<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>جدار للديكورات الحديثة</title>
    <meta name="description" content="جدار للديكورات الحديثة فى الفيوم مصر، لجميع خامات الديكور، بديل الخشب، بديل الرخام، بديل شيبورد، شرائح استيل، وفوم. جودة عالية وأسعار تنافسية مع خدمة التوصيل والتركيب.">
    <meta name="author" content="Gedar Decor،Gedarr،جدار،جدار الفيوم،جدار للديكور">
	<meta property="og:image" content="https://raw.githubusercontent.com/gedarfayoum-eng/website/refs/heads/main/seo/jghbbfj.webp">
	<link rel="canonical" href="https://gedarr.com/" />
    <link rel="alternate" hreflang="en" href="https://gedarr.com/" />
    <link rel="alternate" hreflang="x-default" href="https://gedarr.com/" />
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="جدار للديكورات الحديثة">
    <meta property="og:url" content="https://gedarr.com/">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#1c1917">
	<meta property="og:title" content="جدار للديكور">
    <meta property="og:description" content="جدار للديكورات الحديثة فى الفيوم مصر، لجميع خامات الديكور، بديل الخشب، بديل الرخام، بديل شيبورد، شرائح استيل، وفوم. جودة عالية وأسعار تنافسية مع خدمة التوصيل والتركيب.">
    <meta property="og:image" content="https://github.com/gedarfayoum-eng/website/blob/main/seo/jkldgh.webp?raw=true">
    <meta property="og:image" content="https://github.com/gedarfayoum-eng/website/blob/main/seo/ufklyhslkjf.webp?raw=true">
    <meta property="og:image" content="https://github.com/gedarfayoum-eng/website/blob/main/seo/wihujrfio.webp?raw=true">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="جدار للديكورات الحديثة">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://gedarr.com/">
    <meta property="twitter:domain" content="gedarr.com">
    <meta property="twitter:url" content="https://gedarr.com/">
    <meta name="twitter:title" content="جدار للديكورات الحديثة">
    <meta name="twitter:description" content="جدار للديكورات الحديثة فى الفيوم مصر، لجميع خامات الديكور، بديل الخشب، بديل الرخام، بديل شيبورد، شرائح استيل، وفوم. جودة عالية وأسعار تنافسية مع خدمة التوصيل والتركيب.">
    <meta name="twitter:image" content="https://github.com/gedarfayoum-eng/website/blob/main/seo/eoljkmgl.webp?raw=true">
    <meta name="twitter:image:alt" content="جدار للديكورات الحديثة">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Home",
  "@id": "https://gedarr.com/#home",
  "name": "جدار للديكورات الحديثة",
  "givenName": "جدار",
  "familyName": "للديكورات",
  "alternateName": [
    "جدار للديكورات الحديثة",
    "جدار للديكور"
  ],
  "url": "https://gedarr.com/",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/jghbbfj.webp?raw=true",
      "width": 1200,
      "height": 1200,
      "caption": "جدار للديكورات الحديثة"
    },
    { "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/jghbbfj.webp?raw=true" },
    { "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/ufklyhslkjf.webp?raw=true" },
	{ "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/wihujrfio.webp?raw=true" },
	{ "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/hegjkh.webp?raw=true" },
	{ "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/jkldgh.webp?raw=true" },
    { "@type": "ImageObject", "url": "https://github.com/gedarfayoum-eng/website/blob/main/seo/wihujrfio.webp?raw=true" }
  ],
  "email": "mailto:gedar.fayoum@gmail.com",
  "telephone": [
    "+20-10-1417-5070",
    "+20-10-6400-9655"
  ],
  "contactPoint": [
    {
      "@type": "ContactPoint",
      "contactType": "work",
      "telephone": "+20-10-1417-5070",
      "areaServed": "EG"
    },
    {
      "@type": "ContactPoint",
      "contactType": "work",
      "telephone": "+20-10-1417-5070",
      "areaServed": "EG"
    }
  ],
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Faiyum",
    "addressCountry": "EG"
  },
  "sameAs": [
    "https://www.facebook.com/gedar.fayoum",
    "https://www.instagram.com/gedar_fayoum"
  ]
}

    </script>

    <!-- Tailwind CSS (Optimized: Fixed Version + Pre-Config) -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        stone: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917', 950: '#0c0a09',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts (Tajawal) - Optimized for Performance -->
    <!-- 1. Preconnect to establish connection early -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- 2. Preload font as style to prevent render blocking -->
    <!-- Reduced weights: Removed 800 (extrabold) as it's rarely used to save bandwidth -->
    <link 
        rel="preload" 
        as="style" 
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap"
        onload="this.onload=null;this.rel='stylesheet'"
    >
    
    <!-- 3. Fallback for no-js environments -->
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap">
    </noscript>
    
    <!-- REMOVED: External Lucide Script to improve performance -->
    <!-- <script src="https://unpkg.com/lucide@latest" defer></script> -->

    <style>
        /* --- CRITICAL CSS (للعرض الفوري قبل تحميل المكتبات) --- */
        /* يضمن هذا القسم ظهور الهيكل الأساسي وشاشة التحميل بشكل صحيح فوراً */
        
        :root {
            --bg-color: #ffffff;
            --text-color: #1c1917;
            --primary-color: #1c1917;
        }

        /* REMOVED: Splash Screen Styles */

        body { 
            font-family: 'Tajawal', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            text-align: right;
        }

        /* Prevent Layout Shifts for Main Containers */
        #main-content {
            flex-grow: 1;
            min-height: 80vh; /* حجز مساحة للشاشة الرئيسية */
            width: 100%;
        }

        footer {
            min-height: 300px; /* حجز مساحة للفوتر */
            contain: content; /* عزل الفوتر لتحسين الأداء */
        }

        /* --- END CRITICAL CSS --- */

        /* --- EXISTING UTILITY STYLES --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* REMOVED: .fade-in-up and keyframes */
        
        /* --- 1. إضافة حركة القلب (Pop Animation) --- */
        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.35); }
            100% { transform: scale(1); }
        }
        .heart-pop {
            animation: heartPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* ------------------------------------------ */

        /* --- FIX: Mega Menu Glitch (إصلاح القائمة المنسدلة) --- */
        .mega-menu { 
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px);
            /* إضافة تأخير بسيط عند الإغلاق لمنع الاختفاء المفاجئ */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transition-delay: 0.15s; 
        }
        
        /* تحديث الجسر الوهمي:
           تم تقليل العرض (width) وجعله ممركزاً (left: 50%) ليكون تحت زر "الأقسام" فقط 
           ولا يغطي الأزرار المجاورة مثل "العروض" أو "الرئيسية".
        */
        .mega-menu::before {
            content: '';
            position: absolute;
            top: -30px; /* يغطي المسافة العلوية حتى الهيدر */
            left: 50%;
            transform: translateX(-50%); /* توسيط الجسر */
            width: 150px; /* عرض محدود يناسب الزر فقط */
            height: 35px;
            background: transparent;
            display: block;
            z-index: 60;
        }

        .group:hover .mega-menu { 
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0s; /* الظهور فوراً بدون تأخير */
        }
        /* ------------------------------------ */

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        .gallery-thumb.active { border-color: #d97706; box-shadow: 0 0 0 1px #d97706; }

        /* NEW: Modern Horizontal Scrollbar */
        .custom-scrollbar-modern::-webkit-scrollbar {
            height: 6px; /* أنحف */
            background-color: transparent;
        }
        .custom-scrollbar-modern::-webkit-scrollbar-track {
            background-color: #f5f5f4; /* stone-100 */
            border-radius: 99px;
            margin-inline: 10px;
        }
        .custom-scrollbar-modern::-webkit-scrollbar-thumb {
            background-color: #d6d3d1; /* stone-300 */
            border-radius: 99px;
            border: 2px solid #f5f5f4; /* Padding effect */
        }
        .custom-scrollbar-modern::-webkit-scrollbar-thumb:hover {
            background-color: #78716c; /* stone-500 */
        }
    </style>
</head>
<!-- 
    PIXEL PERFECT CALCULATION:
    Navbar Height: 80px
    Quick Menu Removed
    Total Mobile Padding: 85px (Header only)
    Desktop Padding: 84px
-->
<body class="bg-white text-stone-900 selection:bg-stone-200 overflow-x-hidden flex flex-col min-h-screen pt-[85px] md:pt-[84px] pb-[130px] md:pb-0 animate-in fade-in duration-700">

    <!-- REMOVED: Splash Screen HTML & Script -->

    <!-- Navigation -->
    <!-- UPDATED: Modern Glassmorphism Header -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-[100] transition-all duration-500 bg-white/90 backdrop-blur-xl border-b border-stone-100/50 supports-[backdrop-filter]:bg-white/60 h-[80px] md:h-[84px] flex items-center">
        
        <div class="container mx-auto px-4 md:px-6 py-2 md:py-4 flex flex-row justify-between items-center relative gap-3 w-full">
            
            <!-- 1. Right Side (RTL Start): Profile & Search -->
            <div class="flex items-center gap-2 z-50">
                
                <!-- Desktop Logo (Visible only on Desktop) -->
                <div id="navbar-brand-desktop" onclick="setView('home')" 
                     class="hidden md:flex cursor-pointer items-center justify-center leading-none group transition-all select-none shrink-0">
                     <!-- Logo Injected by JS -->
                </div>

                <!-- Mobile Profile Picture (Visible only on Mobile) -->
                <div id="mobile-profile-pic" class="md:hidden w-10 h-10 rounded-full overflow-hidden border border-stone-100 shadow-sm bg-stone-50 cursor-pointer flex items-center justify-center" onclick="toggleMobileMenu()">
                    <!-- Profile Img Injected by JS -->
                    <i data-lucide="user" size="20" class="text-stone-400"></i>
                </div>

                <!-- Mobile Search Button (Next to Profile) -->
                <button onclick="toggleMobileSearch(true)" class="md:hidden w-10 h-10 flex items-center justify-center text-stone-600 hover:text-stone-900 bg-stone-50/50 hover:bg-stone-100 rounded-full transition-all border border-stone-100/50" aria-label="بحث">
                    <i data-lucide="search" size="20"></i>
                </button>
            </div>

            <!-- 2. Center: Logo (Mobile) & Menu (Desktop) -->
            
            <!-- Mobile Logo (Absolute Center) -->
            <div id="navbar-brand-mobile" onclick="setView('home')" 
                 class="md:hidden absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-40 cursor-pointer flex items-center justify-center select-none">
                 <!-- Mobile Logo Injected by JS -->
            </div>

            <!-- Desktop Navigation (Centered) -->
            <!-- UPDATED: Glass Effect for Menu Container -->
            <div id="desktop-nav-menu" class="hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 items-center gap-1 bg-white/80 backdrop-blur-md p-1.5 rounded-full border border-stone-200/60 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.05)] z-[60] transition-all duration-300 ease-in-out origin-center">
                <button onclick="setView('home')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-stone-50 hover:text-stone-900 transition-all duration-300">الرئيسية</button>
                
                <div class="group h-full flex items-center relative">
                    <button onclick="setView('categories')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-stone-50 hover:text-stone-900 transition-all duration-300 flex items-center gap-1">
                        الأقسام <i data-lucide="chevron-down" size="12" class="group-hover:rotate-180 transition-transform duration-300 opacity-60"></i>
                    </button>
                    
                    <!-- Modern Mega Menu (Redesigned: Premium Look) -->
                    <div class="mega-menu fixed left-1/2 -translate-x-1/2 top-[85px] w-[95vw] max-w-[1200px] bg-white/95 backdrop-blur-xl rounded-[2.5rem] shadow-2xl shadow-stone-200/50 border border-stone-100 overflow-hidden invisible opacity-0 translate-y-4 group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 ease-out z-[60]">
                        <div class="flex h-[500px]">
                            <!-- Sidebar Navigation (List) -->
                            <div class="w-[28%] bg-stone-50/50 p-8 flex flex-col border-l border-stone-100 relative">
                                <!-- Header -->
                                <div class="flex items-center gap-3 mb-6 text-stone-600">
                                    <i data-lucide="layout-grid" size="18"></i>
                                    <span class="text-xs font-bold tracking-[0.2em] uppercase">التصنيفات</span>
                                </div>
                                
                                <!-- List (Added min-h) -->
                                <ul class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pl-2 pr-1 min-h-[300px]" id="mega-menu-categories-list">
                                    <!-- Injected via JS -->
                                    <!-- Placeholder Loading State -->
                                    <li class="h-10 bg-stone-200/50 rounded-xl animate-pulse"></li>
                                    <li class="h-10 bg-stone-200/50 rounded-xl animate-pulse"></li>
                                    <li class="h-10 bg-stone-200/50 rounded-xl animate-pulse"></li>
                                </ul>

                                <!-- Bottom Action -->
                                <div class="mt-4 pt-4 border-t border-stone-200">
                                    <button onclick="viewAllProducts()" class="group w-full flex items-center justify-between p-4 rounded-2xl bg-stone-900 text-white hover:bg-stone-800 transition-all shadow-lg hover:shadow-stone-900/20 active:scale-95">
                                        <div class="flex items-center gap-3">
                                            <div class="p-1.5 bg-white/10 rounded-lg"><i data-lucide="package" size="16"></i></div>
                                            <span class="font-bold text-sm">كل المنتجات</span>
                                        </div>
                                        <i data-lucide="arrow-left" size="16" class="transition-transform group-hover:-translate-x-1"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Visual Content Area (Grid) -->
                            <div class="w-[72%] p-10 bg-white relative overflow-hidden">
                                <!-- Background Decoration -->
                                <div class="absolute top-0 right-0 w-64 h-64 bg-stone-50 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>
                                
                                <div class="flex justify-between items-end mb-8 relative z-10">
                                    <div>
                                        <h3 class="text-3xl font-bold text-stone-900 mb-2 tracking-tight">أقسام مميزة</h3>
                                        <p class="text-stone-600 text-sm">استكشف مجموعاتنا المختارة بعناية لتناسب ذوقك الرفيع</p>
                                    </div>
                                    <button onclick="setView('categories')" class="group flex items-center gap-2 px-5 py-2.5 rounded-full bg-stone-50 text-stone-600 font-bold text-xs hover:bg-stone-100 transition-colors">
                                        عرض جميع الأقسام
                                        <div class="w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-sm group-hover:-translate-x-1 transition-transform">
                                            <i data-lucide="arrow-left" size="10"></i>
                                        </div>
                                    </button>
                                </div>

                                <!-- Grid (Already has h-[360px]) -->
                                <div id="mega-menu-popular-list" class="grid grid-cols-3 gap-6 h-[360px] relative z-10 min-h-[360px]">
                                    <!-- Injected via JS -->
                                    <div class="bg-stone-100 rounded-[2rem] animate-pulse h-full"></div>
                                    <div class="bg-stone-100 rounded-[2rem] animate-pulse h-full"></div>
                                    <div class="bg-stone-100 rounded-[2rem] animate-pulse h-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UPDATED: Desktop Hover -> bg-red-600 text-white -->
                <button onclick="setView('offers')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-red-600 hover:text-white hover:shadow-sm transition-all duration-300 flex items-center gap-1"><i data-lucide="flame" size="12"></i> العروض</button>
                <button onclick="setView('shop')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-stone-50 hover:text-stone-900 transition-all duration-300">المتجر</button>
                <button onclick="setView('track-order')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-stone-50 hover:text-stone-900 transition-all duration-300">تتبع طلبك</button>
                <button onclick="setView('contact')" class="px-5 py-2 rounded-full text-xs font-bold text-stone-600 hover:bg-stone-50 hover:text-stone-900 transition-all duration-300">تواصل</button>
            </div>

            <!-- 4. Action Icons (Right Side in DOM / Left in RTL) -->
            <!-- UPDATED: Added md:flex-none to prevent overlapping the center menu on desktop -->
            <div class="flex items-center justify-end gap-2 md:gap-3 z-50 flex-1 md:flex-none w-auto">
                
                <!-- NEW: Mobile Contact Icon (Replaces Track Order) -->
                <button onclick="setView('contact')" class="md:hidden w-9 h-9 flex items-center justify-center text-stone-600 hover:text-stone-900 bg-stone-50/50 hover:bg-stone-100 rounded-full transition-all border border-stone-100/50" aria-label="تواصل معنا">
                    <i data-lucide="phone" size="20"></i>
                </button>

                <!-- NEW: Mobile Favorites Icon (Next to Contact) -->
                <button onclick="setView('favorites')" class="md:hidden w-9 h-9 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 hover:text-red-600 transition-colors bg-stone-50/50 border border-stone-100/50" title="المفضلة" aria-label="المفضلة">
                    <i data-lucide="heart" size="20"></i>
                </button>

                <!-- Search (Desktop Only) -->
                <!-- UPDATED: Logic to handle width correctly on both -->
                <div id="top-search-wrapper" class="relative flex-grow md:flex-grow-0 min-w-0 hidden md:block">
                    <div id="top-search-bar" class="flex items-center rounded-full h-9 md:h-10 transition-all duration-300 ease-out overflow-hidden cursor-pointer
                        w-full bg-stone-100/50 border border-stone-200/60 shadow-sm
                        md:w-10 md:bg-transparent md:border-transparent md:shadow-none md:hover:bg-stone-100" 
                        onclick="toggleTopSearch(event)">
                        
                        <button class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center text-stone-600 hover:text-stone-900 shrink-0" aria-label="بحث">
                            <i data-lucide="search" size="18" class="md:w-[20px] md:h-[20px]"></i>
                        </button>
                        <label for="top-search-input" class="sr-only">البحث في الموقع</label>
                        <input 
                            id="top-search-input" 
                            type="text" 
                            class="w-full h-full bg-transparent border-none outline-none text-xs md:text-sm px-1 md:px-2 text-stone-800 transition-opacity duration-200 placeholder:text-stone-600 font-medium
                            opacity-100
                            md:opacity-0" 
                            placeholder="ابحث..."
                            onkeydown="handleGlobalSearch(event)"
                            onclick="event.stopPropagation()" 
                            autocomplete="off"
                        >
                    </div>
                </div>

                <!-- Icons Group (Desktop Only for Cart/Fav) -->
                <div class="hidden md:flex items-center gap-1.5 md:gap-3 flex-shrink-0">
                    <!-- Favorites -->
                    <button onclick="setView('favorites')" class="relative w-9 h-9 md:w-10 md:h-10 hidden md:flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 hover:text-red-600 transition-colors group" title="المفضلة" aria-label="المفضلة">
                        <i data-lucide="heart" size="20" class="group-hover:scale-110 transition-transform"></i>
                        <span id="fav-badge" class="absolute top-2 right-2 h-2 w-2 bg-red-500 rounded-full hidden ring-2 ring-white"></span>
                    </button>
                    
                    <!-- Cart -->
                    <button onclick="toggleCart(true)" class="relative w-9 h-9 md:w-10 md:h-10 hidden md:flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 hover:text-stone-900 transition-colors group" aria-label="سلة التسوق" title="سلة التسوق">
                        <i data-lucide="shopping-bag" size="20" class="group-hover:scale-110 transition-transform"></i>
                        <span id="cart-badge" class="absolute -top-1 -right-1 h-4 w-4 md:h-5 md:w-5 bg-red-600 text-white text-[9px] md:text-[10px] flex items-center justify-center rounded-full hidden font-bold border-2 border-white shadow-sm">0</span>
                    </button>

                    <!-- User Profile -->
                    <div class="relative group/user pl-0 md:pl-1 hidden md:block" id="user-menu-container">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Search Pop-up Overlay -->
        <div id="mobile-search-overlay" class="absolute top-0 left-0 w-full h-[80px] bg-white z-[110] flex items-center px-4 transition-transform duration-300 -translate-y-full md:hidden shadow-sm">
            <form onsubmit="handleMobileSearch(event)" class="w-full relative">
                <input type="text" id="mobile-popup-input" class="w-full bg-stone-100 border-none rounded-xl py-3 px-4 pl-12 text-sm focus:ring-2 focus:ring-stone-900 outline-none text-stone-900 placeholder:text-stone-500" placeholder="ابحث عن منتج..." autocomplete="off">
                
                <!-- Close Button (Left in RTL) -->
                <button type="button" onclick="toggleMobileSearch(false)" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-500 p-1">
                    <i data-lucide="x" size="20"></i>
                </button>
                
                <!-- Search Icon (Right in RTL) -->
                <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-stone-500 p-1 pointer-events-none">
                    <i data-lucide="search" size="20"></i>
                </button>
            </form>
        </div>

        <!-- Mobile Menu (Full Screen Overlay) -->
        <div id="mobile-menu" class="absolute top-full left-0 w-full bg-white shadow-lg hidden flex-col border-t border-stone-100 h-[calc(100vh-80px)] overflow-y-auto pb-20 z-40">
            <div id="mobile-user-section" class="p-6 bg-white mb-2 border-b border-stone-100">
                <!-- Mobile User Info Injected Here -->
            </div>
            
            <div class="p-4 space-y-2">
                <button onclick="setView('home'); toggleMobileMenu()" class="w-full flex items-center justify-between p-4 rounded-2xl hover:bg-white transition-colors font-bold text-stone-700">
                    <span class="flex items-center gap-3"><i data-lucide="home" size="18" class="text-stone-600"></i> الرئيسية</span>
                    <i data-lucide="chevron-left" size="16" class="text-stone-600"></i>
                </button>
                
                <button onclick="setView('favorites'); toggleMobileMenu()" class="w-full flex items-center justify-between p-4 rounded-2xl hover:bg-white transition-colors font-bold text-stone-700">
                    <span class="flex items-center gap-3"><i data-lucide="heart" size="18" class="text-stone-600"></i> المفضلة</span>
                    <i data-lucide="chevron-left" size="16" class="text-stone-600"></i>
                </button>

                <!-- ... other menu items ... -->
                
                <button onclick="setView('track-order'); toggleMobileMenu()" class="w-full flex items-center justify-between p-4 rounded-2xl hover:bg-white transition-colors font-bold text-stone-700">
                    <span class="flex items-center gap-3"><i data-lucide="package-search" size="18" class="text-blue-500"></i> تتبع طلبك</span>
                    <i data-lucide="chevron-left" size="16" class="text-stone-600"></i>
                </button>
                
                <button onclick="setView('contact'); toggleMobileMenu()" class="w-full flex items-center justify-between p-4 rounded-2xl hover:bg-white transition-colors font-bold text-stone-700">
                    <span class="flex items-center gap-3"><i data-lucide="phone" size="18" class="text-stone-600"></i> تواصل معنا</span>
                    <i data-lucide="chevron-left" size="16" class="text-stone-600"></i>
                </button>
            </div>

            <div class="mt-auto p-6 border-t border-stone-100" id="mobile-admin-link">
                <!-- Admin link -->
            </div>
        </div>
    </nav>

    <!-- NEW: Mobile Bottom Navigation Bar (Floating Capsule Design) -->
    <div id="bottom-nav-bar" class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-[400px] bg-white/90 backdrop-blur-xl border border-white/40 rounded-[2.5rem] z-[90] flex justify-between items-end px-4 h-[70px] shadow-[0_8px_30px_rgb(0,0,0,0.12)] transition-all duration-300 ease-out hover:shadow-[0_8px_40px_rgb(0,0,0,0.16)] pb-2">
        
        <!-- Home -->
        <button onclick="setView('home')" class="nav-item flex flex-col items-center justify-end gap-1 h-full pb-1 text-stone-400 hover:text-stone-900 transition-all duration-300 group w-14" data-view="home" aria-label="الرئيسية">
            <i data-lucide="home" size="22" class="stroke-[2px] transition-transform duration-300 group-hover:-translate-y-1"></i>
            <span class="text-[10px] font-bold leading-none">الرئيسية</span>
        </button>

        <!-- Offers -->
        <button onclick="setView('offers')" class="nav-item flex flex-col items-center justify-end gap-1 h-full pb-1 text-stone-400 hover:text-red-600 transition-all duration-300 group w-14" data-view="offers" aria-label="العروض">
            <i data-lucide="flame" size="22" class="stroke-[2px] transition-transform duration-300 group-hover:-translate-y-1"></i>
            <span class="text-[10px] font-bold leading-none group-hover:text-red-600">العروض</span>
        </button>

        <!-- Shop (Center Floating Button) -->
        <div class="relative -top-8 group flex flex-col items-center">
            <button onclick="setView('shop')" class="nav-item w-[4.5rem] h-[4.5rem] bg-stone-900 rounded-full flex items-center justify-center border-[6px] border-[#FAFAFA] shadow-2xl text-white hover:scale-110 hover:rotate-3 transition-all duration-300 ease-out relative z-10" data-view="shop" aria-label="المتجر">
                <!-- تم تغيير الأيقونة هنا من layout-grid إلى store -->
                <i data-lucide="store" size="26" class="transition-transform duration-500 group-hover:rotate-12"></i>
            </button>
            <span class="text-[10px] font-bold text-stone-900 absolute -bottom-5 w-max">المتجر</span>
            <!-- Glow Effect -->
            <div class="absolute inset-0 bg-stone-900/30 blur-xl rounded-full -z-0 translate-y-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </div>

        <!-- Cart -->
        <button onclick="toggleCart(true)" class="nav-item flex flex-col items-center justify-end gap-1 h-full pb-1 text-stone-400 hover:text-stone-900 transition-all duration-300 group w-14 relative" aria-label="سلة التسوق">
            <div class="relative transition-transform duration-300 group-hover:-translate-y-1">
                <i data-lucide="shopping-bag" size="22" class="stroke-[2px]"></i>
                <span id="bottom-cart-badge" class="absolute -top-1.5 -right-1.5 h-4 w-4 bg-red-600 text-white text-[9px] flex items-center justify-center rounded-full hidden border-2 border-white shadow-sm font-bold scale-0 transition-transform duration-300">0</span>
            </div>
            <span class="text-[10px] font-bold leading-none">السلة</span>
        </button>

        <!-- Track Order (Replaced 'Menu') -->
        <button onclick="setView('track-order')" class="nav-item flex flex-col items-center justify-end gap-1 h-full pb-1 text-stone-400 hover:text-stone-900 transition-all duration-300 group w-14" data-view="track-order" aria-label="تتبع طلبك">
            <i data-lucide="package-search" size="22" class="stroke-[2px] transition-transform duration-300 group-hover:-translate-y-1"></i>
            <span class="text-[10px] font-bold leading-none">تتبع</span>
        </button>
    </div>

    <!-- REMOVED: Old #mobile-quick-menu -->

    <!-- NEW LOCATION: Header Banner (Below Fixed Nav) -->
    <div id="header-banner-container" class="w-full z-30 transition-all duration-300 hidden"></div>

    <!-- تم إضافة flex-grow هنا لدفع الـ Footer للأسفل دائماً -->
    <!-- Added min-h-[80vh] to prevent layout collapse on empty content -->
    <main id="main-content" class="flex-grow min-h-[80vh]">
        <!-- 4️⃣ Skeleton Loader (Initial Paint CLS Fix) -->
        <div class="container mx-auto px-6 py-8 animate-pulse">
            <!-- Banner Skeleton -->
            <div class="w-full h-48 md:h-64 bg-stone-100 rounded-3xl mb-8"></div>
            
            <!-- Section Header Skeleton -->
            <div class="flex justify-between items-end mb-6">
                <div class="space-y-2">
                    <div class="h-4 w-24 bg-stone-100 rounded"></div>
                    <div class="h-8 w-48 bg-stone-100 rounded"></div>
                </div>
            </div>

            <!-- Products Grid Skeleton -->
            <div class="flex gap-4 overflow-hidden pb-4">
                <!-- Skeleton Item 1 -->
                <div class="min-w-[210px] w-[210px] space-y-3">
                    <div class="aspect-[4/5] bg-stone-100 rounded-2xl"></div>
                    <div class="space-y-2 px-1">
                        <div class="h-4 w-3/4 bg-stone-100 rounded"></div>
                        <div class="h-4 w-1/2 bg-stone-100 rounded"></div>
                    </div>
                </div>
                <!-- Skeleton Item 2 -->
                <div class="min-w-[210px] w-[210px] space-y-3">
                    <div class="aspect-[4/5] bg-stone-100 rounded-2xl"></div>
                    <div class="space-y-2 px-1">
                        <div class="h-4 w-3/4 bg-stone-100 rounded"></div>
                        <div class="h-4 w-1/2 bg-stone-100 rounded"></div>
                    </div>
                </div>
                <!-- Skeleton Item 3 -->
                <div class="min-w-[210px] w-[210px] space-y-3">
                    <div class="aspect-[4/5] bg-stone-100 rounded-2xl"></div>
                    <div class="space-y-2 px-1">
                        <div class="h-4 w-3/4 bg-stone-100 rounded"></div>
                        <div class="h-4 w-1/2 bg-stone-100 rounded"></div>
                    </div>
                </div>
                <!-- Skeleton Item 4 -->
                <div class="min-w-[210px] w-[210px] space-y-3">
                    <div class="aspect-[4/5] bg-stone-100 rounded-2xl"></div>
                    <div class="space-y-2 px-1">
                        <div class="h-4 w-3/4 bg-stone-100 rounded"></div>
                        <div class="h-4 w-1/2 bg-stone-100 rounded"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Drawers & Modals -->
    <!-- UPDATED: Increased Z-Index to > 100 to cover Header -->
    <div id="cart-drawer-backdrop" onclick="toggleCart(false)" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="cart-drawer" class="fixed top-0 left-0 h-full w-full sm:w-[450px] bg-white z-[110] shadow-2xl transform -translate-x-full transition-transform duration-500 cubic-bezier(0.4, 0, 0.2, 1) flex flex-col border-r border-stone-100">
        <!-- Modern Header -->
        <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-white z-10">
            <div>
                <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2">عربة التسوق</h2>
                <p class="text-xs text-stone-600 mt-1">راجع طلباتك قبل الدفع</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="clear-cart-btn" onclick="clearCart()" class="w-10 h-10 bg-red-50 hover:bg-red-100 text-red-600 rounded-full flex items-center justify-center transition-colors hidden" title="تفريغ السلة" aria-label="تفريغ السلة">
                    <i data-lucide="trash-2" size="18"></i>
                </button>
                <button onclick="toggleCart(false)" class="w-10 h-10 bg-white hover:bg-stone-100 rounded-full flex items-center justify-center transition-colors text-stone-600 hover:text-stone-900" aria-label="إغلاق"><i data-lucide="x" size="20"></i></button>
            </div>
        </div>
        
        <!-- 5️⃣ Stepper Placeholder (Cart - Step 1) -->
        <div id="cart-stepper" class="px-6 pt-6 bg-white min-h-[60px]"></div>

        <!-- Items Container (Added min-h) -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-5 bg-white/30 custom-scrollbar min-h-[300px]"></div>
        
        <!-- Modern Footer -->
        <div id="cart-footer" class="p-6 border-t border-stone-100 bg-white space-y-4 hidden z-10 shadow-[0_-10px_60px_-15px_rgba(0,0,0,0.1)]">
            <div class="space-y-3">
                <div class="flex justify-between items-center text-sm font-medium text-stone-600"><span>عدد المنتجات</span><span id="cart-count-summary" class="font-bold text-stone-900 bg-stone-100 px-2 py-0.5 rounded text-xs">0</span></div>
                <div class="flex justify-between items-center">
                    <span class="text-lg font-bold text-stone-900">الإجمالي</span>
                    <span id="cart-total" class="text-2xl font-serif font-bold text-stone-900">$0.00</span>
                </div>
                <p class="text-[10px] text-stone-600 text-center bg-white p-2 rounded-lg border border-stone-100"><i data-lucide="info" size="10" class="inline mb-0.5"></i> الشحن والضرائب تحسب عند إتمام الطلب</p>
            </div>
            <button onclick="checkout()" class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-3 group text-lg">
                <span>إتمام الشراء</span>
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:translate-x-1 transition-transform">
                    <i data-lucide="arrow-left" size="18"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- REMOVED OLD FAVORITE DRAWER -->

    <!-- تم تعديل z-100 إلى z-[130] ليظهر التنبيه فوق كل النوافذ والهيدر -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[130] transition-all duration-500 translate-y-12 opacity-0 pointer-events-none bg-stone-900 text-white px-6 py-3 rounded shadow-lg text-sm font-medium"></div>

    <!-- Checkout Modal (Redesigned) -->
    <!-- UPDATED: Increased Z-Index to > 100 -->
    <div id="checkout-modal-backdrop" onclick="toggleCheckoutModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    
    <div id="checkout-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-lg bg-white rounded-[2rem] shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) scale-95 p-0 max-h-[90vh] flex flex-col overflow-hidden border border-stone-100">
        
        <!-- Header (Fixed) -->
        <div class="px-6 py-5 bg-white z-10 flex justify-between items-center border-b border-stone-50 shrink-0">
            <div>
                <h2 class="text-xl font-bold text-stone-900 flex items-center gap-2">إتمام الطلب</h2>
                <p class="text-[10px] text-stone-600 mt-0.5 font-medium">أكمل بياناتك لتأكيد الحجز</p>
            </div>
            <button onclick="toggleCheckoutModal(false)" class="w-9 h-9 bg-white rounded-full flex items-center justify-center text-stone-600 hover:bg-red-50 hover:text-red-600 transition-all duration-300 group shadow-sm" aria-label="إغلاق">
                <i data-lucide="x" size="18" class="group-hover:rotate-90 transition-transform"></i>
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto px-6 py-6 custom-scrollbar bg-[#FAFAFA]">
            
            <!-- 5️⃣ Stepper Placeholder -->
            <div id="checkout-stepper" class="mb-6"></div>

            <form onsubmit="handlePlaceOrder(event)" class="space-y-6">
                
                <!-- Section 1: Customer Info -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-stone-600 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-stone-200 text-stone-600 flex items-center justify-center text-[10px]">1</span>
                        بيانات التواصل
                    </h3>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 space-y-3">
                        <!-- Name -->
                        <div class="relative group">
                            <div class="absolute right-3.5 top-1/2 -translate-y-1/2 text-stone-600 group-focus-within:text-stone-800 transition-colors pointer-events-none">
                                <i data-lucide="user" size="16"></i>
                            </div>
                            <label for="checkout-name" class="sr-only">الاسم ثلاثي</label>
                            <input id="checkout-name" name="customerName" required class="w-full bg-white border border-stone-100 focus:border-stone-900 focus:bg-white rounded-xl py-3 pr-10 pl-4 text-sm font-bold text-stone-800 placeholder:text-stone-600 placeholder:font-medium transition-all outline-none" placeholder="الاسم ثلاثي">
                        </div>

                        <!-- Phone -->
                        <div class="relative group">
                            <div class="absolute right-3.5 top-1/2 -translate-y-1/2 text-stone-600 group-focus-within:text-stone-800 transition-colors pointer-events-none">
                                <i data-lucide="smartphone" size="16"></i>
                            </div>
                            <label for="checkout-phone" class="sr-only">رقم الموبايل</label>
                            <input id="checkout-phone" name="customerPhone" type="tel" maxlength="11" required class="w-full bg-white border border-stone-100 focus:border-stone-900 focus:bg-white rounded-xl py-3 pr-10 pl-4 text-sm font-bold text-stone-800 placeholder:text-stone-600 placeholder:font-medium transition-all outline-none dir-ltr text-right font-mono" placeholder="01xxxxxxxxx">
                        </div>

                        <!-- Address -->
                        <div class="relative group">
                            <div class="absolute right-3.5 top-3.5 text-stone-600 group-focus-within:text-stone-800 transition-colors pointer-events-none">
                                <i data-lucide="map-pin" size="16"></i>
                            </div>
                            <label for="checkout-address" class="sr-only">العنوان بالتفصيل</label>
                            <textarea id="checkout-address" name="customerAddress" oninput="calculateCheckoutTotal()" required rows="2" class="w-full bg-white border border-stone-100 focus:border-stone-900 focus:bg-white rounded-xl py-3 pr-10 pl-4 text-sm font-bold text-stone-800 placeholder:text-stone-600 placeholder:font-medium transition-all outline-none resize-none" placeholder="العنوان بالتفصيل (المحافظة - المدينة - الشارع)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Delivery -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-stone-600 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-stone-200 text-stone-600 flex items-center justify-center text-[10px]">2</span>
                        خيارات التوصيل
                    </h3>
                    
                    <label class="flex items-center justify-between bg-white p-3.5 rounded-2xl border border-stone-100 shadow-sm cursor-pointer hover:border-stone-300 transition-all group select-none">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="truck" size="16"></i>
                            </div>
                            <div>
                                <span class="block text-xs font-bold text-stone-900">توصيل للمنزل</span>
                                <span class="text-[9px] text-stone-600">سيتم حساب التكلفة تلقائياً</span>
                            </div>
                        </div>
                        <div class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="delivery-check" onchange="calculateCheckoutTotal()" class="sr-only peer">
                            <div class="w-9 h-5 bg-stone-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-stone-900"></div>
                        </div>
                    </label>
                </div>

                <!-- Section 3: Payment -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-stone-600 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-stone-200 text-stone-600 flex items-center justify-center text-[10px]">3</span>
                        طريقة الدفع
                    </h3>

                    <div class="grid grid-cols-2 gap-3">
                        <!-- COD -->
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="paymentMethod" value="cod" class="peer sr-only" checked onchange="updatePaymentUI()">
                            <div class="p-3 rounded-2xl bg-white border border-stone-100 peer-checked:border-green-500 peer-checked:bg-green-50/10 transition-all text-center h-full hover:border-stone-300 flex flex-col items-center justify-center gap-2">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white text-stone-600 peer-checked:bg-green-500 peer-checked:text-white transition-colors flex items-center justify-center">
                                    <i data-lucide="banknote" size="16"></i>
                                </div>
                                <span class="block text-[10px] font-bold text-stone-600 peer-checked:text-green-700">دفع عند الاستلام</span>
                                
                                <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity text-green-500">
                                    <i data-lucide="check-circle-2" size="14" class="fill-green-100"></i>
                                </div>
                            </div>
                        </label>

                        <!-- VF Cash -->
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="paymentMethod" value="vodafone_cash" class="peer sr-only" onchange="updatePaymentUI()">
                            <div class="p-3 rounded-2xl bg-white border border-stone-100 peer-checked:border-red-500 peer-checked:bg-red-50/10 transition-all text-center h-full hover:border-stone-300 flex flex-col items-center justify-center gap-2">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white text-stone-600 peer-checked:bg-red-500 peer-checked:text-white transition-colors flex items-center justify-center">
                                    <i data-lucide="smartphone" size="16"></i>
                                </div>
                                <span class="block text-[10px] font-bold text-stone-600 peer-checked:text-red-700">المحافظ الإلكترونية</span>
                                
                                <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity text-red-600">
                                    <i data-lucide="check-circle-2" size="14" class="fill-red-100"></i>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Partial Payment Option -->
                    <div id="partial-payment-option" class="hidden mt-2 animate-in fade-in slide-in-from-top-2">
                        <label class="flex items-center gap-3 p-3 bg-orange-50 border border-orange-100 rounded-xl cursor-pointer hover:bg-orange-100 transition-colors">
                            <div class="relative flex items-center">
                                <input type="checkbox" name="isPartial" id="isPartial" class="peer w-4 h-4 accent-orange-600 rounded cursor-pointer" onchange="updatePaymentUI()">
                            </div>
                            <div class="flex-1">
                                <span class="block text-xs font-bold text-orange-800">دفع عربون فقط (جدية حجز)</span>
                                <p class="text-[9px] text-orange-600/80">ادفع 50% الآن والباقي عند الاستلام</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="bg-white rounded-2xl p-4 border border-stone-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-stone-600 font-bold">إجمالي الطلب</span>
                        <span id="checkout-total-display" class="text-xl font-serif font-black text-stone-900">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p id="delivery-note" class="text-[9px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded hidden"></p>
                        <span id="payment-method-label" class="text-[9px] font-bold px-2 py-0.5 rounded bg-stone-200 text-stone-600">دفع عند الاستلام</span>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="space-y-3 pt-2">
                    <div class="flex items-center gap-2 justify-center text-[9px] text-stone-600 bg-white/50 py-1.5 rounded-lg border border-stone-50">
                        <i data-lucide="shield-check" size="10" class="text-green-500"></i>
                        <span>جميع البيانات مشفرة وآمنة</span>
                    </div>

                    <button type="submit" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2 group text-sm">
                        <span>تأكيد الطلب</span>
                        <div class="bg-white/20 rounded-full p-1 group-hover:translate-x-1 transition-transform">
                            <i data-lucide="arrow-left" size="14"></i>
                        </div>
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- Vodafone Cash Modal (NEW) -->
    <!-- UPDATED: Increased Z-Index -->
    <div id="vodafone-modal-backdrop" onclick="toggleVodafoneModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="vodafone-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-[2rem] shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-0 overflow-hidden border border-stone-100">
        
        <!-- Modern Header -->
        <div class="bg-stone-900 p-6 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-8 -mb-8 blur-2xl"></div>
            
            <div class="relative z-10 flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center backdrop-blur-md mb-3 border border-white/10 shadow-lg">
                    <i data-lucide="smartphone-nfc" size="24" class="text-white"></i>
                </div>
                <h2 class="text-xl font-bold mb-1">الدفع الإلكتروني</h2>
                <p class="text-white/70 text-xs font-medium">المحافظ الذكية & إنستا باي</p>
            </div>
            <button onclick="toggleVodafoneModal(false)" class="absolute top-4 left-4 text-white/60 hover:text-white bg-white/5 hover:bg-white/20 rounded-full p-2 transition-all" aria-label="إغلاق"><i data-lucide="x" size="18"></i></button>
        </div>

        <div class="p-5 space-y-5 bg-white max-h-[70vh] overflow-y-auto custom-scrollbar">
            <!-- 5️⃣ Stepper Placeholder (Payment - Step 3) -->
            <div id="vodafone-stepper" class="-mt-2"></div>

            <!-- Amount Display -->
            <div class="text-center">
                <p class="text-[10px] text-stone-600 font-bold uppercase tracking-wider mb-2">المبلغ المطلوب تحويله</p>
                <div class="inline-flex items-baseline justify-center gap-1 bg-white border border-stone-200 rounded-2xl px-8 py-3 shadow-sm w-full">
                    <span id="vc-amount" class="text-3xl font-serif font-black text-stone-900 tracking-tight">0.00</span>
                </div>
            </div>

            <!-- Copy Number Section (Primary Action) -->
            <div class="relative group cursor-pointer" onclick="navigator.clipboard.writeText('01064009655'); showToast('تم نسخ الرقم بنجاح')">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-stone-200 to-stone-300 rounded-2xl opacity-50 group-hover:opacity-100 transition duration-500 blur-sm"></div>
                <div class="relative bg-white border border-stone-100 rounded-2xl p-3 flex items-center justify-between shadow-sm hover:shadow-md transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-stone-600 border border-stone-100">
                            <i data-lucide="copy" size="18"></i>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-stone-600 font-bold uppercase mb-0.5">رقم التحويل (جميع المحافظ)</p>
                            <p class="text-lg font-mono font-bold text-stone-900 dir-ltr tracking-wide leading-none">01064009655</p>
                            <p class="text-[9px] text-stone-600 font-medium mt-1 dir-ltr tracking-tight">Mostafa M** Mo*** Z*** Eyd</p>
                        </div>
                    </div>
                    <div class="text-[10px] font-bold text-white bg-stone-900 px-3 py-1.5 rounded-lg shadow-sm group-hover:scale-105 transition-transform">
                        نسخ
                    </div>
                </div>
            </div>

            <!-- Generic Instructions (Tabs Style) -->
            <div class="bg-white border border-stone-200 rounded-2xl overflow-hidden">
                <div class="flex border-b border-stone-100 bg-white/50">
                    <button class="flex-1 py-3 text-xs font-bold text-stone-900 border-b-2 border-stone-900 bg-white">عبر التطبيق</button>
                    <button class="flex-1 py-3 text-xs font-bold text-stone-600 hover:text-stone-700 transition-colors" onclick="document.getElementById('ussd-codes-section').scrollIntoView({behavior: 'smooth'})">الأكواد المختصرة</button>
                </div>
                <div class="p-4 bg-white/30">
                    <!-- تم تعديل الهيكل: وضع الخط الزخرفي خارج القائمة ul داخل حاوية relative -->
                    <div class="relative">
                        <!-- الخط العمودي (الزخرفة) -->
                        <div class="absolute right-[9px] top-2 bottom-2 w-0.5 bg-stone-200"></div>
                        
                        <!-- القائمة تحتوي فقط على عناصر li -->
                        <ul class="space-y-3 relative">
                            <li class="relative pr-6 flex items-start">
                                <span class="absolute right-0 top-0.5 w-5 h-5 bg-white border-2 border-stone-200 rounded-full flex items-center justify-center text-[9px] font-bold text-stone-600 z-10 shadow-sm">1</span>
                                <p class="text-xs text-stone-600 font-medium pt-0.5">افتح تطبيق <span class="font-bold text-stone-800">محفظتك</span> أو <span class="font-bold text-purple-700">InstaPay</span>.</p>
                            </li>
                            <li class="relative pr-6 flex items-start">
                                <span class="absolute right-0 top-0.5 w-5 h-5 bg-white border-2 border-stone-200 rounded-full flex items-center justify-center text-[9px] font-bold text-stone-600 z-10 shadow-sm">2</span>
                                <p class="text-xs text-stone-600 font-medium pt-0.5">اختر <span class="font-bold text-stone-800">تحويل لأي محفظة</span> أو رقم هاتف.</p>
                            </li>
                            <li class="relative pr-6 flex items-start">
                                <span class="absolute right-0 top-0.5 w-5 h-5 bg-white border-2 border-stone-200 rounded-full flex items-center justify-center text-[9px] font-bold text-stone-600 z-10 shadow-sm">3</span>
                                <p class="text-xs text-stone-600 font-medium pt-0.5">حول <span class="bg-stone-200 px-1 rounded text-stone-900 dir-ltr inline-block font-bold text-[10px]" id="vc-amount-step">0</span> للرقم الموضح بالأعلى.</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- USSD Codes Section (NEW) -->
            <div id="ussd-codes-section" class="space-y-2">
                <div class="flex items-center gap-2 mb-1 px-1">
                    <i data-lucide="hash" size="14" class="text-stone-600"></i>
                    <span class="text-xs font-bold text-stone-600">أكواد التحويل السريع (بدون انترنت)</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <!-- Vodafone -->
                    <div class="bg-red-50/50 border border-red-100 p-2 rounded-xl text-center group hover:border-red-200 transition-colors">
                        <div class="text-[9px] font-bold text-red-600 mb-1">فودافون كاش</div>
                        <div class="bg-white border border-red-100 rounded-lg py-1.5 px-1 shadow-sm dir-ltr font-mono text-[9px] font-bold text-stone-700 whitespace-nowrap overflow-x-auto scrollbar-hide">
                            *9*7*الرقم*المبلغ#
                        </div>
                    </div>
                    <!-- Etisalat -->
                    <div class="bg-green-50/50 border border-green-100 p-2 rounded-xl text-center group hover:border-green-200 transition-colors">
                        <div class="text-[9px] font-bold text-green-600 mb-1">اتصالات كاش</div>
                        <div class="bg-white border border-green-100 rounded-lg py-1.5 px-1 shadow-sm dir-ltr font-mono text-[9px] font-bold text-stone-700">
                            اطلب *777#
                        </div>
                    </div>
                    <!-- Orange -->
                    <div class="bg-orange-50/50 border border-orange-100 p-2 rounded-xl text-center group hover:border-orange-200 transition-colors">
                        <div class="text-[9px] font-bold text-orange-600 mb-1">أورانج كاش</div>
                        <div class="bg-white border border-orange-100 rounded-lg py-1.5 px-1 shadow-sm dir-ltr font-mono text-[9px] font-bold text-stone-700">
                            اطلب *115#
                        </div>
                    </div>
                    <!-- WE -->
                    <div class="bg-purple-50/50 border border-purple-100 p-2 rounded-xl text-center group hover:border-purple-200 transition-colors">
                        <div class="text-[9px] font-bold text-purple-700 mb-1">وي باي (WE)</div>
                        <div class="bg-white border border-purple-100 rounded-lg py-1.5 px-1 shadow-sm dir-ltr font-mono text-[9px] font-bold text-stone-700">
                            اطلب *322#
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirmation Action -->
            <input type="hidden" id="vc-order-id-hidden">
            <div class="pt-2 sticky bottom-0 bg-white pb-1">
                <button onclick="confirmVodafonePayment()" class="w-full bg-stone-900 hover:bg-stone-800 text-white py-3.5 rounded-xl font-bold transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2 group text-sm">
                    <span>أتممت التحويل، متابعة</span>
                    <i data-lucide="arrow-left" size="16" class="group-hover:-translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Vodafone Payment Confirmation Form Modal (NEW) -->
    <div id="vc-confirm-modal-backdrop" onclick="toggleVcConfirmModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="vc-confirm-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="file-check" class="text-[#E60000]"></i> تأكيد بيانات الدفع</h2>
            <button onclick="toggleVcConfirmModal(false)" class="text-stone-600 hover:text-red-600 transition-colors p-1 bg-white rounded-full" aria-label="إغلاق"><i data-lucide="x"></i></button>
        </div>
        
        <!-- 5️⃣ Stepper Placeholder (Payment Confirm - Step 3) -->
        <div id="vc-confirm-stepper" class="mb-6"></div>

        <!-- تم إضافة id="vc-confirm-form" و oninput="validateVcForm()" -->
        <form id="vc-confirm-form" onsubmit="handleVcConfirmSubmit(event)" oninput="validateVcForm()" onchange="validateVcForm()" class="space-y-4">
            <input type="hidden" id="vc-confirm-order-id">
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-xs text-blue-800 mb-2 flex gap-2 items-start">
                <i data-lucide="info" size="14" class="mt-0.5 shrink-0"></i>
                <p>ساعدنا في تأكيد طلبك بسرعة من خلال إرفاق بيانات التحويل الصحيحة.</p>
            </div>

            <!-- حقل رفع الصورة الجديد (Client-side Compression) -->
            <div class="bg-white p-3 rounded-xl border border-stone-200 border-dashed hover:bg-stone-100 transition-colors relative group">
                <label for="vc-receipt-image" class="block text-xs font-bold text-stone-600 mb-2 uppercase tracking-wider flex items-center gap-2 cursor-pointer">
                    <i data-lucide="image" size="14"></i> صورة التحويل (سكرين شوت) <span class="text-red-600">*</span>
                </label>
                <input id="vc-receipt-image" type="file" name="receiptImage" accept="image/*" required class="w-full text-sm text-stone-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-stone-900 file:text-white hover:file:bg-stone-800 cursor-pointer">
                <p class="text-[10px] text-stone-600 mt-2">يرجى رفع صورة واضحة لرسالة تأكيد التحويل (سيتم ضغطها تلقائياً لتقليل استهلاك البيانات).</p>
                
                <!-- علامة صح تظهر عند رفع الصورة -->
                <div id="img-check-indicator" class="absolute top-3 left-3 text-green-500 hidden animate-bounce">
                    <i data-lucide="check-circle" size="20"></i>
                </div>
            </div>

            <div>
                <label for="vc-sender-name" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">الاسم بالكامل (صاحب المحفظة) <span class="text-red-600">*</span></label>
                <div class="relative">
                    <input id="vc-sender-name" name="senderName" required class="w-full border border-stone-200 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors text-sm font-bold text-stone-800">
                    <i data-lucide="user" class="absolute left-3 top-3.5 text-stone-600" size="16"></i>
                </div>
            </div>

            <div>
                <label for="vc-sender-phone" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">رقم الموبايل المحول منه <span class="text-red-600">*</span></label>
                <div class="relative">
                    <input id="vc-sender-phone" name="senderPhone" type="tel" maxlength="11" required class="w-full border border-stone-200 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors text-sm font-bold text-stone-800 dir-ltr text-right" placeholder="01xxxxxxxxx">
                    <i data-lucide="smartphone" class="absolute left-3 top-3.5 text-stone-600" size="16"></i>
                </div>
                <p class="text-[10px] text-stone-600 mt-1 mr-1">يجب أن يكون 11 رقم (010, 011, 012, 015)</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="vc-amount-paid" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">المبلغ المدفوع <span class="text-red-600">*</span></label>
                    <div class="relative">
                        <input id="vc-amount-paid" name="amountPaid" type="number" step="0.01" required class="w-full border border-stone-200 p-3 pl-8 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors text-sm font-bold text-stone-800">
                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">$</span>
                    </div>
                </div>
                <div>
                    <label for="vc-transaction-id" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">رقم العملية (اختياري)</label>
                    <input id="vc-transaction-id" name="transactionId" class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors text-sm font-bold text-stone-800" placeholder="Transaction ID">
                </div>
            </div>

            <!-- تم تعديل الزر: إضافة id="vc-submit-btn" و disabled و تنسيق باهت -->
            <button type="submit" id="vc-submit-btn" disabled class="w-full bg-stone-400 text-white/80 py-4 rounded-xl font-bold cursor-not-allowed transition-all shadow-none mt-4 flex justify-center items-center gap-2">
                <span>تأكيد وإرسال للمراجعة</span>
                <i data-lucide="check" size="18"></i>
            </button>
            <p id="vc-form-hint" class="text-center text-[10px] text-red-600 font-bold animate-pulse">يرجى رفع الصورة وملء البيانات لتفعيل الزر</p>
        </form>
    </div>

    <!-- 🆕 Add Real Work Modal (New Modal instead of Browser Prompt) -->
    <div id="add-work-modal-backdrop" onclick="toggleAddWorkModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="add-work-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="image-plus" class="text-blue-600"></i> إضافة للمعرض</h3>
            <button onclick="toggleAddWorkModal(false)" class="text-stone-600 hover:text-stone-900 bg-stone-100 rounded-full p-1" aria-label="إغلاق"><i data-lucide="x" size="18"></i></button>
        </div>
        <form onsubmit="handleSubmitRealWork(event)">
            <div class="space-y-4">
                <div>
                    <label for="work-url-input" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">الرابط (صورة أو فيديو يوتيوب)</label>
                    <input id="work-url-input" name="workUrl" required class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-all dir-ltr text-left placeholder:text-right" placeholder="https://...">
                    <p class="text-[10px] text-stone-600 mt-1">يقبل روابط الصور المباشرة أو روابط فيديوهات YouTube</p>
                </div>
                <button type="submit" class="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="plus-circle" size="18"></i> إضافة
                </button>
            </div>
        </form>
    </div>

    <!-- Edit Order Modal (NEW) -->
    <div id="edit-order-modal-backdrop" onclick="toggleEditOrderModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="edit-order-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="pen-line" class="text-blue-600"></i> تعديل الطلب</h2>
            <button onclick="toggleEditOrderModal(false)" class="text-stone-600 hover:text-red-600 transition-colors p-1 bg-white rounded-full" aria-label="إغلاق"><i data-lucide="x"></i></button>
        </div>
        
        <form onsubmit="handleUpdateOrder(event)" id="edit-order-form" class="space-y-5">
            <input type="hidden" name="orderId">
            <div class="space-y-4">
                <div>
                    <label for="edit-customer-name" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">اسم العميل</label>
                    <input id="edit-customer-name" name="customerName" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors">
                </div>
                <div>
                    <label for="edit-customer-phone" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">رقم الهاتف</label>
                    <input id="edit-customer-phone" name="customerPhone" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors">
                </div>
                <div>
                    <label for="edit-customer-address" class="block text-xs font-bold text-stone-600 mb-1.5 uppercase tracking-wider">العنوان</label>
                    <textarea id="edit-customer-address" name="customerAddress" required rows="2" class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white transition-colors"></textarea>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                     <label for="edit-total-amount" class="block text-xs font-bold text-blue-800 mb-1.5 uppercase tracking-wider">الإجمالي (تعديل يدوي)</label>
                     <div class="relative">
                        <input id="edit-total-amount" name="totalAmount" type="number" step="0.01" required class="w-full border border-blue-200 p-3 pl-8 rounded-xl focus:ring-2 focus:ring-blue-600 outline-none bg-white font-bold text-stone-900">
                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">$</span>
                     </div>
                     <p class="text-[10px] text-blue-600 mt-2">تنبيه: تغيير هذا الرقم لا يؤثر على أسعار المنتجات الفردية، بل يغير إجمالي الفاتورة فقط.</p>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg flex justify-center items-center gap-2">
                <i data-lucide="save"></i> <span>حفظ التعديلات</span>
            </button>
        </form>
    </div>
    <!-- Order Success Modal (UPDATED) -->
    <div id="success-modal-backdrop" onclick="toggleSuccessModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="success-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-8 text-center">
        
        <!-- 5️⃣ Stepper Placeholder (Success - Step 4) -->
        <div id="success-stepper" class="mb-8"></div>

        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm animate-bounce">
            <i data-lucide="check" size="40"></i>
        </div>
        <!-- Added IDs here -->
        <h2 id="success-title" class="text-2xl font-bold text-stone-900 mb-2">تم استلام طلبك بنجاح!</h2>
        <div id="success-desc" class="text-stone-600 text-sm mb-6">شكراً لثقتك بنا. يرجى الاحتفاظ برقم الطلب لتتبع حالة الشحنة.</div>
        
        <div class="bg-white p-4 rounded-xl border border-stone-200 mb-6 relative group cursor-pointer hover:bg-stone-100 transition-colors" onclick="copyOrderId()">
            <p class="text-xs text-stone-600 font-bold uppercase tracking-wider mb-1">رقم الطلب (اضغط للنسخ)</p>
            <p id="success-order-id" class="text-xl font-mono font-bold text-stone-800 tracking-wider select-all">Loading...</p>
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-600 group-hover:text-stone-900 transition-colors">
                <i data-lucide="copy" size="20"></i>
            </div>
        </div>

        <button onclick="toggleSuccessModal(false); setView('track-order')" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl mb-3 flex items-center justify-center gap-2">
            <i data-lucide="package-search" size="18"></i> تتبع حالة الطلب الآن
        </button>
        <button onclick="toggleSuccessModal(false)" class="w-full text-stone-600 font-bold py-2 hover:text-stone-900">
            متابعة التسوق
        </button>
    </div>

    <!-- Request Modification Modal (NEW Feature) -->
    <div id="mod-modal-backdrop" onclick="toggleModModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="mod-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="edit-3" class="text-orange-500"></i> طلب تعديل</h3>
            <button onclick="toggleModModal(false)" aria-label="إغلاق"><i data-lucide="x" class="text-stone-600 hover:text-stone-900"></i></button>
        </div>
        <form onsubmit="handleSubmitModRequest(event)">
            <input type="hidden" name="orderId" id="mod-order-id">
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-4 text-xs text-blue-700 leading-relaxed">
                <i data-lucide="info" size="14" class="inline mb-0.5"></i> يرجى كتابة التعديلات المطلوبة بوضوح (مثلاً: تغيير العنوان، تغيير رقم الهاتف، إلغاء منتج). سيقوم فريقنا بمراجعة الطلب وتنفيذه إن أمكن.
            </div>
            <label for="mod-message-input" class="sr-only">تفاصيل التعديل</label>
            <textarea id="mod-message-input" name="message" required rows="4" class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-stone-900 outline-none mb-4 bg-white focus:bg-white transition-all placeholder:text-stone-600" placeholder="اكتب تفاصيل التعديل هنا..."></textarea>
            <button type="submit" class="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg">إرسال الطلب للإدارة</button>
        </form>
    </div>

    <!-- NEW: Custom WhatsApp Message Modal -->
    <div id="wa-modal-backdrop" onclick="toggleWaModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[105] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="wa-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[110] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="message-circle" class="text-[#25D366]"></i> مراسلة العميل</h3>
            <button onclick="toggleWaModal(false)" aria-label="إغلاق"><i data-lucide="x" class="text-stone-600 hover:text-stone-900"></i></button>
        </div>
        <div class="space-y-4">
            <input type="hidden" id="wa-target-phone">
            
            <div class="flex gap-2 mb-2 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="setWaTemplate('confirm')" class="text-[10px] bg-green-50 text-green-700 px-3 py-1.5 rounded-full border border-green-200 hover:bg-green-100 whitespace-nowrap transition-colors">قالب تأكيد</button>
                <button onclick="setWaTemplate('shipping')" class="text-[10px] bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-200 hover:bg-blue-100 whitespace-nowrap transition-colors">قالب شحن</button>
                <button onclick="setWaTemplate('address')" class="text-[10px] bg-orange-50 text-orange-700 px-3 py-1.5 rounded-full border border-orange-200 hover:bg-orange-100 whitespace-nowrap transition-colors">تأكيد عنوان</button>
                <button onclick="setWaTemplate('empty')" class="text-[10px] bg-white text-stone-700 px-3 py-1.5 rounded-full border border-stone-200 hover:bg-stone-100 whitespace-nowrap transition-colors">فارغ</button>
            </div>

            <div>
                <label for="wa-message-input" class="block text-xs font-bold text-stone-600 mb-1.5">نص الرسالة (قابل للتعديل)</label>
                <textarea id="wa-message-input" rows="8" class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-[#25D366] outline-none bg-white focus:bg-white transition-all placeholder:text-stone-600 font-medium text-stone-700 leading-relaxed"></textarea>
            </div>
            <button onclick="sendCustomWhatsApp()" class="w-full bg-[#25D366] text-white py-3.5 rounded-xl font-bold hover:bg-[#1da851] transition-all shadow-lg flex justify-center gap-2 items-center group">
                <span>فتح في واتساب</span>
                <i data-lucide="send" size="18" class="group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- Modern Light Footer -->
    <!-- Updated: Compact Mobile Layout & Removed Shopping Links on Mobile -->
    <footer class="bg-white text-stone-600 py-4 md:py-16 mt-auto border-t border-stone-200 font-normal relative overflow-hidden" style="contain: content;">
        <!-- Background Elements (Light Theme) -->
        <div class="absolute top-0 right-0 w-96 h-96 bg-stone-200/40 rounded-full blur-3xl -mr-40 -mt-40 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-stone-200/40 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none"></div>

        <div class="container mx-auto px-4 md:px-6 relative z-10">
            
            <!-- زر الانتقال للأعلى (جديد) -->
            <div class="flex justify-end mb-4 md:mb-8">
                <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="group flex items-center gap-2 bg-white border border-stone-200 hover:border-stone-900 text-stone-600 hover:text-stone-900 px-4 py-2 md:px-5 md:py-2.5 rounded-full transition-all duration-300 shadow-sm hover:shadow-md">
                    <span class="text-[10px] md:text-xs font-bold">للأعلي</span>
                    <div class="bg-stone-100 group-hover:bg-stone-900 group-hover:text-white rounded-full p-1 transition-colors">
                        <i data-lucide="arrow-up" size="12" class="group-hover:-translate-y-0.5 transition-transform"></i>
                    </div>
                </button>
            </div>

            <!-- Added min-h to grid items to prevent collapse/shift -->
            <!-- UPDATED: Removed border-b on mobile, reduced gap/margin -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-12 mb-4 md:mb-16 md:border-b md:border-stone-200 pb-2 md:pb-12">
                <!-- Brand Info -->
                <div class="space-y-4 md:space-y-6 text-center md:text-right">
                    <!-- تم إضافة id="footer-brand" هنا مع min-height لحجز المساحة -->
                    <div id="footer-brand" class="min-h-[50px] md:min-h-[60px] flex items-center justify-center md:justify-start"></div>
                    <!-- تم تكبير الخط هنا من text-sm إلى text-base -->
                    <p class="text-sm md:text-base leading-relaxed text-stone-600">
                        نحول مساحتك العادية إلى تحفة فنية. وجهتك الأولى لأحدث صيحات الديكور وتجاليد الحوائط في مصر.
                    </p>
                    <div class="flex gap-3 justify-center md:justify-start">
                        <!-- UPDATED: Added Distinctive Aria-Labels -->
                        <a href="https://www.facebook.com/gedar.fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#1877F2] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#1877F2] text-stone-600" aria-label="تابع جدار للديكور على فيسبوك" title="تابع جدار للديكور على فيسبوك">
                            <i data-lucide="facebook" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://www.instagram.com/gedar_fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#E4405F] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#E4405F] text-stone-600" aria-label="تصفح معرض صور جدار على انستجرام" title="تصفح معرض صور جدار على انستجرام">
                            <i data-lucide="instagram" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://wa.me/201014175070" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#25D366] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#25D366] text-stone-600" aria-label="تواصل مع خدمة العملاء عبر واتساب" title="تواصل مع خدمة العملاء عبر واتساب">
                            <i data-lucide="message-circle" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links (Shopping) - HIDDEN ON MOBILE -->
                <div class="hidden md:block">
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">التسوق</h4>
                    <!-- تم تكبير الخط هنا من text-sm إلى text-base -->
                    <ul class="space-y-4 text-base">
                        <li><button onclick="setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-600"></i> كل المنتجات</button></li>
                        <li><button onclick="filterCategory('بديل الخشب'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-600"></i> بديل الخشب</button></li>
                        <li><button onclick="filterCategory('بديل الرخام'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-600"></i> بديل الرخام</button></li>
                        <li><button onclick="setView('offers')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-600"></i> العروض والخصومات</button></li>
                    </ul>
                </div>

                <!-- Customer Support -->
                <div class="text-center md:text-right">
                    <h4 class="text-stone-900 font-bold text-lg mb-4 md:mb-6 relative w-fit mx-auto md:mx-0 after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">خدمة العملاء</h4>
                    <!-- تم تكبير الخط هنا من text-sm إلى text-base -->
                    <ul class="space-y-3 md:space-y-4 text-sm md:text-base">
                        <!-- تم إخفاء تتبع الطلب واتصل بنا من الفوتر في الموبايل لتقليل الارتفاع (موجودة في البار العلوي والسفلي) -->
                        <li class="hidden md:block"><button onclick="setView('track-order')" class="hover:text-stone-900 transition-colors flex items-center justify-center md:justify-start gap-2 text-orange-600 font-bold group w-full"><i data-lucide="package-search" size="16" class="group-hover:scale-110 transition-transform"></i> تتبع طلبك</button></li>
                        <li class="hidden md:block"><button onclick="setView('contact')" class="hover:text-stone-900 transition-colors w-full">اتصل بنا</button></li>
                        <li><button onclick="setView('faq')" class="hover:text-stone-900 transition-colors w-full">الأسئلة الشائعة</button></li>
                        <li><button onclick="setView('return-policy')" class="hover:text-stone-900 transition-colors w-full">سياسة الاسترجاع</button></li>
                    </ul>
                </div>

                <!-- Contact Details (Hidden on Mobile) -->
                <div class="hidden md:block text-right">
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">معلومات التواصل</h4>
                    <ul class="space-y-6 text-base">
                        <li class="flex items-start gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-600 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="map-pin" size="18"></i>
                            </div>
                            <span class="mt-1 leading-relaxed">الفيوم - شارع المستشفي العام<br/><span class="text-stone-500 text-xs">أمام مطعم ابو صلاح</span></span>
                        </li>
                        <li class="flex items-center gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-600 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="phone" size="18"></i>
                            </div>
                            <div class="flex flex-col items-start">
                                <a href="tel:+201014175070" class="dir-ltr font-mono text-xl text-stone-900 font-bold tracking-wide hover:text-blue-600 transition-colors" title="اتصال هاتفي">01014175070</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="pt-0 md:pt-8">
                <!-- تم تكبير الخط هنا من text-xs إلى text-sm -->
                <!-- UPDATED YEAR: 2026 -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-xs md:text-sm text-stone-600 mb-4 md:mb-6">
                    <p>&copy; 2026 متجر جدار للديكور.</p>
                    
                    <!-- Payment Methods Logos - Hidden on Mobile -->
                    <div class="hidden md:flex grayscale hover:grayscale-0 transition-all duration-500 opacity-80 hover:opacity-100 h-12 md:h-24 w-auto items-center">
                        <!-- UPDATED: Replaced GitHub Raw with jsDelivr & Added loading="lazy" -->
                        <img src="https://cdn.jsdelivr.net/gh/gedarfayoum-eng/website@main/Images/banner/payment.webp" loading="lazy" class="h-full w-auto object-contain" width="300" height="96" alt="طرق الدفع">
                    </div>
                </div>

                <!-- Developer Info (NEW) -->
                <!-- تم تكبير الخط هنا من text-[10px] إلى text-sm -->
                <div class="flex justify-center items-center gap-2 text-xs md:text-sm text-stone-600 border-t border-stone-100 pt-4">
                    <span>برمجة:</span>
                    <a href="https://badre.site" target="_blank" class="flex items-center gap-1.5 font-bold hover:text-stone-800 transition-colors group dir-ltr bg-white px-3 py-1 rounded-full border border-stone-100 hover:border-stone-300 hover:shadow-sm" aria-label="زيارة موقع المطور Badr i. Smida">
                        <i data-lucide="globe" size="12" class="text-stone-600 group-hover:text-blue-600 transition-colors"></i>
                        <span>Badr i. Smida</span>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- REMOVED: Bottom Banner Container was here -->

    <!-- New Lightbox Modal (White Theme) -->
    <div id="lightbox-modal" class="fixed inset-0 z-[130] bg-white/95 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <!-- Close Button -->
        <button onclick="closeLightbox()" class="absolute top-6 right-6 text-stone-600 hover:text-stone-900 z-50 p-2 transition-transform hover:rotate-90 bg-stone-100 hover:bg-stone-200 rounded-full backdrop-blur-md border border-stone-200 shadow-sm" aria-label="إغلاق العرض">
            <i data-lucide="x" size="24"></i>
        </button>
        
        <!-- Navigation Buttons -->
        <!-- Next (Left in RTL) -->
        <button onclick="changeLightboxImage(1)" class="absolute left-4 md:left-8 top-1/2 -translate-y-1/2 text-stone-600 hover:text-stone-900 z-50 p-3 bg-white hover:bg-stone-50 rounded-full backdrop-blur-md transition-all border border-stone-200 shadow-lg hover:scale-110 group" aria-label="الصورة التالية">
            <i data-lucide="chevron-left" size="32" class="group-hover:-translate-x-1 transition-transform"></i>
        </button>
        
        <!-- Prev (Right in RTL) -->
        <button onclick="changeLightboxImage(-1)" class="absolute right-4 md:right-8 top-1/2 -translate-y-1/2 text-stone-600 hover:text-stone-900 z-50 p-3 bg-white hover:bg-stone-50 rounded-full backdrop-blur-md transition-all border border-stone-200 shadow-lg hover:scale-110 group" aria-label="الصورة السابقة">
            <i data-lucide="chevron-right" size="32" class="group-hover:translate-x-1 transition-transform"></i>
        </button>

        <!-- Main Content Container -->
        <div class="relative w-full h-full flex items-center justify-center p-4 md:p-12" onclick="if(event.target === this) closeLightbox()">
            
            <!-- Image Element -->
            <img id="lightbox-img" src="" class="max-h-full max-w-full object-contain rounded-2xl shadow-2xl transition-all duration-300 select-none transform scale-95 opacity-0 border border-stone-100" alt="عرض الصورة المكبر">
            
            <!-- Video Element (New) -->
            <div id="lightbox-video-container" class="hidden w-full max-w-4xl aspect-video rounded-2xl overflow-hidden shadow-2xl border border-stone-200 bg-black">
                <!-- UPDATED: Added loading="lazy" -->
                <iframe id="lightbox-video" loading="lazy" class="w-full h-full" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>

            <!-- Counter -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-stone-600 font-mono text-sm bg-white/90 px-4 py-1.5 rounded-full backdrop-blur-md border border-stone-200 font-bold tracking-widest shadow-sm">
                <span id="lightbox-counter">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- Firebase & Main Logic -->
    <script type="module">
        // 🚀 OPTIMIZED: Removed static imports to prevent render blocking
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ... (other imports removed) ...

        // --- ⚡ PERFORMANCE FIX: LOCAL ICONS SYSTEM ---
        // بدلاً من تحميل مكتبة كاملة، نستخدم فقط الأيقونات التي نحتاجها
        const ICONS = {
            "store": '<path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/>',
            "align-left": '<line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/>',
            "arrow-left": '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
            "arrow-right": '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            "arrow-up": '<path d="m5 12 7-7 7 7"/><path d="M12 19V5"/>',
            "arrow-left-right": '<path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/>',
            "search": '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
            "search-x": '<path d="m13.5 8.5-5 5"/><path d="m8.5 8.5 5 5"/><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
            "heart": '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            "heart-off": '<line x1="2" y1="2" x2="22" y2="22"/><path d="M16.5 16.5 12 21l-7-7c-1.5-1.45-3-3.2-3-5.5a5.5 5.5 0 0 1 2.14-4.35"/><path d="M8.76 3.1c1.15.22 2.13.78 3.24 1.9 1.5-1.5 2.74-2 4.5-2A5.5 5.5 0 0 1 21.5 8.5c0 1.12-.36 2.22-.9 3.28"/>',
            "shopping-bag": '<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>',
            "user": '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            "chevron-down": '<path d="m6 9 6 6 6-6"/>',
            "chevron-up": '<path d="m18 15-6-6-6 6"/>',
            "chevron-left": '<path d="m15 18-6-6 6-6"/>',
            "chevron-right": '<path d="m9 18 6-6-6-6"/>',
            "layout-grid": '<rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/>',
            "grid": '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/>',
            "grid-2x2": '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="12" x2="12" y1="3" y2="21"/>',
            "package": '<path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/>',
            "package-search": '<path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/><circle cx="18.5" cy="15.5" r="2.5"/><path d="M20.27 17.27 22 19"/>',
            "package-check": '<path d="m16 16 2 2 4-4"/><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m16.5 9.4-9-5.19"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>',
            "package-plus": '<path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/><path d="M18.5 21.64V16"/><path d="M21.32 18.82H15.68"/>',
            "flame": '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3 .5.5 1 1.5 1.5 2.5z"/>',
            "phone": '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>',
            "trash-2": '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
            "x": '<path d="M18 6 6 18"/><path d="m6 6 18 18"/>',
            "x-circle": '<circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>',
            "x-octagon": '<polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>',
            "check": '<path d="M20 6 9 17l-5-5"/>',
            "check-circle": '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
            "check-circle-2": '<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>',
            "badge-check": '<path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78 4 4 0 0 1 0-6.74Z"/><path d="m9 12 2 2 4-4"/>',
            "map-pin": '<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>',
            "truck": '<path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/>',
            "banknote": '<rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/>',
            "smartphone": '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>',
            "smartphone-nfc": '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/><path d="M10 6a2 2 0 0 1 4 0"/>',
            "shield-check": '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/>',
            "shield-alert": '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/>',
            "copy": '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>',
            "hash": '<line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/>',
            "file-check": '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/>',
            "file-search": '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><circle cx="10" cy="14" r="3"/><path d="m14.5 18.5-2.1-2.1"/>',
            "file-shield": '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 13v1.6c0 2.2 2.6 3.1 3.5 3.4.9-.3 3.5-1.2 3.5-3.4V13l-3.5-2z"/>',
            "file-text": '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>',
            "image": '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>',
            "image-plus": '<path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" x2="22" y1="5" y2="5"/><line x1="19" x2="19" y1="2" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>',
            "pen-line": '<path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>',
            "save": '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>',
            "edit-3": '<path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>',
            "message-circle": '<path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>',
            "send": '<line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>',
            "globe": '<circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
            "facebook": '<path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>',
            "instagram": '<rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/>',
            "play": '<polygon points="5 3 19 12 5 21 5 3"/>',
            "zoom-in": '<circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/>',
            "plus": '<path d="M5 12h14"/><path d="M12 5v14"/>',
            "plus-circle": '<circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/>',
            "minus": '<path d="M5 12h14"/>',
            "share-2": '<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/>',
            "flag": '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/>',
            "palette": '<circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>',
            "timer": '<line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/>',
            "tag": '<path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94 .94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/>',
            "clock": '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
            "bell": '<path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>',
            "alert-circle": '<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>',
            "alert-triangle": '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>',
            "filter": '<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>',
            "download": '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>',
            "sliders-horizontal": '<line x1="21" x2="14" y1="4" y2="4"/><line x1="10" x2="3" y1="4" y2="4"/><line x1="21" x2="12" y1="12" y2="12"/><line x1="8" x2="3" y1="12" y2="12"/><line x1="21" x2="16" y1="20" y2="20"/><line x1="12" x2="3" y1="20" y2="20"/><line x1="14" x2="14" y1="2" y2="6"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="16" x2="16" y1="18" y2="22"/>',
            "layout-dashboard": '<rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/>',
            "activity": '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
            "folder-plus": '<path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2Z"/><line x1="12" x2="12" y1="10" y2="16"/><line x1="9" x2="15" y1="13" y2="13"/>',
            "folder-open": '<path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/>',
            "settings": '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            "settings-2": '<path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/>',
            "log-out": '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>',
            "message-square-warning": '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M12 7v2"/><path d="M12 13h.01"/>',
            "layout-template": '<rect width="18" height="18" x="3" y="3" rx="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="9" y2="21"/>',
            "monitor": '<rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>',
            "layout": '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="9" y2="21"/>',
            "trending-up": '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
            "credit-card": '<rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>',
            "mail": '<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>',
            "external-link": '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/>',
            "refresh-cw": '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            "refresh-ccw": '<path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/>',
            "list-ordered": '<line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/>',
            "help-circle": '<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>',
            "home": '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            
            // أيقونات مفقودة (تمت إضافتها لإصلاح النجوم والتعليقات)
            "star": '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            "quote": '<path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/>',

            // أيقونات الأقسام الجديدة (Apple Style)
            "gem": '<path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/>',
            "layers": '<path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/>',
            "scissors": '<circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/>',
            "wrench": '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
            "percent": '<line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>',
            "panel-top": '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/>',
            "sparkles": '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/>'
        };

        // دالة إنشاء الأيقونات (بديل خفيف جداً)
        window.lucide = {
            createIcons: () => {
                document.querySelectorAll('[data-lucide]').forEach(el => {
                    const name = el.getAttribute('data-lucide');
                    const content = ICONS[name];
                    if (content) {
                        const size = el.getAttribute('size') || 24;
                        const className = el.getAttribute('class') || '';
                        
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        svg.setAttribute('viewBox', '0 0 24 24');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        svg.setAttribute('stroke-width', '2');
                        svg.setAttribute('stroke-linecap', 'round');
                        svg.setAttribute('stroke-linejoin', 'round');
                        if(className) svg.setAttribute('class', className);
                        svg.innerHTML = content;
                        
                        el.replaceWith(svg);
                    }
                });
            }
        };

        // ==========================================
        // إعدادات الإشعارات (هام جداً)
        // ==========================================
        // ضع رابط Google Apps Script Web App هنا بين علامات التنصيص
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeZJyOp0X4_CUWeoB_Bhkt75CCH-dEu0QKjkSOJsb-7MvNgYx8tgFKdCvVT64tp8frzg/exec"; 
        
        // Admin Configuration
        const ADMIN_EMAIL = 'gedar.fayoum@gmail.com';
        
        // Delivery Configuration
        const DELIVERY_AREAS = [
            "العبودي", "الإصلاح الزراعي", "المسلة", "رفعت عزمي", 
            "النويرى", "المستشفي العام", "دلة", "موقف مصر"
        ];
        const FIXED_DELIVERY_FEE = 70;

        // Global State
        let db, auth, appId, user;
        
        // Firebase Functions Placeholders (To be loaded dynamically)
        let initializeApp, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut;
        let getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion, serverTimestamp, runTransaction, query, limit, where, orderBy;

        let CATEGORIES = [];
        let PRODUCTS = [];
        let ALL_REVIEWS = []; 
        let ALL_ORDERS = []; // NEW: Store orders
        let REAL_WORKS = []; // 🆕 Global variable for Real Work images
        let realWorkLimit = 4; // 🆕 متغير لتتبع عدد الصور المعروضة حالياً
        let cart = [];
        let favorites = [];
        let isDataLoaded = false; // NEW: To handle direct link loading state
        
        // Lightbox State
        let currentLightboxIndex = 0;

        // 🆕 Helper: Extract YouTube ID
        window.getYouTubeID = (url) => {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- 🆕 NEW: Smart Image Optimizer Helper ---
        // وظيفة: تحويل الروابط السيئة (GitHub Raw) إلى CDN سريع تلقائياً
        window.optimizeImageUrl = (url) => {
            if (!url) return 'https://via.placeholder.com/400x500?text=No+Image';
            
            // 1. Convert GitHub Raw to jsDelivr (Fast CDN + Cache)
            if (url.includes('raw.githubusercontent.com')) {
                // FIX: Remove 'refs/heads' segment which breaks jsDelivr links
                let cleanUrl = url.replace('/refs/heads', '');
                
                // Convert: https://raw.githubusercontent.com/user/repo/main/path/to/image.jpg
                // To: https://cdn.jsdelivr.net/gh/user/repo@main/path/to/image.jpg
                return cleanUrl.replace('raw.githubusercontent.com', 'cdn.jsdelivr.net/gh')
                               .replace('/main/', '@main/');
            }
            
            // 2. Facebook CDN Warning (Console only, can't fix automatically without proxy)
            if (url.includes('fbcdn.net') || url.includes('facebook.com')) {
                // console.warn('Performance Warning: Using Facebook CDN image:', url);
            }

            return url;
        };
        // ---------------------------------------------

        // --- NEW: Lightbox Functions (Updated for Video) ---
        window.openLightbox = (index) => {
            if (!REAL_WORKS || REAL_WORKS.length === 0) return;
            
            const modal = document.getElementById('lightbox-modal');
            
            currentLightboxIndex = index;
            
            // Show modal first
            modal.classList.remove('hidden');
            // Small delay to allow CSS transition for opacity
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
            });

            // Update content
            updateLightboxContent();
            
            // Add Keyboard Listener
            document.addEventListener('keydown', handleLightboxKeys);
            // Disable Body Scroll
            document.body.style.overflow = 'hidden';
        };

        window.closeLightbox = () => {
            const modal = document.getElementById('lightbox-modal');
            modal.classList.add('opacity-0');
            
            // Stop Video Playback immediately by clearing src
            const iframe = document.getElementById('lightbox-video');
            if(iframe) iframe.src = '';

            setTimeout(() => {
                modal.classList.add('hidden');
                // Reset Image
                const img = document.getElementById('lightbox-img');
                if(img) {
                    img.style.transform = 'scale(0.95)';
                    img.style.opacity = '0';
                }
            }, 300);

            document.removeEventListener('keydown', handleLightboxKeys);
            document.body.style.overflow = '';
        };

        window.changeLightboxImage = (dir) => {
            // dir: 1 (Next), -1 (Prev)
            currentLightboxIndex += dir;
            
            // Loop functionality
            if (currentLightboxIndex >= REAL_WORKS.length) currentLightboxIndex = 0;
            if (currentLightboxIndex < 0) currentLightboxIndex = REAL_WORKS.length - 1;
            
            updateLightboxContent();
        };

        function updateLightboxContent() {
            const url = REAL_WORKS[currentLightboxIndex];
            const ytId = getYouTubeID(url);
            
            const imgEl = document.getElementById('lightbox-img');
            const vidContainer = document.getElementById('lightbox-video-container');
            const iframe = document.getElementById('lightbox-video');
            const counter = document.getElementById('lightbox-counter');
            
            // Update counter
            if(counter) counter.innerText = `${currentLightboxIndex + 1} / ${REAL_WORKS.length}`;

            // Reset States
            imgEl.style.opacity = '0';
            imgEl.style.transform = 'scale(0.98)';
            
            // Logic to switch between Video and Image
            if (ytId) {
                // It's a Video
                imgEl.classList.add('hidden');
                vidContainer.classList.remove('hidden');
                
                // Set AutoPlay for smooth experience
                iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&rel=0`;
            } else {
                // It's an Image
                vidContainer.classList.add('hidden');
                iframe.src = ''; // Stop any playing video
                imgEl.classList.remove('hidden');
                
                setTimeout(() => {
                    imgEl.src = url;
                    // Fade in on load
                    imgEl.onload = () => {
                        imgEl.style.opacity = '1';
                        imgEl.style.transform = 'scale(1)';
                    };
                }, 50);
            }
        }

        function handleLightboxKeys(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') changeLightboxImage(1); // Left Arrow = Next (in RTL visuals)
            if (e.key === 'ArrowRight') changeLightboxImage(-1); // Right Arrow = Prev (in RTL visuals)
        }
        // ------------------------------

        // Tracking Data Loading
        let initialCatsLoaded = false;
        let initialProdsLoaded = false;

        // NEW: Load Data from Cache (Speed Booster)
        function loadCachedData() {
            try {
                // 1. Load Categories
                const cachedCats = localStorage.getItem('gedar_categories_cache');
                if (cachedCats) {
                    const parsed = JSON.parse(cachedCats);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        CATEGORIES = parsed;
                        initialCatsLoaded = true;
                    }
                }

                // 2. Load Products
                const cachedProds = localStorage.getItem('gedar_products_cache');
                if (cachedProds) {
                    const parsed = JSON.parse(cachedProds);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        PRODUCTS = parsed;
                        initialProdsLoaded = true;
                        isDataLoaded = true;
                    }
                }

                // 3. Load Reviews (NEW)
                const cachedReviews = localStorage.getItem('gedar_reviews_cache');
                if (cachedReviews) {
                    const parsed = JSON.parse(cachedReviews);
                    if (Array.isArray(parsed)) {
                        ALL_REVIEWS = parsed;
                    }
                }

                // 4. Load Real Work Images (NEW)
                const cachedRealWorks = localStorage.getItem('gedar_realwork_cache');
                if (cachedRealWorks) {
                    const parsed = JSON.parse(cachedRealWorks);
                    if (Array.isArray(parsed)) {
                        REAL_WORKS = parsed;
                    }
                }

                // 5. Render Immediately if we have data
                if (initialCatsLoaded || initialProdsLoaded) {
                    // Update Mega Menu immediately with what we have
                    if (CATEGORIES.length > 0) updateMegaMenu();
                    
                    // Render current view
                    renderView();
                    
                    console.log("🚀 Loaded ALL data from cache instantly");
                }
            } catch (e) {
                console.error("Cache Load Error:", e);
            }
        }

        // NEW: Global interval for countdowns
        let countdownInterval = null;
        let bannerScrollTimers = {}; // متغير لتخزين مؤقتات الحركة التلقائية
        let lastPlacedOrder = null; // ✅ تم إضافة هذا المتغير لمنع الأخطاء
        
        // NEW: متغير لتتبع هل تم فتح السلة تلقائياً أم لا
        let hasAutoOpenedCart = false;

        // NEW: Lock flags to prevent double submission (تحسينات لازمة)
        let isOrderSubmitting = false;
        let isPaymentSubmitting = false;

        // خريطة حالات الطلب للنصوص العربية (للإشعارات)
        const STATUS_ARABIC_MAP = {
            'new': 'تم استلام الطلب',
            'pending_payment': 'بانتظار الدفع',
            'payment_review': 'جاري مراجعة الدفع',
            'confirmed': 'تم تأكيد الطلب والدفع',
            'processing': 'جاري تجهيز الطلب',
            'shipped': 'تم شحن الطلب',
            'delivered': 'تم توصيل الطلب بنجاح',
            'cancelled': 'تم إلغاء الطلب',
            'expired': 'منتهية الصلاحية (لم يتم الدفع)' // 3️⃣ New Status
        };

        // NEW: Hero Settings State (Initialized Empty)
        let HERO_SETTINGS = {
            // Logo Settings
            logoUrl: "",
            logoSize: "100",
            profileUrl: "", // 🆕 New Field for Profile Picture
            
            // Image Configuration
            imageBaseUrl: "",
            imageDefaultExt: ".webp",
            
            // Header Banner Settings (Separate Mobile/Desktop)
            footerBannerUrl: "",
            footerBannerUrlMobile: "", 
            fbHeightDesktop: "300", fbHeightMobile: "150",
            fbWidthDesktop: "90", fbWidthMobile: "95",
            fbRadiusDesktop: "2rem", fbRadiusMobile: "1rem",
            showFooterBanner: false,
            
            // REMOVED: Category Banner Settings
            
            // Best Seller Banner
            bestSellerBannerUrl: "",
            bestSellerBannerHeight: "200",
            bestSellerBannerWidth: "100",
            showBestSellerBanner: false,
            
            // Featured Banner (Top)
            featuredBannerUrl: "",
            featuredBannerHeight: "200",
            featuredBannerWidth: "100",
            showFeaturedBanner: false,
            
            // Payment Banner Settings
            paymentBannerUrl: "",
            showPaymentBanner: false,
            paymentBannerHeight: "60",
            paymentBannerWidth: "auto"
        };
        let currentView = 'home';
        let currentAdminTab = 'dashboard';
        let currentOrderTab = 'active'; 
        let currentProductId = null;
        let currentEditProduct = null;
        let currentEditCategoryName = null; // NEW: Track category being edited
        let shopState = { search: '', categories: [], priceMin: 0, priceMax: 10000, sort: 'featured' };
        
        // NEW: Admin Order Filter State
        let adminOrderFilter = 'all'; // all, pending, vodafone, today

        let detailsQuantity = 1;
        let activeImageIndex = 0;
        let currentSelectedColor = null; // متغير جديد لتخزين اللون المختار

        // --- NEW: Helper to check if discount is valid ---
        function isDiscountActive(p) {
            if (!p.discount || p.discount <= 0) return false;
            // If no expiry is set, discount is always active (permanent)
            if (!p.discountExpiry) return true;
            // Check if current time is before expiry
            return p.discountExpiry > Date.now();
        }

        // --- Init ---
        async function init() {
            // 1. الأولوية القصوى: تشغيل المكتبات وتحميل الكاش (First Meaningful Paint)
            lucide.createIcons();
            
            // استعادة الحالة المحلية (سريعة جداً)
            const savedFavs = localStorage.getItem('aura_favorites');
            if (savedFavs) try { favorites = JSON.parse(savedFavs); updateFavoritesUI(); } catch(e) {}

            const savedCart = localStorage.getItem('gedar_cart');
            if (savedCart) try { cart = JSON.parse(savedCart); updateCartUI(); } catch(e) {}

            // تحديد الصفحة الحالية قبل الرسم
            window.addEventListener('hashchange', handleRouting);
            handleRouting(); 

            // 🚀 عرض المحتوى المخزن في الكاش فوراً
            loadCachedData();

            // تحسين الأداء: مستمعات الأحداث (Scroll & Click)
            let lastScrollY = window.scrollY;
            let scrollTicking = false;

            window.addEventListener('scroll', () => {
                lastScrollY = window.scrollY;
                if (!scrollTicking) {
                    window.requestAnimationFrame(() => {
                        const nav = document.getElementById('navbar');
                        if (nav) {
                            if (lastScrollY > 20) {
                                nav.classList.add('shadow-md');
                            } else {
                                nav.classList.remove('shadow-md');
                            }
                        }
                        scrollTicking = false;
                    });
                    scrollTicking = true;
                }
            }, { passive: true });

            document.addEventListener('click', (e) => {
                const wrapper = document.getElementById('top-search-wrapper');
                if (wrapper && !wrapper.contains(e.target)) {
                    closeTopSearch();
                }
            });

            // 2. تحميل فايربيس والبيانات فوراً (تمت إزالة التأخير لسرعة عرض المنتجات)
            // لم نعد ننتظر window.load لتسريع جلب البيانات
            try {
                console.log("⚡ Loading Firebase Immediately...");
                
                // استيراد المكتبات بشكل ديناميكي (Lazy Loading)
                const [fbApp, fbAuth, fbFirestore] = await Promise.all([
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")
                ]);

                // تعيين الدوال للمتغيرات العامة
                initializeApp = fbApp.initializeApp;
                getAuth = fbAuth.getAuth;
                signInAnonymously = fbAuth.signInAnonymously;
                onAuthStateChanged = fbAuth.onAuthStateChanged;
                GoogleAuthProvider = fbAuth.GoogleAuthProvider;
                signInWithPopup = fbAuth.signInWithPopup;
                signOut = fbAuth.signOut;

                getFirestore = fbFirestore.getFirestore;
                collection = fbFirestore.collection;
                doc = fbFirestore.doc;
                getDoc = fbFirestore.getDoc;
                getDocs = fbFirestore.getDocs; // ✅ Import getDocs
                setDoc = fbFirestore.setDoc;
                addDoc = fbFirestore.addDoc;
                onSnapshot = fbFirestore.onSnapshot;
                updateDoc = fbFirestore.updateDoc;
                deleteDoc = fbFirestore.deleteDoc;
                arrayUnion = fbFirestore.arrayUnion;
                serverTimestamp = fbFirestore.serverTimestamp;
                runTransaction = fbFirestore.runTransaction;
                
                // NEW: Query functions for optimization
                query = fbFirestore.query;
                limit = fbFirestore.limit;
                where = fbFirestore.where;
                orderBy = fbFirestore.orderBy;

                const firebaseConfig = {
                    apiKey: "AIzaSyAQoLRMCHjOW_jWHtuYppSLxzaYhPZUj40",
                    authDomain: "gedarwebsitenew.firebaseapp.com",
                    projectId: "gedarwebsitenew",
                    storageBucket: "gedarwebsitenew.firebasestorage.app",
                    messagingSenderId: "164355005674",
                    appId: "1:164355005674:web:ce33a2b8694c2e9507cb93",
                    measurementId: "G-8FPJKYQT4X"
                };
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                onAuthStateChanged(auth, (u) => {
                    // Security Check: Enforce Owner Only for Google Sign-In
                    if (u && !u.isAnonymous && u.email !== ADMIN_EMAIL) {
                        signOut(auth).then(() => {
                            showToast("عذراً، هذا الحساب غير مصرح له بالدخول. الدخول للمالك فقط.");
                        });
                        return;
                    }

                    user = u;
                    updateUserUI();
                    
                    if (user) {
                        setupDataListeners();
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Anon Auth Error:", err));
                    }
                });
            } catch (error) {
                console.warn("⚠️ Firebase connection warning:", error);
            }
        }

        // OPTIMIZED: Use getDocs for static data, onSnapshot only for critical real-time needs
        async function setupDataListeners() {
            try {
                // 1. Categories (Metadata) -> Switch to getDocs (One-time fetch)
                try {
                    const catDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store');
                    // استخدام getDoc بدلاً من onSnapshot لتخفيف الحمل
                    // سنستخدم onSnapshot فقط إذا كنا في وضع الأدمن لتحديث التعديلات فوراً
                    if (user && user.email === ADMIN_EMAIL) {
                        onSnapshot(catDoc, (snap) => processCategories(snap));
                    } else {
                        const snap = await getDoc(catDoc);
                        processCategories(snap);
                    }
                } catch (e) { console.warn("Cats Error:", e); }

                // 2. Products -> Smart Fetching Strategy (Progressive Loading)
                try {
                    const prodCol = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                    
                    if (user && user.email === ADMIN_EMAIL) {
                        // Admin needs everything real-time for editing
                        onSnapshot(prodCol, (snap) => processProducts(snap));
                    } else {
                        // User: Load first batch fast, then the rest silently
                        // Fetch only first 20 products initially for speed
                        // This solves the "heavy load" feeling
                        const firstBatchQuery = query(prodCol, limit(20)); 
                        const snap = await getDocs(firstBatchQuery);
                        
                        // If cache is empty or we have new data, process this batch
                        processProducts(snap); 
                        
                        // Fetch remaining products in background after 3 seconds
                        // This ensures the site is interactive quickly, then loads full data for search/filtering
                        setTimeout(async () => {
                            try {
                                const fullSnap = await getDocs(prodCol);
                                processProducts(fullSnap); 
                                console.log("📦 Full product catalog loaded in background");
                            } catch(err) { console.warn("Background fetch error", err); }
                        }, 3000); 
                    }
                } catch (e) { console.warn("Prods Error:", e); }

                // 3. Reviews -> Limit to approved & recent only (Optimization)
                try {
                    const reviewsCol = collection(db, 'artifacts', appId, 'public', 'data', 'reviews');
                    // مراجعات المستخدمين لا تحتاج تحديث لحظي إلا للأدمن
                    if (user && user.email === ADMIN_EMAIL) {
                        onSnapshot(reviewsCol, (snap) => {
                            ALL_REVIEWS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            // Cache for Admin as well (optional)
                            localStorage.setItem('gedar_reviews_cache', JSON.stringify(ALL_REVIEWS));
                            if (currentView === 'admin') renderView();
                        });
                    } else {
                        // User: Only fetch approved reviews, limit to 50 (instead of fetching thousands)
                        const q = query(reviewsCol, where('status', '==', 'approved'), limit(50));
                        const snap = await getDocs(q);
                        ALL_REVIEWS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        
                        // ✅ SAVE TO CACHE
                        localStorage.setItem('gedar_reviews_cache', JSON.stringify(ALL_REVIEWS));
                    }
                } catch (e) { console.warn("Reviews Error:", e); }

                // 4. Hero Settings -> Keep onSnapshot (Lightweight & Critical for UI updates)
                const heroDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero');
                onSnapshot(heroDoc, (snap) => {
                    if (snap.exists()) {
                        HERO_SETTINGS = snap.data();
                        localStorage.setItem('gedar_hero_cache', JSON.stringify(HERO_SETTINGS));
                    }
                    updateGlobalBranding();
                    if (currentView === 'home' || currentView === 'admin') renderView();
                }, (error) => { console.warn("Hero Settings Error:", error); });

                // 5. Real Work -> Switch to getDocs
                try {
                    const realWorkDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'realwork');
                    const snap = await getDoc(realWorkDoc); // One-time fetch is enough
                    if (snap.exists()) {
                        REAL_WORKS = snap.data().images || [];
                        // ✅ SAVE TO CACHE
                        localStorage.setItem('gedar_realwork_cache', JSON.stringify(REAL_WORKS));
                    } else {
                        REAL_WORKS = [];
                    }
                    if (currentView === 'home') renderView();
                } catch(e) { console.warn("RealWork Error:", e); }

                // 6. Orders -> Keep onSnapshot (Critical for Admin)
                if (user && user.email === ADMIN_EMAIL) {
                    const ordersCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    onSnapshot(ordersCol, (snap) => {
                        ALL_ORDERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        ALL_ORDERS.sort((a, b) => {
                            const getTime = (t) => {
                                if (!t) return Date.now();
                                return t.toMillis ? t.toMillis() : (t || 0);
                            };
                            return getTime(b.createdAt) - getTime(a.createdAt);
                        });
                        autoCleanupOrders(ALL_ORDERS);
                        if (currentView === 'orders' || (currentView === 'admin' && currentAdminTab === 'orders')) renderView();
                    }, (error) => { console.warn("Orders Listener Error:", error); });
                }
            } catch (err) {
                console.warn("⚠️ Data Setup Error:", err);
            }
        }

        // Helper to process categories (used by both onSnapshot and getDoc)
        function processCategories(snap) {
            if (snap.exists()) {
                let cats = snap.data().categories || [];
                CATEGORIES = cats
                    .map(c => typeof c === 'string' ? { name: c, image: 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500' } : c)
                    .filter(c => c && c.name && c.name !== 'undefined' && c.name.trim() !== '');
                
                localStorage.setItem('gedar_categories_cache', JSON.stringify(CATEGORIES));
            } else {
                if(!CATEGORIES.length) { setDoc(snap.ref, { categories: [] }); CATEGORIES = []; }
            }
            initialCatsLoaded = true;
            updateMegaMenu();
            if (currentView === 'shop' || currentView === 'categories' || currentView === 'admin') renderView();
        }

        // Helper to process products
        function processProducts(snap) {
            PRODUCTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            isDataLoaded = true;
            localStorage.setItem('gedar_products_cache', JSON.stringify(PRODUCTS));
            initialProdsLoaded = true;
            // FIXED: Added 'offers' to the re-render list so offers appear when data loads
            if (currentView === 'product-details' || currentView === 'home' || currentView === 'shop' || currentView === 'offers') renderView();
        }

        // --- 3️⃣ NEW: Auto Cleanup Function (التنظيف الذكي) ---
        async function autoCleanupOrders(orders) {
            const now = Date.now();
            const EXPIRATION_LIMIT = 48 * 60 * 60 * 1000; // 48 ساعة بالميلي ثانية

            // فلترة الطلبات التي تحتاج تنظيف
            const expiredOrders = orders.filter(o => {
                // نتحقق فقط من الطلبات التي في انتظار الدفع (Pending)
                const isPending = o.status === 'pending_payment';
                if (!isPending) return false;

                // حساب وقت الطلب (تصحيح الجليتش)
                let orderTime = now; // القيمة الافتراضية: "الآن" (لمنع الحذف بالخطأ)

                if (o.createdAt) {
                    if (typeof o.createdAt.toMillis === 'function') {
                        orderTime = o.createdAt.toMillis();
                    } else if (typeof o.createdAt === 'number') {
                        orderTime = o.createdAt;
                    } else {
                        const parsed = new Date(o.createdAt).getTime();
                        if (!isNaN(parsed) && parsed > 0) orderTime = parsed;
                    }
                }
                
                // الشرط: مر أكثر من 48 ساعة
                // إذا كان orderTime = now (في حالة الخطأ)، النتيجة ستكون 0 وهي ليست أكبر من 48 ساعة، لذا الطلب بأمان
                return (now - orderTime) > EXPIRATION_LIMIT;
            });

            if (expiredOrders.length === 0) return; // لا يوجد شيء للتنظيف

            // تنفيذ التحديثات (Batch updates logic handling one by one here for simplicity)
            const updates = expiredOrders.map(o => {
                return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), {
                    status: 'expired',
                    // توثيق العملية في السجل الزمني
                    statusHistory: arrayUnion({
                        status: 'expired',
                        timestamp: Date.now(),
                        note: 'نظام التنظيف الذكي: تم إلغاء الطلب تلقائياً لعدم إرسال إثبات الدفع خلال 48 ساعة'
                    })
                });
            });

            try {
                await Promise.all(updates);
                // إظهار التنبيه فقط إذا تم حذف طلبات بالفعل
                if(expiredOrders.length > 0) {
                    showToast(`🧹 التنظيف الذكي: تم تحويل ${expiredOrders.length} طلب قديم إلى منتهي الصلاحية`);
                }
            } catch (err) {
                console.error("Auto Cleanup Error:", err);
            }
        }
        // -----------------------------------------------------

        function updateUserUI() {
            const container = document.getElementById('user-menu-container');
            const mobileSection = document.getElementById('mobile-user-section');
            const mobileAdminLink = document.getElementById('mobile-admin-link');
            const isAnon = user ? user.isAnonymous : true;
            const isAdmin = user && user.email === ADMIN_EMAIL;

            if (isAnon) {
                // تم إزالة hidden sm:block لتظهر الأيقونة دائماً
                container.innerHTML = `<button onclick="setView('login')" class="p-2 hover:bg-stone-100 rounded-full transition-colors" title="تسجيل الدخول"><i data-lucide="user"></i></button>`;
                mobileSection.innerHTML = `<button onclick="setView('login'); toggleMobileMenu()" class="w-full text-center py-2 bg-stone-900 text-white rounded-xl">تسجيل الدخول</button>`;
                if(mobileAdminLink) mobileAdminLink.innerHTML = '';
            } else {
                const avatar = user.photoURL || '';
                const name = user.displayName || 'مستخدم';
                const email = user.email || '';

                // Modern User Dropdown Design
                // --- 3. تحديث قائمة المستخدم لتكون انسيابية (invisible/visible بدلاً من hidden/block) ---
                container.innerHTML = `
                    <button class="flex items-center gap-2 p-1 pl-2 hover:bg-stone-100 rounded-full flex border border-transparent hover:border-stone-200 transition-all group-hover/user:bg-white group-hover/user:shadow-sm" aria-label="قائمة المستخدم">
                        ${avatar ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow-sm" alt="${name}">` : `<div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-600"><i data-lucide="user" size="16"></i></div>`}
                        <i data-lucide="chevron-down" size="14" class="text-stone-600 group-hover/user:text-stone-800 transition-colors hidden sm:block"></i>
                    </button>
                    
                    <div class="absolute top-full left-0 mt-3 w-72 bg-white/95 backdrop-blur-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.15)] rounded-2xl border border-stone-100 overflow-hidden invisible opacity-0 translate-y-2 group-hover/user:visible group-hover/user:opacity-100 group-hover/user:translate-y-0 z-50 p-2 transform origin-top-left transition-all duration-300 ease-out">
                        
                        <!-- Profile Header -->
                        <div class="p-4 mb-2 bg-white/80 rounded-xl flex items-center gap-4 border border-stone-100">
                             ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full object-cover ring-4 ring-white shadow-sm" alt="${name}">` : `<div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm text-stone-600"><i data-lucide="user" size="24"></i></div>`}
                            <div class="overflow-hidden">
                                <p class="font-bold text-stone-900 text-sm truncate">${name}</p>
                                <p class="text-[11px] text-stone-600 truncate font-medium">${email}</p>
                                ${isAdmin ? `<span class="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full">المدير</span>` : `<span class="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full">عميل</span>`}
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <div class="space-y-1">
                            ${isAdmin ? `
                            <button onclick="setView('admin')" class="w-full text-right px-3 py-2.5 hover:bg-white rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i data-lucide="layout-dashboard" size="16"></i></div> لوحة التحكم</span>
                            </button>
                            ` : ''}
                            
                            <!-- تم تحديث الرابط هنا ليوجه لتبويب الطلبات داخل اللوحة -->
                            <button onclick="${isAdmin ? "setAdminView('orders')" : "showToast('قريباً...')"}" class="w-full text-right px-3 py-2.5 hover:bg-white rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors"><i data-lucide="package" size="16"></i></div> طلبات العملاء</span>
                                ${isAdmin ? `<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full" id="orders-badge" ${ALL_ORDERS.length===0?'style="display:none"':''}>${ALL_ORDERS.filter(o=>!o.isArchived).length}</span>` : ''}
                            </button>
                            
                            <div class="h-px bg-stone-100 my-2 mx-2"></div>
                            
                            <button onclick="handleLogout()" class="w-full text-right px-3 py-2.5 hover:bg-red-50 text-stone-600 hover:text-red-600 rounded-xl text-sm font-bold flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-stone-100 text-stone-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors"><i data-lucide="log-out" size="16"></i></div> تسجيل الخروج</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Mobile Section (Simpler version)
                mobileSection.innerHTML = `
                    <div class="flex items-center gap-3 mb-6 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                        ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full border-2 border-white shadow-md" alt="${name}">` : `<div class="w-12 h-12 bg-stone-200 rounded-full flex items-center justify-center"><i data-lucide="user"></i></div>`}
                        <div class="overflow-hidden">
                            <p class="font-bold text-lg text-stone-900">${name}</p>
                            <p class="text-xs text-stone-600 truncate">${email}</p>
                        </div>
                    </div>
                    <button onclick="handleLogout(); toggleMobileMenu()" class="w-full flex items-center justify-center gap-2 py-3 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 transition-colors">
                        <i data-lucide="log-out" size="18"></i> تسجيل الخروج
                    </button>
                `;

                if(isAdmin && mobileAdminLink) {
                    mobileAdminLink.innerHTML = `<button onclick="setView('admin'); toggleMobileMenu()" class="flex items-center gap-2 text-sm text-stone-600"><i data-lucide="settings" size="18"></i> الإدارة</button>`;
                } else if (mobileAdminLink) {
                    mobileAdminLink.innerHTML = '';
                }
            }
            lucide.createIcons();
        }

        // --- Exposed Logic ---
        
        // NEW: Routing Handler (Updated for Deep Linking)
        function handleRouting() {
            const hash = window.location.hash; 
            
            // If no hash or just #/, default to home
            if (!hash || hash === '#/' || hash === '#') {
                if(currentView !== 'home') {
                    setView('home');
                }
                return;
            }

            const path = hash.replace(/^#\//, ''); // remove #/
            const parts = path.split('/'); // split by /
            
            const route = parts[0];
            
            if (route === 'product' && parts[1]) {
                // Route: #/product/{id}
                currentProductId = parts[1];
                currentView = 'product-details';
            } else if (route === 'admin') {
                // Route: #/admin or #/admin/orders
                currentView = 'admin';
                if(parts[1]) currentAdminTab = parts[1];
                else currentAdminTab = 'dashboard';
            } else if (route) {
                // Generic Routes: #/shop, #/about, #/return-policy etc.
                currentView = route;
            } else {
                currentView = 'home';
            }
            
            // Clean up admin edit states if leaving admin
            if (currentView !== 'admin') {
                currentEditProduct = null;
                currentEditCategoryName = null;
            }

            renderView();
            window.scrollTo(0, 0);
        }

        window.setView = (view, param) => {
            // Clear any running countdowns when switching views
            if (countdownInterval) clearInterval(countdownInterval);

            currentView = view;
            
            // 🆕 إعادة تعيين حد عرض الصور عند العودة للرئيسية
            if (view === 'home') {
                realWorkLimit = 4;
            }
            
            if(view !== 'admin' && view !== 'orders') currentEditProduct = null;
            if(view === 'admin' && !currentAdminTab) currentAdminTab = 'dashboard';
            
            // UPDATE: URL Hash Logic (Smart URL Update)
            let targetHash = '/';
            
            if (view === 'home') {
                targetHash = '/';
            } else if (view === 'offers') {
                targetHash = '/offers';
            } else if (view === 'faq') { // NEW ROUTE
                targetHash = '/faq';
            } else if (view === 'product-details' && param) {
                targetHash = '/product/' + param;
                currentProductId = param; // Ensure ID is set
            } else if (view === 'admin') {
                targetHash = '/admin/' + (param || currentAdminTab || 'dashboard');
                if(param) currentAdminTab = param;
            } else {
                targetHash = '/' + view;
            }
            
            // NEW: Update URL Hash without triggering reload
            if (window.location.hash !== '#' + targetHash) {
                history.pushState(null, null, '#' + targetHash);
            }

            // --- 🆕 UPDATE BOTTOM NAV ACTIVE STATE ---
            const bottomNavItems = document.querySelectorAll('#bottom-nav-bar .nav-item');
            bottomNavItems.forEach(btn => {
                const viewName = btn.dataset.view;
                // إزالة التفعيل من الكل أولاً
                btn.classList.remove('text-stone-900', 'text-red-600');
                btn.classList.add('text-stone-400');
                
                // إعادة تعيين الأيقونات
                const icon = btn.querySelector('svg');
                if(icon) icon.classList.remove('scale-110');

                // إضافة التفعيل للعنصر المطابق
                if (viewName && viewName === view) {
                    btn.classList.remove('text-stone-400');
                    if(viewName === 'offers') btn.classList.add('text-red-600');
                    else btn.classList.add('text-stone-900');
                    
                    // تأثير بسيط للأيقونة
                    if(icon) icon.classList.add('scale-110');
                }
            });
            // ----------------------------------------

            renderView();
            window.scrollTo(0, 0);
        };

        // دالة جديدة للتنقل بين تبويبات لوحة التحكم
        window.setAdminView = (tab) => {
            setView('admin', tab);
        };

        // NEW: Set Admin Order Filter
        window.setAdminOrderFilter = (filter) => {
            adminOrderFilter = filter;
            renderView();
        };

        // --- FIX: دالة التبديل بين الجارية والأرشيف (كانت مفقودة) ---
        window.setOrderTab = (tab) => {
            currentOrderTab = tab;
            // إعادة تعيين فلتر البحث عند تغيير التبويب
            adminOrderFilter = 'all'; 
            renderView();
        };
        // -----------------------------------------------------------

        // --- NEW: دالة البحث الفوري في الطلبات ---
        window.filterOrdersList = (query) => {
            const cards = document.querySelectorAll('.order-card-item');
            const q = query.toLowerCase().trim();
            
            cards.forEach(card => {
                const searchData = card.dataset.search.toLowerCase();
                if (searchData.includes(q)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        };
        // ---------------------------------------

        window.viewProduct = (id) => {
            currentProductId = id; // Ensure ID is set immediately
            detailsQuantity = 1;
            activeImageIndex = 0;
            currentSelectedColor = null; // تصفير اللون عند فتح منتج جديد
            
            // --- NEW: Save to History ---
            // Get existing history
            let historyList = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            // Remove current id if it exists (to move it to top)
            historyList = historyList.filter(hId => hId !== id);
            // Add to front
            historyList.unshift(id);
            // Limit to 10 items
            if(historyList.length > 10) historyList.pop();
            // Save back
            localStorage.setItem('gedar_history', JSON.stringify(historyList));
            // ---------------------------

            // Use setView to handle URL update properly
            setView('product-details', id);
        };

        window.scrollSlider = (dir) => {
            const s = document.getElementById('related-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 220 : -220, behavior: 'smooth' });
        };

        // NEW: Generic Banner Scroll Function (Updated for RTL Robustness)
        window.scrollBanner = (id, direction) => {
            const slider = document.getElementById(id);
            if (!slider) return;
            
            const width = slider.clientWidth;
            // direction: -1 (Left Arrow/Next in RTL), 1 (Right Arrow/Prev in RTL)
            slider.scrollBy({ left: direction * width, behavior: 'smooth' });
        };

        // NEW: Auto Scroll Logic
        window.startBannerAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // Clear existing timer to prevent duplicates
            if (bannerScrollTimers[id]) clearInterval(bannerScrollTimers[id]);

            bannerScrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                if (!element) {
                    clearInterval(bannerScrollTimers[id]);
                    return;
                }

                // Logic for infinite scrolling effect
                const maxScroll = element.scrollWidth - element.clientWidth;
                // In RTL, scrollLeft is typically negative or 0 at start. 
                // We use Math.abs to handle browser differences in RTL scroll behavior.
                const currentScroll = Math.abs(element.scrollLeft);
                
                // If we reached the end (with small tolerance), go back to start
                if (currentScroll >= maxScroll - 10) {
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // Move Next (Negative left in RTL)
                    element.scrollBy({ left: -element.clientWidth, behavior: 'smooth' });
                }
            }, 4000); // 4 seconds interval
        };

        window.stopBannerAutoScroll = (id) => {
            if (bannerScrollTimers[id]) {
                clearInterval(bannerScrollTimers[id]);
                delete bannerScrollTimers[id];
            }
        };
        
        window.scrollFeatured = (dir) => {
            const s = document.getElementById('featured-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 260 : -260, behavior: 'smooth' });
        };

        // NEW: Function to start countdown timers
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const update = () => {
                const timers = document.querySelectorAll('.discount-timer');
                if (timers.length === 0) return;

                const now = Date.now();
                timers.forEach(el => {
                    const expiry = parseInt(el.dataset.expiry);
                    const diff = expiry - now;

                    if (diff <= 0) {
                        el.innerHTML = '<span class="text-stone-600 font-bold text-xs">انتهى العرض</span>';
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    // UPDATED: Countdown Style -> bg-red-600 text-white
                    el.innerHTML = `
                        <div class="flex items-center gap-2 text-xs font-bold text-white dir-ltr bg-red-600 px-2 py-1 rounded-lg border border-red-600 shadow-sm">
                            <span class="w-5 text-center">${seconds}</span>:
                            <span class="w-5 text-center">${minutes}</span>:
                            <span class="w-5 text-center">${hours}</span>:
                            <span class="w-6 text-center">${days}ي</span>
                        </div>
                    `;
                });
            };

            update(); // Run immediately
            countdownInterval = setInterval(update, 1000);
        }

        // --- NEW: Generic Scroll Function for Product Details Sliders ---
        window.scrollSection = (id, dir) => {
            const el = document.getElementById(id);
            if(el) {
                // In RTL, scrolling negative 'left' moves to the visual left (next items)
                const scrollAmount = 300;
                el.scrollBy({ left: dir === 'next' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
            }
        };

        // --- NEW: Toggle About Section ---
        window.toggleAbout = (id) => {
            const container = document.getElementById(`about-container-${id}`);
            const fade = document.getElementById(`about-fade-${id}`);
            const btn = document.getElementById(`about-btn-${id}`);
            
            if (container.classList.contains('max-h-[100px]')) {
                // Expand
                container.classList.remove('max-h-[100px]');
                if(fade) fade.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="chevron-up" size="16"></i> عرض أقل`;
            } else {
                // Collapse
                container.classList.add('max-h-[100px]');
                if(fade) fade.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="chevron-down" size="16"></i> شاهد المزيد`;
            }
            lucide.createIcons();
        };

        // --- NEW: Share Product Logic ---
        window.shareProduct = async (id) => {
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            
            // تكوين الرابط المباشر
            // نستخدم window.location.origin و window.location.pathname لضمان أن الرابط يعمل بغض النظر عن الدومين
            const url = `${window.location.origin}${window.location.pathname}#/product/${id}`;
            
            // استخدام واجهة المشاركة الأصلية للمتصفح (للهواتف)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: product.name,
                        text: `شاهد هذا المنتج المميز من جدار: ${product.name}`,
                        url: url
                    });
                } catch (err) {
                    console.log('Sharing failed or cancelled', err);
                }
            } else {
                // النسخ للحافظة كبديل (لأجهزة الكمبيوتر أو المتصفحات القديمة)
                navigator.clipboard.writeText(url).then(() => {
                    showToast("تم نسخ رابط المنتج للحافظة");
                }).catch(() => {
                    showToast("فشل نسخ الرابط");
                });
            }
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.remove('translate-y-12', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-12', 'opacity-0'), 3000);
        };

        // --- NEW: Shop & Filter Logic (إصلاح مشكلة التصفية) ---
        
        window.filterCategory = (catName) => {
            // تفعيل القسم المختار وتصفير البحث
            shopState.categories = [catName];
            shopState.search = ''; 
            // الانتقال لصفحة المتجر
            setView('shop');
        };

        window.viewAllProducts = () => {
            // إعادة ضبط الفلاتر وعرض الكل
            shopState = { search: '', categories: [], priceMin: 0, priceMax: 10000, sort: 'featured' };
            setView('shop');
        };

        // --- NEW: Advanced Arabic Search Helper ---
        window.normalizeArabic = (text) => {
            if (!text) return "";
            return String(text)
                .replace(/(آ|إ|أ)/g, 'ا')
                .replace(/(ة)/g, 'ه')
                .replace(/(ى)/g, 'ي')
                .replace(/(ؤ)/g, 'و')
                .replace(/(ئ)/g, 'ي')
                .replace(/[\u064B-\u065F]/g, '') // إزالة التشكيل
                .toLowerCase()
                .trim();
        };

        window.updateShopFilters = (type, value) => {
            if (type === 'search') {
                shopState.search = value; // تخزين النص الخام كما كتبه المستخدم
            } else if (type === 'category') {
                // إضافة أو إزالة القسم من مصفوفة التصفية
                if (shopState.categories.includes(value)) {
                    shopState.categories = shopState.categories.filter(c => c !== value);
                } else {
                    shopState.categories.push(value);
                }
            } else if (type === 'priceMax') {
                shopState.priceMax = Number(value);
            } else if (type === 'priceMin') {
                shopState.priceMin = Number(value);
            } else if (type === 'sort') {
                shopState.sort = value;
            }
            
            // تطبيق الفلتر وتحديث الواجهة
            if (currentView === 'shop') {
                applyShopFilters();
                
                // NEW: إعادة رسم قائمة الأقسام لتحديث حالة التحديد (Checkboxes)
                if (type === 'category') {
                    const list = document.getElementById('shop-categories-list');
                    if (list) list.innerHTML = generateCategoryFilterHTML();
                }
            }
        };

        // NEW: Helper function to generate category filter HTML
        function generateCategoryFilterHTML() {
            return CATEGORIES.map(cat => {
                const isSelected = shopState.categories.includes(cat.name);
                return `
                <label class="cursor-pointer group flex items-center justify-between p-2.5 rounded-xl transition-all duration-200 border ${isSelected ? 'bg-stone-900 border-stone-900 text-white shadow-md' : 'bg-white border-transparent hover:bg-white text-stone-600'}">
                    <div class="flex items-center gap-3">
                        <div class="relative flex items-center justify-center w-5 h-5">
                            <input type="checkbox" class="peer appearance-none w-5 h-5 border-2 rounded-md transition-all duration-200 cursor-pointer ${isSelected ? 'border-white/40 bg-white/20' : 'border-stone-300 bg-white group-hover:border-stone-400'}" value="${cat.name}" onchange="updateShopFilters('category',this.value)" ${isSelected ? 'checked' : ''}>
                            <i data-lucide="check" size="12" class="absolute text-white pointer-events-none transition-all duration-200 ${isSelected ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}"></i>
                        </div>
                        <span class="font-bold text-sm select-none">${cat.name}</span>
                    </div>
                </label>`;
            }).join('');
        }

        window.resetFilters = () => {
            viewAllProducts();
        };

        // --- NEW: Missing Cart & UI Functions (إضافة دوال السلة والمفضلة المفقودة) ---

        window.addToCart = (id, selectedColor = null) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            
            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            // البحث عن المنتج في السلة (نطابق الآيدي واللون)
            const existing = cart.find(x => x.id === id && x.selectedColor === selectedColor);
            
            if (existing) {
                existing.quantity++;
                // Update price in cart to match current offer status (optional but good practice)
                existing.price = finalPrice; 
            } else {
                // Store with effective price and selected color
                cart.push({ ...p, price: finalPrice, quantity: 1, selectedColor: selectedColor });
            }
            
            saveCart();
            updateCartUI();
            
            // تعديل: فتح السلة تلقائياً فقط في المرة الأولى
            if (!hasAutoOpenedCart) {
                toggleCart(true);
                hasAutoOpenedCart = true;
            }
            
            showToast("تمت الإضافة للسلة");
        };

        // --- 5️⃣ NEW: Stepper HTML Generator Helper ---
        window.getStepperHTML = (currentStep) => {
            const steps = [
                { num: 1, label: 'السلة' },
                { num: 2, label: 'البيانات' },
                { num: 3, label: 'الدفع' },
                { num: 4, label: 'تأكيد' }
            ];
            
            let html = '<div class="flex items-center justify-between w-full dir-rtl relative">';
            
            // Background Line
            html += '<div class="absolute top-3 right-0 left-0 h-0.5 bg-stone-200 -z-0"></div>';
            
            // Progress Line (Width based on step) - RTL adjustment
            const progress = ((currentStep - 1) / (steps.length - 1)) * 100;
            html += `<div class="absolute top-3 right-0 h-0.5 bg-stone-900 -z-0 transition-all duration-500" style="width: ${progress}%"></div>`;

            html += steps.map(s => {
                const isActive = s.num <= currentStep;
                const isCurrent = s.num === currentStep;
                
                return `
                <div class="flex flex-col items-center gap-1.5 relative z-10 bg-white px-2">
                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold border-2 transition-all duration-300 ${isActive ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-600 border-stone-300'} ${isCurrent ? 'ring-2 ring-stone-100 ring-offset-2' : ''}">
                        ${isActive && !isCurrent ? '<i data-lucide="check" size="10"></i>' : s.num}
                    </div>
                    <span class="text-[9px] font-bold ${isActive ? 'text-stone-900' : 'text-stone-600'} transition-colors">${s.label}</span>
                </div>
                `;
            }).join('');
            
            html += '</div>';
            return html;
        };
        // ---------------------------------------------

        window.toggleCart = (show) => {
            const backdrop = document.getElementById('cart-drawer-backdrop');
            const drawer = document.getElementById('cart-drawer');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                drawer.classList.remove('-translate-x-full');
                
                // Inject Stepper (Step 1)
                const stepper = document.getElementById('cart-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(1);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                drawer.classList.add('-translate-x-full');
            }
            lucide.createIcons();
        };

        window.saveCart = () => localStorage.setItem('gedar_cart', JSON.stringify(cart));

        window.removeFromCartByIndex = (index) => {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
        };

        // NEW: Clear Cart Function
        window.clearCart = () => {
            if(cart.length === 0) return;
            if(!confirm("هل أنت متأكد من تفريغ السلة بالكامل؟")) return;
            cart = [];
            saveCart();
            updateCartUI();
            showToast("تم تفريغ السلة");
        };

        window.updateQuantityByIndex = (index, change) => {
            const item = cart[index];
            if(item) {
                item.quantity += change;
                if(item.quantity < 1) item.quantity = 1;
                saveCart();
                updateCartUI();
            }
        };

        // --- UPDATED: تحسين دالة المفضلة (تحديث فوري + حركة) ---
        window.toggleFavorite = (id) => {
            const index = favorites.indexOf(id);
            const isAdding = index === -1;

            if (isAdding) {
                favorites.push(id);
            } else {
                favorites.splice(index, 1);
            }
            
            localStorage.setItem('aura_favorites', JSON.stringify(favorites));
            updateFavoritesUI(); // تحديث العداد العلوي فقط
            
            // --- التحديث الفوري للأزرار دون إعادة تحميل الصفحة ---
            // نبحث عن كل أزرار المفضلة التي تحمل كلاس هذا المنتج
            const btns = document.querySelectorAll(`.fav-btn-${id}`);
            
            btns.forEach(btn => {
                if (isAdding) {
                    // تفعيل القلب
                    btn.classList.remove('text-stone-600', 'border-stone-100');
                    btn.classList.add('text-red-600', 'border-red-100');
                    
                    // إضافة حركة التكبير
                    btn.classList.add('heart-pop');
                    setTimeout(() => btn.classList.remove('heart-pop'), 450); // إزالة الكلاس بعد انتهاء الحركة

                    // ملء الأيقونة باللون
                    const icon = btn.querySelector('svg');
                    if (icon) icon.classList.add('fill-current');
                } else {
                    // إلغاء تفعيل القلب
                    btn.classList.add('text-stone-600', 'border-stone-100');
                    btn.classList.remove('text-red-600', 'border-red-100');
                    
                    const icon = btn.querySelector('svg');
                    if (icon) icon.classList.remove('fill-current');
                }
            });

            // فقط إذا كنا داخل صفحة "المفضلة" نقوم بإعادة الرسم لإخفاء العنصر المحذوف
            if (currentView === 'favorites' && !isAdding) {
                renderFavoritesPage(document.getElementById('main-content'));
                lucide.createIcons();
            }
            
            showToast(isAdding ? "تمت الإضافة للمفضلة ❤️" : "تم الحذف من المفضلة 💔");
        };
        // -----------------------------------------------------
        
        // دوال مساعدة لصفحة تفاصيل المنتج
        window.setActiveImage = (idx) => {
            activeImageIndex = idx;
            const mainImg = document.getElementById('main-product-image');
            const thumbs = document.querySelectorAll('.gallery-thumb');
            const p = PRODUCTS.find(x => x.id === currentProductId);
            const images = (p && p.images && p.images.length) ? p.images : (p ? [p.image] : []);
            
            if(mainImg && images[idx]) mainImg.src = images[idx];
            
            thumbs.forEach((t, i) => {
                if(i === idx) t.classList.add('active');
                else t.classList.remove('active');
            });
        };

        window.changeDetailsQuantity = (d) => {
            detailsQuantity += d;
            if(detailsQuantity < 1) detailsQuantity = 1;
            const el = document.getElementById('details-qty');
            if(el) el.innerText = detailsQuantity;
        };

        window.addToCartFromDetails = (id) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;

            // التحقق مما إذا كان المنتج يحتوي على ألوان ولم يتم اختيار لون
            if (p.variants && p.variants.length > 0 && !currentSelectedColor) {
                showToast("يرجى اختيار اللون أولاً");
                // Scroll to variants section
                const variantsSec = document.getElementById('variants-section');
                if(variantsSec) variantsSec.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            const existing = cart.find(x => x.id === id && x.selectedColor === currentSelectedColor);
            if (existing) {
                existing.quantity += detailsQuantity;
                existing.price = finalPrice;
            } else {
                cart.push({ ...p, price: finalPrice, quantity: detailsQuantity, selectedColor: currentSelectedColor });
            }
            
            saveCart();
            updateCartUI();
            showToast("تمت الإضافة للسلة");
        };

        window.toggleMobileMenu = () => {
             const m = document.getElementById('mobile-menu');
             if(m) {
                 m.classList.toggle('hidden');
                 m.classList.toggle('flex');
             }
        };

        // --- Checkout Logic ---
        
        window.checkout = () => {
            if (cart.length === 0) return showToast("السلة فارغة");
            
            // Reset fields
            document.getElementById('delivery-check').checked = false;
            document.getElementById('checkout-address').value = ''; 
            
            // Reset Payment to Default (COD)
            const radios = document.getElementsByName('paymentMethod');
            if(radios.length > 0) radios[0].checked = true;
            if(window.updatePaymentUI) window.updatePaymentUI();

            // Initial Calculation
            calculateCheckoutTotal();
            
            // Close cart drawer & Open modal
            toggleCart(false);
            toggleCheckoutModal(true);
        };
        
        // NEW: Update UI based on selection
        window.updatePaymentUI = () => {
            const el = document.querySelector('input[name="paymentMethod"]:checked');
            const method = el ? el.value : 'cod';
            const label = document.getElementById('payment-method-label');
            const partialOption = document.getElementById('partial-payment-option');
            const isPartialCheck = document.getElementById('isPartial');
            
            if (!label) return;

            if (method === 'vodafone_cash') {
                partialOption.classList.remove('hidden');
                
                if (isPartialCheck && isPartialCheck.checked) {
                    label.innerText = 'عربون (مقدم)';
                    label.className = 'inline-block bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded font-bold';
                } else {
                    label.innerText = 'المحافظ الإلكترونية';
                    label.className = 'inline-block bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded font-bold';
                }
            } else {
                partialOption.classList.add('hidden');
                if(isPartialCheck) isPartialCheck.checked = false; // Reset checkbox
                
                label.innerText = 'دفع عند الاستلام';
                label.className = 'inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold';
            }
        };

        window.calculateCheckoutTotal = () => {
            const isDelivery = document.getElementById('delivery-check').checked;
            const address = document.getElementById('checkout-address').value.trim();
            const totalDisplay = document.getElementById('checkout-total-display');
            const noteDisplay = document.getElementById('delivery-note');
            
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let finalTotal = cartTotal;
            let note = "";
            let showNote = false;

            if (isDelivery) {
                // Check if address contains any of the predefined areas
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                
                if (isFixedArea) {
                    finalTotal += FIXED_DELIVERY_FEE;
                    note = `+ ${FIXED_DELIVERY_FEE} ج.م مصاريف توصيل`;
                    showNote = true;
                } else {
                    // Delivery requested but area not matched yet or unknown
                    note = "حساب التوصيل مع المندوب عند الاستلام";
                    showNote = true;
                }
            } else {
                note = "بدون توصيل (استلام من الفرع)";
                showNote = false;
            }

            totalDisplay.innerText = `$${finalTotal.toFixed(2)}`;
            noteDisplay.innerText = note;
            if(showNote) noteDisplay.classList.remove('hidden');
            else noteDisplay.classList.add('hidden');
        };

        window.toggleCheckoutModal = (show) => {
            const backdrop = document.getElementById('checkout-modal-backdrop');
            const modal = document.getElementById('checkout-modal');
            
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');

                // Inject Stepper (Step 2)
                const stepper = document.getElementById('checkout-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(2);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // --- 🆕 FIXED: Track Order Search Handler ---
        window.handleTrackOrderSearch = async (e) => {
            e.preventDefault();
            const orderId = e.target.orderId.value.trim();
            const resultContainer = document.getElementById('tracking-result');
            
            if (!orderId) return;

            // Show Loading
            resultContainer.innerHTML = '<div class="text-center py-8"><div class="inline-block w-8 h-8 border-4 border-stone-200 border-t-stone-900 rounded-full animate-spin"></div><p class="mt-2 text-stone-600 text-sm">جاري البحث...</p></div>';

            try {
                // Fetch Order
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const order = { id: docSnap.id, ...docSnap.data() };
                    
                    // Render Result
                    renderTrackingTimeline(resultContainer, order);
                } else {
                    // Not Found
                    // UPDATED: Removed 'fade-in-up'
                    resultContainer.innerHTML = `
                        <div class="text-center py-12 bg-red-50 rounded-3xl border border-red-100">
                            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="search-x" size="32"></i>
                            </div>
                            <h3 class="font-bold text-red-900 text-lg mb-2">عذراً، لم نجد هذا الطلب</h3>
                            <p class="text-red-700/80 text-sm">يرجى التأكد من رقم الطلب والمحاولة مرة أخرى.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Tracking Error:", error);
                showToast("حدث خطأ أثناء البحث");
                resultContainer.innerHTML = '';
            }
        };
        // ---------------------------------------------

        // NEW: Success Modal Logic (Enhanced for VF Cash)
        window.toggleSuccessModal = (show, orderId, isVodafoneCash = false) => {
            const backdrop = document.getElementById('success-modal-backdrop');
            const modal = document.getElementById('success-modal');
            const idDisplay = document.getElementById('success-order-id');
            const titleEl = document.getElementById('success-title');
            const descEl = document.getElementById('success-desc');
            
            if (show) {
                if(orderId) idDisplay.innerText = orderId;
                
                // Inject Stepper (Step 4 - Final)
                const stepper = document.getElementById('success-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(4);
                    lucide.createIcons();
                }

                // Custom Message Logic
                if (isVodafoneCash) {
                    titleEl.innerText = "تم استلام طلبك والمراجعة جارية";
                    descEl.innerHTML = `
                        <div class="space-y-3 mt-4 mb-2">
                            <div class="bg-blue-50 text-blue-800 p-3 rounded-xl text-xs md:text-sm font-bold border border-blue-100 flex items-center justify-center gap-2 shadow-sm">
                                <span class="animate-pulse">⏳</span> جاري مراجعة التحويل خلال 30 دقيقة
                            </div>
                            <div class="text-stone-600 text-xs font-medium flex items-center justify-center gap-1">
                                📲 سيتم التواصل معك فور تأكيد عملية الدفع
                            </div>
                        </div>
                    `;
                } else {
                    // Default Message
                    titleEl.innerText = "تم استلام طلبك بنجاح!";
                    descEl.innerHTML = "شكراً لثقتك بنا. يرجى الاحتفاظ برقم الطلب لتتبع حالة الشحنة.";
                }

                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        window.copyOrderId = () => {
            const id = document.getElementById('success-order-id').innerText;
            navigator.clipboard.writeText(id);
            showToast("تم نسخ رقم الطلب");
        };

        window.handlePlaceOrder = async (e) => {
            e.preventDefault();
            
            // Lock Check: منع التكرار
            if (isOrderSubmitting) return;
            if (cart.length === 0) return;

            // 1. Get Button & Save Original State
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;

            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            
            // --- VALIDATION START ---
            if (!name || !phone || !address) {
                return showToast("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، العنوان)");
            }

            // Phone Validation Regex (Egypt Mobile Numbers)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showToast("رقم الهاتف غير صحيح. يجب أن يتكون من 11 رقم ويبدأ بـ 010, 011, 012, أو 015");
                return;
            }
            // --- VALIDATION END ---

            // 2. Set Loading State & Lock
            isOrderSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>جاري إصدار الفاتورة...</span></div>`;
            submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

            // Get Payment Method
            const paymentMethod = e.target.paymentMethod ? e.target.paymentMethod.value : 'cod';
            
            // 4️⃣ Get Partial Payment Status
            const isPartial = document.getElementById('isPartial').checked && paymentMethod === 'vodafone_cash';

            // Recalculate logic securely
            const isDelivery = document.getElementById('delivery-check').checked;
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let deliveryFee = 0;
            let deliveryStatus = "no_delivery"; 

            if (isDelivery) {
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                if (isFixedArea) {
                    deliveryFee = FIXED_DELIVERY_FEE;
                    deliveryStatus = "fixed";
                } else {
                    deliveryStatus = "courier";
                }
            }

            const totalAmount = cartTotal + deliveryFee;
            const initialStatus = paymentMethod === 'vodafone_cash' ? 'pending_payment' : 'new';

            const orderData = {
                customer: {
                    name: name,
                    phone: phone,
                    address: address
                },
                items: cart,
                subtotal: cartTotal,
                delivery: {
                    requested: isDelivery,
                    fee: deliveryFee,
                    status: deliveryStatus, 
                    areasMatch: deliveryStatus === 'fixed'
                },
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                isPartialPayment: isPartial, // 4️⃣ Save Partial Flag
                status: initialStatus,
                createdAt: serverTimestamp(), // NOTE: In local obj we use Date.now() for immediate PDF
                userId: user && !user.isAnonymous ? user.uid : 'guest',
                statusHistory: [{
                    status: initialStatus,
                    timestamp: Date.now(),
                    note: isPartial ? 'تم إنشاء الطلب (بنظام العربون)' : 'تم إنشاء الطلب بنجاح'
                }]
            };

            // 1️⃣1️⃣ Create a local snapshot with proper Date for immediate PDF generation
            // Because serverTimestamp() is not readable immediately in client-side object without fetch
            lastPlacedOrder = { 
                ...orderData, 
                id: "PENDING-ID", // Will update after success
                createdAt: Date.now() 
            };

            try {
                // --- 8️⃣ SMART ORDER NUMBERING (الترقيم الذكي) ---
                // نستخدم Transaction لضمان عدم تكرار الرقم حتى لو طلب شخصين في نفس اللحظة
                
                const finalOrderId = await runTransaction(db, async (transaction) => {
                    // ... existing transaction code ...
                    const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'orderCounter');
                    const counterDoc = await transaction.get(counterRef);
                    let currentSeq = 0;
                    if (counterDoc.exists()) currentSeq = counterDoc.data().seq || 0;
                    const nextSeq = currentSeq + 1;
                    const year = new Date().getFullYear();
                    const formattedId = `GD-${year}-${String(nextSeq).padStart(5, '0')}`;
                    const newOrderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', formattedId);
                    transaction.set(newOrderRef, orderData);
                    transaction.set(counterRef, { seq: nextSeq }, { merge: true });
                    return formattedId;
                });
                
                // 1️⃣1️⃣ Update the global order object with the real ID
                lastPlacedOrder.id = finalOrderId;

                // ... existing notification code ...
                if (GOOGLE_SCRIPT_URL) {
                    const itemsSummary = cart.map(i => `${i.name} (${i.quantity})`).join(' + ');
                    // ✅ إضافة 1: توضيح العربون بجانب المنتجات
                    const finalItems = isPartial ? itemsSummary + " (نظام عربون 50%)" : itemsSummary;
                    const timestamp = new Date().toLocaleString('ar-EG');
                    
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'new_order',
                            orderId: finalOrderId, 
                            date: timestamp,
                            customerName: name,
                            customerPhone: phone,
                            address: address,
                            totalAmount: totalAmount,
                            // ✅ إضافة 2: إرسال الكود الخام (vodafone_cash) عشان السكريبت يفهمه
                            paymentMethod: paymentMethod, 
                            items: finalItems,
                            backup_source: "Gedar_Web_V1"
                        })
                    }).catch(err => console.log("Backup Error:", err));
                }

                cart = [];
                saveCart(); 
                updateCartUI(); 
                toggleCheckoutModal(false);
                e.target.reset();
                
                // 3. Reset Button State (Success) & Unlock
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                
                // BRANCHING LOGIC based on Payment Method
                if (paymentMethod === 'vodafone_cash') {
                    handleVodafoneCashFlow(finalOrderId, totalAmount, isPartial); // Pass isPartial
                } else {
                    toggleSuccessModal(true, finalOrderId, false); 
                }
                
            } catch (error) {
                // ... error handling ...
                console.error("Order Error:", error);
                showToast("حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.");
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        };

        // NEW: Vodafone Cash Flow Implementation
        window.handleVodafoneCashFlow = (orderId, amount, isPartial = false) => {
            // Populate Data
            
            // 4️⃣ Update Labels for Partial Payment
            if (isPartial) {
                // حساب 50% من المبلغ
                const minPartial = Math.ceil(amount * 0.5); // تقريب للأعلى لأقرب رقم صحيح
                
                document.getElementById('vc-amount').innerHTML = `
                    <div class="flex flex-col items-center gap-1">
                        <span class="text-3xl font-serif font-black text-stone-900">${minPartial.toFixed(2)} ج.م</span>
                        <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded">مطلوب دفع 50% كحد أدنى للعربون</span>
                    </div>`;
                document.getElementById('vc-amount-step').innerText = minPartial + ' ج.م';
                
                // تخزين الحد الأدنى في متغير عام للتحقق منه لاحقاً
                window.requiredMinPayment = minPartial;
            } else {
                document.getElementById('vc-amount').innerText = amount.toFixed(2) + ' ج.م';
                document.getElementById('vc-amount-step').innerText = amount.toFixed(2) + ' ج.م';
                window.requiredMinPayment = 0; // لا يوجد حد أدنى خاص (المبلغ بالكامل مطلوب لكن التحقق منه أقل صرامة هنا)
            }
            
            document.getElementById('vc-order-id-hidden').value = orderId;
            
            // Show Modal
            toggleVodafoneModal(true);
        };

        window.toggleVodafoneModal = (show) => {
            const backdrop = document.getElementById('vodafone-modal-backdrop');
            const modal = document.getElementById('vodafone-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');

                // Inject Stepper (Step 3 - Payment)
                const stepper = document.getElementById('vodafone-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(3);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // Transition from Instruction Modal to Form Modal
        window.confirmVodafonePayment = () => {
            const orderId = document.getElementById('vc-order-id-hidden').value;
            // Get amount from display text (e.g., "1250.00 ج.م") and parse it
            const amountText = document.getElementById('vc-amount').innerText;
            const amountVal = parseFloat(amountText);

            toggleVodafoneModal(false);
            
            // Open Confirmation Form & Prefill Data
            document.getElementById('vc-confirm-order-id').value = orderId;
            
            // Prefill amount if input exists
            const amountInput = document.querySelector('#vc-confirm-modal input[name="amountPaid"]');
            if(amountInput) amountInput.value = amountVal;

            toggleVcConfirmModal(true);
        };

        // Toggle Confirmation Modal
        window.toggleVcConfirmModal = (show) => {
            const backdrop = document.getElementById('vc-confirm-modal-backdrop');
            const modal = document.getElementById('vc-confirm-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
                
                // Inject Stepper (Step 3 - Payment Confirm)
                const stepper = document.getElementById('vc-confirm-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(3);
                    lucide.createIcons();
                }

                // --- NEW: Restore Draft Data (استعادة المسودة) ---
                loadVcDraft();
                // ---------------------------------------------

                // إعادة التحقق عند الفتح لتحديث حالة الزر
                setTimeout(validateVcForm, 100);
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // --- NEW: Save Draft Function (حفظ تلقائي) ---
        window.saveVcDraft = () => {
            const form = document.getElementById('vc-confirm-form');
            if(!form) return;
            
            const currentOrderId = document.getElementById('vc-confirm-order-id').value;
            
            const draft = {
                senderName: form.senderName.value,
                senderPhone: form.senderPhone.value,
                amountPaid: form.amountPaid.value,
                transactionId: form.transactionId.value,
                orderId: currentOrderId, // ربط المسودة برقم الطلب
                timestamp: Date.now()
            };
            
            localStorage.setItem('gedar_vc_draft', JSON.stringify(draft));
        };

        // --- NEW: Load Draft Function (استعادة المسودة) ---
        window.loadVcDraft = () => {
            const draftStr = localStorage.getItem('gedar_vc_draft');
            if (!draftStr) return;
            
            try {
                const draft = JSON.parse(draftStr);
                const currentOrderId = document.getElementById('vc-confirm-order-id').value;
                
                // نتأكد أن المسودة تخص نفس الطلب الحالي (أو مسودة عامة حديثة)
                // إذا كان رقم الطلب مطابقاً، نستعيد البيانات
                if (draft.orderId && draft.orderId === currentOrderId) {
                    const form = document.getElementById('vc-confirm-form');
                    if(!form) return;

                    if(draft.senderName) form.senderName.value = draft.senderName;
                    if(draft.senderPhone) form.senderPhone.value = draft.senderPhone;
                    if(draft.amountPaid) form.amountPaid.value = draft.amountPaid;
                    if(draft.transactionId) form.transactionId.value = draft.transactionId;
                    
                    // تنبيه بسيط (اختياري)
                    // console.log("Draft restored");
                }
            } catch(e) { console.error("Error loading draft", e); }
        };

        // --- UPDATED: التحقق من صحة نموذج الدفع وحفظ المسودة ---
        window.validateVcForm = () => {
            const form = document.getElementById('vc-confirm-form');
            const btn = document.getElementById('vc-submit-btn');
            const hint = document.getElementById('vc-form-hint');
            const imgIndicator = document.getElementById('img-check-indicator');
            
            if(!form || !btn) return;

            // --- NEW: Save Draft on every validation check (Input) ---
            saveVcDraft();
            // -----------------------------------------------------

            // 1. التحقق من الصورة
            const hasImage = form.receiptImage.files.length > 0;
            if(imgIndicator) {
                if(hasImage) imgIndicator.classList.remove('hidden');
                else imgIndicator.classList.add('hidden');
            }

            // 2. التحقق من باقي الحقول
            const name = form.senderName.value.trim();
            const phone = form.senderPhone.value.trim();
            const amountVal = parseFloat(form.amountPaid.value);
            
            // تحقق بسيط من طول رقم الهاتف (أكثر من 10 أرقام)
            const isPhoneValid = phone.length >= 11;

            // 3. التحقق من قيمة العربون (50%) - (NEW LOGIC)
            let isAmountValid = true;
            let amountErrorMsg = '';
            
            // التحقق من المتغير العام الذي تم تعيينه في handleVodafoneCashFlow
            if (window.requiredMinPayment && window.requiredMinPayment > 0) {
                if (isNaN(amountVal) || amountVal < window.requiredMinPayment) {
                    isAmountValid = false;
                    amountErrorMsg = `عفواً، أقل مبلغ للعربون هو ${window.requiredMinPayment} ج.م (50% من القيمة)`;
                }
            } else {
                // في حالة الدفع الكامل، فقط نتأكد أنه رقم صحيح موجب
                if (isNaN(amountVal) || amountVal <= 0) isAmountValid = false;
            }

            // 4. تفعيل/تعطيل الزر
            if (hasImage && name && isPhoneValid && isAmountValid) {
                btn.disabled = false;
                // إزالة ستايل التعطيل
                btn.classList.remove('bg-stone-400', 'text-white/80', 'cursor-not-allowed', 'shadow-none');
                // إضافة ستايل التفعيل
                btn.classList.add('bg-stone-900', 'text-white', 'hover:bg-stone-800', 'shadow-lg');
                
                // إخفاء التلميح
                if(hint) hint.classList.add('hidden');
            } else {
                btn.disabled = true;
                // استعادة ستايل التعطيل
                btn.classList.add('bg-stone-400', 'text-white/80', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-stone-900', 'text-white', 'hover:bg-stone-800', 'shadow-lg');
                
                // إظهار التلميح المناسب
                if(hint) {
                    hint.classList.remove('hidden');
                    if (!isAmountValid && amountErrorMsg) {
                        // إظهار رسالة خطأ المبلغ باللون الأحمر
                        hint.innerText = amountErrorMsg;
                        hint.classList.remove('text-red-600', 'text-stone-600');
                        hint.classList.add('text-red-600', 'font-black');
                    } else {
                        // الرسالة الافتراضية
                        hint.innerText = 'يرجى رفع الصورة وملء البيانات لتفعيل الزر';
                        hint.classList.remove('text-red-600', 'font-black');
                        hint.classList.add('text-red-600');
                    }
                }
            }
        };

        // NEW: Image Compression Helper (Client-Side)
        // This avoids using paid cloud storage by compressing images to small strings
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize Logic (Max 800px width/height) to ensure small size
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG with 60% quality
                        // This usually results in < 100KB string which fits easily in Firestore
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // Handle Submission of Payment Details
        window.handleVcConfirmSubmit = async (e) => {
            e.preventDefault();
            
            // Lock Check: منع التكرار
            if (isPaymentSubmitting) return;

            // 1. Get Button & Save State
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;

            const orderId = document.getElementById('vc-confirm-order-id').value;
            const senderName = e.target.senderName.value.trim();
            const senderPhone = e.target.senderPhone.value.trim();
            const amountPaid = e.target.amountPaid.value; 
            const transactionId = e.target.transactionId.value.trim(); 
            
            // Get Image File
            const receiptFile = e.target.receiptImage.files[0];

            // --- 3️⃣ DUPLICATE DETECTION (Smart Check) ---
            try {
                const lastSub = JSON.parse(localStorage.getItem('gedar_last_vc_submit') || '{}');
                if (lastSub.phone === senderPhone && 
                    lastSub.amount === amountPaid && 
                    (Date.now() - lastSub.timestamp) < 5 * 60 * 1000) {
                    
                    showToast("⚠️ تم إرسال هذا الإيصال بالفعل! يرجى الانتظار للمراجعة.");
                    return; 
                }
            } catch(err) { console.log("Duplicate check error", err); }
            // ---------------------------------------------

            // --- VALIDATION START (التحقق الذكي) ---
            if (!senderName || !senderPhone || !amountPaid) {
                return showToast("⚠️ يرجى استكمال جميع البيانات المطلوبة");
            }
            
            if (!receiptFile) {
                return showToast("⚠️ يرجى إرفاق صورة التحويل (سكرين شوت)");
            }

            // Phone Validation Regex (Egypt Mobile Numbers)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            if (!phoneRegex.test(senderPhone)) {
                // 🔴 رسالة الخطأ الذكية 1: رقم غلط
                showToast("❌ رقم الهاتف غير صحيح. تأكد أنه 11 رقم ويبدأ بـ 01");
                return;
            }
            // --- VALIDATION END ---

            // 2. Set Loading State & Lock
            isPaymentSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>جاري المعالجة...</span></div>`;
            submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

            try {
                // Compress Image
                const base64Image = await compressImage(receiptFile);
                const amountPaidFloat = parseFloat(amountPaid);

                // Update Firestore Order Document
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
                    paymentDetails: {
                        method: 'vodafone_cash',
                        senderName: senderName,
                        senderPhone: senderPhone,
                        amountPaid: amountPaidFloat,
                        transactionId: transactionId || 'N/A',
                        screenshotBase64: base64Image, // Store image directly as text
                        submittedAt: Date.now()
                    },
                    // Update Status to "Review" so admin knows payment is claimed
                    status: 'payment_review' 
                });

                // --- 🆕 إرسال إشعار بيانات الدفع لجوجل سكريبت ---
                if (GOOGLE_SCRIPT_URL) {
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'payment_confirmation', // ده اللي بيميز الرسالة دي
                            orderId: orderId,
                            senderName: senderName,
                            senderPhone: senderPhone,
                            amountPaid: amountPaid,
                            transactionId: transactionId
                        })
                    }).catch(err => console.log("Payment Notification Error:", err));
                }
                // --------------------------------------------------

                // --- SAVE SUBMISSION TO LOCAL STORAGE ---
                localStorage.setItem('gedar_last_vc_submit', JSON.stringify({
                    phone: senderPhone,
                    amount: amountPaid,
                    timestamp: Date.now()
                }));
                
                // --- Clear Draft on Success ---
                localStorage.removeItem('gedar_vc_draft');

                toggleVcConfirmModal(false);
                
                // Show Final Success Modal
                toggleSuccessModal(true, orderId, true);
                
                showToast("✅ تم إرسال البيانات بنجاح");
                
                // 3. Reset Button (Success) & Unlock
                isPaymentSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');

            } catch (err) {
                console.error("Payment Confirm Error:", err);
                
                // 🔴 تحليل الأخطاء الذكي (Smart Error Analysis)
                let errorMsg = "حدث خطأ غير متوقع، حاول مرة أخرى.";
                const errString = err.toString().toLowerCase();
                const errCode = err.code; // Firebase error code

                // 1. Image Too Large (صورة كبيرة)
                // عادةً الخطأ يكون invalid-argument إذا تجاوز حجم المستند 1 ميجا
                if (errString.includes('exceeds') || errString.includes('too large') || errCode === 'invalid-argument') {
                    errorMsg = "📸 الصورة كبيرة جداً! يرجى اختيار صورة أصغر أو التقاط لقطة شاشة جديدة.";
                } 
                // 2. Weak Connection (اتصال ضعيف)
                else if (errString.includes('network') || errString.includes('offline') || errCode === 'unavailable') {
                    errorMsg = "📡 الاتصال ضعيف! يرجى التحقق من الإنترنت والمحاولة مجدداً.";
                }
                // 3. Permission Error (مشكلة صلاحيات)
                else if (errCode === 'permission-denied') {
                    errorMsg = "🔒 حدث خطأ في الصلاحيات. يرجى تحديث الصفحة.";
                }

                showToast(errorMsg);
                
                // 4. Reset Button (Error) & Unlock
                isPaymentSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        };

        window.handleAddCategory = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            const name = e.target.catName.value.trim();
            const image = e.target.catImg.value.trim();
            
            // Check logic: If editing, update. If adding, check duplicate.
            if (currentEditCategoryName) {
                // --- UPDATE MODE ---
                try {
                    const newCats = CATEGORIES.map(c => 
                        c.name === currentEditCategoryName ? { name: name, image: image } : c
                    );
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                    showToast(`تم تعديل قسم "${name}" بنجاح`);
                    currentEditCategoryName = null; // Reset
                    e.target.reset();
                    renderView(); // Refresh UI to reset button text
                } catch(err) { console.error(err); showToast("حدث خطأ في التعديل"); }
            } else {
                // --- ADD MODE ---
                if (name && !CATEGORIES.some(c => c.name === name)) {
                    try {
                        const newCat = { 
                            name: name, 
                            image: image || "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500" 
                        };
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: arrayUnion(newCat) });
                        showToast(`تم إضافة قسم "${name}" بنجاح`);
                        e.target.reset();
                    } catch(err) { console.error(err); showToast("حدث خطأ"); }
                } else {
                    showToast("اسم غير صالح أو موجود مسبقاً");
                }
            }
        };

        // NEW: دوال مساعدة لتعديل الأقسام (كانت مفقودة)
        window.prepareEditCategory = (name) => {
            currentEditCategoryName = name;
            // التأكد من أننا في تبويب الأقسام
            setAdminView('categories');
            showToast(`جاري تعديل قسم: ${name}`);
            window.scrollTo(0, 0); // الصعود للأعلى للوصول للنموذج
        };

        window.cancelEditCategory = () => {
            currentEditCategoryName = null;
            renderView();
        };

        // --- NEW: Delete Category ---
        window.handleDeleteCategory = async (catName) => {
            if (!confirm(`هل أنت متأكد من حذف قسم "${catName}"؟`)) return;
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            try {
                // Filter out the category to delete
                const newCats = CATEGORIES.filter(c => c.name !== catName);
                // Save the new array (overwrite)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                showToast("تم حذف القسم");
            } catch(err) { console.error(err); showToast("حدث خطأ أثناء الحذف"); }
        };

        // NEW: Handle Save Hero Settings
        window.handleSaveHeroSettings = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            // دالة مساعدة لجلب القيمة بأمان حتى لو الحقل غير موجود
            const getVal = (name, fallback = "") => e.target[name] ? e.target[name].value.trim() : fallback;
            const getCheck = (name, fallback = false) => e.target[name] ? e.target[name].checked : fallback;

            // Logo Fields (Updated)
            const logoUrl = getVal('siteLogo');
            const profileUrl = getVal('profilePic'); // 🆕 New Field
            const logoSizeDesk = getVal('logoSizeDesk', '120'); 
            const logoSizeMob = getVal('logoSizeMob', '80');   

            // Image Config Fields
            const imgBaseUrl = getVal('imgBaseUrl');
            const imgDefaultExt = getVal('imgExt');

            // Header Banner Fields
            const fbUrl = getVal('fbUrl');
            const fbUrlMob = getVal('fbUrlMob');
            const fbHeightDesk = getVal('fbHeightDesk');
            const fbWidthDesk = getVal('fbWidthDesk');
            const fbRadiusDesk = getVal('fbRadiusDesk');
            const fbHeightMob = getVal('fbHeightMob');
            const fbWidthMob = getVal('fbWidthMob');
            const fbRadiusMob = getVal('fbRadiusMob');
            const fbShow = getCheck('fbShow');

            // REMOVED: Category Banner Fields extraction

            // Best Seller Banner Fields
            const bsBanUrl = getVal('bsBanUrl');
            const bsBanHeight = getVal('bsBanHeight');
            const bsBanWidth = getVal('bsBanWidth');
            const bsBanShow = getCheck('bsBanShow');

            // Featured Banner Fields
            const ftBanUrl = getVal('ftBanUrl');
            const ftBanUrlMob = getVal('ftBanUrlMob');
            const ftBanHeightDesk = getVal('ftBanHeightDesk');
            const ftBanWidthDesk = getVal('ftBanWidthDesk');
            const ftBanHeightMob = getVal('ftBanHeightMob');
            const ftBanWidthMob = getVal('ftBanWidthMob');
            const ftBanShow = getCheck('ftBanShow');

            // Payment Banner
            const payBanUrl = getVal('payBanUrl');
            const payBanHeight = getVal('payBanHeight');
            const payBanWidth = getVal('payBanWidth');
            const payBanShow = getCheck('payBanShow');

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero'), {
                    // Logo
                    logoUrl: logoUrl,
                    profileUrl: profileUrl, // 🆕 Save Profile URL
                    logoSizeDesktop: logoSizeDesk, // Save Desktop
                    logoSizeMobile: logoSizeMob,   // Save Mobile
                    
                    // Image Config
                    imageBaseUrl: imgBaseUrl,
                    imageDefaultExt: imgDefaultExt,
                    
                    // Header Banner
                    footerBannerUrl: fbUrl,
                    footerBannerUrlMobile: fbUrlMob,
                    fbHeightDesktop: fbHeightDesk, fbWidthDesktop: fbWidthDesk, fbRadiusDesktop: fbRadiusDesk,
                    fbHeightMobile: fbHeightMob, fbWidthMobile: fbWidthMob, fbRadiusMobile: fbRadiusMob,
                    showFooterBanner: fbShow,
                    
                    // REMOVED: Category Banner save logic
                    
                    // Best Seller Banner
                    bestSellerBannerUrl: bsBanUrl,
                    bestSellerBannerHeight: bsBanHeight,
                    bestSellerBannerWidth: bsBanWidth,
                    showBestSellerBanner: bsBanShow,
                    
                    // Featured Banner
                    featuredBannerUrl: ftBanUrl,
                    featuredBannerUrlMobile: ftBanUrlMob,
                    featuredBannerHeightDesktop: ftBanHeightDesk, featuredBannerWidthDesktop: ftBanWidthDesk,
                    featuredBannerHeightMobile: ftBanHeightMob, featuredBannerWidthMobile: ftBanWidthMob,
                    showFeaturedBanner: ftBanShow,
                    
                    // Payment Banner
                    paymentBannerUrl: payBanUrl,
                    paymentBannerHeight: payBanHeight,
                    paymentBannerWidth: payBanWidth,
                    showPaymentBanner: payBanShow
                }, { merge: true });
                showToast("تم تحديث إعدادات الموقع والواجهة بنجاح");
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء الحفظ");
            }
        };

        // --- 🆕 NEW: Bulk Action Functions ---
        
        window.toggleSelectAllProducts = (source) => {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        };

        window.applyBulkDiscount = async () => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            // Get checked boxes
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            if (ids.length === 0) return showToast("يرجى اختيار منتجات من الجدول أولاً");
            
            const discountInput = document.getElementById('bulk-discount-input');
            const dateInput = document.getElementById('bulk-date-input');
            
            const discountVal = parseFloat(discountInput.value);
            const dateVal = dateInput.value;
            // تحويل التاريخ إلى Timestamp أو null إذا كان فارغاً
            const expiryTimestamp = dateVal ? new Date(dateVal).getTime() : null;

            if (isNaN(discountVal) || discountVal < 0) return showToast("يرجى تحديد نسبة خصم صحيحة");

            if (!confirm(`هل أنت متأكد من تطبيق خصم ${discountVal}% على ${ids.length} منتج؟`)) return;

            // إظهار حالة التحميل على الزر
            const btn = document.getElementById('bulk-apply-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'جاري التنفيذ...';
            btn.disabled = true;

            try {
                // إنشاء مصفوفة الوعود للتحديث المتوازي
                const updates = ids.map(id => {
                    return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), {
                        discount: discountVal,
                        discountExpiry: expiryTimestamp
                    });
                });
                
                await Promise.all(updates);
                
                showToast(`تم تحديث ${ids.length} منتج بنجاح ✅`);
                
                // تصفير الحقول وإعادة الرسم
                discountInput.value = '';
                dateInput.value = '';
                renderView(); 
                
            } catch(err) {
                console.error("Bulk Update Error:", err);
                showToast("حدث خطأ أثناء التحديث الجماعي");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // NEW: Function to update global branding (Navbar, Footer, & Bottom Banner)
        function updateGlobalBranding() {
            const navBrandDesk = document.getElementById('navbar-brand-desktop');
            const navBrandMob = document.getElementById('navbar-brand-mobile');
            const mobProfile = document.getElementById('mobile-profile-pic'); // 🆕
            const footerBrand = document.getElementById('footer-brand');
            const bannerContainer = document.getElementById('header-banner-container'); 
            
            // تنظيف الأنماط القديمة
            const nav = document.getElementById('navbar');
            if (bannerContainer) bannerContainer.style.marginTop = ''; // Reset JS margin to rely on CSS padding first

            const oldStyle = document.getElementById('dynamic-top-banner-style');
            if (oldStyle) oldStyle.remove();

            const logoUrl = HERO_SETTINGS.logoUrl;
            const profileUrl = HERO_SETTINGS.profileUrl; // 🆕
            
            // --- UPDATED: Logo Sizing Logic (Responsive) ---
            const sizeDesk = HERO_SETTINGS.logoSizeDesktop || HERO_SETTINGS.logoSize || 120;
            // تم تغيير الحجم الافتراضي هنا من 80 إلى 100
            const sizeMob = HERO_SETTINGS.logoSizeMobile || 100;

            // Inject Dynamic CSS for Logo
            let logoStyle = document.getElementById('dynamic-logo-style');
            if (!logoStyle) {
                logoStyle = document.createElement('style');
                logoStyle.id = 'dynamic-logo-style';
                document.head.appendChild(logoStyle);
            }
            
            logoStyle.innerHTML = `
                .brand-logo-img {
                    height: auto;
                    object-fit: contain;
                }
                .profile-pic-img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
            `;
            
            // Trigger layout adjustment after transition ends (300ms + buffer)
            setTimeout(adjustMobileLayout, 350);
            // ------------------------------------------------

            // 1. Desktop Logo
            if (navBrandDesk) {
                if (logoUrl) {
                    navBrandDesk.innerHTML = `<img src="${logoUrl}" class="brand-logo-img" width="${sizeDesk}" height="${sizeDesk}" style="width: ${sizeDesk}px;" alt="Logo">`;
                } else {
                    navBrandDesk.innerHTML = '';
                }
            }

            // 2. Mobile Logo (Center)
            if (navBrandMob) {
                if (logoUrl) {
                    navBrandMob.innerHTML = `<img src="${logoUrl}" class="brand-logo-img" width="${sizeMob}" height="${sizeMob}" style="width: ${sizeMob}px;" alt="Logo" onload="adjustMobileLayout()">`;
                } else {
                    navBrandMob.innerHTML = '';
                }
            }

            // 3. Mobile Profile Picture (Right) - UPDATED with Auto Toggle Animation
            if (mobProfile) {
                // Determine base content (Image or Icon)
                const imgContent = profileUrl 
                    ? `<img src="${profileUrl}" class="w-full h-full object-cover" alt="Profile">` 
                    : `<i data-lucide="user" size="20" class="text-stone-400"></i>`;
                
                // Create dual-layer structure for toggling
                mobProfile.innerHTML = `
                    <div class="relative w-full h-full">
                        <!-- Layer 1: Profile Image/Icon -->
                        <div id="mob-profile-view-1" class="absolute inset-0 flex items-center justify-center transition-all duration-500 opacity-100 scale-100">
                            ${imgContent}
                        </div>
                        <!-- Layer 2: Menu Icon -->
                        <div id="mob-profile-view-2" class="absolute inset-0 flex items-center justify-center transition-all duration-500 opacity-0 scale-75 bg-stone-50">
                            <i data-lucide="align-left" size="20" class="text-stone-600"></i>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                // Initialize Toggler Loop (only once)
                if (!window.profileTogglerRunning) {
                    setInterval(() => {
                        const v1 = document.getElementById('mob-profile-view-1');
                        const v2 = document.getElementById('mob-profile-view-2');
                        if (v1 && v2) {
                            // Toggle classes
                            if (v1.classList.contains('opacity-100')) {
                                // Switch to Menu Icon
                                v1.classList.remove('opacity-100', 'scale-100');
                                v1.classList.add('opacity-0', 'scale-75');
                                
                                v2.classList.remove('opacity-0', 'scale-75');
                                v2.classList.add('opacity-100', 'scale-100');
                            } else {
                                // Switch back to Profile
                                v2.classList.remove('opacity-100', 'scale-100');
                                v2.classList.add('opacity-0', 'scale-75');
                                
                                v1.classList.remove('opacity-0', 'scale-75');
                                v1.classList.add('opacity-100', 'scale-100');
                            }
                        }
                    }, 2500); // Toggle every 2.5 seconds
                    window.profileTogglerRunning = true;
                }
            }

            if (footerBrand) {
                if (logoUrl) {
                    // Footer logo usually slightly larger, handled here via inline or reuse class
                    footerBrand.innerHTML = `<img src="${logoUrl}" width="${parseInt(sizeDesk) * 1.2}" height="${parseInt(sizeDesk) * 1.2}" style="width: ${parseInt(sizeDesk) * 1.2}px; height: auto;" class="object-contain" alt="Logo">`;
                } else {
                    footerBrand.innerHTML = '';
                }
            }

            // Update Header Banner (Slider Logic with Responsive Styles)
            if (bannerContainer) {
                if (HERO_SETTINGS.showFooterBanner && (HERO_SETTINGS.footerBannerUrl || HERO_SETTINGS.footerBannerUrlMobile)) {
                    // تعديل: إظهار البانر فقط إذا كنا في الصفحة الرئيسية
                    if (currentView === 'home') {
                        bannerContainer.classList.remove('hidden');
                    } else {
                        bannerContainer.classList.add('hidden');
                    }
                    
                    // 1. Prepare URLs
                    const deskUrls = (HERO_SETTINGS.footerBannerUrl || '').split(/\r?\n/).filter(u => u.trim());
                    // Fallback to desktop if mobile is empty
                    const rawMobUrls = (HERO_SETTINGS.footerBannerUrlMobile || '').split(/\r?\n/).filter(u => u.trim());
                    const mobUrls = rawMobUrls.length > 0 ? rawMobUrls : deskUrls;

                    // IDs
                    const sliderDeskId = 'header-slider-desktop';
                    const sliderMobId = 'header-slider-mobile';
                    
                    // Settings
                    const hDesk = HERO_SETTINGS.fbHeightDesktop || 300;
                    const hMob = HERO_SETTINGS.fbHeightMobile || 150;
                    const rDesk = HERO_SETTINGS.fbRadiusDesktop || '2rem';
                    const rMob = HERO_SETTINGS.fbRadiusMobile || '1rem'; // Will be overridden by card style on mobile

                    // Inject CSS for Desktop Fade Only
                    const styleId = 'header-banner-style';
                    let styleEl = document.getElementById(styleId);
                    if(!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = styleId;
                        document.head.appendChild(styleEl);
                    }
                    
                    // UPDATE: CSS للبانر (Desktop Fade Only + Common Helpers)
                    styleEl.innerHTML = `
                        /* حاوية البانر */
                        .banner-fade-container {
                            position: relative;
                            width: 100%;
                            overflow: hidden;
                        }
                        /* الشريحة (مشتركة) */
                        .banner-fade-slide {
                            position: absolute;
                            top: 0; left: 0; width: 100%; height: 100%;
                            opacity: 0; transition: opacity 1.5s ease-in-out; z-index: 1;
                        }
                        .banner-fade-slide.active { opacity: 1; z-index: 2; }
                        .banner-img-desk { width: 100%; height: 100%; object-fit: cover; border-radius: ${rDesk}; }
                        
                        /* Mobile Scroll Snap Utilities */
                        .snap-x-mandatory { scroll-snap-type: x mandatory; }
                        .snap-center { scroll-snap-align: center; }
                    `;

                    // Generate HTML
                    // Apple Style Mobile Banner: Scrollable Cards
                    
                    bannerContainer.innerHTML = `
                    <div class="w-full bg-white dir-ltr pb-2"> 
                        
                        <!-- Mobile Scroll Slider (Apple Style) -->
                        <div class="md:hidden flex overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-3 px-4 py-3" 
                             id="${sliderMobId}"
                             style="scroll-padding: 0 16px;"
                             onscroll="updateBannerScrollDots('${sliderMobId}')">
                            
                            ${mobUrls.map((url, idx) => `
                                <div class="min-w-[93%] w-[93%] snap-center relative rounded-[1.25rem] overflow-hidden shadow-[0_8px_20px_-6px_rgba(0,0,0,0.12)] bg-stone-100 border border-stone-100 aspect-[2.2/1]" 
                                     style="height: ${hMob}px;">
                                    <img src="${url.trim()}" class="w-full h-full object-cover" alt="بانر ${idx + 1}" loading="${idx===0?'eager':'lazy'}">
                                </div>
                            `).join('')}
                            
                            <!-- Spacer to fix last item padding issue in some browsers -->
                            <div class="min-w-[4px] w-[4px] shrink-0"></div>
                        </div>
                        
                        <!-- NEW: Mobile Dots Indicator (Linked to Scroll) -->
                        ${mobUrls.length > 1 ? `
                        <div class="md:hidden flex justify-center gap-1.5 mt-0.5" id="${sliderMobId}-dots">
                            ${mobUrls.map((_, i) => `<div class="w-1.5 h-1.5 rounded-full ${i === 0 ? 'bg-stone-800 w-4' : 'bg-stone-300'} transition-all duration-300 dot-indicator" data-index="${i}"></div>`).join('')}
                        </div>
                        ` : ''}

                        <!-- Desktop Fade Slider (Unchanged) -->
                        <div class="hidden md:block relative group w-full banner-fade-container" 
                             style="height: ${hDesk}px;"
                             id="${sliderDeskId}"
                             onmouseenter="stopBannerAutoFade('${sliderDeskId}')" 
                             onmouseleave="startBannerAutoFade('${sliderDeskId}')">
                            
                            ${deskUrls.map((url, idx) => `
                                <div class="banner-fade-slide ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                                    <div class="w-full h-full relative overflow-hidden shadow-sm border border-stone-100 bg-stone-100" style="border-radius: ${rDesk};">
                                        <img src="${url.trim()}" class="banner-img-desk" alt="بانر إعلاني"
                                             ${idx === 0 ? 'fetchpriority="high"' : 'loading="lazy"'} 
                                             decoding="async">
                                    </div>
                                </div>
                            `).join('')}
                            
                            <!-- Nav Buttons -->
                            ${deskUrls.length > 1 ? `
                            <button onclick="fadeBannerStep('${sliderDeskId}', -1)" class="absolute top-1/2 left-6 -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-md hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 hover:bg-white" aria-label="السابق"><i data-lucide="chevron-left"></i></button>
                            <button onclick="fadeBannerStep('${sliderDeskId}', 1)" class="absolute top-1/2 right-6 -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-md hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 hover:bg-white" aria-label="التالي"><i data-lucide="chevron-right"></i></button>
                            ` : ''}
                        </div>

                    </div>`;
                    
                    // Init State & Auto Play (Desktop Only)
                    window.bannerFadeState = window.bannerFadeState || {};
                    window.bannerFadeState[sliderDeskId] = 0;

                    setTimeout(() => {
                        if(deskUrls.length > 1) startBannerAutoFade(sliderDeskId, deskUrls.length);
                    }, 500);

                    lucide.createIcons();
                } else {
                    bannerContainer.classList.add('hidden');
                    bannerContainer.innerHTML = '';
                }
            }
            
            // --- NEW: Trigger Layout Adjustment ---
            setTimeout(adjustMobileLayout, 100); 
        }

        // --- NEW: Update Banner Dots based on Scroll ---
        window.updateBannerScrollDots = (containerId) => {
            const container = document.getElementById(containerId);
            const dotsContainer = document.getElementById(`${containerId}-dots`);
            if (!container || !dotsContainer) return;

            const scrollLeft = container.scrollLeft;
            const width = container.clientWidth;
            // Calculate active index (round to nearest card)
            // In RTL, scrollLeft might be negative or large positive depending on browser, 
            // but we used dir="ltr" for the banner container specifically to simplify this logic.
            const index = Math.round(scrollLeft / (width * 0.93)); // 0.93 is the card width percentage

            const dots = dotsContainer.querySelectorAll('.dot-indicator');
            dots.forEach((dot, i) => {
                if (i === index) {
                    dot.classList.remove('bg-stone-300');
                    dot.classList.add('bg-stone-800', 'w-4');
                } else {
                    dot.classList.remove('bg-stone-800', 'w-4');
                    dot.classList.add('bg-stone-300');
                }
            });
        };

        // --- NEW: Dynamic Layout Adjustment Function ---
        // OPTIMIZED: تم فصل القراءة عن الكتابة (Batching) لمنع Forced Reflow
        window.adjustMobileLayout = () => {
            const navbar = document.getElementById('navbar');
            const banner = document.getElementById('header-banner-container');
            const homeTopSection = document.getElementById('home-top-section'); // القسم الرئيسي (الأكثر مبيعاً)
            
            if (!navbar) return;
            
            // --- Phase 2: Write (تنفيذ التعديلات دفعة واحدة) ---
            requestAnimationFrame(() => {
                // 1. القائمة السريعة تم حذفها، لا حاجة لضبطها.
                
                // 2. معالجة البانر: لا نضيف هامش (Margin) لأن الجسم (Body) لديه Padding بالفعل
                if (banner) {
                    banner.style.marginTop = '0px'; 
                } 
                
                // 3. معالجة قسم "الأكثر مبيعاً":
                // نثبت المسافة الداخلية للقسم
                if (homeTopSection) {
                    // إذا كان البانر مخفي، نضيف مسافة بسيطة (padding) للقسم نفسه
                    homeTopSection.style.paddingTop = '1.5rem'; 
                }
                
                // 4. الصفحات الأخرى: إزالة التعديلات الديناميكية والاعتماد على CSS Body Padding
                const mainPages = document.querySelectorAll('.min-h-screen');
                mainPages.forEach(page => {
                     // إزالة أي تعديلات يدوية سابقة للجافاسكريبت
                     page.style.paddingTop = ''; 
                });
            });
        };

        // OPTIMIZED: Debounce Resize Event
        // تحسين الأداء: استخدام Debounce لمنع إعادة الحساب المتكرر أثناء تغيير حجم النافذة
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                adjustMobileLayout();
            }, 100);
        });

        // Call initially and after a slight delay to ensure rendering
        window.addEventListener('load', adjustMobileLayout);
        setTimeout(adjustMobileLayout, 500);
        // ---------------------------------------------

        // --- NEW: Fade Logic Implementation ---
        
        let bannerFadeTimers = {};

        // دالة للتبديل اليدوي أو الآلي
        window.fadeBannerStep = (id, step) => {
            const container = document.getElementById(id);
            if(!container) return;
            
            const slides = container.querySelectorAll('.banner-fade-slide');
            const total = slides.length;
            if(total <= 1) return;

            let current = window.bannerFadeState[id] || 0;
            let next = current + step;

            // Loop logic
            if (next >= total) next = 0;
            if (next < 0) next = total - 1;

            // Update State
            window.bannerFadeState[id] = next;

            // Apply Classes
            slides.forEach((slide, idx) => {
                if(idx === next) {
                    slide.classList.add('active');
                } else {
                    slide.classList.remove('active');
                }
            });

            // Update Dots (Modified to find dots globally by ID)
            // This supports dots being outside the container
            for (let i = 0; i < total; i++) {
                const dot = document.getElementById(`${id}-dot-${i}`);
                if (dot) {
                    if (i === next) {
                        // Active State (Dark & Wide)
                        dot.classList.remove('bg-stone-300', 'bg-white/50'); 
                        dot.classList.add('bg-stone-900', 'w-4'); 
                    } else {
                        // Inactive State (Light & Small)
                        dot.classList.add('bg-stone-300');
                        dot.classList.remove('bg-stone-900', 'w-4', 'bg-white');
                    }
                }
            }
        };

        window.startBannerAutoFade = (id, count) => {
            // إذا لم يتم تمرير العدد، نحاول حسابه
            if(!count) {
                const el = document.getElementById(id);
                if(el) count = el.querySelectorAll('.banner-fade-slide').length;
                else return;
            }
            
            if(bannerFadeTimers[id]) clearInterval(bannerFadeTimers[id]);

            // كل 3 ثواني (تم التعديل من 4000 إلى 3000)
            bannerFadeTimers[id] = setInterval(() => {
                fadeBannerStep(id, 1);
            }, 3000);
        };

        window.stopBannerAutoFade = (id) => {
            if(bannerFadeTimers[id]) {
                clearInterval(bannerFadeTimers[id]);
                delete bannerFadeTimers[id];
            }
        };

        // NEW: Improved Banner Scroll Function (Smart Direction) - (Legacy kept for other sliders)
        window.scrollBanner = (id, direction) => {
            const slider = document.getElementById(id);
            if (!slider) return;
            
            // Detect direction based on scrollHeight
            if (slider.scrollHeight > slider.clientHeight) {
                // Vertical
                const height = slider.clientHeight;
                slider.scrollBy({ top: direction * height, behavior: 'smooth' });
            } else {
                // Horizontal
                const width = slider.clientWidth;
                slider.scrollBy({ left: direction * width, behavior: 'smooth' });
            }
        };

        // NEW: Improved Auto Scroll Logic (Looping & Vertical Support)
        window.startBannerAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            if (bannerScrollTimers[id]) clearInterval(bannerScrollTimers[id]);

            // سرعة متوسطة (3 ثواني) مع حركة ناعمة
            bannerScrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                if (!element) {
                    clearInterval(bannerScrollTimers[id]);
                    return;
                }

                // Check vertical
                if (element.scrollHeight > element.clientHeight) {
                    const maxScroll = element.scrollHeight - element.clientHeight;
                    const currentScroll = element.scrollTop;
                    
                    if (currentScroll >= maxScroll - 10) {
                        element.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        element.scrollBy({ top: element.clientHeight, behavior: 'smooth' });
                    }
                } else {
                    // Horizontal fallback
                    const maxScroll = element.scrollWidth - element.clientWidth;
                    const currentScroll = Math.abs(element.scrollLeft);
                    
                    if (currentScroll >= maxScroll - 10) {
                        element.scrollTo({ left: 0, behavior: 'smooth' });
                    } else {
                        element.scrollBy({ left: element.clientWidth, behavior: 'smooth' });
                    }
                }
            }, 3000); 
        };

        // NEW: Improved Auto Scroll Logic (Looping)
        window.startBannerAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            if (bannerScrollTimers[id]) clearInterval(bannerScrollTimers[id]);

            bannerScrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                if (!element) {
                    clearInterval(bannerScrollTimers[id]);
                    return;
                }

                const maxScroll = element.scrollWidth - element.clientWidth;
                const currentScroll = element.scrollLeft;
                
                // If at end, go to start smoothly (or instantly if preferred)
                if (currentScroll >= maxScroll - 10) {
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    element.scrollBy({ left: element.clientWidth, behavior: 'smooth' });
                }
            }, 4000); 
        };

        window.cancelEdit = () => {
            currentEditProduct = null;
            renderView();
        };

        // NEW: دوال تعديل وحذف المنتجات
        window.handleEditProduct = (id) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            currentEditProduct = p;
            // الانتقال لتبويب المنتجات في لوحة التحكم وتعبئة النموذج
            setAdminView('products');
            showToast(`جاري تعديل: ${p.name}`);
        };

        window.handleDeleteProduct = async (id) => {
            if (!confirm("هل أنت متأكد تماماً من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.")) return;
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                showToast("تم حذف المنتج بنجاح");
                // إذا كان المنتج المحذوف هو قيد التعديل حالياً، قم بإلغاء التعديل
                if (currentEditProduct && currentEditProduct.id === id) {
                    currentEditProduct = null;
                }
            } catch (error) {
                console.error("Error deleting product:", error);
                showToast("حدث خطأ أثناء الحذف");
            }
        };

        window.handleSaveProduct = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            
            const nameVal = e.target.prodName.value;
            const brandVal = e.target.prodBrand ? e.target.prodBrand.value : "";
            const materialVal = e.target.prodMaterial ? e.target.prodMaterial.value : "";
            const priceVal = parseFloat(e.target.prodPrice.value);
            const discountVal = parseFloat(e.target.prodDiscount.value) || 0;
            const expiryVal = e.target.prodExpiry.value ? new Date(e.target.prodExpiry.value).getTime() : null;
            
            // NEW: Get Featured Value
            const isFeaturedVal = e.target.prodFeatured ? e.target.prodFeatured.checked : false;
            
            // NEW: Get In Stock Value
            const inStockVal = e.target.prodInStock ? e.target.prodInStock.checked : true;

            const catVal = e.target.prodCat.value;
            
            // --- NEW: Smart Image URL Generation ---
            let imgInput = e.target.prodImg.value.trim();
            let imgVal = imgInput;
            
            // إذا كان المدخل ليس رابطاً كاملاً (لا يبدأ بـ http) ويوجد إعدادات للقاعدة
            if (imgInput && !imgInput.match(/^https?:\/\//) && HERO_SETTINGS.imageBaseUrl) {
                // التأكد من وجود / في نهاية الرابط الأساسي
                const baseUrl = HERO_SETTINGS.imageBaseUrl.endsWith('/') 
                    ? HERO_SETTINGS.imageBaseUrl 
                    : HERO_SETTINGS.imageBaseUrl + '/';
                
                // التأكد من الامتداد
                const ext = HERO_SETTINGS.imageDefaultExt || '.webp';
                const hasExt = imgInput.includes('.');
                
                imgVal = baseUrl + imgInput + (hasExt ? '' : ext);
            }
            // ----------------------------------------

            const descVal = e.target.prodDesc ? e.target.prodDesc.value : "";
            const featuresVal = e.target.prodFeatures ? e.target.prodFeatures.value.split('\n').filter(l => l.trim()) : [];
            const imagesVal = e.target.prodImages ? e.target.prodImages.value.split('\n').filter(l => l.trim()) : [];
            
            // Parse Variants (Colors)
            const variantsLines = e.target.prodVariants ? e.target.prodVariants.value.split('\n').filter(l => l.trim()) : [];
            const variants = variantsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const color = parts[0].trim();
                const image = parts.slice(1).join(':').trim(); 
                return { color, image };
            }).filter(item => item !== null);

            // Parse Specifications
            const specsLines = e.target.prodSpecs ? e.target.prodSpecs.value.split('\n').filter(l => l.trim()) : [];
            const specifications = specsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const label = parts[0].trim();
                const value = parts.slice(1).join(':').trim(); 
                return { label, value };
            }).filter(item => item !== null);

            // --- NEW: Parse Services ---
            const servicesLines = e.target.prodServices ? e.target.prodServices.value.split('\n').filter(l => l.trim()) : [];
            const services = servicesLines.map(line => {
                const parts = line.split(':');
                if (parts.length < 2) return null;
                const icon = parts[0].trim();
                const text = parts.slice(1).join(':').trim();
                return { icon, text };
            }).filter(item => item !== null);

            const finalImages = [imgVal, ...imagesVal];

            const productData = {
                name: nameVal,
                brand: brandVal,
                material: materialVal,
                price: priceVal,
                discount: discountVal,
                discountExpiry: expiryVal,
                isFeatured: isFeaturedVal, // Save Featured Status
                inStock: inStockVal,       // Save Stock Status
                category: catVal,
                image: imgVal,
                images: finalImages,
                description: descVal,
                features: featuresVal,
                variants: variants, // Add Variants
                specifications: specifications,
                services: services, // Add services
                rating: 5,
                details: "تفاصيل المنتج..."
            };

            try {
                if (currentEditProduct) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', currentEditProduct.id), productData);
                    showToast("تم تعديل المنتج بنجاح");
                    currentEditProduct = null;
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), productData);
                    showToast("تم إضافة المنتج بنجاح");
                }
                e.target.reset();
                if (currentView === 'admin') renderView();
            } catch(err) { console.error(err); showToast("حدث خطأ"); }
        };

        window.handleSubmitReview = async (e) => {
            e.preventDefault();
            const name = e.target.reviewerName.value.trim();
            const comment = e.target.reviewerComment.value.trim();
            const rating = parseInt(e.target.reviewerRating.value);

            if (!name || !comment) return showToast("يرجى ملء جميع الحقول");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), {
                    productId: currentProductId,
                    userName: name,
                    comment: comment,
                    rating: rating,
                    status: 'pending',
                    createdAt: Date.now()
                });
                showToast("تم إرسال تعليقك للمراجعة، سيظهر بعد الموافقة");
                e.target.reset();
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء الإرسال");
            }
        };

        window.handleReviewAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            try {
                if (action === 'approve') {
                    // Check if verified checkbox is checked
                    const isVerified = document.getElementById(`verify-check-${id}`)?.checked || false;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id), { 
                        status: 'approved',
                        verified: isVerified 
                    });
                    showToast("تمت الموافقة على التعليق");
                } else {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id));
                    showToast("تم رفض التعليق وحذفه");
                }
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // --- 🆕 FIXED: Modification Request Logic (إصلاح طلب التعديل) ---
        window.toggleModModal = (show) => {
            const backdrop = document.getElementById('mod-modal-backdrop');
            const modal = document.getElementById('mod-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
        };

        window.openModRequestModal = (orderId) => {
            document.getElementById('mod-order-id').value = orderId;
            toggleModModal(true);
        };

        window.handleSubmitModRequest = async (e) => {
            e.preventDefault();
            const orderId = e.target.orderId.value;
            const message = e.target.message.value.trim();

            if (!message) return showToast("يرجى كتابة تفاصيل التعديل");

            try {
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "جاري الإرسال...";

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
                    modificationRequest: {
                        message: message,
                        status: 'pending',
                        createdAt: Date.now()
                    },
                    // إضافة للسجل الزمني
                    statusHistory: arrayUnion({
                        status: 'modification_requested',
                        timestamp: Date.now(),
                        note: `طلب العميل تعديل: ${message}`
                    })
                });

                showToast("تم إرسال طلب التعديل للإدارة بنجاح");
                toggleModModal(false);
                e.target.reset();
                btn.disabled = false;
                btn.innerText = originalText;
                
                // تحديث الواجهة فوراً إذا كنا في صفحة التتبع
                const resultContainer = document.getElementById('tracking-result');
                if (resultContainer && resultContainer.innerHTML !== "") {
                    // إعادة جلب الطلب لتحديث الحالة الظاهرة
                    const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                    if(docSnap.exists()){
                         const order = { id: docSnap.id, ...docSnap.data() };
                         renderTrackingTimeline(resultContainer, order);
                    }
                }

            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء الإرسال");
                e.target.querySelector('button').disabled = false;
                e.target.querySelector('button').innerText = "إرسال الطلب للإدارة";
            }
        };
        // -----------------------------------------------------------

        // --- 1️⃣2️⃣ FIXED: Admin Edit Order Logic (إصلاح تعديل الطلب) ---
        
        window.toggleEditOrderModal = (show) => {
            const backdrop = document.getElementById('edit-order-modal-backdrop');
            const modal = document.getElementById('edit-order-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
        };

        window.openEditOrderModal = (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const order = ALL_ORDERS.find(o => o.id === id);
            if (!order) return showToast("الطلب غير موجود");

            const form = document.getElementById('edit-order-form');
            form.orderId.value = order.id;
            form.customerName.value = order.customer.name;
            form.customerPhone.value = order.customer.phone;
            form.customerAddress.value = order.customer.address;
            form.totalAmount.value = order.totalAmount;

            toggleEditOrderModal(true);
        };

        window.handleUpdateOrder = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            const id = e.target.orderId.value;
            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            const total = parseFloat(e.target.totalAmount.value);

            if (!name || !phone || !address || isNaN(total)) {
                return showToast("يرجى التأكد من صحة البيانات");
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'customer.name': name,
                    'customer.phone': phone,
                    'customer.address': address,
                    'totalAmount': total,
                    statusHistory: arrayUnion({
                        status: 'edited',
                        timestamp: Date.now(),
                        note: 'تم تعديل بيانات الطلب يدوياً بواسطة المدير'
                    })
                });
                showToast("✅ تم تحديث بيانات الطلب بنجاح");
                toggleEditOrderModal(false);
            } catch(err) {
                console.error(err);
                showToast("❌ فشل تحديث الطلب");
            }
        };
        // -----------------------------------------------------------

        // NEW: Handle Order Actions
        window.handleOrderAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                if (action === 'delete') {
                    if(!confirm("⚠️ تحذير: هل أنت متأكد من حذف هذا الطلب نهائياً؟ لا يمكن التراجع.")) return;
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    showToast("تم حذف الطلب نهائياً");
                } else if (action === 'archive') {
                    if(!confirm("هل تريد نقل هذا الطلب إلى الأرشيف؟")) return;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: true,
                        // إضافة سجل للعملية
                        statusHistory: arrayUnion({
                            status: 'archived',
                            timestamp: Date.now(),
                            note: 'تم نقل الطلب للأرشيف يدوياً'
                        })
                    });
                    showToast("تم نقل الطلب إلى الأرشيف 🗄️");
                    
                } else if (action === 'restore') {
                    if(!confirm("هل تريد استعادة هذا الطلب للقائمة الجارية؟")) return;

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: false,
                        // إضافة سجل للعملية
                        statusHistory: arrayUnion({
                            status: 'restored',
                            timestamp: Date.now(),
                            note: 'تم استعادة الطلب من الأرشيف'
                        })
                    });
                    showToast("تم استعادة الطلب للقائمة الرئيسية ↩️");
                }
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ في تحديث الطلب");
            }
        };

        // NEW: Handle Modification Decision (Admin)
        window.handleModDecision = async (id, decision) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                // decision: 'approved' or 'rejected'
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'modificationRequest.status': decision,
                    'modificationRequest.adminRespondedAt': Date.now()
                });
                
                if (decision === 'approved') {
                    showToast("تمت الموافقة على طلب التعديل (يرجى تنفيذ التعديل يدوياً إذا لزم الأمر)");
                    // Optional: Open edit modal automatically if approved to let admin make changes
                    // openEditOrderModal(id); 
                } else {
                    showToast("تم رفض طلب التعديل");
                }
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // NEW: Handle Order Status Change (Admin)
        window.handleOrderStatusChange = async (id, newStatus) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                // الحصول على النص العربي للحالة
                const statusLabel = STATUS_ARABIC_MAP[newStatus] || newStatus;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    status: newStatus,
                    // --- NEW: إضافة للسجل الزمني ---
                    statusHistory: arrayUnion({
                        status: newStatus,
                        timestamp: Date.now(),
                        note: `تم تغيير الحالة إلى: ${statusLabel}`
                    })
                    // -----------------------------
                });
                showToast("تم تحديث حالة الطلب بنجاح");

                // --- NEW: إرسال إشعار للعميل ---
                const order = ALL_ORDERS.find(o => o.id === id);
                if (order) {
                    // Update local object immediately to reflect in UI without refresh if needed
                    if (!order.statusHistory) order.statusHistory = [];
                    order.statusHistory.push({
                        status: newStatus,
                        timestamp: Date.now(),
                        note: `تم تغيير الحالة إلى: ${statusLabel}`
                    });
                    
                    notifyOrderStatus(order, newStatus);
                }
                // -----------------------------

            } catch(err) {
                console.error(err);
                showToast("فشل تحديث الحالة");
            }
        };

        // --- NEW: دالة إضافة ملاحظة داخلية ---
        window.addInternalNote = async (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const input = document.getElementById(`note-input-${id}`);
            const text = input.value.trim();
            
            if (!text) return;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    internalNotes: arrayUnion({
                        text: text,
                        timestamp: Date.now(),
                        admin: user.displayName || 'Admin'
                    })
                });
                showToast("تم حفظ الملاحظة الداخلية");
                input.value = ''; // تفريغ الحقل
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء حفظ الملاحظة");
            }
        };

        // --- 9️⃣ CSV EXPORT FUNCTION ---
        window.exportOrdersToCSV = (range) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            let filteredOrders = ALL_ORDERS;
            const now = new Date();
            
            // Filter Logic
            if (range === 'today') {
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d.toDateString() === now.toDateString();
                });
            } else if (range === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d >= weekAgo;
                });
            } else if (range === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d >= monthAgo;
                });
            }

            if (filteredOrders.length === 0) return showToast("لا توجد طلبات في هذه الفترة لتصديرها");

            // CSV Header
            let csvContent = "\uFEFF"; // BOM for Excel Arabic support
            // تم إضافة أعمدة بيانات الدفع في النهاية
            csvContent += "رقم الطلب,اسم العميل,رقم الهاتف,العنوان,إجمالي المبلغ,طريقة الدفع,حالة الطلب,تاريخ الطلب,اسم المحول (الدفع),رقم المحفظة,المبلغ المدفوع,رقم العملية\n";

            // CSV Rows
            filteredOrders.forEach(o => {
                const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                const dateStr = d.toLocaleDateString('ar-EG') + " " + d.toLocaleTimeString('ar-EG');
                
                // Escape commas in address/name to prevent column shift
                const cleanName = `"${(o.customer.name || '').replace(/"/g, '""')}"`;
                const cleanAddress = `"${(o.customer.address || '').replace(/"/g, '""')}"`;
                const paymentAr = o.paymentMethod === 'vodafone_cash' ? 'فودافون كاش' : 'عند الاستلام';
                const statusAr = STATUS_ARABIC_MAP[o.status] || o.status;

                // استخراج بيانات الدفع إذا وجدت
                let paySenderName = "-", paySenderPhone = "-", payAmount = "-", payTransId = "-";
                
                if (o.paymentMethod === 'vodafone_cash' && o.paymentDetails) {
                    paySenderName = `"${(o.paymentDetails.senderName || '').replace(/"/g, '""')}"`;
                    // إضافة علامة اقتباس مفردة لمنع إكسيل من حذف الصفر في بداية الرقم
                    paySenderPhone = `'${o.paymentDetails.senderPhone || ''}`; 
                    payAmount = o.paymentDetails.amountPaid || '0';
                    payTransId = `"${(o.paymentDetails.transactionId || '').replace(/"/g, '""')}"`;
                }

                csvContent += `${o.id},${cleanName},'${o.customer.phone},${cleanAddress},${o.totalAmount},${paymentAr},${statusAr},${dateStr},${paySenderName},${paySenderPhone},${payAmount},${payTransId}\n`;
            });

            // Trigger Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `orders_export_${range}_${now.toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`تم تصدير ${filteredOrders.length} طلب بنجاح`);
        };

        // NEW: Handle Payment Review Decision (Vodafone Cash) - UPDATED FOR AUTO WHATSAPP
        window.handlePaymentDecision = async (id, decision) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            // جلب بيانات الطلب أولاً لاستخدام اسم ورقم العميل
            const order = ALL_ORDERS.find(o => o.id === id);
            if (!order) return showToast("بيانات الطلب غير موجودة");

            try {
                let updateData = {};
                let msg = "";
                let whatsappMsg = ""; // الرسالة المنسقة
                
                if (decision === 'approve') {
                    // قبول الدفع: تحويل الحالة إلى مؤكد (مدفوع)
                    updateData = {
                        status: 'confirmed', 
                        'paymentDetails.verified': true,
                        'paymentDetails.verifiedAt': Date.now(),
                        'paymentDetails.adminNote': 'تم تأكيد وصول المبلغ',
                        // --- NEW: إضافة للسجل الزمني ---
                        statusHistory: arrayUnion({
                            status: 'confirmed',
                            timestamp: Date.now(),
                            note: 'تم تأكيد استلام الدفع بنجاح'
                        })
                        // -----------------------------
                    };
                    msg = "تم تأكيد الدفع بنجاح وتحويل الطلب إلى (مؤكد)";

                    // === رسالة القبول المنسقة ===
                    whatsappMsg = `مرحبًا أ/ ${order.customer.name}\n\n` +
                        `يسعدنا إبلاغك بأنه تم تأكيد استلام قيمة طلبك بنجاح.\n` +
                        `رقم الطلب: *${order.id}*\n` +
                        `المبلغ المستلم: *${order.paymentDetails.amountPaid} ج.م*\n` +
                        `جاري حاليًا تجهيز طلبك داخل المخازن، وسيتم شحنه في أقرب وقت ممكن.\n\n` +
                        `سنوافيك بتفاصيل الشحن فور خروج الطلب.\n` +
                        `شكرًا لثقتك في جدار للديكور 🤍`;

                } else {
                    // رفض الدفع: طلب سبب الرفض
                    const reason = prompt("يرجى كتابة سبب الرفض (سيظهر للعميل):", "المبلغ لم يصل المحفظة / البيانات غير مطابقة");
                    if (reason === null) return; // ألغى المدير العملية

                    updateData = {
                        status: 'payment_pending',
                        'paymentDetails.verified': false,
                        'paymentDetails.rejectedAt': Date.now(),
                        'paymentDetails.adminNote': reason, // حفظ السبب المدخل
                        // --- NEW: إضافة للسجل الزمني ---
                        statusHistory: arrayUnion({
                            status: 'payment_pending',
                            timestamp: Date.now(),
                            note: `رفض عملية الدفع: ${reason}`
                        })
                        // -----------------------------
                    };
                    msg = "تم رفض الدفع وتسجيل السبب للعميل";

                    // === رسالة الرفض المنسقة ===
                    const trackLink = `${window.location.origin}${window.location.pathname}#/track-order`;
                    whatsappMsg = `مرحباً ${order.customer.name} 👋\n` +
                        `تحديث بخصوص طلبك رقم *#${order.id}*\n\n` +
                        `عذراً، لم نتمكن من تأكيد عملية الدفع ❌\n` +
                        `⚠️ السبب: *${reason}*\n\n` +
                        `يرجى مراجعة البيانات وإعادة المحاولة عبر رابط التتبع:\n${trackLink}`;
                }

                // تحديث قاعدة البيانات
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), updateData);
                showToast(msg);

                // === فتح واتساب تلقائياً ===
                const phone = "20" + order.customer.phone.replace(/^0+/, ""); // تنسيق الرقم المصري
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(whatsappMsg)}`;
                
                // فتح في نافذة جديدة (قد يحتاج المتصفح لسماحية Pop-ups لأول مرة)
                const win = window.open(url, '_blank');
                if (win) {
                    win.focus();
                } else {
                    showToast("يرجى السماح بالنوافذ المنبثقة لفتح واتساب تلقائياً");
                    // Fallback link click
                    window.location.href = url;
                }

            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء تحديث حالة الدفع");
            }
        };

        // ❌ تم حذف دالة handlePlaceOrder المكررة من هنا بالكامل لحل مشكلة ازدواج الطلب

        function renderTrackingTimeline(container, order) {
            const steps = [
                { id: 'new', label: 'تم الطلب', icon: 'shopping-bag', desc: 'تم استلام طلبك بنجاح وهو قيد المراجعة.' },
                { id: 'pending_payment', label: 'بانتظار الدفع', icon: 'credit-card', desc: 'يرجى إتمام عملية الدفع لتأكيد الطلب.' },
                { id: 'payment_review', label: 'مراجعة الدفع', icon: 'file-search', desc: 'جاري مراجعة بيانات الدفع التي أرسلتها لتأكيد الطلب.' },
                { id: 'confirmed', label: 'تم التأكيد', icon: 'check-circle', desc: 'تم تأكيد طلبك والدفع بنجاح.' },
                { id: 'processing', label: 'جاري التجهيز', icon: 'package', desc: 'يقوم فريقنا بتجهيز وتغليف طلبك حالياً.' },
                { id: 'shipped', label: 'تم الشحن', icon: 'truck', desc: 'الشحنة خرجت مع مندوب التوصيل في طريقها إليك.' },
                { id: 'delivered', label: 'تم التوصيل', icon: 'home', desc: 'تم تسليم الطلب بنجاح. نتمنى أن ينال إعجابك!' }
            ];

            const currentStatus = order.status || 'new';
            const currentIndex = steps.findIndex(s => s.id === currentStatus);
            const currentStepInfo = (currentIndex !== -1) ? steps[currentIndex] : steps[0];
            const isDelivered = currentStatus === 'delivered';
            const progressPercent = Math.min(100, Math.max(0, (currentIndex / (steps.length - 1)) * 100));

            // ... (Payment Rejection HTML & Mod Req HTML code same as before) ...
            // للاختصار سأضع الأكواد المتغيرة هنا، يمكنك الحفاظ على الأكواد القديمة للأقسام الأخرى
            
            let paymentRejectionHTML = '';
            if (order.paymentDetails && order.paymentDetails.verified === false && order.status === 'payment_pending') {
                const rejectionReason = order.paymentDetails.adminNote || "يرجى مراجعة البيانات.";
                const waNumber = "201014175070";
                const waText = encodeURIComponent(`مرحباً، لدي استفسار بخصوص رفض الدفع للطلب رقم #${order.id}`);
                paymentRejectionHTML = `
                <div class="bg-red-50 border-2 border-red-100 rounded-2xl p-6 mb-8 flex flex-col md:flex-row gap-5 items-start animate-in fade-in slide-in-from-top-4 shadow-sm">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center shrink-0 text-red-600">
                        <i data-lucide="x-octagon" size="24"></i>
                    </div>
                    <div class="flex-1 w-full">
                        <h3 class="font-bold text-lg text-red-800 mb-1">عذراً، تم رفض عملية الدفع</h3>
                        <p class="text-red-700 font-medium text-sm mb-3">السبب: "<span class="font-bold">${rejectionReason}</span>"</p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="handleVodafoneCashFlow('${order.id}', ${order.totalAmount})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="refresh-cw" size="16"></i> إعادة إرسال البيانات</button>
                            <a href="https://wa.me/${waNumber}?text=${waText}" target="_blank" class="flex-1 bg-white border border-green-500 text-green-600 hover:bg-green-50 px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="message-circle" size="16"></i> حل النزاع (واتساب)</a>
                        </div>
                    </div>
                </div>`;
            }

            let modReqHTML = '';
            if (order.modificationRequest && order.modificationRequest.status === 'pending') {
                modReqHTML = `<div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6 flex items-start gap-3"><i data-lucide="clock" class="text-orange-500 mt-1 shrink-0"></i><div><h4 class="font-bold text-orange-700 text-sm">طلب التعديل قيد المراجعة</h4><p class="text-orange-600 text-xs mt-1">طلبت: "${order.modificationRequest.message}"</p></div></div>`;
            } else if (currentStatus !== 'delivered' && currentStatus !== 'shipped' && !order.modificationRequest) {
                modReqHTML = `<div class="mb-6 text-center"><button onclick="openModRequestModal('${order.id}')" class="text-sm font-bold text-stone-600 hover:text-stone-900 underline decoration-stone-300 underline-offset-4 flex items-center justify-center gap-2 mx-auto transition-colors"><i data-lucide="edit-3" size="14"></i> هل تريد طلب تعديل على هذا الطلب؟</button></div>`;
            }

            container.innerHTML = `
                <!-- 1. Hero Status Card -->
                <!-- UPDATED: Removed 'fade-in-up' -->
                <div class="bg-white rounded-3xl p-6 md:p-8 shadow-xl shadow-stone-200/40 mb-8 border border-white relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full -mr-20 -mt-20 blur-3xl transition-colors duration-500 group-hover:bg-stone-100"></div>
                    <div class="absolute bottom-0 left-0 w-40 h-40 ${isDelivered ? 'bg-green-50' : 'bg-blue-50'} rounded-full -ml-10 -mb-10 blur-3xl opacity-60"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-stone-100 text-stone-600 mb-4 border border-stone-200">
                                <span class="w-1.5 h-1.5 rounded-full ${isDelivered ? 'bg-green-500' : 'bg-blue-500 animate-pulse'}"></span>
                                رقم الطلب #${order.id}
                            </div>
                            <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mb-2 tracking-tight">${currentStepInfo.label}</h2>
                            <p class="text-stone-600 text-sm md:text-base max-w-md leading-relaxed">${currentStepInfo.desc}</p>
                        </div>
                        <div class="w-20 h-20 md:w-24 md:h-24 ${isDelivered ? 'bg-green-100 text-green-600' : 'bg-stone-900 text-white'} rounded-3xl flex items-center justify-center shadow-lg transform rotate-3 transition-transform hover:rotate-6">
                            <i data-lucide="${currentStepInfo.icon}" size="40"></i>
                        </div>
                    </div>
                </div>

                ${paymentRejectionHTML}
                ${modReqHTML}

                <!-- UPDATED: Removed 'fade-in-up' and animation-delay style -->
                <div class="space-y-8">
                    
                    <!-- 2. Horizontal Timeline (Full Width) -->
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 overflow-hidden">
                        <div class="overflow-x-auto pb-4 custom-scrollbar">
                            <div class="min-w-[700px] relative px-4 py-6">
                                <div class="absolute top-1/2 right-0 left-0 h-1 bg-stone-100 -translate-y-1/2 rounded-full z-0 mx-8"></div>
                                <div class="absolute top-1/2 right-0 h-1 bg-stone-900 -translate-y-1/2 rounded-full z-0 mx-8 transition-all duration-1000 ease-out" style="width: ${progressPercent}%"></div>
                                <div class="flex justify-between items-center relative z-10 w-full">
                                    ${steps.map((step, idx) => {
                                        const isCompleted = idx <= currentIndex;
                                        const isCurrent = idx === currentIndex;
                                        return `<div class="flex flex-col items-center gap-4 relative group cursor-default text-center w-32">
                                            <div class="w-12 h-12 rounded-full border-[3px] flex items-center justify-center transition-all duration-500 z-10 ${isCompleted ? 'bg-stone-900 border-stone-900 text-white shadow-lg scale-110' : 'bg-white border-stone-200 text-stone-600'} ${isCurrent ? 'ring-4 ring-stone-100' : ''}"><i data-lucide="${step.icon}" size="${isCurrent ? 20 : 18}"></i></div>
                                            <div class="flex flex-col items-center"><h4 class="font-bold text-sm ${isCompleted ? 'text-stone-900' : 'text-stone-600'} mb-1 transition-colors">${step.label}</h4>${isCurrent ? `<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold animate-pulse">الحالية</span>` : ''}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. NEW: Detailed Order Timeline Log (Sijil Zamani) -->
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                        <h3 class="font-bold text-lg mb-8 flex items-center gap-2 text-stone-900">
                            <div class="p-2 bg-white rounded-lg"><i data-lucide="history" class="text-stone-900" size="20"></i></div>
                            سجل النشاطات (Timeline)
                        </h3>
                        
                        <div class="relative border-r-2 border-stone-100 mr-3 space-y-8 pb-2">
                            ${(order.statusHistory && order.statusHistory.length > 0) ? order.statusHistory.sort((a,b) => b.timestamp - a.timestamp).map((log, idx) => {
                                const dateObj = new Date(log.timestamp);
                                const dateStr = dateObj.toLocaleDateString('ar-EG');
                                const timeStr = dateObj.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                                const isFirst = idx === 0;
                                
                                return `
                                <div class="relative pr-8 animate-in fade-in slide-in-from-right-4" style="animation-delay: ${idx * 0.1}s">
                                    <!-- Dot -->
                                    <div class="absolute -right-[9px] top-1.5 w-4 h-4 rounded-full border-2 border-white ${isFirst ? 'bg-green-500 ring-4 ring-green-100 shadow-md' : 'bg-stone-300'}"></div>
                                    
                                    <div class="bg-white p-4 rounded-2xl border border-stone-100 ${isFirst ? 'bg-green-50/50 border-green-100' : ''}">
                                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-1 mb-2">
                                            <h4 class="font-bold text-stone-900 text-sm ${isFirst ? 'text-green-800' : ''}">${STATUS_ARABIC_MAP[log.status] || log.status}</h4>
                                            <span class="text-[10px] text-stone-600 dir-ltr font-mono bg-white px-2 py-0.5 rounded border border-stone-100">${dateStr} | ${timeStr}</span>
                                        </div>
                                        <p class="text-xs text-stone-600 leading-relaxed font-medium">${log.note || 'لا توجد ملاحظات إضافية'}</p>
                                    </div>
                                </div>
                                `;
                            }).join('') : `
                                <div class="relative pr-8">
                                    <div class="absolute -right-[9px] top-1.5 w-4 h-4 rounded-full bg-stone-300 border-2 border-white"></div>
                                    <h4 class="font-bold text-stone-900 text-sm">بداية السجل</h4>
                                    <p class="text-xs text-stone-600 mt-1">سجل النشاطات متاح للطلبات الجديدة فقط.</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- 4. Invoice Summary -->
                    <div class="bg-white rounded-3xl shadow-xl shadow-stone-200/50 border border-stone-100 overflow-hidden transform transition-all hover:-translate-y-1 duration-300">
                        <div class="p-6 bg-stone-900 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-8 -mb-8 blur-2xl"></div>
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="receipt" size="18" class="text-stone-600"></i> ملخص الفاتورة</h3>
                                    <p class="text-stone-600 text-xs mt-1 font-mono tracking-wider opacity-80">ORDER #${order.id}</p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/10"><i data-lucide="shopping-bag" size="20" class="text-white"></i></div>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2">
                            <div class="p-6 bg-white md:border-l md:border-stone-100 max-h-[350px] overflow-y-auto custom-scrollbar space-y-4">
                                ${order.items.map(item => `
                                    <div class="flex items-center gap-4 group">
                                        <div class="w-14 h-14 bg-white rounded-xl border border-stone-100 overflow-hidden flex-shrink-0 relative">
                                            <img src="${item.selectedColor && item.variants ? (item.variants.find(v=>v.color===item.selectedColor)?.image || item.image) : item.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                            <span class="absolute bottom-0 right-0 bg-stone-900 text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-tl-lg font-bold">${item.quantity}</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-bold text-stone-900 text-sm truncate mb-0.5">${item.name}</h4>
                                            <p class="text-xs text-stone-600 font-medium">سعر القطعة: $${item.price}</p>
                                            ${item.selectedColor ? `<p class="text-[10px] text-stone-600 mt-0.5 bg-white inline-block px-1.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                                        </div>
                                        <div class="text-right"><p class="font-serif font-bold text-stone-900 text-sm">$${(item.price * item.quantity).toFixed(2)}</p></div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex flex-col">
                                <div class="p-6 bg-white space-y-3 flex-1">
                                    <div class="flex justify-between items-center text-xs font-bold text-stone-600"><span>المجموع الفرعي</span><span class="font-serif text-stone-700">$${order.items.reduce((s, i) => s + (i.price * i.quantity), 0).toFixed(2)}</span></div>
                                    ${order.delivery && order.delivery.requested ? `<div class="flex justify-between items-center text-xs font-bold text-stone-600"><span>الشحن</span><span class="font-serif text-stone-700">${order.delivery.fee > 0 ? '$' + order.delivery.fee.toFixed(2) : 'حسب المنطقة'}</span></div>` : ''}
                                    <div class="flex justify-between items-center pt-3 border-t border-stone-200 mt-2"><span class="text-base font-bold text-stone-900">الإجمالي الكلي</span><span class="text-xl font-serif font-black text-stone-900">$${Number(order.totalAmount).toFixed(2)}</span></div>
                                </div>
                                <div class="p-5 bg-white/50 border-t border-stone-100 text-xs">
                                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                                        <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm"><i data-lucide="user" size="14"></i></div><div><p class="text-[10px] text-stone-600 font-bold mb-0.5">العميل</p><p class="font-bold text-stone-900 text-sm">${order.customer.name}</p></div></div>
                                        <div class="flex items-center gap-2"><div class="text-right"><p class="text-[10px] text-stone-600 font-bold mb-0.5">الهاتف</p><p class="font-mono text-stone-700 font-bold dir-ltr bg-white px-2 py-0.5 rounded border border-stone-100">${order.customer.phone}</p></div><div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm"><i data-lucide="phone" size="14"></i></div></div>
                                    </div>
                                    <div class="bg-white p-3 rounded-xl border border-stone-200 shadow-sm flex gap-3 items-start"><i data-lucide="map-pin" size="16" class="text-orange-500 shrink-0 mt-0.5"></i><div><p class="text-[10px] text-stone-600 font-bold mb-1">عنوان التوصيل</p><p class="text-stone-700 leading-relaxed font-medium">${order.customer.address}</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                // Extra check immediately after popup
                if (result.user.email !== ADMIN_EMAIL) {
                    await signOut(auth);
                    showToast("عذراً، الدخول مقتصر على حساب المالك فقط: " + ADMIN_EMAIL);
                    return;
                }
                showToast("مرحباً بك يا مدير المتجر");
                setView('home');
            } catch (error) {
                console.error(error);
                showToast("فشل تسجيل الدخول");
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showToast("تم تسجيل الخروج");
                setView('home');
            } catch (error) { console.error(error); }
        };

        // --- Search Logic ---
        let isSearchOpen = false;

        window.toggleTopSearch = (e) => {
            e.stopPropagation();
            
            // Disable toggle logic on mobile (since it's always open)
            if (window.innerWidth < 768) {
                document.getElementById('top-search-input').focus();
                return;
            }

            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            const desktopMenu = document.getElementById('desktop-nav-menu'); // Get Desktop Menu
            
            if (!isSearchOpen) {
                // Open (Modern Expansion)
                // Remove mobile classes first to be safe, then apply desktop open styles
                bar.classList.remove('md:bg-transparent', 'md:border-transparent', 'md:w-10');
                bar.classList.add('bg-white', 'border-stone-200', 'w-48', 'md:w-64', 'shadow-sm'); 
                input.classList.remove('md:opacity-0');
                input.focus();
                
                // Hide Desktop Menu with Fade Effect
                if(desktopMenu) {
                    desktopMenu.classList.add('opacity-0', 'invisible', 'scale-90', 'pointer-events-none');
                }

                isSearchOpen = true;
            } else {
                if(input.value.trim() !== "") {
                     updateShopFilters('search', input.value.trim());
                     setView('shop');
                     closeTopSearch(); // Optional: Close after search triggers
                } else {
                    closeTopSearch(); 
                }
            }
        };

        window.closeTopSearch = () => {
            // Disable close logic on mobile
            if (window.innerWidth < 768) return;

            if(!isSearchOpen) return;
            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            const desktopMenu = document.getElementById('desktop-nav-menu'); // Get Desktop Menu
            
            bar.classList.remove('bg-white', 'border-stone-200', 'w-48', 'md:w-64', 'shadow-sm');
            bar.classList.add('md:bg-transparent', 'md:border-transparent', 'md:w-10');
            input.classList.add('md:opacity-0');
            input.blur();
            
            // Show Desktop Menu Back
            if(desktopMenu) {
                desktopMenu.classList.remove('opacity-0', 'invisible', 'scale-90', 'pointer-events-none');
            }

            isSearchOpen = false;
        };

        // NEW: Mobile Search Functions
        window.toggleMobileSearch = (show) => {
            const overlay = document.getElementById('mobile-search-overlay');
            const input = document.getElementById('mobile-popup-input');
            if(show) {
                overlay.classList.remove('-translate-y-full');
                setTimeout(() => input.focus(), 100);
            } else {
                overlay.classList.add('-translate-y-full');
                input.blur();
            }
        };

        window.handleMobileSearch = (e) => {
            e.preventDefault();
            const input = document.getElementById('mobile-popup-input');
            const val = input.value.trim();
            if(val) {
                updateShopFilters('search', val);
                setView('shop');
                toggleMobileSearch(false);
                input.value = ''; // Reset
            }
        };

        window.handleGlobalSearch = (e) => {
            if(e.key === 'Enter') {
                const val = e.target.value.trim();
                if(val) {
                     updateShopFilters('search', val);
                     setView('shop');
                     closeTopSearch(); // Optional: close after search
                }
            }
        };

        // NEW: Filter Drawer Logic
        window.toggleFilterDrawer = (show) => {
            const sidebar = document.getElementById('shop-sidebar');
            const overlay = document.getElementById('filter-sidebar-overlay');
            if (show) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        // --- Internal Helpers ---

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            const badge = document.getElementById('cart-badge'); // Desktop Badge
            const bottomBadge = document.getElementById('bottom-cart-badge'); // 🆕 Bottom Nav Badge
            const totalEl = document.getElementById('cart-total');
            const countSummary = document.getElementById('cart-count-summary');
            const clearBtn = document.getElementById('clear-cart-btn'); // NEW: Get Clear Button
            
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            
            // Update Desktop Badge
            if(badge) {
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
            }

            // 🆕 Update Bottom Nav Badge
            if(bottomBadge) {
                bottomBadge.innerText = count;
                if(count > 0) {
                    bottomBadge.classList.remove('hidden', 'scale-0');
                    bottomBadge.classList.add('scale-100');
                } else {
                    bottomBadge.classList.add('hidden', 'scale-0');
                    bottomBadge.classList.remove('scale-100');
                }
            }
            
            // NEW: Toggle Clear Button Visibility
            if(clearBtn) {
                if(count > 0) clearBtn.classList.remove('hidden');
                else clearBtn.classList.add('hidden');
            }
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            totalEl.innerText = `$${total.toFixed(2)}`;
            if(countSummary) countSummary.innerText = count;

            if (cart.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-in fade-in zoom-in duration-300">
                    <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center mb-4 relative">
                        <div class="absolute inset-0 border-2 border-dashed border-stone-300 rounded-full animate-[spin_10s_linear_infinite]"></div>
                        <i data-lucide="shopping-bag" size="48" class="text-stone-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">سلة التسوق فارغة</h3>
                        <p class="text-stone-600 text-sm max-w-[200px] mx-auto">يبدو أنك لم تضف أي منتجات بعد. تصفح المتجر واكتشف خياراتنا المميزة.</p>
                    </div>
                    <button onclick="toggleCart(false)" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:-translate-y-0.5">
                        ابدأ التسوق
                    </button>
                </div>`;
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
                // نستخدم map مع index لأننا نحتاج الـ index للحذف والتعديل الدقيق
                container.innerHTML = cart.map((item, index) => {
                    // تحديد الصورة بناءً على اللون المختار
                    let displayImage = item.image;
                    if (item.selectedColor && item.variants) {
                        const variant = item.variants.find(v => v.color === item.selectedColor);
                        if (variant && variant.image) displayImage = variant.image;
                    }

                    return `
                    <div class="group flex gap-4 p-4 bg-white border border-stone-100 rounded-2xl hover:border-stone-300 hover:shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)] transition-all duration-300 relative overflow-hidden">
                        <!-- Image -->
                        <div class="h-24 w-24 flex-shrink-0 bg-white rounded-xl overflow-hidden border border-stone-100 relative">
                            <img src="${displayImage}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-700" alt="${item.name}">
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <div class="flex justify-between items-start gap-2">
                                    <h3 class="font-bold text-stone-900 text-sm leading-snug line-clamp-2 hover:text-blue-600 transition-colors cursor-pointer" onclick="viewProduct('${item.id}'); toggleCart(false)">${item.name}</h3>
                                    <button onclick="removeFromCartByIndex(${index})" class="text-stone-600 hover:text-red-600 transition-colors p-1 -mt-1 -ml-1 rounded-full hover:bg-red-50" aria-label="حذف المنتج"><i data-lucide="x" size="16"></i></button>
                                </div>
                                <p class="text-[10px] text-stone-600 mt-1 font-bold tracking-wider uppercase">${item.category}</p>
                                ${item.selectedColor ? `<p class="text-[10px] text-stone-600 mt-1 bg-white inline-block px-1.5 py-0.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                            </div>
                            
                            <!-- Controls -->
                            <div class="flex justify-between items-end mt-3">
                                <p class="text-base font-serif font-bold text-stone-900">$${item.price}</p>
                                
                                <div class="flex items-center gap-3 bg-white rounded-lg p-1 border border-stone-100">
                                    <button onclick="updateQuantityByIndex(${index}, -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors disabled:opacity-50 hover:text-stone-900" aria-label="تقليل الكمية"><i data-lucide="minus" size="14"></i></button>
                                    <span class="w-6 text-center text-sm font-bold text-stone-800 select-none">${item.quantity}</span>
                                    <button onclick="updateQuantityByIndex(${index}, 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors hover:text-stone-900" aria-label="زيادة الكمية"><i data-lucide="plus" size="14"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function updateFavoritesUI() {
            // Simplified: Only update badge
            const badge = document.getElementById('fav-badge');
            if(badge) badge.classList.toggle('hidden', favorites.length === 0);
        }

        function updateMegaMenu() {
            const list = document.getElementById('mega-menu-categories-list');
            const popularList = document.getElementById('mega-menu-popular-list');
            const mobList = document.getElementById('mobile-cats-list');
            
            // 1. Update Sidebar List (Modern Hover Effect)
            if (list) {
                // Take first 6 categories for sidebar
                const visibleCats = CATEGORIES.slice(0, 6);
                
                list.innerHTML = visibleCats.map((cat) => {
                    const safeName = cat.name.replace(/'/g, "\\'");
                    return `
                    <li>
                        <button onclick="filterCategory('${safeName}')" class="group/item w-full flex items-center gap-4 p-3 rounded-2xl hover:bg-white hover:shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)] transition-all duration-300 border border-transparent hover:border-stone-100 text-right">
                            <div class="w-12 h-12 rounded-xl bg-white border border-stone-200 p-0.5 overflow-hidden flex-shrink-0 shadow-sm group-hover/item:scale-105 transition-transform">
                                <img src="${cat.image}" class="w-full h-full object-cover rounded-lg" onerror="this.style.display='none'" alt="${cat.name}">
                            </div>
                            <div class="flex-1">
                                <span class="block font-bold text-stone-700 text-sm group-hover/item:text-stone-900 transition-colors truncate">${cat.name}</span>
                                <span class="text-[10px] text-stone-600 group-hover/item:text-blue-500 transition-colors font-medium">تصفح المجموعة</span>
                            </div>
                            <i data-lucide="chevron-left" size="16" class="text-stone-600 opacity-0 -translate-x-2 group-hover/item:opacity-100 group-hover/item:translate-x-0 transition-all"></i>
                        </button>
                    </li>
                    `;
                }).join('');
            }

            // 2. Update Popular Grid (Visual Cards - Clean & Modern)
            if (popularList) {
                // Take 3 main categories for the large grid
                const popularCats = CATEGORIES.slice(0, 3); 
                
                if (popularCats.length === 0) {
                    popularList.innerHTML = `<div class="col-span-3 flex flex-col items-center justify-center text-stone-600 h-full bg-stone-50/50 rounded-3xl border-2 border-dashed border-stone-200"><i data-lucide="folder-open" size="40" class="mb-3 opacity-50"></i><p class="text-sm font-bold">لا توجد أقسام للعرض</p></div>`;
                } else {
                    popularList.innerHTML = popularCats.map((cat, index) => `
                        <div onclick="filterCategory('${cat.name.replace(/'/g, "\\'")}')" class="group relative h-full rounded-[2rem] overflow-hidden cursor-pointer shadow-sm hover:shadow-2xl hover:shadow-stone-200/50 transition-all duration-500 border border-stone-100 bg-stone-100">
                            <img src="${cat.image}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110" loading="lazy" alt="${cat.name}">
                            
                            <!-- Premium Gradient Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-60 group-hover:opacity-50 transition-opacity duration-500"></div>
                            
                            <!-- Floating Content -->
                            <div class="absolute bottom-0 left-0 w-full p-6 translate-y-2 group-hover:translate-y-0 transition-transform duration-500">
                                <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl overflow-hidden relative group-hover:bg-white/20 transition-colors">
                                    <!-- Decorative Shape -->
                                    <div class="absolute top-0 right-0 w-12 h-12 bg-white/10 rounded-bl-full -mr-4 -mt-4 blur-sm"></div>
                                    
                                    <h4 class="text-white font-bold text-xl mb-1 relative z-10">${cat.name}</h4>
                                    
                                    <div class="flex items-center gap-2 text-white/90 text-xs font-bold opacity-0 group-hover:opacity-100 transition-all duration-500 delay-75 transform translate-y-2 group-hover:translate-y-0">
                                        <span>اكتشف المزيد</span>
                                        <div class="bg-white text-stone-900 rounded-full p-0.5"><i data-lucide="arrow-left" size="10"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // 3. Update Mobile List (No Change)
            if (mobList) {
                // ... existing mobile code ...
                mobList.innerHTML = CATEGORIES.map(cat => `
                    <button onclick="filterCategory('${cat.name.replace(/'/g, "\\'")}')" class="w-full py-3 text-center text-sm text-stone-600 hover:bg-white flex items-center justify-center gap-3 border-b border-stone-50 last:border-none">
                        <img src="${cat.image}" class="w-8 h-8 rounded-lg object-cover border border-stone-200 shadow-sm" alt="${cat.name}">
                        ${cat.name}
                    </button>
                `).join('');
            }
            lucide.createIcons();
        }

        function applyShopFilters() {
            const grid = document.getElementById('shop-products-grid');
            const empty = document.getElementById('shop-empty-state');
            const count = document.getElementById('results-count');
            
            if (!grid) return;

            let filtered = PRODUCTS.filter(p => {
                // 1. Search Logic (Improved Smart Search)
                const rawQuery = shopState.search;
                let matchesSearch = true;
                
                if (rawQuery && rawQuery.trim().length > 0) {
                    // Normalize search query and split into terms
                    const searchTerms = normalizeArabic(rawQuery).split(/\s+/).filter(t => t.length > 0);
                    
                    // Create comprehensive searchable text from all relevant product fields
                    const productSearchText = normalizeArabic(
                        (p.name || "") + " " + 
                        (p.description || "") + " " + 
                        (p.brand || "") + " " + 
                        (p.category || "") + " " +
                        (p.features ? p.features.join(" ") : "") + " " +
                        (p.specifications ? p.specifications.map(s => s.value).join(" ") : "")
                    );

                    // Check if EVERY search term exists in the product text (AND Logic for Accuracy)
                    matchesSearch = searchTerms.every(term => productSearchText.includes(term));
                }

                const matchesCat = shopState.categories.length === 0 || shopState.categories.includes(p.category);
                const matchesPrice = p.price >= shopState.priceMin && p.price <= shopState.priceMax;
                
                return matchesSearch && matchesCat && matchesPrice;
            });

            if (shopState.sort === 'price-low') filtered.sort((a, b) => a.price - b.price);
            else if (shopState.sort === 'price-high') filtered.sort((a, b) => b.price - a.price);
            else if (shopState.sort === 'newest') filtered.reverse();

            if (count) count.innerText = `النتائج: ${filtered.length}`;
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                if(empty) empty.classList.remove('hidden');
            } else {
                if(empty) empty.classList.add('hidden');
                grid.innerHTML = filtered.map(p => createProductCard(p)).join('');
            }
            lucide.createIcons();
        }

        // --- Render Views ---
        // --- ⚡ PERFORMANCE FIX: VIEW MANAGER (Prevent Excessive Repaint) ---
        // حل مشكلة إعادة الرسم العنيف: بدلاً من حذف الصفحة، نقوم بإخفاء/إظهار العناصر
        
        // UPDATED: تحويل الدالة إلى Async لدعم الانتقالات السلسة (Transitions)
        async function renderView() {
            const main = document.getElementById('main-content');
            const viewId = `view-${currentView}`;
            
            // 🆕 1. Transition OUT (إخفاء الصفحة الحالية بتأثير بصري)
            const currentActive = Array.from(main.children).find(c => !c.classList.contains('hidden'));
            
            // إذا كانت هناك صفحة نشطة وهي ليست الصفحة الجديدة، نقوم بإخفائها بتدريج
            if (currentActive && currentActive.id !== viewId) {
                // إضافة كلاسات الحركة للخروج (تلاشي + هبوط بسيط)
                currentActive.classList.add('transition-all', 'duration-300', 'ease-in-out', 'opacity-0', 'translate-y-4');
                
                // انتظار انتهاء الحركة (300ms) محاكاة لـ AJAX Latency
                await new Promise(resolve => setTimeout(resolve, 250));
                
                // إخفاء العنصر تماماً وإزالة كلاسات الحركة للاستخدام المستقبلي
                currentActive.classList.add('hidden');
                currentActive.classList.remove('transition-all', 'duration-300', 'ease-in-out', 'opacity-0', 'translate-y-4');
            }

            // Scroll to top immediately after transition out
            window.scrollTo({ top: 0, behavior: 'auto' });

            // 2. التحكم في البانر (فقط للرئيسية)
            const banner = document.getElementById('header-banner-container');
            if (banner) {
                // نظهر البانر فقط إذا كنا في الرئيسية ونمتلك الرابط
                const isHome = currentView === 'home';
                if (isHome && HERO_SETTINGS.showFooterBanner && HERO_SETTINGS.footerBannerUrl) {
                    banner.classList.remove('hidden');
                    // Banner Entry Animation
                    banner.classList.remove('opacity-0', '-translate-y-2');
                    banner.classList.add('transition-all', 'duration-500', 'opacity-100', 'translate-y-0');
                } else {
                    banner.classList.add('hidden');
                    banner.classList.add('opacity-0', '-translate-y-2');
                }
            }

            // 3. تحديد الصفحات التي يجب إعادة بنائها دائماً
            const volatileViews = ['home', 'product-details', 'admin', 'orders', 'favorites', 'offers'];
            const isVolatile = volatileViews.includes(currentView);
            
            let viewContainer = document.getElementById(viewId);

            // 4. منطق العرض أو الإنشاء
            if (!viewContainer || isVolatile) {
                // إذا لم يكن الكونتينر موجوداً، ننشئه
                if (!viewContainer) {
                    viewContainer = document.createElement('div');
                    viewContainer.id = viewId;
                    main.appendChild(viewContainer);
                } else {
                    // تفريغ المحتوى إذا كانت الصفحة متطايرة
                    viewContainer.innerHTML = '';
                }
                
                // إعداد الحالة الأولية للدخول (غير مرئي + مزاح للأسفل قليلاً)
                viewContainer.className = 'w-full h-full opacity-0 translate-y-8 transition-all duration-500 ease-out hidden';
                viewContainer.classList.remove('hidden'); // إظهار الهيكل لبدء الرسم

                // استدعاء دالة الرسم المناسبة وتمرير الحاوية الجديدة
                if (currentView === 'home') {
                    renderFeatured(viewContainer);
                    renderCategorySections(viewContainer); 
                    renderRealWorkSection(viewContainer); 
                    renderReviewsSection(viewContainer); 
                } else if (currentView === 'shop') {
                    renderShop(viewContainer);
                } else if (currentView === 'offers') { 
                    renderOffers(viewContainer);
                } else if (currentView === 'categories') {
                    renderCategoriesView(viewContainer);
                } else if (currentView === 'about') {
                    renderAbout(viewContainer);
                } else if (currentView === 'contact') {
                    renderContact(viewContainer);
                } else if (currentView === 'return-policy') {
                    renderReturnPolicy(viewContainer);
                } else if (currentView === 'faq') { 
                    renderFAQ(viewContainer);
                } else if (currentView === 'product-details') {
                    renderProductDetails(viewContainer);
                } else if (currentView === 'admin') {
                    renderAdmin(viewContainer);
                } else if (currentView === 'orders') {
                    renderOrders(viewContainer);
                } else if (currentView === 'login') {
                    renderLogin(viewContainer);
                } else if (currentView === 'track-order') {
                    renderTrackOrder(viewContainer);
                } else if (currentView === 'favorites') {
                    renderFavoritesPage(viewContainer);
                }
                
                lucide.createIcons();
            } else {
                // 5. للصفحات الثابتة (Cached): إعادة تهيئة الحركة
                viewContainer.classList.remove('hidden');
                
                // Reset Animation State (Prepare for Entry)
                viewContainer.classList.remove('transition-all', 'duration-500', 'ease-out');
                viewContainer.classList.add('opacity-0', 'translate-y-8');
                
                // Force Reflow
                void viewContainer.offsetWidth; 
                
                // Re-apply transition class
                viewContainer.classList.add('transition-all', 'duration-500', 'ease-out');

                // حالة خاصة للمتجر: تحديث الشبكة فقط (للفلتر)
                if (currentView === 'shop') {
                    applyShopFilters();
                }
            }
            
            // 🆕 6. Transition IN (تشغيل حركة الدخول)
            // نستخدم requestAnimationFrame لضمان تطبيق الحركة بعد الرسم
            requestAnimationFrame(() => {
                if(viewContainer) {
                    viewContainer.classList.remove('opacity-0', 'translate-y-8');
                    viewContainer.classList.add('opacity-100', 'translate-y-0');
                }
            });
            
            // ضبط المسافات للموبايل
            setTimeout(adjustMobileLayout, 50);
        }

        // --- NEW: Render Reviews Section (Customer Trust) ---
        function renderReviewsSection(c) {
            // تصفية المراجعات المعتمدة والتي لها تقييم عالي (4 أو 5 نجوم)
            // نأخذ عدد أكبر قليلاً لملء الشريط
            const validReviews = ALL_REVIEWS.filter(r => r.status === 'approved' && r.rating >= 4).slice(0, 20);
            
            if (validReviews.length === 0) return;

            // نحتاج لتكرار المراجعات لضمان استمرارية الشريط (Infinite Loop)
            // إذا كان العدد قليل نكرره أكثر من مرة
            let loopReviews = [...validReviews];
            if (loopReviews.length < 10) {
                loopReviews = [...loopReviews, ...loopReviews, ...loopReviews]; 
            } else {
                loopReviews = [...loopReviews, ...loopReviews]; // تكرار مرة واحدة يكفي
            }

            // إضافة ستايل الانيميشن ديناميكياً
            const styleId = 'marquee-style';
            if (!document.getElementById(styleId)) {
                const style = document.createElement('style');
                style.id = styleId;
                style.innerHTML = `
                    @keyframes scroll-rtl {
                        0% { transform: translateX(0); }
                        100% { transform: translateX(50%); } /* التحرك لليمين في المحتوى العربي */
                    }
                    .animate-scroll-rtl {
                        animation: scroll-rtl 60s linear infinite;
                    }
                    .pause-on-hover:hover .animate-scroll-rtl {
                        animation-play-state: paused;
                    }
                `;
                document.head.appendChild(style);
            }

            c.innerHTML += `
            <div class="py-24 bg-[#F9FAFB] relative overflow-hidden dir-ltr"> <!-- dir-ltr للحاوية لضبط الحركة -->
                
                <!-- Background Decor -->
                <div class="absolute inset-0 z-0 opacity-30" style="background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 32px 32px;"></div>
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-[#F9FAFB] to-transparent z-10"></div>
                <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-[#F9FAFB] to-transparent z-10"></div>

                <div class="container mx-auto px-4 relative z-20 mb-12 text-center dir-rtl">
                    <span class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-bold mb-6 border border-yellow-200 shadow-sm">
                        <i data-lucide="star" size="14" class="fill-current"></i>
                        تقييمات حقيقية موثقة
                    </span>
                    <h3 class="text-4xl md:text-5xl font-black text-stone-900 mb-4 tracking-tight">
                        عملاؤنا هم سر نجاحنا
                    </h3>
                    <p class="text-stone-500 text-lg max-w-2xl mx-auto font-medium">
                        نفخر بثقة أكثر من +1000 عميل في جميع أنحاء مصر.
                    </p>
                </div>

                <!-- Marquee Container -->
                <div class="relative w-full overflow-hidden pause-on-hover">
                    <!-- Gradient Masks for Edges -->
                    <div class="absolute top-0 left-0 h-full w-20 md:w-60 bg-gradient-to-r from-[#F9FAFB] to-transparent z-10 pointer-events-none"></div>
                    <div class="absolute top-0 right-0 h-full w-20 md:w-60 bg-gradient-to-l from-[#F9FAFB] to-transparent z-10 pointer-events-none"></div>

                    <!-- Rolling Track -->
                    <div class="flex gap-6 w-max animate-scroll-rtl">
                        ${loopReviews.map((r) => `
                            <div class="w-[300px] md:w-[380px] flex-shrink-0 dir-rtl">
                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-stone-100 hover:shadow-xl hover:border-yellow-200 transition-all duration-300 h-full flex flex-col group cursor-default">
                                    
                                    <!-- Header: User & Rating -->
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-700 font-bold text-sm border border-stone-200">
                                                ${r.userName.charAt(0)}
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-stone-900 text-sm">${r.userName}</h4>
                                                <span class="text-[10px] text-stone-400 block">${new Date(r.createdAt).toLocaleDateString('ar-EG')}</span>
                                            </div>
                                        </div>
                                        <div class="bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100 flex gap-0.5">
                                            ${Array(5).fill(0).map((_, i) => `
                                                <i data-lucide="star" class="w-3 h-3 ${i < r.rating ? 'text-yellow-500 fill-yellow-500' : 'text-stone-300'}"></i>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <!-- Content -->
                                    <div class="flex-1 mb-4">
                                        <i data-lucide="quote" class="w-6 h-6 text-stone-200 mb-2 fill-stone-100"></i>
                                        <p class="text-stone-600 text-sm leading-relaxed font-medium line-clamp-3">
                                            "${r.comment}"
                                        </p>
                                    </div>

                                    <!-- Footer: Verification -->
                                    ${r.verified ? `
                                    <div class="pt-4 border-t border-stone-50 flex items-center gap-2 text-xs font-bold text-green-600">
                                        <div class="bg-green-100 p-1 rounded-full"><i data-lucide="check" size="10" stroke-width="3"></i></div>
                                        عملية شراء مؤكدة
                                    </div>
                                    ` : `<div class="h-8"></div>`}
                                    
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
            
            lucide.createIcons();
        }

        // --- NEW: Render Real Work Section (أعمالنا من أرض الواقع) ---
        function renderRealWorkSection(c) {
            // التحقق من صلاحية المدير
            const isAdmin = user && user.email === ADMIN_EMAIL;
            
            // تحديد الصور التي سيتم عرضها بناءً على Limit
            const visibleWorks = REAL_WORKS.slice(0, realWorkLimit);
            const hasMore = REAL_WORKS.length > realWorkLimit;

            // Added min-h-[600px] to container
            c.innerHTML += `
            <div class="py-24 bg-white relative overflow-hidden min-h-[600px]">
                
                <div class="container mx-auto px-4 md:px-8 relative z-10">
                    
                    <!-- Modern Header with Actions (Centered on Mobile) -->
                    <!-- UPDATED: Removed 'fade-in-up' -->
                    <div class="flex flex-col xl:flex-row justify-between items-center xl:items-end mb-12 gap-8 text-center xl:text-right">
                        <div class="max-w-2xl w-full xl:w-auto">
                            <div class="flex items-center justify-center xl:justify-start gap-2 mb-3">
                                <span class="text-xs font-bold uppercase tracking-[0.2em] text-stone-600"></span>
                            </div>
                            <h3 class="text-3xl md:text-5xl font-black text-stone-900 leading-tight mb-4">
                                معرض أعمالنـا <br>

                            </h3>
                            <p class="text-stone-600 text-sm md:text-base font-medium leading-relaxed max-w-lg mx-auto xl:mx-0">
                                تشطيباتنا من أرض الواقع.
                            </p>
                        </div>
                        
                        <!-- Actions (Social & Consultation Buttons) -->
                        <!-- UPDATED: Added justify-center xl:justify-end -->
                        <div class="flex flex-wrap gap-2.5 justify-center xl:justify-end w-full xl:w-auto">
                            <!-- Facebook -->
                            <!-- UPDATED: Added Aria Label -->
                            <a href="https://www.facebook.com/gedar.fayoum" target="_blank" class="flex items-center gap-2 bg-white border border-stone-300 px-4 py-2.5 rounded-full text-xs font-bold text-stone-800 hover:text-[#1877F2] hover:border-[#1877F2] hover:bg-[#1877F2]/5 transition-all shadow-sm group" aria-label="تابع أحدث أعمالنا على فيسبوك" title="تابع أحدث أعمالنا على فيسبوك">
                                <i data-lucide="facebook" size="16"></i>
                                <span class="hidden sm:inline">فيسبوك</span>
                            </a>

                            <!-- Instagram -->
                            <!-- UPDATED: Added Aria Label -->
                            <a href="https://www.instagram.com/gedar_fayoum" target="_blank" class="flex items-center gap-2 bg-white border border-stone-300 px-4 py-2.5 rounded-full text-xs font-bold text-stone-800 hover:text-[#E4405F] hover:border-[#E4405F] hover:bg-[#E4405F]/5 transition-all shadow-sm group" aria-label="شاهد صور التنفيذ على انستجرام" title="شاهد صور التنفيذ على انستجرام">
                                <i data-lucide="instagram" size="16"></i>
                                <span class="hidden sm:inline">انستجرام</span>
                            </a>

                            <!-- Consultation Button (Featured) -->
                            <a href="https://wa.me/201014175070?text=${encodeURIComponent('مرحباً، أرغب في طلب استشارة بخصوص ديكور منزلي')}" target="_blank" class="flex items-center gap-2 bg-stone-900 border border-stone-900 px-5 py-2.5 rounded-full text-xs font-bold text-white hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5" aria-label="اطلب استشارة مجانية عبر واتساب">
                                <i data-lucide="message-circle" size="16"></i>
                                <span>اطلب استشارتك الآن</span>
                            </a>

                            ${isAdmin ? `
                            <button onclick="toggleAddWorkModal(true)" class="flex items-center gap-2 bg-stone-100 border border-stone-200 text-stone-700 px-4 py-2.5 rounded-full text-xs font-bold hover:bg-stone-200 transition-all">
                                <i data-lucide="plus" size="16"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Clean Grid Layout -->
                    <div id="real-work-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${visibleWorks.map((itemUrl, i) => {
                            // Check if YouTube
                            const ytId = getYouTubeID(itemUrl);
                            const isVideo = !!ytId;
                            // Thumbnail: YouTube HQ or Original Image
                            const displayImg = isVideo ? `https://img.youtube.com/vi/${ytId}/hqdefault.jpg` : itemUrl;

                            return `
                            <!-- UPDATED: Removed 'fade-in-up' and animation-delay style -->
                            <div onclick="openLightbox(${i})" class="group relative aspect-[4/5] rounded-3xl overflow-hidden cursor-pointer bg-stone-100 shadow-sm hover:shadow-xl transition-all duration-500 border border-stone-200">
                                <img src="${displayImg}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 will-change-transform" loading="lazy" alt="تنفيذ واقعي">
                                
                                <!-- Clean Dark Overlay -->
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                
                                <!-- Center Icon -->
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-all duration-300 scale-90 group-hover:scale-100">
                                    ${isVideo 
                                        ? `<div class="w-14 h-14 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg"><i data-lucide="play" class="ml-1 fill-stone-900 text-stone-900" size="20"></i></div>`
                                        : `<div class="w-12 h-12 bg-white/20 backdrop-blur-md border border-white/30 rounded-full flex items-center justify-center text-white"><i data-lucide="zoom-in" size="20"></i></div>`
                                    }
                                </div>

                                <!-- Admin Delete Button -->
                                ${isAdmin ? `
                                <button onclick="event.stopPropagation(); handleDeleteRealWorkImage(${i})" class="absolute top-3 right-3 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-md transition-all z-20" aria-label="حذف الصورة">
                                    <i data-lucide="trash-2" size="14"></i>
                                </button>
                                ` : ''}
                            </div>
                        `;}).join('')}
                    </div>
                    
                    <!-- Load More Button -->
                    <div id="load-more-container" class="mt-12 text-center ${!hasMore ? 'hidden' : ''}">
                        <button onclick="loadMoreRealWorks()" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold text-stone-800 bg-white border border-stone-300 rounded-full hover:bg-stone-50 hover:border-stone-400 transition-all shadow-sm" aria-label="عرض المزيد من صور الأعمال">
                            <span>عرض المزيد من الصور</span>
                            <i data-lucide="chevron-down" size="16"></i>
                        </button>
                    </div>

                </div>
            </div>`;
            lucide.createIcons();
        }

        // 🆕 دالة تحميل المزيد من الصور (محدثة لدعم الفيديو)
        window.loadMoreRealWorks = () => {
            const start = realWorkLimit;
            const end = start + 4;
            const newItems = REAL_WORKS.slice(start, end);
            const isAdmin = user && user.email === ADMIN_EMAIL;
            
            if(newItems.length === 0) return;
            
            realWorkLimit += newItems.length;
            
            const html = newItems.map((itemUrl, i) => {
                const absoluteIndex = start + i;
                const ytId = getYouTubeID(itemUrl);
                const isVideo = !!ytId;
                const displayImg = isVideo ? `https://img.youtube.com/vi/${ytId}/hqdefault.jpg` : itemUrl;

                return `
                <!-- UPDATED: Removed 'fade-in-up' -->
                <div onclick="openLightbox(${absoluteIndex})" class="group relative aspect-[4/5] rounded-3xl overflow-hidden cursor-pointer bg-stone-100 shadow-sm hover:shadow-xl transition-all duration-500 border border-stone-200">
                    <img src="${displayImg}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 will-change-transform" loading="lazy" alt="تنفيذ واقعي">
                    
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-all duration-300 scale-90 group-hover:scale-100">
                        ${isVideo 
                            ? `<div class="w-14 h-14 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg"><i data-lucide="play" class="ml-1 fill-stone-900 text-stone-900" size="20"></i></div>`
                            : `<div class="w-12 h-12 bg-white/20 backdrop-blur-md border border-white/30 rounded-full flex items-center justify-center text-white"><i data-lucide="zoom-in" size="20"></i></div>`
                        }
                    </div>

                    ${isAdmin ? `
                    <button onclick="event.stopPropagation(); handleDeleteRealWorkImage(${absoluteIndex})" class="absolute top-3 right-3 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-md transition-all z-20">
                        <i data-lucide="trash-2" size="14"></i>
                    </button>
                    ` : ''}
                </div>`;
            }).join('')
            
            document.getElementById('real-work-grid').insertAdjacentHTML('beforeend', html);
            lucide.createIcons();
            
            if (realWorkLimit >= REAL_WORKS.length) {
                document.getElementById('load-more-container').style.display = 'none';
            }
        };

        // 🆕 إدارة نافذة إضافة الأعمال
        window.toggleAddWorkModal = (show) => {
            const backdrop = document.getElementById('add-work-modal-backdrop');
            const modal = document.getElementById('add-work-modal');
            
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // 🆕 تقديم رابط جديد (صورة أو فيديو)
        window.handleSubmitRealWork = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const url = e.target.workUrl.value.trim();
            if (!url) return;
            
            try {
                // إضافة الصورة في بداية المصفوفة
                const newImages = [url, ...REAL_WORKS];
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'realwork'), { images: newImages });
                
                showToast("✅ تمت الإضافة بنجاح");
                toggleAddWorkModal(false);
                e.target.reset();
            } catch(e) {
                console.error(e);
                showToast("❌ حدث خطأ أثناء الحفظ");
            }
        };

        window.handleDeleteRealWorkImage = async (index) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            if (!confirm("هل أنت متأكد من حذف هذه الصورة من المعرض؟")) return;
            
            try {
                const newImages = [...REAL_WORKS];
                newImages.splice(index, 1);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'realwork'), { images: newImages });
                showToast("🗑️ تم حذف الصورة");
            } catch(e) {
                console.error(e);
                showToast("❌ حدث خطأ أثناء الحذف");
            }
        };

        // NEW: Render Offers Page
        function renderOffers(c) {
            const now = Date.now();
            let timedOffers = PRODUCTS.filter(p => p.discount > 0 && p.discountExpiry && p.discountExpiry > now);
            let untimedOffers = PRODUCTS.filter(p => p.discount > 0 && !p.discountExpiry);
            
            // Sort timed offers by expiry (soonest first)
            timedOffers.sort((a, b) => a.discountExpiry - b.discountExpiry);
            
            const allOffers = [...timedOffers, ...untimedOffers];

            c.innerHTML = `
            <div class="pt-4 pb-20 min-h-screen bg-red-50/30">
                <div class="container mx-auto px-2 md:px-6">
                    <div class="text-center mb-8">
                        <span class="inline-block p-2 rounded-2xl bg-red-100 text-red-600 mb-2 shadow-sm border border-red-200"><i data-lucide="timer" size="24"></i></span>
                        <h1 class="text-2xl md:text-4xl font-bold text-stone-900 mb-2">العروض الخاطفة</h1>
                        <p class="text-stone-600 text-xs md:text-lg">اغتنم الفرصة! خصومات حصرية لفترة محدودة.</p>
                    </div>

                    ${allOffers.length === 0 ? `
                        <div class="text-center py-20 bg-white rounded-3xl shadow-sm border border-stone-100 max-w-2xl mx-auto">
                            <div class="w-24 h-24 bg-stone-100 text-stone-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="tag" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">لا توجد عروض نشطة حالياً</h3>
                            <p class="text-stone-600 mb-8">تابعنا قريباً للحصول على أقوى الخصومات.</p>
                            <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all">تصفح كل المنتجات</button>
                        </div>
                    ` : `
                        <!-- Updated Grid: Reverted to 3 columns on mobile -->
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4">
                            ${allOffers.map(p => {
                                // FIXED: Price calculation robustness & Image Optimization & Stock Check
                                const priceNum = Number(p.price) || 0;
                                const discountNum = Number(p.discount) || 0;
                                const finalPrice = (priceNum * (1 - discountNum / 100)).toFixed(0); 
                                const optimizedImg = optimizeImageUrl(p.image);
                                const isInStock = p.inStock !== false;

                                return `
                                <div class="group bg-white rounded-xl border border-red-100 overflow-hidden hover:shadow-lg hover:border-red-200 transition-all h-full flex flex-col relative select-none" onclick="viewProduct('${p.id}')">
                                    
                                    <!-- Discount Badge (Compact) -->
                                    <div class="absolute top-1 right-1 z-10">
                                        <div class="bg-red-600 text-white text-[8px] md:text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                                            -${discountNum}%
                                        </div>
                                    </div>

                                    <!-- Stock Badge if out -->
                                    ${!isInStock ? `
                                    <div class="absolute inset-0 bg-white/60 z-20 flex items-center justify-center backdrop-blur-[1px]">
                                        <div class="bg-stone-800 text-white text-[9px] font-bold px-2 py-1 rounded shadow-sm">
                                            غير متوفر
                                        </div>
                                    </div>` : ''}

                                    <!-- Image -->
                                    <div class="relative aspect-[4/5] overflow-hidden bg-stone-100">
                                        <img src="${optimizedImg}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ${!isInStock ? 'grayscale opacity-70' : ''}" alt="${p.name}" loading="lazy">
                                        
                                        <!-- Countdown Overlay (Mobile Optimized) -->
                                        ${p.discountExpiry ? `
                                        <div class="absolute bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm p-0.5 border-t border-red-100 flex flex-col items-center justify-center z-10">
                                            <div class="discount-timer scale-75 origin-center" data-expiry="${p.discountExpiry}"></div>
                                        </div>` : ''}
                                    </div>

                                    <div class="p-2 flex-1 flex flex-col gap-1">
                                        <h3 class="font-bold text-stone-900 text-[10px] md:text-sm leading-tight line-clamp-2 h-7 md:h-auto group-hover:text-red-600 transition-colors">${p.name}</h3>
                                        
                                        <div class="mt-auto pt-1">
                                            <div class="flex flex-col md:flex-row md:items-center md:gap-1.5 mb-1.5">
                                                <span class="text-sm md:text-xl font-serif text-red-600 font-bold leading-none">${finalPrice}<span class="text-[8px] mr-0.5">ج.م</span></span>
                                                <span class="text-[9px] md:text-xs text-stone-600 line-through decoration-red-200">${Math.floor(priceNum)}</span>
                                            </div>
                                            
                                            <button onclick="event.stopPropagation(); addToCart('${p.id}')" ${!isInStock ? 'disabled' : ''} class="w-full ${isInStock ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-stone-200 text-stone-500 cursor-not-allowed'} py-1.5 md:py-2.5 rounded-lg font-bold shadow-sm transition-colors flex items-center justify-center gap-1 text-[9px] md:text-xs">
                                                ${isInStock ? `<i data-lucide="shopping-bag" size="12"></i> <span class="hidden md:inline">إلحق العرض</span><span class="md:hidden">أضف</span>` : 'نفذت الكمية'}
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `}
                </div>
            </div>`;
            
            startCountdown();
            lucide.createIcons();
        }

        // NEW: Render Favorites Page (Full Screen)
        function renderFavoritesPage(c) {
            const favItems = PRODUCTS.filter(p => favorites.includes(p.id));

            c.innerHTML = `
            <div class="pt-4 pb-20 min-h-screen bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <div class="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
                            <i data-lucide="heart" size="32" class="fill-current"></i>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-3">قائمة الأمنيات</h1>
                        <p class="text-stone-600 font-medium">المنتجات التي حفظتها للرجوع إليها لاحقاً (${favItems.length})</p>
                    </div>

                    ${favItems.length === 0 ? `
                        <div class="max-w-md mx-auto text-center py-16 bg-white rounded-3xl shadow-sm border border-stone-100">
                            <div class="w-24 h-24 bg-white text-stone-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="heart-off" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">القائمة فارغة حالياً</h3>
                            <p class="text-stone-600 mb-8 px-6 leading-relaxed">لم تقم بإضافة أي منتجات إلى المفضلة بعد. تصفح المتجر واضغط على أيقونة القلب لحفظ ما يعجبك.</p>
                            <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto">
                                <span>تصفح المنتجات</span>
                                <i data-lucide="arrow-left" size="18"></i>
                            </button>
                        </div>
                    ` : `
                        <!-- Updated Grid: Reverted to 3 columns on mobile -->
                        <div class="grid grid-cols-3 sm:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-6">
                            ${favItems.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-16 text-center">
                            <button onclick="viewAllProducts()" class="inline-flex items-center gap-2 text-stone-600 font-bold hover:text-stone-900 transition-colors">
                                <i data-lucide="arrow-right" size="18"></i>
                                <span>متابعة التسوق</span>
                            </button>
                        </div>
                    `}
                </div>
            </div>`;
        }

        // NEW: Track Order Page
        function renderTrackOrder(c) {
            c.innerHTML = `
            <!-- تم تحديث التصميم بالكامل ليكون عصرياً -->
            <div class="min-h-screen bg-stone-50/50 pt-4 pb-20 relative overflow-hidden">
                <!-- Background Decoration -->
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-[500px] bg-gradient-to-b from-blue-50/50 to-transparent pointer-events-none -z-10"></div>
                <div class="absolute top-20 right-0 w-64 h-64 bg-orange-100/40 rounded-full blur-3xl -z-10"></div>
                <div class="absolute bottom-0 left-0 w-96 h-96 bg-blue-100/40 rounded-full blur-3xl -z-10"></div>

                <div class="container mx-auto px-4 md:px-6 relative z-10">
                    
                    <!-- Modern Header Section -->
                    <div class="max-w-3xl mx-auto text-center mb-10">
                        <div class="inline-flex items-center justify-center p-3 mb-6 bg-white rounded-2xl shadow-lg shadow-blue-100/50 border border-blue-50">
                            <div class="bg-blue-600 text-white p-2.5 rounded-xl">
                                <i data-lucide="package-search" size="28"></i>
                            </div>
                        </div>
                        <h1 class="text-3xl md:text-5xl font-black text-stone-900 mb-4 tracking-tight">تتبع رحلة طلبك</h1>
                        <p class="text-stone-600 text-sm md:text-lg max-w-lg mx-auto leading-relaxed font-medium">أدخل رقم الشحنة أو رقم الطلب في الأسفل لمعرفة حالة التوصيل وموعد الوصول المتوقع.</p>
                    </div>

                    <!-- Search Box Card -->
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white p-2 md:p-3 rounded-[2rem] shadow-xl shadow-stone-200/40 border border-stone-100 relative group transition-all hover:shadow-2xl hover:shadow-blue-200/20 focus-within:shadow-2xl focus-within:shadow-blue-200/20 focus-within:border-blue-200">
                            <form onsubmit="handleTrackOrderSearch(event)" class="relative flex items-center">
                                <div class="absolute right-4 text-stone-600 group-focus-within:text-blue-600 transition-colors">
                                    <i data-lucide="hash" size="20"></i>
                                </div>
                                <input 
                                    name="orderId" 
                                    required 
                                    class="w-full h-14 md:h-16 pr-12 pl-16 bg-transparent border-none outline-none text-lg md:text-xl font-bold text-stone-800 placeholder:text-stone-600 placeholder:font-medium tracking-wide text-center md:text-right transition-all font-mono" 
                                    placeholder="رقم الطلب"
                                    autocomplete="off"
                                >
                                <button type="submit" class="absolute left-2 top-1/2 -translate-y-1/2 h-10 md:h-12 px-6 md:px-8 bg-stone-900 hover:bg-blue-600 text-white rounded-full flex items-center gap-2 transition-all shadow-md hover:shadow-lg active:scale-95 group/btn">
                                    <span class="hidden md:inline font-bold text-sm">بحث</span>
                                    <i data-lucide="search" size="18" class="group-hover/btn:scale-110 transition-transform"></i>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Helper Text -->
                        <div class="mt-6 flex flex-wrap justify-center gap-4 text-xs md:text-sm font-medium text-stone-600">
                            <span class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-stone-100"><i data-lucide="clock" size="14" class="text-orange-500"></i> تحديث لحظي</span>
                            <span class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-stone-100"><i data-lucide="shield-check" size="14" class="text-green-500"></i> بيانات مشفرة</span>
                            <span class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-stone-100"><i data-lucide="bell" size="14" class="text-blue-500"></i> إشعارات واتساب</span>
                        </div>
                    </div>
                    
                    <!-- Results Container -->
                    <div id="tracking-result" class="max-w-4xl mx-auto mt-12 transition-all"></div>
                    
                    <!-- Support Section -->
                    <div class="mt-20 text-center border-t border-stone-200/60 pt-10 max-w-xl mx-auto">
                        <p class="text-stone-600 text-xs font-bold uppercase tracking-widest mb-3">هل تواجه مشكلة؟</p>
                        <h3 class="text-stone-800 font-bold mb-4">فريق الدعم جاهز لمساعدتك</h3>
                        <a href="https://wa.me/201014175070" target="_blank" class="inline-flex items-center gap-2 text-stone-600 hover:text-green-600 font-bold bg-white px-6 py-3 rounded-xl border border-stone-200 hover:border-green-200 hover:shadow-md transition-all">
                            <i data-lucide="message-circle" size="18"></i>
                            <span>تواصل مع خدمة العملاء</span>
                        </a>
                    </div>
                </div>
            </div>`;
        }

        function renderFeatured(c) {
            // تم إزالة منطق الحساب اليدوي للمسافات (ptMobile/ptDesktop)
            // سنعتمد على id="home-top-section" ودالة adjustMobileLayout

            // --- 🆕 1. Stories Section (Categories Capsules/Chips) ---
            if (CATEGORIES && CATEGORIES.length > 0) {
                // مصفوفة التدريجات اللونية (Gradients)
                const gradients = [
                    "bg-gradient-to-br from-orange-50 to-amber-100 border-orange-200 text-orange-900 group-hover:to-orange-200",
                    "bg-gradient-to-br from-blue-50 to-cyan-100 border-blue-200 text-blue-900 group-hover:to-blue-200",
                    "bg-gradient-to-br from-emerald-50 to-teal-100 border-emerald-200 text-emerald-900 group-hover:to-emerald-200",
                    "bg-gradient-to-br from-violet-50 to-purple-100 border-violet-200 text-violet-900 group-hover:to-purple-200",
                    "bg-gradient-to-br from-rose-50 to-pink-100 border-rose-200 text-rose-900 group-hover:to-rose-200",
                    "bg-gradient-to-br from-slate-50 to-gray-200 border-slate-200 text-slate-900 group-hover:to-gray-300"
                ];

                c.innerHTML += `
                <div class="py-4 bg-white dir-ltr border-b border-stone-50 mb-2">
                    <div class="container mx-auto px-4">
                        <div class="flex gap-3 overflow-x-auto scrollbar-hide px-1 snap-x items-center py-1">
                            
                            <!-- Static 'All' (Dark Capsule - Text Only) -->
                            <button onclick="viewAllProducts()" class="flex items-center justify-center px-6 py-3 bg-stone-900 text-white rounded-full shadow-md shadow-stone-200 flex-shrink-0 snap-start active:scale-95 transition-all duration-200 border border-stone-900 group select-none">
                                <span class="text-xs font-bold leading-none mt-0.5">الكل</span>
                            </button>

                            <!-- Dynamic Categories (Gradient Capsules - Text Only) -->
                            ${CATEGORIES.map((cat, index) => {
                                // اختيار لون متدرج بناءً على الترتيب
                                const gradientClass = gradients[index % gradients.length];
                                
                                return `
                                <button onclick="filterCategory('${cat.name.replace(/'/g, "\\'")}')" class="flex items-center justify-center px-6 py-3 ${gradientClass} rounded-full border shadow-sm flex-shrink-0 snap-start active:scale-95 transition-all duration-300 group whitespace-nowrap select-none hover:shadow-md">
                                    <span class="text-xs font-bold leading-none mt-0.5">${cat.name}</span>
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            }

            // 1. Render Best Sellers (Vertical Capsules Style - Apple Store Like)
            // UPDATED: Random 4 products & Removed Title Text
            const bestSellers = PRODUCTS
                .sort(() => 0.5 - Math.random()) // Random shuffle
                .slice(0, 4); // Take first 4

            c.innerHTML += `
            <div id="home-top-section" class="pb-8 container mx-auto px-4 md:px-6 border-t border-stone-100 min-h-[400px] transition-all duration-300">
                <!-- Title Removed as requested -->
                
                <!-- Vertical Capsules List -->
                <div class="flex flex-col gap-3 md:gap-4 max-w-2xl mx-auto md:mx-0 mt-6">
                    ${bestSellers.map((p, index) => {
                        const hasDiscount = isDiscountActive(p);
                        const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
                        const priceDisplay = Math.floor(finalPrice).toLocaleString();
                        
                        // Short Description Logic
                        let shortDesc = p.description || p.details || "شاهد التفاصيل";
                        if (shortDesc.length > 35) {
                            shortDesc = shortDesc.substring(0, 35) + ".....";
                        } else {
                            shortDesc += ".....";
                        }

                        return `
                        <div onclick="viewProduct('${p.id}')" class="group relative w-full bg-white border border-stone-100 rounded-[2rem] p-2 pr-3 flex items-center gap-3 shadow-sm hover:shadow-lg hover:border-stone-200 transition-all duration-300 cursor-pointer overflow-hidden">
                            
                            <!-- Image (Circle) -->
                            <div class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-stone-50 border border-stone-100 overflow-hidden flex-shrink-0 relative z-10">
                                <img src="${optimizeImageUrl(p.image)}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" alt="${p.name}" loading="lazy">
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1 min-w-0 z-10 py-1 flex flex-col gap-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-bold text-stone-900 text-sm md:text-base truncate group-hover:text-stone-700 transition-colors">${p.name}</h4>
                                    <!-- Category Badge Inside Capsule -->
                                    <span class="text-[10px] bg-stone-100 text-stone-600 px-2 py-0.5 rounded-full whitespace-nowrap font-bold border border-stone-200 ml-2 hidden sm:inline-block">${p.category}</span>
                                </div>
                                
                                <!-- Product Details Snippet -->
                                <p class="text-[11px] text-stone-500 font-medium leading-tight opacity-80 pl-2">
                                    ${shortDesc}
                                </p>
                                
                                <div class="flex items-center gap-2 mt-auto pt-1">
                                    <span class="text-sm md:text-lg font-bold text-[#00796B] font-serif">${priceDisplay} <span class="text-[10px] font-sans font-normal">ج.م</span></span>
                                    ${hasDiscount ? `<span class="text-[9px] md:text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">-${p.discount}%</span>` : ''}
                                </div>
                            </div>

                            <!-- Actions Group (Add to Cart Only) -->
                            <div class="flex flex-col sm:flex-row items-center gap-2 z-20 shrink-0 ml-1">
                                <!-- Quick Add Button (Updated) -->
                                <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="h-9 md:h-10 px-3 md:px-4 rounded-full bg-stone-100 hover:bg-stone-900 hover:text-white flex items-center justify-center gap-1.5 transition-all duration-300 text-stone-600 shadow-sm border border-stone-200 active:scale-95 group/btn" aria-label="أضف للسلة">
                                    <i data-lucide="shopping-bag" size="16"></i>
                                    <span class="text-[10px] md:text-xs font-bold whitespace-nowrap">إضافة للسلة</span>
                                </button>
                            </div>
                            
                            <!-- Click Feedback Overlay -->
                            <div class="absolute inset-0 bg-stone-50 opacity-0 group-active:opacity-100 transition-opacity duration-200 pointer-events-none"></div>
                        </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- See All Button (Optional) -->
                <div class="mt-6 text-center md:text-right">
                    <button onclick="setView('shop')" class="text-xs font-bold text-stone-500 hover:text-stone-900 transition-colors inline-flex items-center gap-1">
                        عرض كل المنتجات <i data-lucide="arrow-left" size="12"></i>
                    </button>
                </div>
            </div>`;

            // NEW: Render Best Seller Banner (If Enabled)
            if (HERO_SETTINGS.showBestSellerBanner && HERO_SETTINGS.bestSellerBannerUrl) {
                 c.innerHTML += `
                    <div class="container mx-auto px-6 mb-4">
                        <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                            <!-- تعديل هنا: استخدام object-fill -->
                            <img src="${HERO_SETTINGS.bestSellerBannerUrl}" 
                                 class="object-fill md:object-cover"
                                 style="height: ${HERO_SETTINGS.bestSellerBannerHeight || 200}px; width: ${HERO_SETTINGS.bestSellerBannerWidth || 100}%;" 
                                 alt="بانر إعلاني">
                        </div>
                    </div>`;
            }

            // 2. Render Featured Products (Normal Slider Style as requested)
            const featuredProducts = PRODUCTS.filter(p => p.isFeatured);
            
            if (featuredProducts.length > 0) {
                c.innerHTML += `
                <!-- UPDATED: Reduced padding to pt-4 pb-12 -->
                <div class="pt-4 pb-12 bg-yellow-50/50 border-t border-stone-100">
                    <div class="container mx-auto px-6">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <span class="text-xs font-bold text-yellow-600 tracking-wider uppercase mb-1 block">اختياراتنا لك</span>
                                <h3 class="text-2xl md:text-3xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="star" class="text-yellow-500 fill-yellow-500" size="24"></i> منتجات مميزة</h3>
                            </div>
                        </div>
                        
                        <!-- WRAPPER for Relative Positioning of Arrows -->
                        <div class="relative group/slider">
                            <!-- Right Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: 300, behavior: 'smooth' })" class="absolute top-1/2 -right-4 lg:-right-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 translate-x-4 group-hover/slider:translate-x-0 hidden md:flex" aria-label="السابق">
                                <i data-lucide="chevron-right" size="24"></i>
                            </button>

                            <!-- Slider Container (Improved Horizontal Scrolling) -->
                            <!-- UPDATED: Added snap-mandatory, adjusted margins for full-bleed mobile feel -->
                            <div id="special-slider" class="flex overflow-x-auto scrollbar-hide snap-x snap-mandatory pb-8 pt-4 -mx-6 px-6 md:mx-0 md:px-0 scroll-smooth gap-4 md:gap-0">
                                ${featuredProducts.map(p => {
                                    return `
                                    <!-- UPDATED: Fixed width on mobile (280px) for better card feel, fluid on desktop -->
                                    <div class="min-w-[280px] w-[280px] md:min-w-0 md:w-1/3 lg:w-1/4 flex-shrink-0 snap-center md:snap-start md:px-3 group cursor-pointer transition-transform duration-300 hover:-translate-y-1">
                                        ${createProductCard(p)}
                                    </div>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Left Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: -300, behavior: 'smooth' })" class="absolute top-1/2 -left-4 lg:-left-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 -translate-x-4 group-hover/slider:translate-x-0 hidden md:flex" aria-label="التالي">
                                <i data-lucide="chevron-left" size="24"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }
        }

        // NEW: Render Category Sections (Full Grid 5 cols)
        function renderCategorySections(c) {
            // 1. Filter valid categories (only those containing products)
            const activeCategories = CATEGORIES.filter(cat => PRODUCTS.some(p => p.category === cat.name));

            if (activeCategories.length === 0) return;

            let visibleHTML = '';
            let hiddenHTML = '';

            // Loop through valid categories
            activeCategories.forEach((cat, index) => {
                // Get products for this category
                let catProducts = PRODUCTS.filter(p => p.category === cat.name);
                
                // Randomize products
                catProducts = catProducts.sort(() => 0.5 - Math.random());

                // Logic for "Show More" items within the category (Products inside section)
                const initialLimit = 25;
                const visibleProducts = catProducts.slice(0, initialLimit);
                const hiddenProducts = catProducts.slice(initialLimit);
                const hasHidden = hiddenProducts.length > 0;
                const hiddenContainerId = `more-products-${index}`;
                const btnId = `btn-more-${index}`;

                const sectionHTML = `
                <!-- Category Section -->
                <div class="py-4 border-t border-stone-100 bg-white">
                    <div class="container mx-auto px-6">
                        <!-- Category Header -->
                        <div class="flex items-center gap-4 mb-6 mt-4">
                            <div class="w-12 h-12 rounded-xl bg-white border border-stone-200 overflow-hidden shrink-0">
                                <img src="${cat.image}" class="w-full h-full object-cover" alt="${cat.name}">
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-stone-900">${cat.name}</h3>
                            </div>
                            <button onclick="filterCategory('${cat.name}'); setView('shop')" class="mr-auto text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100" aria-label="عرض كافة منتجات قسم ${cat.name}">
                                عرض الكل <i data-lucide="arrow-left" size="14"></i>
                            </button>
                        </div>

                        <!-- Products Grid: Reverted to 3 columns on mobile -->
                        <div class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-6">
                            ${visibleProducts.map(p => createProductCard(p)).join('')}
                        </div>

                        <!-- Hidden Products Container (Inside Section) -->
                        ${hasHidden ? `
                        <div id="${hiddenContainerId}" class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-6 mt-6 hidden">
                            ${hiddenProducts.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button id="${btnId}" onclick="document.getElementById('${hiddenContainerId}').classList.remove('hidden'); this.style.display='none';" class="inline-flex items-center gap-2 text-stone-800 hover:text-stone-900 text-sm font-bold transition-all hover:bg-white px-4 py-2 rounded-lg border border-transparent hover:border-stone-200">
                                <span>عرض المزيد من ${cat.name}</span>
                                <i data-lucide="chevron-down" size="16"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                // Split into visible (first 3) and hidden (rest)
                if (index < 3) {
                    visibleHTML += sectionHTML;
                } else {
                    hiddenHTML += sectionHTML;
                }
            });

            // Append Visible Sections
            c.innerHTML += visibleHTML;

            // Append Hidden Sections Button & Container if there are more
            if (hiddenHTML) {
                c.innerHTML += `
                <div id="hidden-categories-wrapper" class="hidden">
                    ${hiddenHTML}
                </div>
                
                <div id="show-more-cats-btn-container" class="py-8 text-center bg-white/30 border-t border-stone-100 mt-4">
                    <button onclick="document.getElementById('hidden-categories-wrapper').classList.remove('hidden'); document.getElementById('show-more-cats-btn-container').style.display='none';" class="group bg-white border-2 border-stone-200 text-stone-800 px-8 py-3.5 rounded-full font-bold hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all shadow-sm hover:shadow-lg flex items-center gap-3 mx-auto text-sm">
                        <span>عرض المزيد من الأقسام</span>
                        <div class="w-6 h-6 rounded-full bg-stone-100 text-stone-600 flex items-center justify-center group-hover:bg-white/20 group-hover:text-white transition-colors">
                            <i data-lucide="chevron-down" size="16"></i>
                        </div>
                    </button>
                </div>
                `;
            }

            lucide.createIcons();
        }

        function renderShop(c) {
            const catsHTML = generateCategoryFilterHTML();
            // REMOVED: Unused adminBlock logic
            
            c.innerHTML = `<div class="bg-[#FAFAFA] min-h-screen pt-4 pb-20">
                <div class="container mx-auto px-4 md:px-6">
                    
                    <!-- Mobile Search & Filter Toolbar -->
                    <!-- تم ضبط top ليكون مناسباً أسفل الهيدر (80px) -->
                    <div class="lg:hidden mb-4 space-y-3 sticky top-[85px] z-30 bg-[#FAFAFA]/95 backdrop-blur-sm py-2 -mx-4 px-4 shadow-sm border-b border-stone-200/50">
                         <div class="relative group">
                            <label for="mobile-shop-search" class="sr-only">البحث</label>
                            <input id="mobile-shop-search" class="w-full bg-white border border-stone-200 p-3 pl-10 rounded-xl shadow-sm text-sm focus:ring-2 focus:ring-stone-900 outline-none transition-colors" 
                                   oninput="updateShopFilters('search',this.value)" 
                                   value="${shopState.search}" 
                                   placeholder="عن ماذا تبحث؟">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-600" size="18"></i>
                         </div>
                         <div class="flex gap-2">
                             <button onclick="toggleFilterDrawer(true)" class="flex-1 bg-white border border-stone-200 p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-stone-700 text-xs shadow-sm active:bg-white transition-colors">
                                <i data-lucide="sliders-horizontal" size="16"></i> تصفية النتائج
                             </button>
                             <!-- Sort (Mobile) -->
                             <div class="relative flex-1">
                                <label for="mobile-sort-select" class="sr-only">ترتيب حسب</label>
                                <select id="mobile-sort-select" onchange="updateShopFilters('sort',this.value)" class="w-full h-full appearance-none bg-white border border-stone-200 p-3 pl-8 pr-4 rounded-xl text-xs font-bold text-stone-700 shadow-sm focus:outline-none">
                                    <option value="featured" ${shopState.sort === 'featured' ? 'selected' : ''}>المميز</option>
                                    <option value="price-low" ${shopState.sort === 'price-low' ? 'selected' : ''}>أقل سعر</option>
                                    <option value="price-high" ${shopState.sort === 'price-high' ? 'selected' : ''}>أعلى سعر</option>
                                    <option value="newest" ${shopState.sort === 'newest' ? 'selected' : ''}>الأحدث</option>
                                </select>
                                <i data-lucide="chevron-down" size="14" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-600 pointer-events-none"></i>
                             </div>
                         </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        
                        <!-- Sidebar Filters (Drawer on Mobile, Sidebar on Desktop) -->
                        <div id="filter-sidebar-overlay" onclick="toggleFilterDrawer(false)" class="fixed inset-0 bg-black/60 z-[60] hidden lg:hidden backdrop-blur-sm transition-opacity fade-in"></div>
                        
                        <aside id="shop-sidebar" class="
                            fixed inset-y-0 right-0 z-[70] w-[85%] max-w-[320px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto
                            lg:translate-x-0 lg:static lg:z-auto lg:w-1/4 lg:shadow-none lg:bg-transparent lg:overflow-visible lg:block lg:sticky lg:top-28
                        ">
                            <!-- Mobile Drawer Header -->
                            <div class="lg:hidden p-5 border-b border-stone-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                <h3 class="font-bold text-lg text-stone-900">تصفية النتائج</h3>
                                <button onclick="toggleFilterDrawer(false)" class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-stone-600 hover:text-red-600 hover:bg-red-50 transition-colors" aria-label="إغلاق الفلتر"><i data-lucide="x" size="18"></i></button>
                            </div>

                            <div class="p-5 lg:p-0 space-y-6">
                                <!-- REMOVED: adminBlock variable -->
                                
                                <!-- Desktop Search Box (Hidden on Mobile) -->
                                <div class="hidden lg:block bg-white p-1 rounded-2xl shadow-sm border border-stone-100">
                                    <div class="relative group">
                                        <label for="desktop-shop-search" class="sr-only">البحث</label>
                                        <input id="desktop-shop-search" class="w-full bg-white border-transparent p-4 pl-12 rounded-xl text-sm font-medium focus:bg-white focus:ring-2 focus:ring-stone-900 focus:outline-none transition-all placeholder:text-stone-600 text-stone-900" oninput="updateShopFilters('search',this.value)" value="${shopState.search}" placeholder="عن ماذا تبحث؟">
                                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-600 group-focus-within:text-stone-900 transition-colors" size="20"></i>
                                    </div>
                                </div>

                                <!-- Filter Container -->
                                <div class="bg-white rounded-3xl shadow-sm border border-stone-100 overflow-hidden">
                                    <div class="p-6 border-b border-stone-50 flex justify-between items-center bg-white">
                                        <h3 class="font-bold text-lg text-stone-900 flex items-center gap-2"><i data-lucide="sliders-horizontal" size="18"></i> الفلاتر</h3>
                                        ${shopState.categories.length > 0 || shopState.priceMax < 10000 ? `<button onclick="resetFilters(); toggleFilterDrawer(false)" class="text-xs font-bold text-red-600 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors">مسح الكل</button>` : ''}
                                    </div>
                                    
                                    <div class="p-6 space-y-8">
                                        <!-- Categories (Added ID) -->
                                        <div>
                                            <h4 class="font-bold text-sm text-stone-600 uppercase tracking-wider mb-4">التصنيفات</h4>
                                            <div id="shop-categories-list" class="space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                                ${catsHTML}
                                            </div>
                                        </div>

                                        <!-- Price Range (Updated to Min/Max Inputs) -->
                                        <div>
                                            <h4 class="font-bold text-sm text-stone-600 uppercase tracking-wider mb-4">نطاق السعر</h4>
                                            <div class="flex items-center gap-3">
                                                <div class="relative w-full group">
                                                    <label for="price-min-input" class="text-[10px] font-bold text-stone-600 absolute -top-2 right-2 bg-white px-1">من</label>
                                                    <input id="price-min-input" type="number" min="0" class="w-full bg-white border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="0" value="${shopState.priceMin}" oninput="updateShopFilters('priceMin', this.value)">
                                                    <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-600 text-xs font-serif">$</span>
                                                </div>
                                                
                                                <span class="text-stone-600 font-bold text-lg">-</span>
                                                
                                                <div class="relative w-full group">
                                                    <label for="price-max-input" class="text-[10px] font-bold text-stone-600 absolute -top-2 right-2 bg-white px-1">إلى</label>
                                                    <input id="price-max-input" type="number" min="0" class="w-full bg-white border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="10000" value="${shopState.priceMax}" oninput="updateShopFilters('priceMax', this.value)">
                                                    <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-600 text-xs font-serif">$</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mobile Apply Button -->
                                <div class="lg:hidden sticky bottom-0 bg-white p-4 border-t border-stone-100 -mx-5 -mb-5 mt-4">
                                    <button onclick="toggleFilterDrawer(false)" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-stone-800 transition-all active:scale-95">
                                        تم الانتهاء
                                    </button>
                                </div>
                            </div>
                        </aside>

                        <!-- Products Grid Area -->
                        <div class="w-full lg:w-3/4">
                            <!-- Top Bar (Visible only on Desktop) -->
                            <div class="hidden lg:flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                                <div class="flex items-center gap-2">
                                    <div class="p-2 bg-white rounded-lg text-stone-600"><i data-lucide="layout-grid" size="18"></i></div>
                                    <p id="results-count" class="text-stone-600 font-bold text-sm"></p>
                                </div>
                                
                                <div class="flex items-center gap-3 w-full sm:w-auto">
                                    <label for="desktop-sort-select" class="text-xs font-bold text-stone-600 whitespace-nowrap">ترتيب حسب:</label>
                                    <div class="relative w-full sm:w-48">
                                        <select id="desktop-sort-select" onchange="updateShopFilters('sort',this.value)" class="w-full appearance-none border border-stone-200 bg-white p-2.5 pl-8 pr-4 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white cursor-pointer transition-colors">
                                            <option value="featured" ${shopState.sort === 'featured' ? 'selected' : ''}>المميز (الافتراضي)</option>
                                            <option value="price-low" ${shopState.sort === 'price-low' ? 'selected' : ''}>السعر: الأقل أولاً</option>
                                            <option value="price-high" ${shopState.sort === 'price-high' ? 'selected' : ''}>السعر: الأعلى أولاً</option>
                                            <option value="newest" ${shopState.sort === 'newest' ? 'selected' : ''}>الأحدث إضافة</option>
                                        </select>
                                        <i data-lucide="chevron-down" size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-600 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Products Grid -->
                            <div id="shop-products-grid" class="grid grid-cols-3 md:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-4">
                                <!-- Products Injected Here -->
                            </div>
                            
                            <!-- Empty State -->
                            <div id="shop-empty-state" class="hidden text-center py-20 flex flex-col items-center">
                                <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-stone-600">
                                    <i data-lucide="search-x" size="32"></i>
                                </div>
                                <h3 class="text-xl font-bold text-stone-900 mb-2">عذراً، لم نجد نتائج</h3>
                                <p class="text-stone-600 text-sm max-w-xs mx-auto mb-8">حاول البحث بكلمات مختلفة أو قم بإزالة بعض الفلاتر.</p>
                                <button onclick="resetFilters()" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
                                    <i data-lucide="refresh-cw" size="16"></i> إعادة تعيين الفلاتر
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            applyShopFilters();
        }

        // NEW: Auto Scroll Logic Helpers
        let scrollTimers = {};

        window.startAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // Clear existing to avoid duplicates
            if (scrollTimers[id]) clearInterval(scrollTimers[id]);

            scrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                if (!element) {
                    clearInterval(scrollTimers[id]);
                    return;
                }

                // منطق التمرير الذكي (Smart Scrolling Logic for RTL/LTR)
                // في وضع RTL (العربية)، التمرير السالب (-) يحرك المحتوى لليسار (لرؤية التالي)
                // ولكن بعض المتصفحات القديمة قد تختلف، لذا نستخدم منطق التحقق
                
                const maxScroll = element.scrollWidth - element.clientWidth;
                // الحصول على القيمة المطلقة للموقع الحالي لأن بعض المتصفحات ترجع قيماً سالبة في RTL
                const currentScroll = Math.abs(element.scrollLeft); 
                const tolerance = 20; // هامش خطأ بسيط

                // التحقق من الوصول للنهاية (اليسار في العربية)
                // ملاحظة: في Chrome RTL الحديث، scrollLeft يبدأ من 0 ويذهب للسالب
                if (currentScroll >= maxScroll - tolerance) {
                    // العودة للبداية (اليمين) بنعومة
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // التحرك خطوة لليسار (التالي)
                    // القيمة السالبة تعني التحرك لليسار في RTL
                    element.scrollBy({ left: -240, behavior: 'smooth' });
                }
            }, 3000); // كل 3 ثواني
        };

        window.stopAutoScroll = (id) => {
            if (scrollTimers[id]) {
                clearInterval(scrollTimers[id]);
                delete scrollTimers[id];
            }
        };

        function renderCategoriesView(c) {
            const html = CATEGORIES.map((cat, index) => {
                // Escape single quotes for the onclick handler
                const safeName = cat.name.replace(/'/g, "\\'");
                return `
                <div onclick="filterCategory('${safeName}')" class="group cursor-pointer flex flex-col gap-2">
                    <div class="relative aspect-square rounded-2xl md:rounded-[2rem] overflow-hidden bg-stone-100 shadow-sm border border-stone-100 group-hover:shadow-xl group-hover:-translate-y-1 transition-all duration-500">
                        <img src="${cat.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 ease-out" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Category'" alt="${cat.name}">
                        
                        <!-- Modern Overlay on Hover -->
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-500"></div>
                    </div>
                    
                    <div class="text-center px-1">
                        <h3 class="font-bold text-stone-900 text-[10px] md:text-sm group-hover:text-stone-600 transition-colors truncate">${cat.name}</h3>
                    </div>
                </div>`;
            }).join('') || `<div class="col-span-full text-center py-20 text-stone-600 bg-white rounded-xl border border-dashed border-stone-200">لا توجد أقسام حالياً</div>`;

            c.innerHTML = `
            <div class="pt-4 pb-20 min-h-screen bg-white">
                <div class="container mx-auto px-4">
                    <!-- Modern Header -->
                    <div class="text-center max-w-2xl mx-auto mb-8">
                        <h1 class="text-2xl md:text-4xl font-bold text-stone-900 mb-2 tracking-tight">تصنيفات المتجر</h1>
                        <p class="text-stone-600 text-xs md:text-lg leading-relaxed">اختر القسم المناسب لتصفح منتجاتنا المميزة.</p>
                    </div>

                    <!-- Updated Categories Grid: Changed to 3 columns on mobile for clearer icons -->
                    <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-6">
                        ${html}
                    </div>

                    <!-- Call to Action -->
                    <div class="mt-12 text-center border-t border-stone-100 pt-8">
                        <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-6 py-3 rounded-full font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto text-xs md:text-sm">
                            <span>عرض جميع المنتجات</span>
                            <i data-lucide="grid-2x2" size="16"></i>
                        </button>
                    </div>
                </div>
            </div>`;
            lucide.createIcons();
        }

        function renderAdmin(c) {
            if (!user || user.email !== ADMIN_EMAIL) {
                if (user && !user.isAnonymous) {
                     c.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center text-center px-4"><div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-6"><i data-lucide="shield-alert" size="40"></i></div><h1 class="text-2xl font-bold text-stone-900 mb-2">غير مصرح بالدخول</h1><p class="text-stone-600 mb-8">هذه الصفحة مخصصة للمسؤولين فقط.</p><button onclick="setView('home')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold">العودة للرئيسية</button></div>`;
                     return;
                }
                setView('login');
                return;
            }
            
            const isEdit = !!currentEditProduct;
            const p = currentEditProduct || {};
            const extraImages = p.images ? p.images.slice(1).join('\n') : '';
            const variantsString = p.variants ? p.variants.map(v => `${v.color}: ${v.image}`).join('\n') : '';
            // Helper to format timestamp to datetime-local string (YYYY-MM-DDTHH:MM)
            const expiryDateStr = p.discountExpiry 
                ? new Date(p.discountExpiry - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) 
                : '';

            const features = p.features ? p.features.join('\n') : '';
            const specsString = p.specifications ? p.specifications.map(s => `${s.label}: ${s.value}`).join('\n') : '';
            const defaultServices = [
                "banknote: الدفع نقداً عند الاستلام",
                "truck: توصيل مجاني",
                "rotate-ccw: 15 يوم للإرجاع",
                "shield-check: تسوق آمن",
                "badge-check: جودة مضمونة"
            ].join('\n');
            const servicesString = p.services ? p.services.map(s => `${s.icon}: ${s.text}`).join('\n') : defaultServices;

            const pendingReviews = ALL_REVIEWS.filter(r => r.status === 'pending');
            
            // Category Edit Variables
            const editCatObj = currentEditCategoryName ? CATEGORIES.find(c => c.name === currentEditCategoryName) : null;
            const catNameVal = editCatObj ? editCatObj.name : '';
            const catImgVal = editCatObj ? editCatObj.image : '';

            // Helper for active tab style
            const getTabClass = (tabName) => {
                return currentAdminTab === tabName 
                    ? "bg-stone-900 text-white shadow-md" 
                    : "bg-white text-stone-600 hover:bg-stone-100";
            };

            c.innerHTML = `
            <div class="pt-4 pb-20 container mx-auto px-4 min-h-screen bg-white/50">
                <div class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto">
                    
                    <!-- Sidebar Navigation -->
                    <aside class="w-full lg:w-64 flex-shrink-0 space-y-2">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-200 mb-4">
                            <h2 class="font-bold text-stone-900 flex items-center gap-2 mb-1"><i data-lucide="layout-dashboard" size="18"></i> لوحة التحكم</h2>
                            <p class="text-xs text-stone-600">أهلاً بك، المدير</p>
                        </div>

                        <button onclick="setAdminView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('dashboard')}">
                            <i data-lucide="activity" size="18"></i> المراجعات والملخص
                        </button>
                        
                        <button onclick="setAdminView('orders')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('orders')}">
                            <i data-lucide="shopping-bag" size="18"></i> طلبات العملاء
                            ${ALL_ORDERS.filter(o => !o.isArchived).length > 0 ? `<span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full mr-auto">${ALL_ORDERS.filter(o => !o.isArchived).length}</span>` : ''}
                        </button>

                        <button onclick="currentEditProduct=null; setAdminView('products')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('products')}">
                            <i data-lucide="package-plus" size="18"></i> إدارة المنتجات
                        </button>
                        
                        <button onclick="currentEditCategoryName=null; setAdminView('categories')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('categories')}">
                            <i data-lucide="folder-plus" size="18"></i> إدارة الأقسام
                        </button>
                        
                        <button onclick="setAdminView('settings')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('settings')}">
                            <i data-lucide="settings" size="18"></i> إعدادات الواجهة
                        </button>

                         <div class="pt-4 mt-4 border-t border-stone-200">
                             <button onclick="setView('home')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm text-stone-600 hover:bg-red-50 hover:text-red-600 transition-colors">
                                <i data-lucide="log-out" size="18"></i> خروج من اللوحة
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="flex-1 min-w-0">
                        
                        <!-- 1. DASHBOARD TAB -->
                        ${currentAdminTab === 'dashboard' ? `
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-600 text-xs font-bold uppercase mb-2">إجمالي المنتجات</div>
                                        <div class="text-3xl font-bold text-stone-900">${PRODUCTS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-600 text-xs font-bold uppercase mb-2">إجمالي الطلبات</div>
                                        <div class="text-3xl font-bold text-stone-900">${ALL_ORDERS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-600 text-xs font-bold uppercase mb-2">المراجعات المعلقة</div>
                                        <div class="text-3xl font-bold ${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-900'}">${pendingReviews.length}</div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                    <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                        <i data-lucide="message-square-warning" class="${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-600'}"></i> 
                                        التعليقات والمراجعات
                                    </h3>
                                    ${pendingReviews.length === 0 ? `<div class="text-center py-12 bg-white rounded-2xl border border-dashed border-stone-200"><p class="text-stone-600 font-medium">لا توجد تعليقات معلقة حالياً</p></div>` : 
                                    `<div class="space-y-4">${pendingReviews.map(r => {
                                        const prod = PRODUCTS.find(p => p.id === r.productId);
                                        return `<div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 flex flex-col md:flex-row gap-6 justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-3 mb-2"><span class="font-bold text-stone-900 text-lg">${r.userName}</span><div class="flex text-yellow-400 text-xs">${Array(r.rating).fill('<i data-lucide="star" class="w-3 h-3 fill-current"></i>').join('')}</div></div>
                                                <p class="text-stone-600 text-xs mb-2">عن منتج: <span class="font-bold text-stone-800">${prod ? prod.name : 'منتج محذوف'}</span></p>
                                                <p class="text-stone-700 font-medium bg-white p-3 rounded-xl border border-orange-100">"${r.comment}"</p>
                                            </div>
                                            <div class="flex flex-col gap-3 w-full md:w-auto min-w-[200px]">
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded-xl border border-orange-200 hover:border-orange-400 transition-colors">
                                                    <input type="checkbox" id="verify-check-${r.id}" class="w-4 h-4 accent-green-600 rounded cursor-pointer">
                                                    <span class="text-xs font-bold text-stone-700 select-none">شراء تم التحقق منه</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <button onclick="handleReviewAction('${r.id}', 'approve')" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 shadow-sm">موافقة</button>
                                                    <button onclick="handleReviewAction('${r.id}', 'reject')" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-red-700 shadow-sm">رفض</button>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}</div>`}
                                </div>
                            </div>
                        ` : ''}

                        <!-- 2. ORDERS TAB (Integrated Here) -->
                        ${currentAdminTab === 'orders' ? `
                            <div class="space-y-6">
                                
                                <!-- 📊 1. New Stats Dashboard (إحصائيات سريعة) -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex flex-col justify-between">
                                        <div class="text-stone-600 text-[10px] font-bold uppercase tracking-wider mb-2">طلبات اليوم</div>
                                        <div class="flex justify-between items-end">
                                            <span class="text-2xl font-bold text-stone-900">${ALL_ORDERS.filter(o => {
                                                if(!o.createdAt) return false;
                                                const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                                                const now = new Date();
                                                return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                                            }).length}</span>
                                            <div class="p-1.5 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="calendar" size="16"></i></div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex flex-col justify-between">
                                        <div class="text-stone-600 text-[10px] font-bold uppercase tracking-wider mb-2">بانتظار الدفع</div>
                                        <div class="flex justify-between items-end">
                                            <span class="text-2xl font-bold text-orange-600">${ALL_ORDERS.filter(o => o.status === 'pending_payment' && !o.isArchived).length}</span>
                                            <div class="p-1.5 bg-orange-50 text-orange-600 rounded-lg"><i data-lucide="clock" size="16"></i></div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex flex-col justify-between">
                                        <div class="text-stone-600 text-[10px] font-bold uppercase tracking-wider mb-2">مراجعة الدفع</div>
                                        <div class="flex justify-between items-end">
                                            <span class="text-2xl font-bold text-purple-600">${ALL_ORDERS.filter(o => o.status === 'payment_review' && !o.isArchived).length}</span>
                                            <div class="p-1.5 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="file-search" size="16"></i></div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex flex-col justify-between">
                                        <div class="text-stone-600 text-[10px] font-bold uppercase tracking-wider mb-2">طلبات جديدة</div>
                                        <div class="flex justify-between items-end">
                                            <span class="text-2xl font-bold text-green-600">${ALL_ORDERS.filter(o => o.status === 'new' && !o.isArchived).length}</span>
                                            <div class="p-1.5 bg-green-50 text-green-600 rounded-lg"><i data-lucide="bell" size="16"></i></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-4 bg-white p-5 rounded-3xl shadow-sm border border-stone-100">
                                    <div class="flex flex-wrap items-center justify-between gap-4">
                                        <div>
                                            <h2 class="font-bold text-2xl text-stone-900 flex items-center gap-2">
                                                إدارة الطلبات
                                            </h2>
                                            <p class="text-xs text-stone-600 mt-1">إدارة ومتابعة طلبات العملاء بكفاءة</p>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div class="flex items-center gap-2">
                                            <div class="relative group/export">
                                                <button class="flex items-center gap-2 bg-white text-stone-600 px-4 py-2.5 rounded-xl font-bold hover:bg-stone-50 transition-colors border border-stone-200 shadow-sm text-xs">
                                                    <i data-lucide="download" size="14"></i> تصدير
                                                </button>
                                                <div class="absolute top-full left-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-stone-100 overflow-hidden hidden group-hover/export:block z-20">
                                                    <button onclick="exportOrdersToCSV('today')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-xs font-bold text-stone-700">طلبات اليوم</button>
                                                    <button onclick="exportOrdersToCSV('all')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-xs font-bold text-stone-700">الكل</button>
                                                </div>
                                            </div>

                                            <div class="flex p-1 bg-stone-100 rounded-xl">
                                                <button onclick="setOrderTab('active')" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${currentOrderTab === 'active' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-600 hover:text-stone-700'}">الجارية</button>
                                                <button onclick="setOrderTab('archived')" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${currentOrderTab === 'archived' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-600 hover:text-stone-700'}">الأرشيف</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Search -->
                                    <div class="relative w-full group">
                                        <label for="admin-order-search" class="sr-only">بحث في الطلبات</label>
                                        <input id="admin-order-search" type="text" oninput="filterOrdersList(this.value)" placeholder="🔍 ابحث برقم الطلب، اسم العميل، أو رقم الهاتف..." class="w-full border border-stone-200 bg-stone-50 p-3.5 pl-10 rounded-2xl text-sm focus:ring-2 focus:ring-stone-900 focus:bg-white outline-none transition-all placeholder:text-stone-600 font-medium">
                                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-600 group-focus-within:text-stone-900 transition-colors" size="18"></i>
                                    </div>

                                    <!-- 🛁 2. Modern Filter Tabs (Requested Filters) -->
                                    <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide border-t border-stone-100 pt-4">
                                        <!-- الكل -->
                                        <button onclick="setAdminOrderFilter('all')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${adminOrderFilter === 'all' ? 'bg-stone-900 text-white border-stone-900 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:border-stone-400'}">
                                            الكل
                                        </button>
                                        
                                        <!-- الطلبات المؤكدة (Confirmed) -->
                                        <button onclick="setAdminOrderFilter('confirmed')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${adminOrderFilter === 'confirmed' ? 'bg-green-600 text-white border-green-600 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:border-green-300 hover:bg-green-50'}">
                                            <span class="w-2 h-2 rounded-full bg-green-400 ${adminOrderFilter === 'confirmed' ? 'bg-white' : ''}"></span>
                                            المؤكدة
                                            <span class="bg-green-100 text-green-700 px-1.5 rounded-md text-[10px] min-w-[18px] text-center">${ALL_ORDERS.filter(o => ['confirmed', 'processing', 'shipped', 'delivered'].includes(o.status) && !o.isArchived).length}</span>
                                        </button>

                                        <!-- الطلبات المعلقة/الجديدة (Pending/New) -->
                                        <button onclick="setAdminOrderFilter('new')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${adminOrderFilter === 'new' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:border-blue-300 hover:bg-blue-50'}">
                                            <span class="w-2 h-2 rounded-full bg-blue-400 ${adminOrderFilter === 'new' ? 'bg-white' : ''}"></span>
                                            الجديدة (المعلقة)
                                            <span class="bg-blue-100 text-blue-700 px-1.5 rounded-md text-[10px] min-w-[18px] text-center">${ALL_ORDERS.filter(o => o.status === 'new' && !o.isArchived).length}</span>
                                        </button>

                                        <!-- لم يتم الدفع (Unpaid) -->
                                        <button onclick="setAdminOrderFilter('unpaid')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${adminOrderFilter === 'unpaid' ? 'bg-orange-500 text-white border-orange-500 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:border-orange-300 hover:bg-orange-50'}">
                                            <i data-lucide="alert-circle" size="12"></i>
                                            لم يتم الدفع
                                            <span class="bg-orange-100 text-orange-700 px-1.5 rounded-md text-[10px] min-w-[18px] text-center">${ALL_ORDERS.filter(o => o.status === 'pending_payment' && !o.isArchived).length}</span>
                                        </button>

                                        <!-- جاري المراجعة (Review) -->
                                        <button onclick="setAdminOrderFilter('payment_review')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all flex items-center gap-2 ${adminOrderFilter === 'payment_review' ? 'bg-purple-600 text-white border-purple-600 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:border-purple-300 hover:bg-purple-50'}">
                                            مراجعة الدفع
                                            <span class="bg-purple-100 text-purple-700 px-1.5 rounded-md text-[10px] min-w-[18px] text-center">${ALL_ORDERS.filter(o => o.status === 'payment_review' && !o.isArchived).length}</span>
                                        </button>
                                    </div>
                                </div>

                                ${(() => {
                                    let displayOrders = currentOrderTab === 'active' ? ALL_ORDERS.filter(o => !o.isArchived) : ALL_ORDERS.filter(o => o.isArchived);
                                    
                                    // 🛠️ 3. Apply New Filter Logic
                                    if (adminOrderFilter === 'confirmed') {
                                        // المؤكدة تشمل: مؤكد، جاري التجهيز، تم الشحن، تم التوصيل
                                        displayOrders = displayOrders.filter(o => ['confirmed', 'processing', 'shipped', 'delivered'].includes(o.status));
                                    } else if (adminOrderFilter === 'new') {
                                        // الجديدة/المعلقة
                                        displayOrders = displayOrders.filter(o => o.status === 'new');
                                    } else if (adminOrderFilter === 'unpaid') {
                                        // لم يتم الدفع
                                        displayOrders = displayOrders.filter(o => o.status === 'pending_payment');
                                    } else if (adminOrderFilter === 'payment_review') {
                                        // مراجعة الدفع
                                        displayOrders = displayOrders.filter(o => o.status === 'payment_review');
                                    } else if (adminOrderFilter === 'vodafone') {
                                        // فلتر قديم (يمكن إبقاؤه أو دمجه)
                                        displayOrders = displayOrders.filter(o => o.paymentMethod === 'vodafone_cash');
                                    } else if (adminOrderFilter === 'today') {
                                        const today = new Date();
                                        displayOrders = displayOrders.filter(o => {
                                            if(!o.createdAt) return false;
                                            const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                                            return d.getDate() === today.getDate() && 
                                                   d.getMonth() === today.getMonth() && 
                                                   d.getFullYear() === today.getFullYear();
                                        });
                                    }

                                    if (displayOrders.length === 0) return `
                                        <div class="bg-white p-12 rounded-3xl text-center shadow-sm border border-stone-100 flex flex-col items-center animate-in fade-in zoom-in duration-300">
                                            <div class="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mb-4 text-stone-600">
                                                <i data-lucide="filter" size="32"></i>
                                            </div>
                                            <h3 class="font-bold text-lg text-stone-900 mb-1">لا توجد طلبات في هذا التصنيف</h3>
                                            <p class="text-stone-600 text-xs mb-4">حاول تغيير الفلتر أو البحث عن طلب آخر.</p>
                                            <button onclick="setAdminOrderFilter('all')" class="bg-stone-900 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-stone-800 transition-colors shadow-sm">عرض كل الطلبات</button>
                                        </div>
                                    `;
                                    
                                    // Status options for dropdown
                                    const statuses = [
                                        { val: 'new', label: '🔵 طلب جديد' }, 
                                        { val: 'pending_payment', label: '🟠 بانتظار الدفع' }, 
                                        { val: 'payment_review', label: '🟣 مراجعة الدفع' }, 
                                        { val: 'confirmed', label: '✅ تم التأكيد' }, 
                                        { val: 'processing', label: '📦 جاري التجهيز' },
                                        { val: 'shipped', label: '🚚 تم الشحن' }, 
                                        { val: 'delivered', label: '🏠 تم التوصيل' },
                                        { val: 'expired', label: '❌ منتهية الصلاحية' }
                                    ];

                                    // --- Confidence Score (Existing Logic) ---
                                    const calculateConfidence = (order) => {
                                        if (order.paymentMethod !== 'vodafone_cash') return null;
                                        let score = 0; let checks = [];
                                        if (order.paymentDetails?.screenshotBase64) { score += 40; checks.push("📸 سكرين متوفر"); } else { checks.push("⚠️ بلا سكرين"); }
                                        if (order.paymentDetails?.senderPhone && order.customer?.phone) {
                                            const cleanSender = order.paymentDetails.senderPhone.replace(/\D/g, '').slice(-9);
                                            const cleanCust = order.customer.phone.replace(/\D/g, '').slice(-9);
                                            if (cleanSender === cleanCust) { score += 30; checks.push("📱 رقم مطابق"); } else { checks.push(`⚠️ رقم مختلف`); }
                                        }
                                        const prevOrders = ALL_ORDERS.filter(o => o.customer.phone === order.customer.phone && o.id !== order.id && ['confirmed', 'delivered'].includes(o.status)).length;
                                        if (prevOrders > 0) { score += 30; checks.push(`🔄 عميل سابق`); } else { checks.push("👤 جديد"); }
                                        
                                        let level = 'منخفض'; let color = 'bg-red-50 text-red-700 border-red-100';
                                        if (score >= 80) { level = 'عالي'; color = 'bg-green-50 text-green-700 border-green-100'; }
                                        else if (score >= 40) { level = 'متوسط'; color = 'bg-yellow-50 text-yellow-700 border-yellow-100'; }
                                        return { score, level, color, checks };
                                    };

                                    return displayOrders.map(order => {
                                        // Date Logic
                                        let date = "غير محدد";
                                        if (order.createdAt) {
                                            const d = order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                                            date = d.toLocaleString('ar-EG', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                                        }
                                        
                                        const trackingUrl = `${window.location.origin}${window.location.pathname}#/track-order`;
                                        const statusMsg = `تحديث بخصوص طلبك رقم (#${order.id}):\nحالة الطلب الآن: *${STATUS_ARABIC_MAP[order.status] || order.status}*\nتتبع: ${trackingUrl}`;
                                        const notifyLink = `https://wa.me/20${order.customer.phone.replace(/^0+/, '')}?text=${encodeURIComponent(statusMsg)}`;
                                        const confidence = calculateConfidence(order);

                                        // Payment Review Block (Shortened)
                                        let paymentReviewHTML = '';
                                        if (order.paymentMethod === 'vodafone_cash' && order.paymentDetails) {
                                            paymentReviewHTML = `
                                            <div class="col-span-1 lg:col-span-2 bg-purple-50/50 border border-purple-100 rounded-xl p-3 mt-2 text-xs">
                                                <div class="flex justify-between items-center mb-2">
                                                    <h4 class="font-bold text-purple-900 flex items-center gap-1"><i data-lucide="smartphone" size="12"></i> بيانات التحويل</h4>
                                                    ${confidence ? `<span class="${confidence.color} px-2 py-0.5 rounded text-[10px] font-bold border">ثقة: ${confidence.level}</span>` : ''}
                                                </div>
                                                <div class="flex gap-4 flex-wrap text-stone-600">
                                                    <span><b>المحول:</b> ${order.paymentDetails.senderName}</span>
                                                    <span><b>المبلغ:</b> ${order.paymentDetails.amountPaid} ج.م</span>
                                                    <span><b>المحفظة:</b> ${order.paymentDetails.senderPhone}</span>
                                                </div>
                                                ${order.paymentDetails.screenshotBase64 ? `<button onclick="var w=window.open('');w.document.write('<img src=\\'${order.paymentDetails.screenshotBase64}\\' style=\\'width:100%\\'>');" class="mt-2 text-purple-600 underline font-bold flex items-center gap-1"><i data-lucide="image" size="12"></i> عرض الإيصال</button>` : ''}
                                                
                                                ${order.status === 'payment_review' ? `
                                                <div class="flex gap-2 mt-3 pt-2 border-t border-purple-100">
                                                    <button onclick="handlePaymentDecision('${order.id}', 'approve')" class="flex-1 bg-purple-600 text-white py-1.5 rounded-lg font-bold hover:bg-purple-700 transition-colors">قبول وتأكيد</button>
                                                    <button onclick="handlePaymentDecision('${order.id}', 'reject')" class="flex-1 bg-white border border-red-200 text-red-600 py-1.5 rounded-lg font-bold hover:bg-red-50 transition-colors">رفض</button>
                                                </div>` : ''}
                                            </div>`;
                                        }

                                        // Notes HTML
                                        const notesHTML = (order.internalNotes || []).map(n => `
                                            <div class="bg-yellow-50 border-r-2 border-yellow-400 p-1.5 text-[10px] mb-1 text-stone-600">
                                                ${n.text}
                                            </div>
                                        `).join('');

                                        return `
                                        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden group mb-4 order-card-item transition-all hover:border-stone-300" data-search="${order.id} ${order.customer.name} ${order.customer.phone}">
                                            
                                            <!-- Card Header -->
                                            <div class="bg-stone-50/50 p-3 border-b border-stone-100 flex flex-wrap justify-between items-center gap-2">
                                                <div class="flex items-center gap-3">
                                                    <!-- UPDATED: Show Full Order ID -->
                                                    <div class="font-mono font-bold text-stone-700 text-xs bg-white px-2 py-1 rounded border border-stone-200 cursor-pointer hover:bg-stone-900 hover:text-white transition-colors select-all" onclick="navigator.clipboard.writeText('${order.id}'); showToast('تم النسخ')" title="نسخ المعرف">#${order.id}</div>
                                                    <span class="text-[10px] text-stone-600 font-medium flex items-center gap-1"><i data-lucide="clock" size="10"></i> ${date}</span>
                                                </div>
                                                
                                                <div class="flex items-center gap-2">
                                                    <!-- Status Select -->
                                                    <div class="relative">
                                                         <select onchange="handleOrderStatusChange('${order.id}', this.value)" class="bg-white border ${order.status==='confirmed'?'border-green-200 text-green-700':(order.status==='new'?'border-blue-200 text-blue-700':'border-stone-200 text-stone-700')} text-[10px] font-bold rounded-lg py-1 px-2 pr-6 appearance-none focus:outline-none cursor-pointer shadow-sm w-fit" ${currentOrderTab === 'archived' ? 'disabled' : ''}>
                                                            ${statuses.map(s => `<option value="${s.val}" ${order.status === s.val ? 'selected' : ''}>${s.label}</option>`).join('')}
                                                        </select>
                                                        <i data-lucide="chevron-down" class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-600 pointer-events-none" size="12"></i>
                                                    </div>
                                                    <a href="${notifyLink}" target="_blank" class="w-7 h-7 rounded-lg bg-white border border-stone-200 text-stone-600 hover:text-green-600 hover:border-green-200 flex items-center justify-center transition-colors" title="واتساب"><i data-lucide="message-circle" size="14"></i></a>
                                                </div>
                                            </div>

                                            <!-- Card Body -->
                                            <div class="p-4 grid lg:grid-cols-2 gap-4">
                                                <!-- Customer Info -->
                                                <div>
                                                    <div class="flex items-start gap-3 mb-3">
                                                        <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 font-bold text-xs shrink-0">${order.customer.name.charAt(0)}</div>
                                                        <div>
                                                            <p class="font-bold text-stone-900 text-sm">${order.customer.name}</p>
                                                            <div class="flex items-center gap-2 mt-0.5">
                                                                <a href="tel:${order.customer.phone}" class="text-xs text-stone-600 font-mono hover:text-blue-600 underline decoration-dotted">${order.customer.phone}</a>
                                                                <button onclick="navigator.clipboard.writeText('${order.customer.phone}'); showToast('تم نسخ الرقم')" class="text-stone-600 hover:text-stone-600"><i data-lucide="copy" size="10"></i></button>
                                                            </div>
                                                            <p class="text-[10px] text-stone-600 mt-1 leading-snug max-w-[250px]"><i data-lucide="map-pin" size="10" class="inline text-orange-500"></i> ${order.customer.address}</p>
                                                        </div>
                                                    </div>
                                                    
                                                    ${order.modificationRequest && order.modificationRequest.status === 'pending' ? `
                                                    <div class="bg-orange-50 p-2 rounded-lg border border-orange-200 text-xs text-orange-800 mb-2">
                                                        <b>طلب تعديل:</b> "${order.modificationRequest.message}"
                                                        <div class="flex gap-2 mt-2">
                                                            <button onclick="handleModDecision('${order.id}', 'approved')" class="bg-white border border-orange-200 px-2 py-0.5 rounded hover:bg-orange-100">موافقة</button>
                                                            <button onclick="handleModDecision('${order.id}', 'rejected')" class="bg-white border border-orange-200 px-2 py-0.5 rounded hover:bg-orange-100">رفض</button>
                                                        </div>
                                                    </div>` : ''}

                                                    ${paymentReviewHTML}
                                                </div>

                                                <!-- Order Details -->
                                                <div class="border-t lg:border-t-0 lg:border-r border-stone-100 lg:pr-4 pt-3 lg:pt-0">
                                                    <div class="space-y-2 mb-3 max-h-24 overflow-y-auto custom-scrollbar pr-1">
                                                        ${order.items.map(item => `
                                                            <div class="flex justify-between items-center text-xs">
                                                                <div class="flex items-center gap-2 overflow-hidden">
                                                                    <span class="bg-stone-100 text-stone-600 px-1.5 py-0.5 rounded font-bold text-[10px] shrink-0">${item.quantity}x</span>
                                                                    <span class="truncate text-stone-700">${item.name}</span>
                                                                </div>
                                                                <span class="font-bold text-stone-900 dir-ltr text-[10px] shrink-0">$${item.price * item.quantity}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    
                                                    <div class="flex justify-between items-center border-t border-stone-100 pt-2 mb-2">
                                                        <span class="text-xs font-bold text-stone-600">الإجمالي</span>
                                                        <span class="text-sm font-black text-stone-900 font-serif">$${order.totalAmount}</span>
                                                    </div>
                                                    
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-[10px] text-stone-600">الدفع</span>
                                                        ${order.paymentMethod === 'vodafone_cash' ? 
                                                            `<span class="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded border border-red-100">فودافون كاش</span>` : 
                                                            `<span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">استلام</span>`
                                                        }
                                                    </div>

                                                    <!-- Internal Notes Input -->
                                                    <div class="mt-3 bg-stone-50 p-2 rounded-lg border border-stone-100">
                                                        <div class="max-h-16 overflow-y-auto mb-2">${notesHTML}</div>
                                                        <div class="flex gap-1">
                                                            <label for="note-input-${order.id}" class="sr-only">ملاحظة داخلية</label>
                                                            <input id="note-input-${order.id}" class="flex-1 bg-white border border-stone-200 rounded px-2 py-1 text-[10px] outline-none" placeholder="ملاحظة خاصة...">
                                                            <button onclick="addInternalNote('${order.id}')" class="bg-stone-200 hover:bg-stone-300 text-stone-600 px-2 py-1 rounded text-[10px] transition-colors" aria-label="إضافة ملاحظة"><i data-lucide="plus" size="10"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Footer Actions -->
                                            <div class="bg-stone-50 border-t border-stone-100 p-2 flex justify-end gap-2">
                                                 <button onclick="handleOrderAction('${order.id}', 'delete')" class="p-1.5 text-stone-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="حذف نهائي"><i data-lucide="trash-2" size="14"></i></button>
                                                 <button onclick="openEditOrderModal('${order.id}')" class="p-1.5 text-stone-600 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="تعديل"><i data-lucide="pen-line" size="14"></i></button>
                                                 ${currentOrderTab === 'active' ? 
                                                    `<button onclick="handleOrderAction('${order.id}', 'archive')" class="text-[10px] font-bold text-stone-600 hover:text-stone-800 bg-white border border-stone-200 px-3 py-1 rounded hover:bg-stone-100 transition-colors">أرشفة</button>` : 
                                                    `<button onclick="handleOrderAction('${order.id}', 'restore')" class="text-[10px] font-bold text-blue-600 bg-blue-50 border border-blue-100 px-3 py-1 rounded hover:bg-blue-100 transition-colors">استعادة</button>`
                                                 }
                                            </div>
                                        </div>`;
                                    }).join('');
                                })()}
                            </div>
                        ` : ''}

                        <!-- 3. PRODUCTS TAB -->
                        ${currentAdminTab === 'products' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${isEdit ? 'pen-line' : 'package-plus'}" class="text-blue-600"></i>
                                        ${isEdit ? `<span class="text-blue-600">تعديل المنتج: ${p.name}</span>` : 'إدارة المنتجات'}
                                    </h2>
                                    ${isEdit ? `<button onclick="cancelEdit()" class="text-stone-600 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-white rounded-lg transition-colors">إلغاء وعودة للإضافة</button>` : ''}
                                </div>

                                <!-- Add/Edit Form -->
                                <form onsubmit="handleSaveProduct(event)" class="space-y-8 mb-12">
                                    <div class="grid md:grid-cols-2 gap-8">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label for="prod-name-input" class="text-xs font-bold text-stone-600 uppercase">اسم المنتج <span class="text-red-600">*</span></label>
                                                <input id="prod-name-input" name="prodName" value="${p.name || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none transition-all bg-white focus:bg-white placeholder:text-stone-600" placeholder="مثال: لوح بديل خشب">
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="space-y-2">
                                                    <label for="prod-price-input" class="text-xs font-bold text-stone-600 uppercase">السعر <span class="text-red-600">*</span></label>
                                                    <div class="relative">
                                                        <input id="prod-price-input" name="prodPrice" type="number" step="0.01" value="${p.price || ''}" required class="w-full border border-stone-200 p-3.5 pl-8 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="0.00">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">$</span>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <label for="prod-discount-input" class="text-xs font-bold text-stone-600 uppercase">الخصم %</label>
                                                    <input id="prod-discount-input" name="prodDiscount" type="number" min="0" max="100" value="${p.discount || 0}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="0">
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 gap-4">
                                                <!-- Expiry Date Field -->
                                                <div class="space-y-2 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                    <label for="prod-expiry-input" class="text-xs font-bold text-orange-800 uppercase flex items-center gap-1"><i data-lucide="timer" size="14"></i> تاريخ انتهاء الخصم</label>
                                                    <input id="prod-expiry-input" name="prodExpiry" type="datetime-local" value="${expiryDateStr}" class="w-full border border-orange-200 p-2 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none bg-white text-stone-700 dir-ltr">
                                                    <p class="text-[10px] text-orange-600">اتركه فارغاً إذا كان الخصم دائم</p>
                                                </div>

                                                <!-- NEW: Featured Product Checkbox -->
                                                <div class="flex items-center gap-3 bg-yellow-50 p-4 rounded-xl border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition-colors" onclick="document.getElementById('prodFeatured').click()">
                                                    <input type="checkbox" name="prodFeatured" id="prodFeatured" class="w-5 h-5 accent-yellow-500 rounded cursor-pointer" onclick="event.stopPropagation()" ${p.isFeatured ? 'checked' : ''}>
                                                    <label for="prodFeatured" class="text-sm font-bold text-yellow-800 cursor-pointer select-none flex items-center gap-2">
                                                        <i data-lucide="star" size="16" class="fill-yellow-500 text-yellow-600"></i> منتج مميز (يظهر في قسم خاص)
                                                    </label>
                                                </div>

                                                <!-- NEW: In Stock Checkbox -->
                                                <div class="flex items-center gap-3 bg-green-50 p-4 rounded-xl border border-green-100 cursor-pointer hover:bg-green-100 transition-colors" onclick="document.getElementById('prodInStock').click()">
                                                    <input type="checkbox" name="prodInStock" id="prodInStock" class="w-5 h-5 accent-green-500 rounded cursor-pointer" onclick="event.stopPropagation()" ${p.inStock !== false ? 'checked' : ''}>
                                                    <label for="prodInStock" class="text-sm font-bold text-green-800 cursor-pointer select-none flex items-center gap-2">
                                                        <i data-lucide="package-check" size="16" class="text-green-600"></i> متوفر في المخزون (In Stock)
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="space-y-2">
                                                <label for="prod-cat-select" class="text-xs font-bold text-stone-600 uppercase">القسم <span class="text-red-600">*</span></label>
                                                <select id="prod-cat-select" name="prodCat" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white cursor-pointer">
                                                    ${CATEGORIES.map(c => `<option ${p.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="space-y-2">
                                                 <label for="prod-brand-input" class="text-xs font-bold text-stone-600 uppercase">العلامة التجارية</label>
                                                 <input id="prod-brand-input" name="prodBrand" value="${p.brand || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="اسم البراند (اختياري)">
                                            </div>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label for="prod-img-input" class="text-xs font-bold text-stone-600 uppercase">رابط الصورة الرئيسية <span class="text-red-600">*</span></label>
                                                <input id="prod-img-input" name="prodImg" value="${p.image || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white dir-ltr text-left" placeholder="${HERO_SETTINGS.imageBaseUrl ? 'أدخل اسم الملف فقط (مثل: image_01)' : 'https://example.com/image.jpg'}">
                                                ${HERO_SETTINGS.imageBaseUrl ? `<p class="text-[10px] text-blue-600 dir-rtl">سيتم الدمج تلقائياً مع: ${HERO_SETTINGS.imageBaseUrl} وامتداد ${HERO_SETTINGS.imageDefaultExt || '.webp'}</p>` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                <label for="prod-images-textarea" class="text-xs font-bold text-stone-600 uppercase">صور إضافية (رابط في كل سطر)</label>
                                                <textarea id="prod-images-textarea" name="prodImages" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="https://...&#10;https://...">${extraImages}</textarea>
                                            </div>
                                            <!-- NEW: Variants Field -->
                                            <div class="space-y-2">
                                                <label for="prod-variants-textarea" class="text-xs font-bold text-stone-600 uppercase flex items-center gap-1"><i data-lucide="palette" size="14"></i> ألوان المنتج (اسم اللون : رابط الصورة)</label>
                                                <textarea id="prod-variants-textarea" name="prodVariants" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="Red: https://...&#10;Blue: https://...">${variantsString}</textarea>
                                                <p class="text-[10px] text-stone-600">أدخل كل لون في سطر جديد. سيتم عرض هذه الألوان كخيارات للعميل.</p>
                                            </div>
                                             <div class="space-y-2">
                                                <label for="prod-material-input" class="text-xs font-bold text-stone-600 uppercase">المادة (Material)</label>
                                                <input id="prod-material-input" name="prodMaterial" value="${p.material || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="مثال: خشب زان">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-8 pt-4 border-t border-stone-100">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label for="prod-desc-textarea" class="text-xs font-bold text-stone-600 uppercase">وصف المنتج</label>
                                                <textarea id="prod-desc-textarea" name="prodDesc" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="وصف تفصيلي للمنتج...">${p.description || ''}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label for="prod-features-textarea" class="text-xs font-bold text-stone-600 uppercase">المميزات (نقطة في كل سطر)</label>
                                                <textarea id="prod-features-textarea" name="prodFeatures" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="- ميزة 1&#10;- ميزة 2">${features}</textarea>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label for="prod-specs-textarea" class="text-xs font-bold text-stone-600 uppercase">المواصفات (الاسم: القيمة)</label>
                                                <textarea id="prod-specs-textarea" name="prodSpecs" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="الطول: 120 سم&#10;الوزن: 5 كجم">${specsString}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label for="prod-services-textarea" class="text-xs font-bold text-stone-600 uppercase">الخدمات (أيقونة: نص)</label>
                                                <textarea id="prod-services-textarea" name="prodServices" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white dir-ltr text-right" placeholder="truck: توصيل مجاني">${servicesString}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="w-full ${isEdit ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-4 rounded-xl font-bold transition-all text-lg shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2">
                                        <i data-lucide="${isEdit ? 'save' : 'plus-circle'}"></i>
                                        ${isEdit ? 'حفظ التعديلات' : 'إضافة المنتج للمتجر'}
                                    </button>
                                </form>

                                <!-- 🆕 SECTION: BULK ACTIONS TOOLBAR -->
                                <div class="bg-stone-50 p-6 rounded-2xl border border-stone-200 mb-8 shadow-inner">
                                    <h3 class="font-bold text-stone-900 mb-4 flex items-center gap-2 text-sm">
                                        <i data-lucide="percent" class="text-stone-600"></i>
                                        العروض والخصومات الجماعية (Bulk Actions)
                                    </h3>
                                    <div class="flex flex-col md:flex-row items-end gap-4">
                                        <div class="w-full md:w-1/4">
                                            <label class="text-[10px] font-bold text-stone-600 mb-1 block uppercase">نسبة الخصم %</label>
                                            <input type="number" id="bulk-discount-input" min="0" max="100" class="w-full p-2.5 rounded-xl border border-stone-300 focus:border-stone-900 outline-none bg-white" placeholder="مثال: 20">
                                        </div>
                                        <div class="w-full md:w-1/3">
                                            <label class="text-[10px] font-bold text-stone-600 mb-1 block uppercase">تاريخ الانتهاء</label>
                                            <input type="datetime-local" id="bulk-date-input" class="w-full p-2.5 rounded-xl border border-stone-300 focus:border-stone-900 outline-none bg-white dir-ltr text-stone-600 text-sm">
                                        </div>
                                        <button id="bulk-apply-btn" onclick="applyBulkDiscount()" class="w-full md:w-auto bg-stone-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-stone-900 transition-colors shadow-sm flex items-center justify-center gap-2 text-sm h-[42px] mt-2 md:mt-0">
                                            <i data-lucide="check-circle" size="16"></i> تطبيق على المحددة
                                        </button>
                                    </div>
                                    <p class="text-[10px] text-stone-500 mt-2 font-medium flex items-center gap-1">
                                        <i data-lucide="info" size="10"></i>
                                        اختر المنتجات من الجدول بالأسفل ثم اضغط "تطبيق" لتحديث الخصومات دفعة واحدة.
                                    </p>
                                </div>

                                <!-- 🆕 SECTION: PRODUCTS TABLE -->
                                <div class="border-t border-stone-100 pt-8">
                                    <div class="flex justify-between items-end mb-4">
                                        <h3 class="font-bold text-xl text-stone-900">جدول المنتجات (${PRODUCTS.length})</h3>
                                    </div>
                                    
                                    <div class="overflow-x-auto rounded-2xl border border-stone-200 bg-white">
                                        <table class="w-full text-sm text-right whitespace-nowrap">
                                            <thead class="bg-stone-50 text-stone-600 font-bold border-b border-stone-200 text-xs uppercase tracking-wider">
                                                <tr>
                                                    <th class="p-4 w-10 text-center bg-stone-100/50">
                                                        <input type="checkbox" onchange="toggleSelectAllProducts(this)" class="w-4 h-4 rounded cursor-pointer accent-stone-900">
                                                    </th>
                                                    <th class="p-4 w-16 text-center">الصورة</th>
                                                    <th class="p-4">اسم المنتج</th>
                                                    <th class="p-4">القسم</th>
                                                    <th class="p-4">السعر</th>
                                                    <th class="p-4">الخصم</th>
                                                    <th class="p-4">المخزون</th>
                                                    <th class="p-4 text-center">إجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-stone-100">
                                                ${PRODUCTS.length === 0 ? 
                                                    `<tr><td colspan="8" class="p-8 text-center text-stone-500">لا توجد منتجات مضافة حتى الآن.</td></tr>` 
                                                    : PRODUCTS.map(prod => {
                                                        const isExpired = prod.discountExpiry && prod.discountExpiry < Date.now();
                                                        return `
                                                        <tr class="hover:bg-stone-50/50 transition-colors group">
                                                            <td class="p-4 text-center">
                                                                <input type="checkbox" value="${prod.id}" class="product-checkbox w-4 h-4 rounded cursor-pointer accent-stone-900 border-stone-300">
                                                            </td>
                                                            <td class="p-3 text-center">
                                                                <div class="w-10 h-10 rounded-lg bg-stone-100 border border-stone-200 overflow-hidden mx-auto">
                                                                    <img src="${prod.image}" class="w-full h-full object-cover" loading="lazy">
                                                                </div>
                                                            </td>
                                                            <td class="p-4 font-bold text-stone-800 max-w-[200px] truncate" title="${prod.name}">${prod.name}</td>
                                                            <td class="p-4 text-stone-600 text-xs">${prod.category}</td>
                                                            <td class="p-4 font-mono font-bold text-stone-900">$${prod.price}</td>
                                                            <td class="p-4">
                                                                ${prod.discount > 0 ? 
                                                                    `<span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-red-50 text-red-700 text-xs font-bold border border-red-100">
                                                                        ${prod.discount}% 
                                                                        ${isExpired ? '<span class="text-[8px] text-red-400">(منتهي)</span>' : ''}
                                                                     </span>` 
                                                                    : '<span class="text-stone-400 text-xs">-</span>'}
                                                            </td>
                                                            <td class="p-4">
                                                                ${prod.inStock !== false ? 
                                                                    `<span class="text-green-600 text-xs font-bold flex items-center gap-1"><i data-lucide="check" size="10"></i> متوفر</span>` : 
                                                                    `<span class="text-stone-400 text-xs font-bold flex items-center gap-1"><i data-lucide="x" size="10"></i> نفذ</span>`}
                                                            </td>
                                                            <td class="p-4 text-center">
                                                                <div class="flex items-center justify-center gap-2">
                                                                    <button onclick="handleEditProduct('${prod.id}')" class="p-1.5 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-100" title="تعديل">
                                                                        <i data-lucide="pen-line" size="14"></i>
                                                                    </button>
                                                                    <button onclick="handleDeleteProduct('${prod.id}')" class="p-1.5 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors border border-red-100" title="حذف">
                                                                        <i data-lucide="trash-2" size="14"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- 4. CATEGORIES TAB -->
                        ${currentAdminTab === 'categories' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${currentEditCategoryName ? 'pen-line' : 'folder-plus'}" class="text-blue-600"></i>
                                        ${currentEditCategoryName ? `تعديل قسم: <span class="text-blue-600">${currentEditCategoryName}</span>` : 'إدارة الأقسام'}
                                    </h2>
                                    ${currentEditCategoryName ? `<button onclick="cancelEditCategory()" class="text-stone-600 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-white rounded-lg transition-colors">إلغاء التعديل</button>` : ''}
                                </div>

                                <form onsubmit="handleAddCategory(event)" class="max-w-xl space-y-6">
                                    <div>
                                        <label for="cat-name-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">اسم القسم <span class="text-red-600">*</span></label>
                                        <input id="cat-name-input" name="catName" value="${catNameVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white" placeholder="مثال: ديكورات حائط">
                                    </div>
                                    
                                    <div>
                                        <label for="cat-img-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">صورة القسم (رابط) <span class="text-red-600">*</span></label>
                                        <input id="cat-img-input" name="catImg" value="${catImgVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-white focus:bg-white dir-ltr text-left" placeholder="https://...">
                                    </div>

                                    <button class="w-full ${currentEditCategoryName ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-3.5 rounded-xl font-bold transition-all shadow-md flex justify-center items-center gap-2">
                                        <i data-lucide="${currentEditCategoryName ? 'save' : 'plus'}"></i>
                                        ${currentEditCategoryName ? 'حفظ التغييرات' : 'إضافة القسم'}
                                    </button>
                                </form>

                                <div class="mt-12">
                                    <h3 class="font-bold text-lg text-stone-900 mb-4 border-b border-stone-100 pb-2">الأقسام الحالية</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${CATEGORIES.map(c => `
                                            <div class="flex items-center gap-4 bg-white p-3 rounded-xl border border-stone-200 group hover:border-stone-300 transition-colors">
                                                <div class="w-16 h-16 rounded-lg bg-white overflow-hidden border border-stone-100 shrink-0">
                                                    <img src="${c.image}" class="w-full h-full object-cover" alt="${c.name}">
                                                </div>
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-stone-900">${c.name}</h4>
                                                    <p class="text-xs text-stone-600">قسم نشط</p>
                                                </div>
                                                <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onclick="prepareEditCategory('${c.name}')" class="p-2 bg-white text-blue-600 border border-blue-100 hover:bg-blue-50 rounded-lg transition-colors shadow-sm"><i data-lucide="pen-line" size="16"></i></button>
                                                    <button onclick="handleDeleteCategory('${c.name}')" class="p-2 bg-white text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition-colors shadow-sm"><i data-lucide="trash-2" size="16"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- 5. SETTINGS TAB (RESTORED) -->
                        ${currentAdminTab === 'settings' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="layout-template" class="text-stone-900"></i>
                                        إعدادات الموقع والواجهة
                                    </h2>
                                </div>

                                <form onsubmit="handleSaveHeroSettings(event)" class="space-y-8 max-w-3xl">
                                    
                                    <!-- NEW: Image Configuration Settings -->
                                    <div class="space-y-4 p-6 bg-blue-50 rounded-2xl border border-blue-200">
                                        <h3 class="font-bold text-blue-800 flex items-center gap-2"><i data-lucide="image-plus"></i> تكوين روابط الصور (تلقائي)</h3>
                                        <div class="grid md:grid-cols-3 gap-6">
                                            <div class="md:col-span-2">
                                                <label for="img-base-url-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">رابط القاعدة (Base URL)</label>
                                                <input id="img-base-url-input" name="imgBaseUrl" value="${HERO_SETTINGS.imageBaseUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder="https://example.com/images/">
                                                <p class="text-[10px] text-stone-600 mt-1">المسار الثابت الذي ترفع عليه صور منتجاتك</p>
                                            </div>
                                            <div>
                                                <label for="img-ext-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">الامتداد الافتراضي</label>
                                                <input id="img-ext-input" name="imgExt" value="${HERO_SETTINGS.imageDefaultExt || '.webp'}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder=".webp">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logo Settings -->
                                    <div class="space-y-4 p-6 bg-white rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="image-plus"></i> هوية الموقع (الشعار)</h3>
                                        <div class="grid md:grid-cols-1 gap-6">
                                            <div class="grid md:grid-cols-2 gap-4">
                                                <div>
                                                    <label for="site-logo-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">رابط الشعار (Logo URL)</label>
                                                    <input id="site-logo-input" name="siteLogo" value="${HERO_SETTINGS.logoUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://...">
                                                </div>
                                                <!-- 🆕 New Input for Profile Picture -->
                                                <div>
                                                    <label for="profile-pic-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">صورة البروفايل (للهاتف)</label>
                                                    <input id="profile-pic-input" name="profilePic" value="${HERO_SETTINGS.profileUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://... (تظهر بجانب البحث)">
                                                </div>
                                            </div>
                                            
                                            <!-- UPDATED: Split Size Inputs -->
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label for="logo-size-desk-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">حجم الكمبيوتر (px)</label>
                                                    <div class="relative">
                                                        <input id="logo-size-desk-input" name="logoSizeDesk" type="number" value="${HERO_SETTINGS.logoSizeDesktop || HERO_SETTINGS.logoSize || '120'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="120">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="logo-size-mob-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">حجم الموبايل (px)</label>
                                                    <div class="relative">
                                                        <!-- تم تحديث القيمة الافتراضية في لوحة التحكم أيضاً -->
                                                        <input id="logo-size-mob-input" name="logoSizeMob" type="number" value="${HERO_SETTINGS.logoSizeMobile || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Header Banner Settings -->
                                    <div class="space-y-4 p-6 bg-orange-50 rounded-2xl border border-orange-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-orange-600 flex items-center gap-2"><i data-lucide="monitor"></i> بانر إعلاني (أسفل الهيدر)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input id="fb-show-checkbox" type="checkbox" name="fbShow" class="w-5 h-5 accent-orange-600 rounded" ${HERO_SETTINGS.showFooterBanner ? 'checked' : ''}>
                                                <label for="fb-show-checkbox" class="text-sm font-bold text-orange-800 cursor-pointer">تفعيل البانر</label>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-6">
                                            <!-- Desktop URLs -->
                                            <div>
                                                <label for="fb-url-textarea" class="text-xs font-bold text-stone-600 uppercase mb-2 block flex items-center gap-2"><i data-lucide="monitor" size="14"></i> صور الكمبيوتر (رابط في كل سطر)</label>
                                                <textarea id="fb-url-textarea" name="fbUrl" rows="3" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white custom-scrollbar" placeholder="https://desktop-image.jpg">${HERO_SETTINGS.footerBannerUrl || ''}</textarea>
                                            </div>

                                            <!-- Mobile URLs (NEW) -->
                                            <div>
                                                <label for="fb-url-mob-textarea" class="text-xs font-bold text-stone-600 uppercase mb-2 block flex items-center gap-2"><i data-lucide="smartphone" size="14"></i> صور الموبايل (رابط في كل سطر)</label>
                                                <textarea id="fb-url-mob-textarea" name="fbUrlMob" rows="3" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white custom-scrollbar" placeholder="https://mobile-image.jpg (اختياري)">${HERO_SETTINGS.footerBannerUrlMobile || ''}</textarea>
                                                <p class="text-[9px] text-stone-600 mt-1">إذا ترك فارغاً سيتم استخدام صور الكمبيوتر</p>
                                            </div>
                                            
                                            <!-- Desktop Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="monitor" size="14"></i> إعدادات الكمبيوتر</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label for="fb-height-desk-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input id="fb-height-desk-input" name="fbHeightDesk" type="number" value="${HERO_SETTINGS.fbHeightDesktop || HERO_SETTINGS.footerBannerHeight || '300'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label for="fb-width-desk-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">العرض (%)</label>
                                                        <input id="fb-width-desk-input" name="fbWidthDesk" type="number" value="${HERO_SETTINGS.fbWidthDesktop || HERO_SETTINGS.footerBannerWidth || '90'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label for="fb-radius-desk-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input id="fb-radius-desk-input" name="fbRadiusDesk" value="${HERO_SETTINGS.fbRadiusDesktop || HERO_SETTINGS.footerBannerRadius || '2rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Mobile Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="smartphone" size="14"></i> إعدادات الموبايل</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label for="fb-height-mob-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input id="fb-height-mob-input" name="fbHeightMob" type="number" value="${HERO_SETTINGS.fbHeightMobile || '150'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label for="fb-width-mob-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">العرض (%)</label>
                                                        <input id="fb-width-mob-input" name="fbWidthMob" type="number" value="${HERO_SETTINGS.fbWidthMobile || '95'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label for="fb-radius-mob-input" class="text-[10px] font-bold text-stone-600 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input id="fb-radius-mob-input" name="fbRadiusMob" value="${HERO_SETTINGS.fbRadiusMobile || '1rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- REMOVED: Category Banner Settings Block -->

                                    <!-- Best Seller Banner Settings -->
                                    <div class="space-y-4 p-6 bg-purple-50 rounded-2xl border border-purple-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-purple-600 flex items-center gap-2"><i data-lucide="trending-up"></i> بانر إعلاني (أسفل الأكثر مبيعاً)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input id="bs-ban-show-checkbox" type="checkbox" name="bsBanShow" class="w-5 h-5 accent-purple-600 rounded" ${HERO_SETTINGS.showBestSellerBanner ? 'checked' : ''}>
                                                <label for="bs-ban-show-checkbox" class="text-sm font-bold text-purple-800 cursor-pointer">تفعيل البانر</label>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label for="bs-ban-url-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input id="bs-ban-url-input" name="bsBanUrl" value="${HERO_SETTINGS.bestSellerBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label for="bs-ban-height-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input id="bs-ban-height-input" name="bsBanHeight" type="number" value="${HERO_SETTINGS.bestSellerBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="bs-ban-width-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input id="bs-ban-width-input" name="bsBanWidth" type="number" value="${HERO_SETTINGS.bestSellerBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- REMOVED: Featured Banner Settings (Top Banner) -->

                                    <!-- NEW: Payment Banner Settings (Inside Product Page) -->
                                    <div class="space-y-4 p-6 bg-emerald-50 rounded-2xl border border-emerald-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-emerald-700 flex items-center gap-2"><i data-lucide="credit-card"></i> بانر طرق الدفع (صفحة المنتج)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input id="pay-ban-show-checkbox" type="checkbox" name="payBanShow" class="w-5 h-5 accent-emerald-600 rounded" ${HERO_SETTINGS.showPaymentBanner ? 'checked' : ''}>
                                                <label for="pay-ban-show-checkbox" class="text-sm font-bold text-emerald-800 cursor-pointer">تفعيل البانر</label>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label for="pay-ban-url-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">رابط صورة طرق الدفع</label>
                                                <input id="pay-ban-url-input" name="payBanUrl" value="${HERO_SETTINGS.paymentBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-emerald-600 outline-none dir-ltr bg-white" placeholder="https://example.com/payments.png">
                                            </div>
                                            
                                            <!-- أزرار التحكم في الحجم -->
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label for="pay-ban-height-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input id="pay-ban-height-input" name="payBanHeight" type="number" value="${HERO_SETTINGS.paymentBannerHeight || '60'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-emerald-600 outline-none dir-ltr bg-white">
                                                        <span class="absolute left-3 top-3.5 text-stone-600 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="pay-ban-width-input" class="text-xs font-bold text-stone-600 uppercase mb-2 block">العرض (Width CSS)</label>
                                                    <input id="pay-ban-width-input" name="payBanWidth" value="${HERO_SETTINGS.paymentBannerWidth || 'auto'}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-emerald-600 outline-none dir-ltr bg-white" placeholder="auto أو 100%">
                                                </div>
                                            </div>
                                            <p class="text-[10px] text-stone-600 mt-1">يظهر هذا البانر تحت زر "الإبلاغ عن مشكلة". يمكنك تكبير الارتفاع كما تشاء.</p>
                                        </div>
                                    </div>

                                    <button class="w-full bg-stone-900 text-white hover:bg-stone-800 py-4 rounded-xl font-bold transition-all shadow-lg flex justify-center items-center gap-2">
                                        <i data-lucide="save"></i> حفظ وتحديث الإعدادات
                                    </button>
                                </form>
                            </div>
                        ` : ''}

                    </div>
                </div>
            </div>`;
        }

        function renderLogin(c) {
            c.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-white px-6 pt-4">
                    <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl max-w-md w-full text-center space-y-8">
                        <div class="flex justify-center mb-4"><div class="p-4 bg-stone-100 rounded-full"><i data-lucide="shield-check" size="32" class="text-stone-900"></i></div></div>
                        <div>
                            <h2 class="text-3xl font-serif font-bold text-stone-900 mb-2">دخول المالك</h2>
                            <p class="text-stone-600 text-sm leading-relaxed">هذه المنطقة محظورة ومخصصة فقط لإدارة المتجر بواسطة المالك.<br>أي محاولة دخول بحساب آخر سيتم رفضها.</p>
                        </div>
                        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-stone-900 text-white font-bold py-4 rounded-xl hover:bg-stone-800 transition-all hover:shadow-lg group">
                            <svg class="w-5 h-5 bg-white rounded-full p-0.5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            <span>تسجيل الدخول (المالك فقط)</span>
                        </button>
                        <button onclick="setView('home')" class="text-sm text-stone-600 hover:text-stone-900 underline underline-offset-4">العودة للرئيسية كزائر</button>
                    </div>
                </div>
            `;
        }

        function renderContact(c) {
            // ... existing contact code ...
            c.innerHTML = `
            <div class="pt-4 pb-20 container mx-auto px-6 min-h-screen bg-white/30">
                <!-- ... existing content ... -->
                <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
                    <!-- ... cards ... -->
                    <a href="https://wa.me/201014175070" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-[#25D366]"></div>
                        <div class="w-16 h-16 bg-[#25D366]/10 text-[#25D366] rounded-2xl flex items-center justify-center mb-6 group-hover:bg-[#25D366] group-hover:text-white transition-colors">
                            <i data-lucide="message-circle" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">واتساب المعرض</h3>
                        <p class="text-stone-600 text-sm mb-4">تحدث معنا مباشرة لخدمة أسرع</p>
                        <span class="font-mono dir-ltr font-bold text-stone-800 text-lg group-hover:text-[#25D366] transition-colors bg-white px-4 py-2 rounded-lg group-hover:bg-[#25D366]/5">01014175070</span>
                    </a>

                    <a href="mailto:gedar.fayoum@gmail.com" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i data-lucide="mail" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">البريد الإلكتروني</h3>
                        <p class="text-stone-600 text-sm mb-4">راسلنا لأي استفسارات تجارية</p>
                        <span class="font-bold text-stone-800 text-sm break-all group-hover:text-blue-600 transition-colors bg-white px-4 py-2 rounded-lg group-hover:bg-blue-50">gedar.fayoum@gmail.com</span>
                    </a>

                    <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-orange-600"></div>
                        <div class="w-16 h-16 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                            <i data-lucide="map-pin" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">موقع المعرض</h3>
                        <p class="text-stone-600 text-sm mb-4">الفيوم - نهاية شارع المستشفي العام إتجاه مديرية الأمن<br/>بجوار المغسلة الامريكيه وامام مطعم ابو صلاح</p>
                        <div class="flex items-center gap-2 text-stone-800 font-bold bg-white px-4 py-2 rounded-lg group-hover:bg-orange-50 group-hover:text-orange-600 transition-colors text-sm">
                            <span>عرض على الخريطة</span>
                            <i data-lucide="external-link" size="14"></i>
                        </div>
                    </a>
                </div>
                <!-- ... existing map ... -->
                <div class="mt-12 max-w-6xl mx-auto rounded-3xl overflow-hidden shadow-lg border border-stone-200 h-[400px] relative group">
                     <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="block w-full h-full relative group" aria-label="فتح موقع المعرض على خرائط جوجل">
                        <div class="absolute inset-0 bg-stone-200 bg-[url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg')] bg-cover opacity-20 grayscale group-hover:grayscale-0 transition-all duration-700"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-stone-900/10 to-transparent"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 z-10">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-xl animate-bounce text-red-600">
                                <i data-lucide="map-pin" class="fill-current" size="40"></i>
                            </div>
                            <span class="bg-white/90 backdrop-blur-md px-8 py-4 rounded-full font-bold shadow-lg text-stone-900 group-hover:scale-105 transition-transform border border-white/50 flex items-center gap-2">
                                <i data-lucide="navigation" size="18"></i>
                                افتح موقع المعرض على Google Maps
                            </span>
                        </div>
                     </a>
                </div>
            </div>`;
        }

        // NEW: Render Return Policy Page
        function renderReturnPolicy(c) {
            c.innerHTML = `
            <div class="pt-4 pb-20 min-h-screen bg-stone-50/50">
                <div class="container mx-auto px-4 md:px-8">
                    
                    <!-- Header -->
                    <div class="text-center mb-12 max-w-3xl mx-auto">
                        <div class="inline-flex items-center justify-center p-3 mb-4 bg-white rounded-2xl shadow-sm border border-stone-100">
                            <i data-lucide="file-shield" class="text-stone-900" size="32"></i>
                        </div>
                        <h1 class="text-3xl md:text-5xl font-black text-stone-900 mb-4 tracking-tight">سياسة الاسترجاع والاستبدال</h1>
                        <p class="text-stone-600 text-sm md:text-lg leading-relaxed font-medium">حرصًا منا على رضا عملائنا الكرام، نوضح لكم فيما يلي سياسة الاسترجاع والاستبدال الخاصة بنا، لضمان حقوق جميع الأطراف وتقديم أفضل مستوى من الخدمة.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-7xl mx-auto">
                        
                        <!-- Main Content (Right Column) -->
                        <div class="lg:col-span-8 space-y-8">
                            
                            <!-- 1. General Conditions -->
                            <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-1 bg-stone-900 h-full"></div>
                                <h2 class="text-xl font-bold text-stone-900 mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-sm font-bold">1</span> 
                                    أولًا: الشروط العامة والضمان
                                </h2>
                                
                                <div class="space-y-4">
                                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 text-sm text-orange-800 flex gap-3 items-start">
                                        <i data-lucide="alert-triangle" size="18" class="shrink-0 mt-0.5"></i>
                                        <p class="font-bold">تنبيه هام: في حالة "كمالة الشغل"، لا تلتزم الشركة بتوفير نفس درجة اللون في حال عدم توافره وقت التنفيذ.</p>
                                    </div>

                                    <div class="mt-4">
                                        <h3 class="font-bold text-stone-800 mb-3 text-sm flex items-center gap-2"><i data-lucide="ban" size="14" class="text-red-600"></i> الضمان لا يشمل الحالات التالية:</h3>
                                        <ul class="grid sm:grid-cols-2 gap-3">
                                            <li class="flex items-center gap-2 text-stone-600 text-xs font-bold bg-stone-50 p-3 rounded-lg border border-stone-100">سوء الاستخدام أو الإهمال</li>
                                            <li class="flex items-center gap-2 text-stone-600 text-xs font-bold bg-stone-50 p-3 rounded-lg border border-stone-100">استخدام المواد الكيميائية أو الحارقة</li>
                                            <li class="flex items-center gap-2 text-stone-600 text-xs font-bold bg-stone-50 p-3 rounded-lg border border-stone-100">الخدوش الناتجة عن الأدوات الحادة</li>
                                            <li class="flex items-center gap-2 text-stone-600 text-xs font-bold bg-stone-50 p-3 rounded-lg border border-stone-100">الكسر أو التلف الناتج عن الاستخدام الخاطئ</li>
                                        </ul>
                                    </div>

                                    <div class="mt-4 border-t border-stone-100 pt-4">
                                        <h3 class="font-bold text-stone-800 mb-2 text-sm flex items-center gap-2"><i data-lucide="wrench" size="16" class="text-blue-600"></i> ضمان التركيب (سنة واحدة)</h3>
                                        <ul class="space-y-2 text-xs text-stone-600 list-disc list-inside marker:text-blue-400 font-medium">
                                            <li>يشترط تقديم الفاتورة الأصلية للاستفادة من خدمة الصيانة المجانية.</li>
                                            <li>يسقط الضمان في حال تم تنفيذ التركيب بواسطة جهة خارجية غير تابعة للشركة.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Return Policy -->
                            <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-1 bg-red-500 h-full"></div>
                                <h2 class="text-xl font-bold text-stone-900 mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center text-sm font-bold">2</span> 
                                    ثانيًا: سياسة الاسترجاع (7 أيام)
                                </h2>
                                
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="font-bold text-stone-800 text-sm mb-3">يمكنك طلب الاسترجاع في الحالات التالية:</h4>
                                        <ul class="space-y-2">
                                            <li class="flex gap-2 text-xs text-stone-600 font-medium"><i data-lucide="check" size="14" class="text-green-500 mt-0.5 shrink-0"></i> استلام منتج غير مطابق للمواصفات المتفق عليها.</li>
                                            <li class="flex gap-2 text-xs text-stone-600 font-medium"><i data-lucide="check" size="14" class="text-green-500 mt-0.5 shrink-0"></i> وجود عيب تصنيع أو تلف في المنتج.</li>
                                            <li class="flex gap-2 text-xs text-stone-600 font-medium"><i data-lucide="check" size="14" class="text-green-500 mt-0.5 shrink-0"></i> استلام منتج غير الذي تم طلبه.</li>
                                        </ul>
                                    </div>
                                    <div class="bg-stone-50 rounded-xl p-4 border border-stone-100">
                                        <h4 class="font-bold text-stone-800 text-sm mb-3">شروط قبول الاسترجاع:</h4>
                                        <ul class="space-y-2">
                                            <li class="flex gap-2 text-xs text-stone-600 font-bold"><span class="w-1.5 h-1.5 bg-stone-400 rounded-full mt-1.5 shrink-0"></span> أن يكون المنتج بحالته الأصلية.</li>
                                            <li class="flex gap-2 text-xs text-stone-600 font-bold"><span class="w-1.5 h-1.5 bg-stone-400 rounded-full mt-1.5 shrink-0"></span> غير مستخدم نهائياً.</li>
                                            <li class="flex gap-2 text-xs text-stone-600 font-bold"><span class="w-1.5 h-1.5 bg-stone-400 rounded-full mt-1.5 shrink-0"></span> داخل العبوة الأصلية وبكامل ملحقاته.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Exchange Policy -->
                            <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-1 bg-blue-500 h-full"></div>
                                <h2 class="text-xl font-bold text-stone-900 mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-sm font-bold">3</span> 
                                    ثالثًا: سياسة الاستبدال (14 يوم)
                                </h2>
                                
                                <div class="grid sm:grid-cols-2 gap-4">
                                    <div class="flex items-start gap-3 p-4 rounded-xl border border-stone-100 hover:bg-blue-50/30 transition-colors bg-stone-50/50">
                                        <div class="mt-1 bg-white text-blue-600 p-2 rounded-lg border border-stone-100 shadow-sm"><i data-lucide="refresh-ccw" size="16"></i></div>
                                        <div>
                                            <p class="text-sm font-bold text-stone-800">تغيير اللون أو المقاس</p>
                                            <p class="text-xs text-stone-600 mt-1 font-medium">متاح حسب توفر المخزون.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3 p-4 rounded-xl border border-stone-100 hover:bg-blue-50/30 transition-colors bg-stone-50/50">
                                        <div class="mt-1 bg-white text-blue-600 p-2 rounded-lg border border-stone-100 shadow-sm"><i data-lucide="arrow-left-right" size="16"></i></div>
                                        <div>
                                            <p class="text-sm font-bold text-stone-800">استبدال بمنتج آخر</p>
                                            <p class="text-xs text-stone-600 mt-1 font-medium">مع تحمّل فرق السعر إن وجد.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Shipping Fees (سادسًا في النص، تم وضعه هنا للتسلسل المنطقي للعرض) -->
                            <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-1 bg-green-500 h-full"></div>
                                <h2 class="text-xl font-bold text-stone-900 mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-sm font-bold">4</span> 
                                    رسوم الشحن
                                </h2>
                                
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="bg-red-50 p-5 rounded-2xl border border-red-100 text-center hover:shadow-md transition-shadow">
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-red-600 shadow-sm"><i data-lucide="alert-circle" size="20"></i></div>
                                        <h4 class="font-bold text-red-800 text-sm mb-1">خطأ من جانبنا</h4>
                                        <p class="text-[10px] text-red-700 opacity-80 mb-3">(منتج تالف – غير مطابق – خطأ في الطلب)</p>
                                        <div class="bg-white px-4 py-1.5 rounded-full text-xs font-bold text-red-600 inline-block shadow-sm border border-red-100">تتحمل الشركة كامل تكلفة الشحن</div>
                                    </div>
                                    <div class="bg-stone-50 p-5 rounded-2xl border border-stone-200 text-center hover:shadow-md transition-shadow">
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-stone-600 shadow-sm"><i data-lucide="user" size="20"></i></div>
                                        <h4 class="font-bold text-stone-800 text-sm mb-1">رغبة العميل</h4>
                                        <p class="text-[10px] text-stone-600 opacity-80 mb-3">(بدون وجود خطأ في المنتج)</p>
                                        <div class="bg-white px-4 py-1.5 rounded-full text-xs font-bold text-stone-600 inline-block shadow-sm border border-stone-200">يتم خصم قيمة الشحن من المبلغ المُسترد</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Sidebar (Sticky Info) -->
                        <div class="lg:col-span-4 space-y-6">
                            
                            <!-- Non-Returnable Items (رابعًا) -->
                            <div class="bg-stone-900 text-white rounded-3xl p-6 shadow-xl relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 relative z-10"><i data-lucide="ban" class="text-stone-600"></i> منتجات غير قابلة للاسترجاع</h3>
                                <ul class="space-y-3 relative z-10">
                                    <li class="flex items-start gap-3 text-xs text-stone-600 font-medium leading-relaxed">
                                        <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-500 shrink-0 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                                        المنتجات التي تم فتحها أو استخدامها.
                                    </li>
                                    <li class="flex items-start gap-3 text-xs text-stone-600 font-medium leading-relaxed">
                                        <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-500 shrink-0 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                                        المنتجات المُنفذة خصيصًا حسب طلب العميل.
                                    </li>
                                    <li class="flex items-start gap-3 text-xs text-stone-600 font-medium leading-relaxed">
                                        <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-500 shrink-0 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>
                                        العروض والخصومات المعلن عنها على أنها غير قابلة للاسترجاع.
                                    </li>
                                </ul>
                            </div>

                            <!-- Steps (خامسًا) -->
                            <div class="bg-white rounded-3xl p-6 shadow-sm border border-stone-100">
                                <h3 class="font-bold text-stone-900 mb-6 text-sm flex items-center gap-2"><i data-lucide="list-ordered" size="16"></i> خطوات تقديم الطلب</h3>
                                <div class="relative pl-4 border-r-2 border-stone-100 mr-2 space-y-8">
                                    <div class="relative group">
                                        <span class="absolute -right-[9px] top-0 w-4 h-4 bg-white rounded-full border-2 border-green-500 group-hover:scale-110 transition-transform"></span>
                                        <h4 class="font-bold text-stone-800 text-xs">التواصل</h4>
                                        <p class="text-[10px] text-stone-600 mt-1 font-medium">التواصل مع خدمة العملاء عبر واتساب وإرسال رقم الطلب.</p>
                                    </div>
                                    <div class="relative group">
                                        <span class="absolute -right-[9px] top-0 w-4 h-4 bg-white rounded-full border-2 border-stone-300 group-hover:border-stone-900 transition-colors"></span>
                                        <h4 class="font-bold text-stone-800 text-xs">التوضيح</h4>
                                        <p class="text-[10px] text-stone-600 mt-1 font-medium">توضيح سبب الاسترجاع أو الاستبدال بوضوح.</p>
                                    </div>
                                    <div class="relative group">
                                        <span class="absolute -right-[9px] top-0 w-4 h-4 bg-white rounded-full border-2 border-stone-300 group-hover:border-stone-900 transition-colors"></span>
                                        <h4 class="font-bold text-stone-800 text-xs">التسليم</h4>
                                        <p class="text-[10px] text-stone-600 mt-1 font-medium">تجهيز المنتج وتسليمه لمندوب الشحن في الموعد المحدد.</p>
                                    </div>
                                    <div class="relative group">
                                        <span class="absolute -right-[9px] top-0 w-4 h-4 bg-white rounded-full border-2 border-stone-300 group-hover:border-stone-900 transition-colors"></span>
                                        <h4 class="font-bold text-stone-800 text-xs">استرداد المبلغ</h4>
                                        <p class="text-[10px] text-stone-600 mt-1 font-medium">يتم رد المبلغ خلال 1 إلى 3 أيام عمل حسب وسيلة الدفع.</p>
                                    </div>
                                </div>
                                <a href="https://wa.me/201014175070" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl mt-8 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 text-sm flex items-center justify-center gap-2">
                                    <i data-lucide="message-circle" size="16"></i>
                                    بدء طلب استرجاع
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            </div>`;
            lucide.createIcons();
        }

        // NEW: Render FAQ Page
        function renderFAQ(c) {
            // --- FIX: تعريف قائمة الأسئلة الشائعة ---
            const faqs = [
                { 
                    q: "ما هي خامات بديل الرخام وبديل الخشب؟", 
                    a: "بديل الرخام مصنوع من مادة PVC عالية الكثافة مع طبقة حماية UV تعطي لمعان الرخام الطبيعي ومقاومة للخدش. أما بديل الخشب فهو مصنوع من WPC (خليط من ألياف الخشب والبلاستيك) ليجمع بين مظهر الخشب الطبيعي ومقاومة الماء والرطوبة." 
                },
                { 
                    q: "هل المنتجات مقاومة للماء والرطوبة؟", 
                    a: "نعم، جميع منتجاتنا من بديل الرخام وبديل الخشب مقاومة تماماً للماء والرطوبة بنسبة 100%، مما يجعلها مثالية للاستخدام في المطابخ والحمامات ومعالجة مشاكل رطوبة الحوائط." 
                },
                { 
                    q: "هل توفرون خدمة التركيب؟", 
                    a: "نعم، لدينا فريق فني محترف لتركيب جميع الديكورات (بديل رخام، بديل خشب، فوم، مرايات) داخل محافظة الفيوم والمناطق المجاورة. يمكنك طلب المعاينة والتركيب عبر التواصل معنا." 
                },
                { 
                    q: "كم تستغرق عملية الشحن والتوصيل؟", 
                    a: "يتم توصيل الطلبات عادة خلال 2 إلى 4 أيام عمل. بالنسبة للمنتجات الكبيرة (مثل الألواح الكاملة)، يتم التنسيق لضمان وصولها سليمة." 
                },
                { 
                    q: "ماذا لو وصل المنتج تالفاً أو غير مطابق؟", 
                    a: "نضمن لك حق الاسترجاع أو الاستبدال فوراً وبدون أي تكلفة إضافية في حال وصول المنتج تالفاً أو غير مطابق للمواصفات المطلوبة. يرجى مراجعة المنتج عند الاستلام." 
                },
                { 
                    q: "هل يمكنني طلب مقاسات خاصة؟", 
                    a: "معظم الألواح تأتي بمقاسات قياسية (مثلاً بديل الرخام 122×280 سم). يمكن قصها وتشكيلها أثناء التركيب لتناسب مساحتك تماماً." 
                }
            ];
            // ----------------------------------------

            c.innerHTML = `
            <div class="pt-4 pb-20 container mx-auto px-6 min-h-screen bg-white/30">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-12">
                        <span class="inline-block p-3 rounded-2xl bg-indigo-50 text-indigo-600 mb-4 shadow-sm border border-indigo-100"><i data-lucide="help-circle" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">الأسئلة الشائعة</h1>
                        <p class="text-stone-600 text-lg">إجابات على أكثر الأسئلة تداولاً لمساعدتك في اتخاذ القرار.</p>
                    </div>

                    <div class="space-y-4">
                        ${faqs.map((item, idx) => `
                            <div class="bg-white rounded-2xl border border-stone-200 overflow-hidden group">
                                <button onclick="toggleFAQ(${idx})" class="w-full text-right p-6 flex justify-between items-center hover:bg-white transition-colors">
                                    <h3 class="font-bold text-stone-900 text-lg flex items-center gap-3">
                                        <span class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 text-xs font-mono">${idx + 1}</span>
                                        ${item.q}
                                    </h3>
                                    <div id="faq-icon-${idx}" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 transition-transform duration-300">
                                        <i data-lucide="chevron-down" size="20"></i>
                                    </div>
                                </button>
                                <div id="faq-content-${idx}" class="hidden px-6 pb-6 text-stone-600 leading-relaxed border-t border-stone-100 pt-4 bg-white/30 mr-14">
                                    ${item.a}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-12 text-center bg-blue-50 rounded-3xl p-8 border border-blue-100">
                        <h3 class="font-bold text-blue-900 text-lg mb-2">لم تجد إجابة لسؤالك؟</h3>
                        <p class="text-blue-700/80 mb-6">فريقنا جاهز للرد على جميع استفساراتك عبر الواتساب.</p>
                        <a href="https://wa.me/201014175070" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                            <i data-lucide="message-circle" size="18"></i> تحدث معنا الآن
                        </a>
                    </div>
                </div>
            </div>`;
        }

        window.toggleFAQ = (idx) => {
            const content = document.getElementById(`faq-content-${idx}`);
            const icon = document.getElementById(`faq-icon-${idx}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        };

        function renderAbout(c) {
            c.innerHTML = `<div class="pt-8 container mx-auto px-6 text-center"><h1 class="text-4xl font-bold mb-8">تبسيط المنزل</h1><p class="max-w-2xl mx-auto text-stone-600">وُلدت علامة "جدار" من الرغبة في إعادة الهدوء إلى المنزل.</p></div>`;
        }

        function renderProductDetails(c) {
            // NEW: Loading State for Direct Links
            if (!isDataLoaded && PRODUCTS.length === 0) {
                c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center pt-4">
                    <div class="animate-spin w-12 h-12 border-4 border-stone-200 border-t-stone-900 rounded-full mb-4"></div>
                    <p class="text-stone-600 font-medium">جاري تحميل المنتج...</p>
                </div>`;
                return;
            }

            const p = PRODUCTS.find(x => x.id == currentProductId);
            if(!p) return c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center text-center px-4 pt-4">
                    <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-stone-600">
                        <i data-lucide="search-x" size="40"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-stone-900 mb-2">المنتج غير موجود</h2>
                    <p class="text-stone-600 mb-6">قد يكون تم حذف المنتج أو الرابط غير صحيح.</p>
                    <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">تصفح المتجر</button>
                </div>`;
            
            const isFav = favorites.includes(p.id);
            // NEW: Check Admin Status
            const isAdmin = user && user.email === ADMIN_EMAIL;
            
            const images = (p.images && p.images.length > 0) ? p.images : [p.image];
            const features = (p.features && p.features.length > 0) ? p.features : [];

            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)).toFixed(2) : p.price;
            
            // Check Stock Status (Default to true if undefined)
            const isInStock = p.inStock !== false;

            // Calculate Reviews Data
            const productReviews = ALL_REVIEWS.filter(r => r.productId === p.id && r.status === 'approved');
            const totalReviews = productReviews.length;
            const averageRating = totalReviews > 0 ? (productReviews.reduce((sum, r) => sum + r.rating, 0) / totalReviews).toFixed(1) : 0;
            const counts = { 5:0, 4:0, 3:0, 2:0, 1:0 };
            productReviews.forEach(r => counts[r.rating]++);

            // --- 1️⃣ Customer Trust: Dynamic Order Counter Logic ---
            const randomMinutes = Math.floor(Math.random() * 40) + 5; // وقت عشوائي بين 5 و 45 دقيقة
            const trustCounterHTML = `
            <div class="mt-4 pt-4 border-t border-stone-100">
                <p class="text-xs text-stone-600 flex items-center gap-2 mb-2 font-medium bg-green-50 w-fit px-3 py-1.5 rounded-full border border-green-100">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span>آخر طلب تم تأكيده منذ <b>${randomMinutes} دقيقة</b></span>
                </p>
                <div class="flex items-center gap-2 text-[10px] text-stone-600">
                    <i data-lucide="shield-check" class="text-green-600" size="14"></i>
                    <span>عملية الدفع مؤمنة 100% ويتم مراجعتها يدوياً</span>
                </div>
            </div>
            `;
            // -----------------------------------------------------

            // --- Window function to handle color selection ---
            window.selectColor = (colorName, imageUrl) => {
                currentSelectedColor = colorName;
                
                // Update Main Image
                const mainImg = document.getElementById('main-product-image');
                if (mainImg && imageUrl) mainImg.src = imageUrl;
                
                // Update Active State of Buttons
                const allBtns = document.querySelectorAll('.variant-btn');
                allBtns.forEach(btn => {
                    if (btn.dataset.color === colorName) {
                        btn.classList.add('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.remove('border-stone-200');
                        btn.classList.add('border-stone-900');
                    } else {
                        btn.classList.remove('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.add('border-stone-200');
                        btn.classList.remove('border-stone-900');
                    }
                });
            };

            // --- Dynamic Tags Generation (NEW) ---
            // 1. Get all Category Names
            const catTags = CATEGORIES.map(c => c.name);
            
            // 2. Get Random Product Keywords (First 2-3 words of product names)
            const prodTags = PRODUCTS
                .filter(prod => prod.id !== p.id) // Exclude current product
                .map(prod => prod.name.split(' ').slice(0, 3).join(' ')) // Take first 3 words
                .sort(() => 0.5 - Math.random()) // Shuffle
                .slice(0, 12); // Take 12 items
            
            // 3. Combine & Deduplicate
            const dynamicTags = [...new Set([...catTags, ...prodTags])];

            // --- NEW: Random Sponsored Product Logic ---
            const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
            const adHTML = adProduct ? `
            <div onclick="viewProduct('${adProduct.id}')" class="w-full bg-gradient-to-r from-stone-50 via-white to-stone-50 border border-stone-200 rounded-xl p-3 mb-8 flex items-center gap-4 cursor-pointer hover:shadow-md hover:border-green-200 transition-all group animate-in fade-in slide-in-from-top-4 duration-700">
                <div class="bg-stone-200 text-stone-600 text-[10px] font-bold px-2 py-1 rounded select-none">إعلان</div>
                
                <div class="w-12 h-12 bg-white rounded-lg border border-stone-100 overflow-hidden shrink-0">
                    <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                </div>
                
                <div class="flex-1 min-w-0 flex flex-col sm:flex-row sm:items-center justify-between gap-1 sm:gap-4">
                    <div class="truncate">
                        <h4 class="font-bold text-stone-900 text-xs sm:text-sm truncate group-hover:text-green-700 transition-colors">${adProduct.name}</h4>
                        <p class="text-[10px] text-stone-600 truncate hidden sm:block">${adProduct.description ? adProduct.description.substring(0, 50) + '...' : 'تصفح هذا المنتج المميز الآن'}</p>
                    </div>
                    
                    <div class="flex items-center gap-3 shrink-0">
                        <span class="font-serif font-bold text-stone-900 text-sm sm:text-base">$${adProduct.price}</span>
                        <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-600 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-all">
                            <i data-lucide="arrow-left" size="16"></i>
                        </div>
                    </div>
                </div>
            </div>` : '';

            // --- Prepared Slider Data ---
            
            // 1. Related Products (Same Category)
            const relatedProducts = PRODUCTS.filter(prod => prod.category === p.category && prod.id !== p.id);
            
            // 2. Random Suggestions (NEW LOGIC)
            // Shuffle all products and pick 8 random ones (excluding current)
            const randomSuggestions = PRODUCTS.filter(prod => prod.id !== p.id)
                                              .sort(() => 0.5 - Math.random())
                                              .slice(0, 8);

            // 3. Browsing History
            const historyIds = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            const historyProducts = historyIds.map(hId => PRODUCTS.find(prod => prod.id === hId)).filter(item => item !== undefined);

            // --- Helper: Render Slider HTML (Updated for Small Cards) ---
            const renderSliderHTML = (id, title, items, isSmall = false) => {
                if (items.length === 0) return '';
                
                // Determine width based on isSmall flag
                // UPDATE: تم تصغير العرض الافتراضي من 260px إلى 210px
                const cardWidthClass = isSmall ? 'min-w-[140px] w-[140px]' : 'min-w-[210px] w-[210px]';
                
                return `
                <div class="mt-16 border-t border-stone-100 pt-10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="${isSmall ? 'text-lg' : 'text-xl'} font-bold text-stone-900">${title}</h3>
                        <div class="flex gap-2">
                            <button onclick="scrollSection('${id}', 'prev')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600" aria-label="السابق"><i data-lucide="arrow-right" size="16"></i></button>
                            <button onclick="scrollSection('${id}', 'next')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600" aria-label="التالي"><i data-lucide="arrow-left" size="16"></i></button>
                        </div>
                    </div>
                    <div id="${id}" class="flex gap-4 overflow-x-auto scrollbar-hide scroll-smooth snap-x pb-4">
                        ${items.map(item => `
                            <div class="${cardWidthClass} snap-start">
                                ${isSmall ? createSmallProductCard(item) : createProductCard(item)}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            c.innerHTML = `
            <div class="bg-white min-h-screen pt-4 pb-20">
                <div class="container mx-auto px-4 lg:px-6">
                    
                    <!-- Insert The Ad Banner Here -->
                    ${adHTML}

                    <div class="flex items-center gap-2 text-sm text-stone-600 mb-8">
                        <button onclick="setView('shop')" class="hover:text-stone-900">المتجر</button><i data-lucide="chevron-left" size="14"></i>
                        <button onclick="filterCategory('${p.category}'); setView('shop')" class="hover:text-stone-900">${p.category}</button><i data-lucide="chevron-left" size="14"></i>
                        <span class="text-stone-900 font-medium truncate max-w-[200px]">${p.name}</span>
                    </div>
                    
                    <!-- Top Section: Images & Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mb-12">
                        <!-- Product Images -->
                        <div class="lg:col-span-5 flex flex-col-reverse lg:flex-row gap-4">
                            <div class="flex lg:flex-col gap-3 overflow-x-auto lg:overflow-y-auto lg:max-h-[500px] scrollbar-hide py-1 px-1">
                                ${images.map((img, idx) => `<div onmouseover="setActiveImage(${idx})" onclick="setActiveImage(${idx})" class="gallery-thumb cursor-pointer border border-stone-200 rounded-lg p-1 w-16 h-16 lg:w-20 lg:h-20 flex-shrink-0 bg-white ${idx===0?'active':''} hover:border-stone-400 transition-all"><img src="${img}" class="w-full h-full object-cover rounded-md" alt="صورة ${idx + 1} - ${p.name}"></div>`).join('')}
                            </div>
                            <!-- Modified Image Container: Square but constrained width/height -->
                            <div class="flex-1 bg-white rounded-2xl border border-stone-200 flex items-center justify-center relative group w-full max-w-[500px] mx-auto aspect-square overflow-hidden shadow-sm">
                                <img id="main-product-image" src="${images[0]}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="${p.name}">
                                <!-- تم إضافة كلاس fav-btn-${p.id} هنا -->
                                <button onclick="toggleFavorite('${p.id}')" class="fav-btn-${p.id} absolute top-4 right-4 p-3 rounded-full bg-white/90 backdrop-blur-sm shadow-md hover:bg-white transition-all z-10 ${isFav?'text-red-600 border-red-100':'text-stone-600 border-stone-100'} border" aria-label="إضافة للمفضلة">
                                    <i data-lucide="heart" class="${isFav?'fill-current':''}"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Product Info -->
                        <div class="lg:col-span-4 space-y-6">
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        ${p.brand ? `<a href="#" class="text-sm text-blue-600 hover:text-orange-600 hover:underline mb-1 inline-block font-medium">زيارة متجر ${p.brand}</a>` : ''}
                                        <h1 class="text-2xl lg:text-3xl font-bold text-stone-900 leading-tight mb-2">${p.name}</h1>
                                    </div>
                                    <button onclick="shareProduct('${p.id}')" class="w-10 h-10 rounded-full bg-white hover:bg-blue-50 text-stone-600 hover:text-blue-600 flex items-center justify-center transition-all shadow-sm border border-stone-100 shrink-0" title="مشاركة المنتج" aria-label="مشاركة المنتج">
                                        <i data-lucide="share-2" size="20"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="flex text-yellow-400 text-sm">
                                        ${averageRating > 0 
                                            ? Array(Math.round(averageRating)).fill('<i data-lucide="star" class="fill-current w-4 h-4"></i>').join('') 
                                            : '<span class="text-stone-600 text-xs">لا توجد تقييمات</span>'}
                                    </div>
                                    <span class="text-stone-600 text-sm">(${totalReviews} تقييم)</span>
                                </div>
                            </div>
                            <div class="border-t border-b border-stone-100 py-4">
                                ${hasDiscount ? 
                                `<div class="flex items-end gap-3 mb-1">
                                    <span class="text-4xl font-bold text-red-600 font-serif">$${finalPrice}</span>
                                    <span class="text-xl text-stone-600 line-through mb-1">$${p.price}</span>
                                    <!-- UPDATED: Badge Style -> bg-red-600 text-white -->
                                    <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded mb-2 shadow-sm">خصم ${p.discount}%</span>
                                 </div>
                                 <p class="text-sm text-stone-600">شامل الضريبة</p>` 
                                : 
                                `<div class="flex items-baseline gap-2"><span class="text-3xl font-bold text-stone-900 font-serif">$${p.price}</span><span class="text-stone-600 text-sm">شامل الضريبة</span></div>`
                                }
                            </div>

                            <!-- VARIANTS SECTION (Kept here as it affects image) -->
                            ${p.variants && p.variants.length > 0 ? `
                            <div id="variants-section" class="space-y-3 pb-4 border-b border-stone-100">
                                <h3 class="font-bold text-stone-900 text-sm">الألوان المتاحة:</h3>
                                <div class="flex flex-wrap gap-3">
                                    ${p.variants.map(v => `
                                        <button 
                                            onclick="selectColor('${v.color}', '${v.image}')" 
                                            data-color="${v.color}"
                                            class="variant-btn group relative w-12 h-12 rounded-full border border-stone-200 overflow-hidden hover:scale-110 transition-all focus:outline-none"
                                            title="${v.color}"
                                        >
                                            <img src="${v.image}" class="w-full h-full object-cover" alt="لون ${v.color}">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-[10px] text-stone-600"><i data-lucide="info" size="10" class="inline"></i> اختر اللون لمشاهدة صورته وإضافته للسلة</p>
                            </div>
                            ` : ''}
                            
                            <!-- Dynamic Service Icons Slider -->
                            <div class="mt-2 py-4">
                                <div class="flex gap-4 overflow-x-auto scrollbar-hide px-1 snap-x">
                                    ${(p.services && p.services.length > 0 ? p.services : []).map(s => `
                                    <div class="min-w-[80px] w-[80px] flex flex-col items-center text-center gap-2 snap-start group cursor-default">
                                        <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 group-hover:bg-stone-200 transition-colors">
                                            <i data-lucide="${s.icon}" size="20"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-stone-600 leading-tight">${s.text.replace(/ /g, '<br>')}</span>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Report Issue Link (WhatsApp) -->
                            <div class="mt-2">
                                <a href="https://wa.me/201014175070?text=${encodeURIComponent('مرحباً، أريد الإبلاغ عن مشكلة بخصوص المنتج: ' + p.name)}" target="_blank" class="flex items-center gap-2 text-stone-600 hover:text-red-600 text-xs font-medium transition-colors w-fit p-2 rounded-lg hover:bg-white">
                                    <i data-lucide="flag" size="14"></i>
                                    <span>أبلغ عن مشكلة</span>
                                </a>
                            </div>

                            <!-- NEW: Payment Banner (Dynamic) -->
                            ${HERO_SETTINGS.showPaymentBanner && HERO_SETTINGS.paymentBannerUrl ? `
                            <div class="mt-6 pt-4 border-t border-stone-100">
                                <p class="text-[10px] text-stone-600 font-bold mb-2 uppercase tracking-wider">التقسيط:</p>
                                <div class="rounded-xl overflow-hidden border border-stone-100 w-fit max-w-full">
                                    <!-- تم تحديث الستايل هنا ليأخذ القيم من الإعدادات -->
                                    <img src="${HERO_SETTINGS.paymentBannerUrl}" 
                                         style="height: ${HERO_SETTINGS.paymentBannerHeight || 60}px; width: ${HERO_SETTINGS.paymentBannerWidth || 'auto'};" 
                                         class="object-contain bg-white max-w-full" 
                                         alt="طرق الدفع">
                                </div>
                            </div>
                            ` : ''}

                        </div>

                        <!-- Action Card -->
                        <div class="lg:col-span-3">
                            <div class="border border-stone-200 rounded-xl p-5 shadow-sm sticky top-24 bg-white">
                                <div class="mb-4">
                                    ${hasDiscount 
                                        ? `<span class="text-2xl font-bold text-red-600">$${finalPrice}</span> <span class="text-sm text-stone-600 line-through">$${p.price}</span>` 
                                        : `<span class="text-2xl font-bold text-stone-900">$${p.price}</span>`
                                    }
                                </div>
                                <div class="text-sm mb-6">
                                    ${isInStock 
                                        ? `<p class="text-green-600 font-medium mb-1 flex items-center gap-2"><i data-lucide="check-circle" size="16"></i> متوفر في المخزون</p>`
                                        : `<p class="text-red-600 font-medium mb-1 flex items-center gap-2"><i data-lucide="x-circle" size="16"></i> غير متوفر حالياً (Out of Stock)</p>`
                                    }
                                    <p class="text-stone-600">يصلك خلال: <span class="text-stone-900 font-bold">2-4 أيام عمل</span></p>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between border border-stone-200 rounded-lg p-2 bg-white ${!isInStock ? 'opacity-50 pointer-events-none' : ''}">
                                        <span class="text-sm font-bold text-stone-600 px-2">الكمية:</span>
                                        <div class="flex items-center gap-4">
                                            <button onclick="changeDetailsQuantity(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">-</button>
                                            <span id="details-qty" class="font-bold w-4 text-center">${detailsQuantity}</span>
                                            <button onclick="changeDetailsQuantity(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">+</button>
                                        </div>
                                    </div>
                                    
                                    <button onclick="addToCartFromDetails('${p.id}')" ${!isInStock ? 'disabled' : ''} class="w-full ${isInStock ? 'bg-yellow-400 hover:bg-yellow-500 text-stone-900' : 'bg-stone-200 text-stone-600 cursor-not-allowed'} py-3 rounded-full font-bold shadow-sm transition-colors text-sm">
                                        ${isInStock ? 'إضافة إلى عربة التسوق' : 'غير متوفر'}
                                    </button>
                                    
                                    <button onclick="addToCartFromDetails('${p.id}'); checkout()" ${!isInStock ? 'disabled' : ''} class="w-full ${isInStock ? 'bg-orange-500 hover:bg-orange-600 text-white' : 'bg-stone-200 text-stone-600 cursor-not-allowed'} py-3 rounded-full font-bold shadow-sm transition-colors text-sm">
                                        ${isInStock ? 'شراء الآن' : 'غير متوفر'}
                                    </button>
                                </div>

                                <!-- 1️⃣ Trust Signals (Social Proof) -->
                                ${trustCounterHTML}

                                <!-- Sponsored Product Ad -->
                                ${(() => {
                                    // Pick a random product for ad
                                    const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
                                    if (!adProduct) return '';
                                    
                                    return `
                                    <div class="mt-6 pt-4 border-t border-stone-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-[10px] font-bold text-stone-600 uppercase tracking-wider">منتج ممول</span>
                                            <i data-lucide="info" size="10" class="text-stone-600"></i>
                                        </div>
                                        <div class="border border-stone-200 rounded-xl p-2 bg-white hover:bg-white hover:border-stone-400 transition-all cursor-pointer group flex gap-3 items-center" onclick="viewProduct('${adProduct.id}')">
                                            <div class="w-14 h-14 bg-white rounded-lg overflow-hidden shrink-0 border border-stone-100">
                                                <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform" alt="${adProduct.name}">
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-bold text-stone-900 text-xs truncate mb-1">${adProduct.name}</h4>
                                                <div class="flex justify-between items-center">
                                                    <span class="font-serif font-bold text-stone-900 text-sm">$${adProduct.price}</span>
                                                    <span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded-full">عرض</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                })()}

                                <!-- "Customers usually keep this item" Box -->
                                <div class="mt-4 bg-green-50 border border-green-600 rounded-xl p-4 flex items-start justify-between gap-4 shadow-sm">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-stone-900 text-xs mb-1">عادة ما يحتفظ العملاء بهذه السلعة</h4>
                                        <p class="text-[10px] text-stone-700 leading-relaxed">يتمتع هذا المنتج بمعدلات إرجاع أقل من المتوسط.</p>
                                    </div>
                                    <div class="bg-green-600 rounded-full p-1 text-white shrink-0 shadow-sm">
                                        <i data-lucide="check" size="14" stroke-width="3"></i>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- NEW: Detailed Info Section (Bottom Layout like Amazon) -->
                    <div class="grid md:grid-cols-2 gap-8 mb-16 items-start mt-12 border-t border-stone-100 pt-12">
                        <!-- About Item -->
                        <div class="h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-stone-100 p-2 rounded-lg"><i data-lucide="file-text" class="text-stone-600" size="20"></i></span>
                                عن السلعة
                            </h3>
                            ${(() => {
                                // Calculate content length (items)
                                const materialLine = p.material ? 1 : 0;
                                const featureLines = features.length;
                                const descLines = 1;
                                const totalLines = materialLine + featureLines + descLines;
                                const isLong = totalLines > 3;

                                return `
                                <div id="about-container-${p.id}" class="relative overflow-hidden transition-all duration-500 ${isLong ? 'max-h-[100px]' : ''}">
                                    <ul class="list-disc list-outside mr-5 space-y-3 text-stone-700 leading-relaxed">
                                        ${p.material ? `<li class="font-bold text-stone-900">المادة: <span class="font-normal text-stone-700">${p.material}</span></li>` : ''}
                                        ${features.map(f => `<li>${f}</li>`).join('')}
                                        <li>${p.description || p.details}</li>
                                    </ul>
                                    ${isLong ? `<div id="about-fade-${p.id}" class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-white to-transparent"></div>` : ''}
                                </div>
                                ${isLong ? `
                                <button id="about-btn-${p.id}" onclick="toggleAbout('${p.id}')" class="text-stone-900 font-bold text-sm hover:text-orange-600 underline underline-offset-4 flex items-center gap-1 mt-4 transition-colors">
                                    <i data-lucide="chevron-down" size="16"></i> قراءة المزيد
                                </button>` : ''}
                                `;
                            })()}
                        </div>

                        <!-- Specs Section -->
                        <div class="bg-white rounded-3xl p-8 border border-stone-100 h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-white p-2 rounded-lg border border-stone-200"><i data-lucide="settings-2" class="text-stone-600" size="20"></i></span>
                                المواصفات الفنية
                            </h3>
                            ${p.specifications && p.specifications.length > 0 ? `
                            <div class="space-y-0 divide-y divide-stone-200">
                                ${p.specifications.map(s => `
                                    <div class="flex justify-between items-center py-4 px-2">
                                        <span class="font-bold text-stone-600 text-sm">${s.label}</span>
                                        <span class="text-stone-900 dir-ltr text-sm font-bold">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : `<p class="text-stone-600 text-sm">لا توجد مواصفات إضافية.</p>`}
                        </div>
                    </div>

                    <!-- Related Products Slider -->
                    ${renderSliderHTML('related-slider-section', 'المنتجات المرتبطة بهذه السلعة', relatedProducts)}
                    
                    <!-- Random Suggestions Slider (Now Small like History) -->
                    ${renderSliderHTML('suggestions-slider-section', 'اقتراحات قد تعجبك', randomSuggestions, true)}

                    <!-- Reviews Section -->
                    <div class="mt-20 border-t border-stone-100 pt-12">
                        <div class="grid lg:grid-cols-12 gap-12">
                            <!-- Right: Rating Summary (Amazon Style) -->
                            <div class="lg:col-span-4">
                                <h3 class="text-2xl font-bold text-stone-900 mb-2">مراجعات المستخدمين</h3>
                                <div class="flex items-baseline gap-2 mb-4">
                                    <div class="flex text-yellow-400 text-lg">${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-5 h-5 ${i < Math.round(averageRating) ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}</div>
                                    <span class="text-lg font-bold text-stone-900 dir-ltr">${averageRating} من 5</span>
                                </div>
                                <p class="text-sm text-stone-600 mb-6">${totalReviews} من التقييمات العالمية</p>
                                
                                <div class="space-y-3 mb-8">
                                    ${[5,4,3,2,1].map(star => {
                                        const count = counts[star];
                                        const percent = totalReviews > 0 ? Math.round((count / totalReviews) * 100) : 0;
                                        return `
                                        <div class="flex items-center gap-3 text-sm group cursor-default hover:opacity-80 transition-opacity">
                                            <span class="w-12 text-blue-600 font-medium hover:underline text-left dir-ltr">${star} نجوم</span>
                                            <div class="flex-1 h-5 bg-stone-100 rounded-sm overflow-hidden border border-stone-200 box-border">
                                                <div class="h-full bg-yellow-400 border-r border-yellow-500" style="width: ${percent}%"></div>
                                            </div>
                                            <span class="w-8 text-blue-600 font-medium text-right dir-ltr">${percent}%</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="border-t border-stone-200 pt-6">
                                    <h4 class="font-bold text-lg mb-2">راجع هذا المنتج</h4>
                                    <p class="text-sm text-stone-600 mb-4">شارك أفكارك مع العملاء الآخرين</p>
                                    <button onclick="document.getElementById('review-form').classList.toggle('hidden')" class="w-full border border-stone-300 text-stone-900 py-2 rounded-lg text-sm font-bold hover:bg-white transition-colors">اكتب مراجعة للعميل</button>
                                    
                                    <form id="review-form" onsubmit="handleSubmitReview(event)" class="space-y-4 mt-4 hidden bg-white p-4 rounded-xl border border-stone-200">
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-2">التقييم العام</label>
                                            
                                            <!-- Rating Stars Container -->
                                            <div class="rating-container flex flex-row-reverse justify-end gap-1">
                                                <!-- CSS for Rating Logic -->
                                                <style>
                                                    .rating-container:hover label { color: #d6d3d1; /* stone-300 (reset on hover) */ }
                                                    .rating-container label:hover,
                                                    .rating-container label:hover ~ label,
                                                    .rating-container input:checked ~ label {
                                                        color: #facc15 !important; /* yellow-400 */
                                                    }
                                                    .rating-container label:hover svg,
                                                    .rating-container label:hover ~ label svg,
                                                    .rating-container input:checked ~ label svg {
                                                        fill: currentColor;
                                                    }
                                                </style>

                                                ${[5,4,3,2,1].map(val => `
                                                    <input type="radio" name="reviewerRating" value="${val}" id="star${val}" class="sr-only" ${val===5?'checked':''}>
                                                    <label for="star${val}" class="cursor-pointer text-stone-300 transition-colors duration-200 p-1" title="${val} نجوم">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                                        </svg>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <label for="reviewer-name-input" class="block text-xs font-bold text-stone-600 mb-1">الاسم</label>
                                            <input id="reviewer-name-input" name="reviewerName" required class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="اسمك الكريم">
                                        </div>
                                        <div>
                                            <label for="reviewer-comment-textarea" class="block text-xs font-bold text-stone-600 mb-1">أضف مراجعة مكتوبة</label>
                                            <textarea id="reviewer-comment-textarea" name="reviewerComment" required rows="3" class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="ما الذي أعجبك أو لم يعجبك؟ بماذا تنصح؟"></textarea>
                                        </div>
                                        <button class="w-full bg-stone-900 text-white py-2 rounded-lg text-sm font-bold hover:bg-stone-800 transition-colors shadow-md">إرسال</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Left: Reviews List -->
                            <div class="lg:col-span-8 space-y-6">
                                <h3 class="font-bold text-xl mb-4">أفضل المراجعات</h3>
                                ${productReviews.length > 0 ? productReviews.map(r => `
                                    <div class="flex gap-4 mb-6 group/review relative">
                                        <div class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center font-bold text-stone-600 text-lg flex-shrink-0">${r.userName.charAt(0)}</div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-bold text-sm text-stone-900">${r.userName}</span>
                                                </div>
                                                <!-- NEW: Admin Delete Button -->
                                                ${isAdmin ? `
                                                <button onclick="if(confirm('هل أنت متأكد من حذف هذا التعليق نهائياً؟')) handleReviewAction('${r.id}', 'delete')" class="text-red-400 hover:text-red-600 transition-colors p-1 opacity-0 group-hover/review:opacity-100 absolute left-0 top-0 bg-white rounded-full shadow-sm border border-red-100" title="حذف التعليق">
                                                    <i data-lucide="trash-2" size="14"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="flex text-yellow-400 text-xs">
                                                    ${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-4 h-4 ${i < r.rating ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}
                                                </div>
                                                ${r.verified ? `<span class="text-xs font-bold text-orange-600">تم الشراء (Verified Purchase)</span>` : ''}
                                            </div>
                                            <p class="text-xs text-stone-600 mb-2">تمت المراجعة في ${new Date(r.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            <p class="text-stone-700 text-sm leading-relaxed font-medium mb-4">${r.comment}</p>
                                            <div class="flex gap-4 text-xs text-stone-600">
                                                <button class="border border-stone-200 px-4 py-1 rounded-full hover:bg-white transition-colors">مفيد</button>
                                                <button class="text-stone-600 hover:text-stone-600">إبلاغ</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="bg-white rounded-xl p-8 text-center border border-dashed border-stone-200">
                                        <p class="text-stone-600">لا توجد مراجعات حتى الآن.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- NEW: History Slider (Smaller Cards) -->
                    ${renderSliderHTML('history-slider-section', 'سجل التصفح الخاص بك', historyProducts, true)}

                    <!-- NEW: Popular Search Cloud (Dynamic) -->
                    <div class="mt-16 border-t border-stone-100 pt-10 pb-8">
                         <div class="flex justify-between items-end mb-6">
                            <h3 class="text-xl font-bold text-stone-900">البحث الشائع</h3>
                         </div>
                         <div class="flex flex-wrap gap-2.5">
                            ${dynamicTags.length > 0 ? dynamicTags.map(tag => `
                                <button onclick="updateShopFilters('search', '${tag}'); setView('shop')" class="bg-stone-100 hover:bg-stone-200 text-stone-600 hover:text-stone-900 px-3 py-1.5 rounded-md text-xs md:text-sm font-medium transition-colors border border-transparent hover:border-stone-300">
                                    ${tag}
                                </button>
                            `).join('') : '<p class="text-sm text-stone-600">لا توجد كلمات بحث شائعة حالياً.</p>'}
                         </div>
                    </div>

                </div>
            </div>`;
        }
        
        // --- Helper Function: Create Small Product Card ---
        function createSmallProductCard(p, forceEager = false) {
            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            const isAdmin = user && user.email === ADMIN_EMAIL;
            const optimizedImage = optimizeImageUrl(p.image); // ✅ Optimize URL
            
            return `
            <div class="group flex flex-col gap-2 cursor-pointer h-full" onclick="viewProduct('${p.id}')">
                <div class="relative aspect-square bg-white border border-stone-100 rounded-[1.5rem] overflow-hidden group-hover:shadow-md transition-all duration-300">
                    <!-- Brand Badge -->
                    <div class="absolute top-2 right-2 z-10">
                        <span class="bg-[#00796B] text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-sm">${p.brand || 'منتج'}</span>
                    </div>

                    <!-- NEW: Admin Controls -->
                    ${isAdmin ? `
                    <div class="absolute top-2 left-2 z-20 flex flex-col gap-1.5">
                        <button onclick="event.stopPropagation(); handleEditProduct('${p.id}')" class="w-6 h-6 bg-blue-50/90 text-blue-600 rounded-full flex items-center justify-center shadow-sm hover:bg-blue-600 hover:text-white transition-all border border-blue-100" title="تعديل" aria-label="تعديل المنتج"><i data-lucide="pen-line" size="12"></i></button>
                        <button onclick="event.stopPropagation(); handleDeleteProduct('${p.id}')" class="w-6 h-6 bg-red-50/90 text-red-600 rounded-full flex items-center justify-center shadow-sm hover:bg-red-600 hover:text-white transition-all border border-red-100" title="حذف" aria-label="حذف المنتج"><i data-lucide="trash-2" size="12"></i></button>
                    </div>
                    ` : ''}

                    <!-- Image (Optimized) -->
                    <!-- UPDATED: Added width/height for CLS (Square) -->
                    <img src="${optimizedImage}" 
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                         ${forceEager ? 'fetchpriority="high" loading="eager"' : 'loading="lazy" decoding="async"'}
                         width="300" height="300" 
                         alt="${p.name}">
                    
                    <!-- Add Button -->
                    <div class="absolute bottom-2 left-0 w-full px-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-white text-stone-900 text-[10px] font-bold py-2 rounded-full shadow-lg hover:bg-white">
                            أضف
                        </button>
                    </div>
                </div>
                
                <div class="px-1 text-right">
                    <h3 class="text-stone-800 font-bold text-xs leading-snug line-clamp-1 mb-1">${p.name}</h3>
                    <div class="flex items-center justify-end gap-2 dir-ltr">
                        <span class="text-[#00796B] text-sm font-bold">${Math.floor(finalPrice)} ج.م</span>
                    </div>
                </div>
            </div>`;
        }

        function createProductCard(p, forceEager = false) {
            const isFav = favorites.includes(p.id);
            const isAdmin = user && user.email === ADMIN_EMAIL;
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            const optimizedImage = optimizeImageUrl(p.image); // ✅ Optimize URL
            
            // Check Stock Status
            const isInStock = p.inStock !== false;

            // Format Price
            const priceFormatted = Math.floor(finalPrice).toLocaleString();
            const originalPriceFormatted = Math.floor(p.price).toLocaleString();

            return `
            <div class="group flex flex-col gap-2 cursor-pointer h-full select-none" onclick="viewProduct('${p.id}')">
                <!-- Image Container -->
                <div class="relative aspect-[4/5] bg-white rounded-xl md:rounded-[2rem] overflow-hidden transition-all duration-300 group-hover:shadow-lg border border-stone-100 group-hover:border-stone-200">
                    
                    <!-- OUT OF STOCK OVERLAY (z-20 -> z-10) -->
                    ${!isInStock ? `
                    <div class="absolute inset-0 bg-white/60 z-10 flex items-center justify-center backdrop-blur-[1px]">
                        <div class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg rotate-12 border-2 border-white flex items-center gap-1">
                            <i data-lucide="ban" size="14"></i> غير متوفر
                        </div>
                    </div>` : ''}

                    <!-- DISCOUNT BADGE (z-20 -> z-10) -->
                    ${hasDiscount && isInStock ? `
                    <div class="absolute top-1.5 right-1.5 md:top-3 md:right-3 z-10">
                        <div class="bg-red-600 text-white text-[8px] md:text-xs font-bold px-1.5 py-0.5 md:px-3 md:py-1.5 rounded md:rounded-lg shadow-md border border-white/20 flex items-center gap-1">
                            <span class="dir-ltr">-${p.discount}%</span>
                        </div>
                    </div>` : ''}

                    <!-- Brand Badge (z-20 -> z-10) -->
                    <div class="absolute bottom-1 right-1 md:bottom-4 md:right-4 z-10 transition-opacity duration-300 group-hover:opacity-0 hidden md:block">
                        <span class="bg-white/80 backdrop-blur-md text-stone-700 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-stone-100/50">${p.brand || 'JEDAR'}</span>
                    </div>

                    <!-- Top Left: Floating Actions (UPDATED Z-INDEX TO 20 - Lowered) -->
                    <div class="absolute top-1.5 left-1.5 md:top-3 md:left-3 z-20 flex flex-col gap-1.5">
                        <!-- Favorite (تم إضافة كلاس fav-btn-${p.id}) -->
                        <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="fav-btn-${p.id} w-7 h-7 md:w-9 md:h-9 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center shadow-sm hover:scale-110 transition-transform border ${isFav ? 'text-red-600 border-red-100' : 'text-stone-600 border-stone-100'}" aria-label="إضافة للمفضلة">
                            <i data-lucide="heart" size="14" class="md:w-[18px] md:h-[18px] ${isFav ? 'fill-current' : ''}"></i>
                        </button>

                        <!-- Admin Controls (z-20) -->
                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); handleEditProduct('${p.id}')" class="w-7 h-7 md:w-9 md:h-9 bg-blue-50/90 text-blue-600 rounded-full flex items-center justify-center shadow-sm hover:bg-blue-600 hover:text-white transition-all border border-blue-100" title="تعديل" aria-label="تعديل المنتج"><i data-lucide="pen-line" size="14" class="md:w-4 md:h-4"></i></button>
                        <button onclick="event.stopPropagation(); handleDeleteProduct('${p.id}')" class="w-7 h-7 md:w-9 md:h-9 bg-red-50/90 text-red-600 rounded-full flex items-center justify-center shadow-sm hover:bg-red-600 hover:text-white transition-all border border-red-100" title="حذف" aria-label="حذف المنتج"><i data-lucide="trash-2" size="14" class="md:w-4 md:h-4"></i></button>
                        ` : ''}
                    </div>

                    <!-- Product Image (Optimized & LCP Fixed) -->
                    <!-- UPDATED: Added width/height for CLS (4:5 Aspect Ratio) -->
                    <div class="absolute inset-0">
                        <img src="${optimizedImage}" 
                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-in-out ${!isInStock ? 'grayscale opacity-80' : ''}" 
                             ${forceEager ? 'fetchpriority="high" loading="eager"' : 'loading="lazy" decoding="async"'}
                             width="400" height="500" 
                             alt="${p.name}">
                    </div>

                    <!-- Add To Cart Button (Floating) (z-20) -->
                    ${isInStock ? `
                    <div class="hidden md:block absolute bottom-3 left-3 right-3 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 z-20">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-stone-900/90 backdrop-blur-sm text-white font-bold py-3 rounded-xl shadow-lg hover:bg-stone-900 transition-colors flex items-center justify-center gap-2 text-sm">
                            أضف إلى العربة
                        </button>
                    </div>
                    
                    <!-- Mobile Add Button (z-20) -->
                    <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="md:hidden absolute bottom-1.5 left-1.5 w-7 h-7 bg-stone-900/90 text-white rounded-full flex items-center justify-center shadow-md z-20" aria-label="أضف للسلة">
                        <i data-lucide="plus" size="14"></i>
                    </button>
                    ` : ''}
                </div>

                <!-- Info Section -->
                <div class="px-1 md:px-2 text-right flex flex-col gap-0.5 md:gap-1">
                    <!-- Title -->
                    <h3 class="text-stone-800 font-bold text-[10px] md:text-sm leading-tight line-clamp-2 h-7 md:h-auto group-hover:text-[#00796B] transition-colors" title="${p.name}">${p.name}</h3>
                    
                    <!-- Price (Increased Font Size: text-sm md:text-xl) -->
                    <div class="flex items-center justify-end gap-1 md:gap-2 mt-0.5 dir-ltr flex-wrap">
                        <span class="text-[#00796B] text-sm md:text-xl font-bold">${priceFormatted} <span class="text-[8px] md:text-xs text-[#00796B]">ج.م</span></span>
                        ${hasDiscount ? `<span class="text-stone-600 text-[9px] md:text-xs line-through decoration-stone-400 decoration-1">${originalPriceFormatted}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // Start
        init();
    </script>
</body>
</html>