<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدار - للديكورات الحديثة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .group:hover .mega-menu { display: block; animation: slideDown 0.3s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        .gallery-thumb.active { border-color: #d97706; box-shadow: 0 0 0 1px #d97706; }
    </style>
</head>
<!-- تم إضافة flex و min-h-screen هنا لإصلاح مشكلة الجليتش -->
<body class="bg-white text-stone-900 selection:bg-stone-200 overflow-x-hidden flex flex-col min-h-screen">

    <!-- Navigation -->
    <!-- تم إزالة py-6 وإضافتها للعنصر الداخلي للتحكم بشكل أفضل في الموبايل -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-40 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center relative">
            <!-- تم إزالة زر القائمة الجانبية من هنا -->

            <!-- تم إضافة id="navbar-brand" هنا -->
            <div id="navbar-brand" onclick="setView('home')" class="cursor-pointer flex flex-col items-start leading-none group z-50 transition-all">
                <div class="text-2xl font-bold tracking-tight flex items-center gap-1">جدار<span class="text-stone-400 text-4xl leading-3">.</span></div>
                <span class="text-[0.65rem] text-stone-500 font-medium mt-1 tracking-wide">للديكورات الحديثة</span>
            </div>

            <div class="hidden md:flex gap-8 items-center h-full">
                <button onclick="setView('home')" class="nav-link hover:text-stone-500 transition-colors">الرئيسية</button>
                
                <div class="group h-full flex items-center">
                    <button onclick="setView('categories')" class="nav-link hover:text-stone-500 transition-colors py-2 flex items-center gap-1 group-hover:text-stone-900">الأقسام <i data-lucide="chevron-down" size="14" class="group-hover:rotate-180 transition-transform duration-300"></i></button>
                    
                    <!-- Modern Mega Menu -->
                    <div class="mega-menu hidden absolute top-full left-0 w-full bg-white/95 backdrop-blur-2xl shadow-[0_30px_60px_-15px_rgba(0,0,0,0.1)] border-t border-stone-100 z-40 mt-0 transition-all duration-300">
                        <div class="container mx-auto p-8">
                            <div class="flex gap-12">
                                <!-- Sidebar: Categories List -->
                                <div class="w-1/4 flex flex-col justify-between border-l border-stone-100 pl-8 min-h-[300px]">
                                    <div>
                                        <h3 class="font-bold text-lg text-stone-900 flex items-center gap-3 mb-6">
                                            <span class="w-8 h-8 rounded-lg bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="grid" size="18"></i></span>
                                            تصفح الأقسام
                                        </h3>
                                        <ul class="space-y-1" id="mega-menu-categories-list">
                                            <!-- Dynamic List -->
                                        </ul>
                                    </div>
                                    
                                    <button onclick="viewAllProducts()" class="mt-6 w-full py-3.5 rounded-xl bg-stone-900 text-white font-bold text-sm hover:bg-stone-800 transition-all flex items-center justify-center gap-2 shadow-lg shadow-stone-200 group/btn">
                                        عرض كل المنتجات <i data-lucide="arrow-left" size="16" class="group-hover/btn:-translate-x-1 transition-transform"></i>
                                    </button>
                                </div>

                                <!-- Main Content: Featured Categories Grid -->
                                <div class="w-3/4">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="font-bold text-stone-400 text-xs uppercase tracking-widest">أقسام مختارة</h3>
                                        <a href="#/categories" onclick="setView('categories')" class="text-xs font-bold text-stone-900 hover:text-blue-600 transition-colors flex items-center gap-1">عرض الكل <i data-lucide="arrow-left" size="12"></i></a>
                                    </div>
                                    <!-- UPDATED: grid-cols-4 and gap-4 -->
                                    <div id="mega-menu-popular-list" class="grid grid-cols-4 gap-4 h-full">
                                        <!-- Dynamic Cards -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="setView('offers')" class="nav-link hover:text-red-600 transition-colors font-bold text-red-500 flex items-center gap-1"><i data-lucide="flame" size="16"></i> العروض</button>
                <button onclick="setView('shop')" class="nav-link hover:text-stone-500 transition-colors">التسوق</button>
                <button onclick="setView('track-order')" class="nav-link hover:text-stone-500 transition-colors flex items-center gap-1 text-green-600 font-medium"><i data-lucide="package-search" size="16"></i> تتبع طلبك</button>
                <button onclick="setView('contact')" class="nav-link hover:text-stone-500 transition-colors">تواصل معنا</button>
            </div>

            <div class="flex items-center gap-1 z-50">
                <!-- Smart Search Bar -->
                <!-- تم إزالة hidden md:block ليظهر على جميع الشاشات -->
                <div id="top-search-wrapper" class="relative block ml-1">
                    <div id="top-search-bar" class="flex items-center bg-stone-50 rounded-full w-10 h-10 transition-all duration-300 ease-out overflow-hidden border border-transparent cursor-pointer hover:bg-stone-100" onclick="toggleTopSearch(event)">
                        <button class="w-10 h-10 flex items-center justify-center text-stone-600 hover:text-stone-900 shrink-0">
                            <i data-lucide="search" size="20"></i>
                        </button>
                        <input 
                            id="top-search-input" 
                            type="text" 
                            class="w-full h-full bg-transparent border-none outline-none text-sm px-2 text-stone-700 opacity-0 transition-opacity duration-200" 
                            placeholder="ابحث عن منتج..."
                            onkeydown="handleGlobalSearch(event)"
                            onclick="event.stopPropagation()" 
                            autocomplete="off"
                        >
                    </div>
                </div>

                <!-- Favorites Button (Updated Action) -->
                <!-- تم إزالة hidden sm:block لتظهر الأيقونة على الموبايل أيضاً -->
                <button onclick="setView('favorites')" class="relative p-2 hover:bg-stone-100 rounded-full text-stone-600 hover:text-stone-900 transition-colors" title="المفضلة">
                    <i data-lucide="heart"></i>
                    <span id="fav-badge" class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full hidden shadow-sm border border-white"></span>
                </button>
                
                <!-- User Icon Logic -->
                <div class="relative group/user" id="user-menu-container">
                    <!-- Injected via JS based on auth state -->
                </div>

                <button onclick="toggleCart(true)" class="relative p-2 hover:bg-stone-100 rounded-full"><i data-lucide="shopping-bag"></i><span id="cart-badge" class="absolute top-0 right-0 h-5 w-5 bg-stone-900 text-white text-xs flex items-center justify-center rounded-full hidden">0</span></button>
            </div>
        </div>

        <!-- NEW: Mobile Horizontal Scroll Menu (القائمة الأفقية للموبايل) -->
        <div class="md:hidden w-full overflow-x-auto scrollbar-hide border-t border-stone-100 bg-white">
            <!-- تم التعديل: تصغير الحجم والمسافات لأقصى حد (text-[9px], py-1) -->
            <div class="flex items-center justify-center min-w-full w-fit mx-auto px-2 py-1 gap-3 text-[9px] font-bold text-stone-600">
                <button onclick="setView('home')" class="hover:text-stone-900 transition-colors whitespace-nowrap">الرئيسية</button>
                <button onclick="setView('categories')" class="flex items-center gap-0.5 hover:text-stone-900 transition-colors whitespace-nowrap">الأقسام <i data-lucide="chevron-down" size="10"></i></button>
                <button onclick="setView('offers')" class="flex items-center gap-0.5 text-red-500 hover:text-red-600 transition-colors whitespace-nowrap"><i data-lucide="flame" size="10"></i> العروض</button>
                <button onclick="setView('shop')" class="hover:text-stone-900 transition-colors whitespace-nowrap">التسوق</button>
                <button onclick="setView('track-order')" class="flex items-center gap-0.5 text-green-600 hover:text-green-700 transition-colors whitespace-nowrap"><i data-lucide="package-search" size="10"></i> تتبع طلبك</button>
                <button onclick="setView('contact')" class="hover:text-stone-900 transition-colors whitespace-nowrap">تواصل معنا</button>
            </div>
        </div>

        <div id="mobile-menu" class="absolute top-full left-0 w-full bg-white shadow-lg hidden flex-col border-t border-stone-100 h-screen overflow-y-auto pb-20">
            <div id="mobile-user-section" class="p-4 bg-stone-50 mb-2">
                <!-- Mobile User Info Injected Here -->
            </div>
            <button onclick="setView('home'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">الرئيسية</button>
            <div class="border-b border-stone-50">
                <button onclick="document.getElementById('mobile-cats').classList.toggle('hidden')" class="w-full py-4 text-center hover:bg-stone-50 flex items-center justify-center gap-2">الأقسام <i data-lucide="chevron-down" size="14"></i></button>
                <div id="mobile-cats" class="hidden bg-stone-50 py-2"><div id="mobile-cats-list"></div></div>
            </div>
            <button onclick="setView('offers'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50 font-bold text-red-500">العروض والخصومات</button>
            <button onclick="setView('shop'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">التسوق</button>
            <button onclick="setView('track-order'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50 text-green-600 font-bold">تتبع طلبك</button>
            <button onclick="setView('about'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">من نحن</button>
            <button onclick="setView('contact'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">تواصل معنا</button>
            <div class="flex justify-center gap-6 py-6 mt-auto" id="mobile-admin-link">
                <!-- Admin link injected here if admin -->
            </div>
        </div>
    </nav>

    <!-- NEW LOCATION: Header Banner (Below Fixed Nav) -->
    <!-- تم تعديل الهامش العلوي mt من 98px إلى 94px ليناسب القائمة الأصغر -->
    <div id="header-banner-container" class="w-full z-30 transition-all duration-300 hidden mt-[94px] md:mt-[88px]"></div>

    <!-- تم إضافة flex-grow هنا لدفع الـ Footer للأسفل دائماً -->
    <main id="main-content" class="flex-grow"></main>

    <!-- Drawers & Modals -->
    <div id="cart-drawer-backdrop" onclick="toggleCart(false)" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="cart-drawer" class="fixed top-0 left-0 h-full w-full sm:w-[450px] bg-white z-50 shadow-2xl transform -translate-x-full transition-transform duration-500 cubic-bezier(0.4, 0, 0.2, 1) flex flex-col border-r border-stone-100">
        <!-- Modern Header -->
        <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-white z-10">
            <div>
                <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2">عربة التسوق</h2>
                <p class="text-xs text-stone-500 mt-1">راجع طلباتك قبل الدفع</p>
            </div>
            <button onclick="toggleCart(false)" class="w-10 h-10 bg-stone-50 hover:bg-stone-100 rounded-full flex items-center justify-center transition-colors text-stone-500 hover:text-stone-900"><i data-lucide="x" size="20"></i></button>
        </div>
        
        <!-- 5️⃣ Stepper Placeholder (Cart - Step 1) -->
        <div id="cart-stepper" class="px-6 pt-6 bg-white"></div>

        <!-- Items Container -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-5 bg-stone-50/30 custom-scrollbar"></div>
        
        <!-- Modern Footer -->
        <div id="cart-footer" class="p-6 border-t border-stone-100 bg-white space-y-4 hidden z-10 shadow-[0_-10px_60px_-15px_rgba(0,0,0,0.1)]">
            <div class="space-y-3">
                <div class="flex justify-between items-center text-sm font-medium text-stone-500"><span>عدد المنتجات</span><span id="cart-count-summary" class="font-bold text-stone-900 bg-stone-100 px-2 py-0.5 rounded text-xs">0</span></div>
                <div class="flex justify-between items-center">
                    <span class="text-lg font-bold text-stone-900">الإجمالي</span>
                    <span id="cart-total" class="text-2xl font-serif font-bold text-stone-900">$0.00</span>
                </div>
                <p class="text-[10px] text-stone-400 text-center bg-stone-50 p-2 rounded-lg border border-stone-100"><i data-lucide="info" size="10" class="inline mb-0.5"></i> الشحن والضرائب تحسب عند إتمام الطلب</p>
            </div>
            <button onclick="checkout()" class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-3 group text-lg">
                <span>إتمام الشراء</span>
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:translate-x-1 transition-transform">
                    <i data-lucide="arrow-left" size="18"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- REMOVED OLD FAVORITE DRAWER -->

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 transition-all duration-500 translate-y-12 opacity-0 pointer-events-none bg-stone-900 text-white px-6 py-3 rounded shadow-lg text-sm font-medium"></div>

    <!-- Checkout Modal -->
    <div id="checkout-modal-backdrop" onclick="toggleCheckoutModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    
    <!-- FIX: Added max-h-[90vh] and overflow-y-auto to fix height issue -->
    <div id="checkout-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white rounded-3xl shadow-2xl z-50 opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-4 sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="shopping-bag" class="text-stone-900"></i> إتمام الطلب</h2>
            <button onclick="toggleCheckoutModal(false)" class="text-stone-400 hover:text-red-500 transition-colors p-1 bg-stone-50 rounded-full"><i data-lucide="x"></i></button>
        </div>
        
        <!-- 5️⃣ Stepper Placeholder (Checkout - Step 2) -->
        <div id="checkout-stepper" class="mb-6"></div>

        <form onsubmit="handlePlaceOrder(event)" class="space-y-5">
            
            <!-- 2️⃣ Smart Copywriting: Trust Message -->
            <div class="flex items-start gap-3 bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                <div class="bg-white p-1.5 rounded-full shadow-sm text-green-600 mt-0.5">
                    <i data-lucide="lock" size="14"></i>
                </div>
                <div>
                    <p class="text-xs font-bold text-stone-700">بياناتك محمية ولن تُستخدم إلا لتأكيد الطلب</p>
                    <p class="text-[10px] text-stone-500 mt-0.5">نحن نحترم خصوصيتك ولا نشارك بياناتك مع أي طرف ثالث.</p>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Customer Details -->
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">الاسم بالكامل <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input name="customerName" required class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400" placeholder="الاسم ثلاثي">
                        <i data-lucide="user" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم الهاتف <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input name="customerPhone" type="tel" maxlength="11" required class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400" placeholder="01xxxxxxxxx">
                        <i data-lucide="phone" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                    <p class="text-[10px] text-stone-400 mt-1 mr-1">يجب أن يكون 11 رقم (010, 011, 012, 015)</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">العنوان بالتفصيل <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <textarea id="checkout-address" name="customerAddress" oninput="calculateCheckoutTotal()" required rows="2" class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400 resize-none" placeholder="المحافظة - المدينة - الشارع - رقم المنزل"></textarea>
                        <i data-lucide="map-pin" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                </div>
                
                <!-- Delivery Checkbox -->
                <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 flex items-center gap-3">
                    <input type="checkbox" id="delivery-check" onchange="calculateCheckoutTotal()" class="w-5 h-5 accent-stone-900 rounded cursor-pointer">
                    <label for="delivery-check" class="text-sm font-bold text-stone-700 cursor-pointer select-none">أريد توصيل الطلب إلى عنواني</label>
                </div>

                <!-- Payment Method Selection -->
                <div class="pt-2">
                    <label class="block text-xs font-bold text-stone-500 mb-2 uppercase tracking-wider">طريقة الدفع</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer group">
                            <input type="radio" name="paymentMethod" value="cod" class="peer sr-only" checked onchange="updatePaymentUI()">
                            <div class="p-3 rounded-xl border-2 border-stone-100 bg-white peer-checked:border-stone-900 peer-checked:bg-stone-50 transition-all flex flex-col items-center gap-2 text-center h-full relative overflow-hidden group-hover:border-stone-300">
                                <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 peer-checked:bg-stone-900 peer-checked:text-white transition-colors">
                                    <i data-lucide="banknote" size="20"></i>
                                </div>
                                <span class="text-xs font-bold text-stone-700">دفع عند الاستلام</span>
                                <div class="absolute top-2 right-2 w-4 h-4 rounded-full border border-stone-300 peer-checked:border-stone-900 peer-checked:bg-stone-900 flex items-center justify-center transition-all">
                                    <i data-lucide="check" size="10" class="text-white opacity-0 peer-checked:opacity-100"></i>
                                </div>
                            </div>
                        </label>
                        
                        <label class="cursor-pointer group">
                            <input type="radio" name="paymentMethod" value="vodafone_cash" class="peer sr-only" onchange="updatePaymentUI()">
                            <div class="p-3 rounded-xl border-2 border-stone-100 bg-white peer-checked:border-red-600 peer-checked:bg-red-50 transition-all flex flex-col items-center gap-2 text-center h-full relative overflow-hidden group-hover:border-red-200">
                                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 peer-checked:bg-red-600 peer-checked:text-white transition-colors">
                                    <i data-lucide="smartphone" size="20"></i>
                                </div>
                                <span class="text-xs font-bold text-stone-700 peer-checked:text-red-700">المحافظ الإلكترونية</span>
                                <div class="absolute top-2 right-2 w-4 h-4 rounded-full border border-stone-300 peer-checked:border-red-600 peer-checked:bg-red-600 flex items-center justify-center transition-all">
                                    <i data-lucide="check" size="10" class="text-white opacity-0 peer-checked:opacity-100"></i>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- 4️⃣ Partial Payment Option (Hidden by default) -->
                    <div id="partial-payment-option" class="hidden mt-3 bg-orange-50 p-3 rounded-xl border border-orange-100 animate-in fade-in slide-in-from-top-2">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <div class="relative flex items-center">
                                <input type="checkbox" name="isPartial" id="isPartial" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-orange-300 bg-white checked:bg-orange-500 checked:border-orange-500 transition-all" onchange="updatePaymentUI()">
                                <i data-lucide="check" size="14" class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                            </div>
                            <div class="flex-1">
                                <span class="block text-sm font-bold text-stone-800 group-hover:text-orange-700 transition-colors">دفع عربون فقط (جدية حجز)</span>
                                <p class="text-[10px] text-stone-500 mt-0.5">ادفع 50% من المبلغ الآن لتأكيد الطلب، وادفع الباقي عند الاستلام.</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="bg-stone-50 p-5 rounded-2xl border border-stone-100 flex items-center justify-between">
                <div>
                    <p class="text-xs text-stone-500 font-bold mb-1">إجمالي المبلغ المطلوب</p>
                    <p id="delivery-note" class="text-[10px] text-blue-600 font-bold hidden"></p>
                </div>
                <div class="text-right">
                    <span id="checkout-total-display" class="block text-2xl font-serif font-bold text-stone-900">$0.00</span>
                    <span id="payment-method-label" class="inline-block bg-stone-200 text-stone-700 text-[10px] px-2 py-0.5 rounded font-bold">دفع عند الاستلام</span>
                </div>
            </div>

            <!-- 1️⃣ Trust Badge (شارة الأمان في الدفع) -->
            <div class="bg-green-50 border border-green-200 rounded-xl p-3 flex items-center justify-center gap-2 text-xs font-bold text-green-800 shadow-sm">
                <i data-lucide="shield-check" size="16"></i>
                <span>الدفع يتم تأكيده يدويًا – أمان 100%</span>
            </div>

            <button type="submit" class="w-full bg-stone-900 text-white py-4 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2 group">
                <span>تأكيد وإرسال الطلب</span>
                <i data-lucide="arrow-left" class="group-hover:-translate-x-1 transition-transform"></i>
            </button>
        </form>
    </div>

    <!-- Vodafone Cash Modal (NEW) -->
    <div id="vodafone-modal-backdrop" onclick="toggleVodafoneModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[55] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="vodafone-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[55] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-0 overflow-hidden">
        <!-- Header -->
        <div class="bg-[#E60000] p-6 text-white text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-8 -mb-8 blur-xl"></div>
            
            <div class="relative z-10">
                <h2 class="text-2xl font-bold mb-1">الدفع عبر المحافظ الإلكترونية</h2>
                <p class="text-white/80 text-xs">أسهل وأسرع طريقة للدفع</p>
            </div>
            <button onclick="toggleVodafoneModal(false)" class="absolute top-4 left-4 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-1 transition-colors"><i data-lucide="x" size="20"></i></button>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- 5️⃣ Stepper Placeholder (Payment - Step 3) -->
            <div id="vodafone-stepper" class="-mt-2 mb-4"></div>

            <!-- Amount Display -->
            <div class="text-center">
                <p class="text-xs text-stone-500 font-bold uppercase tracking-wider mb-2">المبلغ المطلوب تحويله</p>
                <div class="inline-block bg-stone-50 border border-stone-200 rounded-2xl px-6 py-3">
                    <span id="vc-amount" class="text-3xl font-serif font-black text-stone-900">0.00</span>
                </div>
            </div>

            <!-- Number Display -->
            <div class="bg-red-50 border border-red-100 rounded-xl p-4 flex items-center justify-between group cursor-pointer hover:bg-red-100 transition-colors relative" onclick="navigator.clipboard.writeText('01064009655'); showToast('تم نسخ الرقم')">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#E60000] shadow-sm">
                        <i data-lucide="smartphone" size="20"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-red-600 font-bold mb-0.5">رقم المحفظة</p>
                        <p class="text-xl font-bold text-stone-900 dir-ltr font-mono tracking-wider">01064009655</p>
                    </div>
                </div>
                <div class="text-stone-400 group-hover:text-stone-600 transition-colors">
                    <i data-lucide="copy" size="20"></i>
                </div>
                <div class="absolute -top-2 right-4 bg-white border border-red-100 text-[10px] text-red-600 px-2 py-0.5 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity">اضغط للنسخ</div>
            </div>

            <!-- Steps -->
            <div>
                <h4 class="font-bold text-stone-900 mb-4 flex items-center gap-2 text-sm">
                    <i data-lucide="list-ordered" size="16" class="text-stone-400"></i> خطوات التحويل:
                </h4>
                <ul class="space-y-3 relative before:content-[''] before:absolute before:right-[15px] before:top-2 before:bottom-2 before:w-0.5 before:bg-stone-100 text-sm">
                    <li class="relative pr-8 flex items-start">
                        <span class="absolute right-0 top-0 w-8 h-8 bg-stone-50 border border-stone-200 rounded-full flex items-center justify-center text-xs font-bold text-stone-600 z-10">1</span>
                        <p class="text-stone-600 leading-tight pt-1.5">اطلب <span class="font-bold text-stone-900 dir-ltr bg-stone-100 px-1 rounded inline-block">*9*7#</span> أو استخدم تطبيق "المحفظة الإلكترونية".</p>
                    </li>
                    <li class="relative pr-8 flex items-start">
                        <span class="absolute right-0 top-0 w-8 h-8 bg-stone-50 border border-stone-200 rounded-full flex items-center justify-center text-xs font-bold text-stone-600 z-10">2</span>
                        <p class="text-stone-600 leading-tight pt-1.5">اختر <span class="font-bold text-stone-900">تحويل أموال</span> وأدخل الرقم الموضح أعلاه.</p>
                    </li>
                    <li class="relative pr-8 flex items-start">
                        <span class="absolute right-0 top-0 w-8 h-8 bg-stone-50 border border-stone-200 rounded-full flex items-center justify-center text-xs font-bold text-stone-600 z-10">3</span>
                        <p class="text-stone-600 leading-tight pt-1.5">أدخل المبلغ: <span id="vc-amount-step" class="font-bold text-stone-900 font-serif">0</span> وأكد العملية.</p>
                    </li>
                    <li class="relative pr-8 flex items-start">
                        <span class="absolute right-0 top-0 w-8 h-8 bg-stone-50 border border-stone-200 rounded-full flex items-center justify-center text-xs font-bold text-stone-600 z-10">4</span>
                        <p class="text-stone-600 leading-tight pt-1.5">بعد التحويل، احتفظ برسالة التأكيد أو لقطة الشاشة.</p>
                    </li>
                </ul>
            </div>

            <!-- Confirmation Action -->
            <input type="hidden" id="vc-order-id-hidden">
            <button onclick="confirmVodafonePayment()" class="w-full bg-[#E60000] hover:bg-[#cc0000] text-white py-4 rounded-xl font-bold transition-all shadow-lg hover:shadow-red-200 flex justify-center items-center gap-2">
                <span>لقد أتممت الدفع</span>
                <i data-lucide="check-circle" size="18"></i>
            </button>
            <p class="text-center text-[10px] text-stone-400 mt-2">لن يتم تأكيد الطلب إلا بعد مراجعة التحويل يدويًا خلال 30 دقيقة</p>
        </div>
    </div>

    <!-- Vodafone Payment Confirmation Form Modal (NEW) -->
    <div id="vc-confirm-modal-backdrop" onclick="toggleVcConfirmModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="vc-confirm-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="file-check" class="text-[#E60000]"></i> تأكيد بيانات الدفع</h2>
            <button onclick="toggleVcConfirmModal(false)" class="text-stone-400 hover:text-red-500 transition-colors p-1 bg-stone-50 rounded-full"><i data-lucide="x"></i></button>
        </div>
        
        <!-- 5️⃣ Stepper Placeholder (Payment Confirm - Step 3) -->
        <div id="vc-confirm-stepper" class="mb-6"></div>

        <!-- تم إضافة id="vc-confirm-form" و oninput="validateVcForm()" -->
        <form id="vc-confirm-form" onsubmit="handleVcConfirmSubmit(event)" oninput="validateVcForm()" onchange="validateVcForm()" class="space-y-4">
            <input type="hidden" id="vc-confirm-order-id">
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-xs text-blue-800 mb-2 flex gap-2 items-start">
                <i data-lucide="info" size="14" class="mt-0.5 shrink-0"></i>
                <p>ساعدنا في تأكيد طلبك بسرعة من خلال إرفاق بيانات التحويل الصحيحة.</p>
            </div>

            <!-- حقل رفع الصورة الجديد (Client-side Compression) -->
            <div class="bg-stone-50 p-3 rounded-xl border border-stone-200 border-dashed hover:bg-stone-100 transition-colors relative group">
                <label class="block text-xs font-bold text-stone-600 mb-2 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="image" size="14"></i> صورة التحويل (سكرين شوت) <span class="text-red-500">*</span>
                </label>
                <input type="file" name="receiptImage" accept="image/*" required class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-stone-900 file:text-white hover:file:bg-stone-800 cursor-pointer">
                <p class="text-[10px] text-stone-400 mt-2">يرجى رفع صورة واضحة لرسالة تأكيد التحويل (سيتم ضغطها تلقائياً لتقليل استهلاك البيانات).</p>
                
                <!-- علامة صح تظهر عند رفع الصورة -->
                <div id="img-check-indicator" class="absolute top-3 left-3 text-green-500 hidden animate-bounce">
                    <i data-lucide="check-circle" size="20"></i>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">الاسم بالكامل (صاحب المحفظة) <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input name="senderName" required class="w-full border border-stone-200 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors text-sm font-bold text-stone-800">
                    <i data-lucide="user" class="absolute left-3 top-3.5 text-stone-400" size="16"></i>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم الموبايل المحول منه <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input name="senderPhone" type="tel" maxlength="11" required class="w-full border border-stone-200 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors text-sm font-bold text-stone-800 dir-ltr text-right" placeholder="01xxxxxxxxx">
                    <i data-lucide="smartphone" class="absolute left-3 top-3.5 text-stone-400" size="16"></i>
                </div>
                <p class="text-[10px] text-stone-400 mt-1 mr-1">يجب أن يكون 11 رقم (010, 011, 012, 015)</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">المبلغ المدفوع <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input name="amountPaid" type="number" step="0.01" required class="w-full border border-stone-200 p-3 pl-8 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors text-sm font-bold text-stone-800">
                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">$</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم العملية (اختياري)</label>
                    <input name="transactionId" class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors text-sm font-bold text-stone-800" placeholder="Transaction ID">
                </div>
            </div>

            <!-- تم تعديل الزر: إضافة id="vc-submit-btn" و disabled و تنسيق باهت -->
            <button type="submit" id="vc-submit-btn" disabled class="w-full bg-stone-400 text-white/80 py-4 rounded-xl font-bold cursor-not-allowed transition-all shadow-none mt-4 flex justify-center items-center gap-2">
                <span>تأكيد وإرسال للمراجعة</span>
                <i data-lucide="check" size="18"></i>
            </button>
            <p id="vc-form-hint" class="text-center text-[10px] text-red-500 font-bold animate-pulse">يرجى رفع الصورة وملء البيانات لتفعيل الزر</p>
        </form>
    </div>

    <!-- Edit Order Modal (NEW) -->
    <div id="edit-order-modal-backdrop" onclick="toggleEditOrderModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="edit-order-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="pen-line" class="text-blue-600"></i> تعديل الطلب</h2>
            <button onclick="toggleEditOrderModal(false)" class="text-stone-400 hover:text-red-500 transition-colors p-1 bg-stone-50 rounded-full"><i data-lucide="x"></i></button>
        </div>
        
        <form onsubmit="handleUpdateOrder(event)" id="edit-order-form" class="space-y-5">
            <input type="hidden" name="orderId">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">اسم العميل</label>
                    <input name="customerName" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم الهاتف</label>
                    <input name="customerPhone" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">العنوان</label>
                    <textarea name="customerAddress" required rows="2" class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors"></textarea>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                     <label class="block text-xs font-bold text-blue-800 mb-1.5 uppercase tracking-wider">الإجمالي (تعديل يدوي)</label>
                     <div class="relative">
                        <input name="totalAmount" type="number" step="0.01" required class="w-full border border-blue-200 p-3 pl-8 rounded-xl focus:ring-2 focus:ring-blue-600 outline-none bg-white font-bold text-stone-900">
                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">$</span>
                     </div>
                     <p class="text-[10px] text-blue-600 mt-2">تنبيه: تغيير هذا الرقم لا يؤثر على أسعار المنتجات الفردية، بل يغير إجمالي الفاتورة فقط.</p>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg flex justify-center items-center gap-2">
                <i data-lucide="save"></i> <span>حفظ التعديلات</span>
            </button>
        </form>
    </div>
    <!-- Order Success Modal (UPDATED) -->
    <div id="success-modal-backdrop" onclick="toggleSuccessModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="success-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-8 text-center">
        
        <!-- 5️⃣ Stepper Placeholder (Success - Step 4) -->
        <div id="success-stepper" class="mb-8"></div>

        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm animate-bounce">
            <i data-lucide="check" size="40"></i>
        </div>
        <!-- Added IDs here -->
        <h2 id="success-title" class="text-2xl font-bold text-stone-900 mb-2">تم استلام طلبك بنجاح!</h2>
        <div id="success-desc" class="text-stone-500 text-sm mb-6">شكراً لثقتك بنا. يرجى الاحتفاظ برقم الطلب لتتبع حالة الشحنة.</div>
        
        <div class="bg-stone-50 p-4 rounded-xl border border-stone-200 mb-6 relative group cursor-pointer hover:bg-stone-100 transition-colors" onclick="copyOrderId()">
            <p class="text-xs text-stone-400 font-bold uppercase tracking-wider mb-1">رقم الطلب (اضغط للنسخ)</p>
            <p id="success-order-id" class="text-xl font-mono font-bold text-stone-800 tracking-wider select-all">Loading...</p>
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 group-hover:text-stone-900 transition-colors">
                <i data-lucide="copy" size="20"></i>
            </div>
        </div>

        <button onclick="toggleSuccessModal(false); setView('track-order')" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl mb-3 flex items-center justify-center gap-2">
            <i data-lucide="package-search" size="18"></i> تتبع حالة الطلب الآن
        </button>
        <button onclick="toggleSuccessModal(false)" class="w-full text-stone-500 font-bold py-2 hover:text-stone-900">
            متابعة التسوق
        </button>
    </div>

    <!-- Request Modification Modal (NEW Feature) -->
    <div id="mod-modal-backdrop" onclick="toggleModModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="mod-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="edit-3" class="text-orange-500"></i> طلب تعديل</h3>
            <button onclick="toggleModModal(false)"><i data-lucide="x" class="text-stone-400 hover:text-stone-900"></i></button>
        </div>
        <form onsubmit="handleSubmitModRequest(event)">
            <input type="hidden" name="orderId" id="mod-order-id">
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-4 text-xs text-blue-700 leading-relaxed">
                <i data-lucide="info" size="14" class="inline mb-0.5"></i> يرجى كتابة التعديلات المطلوبة بوضوح (مثلاً: تغيير العنوان، تغيير رقم الهاتف، إلغاء منتج). سيقوم فريقنا بمراجعة الطلب وتنفيذه إن أمكن.
            </div>
            <textarea name="message" required rows="4" class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-stone-900 outline-none mb-4 bg-stone-50 focus:bg-white transition-all placeholder:text-stone-400" placeholder="اكتب تفاصيل التعديل هنا..."></textarea>
            <button type="submit" class="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg">إرسال الطلب للإدارة</button>
        </form>
    </div>

    <!-- NEW: Custom WhatsApp Message Modal -->
    <div id="wa-modal-backdrop" onclick="toggleWaModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[70] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="wa-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[70] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="message-circle" class="text-[#25D366]"></i> مراسلة العميل</h3>
            <button onclick="toggleWaModal(false)"><i data-lucide="x" class="text-stone-400 hover:text-stone-900"></i></button>
        </div>
        <div class="space-y-4">
            <input type="hidden" id="wa-target-phone">
            
            <div class="flex gap-2 mb-2 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="setWaTemplate('confirm')" class="text-[10px] bg-green-50 text-green-700 px-3 py-1.5 rounded-full border border-green-200 hover:bg-green-100 whitespace-nowrap transition-colors">قالب تأكيد</button>
                <button onclick="setWaTemplate('shipping')" class="text-[10px] bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-200 hover:bg-blue-100 whitespace-nowrap transition-colors">قالب شحن</button>
                <button onclick="setWaTemplate('address')" class="text-[10px] bg-orange-50 text-orange-700 px-3 py-1.5 rounded-full border border-orange-200 hover:bg-orange-100 whitespace-nowrap transition-colors">تأكيد عنوان</button>
                <button onclick="setWaTemplate('empty')" class="text-[10px] bg-stone-50 text-stone-700 px-3 py-1.5 rounded-full border border-stone-200 hover:bg-stone-100 whitespace-nowrap transition-colors">فارغ</button>
            </div>

            <div>
                <label class="block text-xs font-bold text-stone-500 mb-1.5">نص الرسالة (قابل للتعديل)</label>
                <textarea id="wa-message-input" rows="8" class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-[#25D366] outline-none bg-stone-50 focus:bg-white transition-all placeholder:text-stone-400 font-medium text-stone-700 leading-relaxed"></textarea>
            </div>
            <button onclick="sendCustomWhatsApp()" class="w-full bg-[#25D366] text-white py-3.5 rounded-xl font-bold hover:bg-[#1da851] transition-all shadow-lg flex justify-center gap-2 items-center group">
                <span>فتح في واتساب</span>
                <i data-lucide="send" size="18" class="group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- Modern Light Footer -->
    <footer class="bg-stone-50 text-stone-600 py-16 mt-auto border-t border-stone-200 font-light relative overflow-hidden">
        <!-- Background Elements (Light Theme) -->
        <div class="absolute top-0 right-0 w-96 h-96 bg-stone-200/40 rounded-full blur-3xl -mr-40 -mt-40 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-stone-200/40 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none"></div>

        <div class="container mx-auto px-6 relative z-10">
            <!-- Newsletter Section (Light) -->
            <div class="flex flex-col md:flex-row justify-between items-center bg-white p-8 rounded-3xl mb-16 border border-stone-200 shadow-sm">
                <div class="mb-6 md:mb-0 md:w-1/2">
                    <h3 class="text-stone-900 text-2xl font-bold mb-2 flex items-center gap-2"><i data-lucide="mail" class="text-stone-400"></i> انضم لنشرتنا البريدية</h3>
                    <p class="text-stone-500 text-sm">كن أول من يعرف عن العروض الحصرية والمنتجات الجديدة.</p>
                </div>
                <div class="w-full md:w-1/2 flex gap-2">
                    <input type="email" placeholder="بريدك الإلكتروني" class="w-full bg-stone-50 border border-stone-200 text-stone-900 px-5 py-3.5 rounded-xl focus:outline-none focus:border-stone-400 transition-colors placeholder:text-stone-400">
                    <button class="bg-stone-900 text-white px-6 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-colors whitespace-nowrap shadow-lg hover:shadow-xl hover:-translate-y-0.5 transform">اشترك</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 lg:gap-8 mb-16 border-b border-stone-200 pb-12">
                <!-- Brand Info -->
                <div class="space-y-6">
                    <!-- تم إضافة id="footer-brand" هنا -->
                    <div id="footer-brand">
                        <div class="text-3xl font-bold text-stone-900 tracking-tighter flex items-center gap-1">جدار<span class="text-stone-400 text-5xl leading-3">.</span></div>
                    </div>
                    <p class="text-sm leading-relaxed max-w-xs text-stone-500">
                        نحول مساحتك العادية إلى تحفة فنية. وجهتك الأولى لأحدث صيحات الديكور وتجاليد الحوائط في مصر بجودة لا تضاهى.
                    </p>
                    <div class="flex gap-3">
                        <a href="https://www.facebook.com/gedar.fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#1877F2] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#1877F2] text-stone-500">
                            <i data-lucide="facebook" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://www.instagram.com/gedar_fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#E4405F] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#E4405F] text-stone-500">
                            <i data-lucide="instagram" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://wa.me/201014175070" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#25D366] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#25D366] text-stone-500">
                            <i data-lucide="message-circle" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">التسوق</h4>
                    <ul class="space-y-4 text-sm">
                        <li><button onclick="setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> كل المنتجات</button></li>
                        <li><button onclick="filterCategory('بديل الخشب'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> بديل الخشب</button></li>
                        <li><button onclick="filterCategory('بديل الرخام'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> بديل الرخام</button></li>
                        <li><button onclick="setView('offers')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> العروض والخصومات</button></li>
                    </ul>
                </div>

                <!-- Customer Support -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">خدمة العملاء</h4>
                    <ul class="space-y-4 text-sm">
                        <li><button onclick="setView('track-order')" class="hover:text-stone-900 transition-colors flex items-center gap-2 text-orange-600 font-bold group w-full text-right"><i data-lucide="package-search" size="16" class="group-hover:scale-110 transition-transform"></i> تتبع طلبك</button></li>
                        <li><button onclick="setView('contact')" class="hover:text-stone-900 transition-colors w-full text-right">اتصل بنا</button></li>
                        <li><button onclick="setView('faq')" class="hover:text-stone-900 transition-colors w-full text-right">الأسئلة الشائعة</button></li>
                        <li><button onclick="setView('return-policy')" class="hover:text-stone-900 transition-colors w-full text-right">سياسة الاسترجاع</button></li>
                    </ul>
                </div>

                <!-- Contact Details -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">معلومات التواصل</h4>
                    <ul class="space-y-6 text-sm">
                        <li class="flex items-start gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-500 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="map-pin" size="18"></i>
                            </div>
                            <span class="mt-1 leading-relaxed">الفيوم - نهاية شارع المستشفي العام إتجاه مديرية الأمن<br/><span class="text-stone-400 text-xs">بجوار المغسلة الامريكيه وامام مطعم ابو صلاح</span></span>
                        </li>
                        <li class="flex items-center gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-500 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="phone" size="18"></i>
                            </div>
                            <div class="flex flex-col">
                                <a href="tel:+201014175070" class="dir-ltr font-mono text-lg text-stone-900 font-bold tracking-wide hover:text-blue-600 transition-colors" title="اتصال هاتفي">01014175070</a>
                                <a href="https://wa.me/201014175070" target="_blank" class="text-[11px] font-bold text-green-600 hover:text-green-700 flex items-center gap-1 transition-colors">
                                    <i data-lucide="message-circle" size="12"></i> تواصل عبر واتساب
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 text-xs text-stone-500 border-t border-stone-200 pt-8">
                <p>&copy; 2024 متجر جدار للديكور. جميع الحقوق محفوظة.</p>
                
                <!-- Payment Methods Logos (Updated Image Size - Slightly Smaller) -->
                <div class="grayscale hover:grayscale-0 transition-all duration-500 opacity-80 hover:opacity-100">
                    <!-- تم تقليل الارتفاع قليلاً من h-20 md:h-32 إلى h-16 md:h-24 -->
                    <img src="https://www.abaqperfume.com/cdn/shop/files/e1U1c1LAEdAcgnmxYmwwqqmy4hHGZ7CJ8DpQIKXy_d883f005-45c0-4330-acf8-5ea9610acc15.png?v=1713207436&width=1100" class="h-16 md:h-24 w-auto object-contain" alt="طرق الدفع المتاحة">
                </div>
            </div>
        </div>
    </footer>

    <!-- REMOVED: Bottom Banner Container was here -->

    <!-- Firebase & Main Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // إضافة runTransaction هنا
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // إعدادات الإشعارات (هام جداً)
        // ==========================================
        // ضع رابط Google Apps Script Web App هنا بين علامات التنصيص
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw4EEcMqepu8I4Vvt6sf_8tVpbL98oGxzQPZoLxY_VuqkDuWOMwcR07MDtyeQG5t6LPxA/exec"; 
        
        // --- 🆕 إعدادات بوت واتساب (CallMeBot) ---
        // 1. احفظ الرقم "CallMeBot" في جهات اتصالك: +34 644 56 52 23
        // 2. أرسل له رسالة: "I allow callmebot to send me messages"
        // 3. سيصلك الـ API Key، ضعه بالأسفل:
        const BOT_PHONE = "201069913150"; // تم التحديث بناءً على بياناتك
        const BOT_API_KEY = "4918216"; // تم التحديث بناءً على بياناتك
        
        // Admin Configuration
        const ADMIN_EMAIL = 'gedar.fayoum@gmail.com';
        
        // Delivery Configuration
        const DELIVERY_AREAS = [
            "العبودي", "الإصلاح الزراعي", "المسلة", "رفعت عزمي", 
            "النويرى", "المستشفي العام", "دلة", "موقف مصر"
        ];
        const FIXED_DELIVERY_FEE = 70;

        // Global State
        let db, auth, appId, user;
        let CATEGORIES = [];
        let PRODUCTS = [];
        let ALL_REVIEWS = []; 
        let ALL_ORDERS = []; // NEW: Store orders
        let cart = [];
        let favorites = [];
        let isDataLoaded = false; // NEW: To handle direct link loading state
        // NEW: Global interval for countdowns
        let countdownInterval = null;
        let bannerScrollTimers = {}; // متغير لتخزين مؤقتات الحركة التلقائية
        
        // NEW: متغير لتتبع هل تم فتح السلة تلقائياً أم لا
        let hasAutoOpenedCart = false;

        // NEW: Lock flags to prevent double submission (تحسينات لازمة)
        let isOrderSubmitting = false;
        let isPaymentSubmitting = false;

        // خريطة حالات الطلب للنصوص العربية (للإشعارات)
        const STATUS_ARABIC_MAP = {
            'new': 'تم استلام الطلب',
            'pending_payment': 'بانتظار الدفع',
            'payment_review': 'جاري مراجعة الدفع',
            'confirmed': 'تم تأكيد الطلب والدفع',
            'processing': 'جاري تجهيز الطلب',
            'shipped': 'تم شحن الطلب',
            'delivered': 'تم توصيل الطلب بنجاح',
            'cancelled': 'تم إلغاء الطلب',
            'expired': 'منتهية الصلاحية (لم يتم الدفع)' // 3️⃣ New Status
        };

        // NEW: Hero Settings State (Initialized Empty)
        let HERO_SETTINGS = {
            mainImage: "",
            secondaryImage: "",
            priceLabel: "",
            priceValue: "",
            discountLabel: "",
            discountValue: "",
            logoUrl: "",
            logoSize: "100",
            // Image Configuration
            imageBaseUrl: "",
            imageDefaultExt: ".webp",
            // Header Banner Settings (Separate Mobile/Desktop)
            footerBannerUrl: "",
            fbHeightDesktop: "300", fbHeightMobile: "150",
            fbWidthDesktop: "90", fbWidthMobile: "95",
            fbRadiusDesktop: "2rem", fbRadiusMobile: "1rem",
            showFooterBanner: false,
            // Category Banner Settings (Separate Mobile/Desktop)
            categoryBannerUrl: "",
            catBanHeightDesktop: "250", catBanHeightMobile: "120",
            catBanWidthDesktop: "90", catBanWidthMobile: "95",
            catBanRadiusDesktop: "1.5rem", catBanRadiusMobile: "0.8rem",
            showCategoryBanner: false,
            // Other Banners
            bestSellerBannerUrl: "",
            bestSellerBannerHeight: "200",
            bestSellerBannerWidth: "100",
            showBestSellerBanner: false,
            featuredBannerUrl: "",
            featuredBannerHeight: "200",
            featuredBannerWidth: "100",
            showFeaturedBanner: false,
            showHeroMobile: true,
            showHeroDesktop: true
        };
        let currentView = 'home';
        let currentAdminTab = 'dashboard';
        let currentOrderTab = 'active'; 
        let currentProductId = null;
        let currentEditProduct = null;
        let currentEditCategoryName = null; // NEW: Track category being edited
        let shopState = { search: '', categories: [], priceMin: 0, priceMax: 10000, sort: 'featured' };
        
        // NEW: Admin Order Filter State
        let adminOrderFilter = 'all'; // all, pending, vodafone, today

        let detailsQuantity = 1;
        let activeImageIndex = 0;
        let currentSelectedColor = null; // متغير جديد لتخزين اللون المختار

        // --- NEW: Helper to check if discount is valid ---
        function isDiscountActive(p) {
            if (!p.discount || p.discount <= 0) return false;
            // If no expiry is set, discount is always active (permanent)
            if (!p.discountExpiry) return true;
            // Check if current time is before expiry
            return p.discountExpiry > Date.now();
        }

        // --- Init ---
        async function init() {
            lucide.createIcons();
            
            const firebaseConfig = {
                apiKey: "AIzaSyAQoLRMCHjOW_jWHtuYppSLxzaYhPZUj40",
                authDomain: "gedarwebsitenew.firebaseapp.com",
                projectId: "gedarwebsitenew",
                storageBucket: "gedarwebsitenew.firebasestorage.app",
                messagingSenderId: "164355005674",
                appId: "1:164355005674:web:ce33a2b8694c2e9507cb93",
                measurementId: "G-8FPJKYQT4X"
            };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            onAuthStateChanged(auth, (u) => {
                // Security Check: Enforce Owner Only for Google Sign-In
                // If user is signed in (not anon) AND email doesn't match admin, force logout.
                if (u && !u.isAnonymous && u.email !== ADMIN_EMAIL) {
                    signOut(auth).then(() => {
                        showToast("عذراً، هذا الحساب غير مصرح له بالدخول. الدخول للمالك فقط.");
                    });
                    return;
                }

                user = u;
                updateUserUI();
                
                if (user) {
                    setupDataListeners();
                } else {
                    signInAnonymously(auth).catch(err => console.error("Anon Auth Error:", err));
                }
            });

            const savedFavs = localStorage.getItem('aura_favorites');
            if (savedFavs) try { favorites = JSON.parse(savedFavs); updateFavoritesUI(); } catch(e) {}

            // NEW: Load Cart from LocalStorage
            const savedCart = localStorage.getItem('gedar_cart');
            if (savedCart) try { cart = JSON.parse(savedCart); updateCartUI(); } catch(e) {}

            // NEW: Listen for URL changes (Back/Forward buttons)
            window.addEventListener('hashchange', handleRouting);
            
            // NEW: Handle initial URL on page load
            handleRouting();
            
            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                // تم تعديل منطق الـ Scroll لإزالة الـ padding الزائد لأننا ثبتناه في الـ HTML
                if (window.scrollY > 20) {
                    nav.classList.add('shadow-md');
                } else {
                    nav.classList.remove('shadow-md');
                }
            });

            // Click outside to close search
            document.addEventListener('click', (e) => {
                const wrapper = document.getElementById('top-search-wrapper');
                if (wrapper && !wrapper.contains(e.target)) {
                    closeTopSearch();
                }
            });
        }

        function setupDataListeners() {
            const catDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store');
            onSnapshot(catDoc, (snap) => {
                if (snap.exists()) {
                    let cats = snap.data().categories || [];
                    // UPDATE: تصفية البيانات لإزالة أي قسم فاسد أو undefined
                    CATEGORIES = cats
                        .map(c => typeof c === 'string' ? { name: c, image: 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500' } : c)
                        .filter(c => c && c.name && c.name !== 'undefined' && c.name.trim() !== '');
                } else {
                    // Create empty metadata doc if not exists, but don't seed dummy data
                    setDoc(catDoc, { categories: [] });
                    CATEGORIES = [];
                }
                updateMegaMenu();
                if (currentView === 'shop' || currentView === 'categories' || currentView === 'admin') renderView();
            });

            const prodCol = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            onSnapshot(prodCol, (snap) => {
                // Completely removed default seeding logic
                // Now purely relies on what's in Firestore
                PRODUCTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                isDataLoaded = true; // Data is ready
                
                // Refresh view if we were waiting for data (e.g. direct product link)
                if (currentView === 'product-details' || currentView === 'home' || currentView === 'shop') renderView();
            });

            const reviewsCol = collection(db, 'artifacts', appId, 'public', 'data', 'reviews');
            onSnapshot(reviewsCol, (snap) => {
                ALL_REVIEWS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (currentView === 'product-details' || currentView === 'admin') renderView();
            });

            // NEW: Hero Settings Listener
            const heroDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero');
            onSnapshot(heroDoc, (snap) => {
                if (snap.exists()) {
                    HERO_SETTINGS = snap.data();
                }
                // Update Branding Immediately
                updateGlobalBranding();
                
                // If on home or admin, re-render to show changes
                if (currentView === 'home' || currentView === 'admin') renderView();
            });

            // NEW: Orders Listener for Admin Only
            if (user && user.email === ADMIN_EMAIL) {
                const ordersCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                onSnapshot(ordersCol, (snap) => {
                    ALL_ORDERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // تعديل منطق الفرز للتعامل مع serverTimestamp
                    ALL_ORDERS.sort((a, b) => {
                        // دالة مساعدة لاستخراج الوقت بالميلي ثانية
                        const getTime = (t) => {
                            if (!t) return Date.now(); // للطلبات الجديدة التي لم يصل توقيتها بعد (Pending)
                            return t.toMillis ? t.toMillis() : (t || 0); // إذا كان Timestamp أو رقم قديم
                        };
                        return getTime(b.createdAt) - getTime(a.createdAt);
                    });

                    // 3️⃣ Auto Cleanup Trigger (تشغيل التنظيف الذكي عند تحميل البيانات)
                    autoCleanupOrders(ALL_ORDERS);

                    // تحديث العرض إذا كنا في صفحة الطلبات أو في لوحة التحكم بتبويب الطلبات
                    if (currentView === 'orders' || (currentView === 'admin' && currentAdminTab === 'orders')) renderView();
                });
            }
        }

        // --- 3️⃣ NEW: Auto Cleanup Function (التنظيف الذكي) ---
        async function autoCleanupOrders(orders) {
            const now = Date.now();
            const EXPIRATION_LIMIT = 48 * 60 * 60 * 1000; // 48 ساعة بالميلي ثانية

            // فلترة الطلبات التي تحتاج تنظيف
            const expiredOrders = orders.filter(o => {
                // نتحقق فقط من الطلبات التي في انتظار الدفع (Pending)
                // نستبعد الطلبات الجديدة (New) لأنها قد تكون دفع عند الاستلام ولا تحتاج إثبات
                // نستهدف 'pending_payment' وهي الحالة الافتراضية لفودافون كاش قبل الرفع
                const isPending = o.status === 'pending_payment';
                
                if (!isPending) return false;

                // حساب وقت الطلب
                let orderTime = 0;
                if (o.createdAt) {
                    orderTime = o.createdAt.toMillis ? o.createdAt.toMillis() : (new Date(o.createdAt).getTime() || 0);
                }
                
                // الشرط: مر أكثر من 48 ساعة
                return (now - orderTime) > EXPIRATION_LIMIT;
            });

            if (expiredOrders.length === 0) return; // لا يوجد شيء للتنظيف

            // تنفيذ التحديثات (Batch updates logic handling one by one here for simplicity)
            const updates = expiredOrders.map(o => {
                return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), {
                    status: 'expired',
                    // توثيق العملية في السجل الزمني
                    statusHistory: arrayUnion({
                        status: 'expired',
                        timestamp: Date.now(),
                        note: 'نظام التنظيف الذكي: تم إلغاء الطلب تلقائياً لعدم إرسال إثبات الدفع خلال 48 ساعة'
                    })
                });
            });

            try {
                await Promise.all(updates);
                showToast(`🧹 التنظيف الذكي: تم تحويل ${expiredOrders.length} طلب معلق إلى منتهي الصلاحية`);
            } catch (err) {
                console.error("Auto Cleanup Error:", err);
            }
        }
        // -----------------------------------------------------

        function updateUserUI() {
            const container = document.getElementById('user-menu-container');
            const mobileSection = document.getElementById('mobile-user-section');
            const mobileAdminLink = document.getElementById('mobile-admin-link');
            const isAnon = user ? user.isAnonymous : true;
            const isAdmin = user && user.email === ADMIN_EMAIL;

            if (isAnon) {
                // تم إزالة hidden sm:block لتظهر الأيقونة دائماً
                container.innerHTML = `<button onclick="setView('login')" class="p-2 hover:bg-stone-100 rounded-full transition-colors" title="تسجيل الدخول"><i data-lucide="user"></i></button>`;
                mobileSection.innerHTML = `<button onclick="setView('login'); toggleMobileMenu()" class="w-full text-center py-2 bg-stone-900 text-white rounded-xl">تسجيل الدخول</button>`;
                if(mobileAdminLink) mobileAdminLink.innerHTML = '';
            } else {
                const avatar = user.photoURL || '';
                const name = user.displayName || 'مستخدم';
                const email = user.email || '';

                // Modern User Dropdown Design
                // تم إزالة hidden sm:flex لتظهر الأيقونة دائماً
                container.innerHTML = `
                    <button class="flex items-center gap-2 p-1 pl-2 hover:bg-stone-100 rounded-full flex border border-transparent hover:border-stone-200 transition-all group-hover/user:bg-stone-50 group-hover/user:shadow-sm">
                        ${avatar ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow-sm">` : `<div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-600"><i data-lucide="user" size="16"></i></div>`}
                        <i data-lucide="chevron-down" size="14" class="text-stone-400 group-hover/user:text-stone-800 transition-colors hidden sm:block"></i>
                    </button>
                    
                    <div class="absolute top-full left-0 mt-3 w-72 bg-white/95 backdrop-blur-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.15)] rounded-2xl border border-stone-100 overflow-hidden hidden group-hover/user:block z-50 p-2 transform origin-top-left transition-all animate-in fade-in slide-in-from-top-2 duration-200">
                        
                        <!-- Profile Header -->
                        <div class="p-4 mb-2 bg-stone-50/80 rounded-xl flex items-center gap-4 border border-stone-100">
                             ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full object-cover ring-4 ring-white shadow-sm">` : `<div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm text-stone-400"><i data-lucide="user" size="24"></i></div>`}
                            <div class="overflow-hidden">
                                <p class="font-bold text-stone-900 text-sm truncate">${name}</p>
                                <p class="text-[11px] text-stone-500 truncate font-medium">${email}</p>
                                ${isAdmin ? `<span class="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full">المدير</span>` : `<span class="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full">عميل</span>`}
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <div class="space-y-1">
                            ${isAdmin ? `
                            <button onclick="setView('admin')" class="w-full text-right px-3 py-2.5 hover:bg-stone-50 rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i data-lucide="layout-dashboard" size="16"></i></div> لوحة التحكم</span>
                            </button>
                            ` : ''}
                            
                            <!-- تم تحديث الرابط هنا ليوجه لتبويب الطلبات داخل اللوحة -->
                            <button onclick="${isAdmin ? "setAdminView('orders')" : "showToast('قريباً...')"}" class="w-full text-right px-3 py-2.5 hover:bg-stone-50 rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors"><i data-lucide="package" size="16"></i></div> طلبات العملاء</span>
                                ${isAdmin ? `<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full" id="orders-badge" ${ALL_ORDERS.length===0?'style="display:none"':''}>${ALL_ORDERS.filter(o=>!o.isArchived).length}</span>` : ''}
                            </button>
                            
                            <div class="h-px bg-stone-100 my-2 mx-2"></div>
                            
                            <button onclick="handleLogout()" class="w-full text-right px-3 py-2.5 hover:bg-red-50 text-stone-600 hover:text-red-600 rounded-xl text-sm font-bold flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-stone-100 text-stone-500 group-hover:bg-red-100 group-hover:text-red-600 transition-colors"><i data-lucide="log-out" size="16"></i></div> تسجيل الخروج</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Mobile Section (Simpler version)
                mobileSection.innerHTML = `
                    <div class="flex items-center gap-3 mb-6 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                        ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">` : `<div class="w-12 h-12 bg-stone-200 rounded-full flex items-center justify-center"><i data-lucide="user"></i></div>`}
                        <div class="overflow-hidden">
                            <p class="font-bold text-lg text-stone-900">${name}</p>
                            <p class="text-xs text-stone-500 truncate">${email}</p>
                        </div>
                    </div>
                    <button onclick="handleLogout(); toggleMobileMenu()" class="w-full flex items-center justify-center gap-2 py-3 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 transition-colors">
                        <i data-lucide="log-out" size="18"></i> تسجيل الخروج
                    </button>
                `;

                if(isAdmin && mobileAdminLink) {
                    mobileAdminLink.innerHTML = `<button onclick="setView('admin'); toggleMobileMenu()" class="flex items-center gap-2 text-sm text-stone-600"><i data-lucide="settings" size="18"></i> الإدارة</button>`;
                } else if (mobileAdminLink) {
                    mobileAdminLink.innerHTML = '';
                }
            }
            lucide.createIcons();
        }

        // --- Exposed Logic ---
        
        // NEW: Routing Handler (Updated for Deep Linking)
        function handleRouting() {
            const hash = window.location.hash; 
            
            // If no hash or just #/, default to home
            if (!hash || hash === '#/' || hash === '#') {
                if(currentView !== 'home') {
                    setView('home');
                }
                return;
            }

            const path = hash.replace(/^#\//, ''); // remove #/
            const parts = path.split('/'); // split by /
            
            const route = parts[0];
            
            if (route === 'product' && parts[1]) {
                // Route: #/product/{id}
                currentProductId = parts[1];
                currentView = 'product-details';
            } else if (route === 'admin') {
                // Route: #/admin or #/admin/orders
                currentView = 'admin';
                if(parts[1]) currentAdminTab = parts[1];
                else currentAdminTab = 'dashboard';
            } else if (route) {
                // Generic Routes: #/shop, #/about, #/return-policy etc.
                currentView = route;
            } else {
                currentView = 'home';
            }
            
            // Clean up admin edit states if leaving admin
            if (currentView !== 'admin') {
                currentEditProduct = null;
                currentEditCategoryName = null;
            }

            renderView();
            window.scrollTo(0, 0);
        }

        window.setView = (view, param) => {
            // Clear any running countdowns when switching views
            if (countdownInterval) clearInterval(countdownInterval);

            currentView = view;
            
            if(view !== 'admin' && view !== 'orders') currentEditProduct = null;
            if(view === 'admin' && !currentAdminTab) currentAdminTab = 'dashboard';
            
            // UPDATE: URL Hash Logic (Smart URL Update)
            let targetHash = '/';
            
            if (view === 'home') {
                targetHash = '/';
            } else if (view === 'offers') {
                targetHash = '/offers';
            } else if (view === 'faq') { // NEW ROUTE
                targetHash = '/faq';
            } else if (view === 'product-details' && param) {
                targetHash = '/product/' + param;
                currentProductId = param; // Ensure ID is set
            } else if (view === 'admin') {
                targetHash = '/admin/' + (param || currentAdminTab || 'dashboard');
                if(param) currentAdminTab = param;
            } else {
                targetHash = '/' + view;
            }
            
            // NEW: Update URL Hash without triggering reload
            if (window.location.hash !== '#' + targetHash) {
                history.pushState(null, null, '#' + targetHash);
            }

            renderView();
            window.scrollTo(0, 0);
        };

        // دالة جديدة للتنقل بين تبويبات لوحة التحكم
        window.setAdminView = (tab) => {
            setView('admin', tab);
        };

        // NEW: Set Admin Order Filter
        window.setAdminOrderFilter = (filter) => {
            adminOrderFilter = filter;
            renderView();
        };

        // --- FIX: دالة التبديل بين الجارية والأرشيف (كانت مفقودة) ---
        window.setOrderTab = (tab) => {
            currentOrderTab = tab;
            // إعادة تعيين فلتر البحث عند تغيير التبويب
            adminOrderFilter = 'all'; 
            renderView();
        };
        // -----------------------------------------------------------

        // --- NEW: دالة البحث الفوري في الطلبات ---
        window.filterOrdersList = (query) => {
            const cards = document.querySelectorAll('.order-card-item');
            const q = query.toLowerCase().trim();
            
            cards.forEach(card => {
                const searchData = card.dataset.search.toLowerCase();
                if (searchData.includes(q)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        };
        // ---------------------------------------

        window.viewProduct = (id) => {
            currentProductId = id; // Ensure ID is set immediately
            detailsQuantity = 1;
            activeImageIndex = 0;
            currentSelectedColor = null; // تصفير اللون عند فتح منتج جديد
            
            // --- NEW: Save to History ---
            // Get existing history
            let historyList = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            // Remove current id if it exists (to move it to top)
            historyList = historyList.filter(hId => hId !== id);
            // Add to front
            historyList.unshift(id);
            // Limit to 10 items
            if(historyList.length > 10) historyList.pop();
            // Save back
            localStorage.setItem('gedar_history', JSON.stringify(historyList));
            // ---------------------------

            // Use setView to handle URL update properly
            setView('product-details', id);
        };

        window.scrollSlider = (dir) => {
            const s = document.getElementById('related-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 220 : -220, behavior: 'smooth' });
        };

        // NEW: Generic Banner Scroll Function (Updated for RTL Robustness)
        window.scrollBanner = (id, direction) => {
            const slider = document.getElementById(id);
            if (!slider) return;
            
            const width = slider.clientWidth;
            // direction: -1 (Left Arrow/Next in RTL), 1 (Right Arrow/Prev in RTL)
            slider.scrollBy({ left: direction * width, behavior: 'smooth' });
        };

        // NEW: Auto Scroll Logic
        window.startBannerAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // Clear existing timer to prevent duplicates
            if (bannerScrollTimers[id]) clearInterval(bannerScrollTimers[id]);

            bannerScrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                if (!element) {
                    clearInterval(bannerScrollTimers[id]);
                    return;
                }

                // Logic for infinite scrolling effect
                const maxScroll = element.scrollWidth - element.clientWidth;
                // In RTL, scrollLeft is typically negative or 0 at start. 
                // We use Math.abs to handle browser differences in RTL scroll behavior.
                const currentScroll = Math.abs(element.scrollLeft);
                
                // If we reached the end (with small tolerance), go back to start
                if (currentScroll >= maxScroll - 10) {
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // Move Next (Negative left in RTL)
                    element.scrollBy({ left: -element.clientWidth, behavior: 'smooth' });
                }
            }, 4000); // 4 seconds interval
        };

        window.stopBannerAutoScroll = (id) => {
            if (bannerScrollTimers[id]) {
                clearInterval(bannerScrollTimers[id]);
                delete bannerScrollTimers[id];
            }
        };
        
        window.scrollFeatured = (dir) => {
            const s = document.getElementById('featured-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 260 : -260, behavior: 'smooth' });
        };

        // NEW: Function to start countdown timers
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const update = () => {
                const timers = document.querySelectorAll('.discount-timer');
                if (timers.length === 0) return;

                const now = Date.now();
                timers.forEach(el => {
                    const expiry = parseInt(el.dataset.expiry);
                    const diff = expiry - now;

                    if (diff <= 0) {
                        el.innerHTML = '<span class="text-stone-400 font-bold text-xs">انتهى العرض</span>';
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    el.innerHTML = `
                        <div class="flex items-center gap-2 text-xs font-bold text-red-600 dir-ltr bg-red-50 px-2 py-1 rounded-lg border border-red-100">
                            <span class="w-5 text-center">${seconds}</span>:
                            <span class="w-5 text-center">${minutes}</span>:
                            <span class="w-5 text-center">${hours}</span>:
                            <span class="w-6 text-center">${days}ي</span>
                        </div>
                    `;
                });
            };

            update(); // Run immediately
            countdownInterval = setInterval(update, 1000);
        }

        // --- NEW: Generic Scroll Function for Product Details Sliders ---
        window.scrollSection = (id, dir) => {
            const el = document.getElementById(id);
            if(el) {
                // In RTL, scrolling negative 'left' moves to the visual left (next items)
                const scrollAmount = 300;
                el.scrollBy({ left: dir === 'next' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
            }
        };

        // --- NEW: Toggle About Section ---
        window.toggleAbout = (id) => {
            const container = document.getElementById(`about-container-${id}`);
            const fade = document.getElementById(`about-fade-${id}`);
            const btn = document.getElementById(`about-btn-${id}`);
            
            if (container.classList.contains('max-h-[100px]')) {
                // Expand
                container.classList.remove('max-h-[100px]');
                if(fade) fade.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="chevron-up" size="16"></i> عرض أقل`;
            } else {
                // Collapse
                container.classList.add('max-h-[100px]');
                if(fade) fade.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="chevron-down" size="16"></i> شاهد المزيد`;
            }
            lucide.createIcons();
        };

        // --- NEW: Share Product Logic ---
        window.shareProduct = async (id) => {
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            
            // تكوين الرابط المباشر
            // نستخدم window.location.origin و window.location.pathname لضمان أن الرابط يعمل بغض النظر عن الدومين
            const url = `${window.location.origin}${window.location.pathname}#/product/${id}`;
            
            // استخدام واجهة المشاركة الأصلية للمتصفح (للهواتف)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: product.name,
                        text: `شاهد هذا المنتج المميز من جدار: ${product.name}`,
                        url: url
                    });
                } catch (err) {
                    console.log('Sharing failed or cancelled', err);
                }
            } else {
                // النسخ للحافظة كبديل (لأجهزة الكمبيوتر أو المتصفحات القديمة)
                navigator.clipboard.writeText(url).then(() => {
                    showToast("تم نسخ رابط المنتج للحافظة");
                }).catch(() => {
                    showToast("فشل نسخ الرابط");
                });
            }
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.remove('translate-y-12', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-12', 'opacity-0'), 3000);
        };

        // --- NEW: Shop & Filter Logic (إصلاح مشكلة التصفية) ---
        
        window.filterCategory = (catName) => {
            // تفعيل القسم المختار وتصفير البحث
            shopState.categories = [catName];
            shopState.search = ''; 
            // الانتقال لصفحة المتجر
            setView('shop');
        };

        window.viewAllProducts = () => {
            // إعادة ضبط الفلاتر وعرض الكل
            shopState = { search: '', categories: [], priceMin: 0, priceMax: 1000, sort: 'featured' };
            setView('shop');
        };

        window.updateShopFilters = (type, value) => {
            if (type === 'search') {
                shopState.search = value.toLowerCase();
            } else if (type === 'category') {
                // إضافة أو إزالة القسم من مصفوفة التصفية
                if (shopState.categories.includes(value)) {
                    shopState.categories = shopState.categories.filter(c => c !== value);
                } else {
                    shopState.categories.push(value);
                }
            } else if (type === 'priceMax') {
                shopState.priceMax = Number(value);
            } else if (type === 'priceMin') {
                shopState.priceMin = Number(value);
            } else if (type === 'sort') {
                shopState.sort = value;
            }
            
            // تطبيق الفلتر وتحديث الواجهة
            if (currentView === 'shop') {
                applyShopFilters();
                
                // NEW: إعادة رسم قائمة الأقسام لتحديث حالة التحديد (Checkboxes)
                if (type === 'category') {
                    const list = document.getElementById('shop-categories-list');
                    if (list) list.innerHTML = generateCategoryFilterHTML();
                }
            }
        };

        // NEW: Helper function to generate category filter HTML
        function generateCategoryFilterHTML() {
            return CATEGORIES.map(cat => {
                const isSelected = shopState.categories.includes(cat.name);
                return `
                <label class="cursor-pointer group flex items-center justify-between p-2.5 rounded-xl transition-all duration-200 border ${isSelected ? 'bg-stone-900 border-stone-900 text-white shadow-md' : 'bg-white border-transparent hover:bg-stone-50 text-stone-600'}">
                    <div class="flex items-center gap-3">
                        <div class="relative flex items-center justify-center w-5 h-5">
                            <input type="checkbox" class="peer appearance-none w-5 h-5 border-2 rounded-md transition-all duration-200 cursor-pointer ${isSelected ? 'border-white/40 bg-white/20' : 'border-stone-300 bg-white group-hover:border-stone-400'}" value="${cat.name}" onchange="updateShopFilters('category',this.value)" ${isSelected ? 'checked' : ''}>
                            <i data-lucide="check" size="12" class="absolute text-white pointer-events-none transition-all duration-200 ${isSelected ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}"></i>
                        </div>
                        <span class="font-bold text-sm select-none">${cat.name}</span>
                    </div>
                </label>`;
            }).join('');
        }

        window.resetFilters = () => {
            viewAllProducts();
        };

        // --- NEW: Missing Cart & UI Functions (إضافة دوال السلة والمفضلة المفقودة) ---

        window.addToCart = (id, selectedColor = null) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            
            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            // البحث عن المنتج في السلة (نطابق الآيدي واللون)
            const existing = cart.find(x => x.id === id && x.selectedColor === selectedColor);
            
            if (existing) {
                existing.quantity++;
                // Update price in cart to match current offer status (optional but good practice)
                existing.price = finalPrice; 
            } else {
                // Store with effective price and selected color
                cart.push({ ...p, price: finalPrice, quantity: 1, selectedColor: selectedColor });
            }
            
            saveCart();
            updateCartUI();
            
            // تعديل: فتح السلة تلقائياً فقط في المرة الأولى
            if (!hasAutoOpenedCart) {
                toggleCart(true);
                hasAutoOpenedCart = true;
            }
            
            showToast("تمت الإضافة للسلة");
        };

        // --- 5️⃣ NEW: Stepper HTML Generator Helper ---
        window.getStepperHTML = (currentStep) => {
            const steps = [
                { num: 1, label: 'السلة' },
                { num: 2, label: 'البيانات' },
                { num: 3, label: 'الدفع' },
                { num: 4, label: 'تأكيد' }
            ];
            
            let html = '<div class="flex items-center justify-between w-full dir-rtl relative">';
            
            // Background Line
            html += '<div class="absolute top-3 right-0 left-0 h-0.5 bg-stone-100 -z-0"></div>';
            
            // Progress Line (Width based on step) - RTL adjustment
            const progress = ((currentStep - 1) / (steps.length - 1)) * 100;
            html += `<div class="absolute top-3 right-0 h-0.5 bg-stone-900 -z-0 transition-all duration-500" style="width: ${progress}%"></div>`;

            html += steps.map(s => {
                const isActive = s.num <= currentStep;
                const isCurrent = s.num === currentStep;
                
                return `
                <div class="flex flex-col items-center gap-1.5 relative z-10 bg-white px-2">
                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold border-2 transition-all duration-300 ${isActive ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-300 border-stone-200'} ${isCurrent ? 'ring-2 ring-stone-100 ring-offset-2' : ''}">
                        ${isActive && !isCurrent ? '<i data-lucide="check" size="10"></i>' : s.num}
                    </div>
                    <span class="text-[9px] font-bold ${isActive ? 'text-stone-900' : 'text-stone-300'} transition-colors">${s.label}</span>
                </div>
                `;
            }).join('');
            
            html += '</div>';
            return html;
        };
        // ---------------------------------------------

        window.toggleCart = (show) => {
            const backdrop = document.getElementById('cart-drawer-backdrop');
            const drawer = document.getElementById('cart-drawer');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                drawer.classList.remove('-translate-x-full');
                
                // Inject Stepper (Step 1)
                const stepper = document.getElementById('cart-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(1);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                drawer.classList.add('-translate-x-full');
            }
            lucide.createIcons();
        };

        window.saveCart = () => localStorage.setItem('gedar_cart', JSON.stringify(cart));

        window.removeFromCartByIndex = (index) => {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
        };

        window.updateQuantityByIndex = (index, change) => {
            const item = cart[index];
            if(item) {
                item.quantity += change;
                if(item.quantity < 1) item.quantity = 1;
                saveCart();
                updateCartUI();
            }
        };

        // Old function kept for backward compatibility if needed, but UI now uses index
        window.removeFromCart = (id) => {
            cart = cart.filter(x => x.id !== id);
            saveCart();
            updateCartUI();
        };

        window.updateQuantity = (id, change) => {
             // Fallback implementation using ID (might affect multiple variants)
             // Better to use updateQuantityByIndex
            const item = cart.find(x => x.id === id);
            if(item) {
                item.quantity += change;
                if(item.quantity < 1) item.quantity = 1;
                saveCart();
                updateCartUI();
            }
        };

        window.toggleFavorite = (id) => {
            if (favorites.includes(id)) favorites = favorites.filter(x => x !== id);
            else favorites.push(id);
            localStorage.setItem('aura_favorites', JSON.stringify(favorites));
            updateFavoritesUI();
            
            // تحديث الواجهة بناءً على الصفحة الحالية
            if(currentView === 'shop') applyShopFilters();
            else if(currentView === 'home') renderFeatured(document.getElementById('main-content'));
            else if(currentView === 'product-details') renderProductDetails(document.getElementById('main-content'));
            else if(currentView === 'favorites') renderFavoritesPage(document.getElementById('main-content'));
            
            showToast(favorites.includes(id) ? "تمت الإضافة للمفضلة" : "تم الحذف من المفضلة");
        };
        
        // دوال مساعدة لصفحة تفاصيل المنتج
        window.setActiveImage = (idx) => {
            activeImageIndex = idx;
            const mainImg = document.getElementById('main-product-image');
            const thumbs = document.querySelectorAll('.gallery-thumb');
            const p = PRODUCTS.find(x => x.id === currentProductId);
            const images = (p && p.images && p.images.length) ? p.images : (p ? [p.image] : []);
            
            if(mainImg && images[idx]) mainImg.src = images[idx];
            
            thumbs.forEach((t, i) => {
                if(i === idx) t.classList.add('active');
                else t.classList.remove('active');
            });
        };

        window.changeDetailsQuantity = (d) => {
            detailsQuantity += d;
            if(detailsQuantity < 1) detailsQuantity = 1;
            const el = document.getElementById('details-qty');
            if(el) el.innerText = detailsQuantity;
        };

        window.addToCartFromDetails = (id) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;

            // التحقق مما إذا كان المنتج يحتوي على ألوان ولم يتم اختيار لون
            if (p.variants && p.variants.length > 0 && !currentSelectedColor) {
                showToast("يرجى اختيار اللون أولاً");
                // Scroll to variants section
                const variantsSec = document.getElementById('variants-section');
                if(variantsSec) variantsSec.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            const existing = cart.find(x => x.id === id && x.selectedColor === currentSelectedColor);
            if (existing) {
                existing.quantity += detailsQuantity;
                existing.price = finalPrice;
            } else {
                cart.push({ ...p, price: finalPrice, quantity: detailsQuantity, selectedColor: currentSelectedColor });
            }
            
            saveCart();
            updateCartUI();
            showToast("تمت الإضافة للسلة");
        };

        window.toggleMobileMenu = () => {
             const m = document.getElementById('mobile-menu');
             if(m) {
                 m.classList.toggle('hidden');
                 m.classList.toggle('flex');
             }
        };

        // --- Checkout Logic ---
        
        window.checkout = () => {
            if (cart.length === 0) return showToast("السلة فارغة");
            
            // Reset fields
            document.getElementById('delivery-check').checked = false;
            document.getElementById('checkout-address').value = ''; 
            
            // Reset Payment to Default (COD)
            const radios = document.getElementsByName('paymentMethod');
            if(radios.length > 0) radios[0].checked = true;
            if(window.updatePaymentUI) window.updatePaymentUI();

            // Initial Calculation
            calculateCheckoutTotal();
            
            // Close cart drawer & Open modal
            toggleCart(false);
            toggleCheckoutModal(true);
        };
        
        // NEW: Update UI based on selection
        window.updatePaymentUI = () => {
            const el = document.querySelector('input[name="paymentMethod"]:checked');
            const method = el ? el.value : 'cod';
            const label = document.getElementById('payment-method-label');
            const partialOption = document.getElementById('partial-payment-option');
            const isPartialCheck = document.getElementById('isPartial');
            
            if (!label) return;

            if (method === 'vodafone_cash') {
                partialOption.classList.remove('hidden');
                
                if (isPartialCheck && isPartialCheck.checked) {
                    label.innerText = 'عربون (مقدم)';
                    label.className = 'inline-block bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded font-bold';
                } else {
                    label.innerText = 'المحافظ الإلكترونية';
                    label.className = 'inline-block bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded font-bold';
                }
            } else {
                partialOption.classList.add('hidden');
                if(isPartialCheck) isPartialCheck.checked = false; // Reset checkbox
                
                label.innerText = 'دفع عند الاستلام';
                label.className = 'inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold';
            }
        };

        window.calculateCheckoutTotal = () => {
            const isDelivery = document.getElementById('delivery-check').checked;
            const address = document.getElementById('checkout-address').value.trim();
            const totalDisplay = document.getElementById('checkout-total-display');
            const noteDisplay = document.getElementById('delivery-note');
            
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let finalTotal = cartTotal;
            let note = "";
            let showNote = false;

            if (isDelivery) {
                // Check if address contains any of the predefined areas
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                
                if (isFixedArea) {
                    finalTotal += FIXED_DELIVERY_FEE;
                    note = `+ ${FIXED_DELIVERY_FEE} ج.م مصاريف توصيل`;
                    showNote = true;
                } else {
                    // Delivery requested but area not matched yet or unknown
                    note = "حساب التوصيل مع المندوب عند الاستلام";
                    showNote = true;
                }
            } else {
                note = "بدون توصيل (استلام من الفرع)";
                showNote = false;
            }

            totalDisplay.innerText = `$${finalTotal.toFixed(2)}`;
            noteDisplay.innerText = note;
            if(showNote) noteDisplay.classList.remove('hidden');
            else noteDisplay.classList.add('hidden');
        };

        window.toggleCheckoutModal = (show) => {
            const backdrop = document.getElementById('checkout-modal-backdrop');
            const modal = document.getElementById('checkout-modal');
            
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');

                // Inject Stepper (Step 2)
                const stepper = document.getElementById('checkout-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(2);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // --- 🆕 FIXED: Track Order Search Handler ---
        window.handleTrackOrderSearch = async (e) => {
            e.preventDefault();
            const orderId = e.target.orderId.value.trim();
            const resultContainer = document.getElementById('tracking-result');
            
            if (!orderId) return;

            // Show Loading
            resultContainer.innerHTML = '<div class="text-center py-8"><div class="inline-block w-8 h-8 border-4 border-stone-200 border-t-stone-900 rounded-full animate-spin"></div><p class="mt-2 text-stone-500 text-sm">جاري البحث...</p></div>';

            try {
                // Fetch Order
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const order = { id: docSnap.id, ...docSnap.data() };
                    
                    // Render Result
                    renderTrackingTimeline(resultContainer, order);
                } else {
                    // Not Found
                    resultContainer.innerHTML = `
                        <div class="text-center py-12 bg-red-50 rounded-3xl border border-red-100 fade-in-up">
                            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="search-x" size="32"></i>
                            </div>
                            <h3 class="font-bold text-red-900 text-lg mb-2">عذراً، لم نجد هذا الطلب</h3>
                            <p class="text-red-700/80 text-sm">يرجى التأكد من رقم الطلب والمحاولة مرة أخرى.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Tracking Error:", error);
                showToast("حدث خطأ أثناء البحث");
                resultContainer.innerHTML = '';
            }
        };
        // ---------------------------------------------

        // NEW: Success Modal Logic (Enhanced for VF Cash)
        window.toggleSuccessModal = (show, orderId, isVodafoneCash = false) => {
            const backdrop = document.getElementById('success-modal-backdrop');
            const modal = document.getElementById('success-modal');
            const idDisplay = document.getElementById('success-order-id');
            const titleEl = document.getElementById('success-title');
            const descEl = document.getElementById('success-desc');
            
            if (show) {
                if(orderId) idDisplay.innerText = orderId;
                
                // Inject Stepper (Step 4 - Final)
                const stepper = document.getElementById('success-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(4);
                    lucide.createIcons();
                }

                // Custom Message Logic
                if (isVodafoneCash) {
                    titleEl.innerText = "تم استلام طلبك والمراجعة جارية";
                    descEl.innerHTML = `
                        <div class="space-y-3 mt-4 mb-2">
                            <div class="bg-blue-50 text-blue-800 p-3 rounded-xl text-xs md:text-sm font-bold border border-blue-100 flex items-center justify-center gap-2 shadow-sm">
                                <span class="animate-pulse">⏳</span> جاري مراجعة التحويل خلال 30 دقيقة
                            </div>
                            <div class="text-stone-500 text-xs font-medium flex items-center justify-center gap-1">
                                📲 سيتم التواصل معك فور تأكيد عملية الدفع
                            </div>
                        </div>
                    `;
                } else {
                    // Default Message
                    titleEl.innerText = "تم استلام طلبك بنجاح!";
                    descEl.innerHTML = "شكراً لثقتك بنا. يرجى الاحتفاظ برقم الطلب لتتبع حالة الشحنة.";
                }

                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        window.copyOrderId = () => {
            const id = document.getElementById('success-order-id').innerText;
            navigator.clipboard.writeText(id);
            showToast("تم نسخ رقم الطلب");
        };

        window.handlePlaceOrder = async (e) => {
            e.preventDefault();
            
            // Lock Check: منع التكرار
            if (isOrderSubmitting) return;
            if (cart.length === 0) return;

            // 1. Get Button & Save Original State
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;

            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            
            // --- VALIDATION START ---
            if (!name || !phone || !address) {
                return showToast("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، العنوان)");
            }

            // Phone Validation Regex (Egypt Mobile Numbers)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showToast("رقم الهاتف غير صحيح. يجب أن يتكون من 11 رقم ويبدأ بـ 010, 011, 012, أو 015");
                return;
            }
            // --- VALIDATION END ---

            // 2. Set Loading State & Lock
            isOrderSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>جاري إصدار الفاتورة...</span></div>`;
            submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

            // Get Payment Method
            const paymentMethod = e.target.paymentMethod ? e.target.paymentMethod.value : 'cod';
            
            // 4️⃣ Get Partial Payment Status
            const isPartial = document.getElementById('isPartial').checked && paymentMethod === 'vodafone_cash';

            // Recalculate logic securely
            const isDelivery = document.getElementById('delivery-check').checked;
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let deliveryFee = 0;
            let deliveryStatus = "no_delivery"; 

            if (isDelivery) {
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                if (isFixedArea) {
                    deliveryFee = FIXED_DELIVERY_FEE;
                    deliveryStatus = "fixed";
                } else {
                    deliveryStatus = "courier";
                }
            }

            const totalAmount = cartTotal + deliveryFee;
            const initialStatus = paymentMethod === 'vodafone_cash' ? 'pending_payment' : 'new';

            const orderData = {
                customer: {
                    name: name,
                    phone: phone,
                    address: address
                },
                items: cart,
                subtotal: cartTotal,
                delivery: {
                    requested: isDelivery,
                    fee: deliveryFee,
                    status: deliveryStatus, 
                    areasMatch: deliveryStatus === 'fixed'
                },
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                isPartialPayment: isPartial, // 4️⃣ Save Partial Flag
                status: initialStatus,
                createdAt: serverTimestamp(), // NOTE: In local obj we use Date.now() for immediate PDF
                userId: user && !user.isAnonymous ? user.uid : 'guest',
                statusHistory: [{
                    status: initialStatus,
                    timestamp: Date.now(),
                    note: isPartial ? 'تم إنشاء الطلب (بنظام العربون)' : 'تم إنشاء الطلب بنجاح'
                }]
            };

            // 1️⃣1️⃣ Create a local snapshot with proper Date for immediate PDF generation
            // Because serverTimestamp() is not readable immediately in client-side object without fetch
            lastPlacedOrder = { 
                ...orderData, 
                id: "PENDING-ID", // Will update after success
                createdAt: Date.now() 
            };

            try {
                // --- 8️⃣ SMART ORDER NUMBERING (الترقيم الذكي) ---
                // نستخدم Transaction لضمان عدم تكرار الرقم حتى لو طلب شخصين في نفس اللحظة
                
                const finalOrderId = await runTransaction(db, async (transaction) => {
                    // ... existing transaction code ...
                    const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'orderCounter');
                    const counterDoc = await transaction.get(counterRef);
                    let currentSeq = 0;
                    if (counterDoc.exists()) currentSeq = counterDoc.data().seq || 0;
                    const nextSeq = currentSeq + 1;
                    const year = new Date().getFullYear();
                    const formattedId = `GD-${year}-${String(nextSeq).padStart(5, '0')}`;
                    const newOrderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', formattedId);
                    transaction.set(newOrderRef, orderData);
                    transaction.set(counterRef, { seq: nextSeq }, { merge: true });
                    return formattedId;
                });
                
                // 1️⃣1️⃣ Update the global order object with the real ID
                lastPlacedOrder.id = finalOrderId;

                // --- 🆕 SEND DIRECT BOT NOTIFICATION ---
                if (BOT_API_KEY && BOT_PHONE) {
                    const msg = encodeURIComponent(
                        `📦 *طلب جديد من الموقع!*\n` +
                        `-------------------\n` +
                        `#️⃣ رقم الطلب: *${finalOrderId}*\n` +
                        `👤 العميل: ${name}\n` +
                        `📱 الهاتف: ${phone}\n` +
                        `💰 الإجمالي: *${totalAmount} ج.م*\n` +
                        `💳 الدفع: ${paymentMethod === 'vodafone_cash' ? 'فودافون كاش' : 'عند الاستلام'}\n` +
                        `-------------------\n` +
                        `📍 العنوان: ${address}`
                    );
                    
                    // إرسال الطلب في الخلفية (mode: no-cors لتجنب مشاكل المتصفح)
                    fetch(`https://api.callmebot.com/whatsapp.php?phone=${BOT_PHONE}&text=${msg}&apikey=${BOT_API_KEY}`, { mode: 'no-cors' })
                        .catch(err => console.error("Bot Notification Failed:", err));
                }
                // ---------------------------------------

                // ... existing notification code ...
                if (GOOGLE_SCRIPT_URL) {
                    const itemsSummary = cart.map(i => `${i.name} (${i.quantity})`).join(' + ');
                    const timestamp = new Date().toLocaleString('ar-EG');
                    
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'new_order',
                            orderId: finalOrderId, 
                            date: timestamp,
                            customerName: name,
                            customerPhone: phone,
                            address: address,
                            totalAmount: totalAmount,
                            paymentMethod: paymentMethod === 'vodafone_cash' ? (isPartial ? 'فودافون كاش (عربون)' : 'فودافون كاش') : 'عند الاستلام',
                            items: itemsSummary,
                            backup_source: "Gedar_Web_V1"
                        })
                    }).catch(err => console.log("Backup Error:", err));
                }

                cart = [];
                saveCart(); 
                updateCartUI(); 
                toggleCheckoutModal(false);
                e.target.reset();
                
                // 3. Reset Button State (Success) & Unlock
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                
                // BRANCHING LOGIC based on Payment Method
                if (paymentMethod === 'vodafone_cash') {
                    handleVodafoneCashFlow(finalOrderId, totalAmount, isPartial); // Pass isPartial
                } else {
                    toggleSuccessModal(true, finalOrderId, false); 
                }
                
            } catch (error) {
                // ... error handling ...
                console.error("Order Error:", error);
                showToast("حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.");
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        };

        // NEW: Vodafone Cash Flow Implementation
        window.handleVodafoneCashFlow = (orderId, amount, isPartial = false) => {
            // Populate Data
            
            // 4️⃣ Update Labels for Partial Payment
            if (isPartial) {
                // حساب 50% من المبلغ
                const minPartial = Math.ceil(amount * 0.5); // تقريب للأعلى لأقرب رقم صحيح
                
                document.getElementById('vc-amount').innerHTML = `
                    <div class="flex flex-col items-center gap-1">
                        <span class="text-3xl font-serif font-black text-stone-900">${minPartial.toFixed(2)} ج.م</span>
                        <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded">مطلوب دفع 50% كحد أدنى للعربون</span>
                    </div>`;
                document.getElementById('vc-amount-step').innerText = minPartial + ' ج.م';
                
                // تخزين الحد الأدنى في متغير عام للتحقق منه لاحقاً
                window.requiredMinPayment = minPartial;
            } else {
                document.getElementById('vc-amount').innerText = amount.toFixed(2) + ' ج.م';
                document.getElementById('vc-amount-step').innerText = amount.toFixed(2) + ' ج.م';
                window.requiredMinPayment = 0; // لا يوجد حد أدنى خاص (المبلغ بالكامل مطلوب لكن التحقق منه أقل صرامة هنا)
            }
            
            document.getElementById('vc-order-id-hidden').value = orderId;
            
            // Show Modal
            toggleVodafoneModal(true);
        };

        window.toggleVodafoneModal = (show) => {
            const backdrop = document.getElementById('vodafone-modal-backdrop');
            const modal = document.getElementById('vodafone-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');

                // Inject Stepper (Step 3 - Payment)
                const stepper = document.getElementById('vodafone-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(3);
                    lucide.createIcons();
                }

            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // Transition from Instruction Modal to Form Modal
        window.confirmVodafonePayment = () => {
            const orderId = document.getElementById('vc-order-id-hidden').value;
            // Get amount from display text (e.g., "1250.00 ج.م") and parse it
            const amountText = document.getElementById('vc-amount').innerText;
            const amountVal = parseFloat(amountText);

            toggleVodafoneModal(false);
            
            // Open Confirmation Form & Prefill Data
            document.getElementById('vc-confirm-order-id').value = orderId;
            
            // Prefill amount if input exists
            const amountInput = document.querySelector('#vc-confirm-modal input[name="amountPaid"]');
            if(amountInput) amountInput.value = amountVal;

            toggleVcConfirmModal(true);
        };

        // Toggle Confirmation Modal
        window.toggleVcConfirmModal = (show) => {
            const backdrop = document.getElementById('vc-confirm-modal-backdrop');
            const modal = document.getElementById('vc-confirm-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
                
                // Inject Stepper (Step 3 - Payment Confirm)
                const stepper = document.getElementById('vc-confirm-stepper');
                if(stepper) {
                    stepper.innerHTML = getStepperHTML(3);
                    lucide.createIcons();
                }

                // --- NEW: Restore Draft Data (استعادة المسودة) ---
                loadVcDraft();
                // ---------------------------------------------

                // إعادة التحقق عند الفتح لتحديث حالة الزر
                setTimeout(validateVcForm, 100);
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // --- NEW: Save Draft Function (حفظ تلقائي) ---
        window.saveVcDraft = () => {
            const form = document.getElementById('vc-confirm-form');
            if(!form) return;
            
            const currentOrderId = document.getElementById('vc-confirm-order-id').value;
            
            const draft = {
                senderName: form.senderName.value,
                senderPhone: form.senderPhone.value,
                amountPaid: form.amountPaid.value,
                transactionId: form.transactionId.value,
                orderId: currentOrderId, // ربط المسودة برقم الطلب
                timestamp: Date.now()
            };
            
            localStorage.setItem('gedar_vc_draft', JSON.stringify(draft));
        };

        // --- NEW: Load Draft Function (استعادة المسودة) ---
        window.loadVcDraft = () => {
            const draftStr = localStorage.getItem('gedar_vc_draft');
            if (!draftStr) return;
            
            try {
                const draft = JSON.parse(draftStr);
                const currentOrderId = document.getElementById('vc-confirm-order-id').value;
                
                // نتأكد أن المسودة تخص نفس الطلب الحالي (أو مسودة عامة حديثة)
                // إذا كان رقم الطلب مطابقاً، نستعيد البيانات
                if (draft.orderId && draft.orderId === currentOrderId) {
                    const form = document.getElementById('vc-confirm-form');
                    if(!form) return;

                    if(draft.senderName) form.senderName.value = draft.senderName;
                    if(draft.senderPhone) form.senderPhone.value = draft.senderPhone;
                    if(draft.amountPaid) form.amountPaid.value = draft.amountPaid;
                    if(draft.transactionId) form.transactionId.value = draft.transactionId;
                    
                    // تنبيه بسيط (اختياري)
                    // console.log("Draft restored");
                }
            } catch(e) { console.error("Error loading draft", e); }
        };

        // --- UPDATED: التحقق من صحة نموذج الدفع وحفظ المسودة ---
        window.validateVcForm = () => {
            const form = document.getElementById('vc-confirm-form');
            const btn = document.getElementById('vc-submit-btn');
            const hint = document.getElementById('vc-form-hint');
            const imgIndicator = document.getElementById('img-check-indicator');
            
            if(!form || !btn) return;

            // --- NEW: Save Draft on every validation check (Input) ---
            saveVcDraft();
            // -----------------------------------------------------

            // 1. التحقق من الصورة
            const hasImage = form.receiptImage.files.length > 0;
            if(imgIndicator) {
                if(hasImage) imgIndicator.classList.remove('hidden');
                else imgIndicator.classList.add('hidden');
            }

            // 2. التحقق من باقي الحقول
            const name = form.senderName.value.trim();
            const phone = form.senderPhone.value.trim();
            const amountVal = parseFloat(form.amountPaid.value);
            
            // تحقق بسيط من طول رقم الهاتف (أكثر من 10 أرقام)
            const isPhoneValid = phone.length >= 11;

            // 3. التحقق من قيمة العربون (50%) - (NEW LOGIC)
            let isAmountValid = true;
            let amountErrorMsg = '';
            
            // التحقق من المتغير العام الذي تم تعيينه في handleVodafoneCashFlow
            if (window.requiredMinPayment && window.requiredMinPayment > 0) {
                if (isNaN(amountVal) || amountVal < window.requiredMinPayment) {
                    isAmountValid = false;
                    amountErrorMsg = `عفواً، أقل مبلغ للعربون هو ${window.requiredMinPayment} ج.م (50% من القيمة)`;
                }
            } else {
                // في حالة الدفع الكامل، فقط نتأكد أنه رقم صحيح موجب
                if (isNaN(amountVal) || amountVal <= 0) isAmountValid = false;
            }

            // 4. تفعيل/تعطيل الزر
            if (hasImage && name && isPhoneValid && isAmountValid) {
                btn.disabled = false;
                // إزالة ستايل التعطيل
                btn.classList.remove('bg-stone-400', 'text-white/80', 'cursor-not-allowed', 'shadow-none');
                // إضافة ستايل التفعيل
                btn.classList.add('bg-stone-900', 'text-white', 'hover:bg-stone-800', 'shadow-lg');
                
                // إخفاء التلميح
                if(hint) hint.classList.add('hidden');
            } else {
                btn.disabled = true;
                // استعادة ستايل التعطيل
                btn.classList.add('bg-stone-400', 'text-white/80', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-stone-900', 'text-white', 'hover:bg-stone-800', 'shadow-lg');
                
                // إظهار التلميح المناسب
                if(hint) {
                    hint.classList.remove('hidden');
                    if (!isAmountValid && amountErrorMsg) {
                        // إظهار رسالة خطأ المبلغ باللون الأحمر
                        hint.innerText = amountErrorMsg;
                        hint.classList.remove('text-red-500', 'text-stone-400');
                        hint.classList.add('text-red-600', 'font-black');
                    } else {
                        // الرسالة الافتراضية
                        hint.innerText = 'يرجى رفع الصورة وملء البيانات لتفعيل الزر';
                        hint.classList.remove('text-red-600', 'font-black');
                        hint.classList.add('text-red-500');
                    }
                }
            }
        };

        // NEW: Image Compression Helper (Client-Side)
        // This avoids using paid cloud storage by compressing images to small strings
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize Logic (Max 800px width/height) to ensure small size
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG with 60% quality
                        // This usually results in < 100KB string which fits easily in Firestore
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // Handle Submission of Payment Details
        window.handleVcConfirmSubmit = async (e) => {
            e.preventDefault();
            
            // Lock Check: منع التكرار
            if (isPaymentSubmitting) return;

            // 1. Get Button & Save State
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;

            const orderId = document.getElementById('vc-confirm-order-id').value;
            const senderName = e.target.senderName.value.trim();
            const senderPhone = e.target.senderPhone.value.trim();
            const amountPaid = e.target.amountPaid.value; 
            const transactionId = e.target.transactionId.value.trim(); 
            
            // Get Image File
            const receiptFile = e.target.receiptImage.files[0];

            // --- 3️⃣ DUPLICATE DETECTION (Smart Check) ---
            try {
                const lastSub = JSON.parse(localStorage.getItem('gedar_last_vc_submit') || '{}');
                if (lastSub.phone === senderPhone && 
                    lastSub.amount === amountPaid && 
                    (Date.now() - lastSub.timestamp) < 5 * 60 * 1000) {
                    
                    showToast("⚠️ تم إرسال هذا الإيصال بالفعل! يرجى الانتظار للمراجعة.");
                    return; 
                }
            } catch(err) { console.log("Duplicate check error", err); }
            // ---------------------------------------------

            // --- VALIDATION START (التحقق الذكي) ---
            if (!senderName || !senderPhone || !amountPaid) {
                return showToast("⚠️ يرجى استكمال جميع البيانات المطلوبة");
            }
            
            if (!receiptFile) {
                return showToast("⚠️ يرجى إرفاق صورة التحويل (سكرين شوت)");
            }

            // Phone Validation Regex (Egypt Mobile Numbers)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            if (!phoneRegex.test(senderPhone)) {
                // 🔴 رسالة الخطأ الذكية 1: رقم غلط
                showToast("❌ رقم الهاتف غير صحيح. تأكد أنه 11 رقم ويبدأ بـ 01");
                return;
            }
            // --- VALIDATION END ---

            // 2. Set Loading State & Lock
            isPaymentSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>جاري المعالجة...</span></div>`;
            submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

            try {
                // Compress Image
                const base64Image = await compressImage(receiptFile);
                const amountPaidFloat = parseFloat(amountPaid);

                // Update Firestore Order Document
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
                    paymentDetails: {
                        method: 'vodafone_cash',
                        senderName: senderName,
                        senderPhone: senderPhone,
                        amountPaid: amountPaidFloat,
                        transactionId: transactionId || 'N/A',
                        screenshotBase64: base64Image, // Store image directly as text
                        submittedAt: Date.now()
                    },
                    // Update Status to "Review" so admin knows payment is claimed
                    status: 'payment_review' 
                });

                // --- SAVE SUBMISSION TO LOCAL STORAGE ---
                localStorage.setItem('gedar_last_vc_submit', JSON.stringify({
                    phone: senderPhone,
                    amount: amountPaid,
                    timestamp: Date.now()
                }));
                
                // --- Clear Draft on Success ---
                localStorage.removeItem('gedar_vc_draft');

                toggleVcConfirmModal(false);
                
                // Show Final Success Modal
                toggleSuccessModal(true, orderId, true);
                
                showToast("✅ تم إرسال البيانات بنجاح");
                
                // 3. Reset Button (Success) & Unlock
                isPaymentSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');

            } catch (err) {
                console.error("Payment Confirm Error:", err);
                
                // 🔴 تحليل الأخطاء الذكي (Smart Error Analysis)
                let errorMsg = "حدث خطأ غير متوقع، حاول مرة أخرى.";
                const errString = err.toString().toLowerCase();
                const errCode = err.code; // Firebase error code

                // 1. Image Too Large (صورة كبيرة)
                // عادةً الخطأ يكون invalid-argument إذا تجاوز حجم المستند 1 ميجا
                if (errString.includes('exceeds') || errString.includes('too large') || errCode === 'invalid-argument') {
                    errorMsg = "📸 الصورة كبيرة جداً! يرجى اختيار صورة أصغر أو التقاط لقطة شاشة جديدة.";
                } 
                // 2. Weak Connection (اتصال ضعيف)
                else if (errString.includes('network') || errString.includes('offline') || errCode === 'unavailable') {
                    errorMsg = "📡 الاتصال ضعيف! يرجى التحقق من الإنترنت والمحاولة مجدداً.";
                }
                // 3. Permission Error (مشكلة صلاحيات)
                else if (errCode === 'permission-denied') {
                    errorMsg = "🔒 حدث خطأ في الصلاحيات. يرجى تحديث الصفحة.";
                }

                showToast(errorMsg);
                
                // 4. Reset Button (Error) & Unlock
                isPaymentSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        };

        window.handleAddCategory = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            const name = e.target.catName.value.trim();
            const image = e.target.catImg.value.trim();
            
            // Check logic: If editing, update. If adding, check duplicate.
            if (currentEditCategoryName) {
                // --- UPDATE MODE ---
                try {
                    const newCats = CATEGORIES.map(c => 
                        c.name === currentEditCategoryName ? { name: name, image: image } : c
                    );
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                    showToast(`تم تعديل قسم "${name}" بنجاح`);
                    currentEditCategoryName = null; // Reset
                    e.target.reset();
                    renderView(); // Refresh UI to reset button text
                } catch(err) { console.error(err); showToast("حدث خطأ في التعديل"); }
            } else {
                // --- ADD MODE ---
                if (name && !CATEGORIES.some(c => c.name === name)) {
                    try {
                        const newCat = { 
                            name: name, 
                            image: image || "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500" 
                        };
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: arrayUnion(newCat) });
                        showToast(`تم إضافة قسم "${name}" بنجاح`);
                        e.target.reset();
                    } catch(err) { console.error(err); showToast("حدث خطأ"); }
                } else {
                    showToast("اسم غير صالح أو موجود مسبقاً");
                }
            }
        };

        // NEW: دوال مساعدة لتعديل الأقسام (كانت مفقودة)
        window.prepareEditCategory = (name) => {
            currentEditCategoryName = name;
            // التأكد من أننا في تبويب الأقسام
            setAdminView('categories');
            showToast(`جاري تعديل قسم: ${name}`);
            window.scrollTo(0, 0); // الصعود للأعلى للوصول للنموذج
        };

        window.cancelEditCategory = () => {
            currentEditCategoryName = null;
            renderView();
        };

        // --- NEW: Delete Category ---
        window.handleDeleteCategory = async (catName) => {
            if (!confirm(`هل أنت متأكد من حذف قسم "${catName}"؟`)) return;
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            try {
                // Filter out the category to delete
                const newCats = CATEGORIES.filter(c => c.name !== catName);
                // Save the new array (overwrite)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                showToast("تم حذف القسم");
            } catch(err) { console.error(err); showToast("حدث خطأ أثناء الحذف"); }
        };

        // NEW: Handle Save Hero Settings
        window.handleSaveHeroSettings = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            const mainImg = e.target.heroMain.value.trim();
            const secImg = e.target.heroSec.value.trim();
            const priceLbl = e.target.heroPriceLabel.value.trim();
            const priceVal = e.target.heroPriceValue.value.trim();
            const discLbl = e.target.heroDiscLabel.value.trim();
            const discVal = e.target.heroDiscValue.value.trim();
            
            // Logo Fields
            const logoUrl = e.target.siteLogo.value.trim();
            const logoSize = e.target.logoSize.value.trim();

            // Image Config Fields (NEW)
            const imgBaseUrl = e.target.imgBaseUrl.value.trim();
            const imgDefaultExt = e.target.imgExt.value.trim();

            // Header Banner Fields
            const fbUrl = e.target.fbUrl.value.trim();
            const fbHeight = e.target.fbHeight.value.trim();
            const fbWidth = e.target.fbWidth.value.trim();
            const fbShow = e.target.fbShow.checked;

            // Category Banner Fields
            const catBanUrl = e.target.catBanUrl.value.trim();
            const catBanHeight = e.target.catBanHeight.value.trim();
            const catBanWidth = e.target.catBanWidth.value.trim();
            const catBanShow = e.target.catBanShow.checked;

            // NEW: Best Seller Banner Fields
            const bsBanUrl = e.target.bsBanUrl.value.trim();
            const bsBanHeight = e.target.bsBanHeight.value.trim();
            const bsBanWidth = e.target.bsBanWidth.value.trim();
            const bsBanShow = e.target.bsBanShow.checked;

            // NEW: Featured Banner Fields
            const ftBanUrl = e.target.ftBanUrl.value.trim();
            const ftBanHeight = e.target.ftBanHeight.value.trim();
            const ftBanWidth = e.target.ftBanWidth.value.trim();
            const ftBanShow = e.target.ftBanShow.checked;

            // Hero Visibility Fields
            const heroMobile = e.target.heroShowMobile.checked;
            const heroDesktop = e.target.heroShowDesktop.checked;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero'), {
                    mainImage: mainImg,
                    secondaryImage: secImg,
                    priceLabel: priceLbl,
                    priceValue: priceVal,
                    discountLabel: discLbl,
                    discountValue: discVal,
                    logoUrl: logoUrl,
                    logoSize: logoSize,
                    // Save Image Config (NEW)
                    imageBaseUrl: imgBaseUrl,
                    imageDefaultExt: imgDefaultExt,
                    // Save Header Banner
                    footerBannerUrl: fbUrl,
                    footerBannerHeight: fbHeight,
                    footerBannerWidth: fbWidth,
                    showFooterBanner: fbShow,
                    // Save Category Banner
                    categoryBannerUrl: catBanUrl,
                    categoryBannerHeight: catBanHeight,
                    categoryBannerWidth: catBanWidth,
                    showCategoryBanner: catBanShow,
                    // Save Best Seller Banner
                    bestSellerBannerUrl: bsBanUrl,
                    bestSellerBannerHeight: bsBanHeight,
                    bestSellerBannerWidth: bsBanWidth,
                    showBestSellerBanner: bsBanShow,
                    // Save Featured Banner
                    featuredBannerUrl: ftBanUrl,
                    featuredBannerHeight: ftBanHeight,
                    featuredBannerWidth: ftBanWidth,
                    showFeaturedBanner: ftBanShow,
                    // Save Hero Visibility
                    showHeroMobile: heroMobile,
                    showHeroDesktop: heroDesktop
                }, { merge: true });
                showToast("تم تحديث إعدادات الموقع والواجهة بنجاح");
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء الحفظ");
            }
        };

        // NEW: Function to update global branding (Navbar, Footer, & Bottom Banner)
        function updateGlobalBranding() {
            const navBrand = document.getElementById('navbar-brand');
            const footerBrand = document.getElementById('footer-brand');
            const bannerContainer = document.getElementById('header-banner-container'); // Updated ID
            
            const logoUrl = HERO_SETTINGS.logoUrl;
            const size = HERO_SETTINGS.logoSize || 100;

            if (navBrand) {
                if (logoUrl) {
                    navBrand.innerHTML = `<img src="${logoUrl}" style="width: ${size}px; height: auto; max-width: none;" class="object-contain" alt="Logo">`;
                } else {
                    navBrand.innerHTML = `
                        <div class="text-2xl font-bold tracking-tight flex items-center gap-1">جدار<span class="text-stone-400 text-4xl leading-3">.</span></div>
                        <span class="text-[0.65rem] text-stone-500 font-medium mt-1 tracking-wide">للديكورات الحديثة</span>
                    `;
                }
            }

            if (footerBrand) {
                if (logoUrl) {
                    footerBrand.innerHTML = `<img src="${logoUrl}" style="width: ${parseInt(size) * 1.2}px; height: auto;" class="object-contain" alt="Logo">`;
                } else {
                    footerBrand.innerHTML = `<div class="text-3xl font-bold text-stone-900 tracking-tighter flex items-center gap-1">جدار<span class="text-stone-400 text-5xl leading-3">.</span></div>`;
                }
            }

            // Update Header Banner (Slider Logic with Responsive Styles)
            if (bannerContainer) {
                if (HERO_SETTINGS.showFooterBanner && HERO_SETTINGS.footerBannerUrl) {
                    // تعديل: إظهار البانر فقط إذا كنا في الصفحة الرئيسية
                    if (currentView === 'home') {
                        bannerContainer.classList.remove('hidden');
                    } else {
                        bannerContainer.classList.add('hidden');
                    }
                    
                    const rawUrls = HERO_SETTINGS.footerBannerUrl.split(/\r?\n/).filter(url => url.trim() !== '');
                    
                    // Infinite Loop Logic: Triple the array
                    let displayUrls = [];
                    if (rawUrls.length > 0) {
                        if (rawUrls.length === 1) {
                            displayUrls = rawUrls; 
                        } else {
                            displayUrls = [...rawUrls, ...rawUrls, ...rawUrls];
                        }
                    }

                    const sliderId = 'header-banner-slider';
                    
                    // Retrieve settings (with fallbacks)
                    const hDesk = HERO_SETTINGS.fbHeightDesktop || HERO_SETTINGS.footerBannerHeight || 300;
                    const hMob = HERO_SETTINGS.fbHeightMobile || 150;
                    // Width settings now control the slide width relative to viewport
                    const wDesk = HERO_SETTINGS.fbWidthDesktop || HERO_SETTINGS.footerBannerWidth || 90;
                    const wMob = HERO_SETTINGS.fbWidthMobile || 95;
                    
                    const rDesk = HERO_SETTINGS.fbRadiusDesktop || HERO_SETTINGS.footerBannerRadius || '2rem';
                    const rMob = HERO_SETTINGS.fbRadiusMobile || '1rem';

                    // Inject Dynamic CSS for this specific banner
                    const styleId = 'header-banner-style';
                    let styleEl = document.getElementById(styleId);
                    if(!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = styleId;
                        document.head.appendChild(styleEl);
                    }
                    
                    // Responsive CSS logic (Gallery Style)
                    styleEl.innerHTML = `
                        #header-banner-wrapper { 
                            width: 100%; 
                            padding: 10px 0;
                        }
                        
                        /* Mobile Gallery Style */
                        .header-banner-slide { 
                            height: ${hMob}px;
                            width: ${wMob}%;
                            min-width: ${wMob}%;
                            margin: 0 6px;
                            border-radius: ${rMob};
                            scroll-snap-align: center;
                            transition: transform 0.5s ease;
                            opacity: 1;
                            transform: scale(0.96);
                        }
                        .header-banner-slide:hover { transform: scale(1); }
                        
                        /* Desktop Gallery Style */
                        @media (min-width: 768px) {
                            #header-banner-wrapper { 
                                padding: 20px 0;
                            }
                            .header-banner-slide { 
                                height: ${hDesk}px;
                                width: ${wDesk}%;
                                min-width: ${wDesk}%; /* Use user setting for width */
                                margin: 0 15px;
                                border-radius: ${rDesk};
                                opacity: 1;
                                transform: scale(0.98);
                            }
                            .header-banner-slide:hover { transform: scale(1); }
                        }

                        #${sliderId} {
                            padding-inline: 0;
                            scrollbar-width: none;
                            -ms-overflow-style: none;
                        }
                        #${sliderId}::-webkit-scrollbar { display: none; }
                    `;

                    if (displayUrls.length > 0) {
                        bannerContainer.innerHTML = `
                        <div class="w-full flex justify-center py-4 bg-stone-50" onmouseenter="stopBannerAutoScroll('${sliderId}')" onmouseleave="startBannerAutoScroll('${sliderId}')">
                            <div id="header-banner-wrapper" class="relative group transition-all duration-300">
                                
                                <!-- Slider Container -->
                                <div id="${sliderId}" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide scroll-smooth h-full items-center">
                                    ${displayUrls.map((url, idx) => `
                                        <div id="header-slide-${idx}" class="header-banner-slide flex-shrink-0 relative overflow-hidden shadow-sm border border-stone-200/50 bg-white">
                                            <!-- تعديل هنا: استخدام object-fill لعمل ستريتش للصورة -->
                                            <img src="${url.trim()}" class="w-full h-full object-fill md:object-cover" alt="Banner">
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Navigation Buttons -->
                                ${rawUrls.length > 1 ? `
                                <button onclick="scrollBanner('${sliderId}', -1)" class="absolute top-1/2 left-4 -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-white hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 border border-stone-100">
                                    <i data-lucide="chevron-left" size="24"></i>
                                </button>
                                <button onclick="scrollBanner('${sliderId}', 1)" class="absolute top-1/2 right-4 -translate-y-1/2 w-10 h-10 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-white hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 border border-stone-100">
                                    <i data-lucide="chevron-right" size="24"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>`;
                        
                        // Centering Logic
                        if (rawUrls.length > 1) {
                            setTimeout(() => {
                                const slider = document.getElementById(sliderId);
                                const startIndex = rawUrls.length; 
                                const targetSlide = document.getElementById(`header-slide-${startIndex}`);
                                
                                if (targetSlide && slider) {
                                    targetSlide.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
                                    startBannerAutoScroll(sliderId);
                                }
                            }, 500);
                        }
                    }
                    lucide.createIcons();
                } else {
                    bannerContainer.classList.add('hidden');
                    bannerContainer.innerHTML = '';
                }
            }
        }

        // --- NEW: Handle Save Hero Settings (Updated for Split Settings) ---
        window.handleSaveHeroSettings = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            // Helpers
            const getVal = (name) => e.target[name] ? e.target[name].value.trim() : '';
            const getCheck = (name) => e.target[name] ? e.target[name].checked : false;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero'), {
                    // Standard Fields
                    mainImage: getVal('heroMain'),
                    secondaryImage: getVal('heroSec'),
                    priceLabel: getVal('heroPriceLabel'),
                    priceValue: getVal('heroPriceValue'),
                    discountLabel: getVal('heroDiscLabel'),
                    discountValue: getVal('heroDiscValue'),
                    logoUrl: getVal('siteLogo'),
                    logoSize: getVal('logoSize'),
                    imageBaseUrl: getVal('imgBaseUrl'),
                    imageDefaultExt: getVal('imgExt'),
                    
                    // Header Banner (Split Settings)
                    footerBannerUrl: getVal('fbUrl'),
                    showFooterBanner: getCheck('fbShow'),
                    fbHeightDesktop: getVal('fbHeightDesk'), fbHeightMobile: getVal('fbHeightMob'),
                    fbWidthDesktop: getVal('fbWidthDesk'), fbWidthMobile: getVal('fbWidthMob'),
                    fbRadiusDesktop: getVal('fbRadiusDesk'), fbRadiusMobile: getVal('fbRadiusMob'),

                    // Category Banner (Split Settings)
                    categoryBannerUrl: getVal('catBanUrl'),
                    showCategoryBanner: getCheck('catBanShow'),
                    catBanHeightDesktop: getVal('catBanHeightDesk'), catBanHeightMobile: getVal('catBanHeightMob'),
                    catBanWidthDesktop: getVal('catBanWidthDesk'), catBanWidthMobile: getVal('catBanWidthMob'),
                    catBanRadiusDesktop: getVal('catBanRadiusDesk'), catBanRadiusMobile: getVal('catBanRadiusMob'),

                    // Other Banners (Simple)
                    bestSellerBannerUrl: getVal('bsBanUrl'),
                    bestSellerBannerHeight: getVal('bsBanHeight'),
                    bestSellerBannerWidth: getVal('bsBanWidth'),
                    showBestSellerBanner: getCheck('bsBanShow'),
                    
                    featuredBannerUrl: getVal('ftBanUrl'),
                    featuredBannerHeight: getVal('ftBanHeight'),
                    featuredBannerWidth: getVal('ftBanWidth'),
                    showFeaturedBanner: getCheck('ftBanShow'),
                    
                    showHeroMobile: getCheck('heroShowMobile'),
                    showHeroDesktop: getCheck('heroShowDesktop')
                }, { merge: true });
                showToast("تم تحديث إعدادات الموقع والواجهة بنجاح");
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء الحفظ");
            }
        };

        window.cancelEdit = () => {
            currentEditProduct = null;
            renderView();
        };

        // NEW: دوال تعديل وحذف المنتجات
        window.handleEditProduct = (id) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            currentEditProduct = p;
            // الانتقال لتبويب المنتجات في لوحة التحكم وتعبئة النموذج
            setAdminView('products');
            showToast(`جاري تعديل: ${p.name}`);
        };

        window.handleDeleteProduct = async (id) => {
            if (!confirm("هل أنت متأكد تماماً من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.")) return;
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                showToast("تم حذف المنتج بنجاح");
                // إذا كان المنتج المحذوف هو قيد التعديل حالياً، قم بإلغاء التعديل
                if (currentEditProduct && currentEditProduct.id === id) {
                    currentEditProduct = null;
                }
            } catch (error) {
                console.error("Error deleting product:", error);
                showToast("حدث خطأ أثناء الحذف");
            }
        };

        window.handleSaveProduct = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            
            const nameVal = e.target.prodName.value;
            const brandVal = e.target.prodBrand ? e.target.prodBrand.value : "";
            const materialVal = e.target.prodMaterial ? e.target.prodMaterial.value : "";
            const priceVal = parseFloat(e.target.prodPrice.value);
            const discountVal = parseFloat(e.target.prodDiscount.value) || 0;
            const expiryVal = e.target.prodExpiry.value ? new Date(e.target.prodExpiry.value).getTime() : null;
            
            // NEW: Get Featured Value
            const isFeaturedVal = e.target.prodFeatured ? e.target.prodFeatured.checked : false;

            const catVal = e.target.prodCat.value;
            
            // --- NEW: Smart Image URL Generation ---
            let imgInput = e.target.prodImg.value.trim();
            let imgVal = imgInput;
            
            // إذا كان المدخل ليس رابطاً كاملاً (لا يبدأ بـ http) ويوجد إعدادات للقاعدة
            if (imgInput && !imgInput.match(/^https?:\/\//) && HERO_SETTINGS.imageBaseUrl) {
                // التأكد من وجود / في نهاية الرابط الأساسي
                const baseUrl = HERO_SETTINGS.imageBaseUrl.endsWith('/') 
                    ? HERO_SETTINGS.imageBaseUrl 
                    : HERO_SETTINGS.imageBaseUrl + '/';
                
                // التأكد من الامتداد
                const ext = HERO_SETTINGS.imageDefaultExt || '.webp';
                const hasExt = imgInput.includes('.');
                
                imgVal = baseUrl + imgInput + (hasExt ? '' : ext);
            }
            // ----------------------------------------

            const descVal = e.target.prodDesc ? e.target.prodDesc.value : "";
            const featuresVal = e.target.prodFeatures ? e.target.prodFeatures.value.split('\n').filter(l => l.trim()) : [];
            const imagesVal = e.target.prodImages ? e.target.prodImages.value.split('\n').filter(l => l.trim()) : [];
            
            // Parse Variants (Colors)
            const variantsLines = e.target.prodVariants ? e.target.prodVariants.value.split('\n').filter(l => l.trim()) : [];
            const variants = variantsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const color = parts[0].trim();
                const image = parts.slice(1).join(':').trim(); 
                return { color, image };
            }).filter(item => item !== null);

            // Parse Specifications
            const specsLines = e.target.prodSpecs ? e.target.prodSpecs.value.split('\n').filter(l => l.trim()) : [];
            const specifications = specsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const label = parts[0].trim();
                const value = parts.slice(1).join(':').trim(); 
                return { label, value };
            }).filter(item => item !== null);

            // --- NEW: Parse Services ---
            const servicesLines = e.target.prodServices ? e.target.prodServices.value.split('\n').filter(l => l.trim()) : [];
            const services = servicesLines.map(line => {
                const parts = line.split(':');
                if (parts.length < 2) return null;
                const icon = parts[0].trim();
                const text = parts.slice(1).join(':').trim();
                return { icon, text };
            }).filter(item => item !== null);

            const finalImages = [imgVal, ...imagesVal];

            const productData = {
                name: nameVal,
                brand: brandVal,
                material: materialVal,
                price: priceVal,
                discount: discountVal,
                discountExpiry: expiryVal,
                isFeatured: isFeaturedVal, // Save Featured Status
                category: catVal,
                image: imgVal,
                images: finalImages,
                description: descVal,
                features: featuresVal,
                variants: variants, // Add Variants
                specifications: specifications,
                services: services, // Add services
                rating: 5,
                details: "تفاصيل المنتج..."
            };

            try {
                if (currentEditProduct) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', currentEditProduct.id), productData);
                    showToast("تم تعديل المنتج بنجاح");
                    currentEditProduct = null;
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), productData);
                    showToast("تم إضافة المنتج بنجاح");
                }
                e.target.reset();
                if (currentView === 'admin') renderView();
            } catch(err) { console.error(err); showToast("حدث خطأ"); }
        };

        window.handleSubmitReview = async (e) => {
            e.preventDefault();
            const name = e.target.reviewerName.value.trim();
            const comment = e.target.reviewerComment.value.trim();
            const rating = parseInt(e.target.reviewerRating.value);

            if (!name || !comment) return showToast("يرجى ملء جميع الحقول");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), {
                    productId: currentProductId,
                    userName: name,
                    comment: comment,
                    rating: rating,
                    status: 'pending',
                    createdAt: Date.now()
                });
                showToast("تم إرسال تعليقك للمراجعة، سيظهر بعد الموافقة");
                e.target.reset();
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء الإرسال");
            }
        };

        window.handleReviewAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            try {
                if (action === 'approve') {
                    // Check if verified checkbox is checked
                    const isVerified = document.getElementById(`verify-check-${id}`)?.checked || false;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id), { 
                        status: 'approved',
                        verified: isVerified 
                    });
                    showToast("تمت الموافقة على التعليق");
                } else {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id));
                    showToast("تم رفض التعليق وحذفه");
                }
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // --- 🆕 FIXED: Modification Request Logic (إصلاح طلب التعديل) ---
        window.toggleModModal = (show) => {
            const backdrop = document.getElementById('mod-modal-backdrop');
            const modal = document.getElementById('mod-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
        };

        window.openModRequestModal = (orderId) => {
            document.getElementById('mod-order-id').value = orderId;
            toggleModModal(true);
        };

        window.handleSubmitModRequest = async (e) => {
            e.preventDefault();
            const orderId = e.target.orderId.value;
            const message = e.target.message.value.trim();

            if (!message) return showToast("يرجى كتابة تفاصيل التعديل");

            try {
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "جاري الإرسال...";

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
                    modificationRequest: {
                        message: message,
                        status: 'pending',
                        createdAt: Date.now()
                    },
                    // إضافة للسجل الزمني
                    statusHistory: arrayUnion({
                        status: 'modification_requested',
                        timestamp: Date.now(),
                        note: `طلب العميل تعديل: ${message}`
                    })
                });

                showToast("تم إرسال طلب التعديل للإدارة بنجاح");
                toggleModModal(false);
                e.target.reset();
                btn.disabled = false;
                btn.innerText = originalText;
                
                // تحديث الواجهة فوراً إذا كنا في صفحة التتبع
                const resultContainer = document.getElementById('tracking-result');
                if (resultContainer && resultContainer.innerHTML !== "") {
                    // إعادة جلب الطلب لتحديث الحالة الظاهرة
                    const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                    if(docSnap.exists()){
                         const order = { id: docSnap.id, ...docSnap.data() };
                         renderTrackingTimeline(resultContainer, order);
                    }
                }

            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء الإرسال");
                e.target.querySelector('button').disabled = false;
                e.target.querySelector('button').innerText = "إرسال الطلب للإدارة";
            }
        };
        // -----------------------------------------------------------

        // --- 1️⃣2️⃣ FIXED: Admin Edit Order Logic (إصلاح تعديل الطلب) ---
        
        window.toggleEditOrderModal = (show) => {
            const backdrop = document.getElementById('edit-order-modal-backdrop');
            const modal = document.getElementById('edit-order-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
        };

        window.openEditOrderModal = (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const order = ALL_ORDERS.find(o => o.id === id);
            if (!order) return showToast("الطلب غير موجود");

            const form = document.getElementById('edit-order-form');
            form.orderId.value = order.id;
            form.customerName.value = order.customer.name;
            form.customerPhone.value = order.customer.phone;
            form.customerAddress.value = order.customer.address;
            form.totalAmount.value = order.totalAmount;

            toggleEditOrderModal(true);
        };

        window.handleUpdateOrder = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            const id = e.target.orderId.value;
            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            const total = parseFloat(e.target.totalAmount.value);

            if (!name || !phone || !address || isNaN(total)) {
                return showToast("يرجى التأكد من صحة البيانات");
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'customer.name': name,
                    'customer.phone': phone,
                    'customer.address': address,
                    'totalAmount': total,
                    statusHistory: arrayUnion({
                        status: 'edited',
                        timestamp: Date.now(),
                        note: 'تم تعديل بيانات الطلب يدوياً بواسطة المدير'
                    })
                });
                showToast("✅ تم تحديث بيانات الطلب بنجاح");
                toggleEditOrderModal(false);
            } catch(err) {
                console.error(err);
                showToast("❌ فشل تحديث الطلب");
            }
        };
        // -----------------------------------------------------------

        // NEW: Handle Order Actions
        window.handleOrderAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                if (action === 'delete') {
                    if(!confirm("⚠️ تحذير: هل أنت متأكد من حذف هذا الطلب نهائياً؟ لا يمكن التراجع.")) return;
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    showToast("تم حذف الطلب نهائياً");
                } else if (action === 'archive') {
                    if(!confirm("هل تريد نقل هذا الطلب إلى الأرشيف؟")) return;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: true,
                        // إضافة سجل للعملية
                        statusHistory: arrayUnion({
                            status: 'archived',
                            timestamp: Date.now(),
                            note: 'تم نقل الطلب للأرشيف يدوياً'
                        })
                    });
                    showToast("تم نقل الطلب إلى الأرشيف 🗄️");
                    
                } else if (action === 'restore') {
                    if(!confirm("هل تريد استعادة هذا الطلب للقائمة الجارية؟")) return;

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: false,
                        // إضافة سجل للعملية
                        statusHistory: arrayUnion({
                            status: 'restored',
                            timestamp: Date.now(),
                            note: 'تم استعادة الطلب من الأرشيف'
                        })
                    });
                    showToast("تم استعادة الطلب للقائمة الرئيسية ↩️");
                }
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ في تحديث الطلب");
            }
        };

        // NEW: Handle Modification Decision (Admin)
        window.handleModDecision = async (id, decision) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                // decision: 'approved' or 'rejected'
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'modificationRequest.status': decision,
                    'modificationRequest.adminRespondedAt': Date.now()
                });
                
                if (decision === 'approved') {
                    showToast("تمت الموافقة على طلب التعديل (يرجى تنفيذ التعديل يدوياً إذا لزم الأمر)");
                    // Optional: Open edit modal automatically if approved to let admin make changes
                    // openEditOrderModal(id); 
                } else {
                    showToast("تم رفض طلب التعديل");
                }
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // NEW: Handle Order Status Change (Admin)
        window.handleOrderStatusChange = async (id, newStatus) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                // الحصول على النص العربي للحالة
                const statusLabel = STATUS_ARABIC_MAP[newStatus] || newStatus;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    status: newStatus,
                    // --- NEW: إضافة للسجل الزمني ---
                    statusHistory: arrayUnion({
                        status: newStatus,
                        timestamp: Date.now(),
                        note: `تم تغيير الحالة إلى: ${statusLabel}`
                    })
                    // -----------------------------
                });
                showToast("تم تحديث حالة الطلب بنجاح");

                // --- NEW: إرسال إشعار للعميل ---
                const order = ALL_ORDERS.find(o => o.id === id);
                if (order) {
                    // Update local object immediately to reflect in UI without refresh if needed
                    if (!order.statusHistory) order.statusHistory = [];
                    order.statusHistory.push({
                        status: newStatus,
                        timestamp: Date.now(),
                        note: `تم تغيير الحالة إلى: ${statusLabel}`
                    });
                    
                    notifyOrderStatus(order, newStatus);
                }
                // -----------------------------

            } catch(err) {
                console.error(err);
                showToast("فشل تحديث الحالة");
            }
        };

        // --- NEW: دالة إضافة ملاحظة داخلية ---
        window.addInternalNote = async (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const input = document.getElementById(`note-input-${id}`);
            const text = input.value.trim();
            
            if (!text) return;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    internalNotes: arrayUnion({
                        text: text,
                        timestamp: Date.now(),
                        admin: user.displayName || 'Admin'
                    })
                });
                showToast("تم حفظ الملاحظة الداخلية");
                input.value = ''; // تفريغ الحقل
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء حفظ الملاحظة");
            }
        };

        // --- 9️⃣ CSV EXPORT FUNCTION ---
        window.exportOrdersToCSV = (range) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            let filteredOrders = ALL_ORDERS;
            const now = new Date();
            
            // Filter Logic
            if (range === 'today') {
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d.toDateString() === now.toDateString();
                });
            } else if (range === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d >= weekAgo;
                });
            } else if (range === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredOrders = filteredOrders.filter(o => {
                    const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return d >= monthAgo;
                });
            }

            if (filteredOrders.length === 0) return showToast("لا توجد طلبات في هذه الفترة لتصديرها");

            // CSV Header
            let csvContent = "\uFEFF"; // BOM for Excel Arabic support
            csvContent += "رقم الطلب,اسم العميل,رقم الهاتف,العنوان,إجمالي المبلغ,طريقة الدفع,حالة الطلب,تاريخ الطلب\n";

            // CSV Rows
            filteredOrders.forEach(o => {
                const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                const dateStr = d.toLocaleDateString('ar-EG') + " " + d.toLocaleTimeString('ar-EG');
                
                // Escape commas in address/name to prevent column shift
                const cleanName = `"${(o.customer.name || '').replace(/"/g, '""')}"`;
                const cleanAddress = `"${(o.customer.address || '').replace(/"/g, '""')}"`;
                const paymentAr = o.paymentMethod === 'vodafone_cash' ? 'فودافون كاش' : 'عند الاستلام';
                const statusAr = STATUS_ARABIC_MAP[o.status] || o.status;

                csvContent += `${o.id},${cleanName},'${o.customer.phone},${cleanAddress},${o.totalAmount},${paymentAr},${statusAr},${dateStr}\n`;
            });

            // Trigger Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `orders_export_${range}_${now.toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`تم تصدير ${filteredOrders.length} طلب بنجاح`);
        };

        // NEW: Handle Payment Review Decision (Vodafone Cash) - UPDATED FOR AUTO WHATSAPP
        window.handlePaymentDecision = async (id, decision) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            // جلب بيانات الطلب أولاً لاستخدام اسم ورقم العميل
            const order = ALL_ORDERS.find(o => o.id === id);
            if (!order) return showToast("بيانات الطلب غير موجودة");

            try {
                let updateData = {};
                let msg = "";
                let whatsappMsg = ""; // الرسالة المنسقة
                
                if (decision === 'approve') {
                    // قبول الدفع: تحويل الحالة إلى مؤكد (مدفوع)
                    updateData = {
                        status: 'confirmed', 
                        'paymentDetails.verified': true,
                        'paymentDetails.verifiedAt': Date.now(),
                        'paymentDetails.adminNote': 'تم تأكيد وصول المبلغ',
                        // --- NEW: إضافة للسجل الزمني ---
                        statusHistory: arrayUnion({
                            status: 'confirmed',
                            timestamp: Date.now(),
                            note: 'تم تأكيد استلام الدفع بنجاح'
                        })
                        // -----------------------------
                    };
                    msg = "تم تأكيد الدفع بنجاح وتحويل الطلب إلى (مؤكد)";

                    // === رسالة القبول المنسقة ===
                    whatsappMsg = `مرحبًا أ/ ${order.customer.name}\n\n` +
                        `يسعدنا إبلاغك بأنه تم تأكيد استلام قيمة طلبك بنجاح.\n` +
                        `رقم الطلب: *${order.id}*\n` +
                        `المبلغ المستلم: *${order.paymentDetails.amountPaid} ج.م*\n` +
                        `جاري حاليًا تجهيز طلبك داخل المخازن، وسيتم شحنه في أقرب وقت ممكن.\n\n` +
                        `سنوافيك بتفاصيل الشحن فور خروج الطلب.\n` +
                        `شكرًا لثقتك في جدار للديكور 🤍`;

                } else {
                    // رفض الدفع: طلب سبب الرفض
                    const reason = prompt("يرجى كتابة سبب الرفض (سيظهر للعميل):", "المبلغ لم يصل المحفظة / البيانات غير مطابقة");
                    if (reason === null) return; // ألغى المدير العملية

                    updateData = {
                        status: 'payment_pending',
                        'paymentDetails.verified': false,
                        'paymentDetails.rejectedAt': Date.now(),
                        'paymentDetails.adminNote': reason, // حفظ السبب المدخل
                        // --- NEW: إضافة للسجل الزمني ---
                        statusHistory: arrayUnion({
                            status: 'payment_pending',
                            timestamp: Date.now(),
                            note: `رفض عملية الدفع: ${reason}`
                        })
                        // -----------------------------
                    };
                    msg = "تم رفض الدفع وتسجيل السبب للعميل";

                    // === رسالة الرفض المنسقة ===
                    const trackLink = `${window.location.origin}${window.location.pathname}#/track-order`;
                    whatsappMsg = `مرحباً ${order.customer.name} 👋\n` +
                        `تحديث بخصوص طلبك رقم *#${order.id}*\n\n` +
                        `عذراً، لم نتمكن من تأكيد عملية الدفع ❌\n` +
                        `⚠️ السبب: *${reason}*\n\n` +
                        `يرجى مراجعة البيانات وإعادة المحاولة عبر رابط التتبع:\n${trackLink}`;
                }

                // تحديث قاعدة البيانات
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), updateData);
                showToast(msg);

                // === فتح واتساب تلقائياً ===
                const phone = "20" + order.customer.phone.replace(/^0+/, ""); // تنسيق الرقم المصري
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(whatsappMsg)}`;
                
                // فتح في نافذة جديدة (قد يحتاج المتصفح لسماحية Pop-ups لأول مرة)
                const win = window.open(url, '_blank');
                if (win) {
                    win.focus();
                } else {
                    showToast("يرجى السماح بالنوافذ المنبثقة لفتح واتساب تلقائياً");
                    // Fallback link click
                    window.location.href = url;
                }

            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء تحديث حالة الدفع");
            }
        };

        window.handlePlaceOrder = async (e) => {
            e.preventDefault();
            
            // Lock Check: منع التكرار
            if (isOrderSubmitting) return;
            if (cart.length === 0) return;

            // 1. Get Button & Save Original State
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;

            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            
            // --- VALIDATION START ---
            if (!name || !phone || !address) {
                return showToast("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، العنوان)");
            }

            // Phone Validation Regex (Egypt Mobile Numbers)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showToast("رقم الهاتف غير صحيح. يجب أن يتكون من 11 رقم ويبدأ بـ 010, 011, 012, أو 015");
                return;
            }
            // --- VALIDATION END ---

            // 2. Set Loading State & Lock
            isOrderSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>جاري إصدار الفاتورة...</span></div>`;
            submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

            // Get Payment Method
            const paymentMethod = e.target.paymentMethod ? e.target.paymentMethod.value : 'cod';
            
            // 4️⃣ Get Partial Payment Status (FIXED)
            const isPartial = document.getElementById('isPartial') && document.getElementById('isPartial').checked && paymentMethod === 'vodafone_cash';

            // Recalculate logic securely
            const isDelivery = document.getElementById('delivery-check').checked;
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let deliveryFee = 0;
            let deliveryStatus = "no_delivery"; 

            if (isDelivery) {
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                if (isFixedArea) {
                    deliveryFee = FIXED_DELIVERY_FEE;
                    deliveryStatus = "fixed";
                } else {
                    deliveryStatus = "courier";
                }
            }

            const totalAmount = cartTotal + deliveryFee;
            const initialStatus = paymentMethod === 'vodafone_cash' ? 'pending_payment' : 'new';

            const orderData = {
                customer: {
                    name: name,
                    phone: phone,
                    address: address
                },
                items: cart,
                subtotal: cartTotal,
                delivery: {
                    requested: isDelivery,
                    fee: deliveryFee,
                    status: deliveryStatus, 
                    areasMatch: deliveryStatus === 'fixed'
                },
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                isPartialPayment: isPartial, // 4️⃣ Save Partial Flag
                status: initialStatus,
                createdAt: serverTimestamp(),
                userId: user && !user.isAnonymous ? user.uid : 'guest',
                statusHistory: [{
                    status: initialStatus,
                    timestamp: Date.now(),
                    note: isPartial ? 'تم إنشاء الطلب (بنظام العربون)' : 'تم إنشاء الطلب بنجاح'
                }]
            };

            try {
                // --- 8️⃣ SMART ORDER NUMBERING (الترقيم الذكي) ---
                // نستخدم Transaction لضمان عدم تكرار الرقم حتى لو طلب شخصين في نفس اللحظة
                
                const finalOrderId = await runTransaction(db, async (transaction) => {
                    // ... existing transaction code ...
                    const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'orderCounter');
                    const counterDoc = await transaction.get(counterRef);
                    let currentSeq = 0;
                    if (counterDoc.exists()) currentSeq = counterDoc.data().seq || 0;
                    const nextSeq = currentSeq + 1;
                    const year = new Date().getFullYear();
                    const formattedId = `GD-${year}-${String(nextSeq).padStart(5, '0')}`;
                    const newOrderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', formattedId);
                    transaction.set(newOrderRef, orderData);
                    transaction.set(counterRef, { seq: nextSeq }, { merge: true });
                    return formattedId;
                });
                
                // --- 🆕 SEND DIRECT BOT NOTIFICATION ---
                // Save and get Reference (Using addDoc as per current implementation)
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                
                // Notifications ...
                if (GOOGLE_SCRIPT_URL) {
                    const itemsSummary = cart.map(i => `${i.name} (${i.quantity})`).join(' + ');
                    
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: docRef.id, 
                            customerName: name,
                            customerPhone: phone,
                            address: address,
                            totalAmount: totalAmount,
                            paymentMethod: paymentMethod === 'vodafone_cash' ? (isPartial ? 'فودافون كاش (عربون)' : 'فودافون كاش') : 'عند الاستلام',
                            items: itemsSummary
                        })
                    }).catch(err => console.log("Notification Error:", err));
                }

                cart = [];
                saveCart(); 
                updateCartUI(); 
                toggleCheckoutModal(false);
                e.target.reset();
                
                // 3. Reset Button State (Success) & Unlock
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                
                // BRANCHING LOGIC based on Payment Method
                if (paymentMethod === 'vodafone_cash') {
                    // FIX: Pass isPartial correctly here
                    handleVodafoneCashFlow(docRef.id, totalAmount, isPartial); 
                } else {
                    toggleSuccessModal(true, docRef.id, false); 
                }
                
            } catch (error) {
                console.error("Order Error:", error);
                showToast("حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.");
                isOrderSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        };

        function renderTrackingTimeline(container, order) {
            const steps = [
                { id: 'new', label: 'تم الطلب', icon: 'shopping-bag', desc: 'تم استلام طلبك بنجاح وهو قيد المراجعة.' },
                { id: 'pending_payment', label: 'بانتظار الدفع', icon: 'credit-card', desc: 'يرجى إتمام عملية الدفع لتأكيد الطلب.' },
                { id: 'payment_review', label: 'مراجعة الدفع', icon: 'file-search', desc: 'جاري مراجعة بيانات الدفع التي أرسلتها لتأكيد الطلب.' },
                { id: 'confirmed', label: 'تم التأكيد', icon: 'check-circle', desc: 'تم تأكيد طلبك والدفع بنجاح.' },
                { id: 'processing', label: 'جاري التجهيز', icon: 'package', desc: 'يقوم فريقنا بتجهيز وتغليف طلبك حالياً.' },
                { id: 'shipped', label: 'تم الشحن', icon: 'truck', desc: 'الشحنة خرجت مع مندوب التوصيل في طريقها إليك.' },
                { id: 'delivered', label: 'تم التوصيل', icon: 'home', desc: 'تم تسليم الطلب بنجاح. نتمنى أن ينال إعجابك!' }
            ];

            const currentStatus = order.status || 'new';
            const currentIndex = steps.findIndex(s => s.id === currentStatus);
            const currentStepInfo = (currentIndex !== -1) ? steps[currentIndex] : steps[0];
            const isDelivered = currentStatus === 'delivered';
            const progressPercent = Math.min(100, Math.max(0, (currentIndex / (steps.length - 1)) * 100));

            // ... (Payment Rejection HTML & Mod Req HTML code same as before) ...
            // للاختصار سأضع الأكواد المتغيرة هنا، يمكنك الحفاظ على الأكواد القديمة للأقسام الأخرى
            
            let paymentRejectionHTML = '';
            if (order.paymentDetails && order.paymentDetails.verified === false && order.status === 'payment_pending') {
                const rejectionReason = order.paymentDetails.adminNote || "يرجى مراجعة البيانات.";
                const waNumber = "201014175070";
                const waText = encodeURIComponent(`مرحباً، لدي استفسار بخصوص رفض الدفع للطلب رقم #${order.id}`);
                paymentRejectionHTML = `
                <div class="bg-red-50 border-2 border-red-100 rounded-2xl p-6 mb-8 flex flex-col md:flex-row gap-5 items-start animate-in fade-in slide-in-from-top-4 shadow-sm">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center shrink-0 text-red-600">
                        <i data-lucide="x-octagon" size="24"></i>
                    </div>
                    <div class="flex-1 w-full">
                        <h3 class="font-bold text-lg text-red-800 mb-1">عذراً، تم رفض عملية الدفع</h3>
                        <p class="text-red-700 font-medium text-sm mb-3">السبب: "<span class="font-bold">${rejectionReason}</span>"</p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="handleVodafoneCashFlow('${order.id}', ${order.totalAmount})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="refresh-cw" size="16"></i> إعادة إرسال البيانات</button>
                            <a href="https://wa.me/${waNumber}?text=${waText}" target="_blank" class="flex-1 bg-white border border-green-500 text-green-600 hover:bg-green-50 px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="message-circle" size="16"></i> حل النزاع (واتساب)</a>
                        </div>
                    </div>
                </div>`;
            }

            let modReqHTML = '';
            if (order.modificationRequest && order.modificationRequest.status === 'pending') {
                modReqHTML = `<div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6 flex items-start gap-3"><i data-lucide="clock" class="text-orange-500 mt-1 shrink-0"></i><div><h4 class="font-bold text-orange-700 text-sm">طلب التعديل قيد المراجعة</h4><p class="text-orange-600 text-xs mt-1">طلبت: "${order.modificationRequest.message}"</p></div></div>`;
            } else if (currentStatus !== 'delivered' && currentStatus !== 'shipped' && !order.modificationRequest) {
                modReqHTML = `<div class="mb-6 text-center"><button onclick="openModRequestModal('${order.id}')" class="text-sm font-bold text-stone-500 hover:text-stone-900 underline decoration-stone-300 underline-offset-4 flex items-center justify-center gap-2 mx-auto transition-colors"><i data-lucide="edit-3" size="14"></i> هل تريد طلب تعديل على هذا الطلب؟</button></div>`;
            }

            container.innerHTML = `
                <!-- 1. Hero Status Card -->
                <div class="bg-white rounded-3xl p-6 md:p-8 shadow-xl shadow-stone-200/40 mb-8 border border-white relative overflow-hidden group fade-in-up">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-stone-50 rounded-full -mr-20 -mt-20 blur-3xl transition-colors duration-500 group-hover:bg-stone-100"></div>
                    <div class="absolute bottom-0 left-0 w-40 h-40 ${isDelivered ? 'bg-green-50' : 'bg-blue-50'} rounded-full -ml-10 -mb-10 blur-3xl opacity-60"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-stone-100 text-stone-600 mb-4 border border-stone-200">
                                <span class="w-1.5 h-1.5 rounded-full ${isDelivered ? 'bg-green-500' : 'bg-blue-500 animate-pulse'}"></span>
                                رقم الطلب #${order.id}
                            </div>
                            <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mb-2 tracking-tight">${currentStepInfo.label}</h2>
                            <p class="text-stone-500 text-sm md:text-base max-w-md leading-relaxed">${currentStepInfo.desc}</p>
                        </div>
                        <div class="w-20 h-20 md:w-24 md:h-24 ${isDelivered ? 'bg-green-100 text-green-600' : 'bg-stone-900 text-white'} rounded-3xl flex items-center justify-center shadow-lg transform rotate-3 transition-transform hover:rotate-6">
                            <i data-lucide="${currentStepInfo.icon}" size="40"></i>
                        </div>
                    </div>
                </div>

                ${paymentRejectionHTML}
                ${modReqHTML}

                <div class="space-y-8 fade-in-up" style="animation-delay: 0.1s;">
                    
                    <!-- 2. Horizontal Timeline (Full Width) -->
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 overflow-hidden">
                        <div class="overflow-x-auto pb-4 custom-scrollbar">
                            <div class="min-w-[700px] relative px-4 py-6">
                                <div class="absolute top-1/2 right-0 left-0 h-1 bg-stone-100 -translate-y-1/2 rounded-full z-0 mx-8"></div>
                                <div class="absolute top-1/2 right-0 h-1 bg-stone-900 -translate-y-1/2 rounded-full z-0 mx-8 transition-all duration-1000 ease-out" style="width: ${progressPercent}%"></div>
                                <div class="flex justify-between items-center relative z-10 w-full">
                                    ${steps.map((step, idx) => {
                                        const isCompleted = idx <= currentIndex;
                                        const isCurrent = idx === currentIndex;
                                        return `<div class="flex flex-col items-center gap-4 relative group cursor-default text-center w-32">
                                            <div class="w-12 h-12 rounded-full border-[3px] flex items-center justify-center transition-all duration-500 z-10 ${isCompleted ? 'bg-stone-900 border-stone-900 text-white shadow-lg scale-110' : 'bg-white border-stone-200 text-stone-300'} ${isCurrent ? 'ring-4 ring-stone-100' : ''}"><i data-lucide="${step.icon}" size="${isCurrent ? 20 : 18}"></i></div>
                                            <div class="flex flex-col items-center"><h4 class="font-bold text-sm ${isCompleted ? 'text-stone-900' : 'text-stone-400'} mb-1 transition-colors">${step.label}</h4>${isCurrent ? `<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold animate-pulse">الحالية</span>` : ''}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. NEW: Detailed Order Timeline Log (Sijil Zamani) -->
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 relative overflow-hidden">
                        <h3 class="font-bold text-lg mb-8 flex items-center gap-2 text-stone-900">
                            <div class="p-2 bg-stone-50 rounded-lg"><i data-lucide="history" class="text-stone-900" size="20"></i></div>
                            سجل النشاطات (Timeline)
                        </h3>
                        
                        <div class="relative border-r-2 border-stone-100 mr-3 space-y-8 pb-2">
                            ${(order.statusHistory && order.statusHistory.length > 0) ? order.statusHistory.sort((a,b) => b.timestamp - a.timestamp).map((log, idx) => {
                                const dateObj = new Date(log.timestamp);
                                const dateStr = dateObj.toLocaleDateString('ar-EG');
                                const timeStr = dateObj.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                                const isFirst = idx === 0;
                                
                                return `
                                <div class="relative pr-8 animate-in fade-in slide-in-from-right-4" style="animation-delay: ${idx * 0.1}s">
                                    <!-- Dot -->
                                    <div class="absolute -right-[9px] top-1.5 w-4 h-4 rounded-full border-2 border-white ${isFirst ? 'bg-green-500 ring-4 ring-green-100 shadow-md' : 'bg-stone-300'}"></div>
                                    
                                    <div class="bg-stone-50 p-4 rounded-2xl border border-stone-100 ${isFirst ? 'bg-green-50/50 border-green-100' : ''}">
                                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-1 mb-2">
                                            <h4 class="font-bold text-stone-900 text-sm ${isFirst ? 'text-green-800' : ''}">${STATUS_ARABIC_MAP[log.status] || log.status}</h4>
                                            <span class="text-[10px] text-stone-400 dir-ltr font-mono bg-white px-2 py-0.5 rounded border border-stone-100">${dateStr} | ${timeStr}</span>
                                        </div>
                                        <p class="text-xs text-stone-600 leading-relaxed font-medium">${log.note || 'لا توجد ملاحظات إضافية'}</p>
                                    </div>
                                </div>
                                `;
                            }).join('') : `
                                <div class="relative pr-8">
                                    <div class="absolute -right-[9px] top-1.5 w-4 h-4 rounded-full bg-stone-300 border-2 border-white"></div>
                                    <h4 class="font-bold text-stone-900 text-sm">بداية السجل</h4>
                                    <p class="text-xs text-stone-500 mt-1">سجل النشاطات متاح للطلبات الجديدة فقط.</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- 4. Invoice Summary -->
                    <div class="bg-white rounded-3xl shadow-xl shadow-stone-200/50 border border-stone-100 overflow-hidden transform transition-all hover:-translate-y-1 duration-300">
                        <div class="p-6 bg-stone-900 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-8 -mb-8 blur-2xl"></div>
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="receipt" size="18" class="text-stone-400"></i> ملخص الفاتورة</h3>
                                    <p class="text-stone-400 text-xs mt-1 font-mono tracking-wider opacity-80">ORDER #${order.id}</p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/10"><i data-lucide="shopping-bag" size="20" class="text-white"></i></div>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2">
                            <div class="p-6 bg-white md:border-l md:border-stone-100 max-h-[350px] overflow-y-auto custom-scrollbar space-y-4">
                                ${order.items.map(item => `
                                    <div class="flex items-center gap-4 group">
                                        <div class="w-14 h-14 bg-stone-50 rounded-xl border border-stone-100 overflow-hidden flex-shrink-0 relative">
                                            <img src="${item.selectedColor && item.variants ? (item.variants.find(v=>v.color===item.selectedColor)?.image || item.image) : item.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                            <span class="absolute bottom-0 right-0 bg-stone-900 text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-tl-lg font-bold">${item.quantity}</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-bold text-stone-900 text-sm truncate mb-0.5">${item.name}</h4>
                                            <p class="text-xs text-stone-500 font-medium">سعر القطعة: $${item.price}</p>
                                            ${item.selectedColor ? `<p class="text-[10px] text-stone-400 mt-0.5 bg-stone-50 inline-block px-1.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                                        </div>
                                        <div class="text-right"><p class="font-serif font-bold text-stone-900 text-sm">$${(item.price * item.quantity).toFixed(2)}</p></div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex flex-col">
                                <div class="p-6 bg-stone-50 space-y-3 flex-1">
                                    <div class="flex justify-between items-center text-xs font-bold text-stone-500"><span>المجموع الفرعي</span><span class="font-serif text-stone-700">$${order.items.reduce((s, i) => s + (i.price * i.quantity), 0).toFixed(2)}</span></div>
                                    ${order.delivery && order.delivery.requested ? `<div class="flex justify-between items-center text-xs font-bold text-stone-500"><span>الشحن</span><span class="font-serif text-stone-700">${order.delivery.fee > 0 ? '$' + order.delivery.fee.toFixed(2) : 'حسب المنطقة'}</span></div>` : ''}
                                    <div class="flex justify-between items-center pt-3 border-t border-stone-200 mt-2"><span class="text-base font-bold text-stone-900">الإجمالي الكلي</span><span class="text-xl font-serif font-black text-stone-900">$${Number(order.totalAmount).toFixed(2)}</span></div>
                                </div>
                                <div class="p-5 bg-stone-50/50 border-t border-stone-100 text-xs">
                                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                                        <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm"><i data-lucide="user" size="14"></i></div><div><p class="text-[10px] text-stone-400 font-bold mb-0.5">العميل</p><p class="font-bold text-stone-900 text-sm">${order.customer.name}</p></div></div>
                                        <div class="flex items-center gap-2"><div class="text-right"><p class="text-[10px] text-stone-400 font-bold mb-0.5">الهاتف</p><p class="font-mono text-stone-700 font-bold dir-ltr bg-white px-2 py-0.5 rounded border border-stone-100">${order.customer.phone}</p></div><div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm"><i data-lucide="phone" size="14"></i></div></div>
                                    </div>
                                    <div class="bg-white p-3 rounded-xl border border-stone-200 shadow-sm flex gap-3 items-start"><i data-lucide="map-pin" size="16" class="text-orange-500 shrink-0 mt-0.5"></i><div><p class="text-[10px] text-stone-400 font-bold mb-1">عنوان التوصيل</p><p class="text-stone-700 leading-relaxed font-medium">${order.customer.address}</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                // Extra check immediately after popup
                if (result.user.email !== ADMIN_EMAIL) {
                    await signOut(auth);
                    showToast("عذراً، الدخول مقتصر على حساب المالك فقط: " + ADMIN_EMAIL);
                    return;
                }
                showToast("مرحباً بك يا مدير المتجر");
                setView('home');
            } catch (error) {
                console.error(error);
                showToast("فشل تسجيل الدخول");
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showToast("تم تسجيل الخروج");
                setView('home');
            } catch (error) { console.error(error); }
        };

        // --- Search Logic ---
        let isSearchOpen = false;

        window.toggleTopSearch = (e) => {
            e.stopPropagation();
            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            
            if (!isSearchOpen) {
                // Open
                bar.classList.remove('w-10', 'bg-stone-50', 'border-transparent');
                // تم التعديل: استخدام w-40 للموبايل و md:w-64 للكمبيوتر
                bar.classList.add('w-40', 'md:w-64', 'bg-white', 'border-stone-200', 'shadow-sm');
                input.classList.remove('opacity-0');
                input.focus();
                isSearchOpen = true;
            } else {
                // If clicked while open and empty, close it. If has text, search.
                if(input.value.trim() !== "") {
                     updateShopFilters('search', input.value.trim());
                     setView('shop');
                } else {
                    closeTopSearch(); // Toggle close if empty
                }
            }
        };

        window.closeTopSearch = () => {
            if(!isSearchOpen) return;
            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            
            bar.classList.add('w-10', 'bg-stone-50', 'border-transparent');
            // تم التعديل: إزالة كلاسات العرض المتجاوب عند الإغلاق
            bar.classList.remove('w-40', 'md:w-64', 'bg-white', 'border-stone-200', 'shadow-sm');
            input.classList.add('opacity-0');
            input.blur();
            isSearchOpen = false;
        };

        window.handleGlobalSearch = (e) => {
            if(e.key === 'Enter') {
                const val = e.target.value.trim();
                if(val) {
                     updateShopFilters('search', val);
                     setView('shop');
                     closeTopSearch(); // Optional: close after search
                }
            }
        };

        // NEW: Filter Drawer Logic
        window.toggleFilterDrawer = (show) => {
            const sidebar = document.getElementById('shop-sidebar');
            const overlay = document.getElementById('filter-sidebar-overlay');
            if (show) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        // --- Internal Helpers ---

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            const badge = document.getElementById('cart-badge');
            const totalEl = document.getElementById('cart-total');
            const countSummary = document.getElementById('cart-count-summary');
            
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            totalEl.innerText = `$${total.toFixed(2)}`;
            if(countSummary) countSummary.innerText = count;

            if (cart.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-in fade-in zoom-in duration-300">
                    <div class="w-32 h-32 bg-stone-50 rounded-full flex items-center justify-center mb-4 relative">
                        <div class="absolute inset-0 border-2 border-dashed border-stone-200 rounded-full animate-[spin_10s_linear_infinite]"></div>
                        <i data-lucide="shopping-bag" size="48" class="text-stone-300"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">سلة التسوق فارغة</h3>
                        <p class="text-stone-500 text-sm max-w-[200px] mx-auto">يبدو أنك لم تضف أي منتجات بعد. تصفح المتجر واكتشف خياراتنا المميزة.</p>
                    </div>
                    <button onclick="toggleCart(false)" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:-translate-y-0.5">
                        ابدأ التسوق
                    </button>
                </div>`;
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
                // نستخدم map مع index لأننا نحتاج الـ index للحذف والتعديل الدقيق
                container.innerHTML = cart.map((item, index) => {
                    // تحديد الصورة بناءً على اللون المختار
                    let displayImage = item.image;
                    if (item.selectedColor && item.variants) {
                        const variant = item.variants.find(v => v.color === item.selectedColor);
                        if (variant && variant.image) displayImage = variant.image;
                    }

                    return `
                    <div class="group flex gap-4 p-4 bg-white border border-stone-100 rounded-2xl hover:border-stone-300 hover:shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)] transition-all duration-300 relative overflow-hidden">
                        <!-- Image -->
                        <div class="h-24 w-24 flex-shrink-0 bg-stone-50 rounded-xl overflow-hidden border border-stone-100 relative">
                            <img src="${displayImage}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-700">
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <div class="flex justify-between items-start gap-2">
                                    <h3 class="font-bold text-stone-900 text-sm leading-snug line-clamp-2 hover:text-blue-600 transition-colors cursor-pointer" onclick="viewProduct('${item.id}'); toggleCart(false)">${item.name}</h3>
                                    <button onclick="removeFromCartByIndex(${index})" class="text-stone-300 hover:text-red-500 transition-colors p-1 -mt-1 -ml-1 rounded-full hover:bg-red-50"><i data-lucide="x" size="16"></i></button>
                                </div>
                                <p class="text-[10px] text-stone-400 mt-1 font-bold tracking-wider uppercase">${item.category}</p>
                                ${item.selectedColor ? `<p class="text-[10px] text-stone-500 mt-1 bg-stone-50 inline-block px-1.5 py-0.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                            </div>
                            
                            <!-- Controls -->
                            <div class="flex justify-between items-end mt-3">
                                <p class="text-base font-serif font-bold text-stone-900">$${item.price}</p>
                                
                                <div class="flex items-center gap-3 bg-stone-50 rounded-lg p-1 border border-stone-100">
                                    <button onclick="updateQuantityByIndex(${index}, -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors disabled:opacity-50 hover:text-stone-900"><i data-lucide="minus" size="14"></i></button>
                                    <span class="w-6 text-center text-sm font-bold text-stone-800 select-none">${item.quantity}</span>
                                    <button onclick="updateQuantityByIndex(${index}, 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors hover:text-stone-900"><i data-lucide="plus" size="14"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function updateFavoritesUI() {
            // Simplified: Only update badge
            const badge = document.getElementById('fav-badge');
            if(badge) badge.classList.toggle('hidden', favorites.length === 0);
        }

        function updateMegaMenu() {
            const list = document.getElementById('mega-menu-categories-list');
            const popularList = document.getElementById('mega-menu-popular-list');
            const mobList = document.getElementById('mobile-cats-list');
            
            // 1. Update List Column (Modern Text List - Limited to 3)
            if (list) {
                // عرض أول 3 أقسام فقط
                const visibleCats = CATEGORIES.slice(0, 3);
                
                let listHTML = visibleCats.map(cat => `
                    <li>
                        <button onclick="filterCategory('${cat.name}'); setView('shop')" class="flex items-center justify-between w-full p-3 rounded-xl hover:bg-stone-50 transition-all group text-right">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded bg-stone-100 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <img src="${cat.image}" class="w-full h-full object-cover rounded" onerror="this.style.display='none'">
                                </div>
                                <span class="font-bold text-sm text-stone-500 group-hover:text-stone-900 transition-colors">${cat.name}</span>
                            </div>
                            <i data-lucide="chevron-left" size="14" class="text-stone-300 group-hover:text-stone-900 group-hover:-translate-x-1 transition-all opacity-0 group-hover:opacity-100"></i>
                        </button>
                    </li>
                `).join('');

                // إضافة زر "تسوق المزيد" إذا كان هناك أكثر من 3 أقسام
                if (CATEGORIES.length > 3) {
                    listHTML += `
                    <li>
                        <button onclick="setView('categories')" class="flex items-center gap-3 w-full p-3 rounded-xl hover:bg-stone-50 transition-all group text-right mt-1">
                            <div class="w-6 h-6 rounded bg-stone-50 flex items-center justify-center text-stone-400 group-hover:text-stone-900 group-hover:bg-stone-200 transition-colors">
                                <i data-lucide="more-horizontal" size="14"></i>
                            </div>
                            <span class="font-bold text-sm text-stone-400 group-hover:text-stone-900 transition-colors">تسوق المزيد من الأقسام...</span>
                        </button>
                    </li>
                    `;
                }

                list.innerHTML = listHTML;
            }

            // 2. Update Popular Grid Column (Visual Cards)
            if (popularList) {
                // UPDATED: Display first 4 categories instead of 3
                const popularCats = CATEGORIES.slice(0, 4); 
                
                if (popularCats.length === 0) {
                    popularList.innerHTML = `<p class="col-span-4 text-center text-stone-400 py-12">لا توجد أقسام للعرض.</p>`;
                } else {
                    popularList.innerHTML = popularCats.map((cat, index) => `
                        <div onclick="filterCategory('${cat.name}'); setView('shop')" class="relative h-64 rounded-2xl overflow-hidden cursor-pointer group shadow-sm hover:shadow-xl transition-all duration-500 border border-stone-100 bg-stone-50">
                            <img src="${cat.image}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 ease-out" loading="lazy">
                            
                            <!-- Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/10 to-transparent opacity-80 group-hover:opacity-90 transition-opacity"></div>
                            
                            <!-- Content -->
                            <div class="absolute bottom-0 left-0 w-full p-4 translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h4 class="text-white font-bold text-lg mb-1">${cat.name}</h4>
                                <div class="flex items-center gap-2 text-white/70 text-[10px] font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75">
                                    <span>تصفح</span>
                                    <i data-lucide="arrow-left" size="10"></i>
                                </div>
                            </div>
                            
                            <!-- Floating Icon -->
                            <div class="absolute top-3 right-3 w-7 h-7 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white border border-white/20 opacity-0 group-hover:opacity-100 transition-all duration-300 -translate-y-2 group-hover:translate-y-0">
                                <i data-lucide="arrow-up-left" size="12"></i>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // 3. Update Mobile List (unchanged logic, just ensuring it runs)
            if (mobList) {
                mobList.innerHTML = CATEGORIES.map(cat => `
                    <button onclick="filterCategory('${cat.name}'); setView('shop'); toggleMobileMenu()" class="w-full py-3 text-center text-sm text-stone-600 hover:bg-stone-50 flex items-center justify-center gap-3">
                        <img src="${cat.image}" class="w-8 h-8 rounded-lg object-cover border border-stone-200">
                        ${cat.name}
                    </button>
                `).join('');
            }
            lucide.createIcons();
        }

        function applyShopFilters() {
            const grid = document.getElementById('shop-products-grid');
            const empty = document.getElementById('shop-empty-state');
            const count = document.getElementById('results-count');
            
            if (!grid) return;

            let filtered = PRODUCTS.filter(p => {
                const s = shopState.search;
                const matchesSearch = p.name.toLowerCase().includes(s) || (p.description && p.description.toLowerCase().includes(s));
                const matchesCat = shopState.categories.length === 0 || shopState.categories.includes(p.category);
                const matchesPrice = p.price >= shopState.priceMin && p.price <= shopState.priceMax;
                return matchesSearch && matchesCat && matchesPrice;
            });

            if (shopState.sort === 'price-low') filtered.sort((a, b) => a.price - b.price);
            else if (shopState.sort === 'price-high') filtered.sort((a, b) => b.price - a.price);
            else if (shopState.sort === 'newest') filtered.reverse();

            if (count) count.innerText = `النتائج: ${filtered.length}`;
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                if(empty) empty.classList.remove('hidden');
            } else {
                if(empty) empty.classList.add('hidden');
                grid.innerHTML = filtered.map(p => createProductCard(p)).join('');
            }
            lucide.createIcons();
        }

        // --- Render Views ---
        function renderView() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            
            // NEW: التحكم في ظهور البانر العلوي حسب الصفحة
            const banner = document.getElementById('header-banner-container');
            if (banner) {
                if (currentView === 'home' && HERO_SETTINGS.showFooterBanner && HERO_SETTINGS.footerBannerUrl) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }
            }
            
            if (currentView === 'home') {
                renderHero(main); 
                renderCategoryBar(main); 
                renderFeatured(main);
                renderCategorySections(main); 
                renderReviewsSection(main); // 1️⃣ Add Reviews to Home
            } else if (currentView === 'shop') {
                renderShop(main);
            } else if (currentView === 'offers') { 
                renderOffers(main);
            } else if (currentView === 'categories') {
                renderCategoriesView(main);
            } else if (currentView === 'about') {
                renderAbout(main);
            } else if (currentView === 'contact') {
                renderContact(main);
            } else if (currentView === 'return-policy') {
                renderReturnPolicy(main);
            } else if (currentView === 'faq') { 
                renderFAQ(main);
            } else if (currentView === 'product-details') {
                renderProductDetails(main);
            } else if (currentView === 'admin') {
                renderAdmin(main);
            } else if (currentView === 'orders') {
                renderOrders(main);
            } else if (currentView === 'login') {
                renderLogin(main);
            } else if (currentView === 'track-order') {
                renderTrackOrder(main);
            } else if (currentView === 'favorites') {
                renderFavoritesPage(main);
            }
            lucide.createIcons();
        }

        // --- NEW: Render Reviews Section (Customer Trust) ---
        function renderReviewsSection(c) {
            // تصفية المراجعات المعتمدة والتي لها تقييم عالي (4 أو 5 نجوم)
            // إذا لم تكن هناك مراجعات، نستخدم بيانات وهمية مؤقتة للبداية إذا أردت، أو نخفي القسم.
            // هنا سأعتمد على البيانات الحقيقية من ALL_REVIEWS.
            const validReviews = ALL_REVIEWS.filter(r => r.status === 'approved' && r.rating >= 4).slice(0, 6);
            
            // إذا لم توجد مراجعات كافية، يمكننا إضافة مراجعات افتراضية "للبداية" (اختياري، سأترك الحقيقية فقط للمصداقية)
            if (validReviews.length === 0) return;

            c.innerHTML += `
            <div class="py-16 bg-stone-50 border-t border-stone-100">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-10 fade-in-up">
                        <span class="inline-block p-2 rounded-xl bg-yellow-50 text-yellow-600 mb-3 border border-yellow-100 shadow-sm"><i data-lucide="message-square-heart" size="24"></i></span>
                        <h3 class="text-3xl font-bold text-stone-900 mb-2">آراء عملائنا</h3>
                        <p class="text-stone-500">نعتز بثقة عملائنا وتجاربهم المميزة مع جدار للديكور</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 fade-in-up" style="animation-delay: 0.1s;">
                        ${validReviews.map((r, i) => `
                            <div class="bg-white p-6 rounded-2xl border border-stone-100 shadow-sm hover:shadow-md transition-shadow relative">
                                <div class="absolute top-6 left-6 text-stone-200">
                                    <i data-lucide="quote" size="40"></i>
                                </div>
                                <div class="flex items-center gap-1 text-yellow-400 mb-3 relative z-10">
                                    ${Array(r.rating).fill('<i data-lucide="star" class="w-4 h-4 fill-current"></i>').join('')}
                                </div>
                                <p class="text-stone-700 text-sm leading-relaxed mb-6 relative z-10 font-medium">"${r.comment}"</p>
                                <div class="flex items-center gap-3 border-t border-stone-50 pt-4 relative z-10">
                                    <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 font-bold text-sm border border-stone-200">${r.userName.charAt(0)}</div>
                                    <div>
                                        <p class="text-sm font-bold text-stone-900">${r.userName}</p>
                                        <p class="text-[10px] text-stone-400">${new Date(r.createdAt).toLocaleDateString('ar-EG')}</p>
                                    </div>
                                    ${r.verified ? `<div class="mr-auto text-blue-500" title="شراء تم التحقق منه"><i data-lucide="badge-check" size="18"></i></div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        // NEW: Render Offers Page
        function renderOffers(c) {
            const now = Date.now();
            let timedOffers = PRODUCTS.filter(p => p.discount > 0 && p.discountExpiry && p.discountExpiry > now);
            let untimedOffers = PRODUCTS.filter(p => p.discount > 0 && !p.discountExpiry);
            
            // Sort timed offers by expiry (soonest first)
            timedOffers.sort((a, b) => a.discountExpiry - b.discountExpiry);
            
            const allOffers = [...timedOffers, ...untimedOffers];

            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 لرفع المحتوى -->
            <div class="pt-28 md:pt-24 pb-20 min-h-screen bg-red-50/30">
                <div class="container mx-auto px-2 md:px-6">
                    <div class="text-center mb-8 fade-in-up">
                        <span class="inline-block p-2 rounded-2xl bg-red-100 text-red-600 mb-2 shadow-sm border border-red-200 animate-pulse"><i data-lucide="timer" size="24"></i></span>
                        <h1 class="text-2xl md:text-4xl font-bold text-stone-900 mb-2">العروض الخاطفة</h1>
                        <p class="text-stone-500 text-xs md:text-lg">اغتنم الفرصة! خصومات حصرية لفترة محدودة.</p>
                    </div>

                    ${allOffers.length === 0 ? `
                        <div class="text-center py-20 bg-white rounded-3xl shadow-sm border border-stone-100 max-w-2xl mx-auto fade-in-up">
                            <div class="w-24 h-24 bg-stone-100 text-stone-300 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="tag" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">لا توجد عروض نشطة حالياً</h3>
                            <p class="text-stone-500 mb-8">تابعنا قريباً للحصول على أقوى الخصومات.</p>
                            <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all">تصفح كل المنتجات</button>
                        </div>
                    ` : `
                        <!-- Updated Grid: 3 columns on mobile with very small gap -->
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1.5 md:gap-4 fade-in-up" style="animation-delay: 0.1s;">
                            ${allOffers.map(p => {
                                // استخدام بطاقة المنتج المحسنة (الموجودة بالأسفل) أو بناء بطاقة مخصصة للعروض هنا
                                const finalPrice = (p.price * (1 - p.discount / 100)).toFixed(0); // إزالة الكسور للموبايل
                                return `
                                <div class="group bg-white rounded-xl border border-red-100 overflow-hidden hover:shadow-lg hover:border-red-200 transition-all h-full flex flex-col relative" onclick="viewProduct('${p.id}')">
                                    
                                    <!-- Discount Badge (Compact) -->
                                    <div class="absolute top-1 right-1 z-10">
                                        <div class="bg-red-600 text-white text-[8px] md:text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                                            -${p.discount}%
                                        </div>
                                    </div>

                                    <!-- Image -->
                                    <div class="relative aspect-[4/5] overflow-hidden bg-stone-100">
                                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                        
                                        <!-- Countdown Overlay (Mobile Optimized) -->
                                        ${p.discountExpiry ? `
                                        <div class="absolute bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm p-0.5 border-t border-red-100 flex flex-col items-center justify-center">
                                            <div class="discount-timer scale-75 origin-center" data-expiry="${p.discountExpiry}"></div>
                                        </div>` : ''}
                                    </div>

                                    <div class="p-2 flex-1 flex flex-col gap-1">
                                        <h3 class="font-bold text-stone-900 text-[10px] md:text-sm leading-tight line-clamp-2 h-7 md:h-auto group-hover:text-red-600 transition-colors">${p.name}</h3>
                                        
                                        <div class="mt-auto pt-1">
                                            <div class="flex flex-col md:flex-row md:items-center md:gap-1.5 mb-1.5">
                                                <span class="text-sm md:text-xl font-serif text-red-600 font-bold leading-none">${finalPrice}<span class="text-[8px] mr-0.5">ج.م</span></span>
                                                <span class="text-[9px] md:text-xs text-stone-400 line-through decoration-red-200">${Math.floor(p.price)}</span>
                                            </div>
                                            
                                            <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-1.5 md:py-2.5 rounded-lg font-bold shadow-sm transition-colors flex items-center justify-center gap-1 text-[9px] md:text-xs">
                                                <i data-lucide="shopping-bag" size="12"></i> <span class="hidden md:inline">إلحق العرض</span><span class="md:hidden">أضف</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `}
                </div>
            </div>`;
            
            startCountdown();
            lucide.createIcons();
        }

        // NEW: Render Favorites Page (Full Screen)
        function renderFavoritesPage(c) {
            const favItems = PRODUCTS.filter(p => favorites.includes(p.id));

            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="pt-28 md:pt-24 pb-20 min-h-screen bg-stone-50">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12 fade-in-up">
                        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
                            <i data-lucide="heart" size="32" class="fill-current"></i>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-3">قائمة الأمنيات</h1>
                        <p class="text-stone-500 font-medium">المنتجات التي حفظتها للرجوع إليها لاحقاً (${favItems.length})</p>
                    </div>

                    ${favItems.length === 0 ? `
                        <div class="max-w-md mx-auto text-center py-16 bg-white rounded-3xl shadow-sm border border-stone-100 fade-in-up" style="animation-delay: 0.1s;">
                            <div class="w-24 h-24 bg-stone-50 text-stone-300 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="heart-off" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">القائمة فارغة حالياً</h3>
                            <p class="text-stone-500 mb-8 px-6 leading-relaxed">لم تقم بإضافة أي منتجات إلى المفضلة بعد. تصفح المتجر واضغط على أيقونة القلب لحفظ ما يعجبك.</p>
                            <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto">
                                <span>تصفح المنتجات</span>
                                <i data-lucide="arrow-left" size="18"></i>
                            </button>
                        </div>
                    ` : `
                        <!-- Updated Grid: 3 columns on mobile -->
                        <div class="grid grid-cols-3 sm:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-6 fade-in-up" style="animation-delay: 0.1s;">
                            ${favItems.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-16 text-center fade-in-up" style="animation-delay: 0.2s;">
                            <button onclick="viewAllProducts()" class="inline-flex items-center gap-2 text-stone-500 font-bold hover:text-stone-900 transition-colors">
                                <i data-lucide="arrow-right" size="18"></i>
                                <span>متابعة التسوق</span>
                            </button>
                        </div>
                    `}
                </div>
            </div>`;
        }

        // NEW: Track Order Page
        function renderTrackOrder(c) {
            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="pt-28 md:pt-24 pb-20 container mx-auto px-6 min-h-screen">
                <div class="max-w-2xl mx-auto text-center mb-8 fade-in-up">
                    <span class="inline-block p-3 rounded-2xl bg-orange-50 text-orange-600 mb-4 shadow-sm border border-orange-100"><i data-lucide="package-search" size="28"></i></span>
                    <h1 class="text-2xl md:text-4xl font-bold text-stone-900 mb-2">تتبع حالة طلبك</h1>
                    <p class="text-stone-500">أدخل رقم الطلب الخاص بك لمعرفة مرحلة التوصيل الحالية</p>
                </div>

                <div class="max-w-xl mx-auto fade-in-up" style="animation-delay: 0.1s;">
                    <form onsubmit="handleTrackOrderSearch(event)" class="relative mb-12">
                        <input name="orderId" required class="w-full h-14 pl-4 pr-14 border-2 border-stone-200 rounded-full text-lg focus:outline-none focus:border-stone-900 focus:ring-0 transition-colors shadow-sm text-center font-mono placeholder:font-sans" placeholder="أدخل رقم الطلب هنا...">
                        <button class="absolute top-2 right-2 h-10 w-10 bg-stone-900 text-white rounded-full flex items-center justify-center hover:bg-stone-800 transition-colors shadow-md">
                            <i data-lucide="search" size="20"></i>
                        </button>
                    </form>
                    
                    <div id="tracking-result"></div>
                </div>
            </div>`;
        }

        function renderHero(c) {
            // Use dynamic settings only (No static fallbacks)
            const mainImg = HERO_SETTINGS.mainImage;
            const secImg = HERO_SETTINGS.secondaryImage;
            const pLabel = HERO_SETTINGS.priceLabel;
            const pValue = HERO_SETTINGS.priceValue;
            const dLabel = HERO_SETTINGS.discountLabel;
            const dValue = HERO_SETTINGS.discountValue;

            // Visibility Logic
            const showMobile = HERO_SETTINGS.showHeroMobile !== false; 
            const showDesktop = HERO_SETTINGS.showHeroDesktop !== false; 

            let visibilityClass = "";
            if (showMobile && showDesktop) visibilityClass = "flex";
            else if (showMobile && !showDesktop) visibilityClass = "flex lg:hidden";
            else if (!showMobile && showDesktop) visibilityClass = "hidden lg:flex";
            else visibilityClass = "hidden"; 

            if (!mainImg) {
                c.innerHTML = ``; 
                return;
            }

            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="relative min-h-[85vh] lg:min-h-[95vh] bg-stone-50 ${visibilityClass} items-center overflow-hidden pt-28 md:pt-20">
                <!-- Decorative Background Elements -->
                <div class="absolute inset-0 z-0">
                    <div class="absolute top-[-10%] right-[-5%] w-[600px] h-[600px] bg-orange-100/40 rounded-full blur-[100px]"></div>
                    <div class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-stone-200/40 rounded-full blur-[100px]"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-[0.03]"></div>
                </div>

                <div class="container mx-auto px-6 relative z-10 grid lg:grid-cols-12 gap-12 items-center">
                    <!-- Text Content -->
                    <div class="lg:col-span-6 space-y-8 fade-in-up order-2 lg:order-1">
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-stone-200 shadow-sm w-fit transition-transform hover:scale-105">
                            <span class="flex h-2 w-2 relative">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-orange-500"></span>
                            </span>
                            <span class="text-xs font-bold tracking-wider uppercase text-stone-600">جديد: بديل الخشب والرخام</span>
                        </div>
                        
                        <h1 class="text-5xl md:text-6xl lg:text-7xl font-bold leading-[1.1] text-stone-900 tracking-tight">
                            جدران تنبض <br/>
                            <span class="relative inline-block">
                                <span class="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-stone-800">بالفخامة والحياة</span>
                                <span class="absolute bottom-2 right-0 w-full h-3 bg-green-100/50 -z-0 -rotate-1"></span>
                            </span>
                        </h1>
                        
                        <p class="text-lg text-stone-600 max-w-lg leading-relaxed">
                            حول مساحتك العادية إلى تحفة فنية مع أحدث صيحات تجاليد الحوائط. 
                            نقدم لك بديل الخشب وبديل الرخام بجودة عالية ولمسات عصرية تدوم طويلاً.
                        </p>
                        
                        <div class="flex flex-wrap gap-4 pt-2">
                            <button onclick="viewAllProducts()" class="group bg-stone-900 text-white px-8 py-4 rounded-2xl font-bold hover:bg-stone-800 transition-all flex items-center gap-3 shadow-lg hover:shadow-xl hover:-translate-y-1 ring-4 ring-stone-900/10">
                                تسوق التشكيلة <i data-lucide="arrow-left" class="group-hover:-translate-x-1 transition-transform"></i>
                            </button>
                            <button onclick="setView('contact')" class="px-8 py-4 rounded-2xl font-bold text-stone-600 hover:bg-white hover:shadow-md transition-all border border-stone-200 bg-white/50 backdrop-blur-sm">
                                طلب معاينة
                            </button>
                        </div>

                        <!-- Trust Features -->
                        <div class="grid grid-cols-3 gap-4 pt-6 border-t border-stone-200/60">
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center text-orange-600 mb-2"><i data-lucide="droplets" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">مقاوم للماء</h4>
                                <p class="text-[10px] text-stone-500">ضمان عدم التأثر بالرطوبة</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-stone-100 flex items-center justify-center text-stone-600 mb-2"><i data-lucide="hammer" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">سهل التركيب</h4>
                                <p class="text-[10px] text-stone-500">يركب على جميع الأسطح</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600 mb-2"><i data-lucide="shield-check" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">ضمان 5 سنوات</h4>
                                <p class="text-[10px] text-stone-500">ضد عيوب الصناعة</p>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Content -->
                    <div class="lg:col-span-6 relative h-[600px] fade-in-up order-1 lg:order-2" style="animation-delay: 0.2s;">
                        <!-- Main Image Shape -->
                        <div class="absolute inset-0 z-10">
                            <div class="relative w-full h-full">
                                <!-- Large Image (WPC Wall) -->
                                <div class="absolute top-0 right-0 w-[85%] h-[85%] rounded-[3rem] overflow-hidden shadow-2xl z-10 border-4 border-white">
                                    <img src="${mainImg}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-[2s]">
                                    
                                    <!-- Floating Price Tag -->
                                    <div class="absolute top-8 left-8 bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-lg animate-bounce duration-[3000ms]">
                                        <p class="text-xs text-stone-500 font-bold mb-1">${pLabel}</p>
                                        <p class="text-xl font-bold text-stone-900 font-serif">${pValue}</p>
                                    </div>
                                </div>
                                
                                <!-- Secondary Image (Marble) - Floating -->
                                <div class="absolute bottom-0 left-0 w-[55%] h-[45%] rounded-[2rem] overflow-hidden shadow-2xl z-20 border-4 border-white translate-x-4 -translate-y-8">
                                    <img src="${secImg}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-[2s]">
                                    
                                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-4">
                                        <p class="text-white font-bold text-sm">بديل الرخام الفاخر</p>
                                    </div>
                                </div>

                                <!-- Decorative Circle -->
                                <div class="absolute top-[40%] right-[-5%] w-32 h-32 rounded-full border-2 border-orange-500/20 z-0"></div>
                                <div class="absolute bottom-[10%] left-[40%] w-20 h-20 rounded-full bg-stone-900 z-30 flex items-center justify-center text-white shadow-xl">
                                    <div class="text-center leading-none">
                                        <span class="block text-xl font-bold">${dValue}</span>
                                        <span class="text-[0.6rem] opacity-80">${dLabel}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderFeatured(c) {
            // 1. Render Best Sellers (Existing Logic)
            c.innerHTML += `
            <!-- UPDATED: Reduced padding to pt-12 pb-2 -->
            <div class="pt-12 pb-2 container mx-auto px-6 border-t border-stone-100">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <span class="text-xs font-bold text-green-600 tracking-wider uppercase mb-1 block">خيارات العملاء</span>
                        <h3 class="text-2xl md:text-3xl font-bold text-stone-900">الأكثر مبيعاً</h3>
                    </div>
                    <!-- REMOVED BUTTONS FROM HERE -->
                </div>
                
                <!-- WRAPPER for Relative Positioning of Arrows -->
                <div class="relative group/slider">
                    <!-- Right Arrow (Scroll Right / Prev) -->
                    <button onclick="document.getElementById('featured-slider').scrollBy({ left: 300, behavior: 'smooth' })" class="absolute top-1/2 -right-4 lg:-right-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-right" size="24"></i>
                    </button>

                    <!-- Slider Container -->
                    <div id="featured-slider" class="flex overflow-x-auto scrollbar-hide snap-x pb-8 pt-4 -mx-3 px-3 scroll-smooth">
                        ${PRODUCTS.slice(0, 8).map(p => {
                            return `
                            <!-- UPDATED: Width is 1/4 on desktop (4 items), 1/3 on tablet, 1/2 on mobile -->
                            <div class="w-1/2 md:w-1/3 lg:w-1/4 flex-shrink-0 snap-start px-3 group cursor-pointer">
                                ${createProductCard(p)}
                            </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Left Arrow (Scroll Left / Next) -->
                    <button onclick="document.getElementById('featured-slider').scrollBy({ left: -300, behavior: 'smooth' })" class="absolute top-1/2 -left-4 lg:-left-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 -translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-left" size="24"></i>
                    </button>
                </div>
            </div>`;

            // NEW: Render Best Seller Banner (If Enabled)
            if (HERO_SETTINGS.showBestSellerBanner && HERO_SETTINGS.bestSellerBannerUrl) {
                 c.innerHTML += `
                    <div class="container mx-auto px-6 mb-4 fade-in-up">
                        <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                            <!-- تعديل هنا: استخدام object-fill -->
                            <img src="${HERO_SETTINGS.bestSellerBannerUrl}" 
                                 class="object-fill md:object-cover"
                                 style="height: ${HERO_SETTINGS.bestSellerBannerHeight || 200}px; width: ${HERO_SETTINGS.bestSellerBannerWidth || 100}%;" 
                                 alt="Best Seller Promo Banner">
                        </div>
                    </div>`;
            }

            // 2. Render Featured Products (Existing Logic)
            const featuredProducts = PRODUCTS.filter(p => p.isFeatured);
            
            if (featuredProducts.length > 0) {
                c.innerHTML += `
                <!-- UPDATED: Reduced padding to pt-4 pb-12 -->
                <div class="pt-4 pb-12 bg-yellow-50/50 border-t border-stone-100">
                    <div class="container mx-auto px-6">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <span class="text-xs font-bold text-yellow-600 tracking-wider uppercase mb-1 block">اختياراتنا لك</span>
                                <h3 class="text-2xl md:text-3xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="star" class="text-yellow-500 fill-yellow-500" size="24"></i> منتجات مميزة</h3>
                            </div>
                            <!-- REMOVED BUTTONS FROM HERE -->
                        </div>
                        
                        <!-- WRAPPER for Relative Positioning of Arrows -->
                        <div class="relative group/slider">
                            <!-- Right Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: 300, behavior: 'smooth' })" class="absolute top-1/2 -right-4 lg:-right-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                                <i data-lucide="chevron-right" size="24"></i>
                            </button>

                            <!-- Slider Container -->
                            <div id="special-slider" class="flex overflow-x-auto scrollbar-hide snap-x pb-8 pt-4 -mx-3 px-3 scroll-smooth">
                                ${featuredProducts.map(p => {
                                    return `
                                    <!-- UPDATED: Width is 1/4 on desktop (4 items), 1/3 on tablet, 1/2 on mobile -->
                                    <div class="w-1/2 md:w-1/3 lg:w-1/4 flex-shrink-0 snap-start px-3 group cursor-pointer">
                                        ${createProductCard(p)}
                                    </div>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Left Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: -300, behavior: 'smooth' })" class="absolute top-1/2 -left-4 lg:-left-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 -translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                                <i data-lucide="chevron-left" size="24"></i>
                            </button>
                        </div>
                    </div>
                </div>`;

                // NEW: Render Featured Banner (If Enabled & Featured Products Exist)
                if (HERO_SETTINGS.showFeaturedBanner && HERO_SETTINGS.featuredBannerUrl) {
                     c.innerHTML += `
                        <div class="container mx-auto px-6 mt-8 mb-8 fade-in-up">
                            <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                                <!-- تعديل هنا: استخدام object-fill -->
                                <img src="${HERO_SETTINGS.featuredBannerUrl}" 
                                     class="object-fill md:object-cover"
                                     style="height: ${HERO_SETTINGS.featuredBannerHeight || 200}px; width: ${HERO_SETTINGS.featuredBannerWidth || 100}%;" 
                                     alt="Featured Promo Banner">
                            </div>
                        </div>`;
                }
            }
        }

        // NEW: Render Category Sections (Full Grid 5 cols)
        function renderCategorySections(c) {
            // 1. Filter valid categories (only those containing products)
            const activeCategories = CATEGORIES.filter(cat => PRODUCTS.some(p => p.category === cat.name));

            if (activeCategories.length === 0) return;

            let visibleHTML = '';
            let hiddenHTML = '';

            // Loop through valid categories
            activeCategories.forEach((cat, index) => {
                // Get products for this category
                let catProducts = PRODUCTS.filter(p => p.category === cat.name);
                
                // Randomize products
                catProducts = catProducts.sort(() => 0.5 - Math.random());

                // Logic for "Show More" items within the category (Products inside section)
                const initialLimit = 25;
                const visibleProducts = catProducts.slice(0, initialLimit);
                const hiddenProducts = catProducts.slice(initialLimit);
                const hasHidden = hiddenProducts.length > 0;
                const hiddenContainerId = `more-products-${index}`;
                const btnId = `btn-more-${index}`;

                const sectionHTML = `
                <!-- Category Section -->
                <div class="py-4 border-t border-stone-100 bg-white">
                    <div class="container mx-auto px-6">
                        <!-- Category Header -->
                        <div class="flex items-center gap-4 mb-6 mt-4">
                            <div class="w-12 h-12 rounded-xl bg-stone-50 border border-stone-200 overflow-hidden shrink-0">
                                <img src="${cat.image}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-stone-900">${cat.name}</h3>
                            </div>
                            <button onclick="filterCategory('${cat.name}'); setView('shop')" class="mr-auto text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100">
                                عرض الكل <i data-lucide="arrow-left" size="14"></i>
                            </button>
                        </div>

                        <!-- Products Grid: Updated to 3 columns on mobile -->
                        <div class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-6">
                            ${visibleProducts.map(p => createProductCard(p)).join('')}
                        </div>

                        <!-- Hidden Products Container (Inside Section) -->
                        ${hasHidden ? `
                        <div id="${hiddenContainerId}" class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-6 mt-6 hidden fade-in-up">
                            ${hiddenProducts.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button id="${btnId}" onclick="document.getElementById('${hiddenContainerId}').classList.remove('hidden'); this.style.display='none';" class="inline-flex items-center gap-2 text-stone-500 hover:text-stone-900 text-sm font-bold transition-all hover:bg-stone-50 px-4 py-2 rounded-lg">
                                <span>عرض المزيد من ${cat.name}</span>
                                <i data-lucide="chevron-down" size="16"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                // Split into visible (first 3) and hidden (rest)
                if (index < 3) {
                    visibleHTML += sectionHTML;
                } else {
                    hiddenHTML += sectionHTML;
                }
            });

            // Append Visible Sections
            c.innerHTML += visibleHTML;

            // Append Hidden Sections Button & Container if there are more
            if (hiddenHTML) {
                c.innerHTML += `
                <div id="hidden-categories-wrapper" class="hidden fade-in-up">
                    ${hiddenHTML}
                </div>
                
                <div id="show-more-cats-btn-container" class="py-8 text-center bg-stone-50/30 border-t border-stone-100 mt-4">
                    <button onclick="document.getElementById('hidden-categories-wrapper').classList.remove('hidden'); document.getElementById('show-more-cats-btn-container').style.display='none';" class="group bg-white border-2 border-stone-200 text-stone-600 px-8 py-3.5 rounded-full font-bold hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all shadow-sm hover:shadow-lg flex items-center gap-3 mx-auto text-sm">
                        <span>عرض المزيد من الأقسام</span>
                        <div class="w-6 h-6 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center group-hover:bg-white/20 group-hover:text-white transition-colors">
                            <i data-lucide="chevron-down" size="16"></i>
                        </div>
                    </button>
                </div>
                `;
            }

            lucide.createIcons();
        }

        function renderShop(c) {
            const catsHTML = generateCategoryFilterHTML();
            let adminBlock = '';
            if (user && user.email === ADMIN_EMAIL) {
               // ...
            }

            // تم تعديل pt-32 إلى pt-28
            c.innerHTML = `<div class="bg-[#FAFAFA] min-h-screen pt-28 md:pt-24 pb-20">
                <div class="container mx-auto px-4 md:px-6">
                    
                    <!-- Mobile Search & Filter Toolbar -->
                    <!-- تم ضبط top ليكون مناسباً (حوالي 105px الآن) -->
                    <div class="lg:hidden mb-4 space-y-3 sticky top-[105px] z-30 bg-[#FAFAFA]/95 backdrop-blur-sm py-2 -mx-4 px-4 shadow-sm border-b border-stone-200/50">
                         <div class="relative group">
                            <input class="w-full bg-white border border-stone-200 p-3 pl-10 rounded-xl shadow-sm text-sm focus:ring-2 focus:ring-stone-900 outline-none transition-colors" 
                                   oninput="updateShopFilters('search',this.value)" 
                                   value="${shopState.search}" 
                                   placeholder="عن ماذا تبحث؟">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400" size="18"></i>
                         </div>
                         <div class="flex gap-2">
                             <button onclick="toggleFilterDrawer(true)" class="flex-1 bg-white border border-stone-200 p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-stone-700 text-xs shadow-sm active:bg-stone-50 transition-colors">
                                <i data-lucide="sliders-horizontal" size="16"></i> تصفية النتائج
                             </button>
                             <!-- Sort (Mobile) -->
                             <div class="relative flex-1">
                                <select onchange="updateShopFilters('sort',this.value)" class="w-full h-full appearance-none bg-white border border-stone-200 p-3 pl-8 pr-4 rounded-xl text-xs font-bold text-stone-700 shadow-sm focus:outline-none">
                                    <option value="featured" ${shopState.sort === 'featured' ? 'selected' : ''}>المميز</option>
                                    <option value="price-low" ${shopState.sort === 'price-low' ? 'selected' : ''}>أقل سعر</option>
                                    <option value="price-high" ${shopState.sort === 'price-high' ? 'selected' : ''}>أعلى سعر</option>
                                    <option value="newest" ${shopState.sort === 'newest' ? 'selected' : ''}>الأحدث</option>
                                </select>
                                <i data-lucide="chevron-down" size="14" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none"></i>
                             </div>
                         </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        
                        <!-- Sidebar Filters (Drawer on Mobile, Sidebar on Desktop) -->
                        <div id="filter-sidebar-overlay" onclick="toggleFilterDrawer(false)" class="fixed inset-0 bg-black/60 z-[60] hidden lg:hidden backdrop-blur-sm transition-opacity fade-in"></div>
                        
                        <aside id="shop-sidebar" class="
                            fixed inset-y-0 right-0 z-[70] w-[85%] max-w-[320px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto
                            lg:translate-x-0 lg:static lg:z-auto lg:w-1/4 lg:shadow-none lg:bg-transparent lg:overflow-visible lg:block lg:sticky lg:top-28
                        ">
                            <!-- Mobile Drawer Header -->
                            <div class="lg:hidden p-5 border-b border-stone-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                <h3 class="font-bold text-lg text-stone-900">تصفية النتائج</h3>
                                <button onclick="toggleFilterDrawer(false)" class="w-8 h-8 bg-stone-50 rounded-full flex items-center justify-center text-stone-500 hover:text-red-500 hover:bg-red-50 transition-colors"><i data-lucide="x" size="18"></i></button>
                            </div>

                            <div class="p-5 lg:p-0 space-y-6">
                                ${adminBlock}
                                
                                <!-- Desktop Search Box (Hidden on Mobile) -->
                                <div class="hidden lg:block bg-white p-1 rounded-2xl shadow-sm border border-stone-100">
                                    <div class="relative group">
                                        <input class="w-full bg-stone-50 border-transparent p-4 pl-12 rounded-xl text-sm font-medium focus:bg-white focus:ring-2 focus:ring-stone-900 focus:outline-none transition-all placeholder:text-stone-400 text-stone-900" oninput="updateShopFilters('search',this.value)" value="${shopState.search}" placeholder="عن ماذا تبحث؟">
                                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 group-focus-within:text-stone-900 transition-colors" size="20"></i>
                                    </div>
                                </div>

                                <!-- Filter Container -->
                                <div class="bg-white rounded-3xl shadow-sm border border-stone-100 overflow-hidden">
                                    <div class="p-6 border-b border-stone-50 flex justify-between items-center bg-white">
                                        <h3 class="font-bold text-lg text-stone-900 flex items-center gap-2"><i data-lucide="sliders-horizontal" size="18"></i> الفلاتر</h3>
                                        ${shopState.categories.length > 0 || shopState.priceMax < 10000 ? `<button onclick="resetFilters(); toggleFilterDrawer(false)" class="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors">مسح الكل</button>` : ''}
                                    </div>
                                    
                                    <div class="p-6 space-y-8">
                                        <!-- Categories (Added ID) -->
                                        <div>
                                            <h4 class="font-bold text-sm text-stone-400 uppercase tracking-wider mb-4">التصنيفات</h4>
                                            <div id="shop-categories-list" class="space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                                ${catsHTML}
                                            </div>
                                        </div>

                                        <!-- Price Range (Updated to Min/Max Inputs) -->
                                        <div>
                                            <h4 class="font-bold text-sm text-stone-400 uppercase tracking-wider mb-4">نطاق السعر</h4>
                                            <div class="flex items-center gap-3">
                                                <div class="relative w-full group">
                                                    <label class="text-[10px] font-bold text-stone-400 absolute -top-2 right-2 bg-white px-1">من</label>
                                                    <input type="number" min="0" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="0" value="${shopState.priceMin}" oninput="updateShopFilters('priceMin', this.value)">
                                                    <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-400 text-xs font-serif">$</span>
                                                </div>
                                                
                                                <span class="text-stone-300 font-bold text-lg">-</span>
                                                
                                                <div class="relative w-full group">
                                                    <label class="text-[10px] font-bold text-stone-400 absolute -top-2 right-2 bg-white px-1">إلى</label>
                                                    <input type="number" min="0" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="1000" value="${shopState.priceMax}" oninput="updateShopFilters('priceMax', this.value)">
                                                    <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-400 text-xs font-serif">$</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mobile Apply Button -->
                                <div class="lg:hidden sticky bottom-0 bg-white p-4 border-t border-stone-100 -mx-5 -mb-5 mt-4">
                                    <button onclick="toggleFilterDrawer(false)" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-stone-800 transition-all active:scale-95">
                                        تم الانتهاء
                                    </button>
                                </div>
                            </div>
                        </aside>

                        <!-- Products Grid Area -->
                        <div class="w-full lg:w-3/4">
                            <!-- Top Bar (Visible only on Desktop) -->
                            <div class="hidden lg:flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm fade-in-up" style="animation-delay: 0.1s;">
                                <div class="flex items-center gap-2">
                                    <div class="p-2 bg-stone-50 rounded-lg text-stone-500"><i data-lucide="layout-grid" size="18"></i></div>
                                    <p id="results-count" class="text-stone-600 font-bold text-sm"></p>
                                </div>
                                
                                <div class="flex items-center gap-3 w-full sm:w-auto">
                                    <span class="text-xs font-bold text-stone-400 whitespace-nowrap">ترتيب حسب:</span>
                                    <div class="relative w-full sm:w-48">
                                        <select onchange="updateShopFilters('sort',this.value)" class="w-full appearance-none border border-stone-200 bg-stone-50 p-2.5 pl-8 pr-4 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white cursor-pointer transition-colors">
                                            <option value="featured" ${shopState.sort === 'featured' ? 'selected' : ''}>المميز (الافتراضي)</option>
                                            <option value="price-low" ${shopState.sort === 'price-low' ? 'selected' : ''}>السعر: الأقل أولاً</option>
                                            <option value="price-high" ${shopState.sort === 'price-high' ? 'selected' : ''}>السعر: الأعلى أولاً</option>
                                            <option value="newest" ${shopState.sort === 'newest' ? 'selected' : ''}>الأحدث إضافة</option>
                                        </select>
                                        <i data-lucide="chevron-down" size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Products Grid (UPDATED to 3 Columns on Mobile) -->
                            <div id="shop-products-grid" class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-2 md:gap-6"></div>
                            
                            <!-- Empty State -->
                            <div id="shop-empty-state" class="hidden flex flex-col items-center justify-center py-24 bg-white rounded-3xl border border-stone-100 shadow-sm text-center">
                                <div class="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                    <i data-lucide="search-x" class="text-stone-300" size="32"></i>
                                </div>
                                <h3 class="text-xl font-bold text-stone-900 mb-2">عذراً، لم نجد نتائج</h3>
                                <p class="text-stone-500 text-sm max-w-xs mx-auto mb-8">حاول البحث بكلمات مختلفة أو قم بإزالة بعض الفلاتر.</p>
                                <button onclick="resetFilters()" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
                                    <i data-lucide="refresh-cw" size="16"></i> إعادة تعيين الفلاتر
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            applyShopFilters();
        }

        // NEW: Render Category Bar (Stories Style)
        function renderCategoryBar(c) {
            // التحقق من حالة ظهور البانر الإعلاني (تحت الهيدر)
            const showHeaderBanner = HERO_SETTINGS.showFooterBanner && HERO_SETTINGS.footerBannerUrl;

            // التحقق من حالة ظهور البانر الرئيسي (Hero)
            const showHeroMob = HERO_SETTINGS.showHeroMobile !== false;
            const showHeroDesk = HERO_SETTINGS.showHeroDesktop !== false;
            
            // --- حساب المسافة للموبايل ---
            let mobilePt = 'pt-28'; // الافتراضي: مسافة كبيرة لتعويض الهيدر الثابت
            
            if (showHeroMob) {
                // إذا كان البانر الرئيسي (Hero) ظاهراً
                // نقلل المسافة لأن البانر يأخذ مساحته
                mobilePt = 'pt-4'; 
            } else if (showHeaderBanner) {
                // إذا كان البانر الرئيسي مخفياً، ولكن بانر الهيدر (الشريط) ظاهر
                // بانر الهيدر يدفع المحتوى للأسفل، لذا نحتاج مسافة صغيرة فقط
                mobilePt = 'pt-2';
            } else {
                // إذا كان الاثنان مخفيين، نحتاج مسافة كبيرة لكي لا يختفي المحتوى تحت الهيدر
                mobilePt = 'pt-28';
            }

            // --- حساب المسافة للكمبيوتر ---
            let desktopPt = 'md:pt-32'; // الافتراضي

            if (showHeroDesk) {
                desktopPt = 'md:pt-8'; // مسافة بسيطة بعد البانر الرئيسي
            } else if (showHeaderBanner) {
                desktopPt = 'md:pt-4'; // مسافة صغيرة بعد بانر الهيدر
            } else {
                desktopPt = 'md:pt-32'; // مسافة كبيرة لتعويض الهيدر
            }

            c.innerHTML += `
            <div class="${mobilePt} ${desktopPt} pb-4 container mx-auto px-6 fade-in-up group/cat" style="animation-delay: 0.3s;">
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1 h-5 bg-stone-900 rounded-full"></span>
                    <h3 class="font-bold text-stone-900 text-base md:text-lg">تسوق حسب القسم</h3>
                </div>
                
                <div class="relative" onmouseenter="stopAutoScroll('category-scroll-container')" onmouseleave="startAutoScroll('category-scroll-container')">
                    <button onclick="document.getElementById('category-scroll-container').scrollBy({ left: 200, behavior: 'smooth' })" class="absolute -right-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-white border border-stone-200 rounded-full flex items-center justify-center shadow-lg text-stone-600 hover:bg-stone-900 hover:text-white transition-all opacity-0 group-hover/cat:opacity-100 translate-x-2 group-hover/cat:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-right" size="20"></i>
                    </button>

                    <div id="category-scroll-container" class="flex gap-3 md:gap-4 overflow-x-auto scrollbar-hide snap-x py-2 px-1 scroll-smooth">
                        <div onclick="viewAllProducts()" class="flex flex-col items-center gap-2 md:gap-3 min-w-[70px] md:min-w-[80px] cursor-pointer group snap-start transition-transform hover:-translate-y-1">
                            <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-stone-900 text-white flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-300 border-2 border-stone-900 ring-2 ring-stone-100 ring-offset-2">
                                <i data-lucide="grid-2x2" size="24" class="md:w-7 md:h-7"></i>
                            </div>
                            <span class="text-[10px] md:text-xs font-bold text-stone-900">الكل</span>
                        </div>

                        ${CATEGORIES.map(cat => `
                            <div onclick="filterCategory('${cat.name.replace(/'/g, "\\'")}')" class="flex flex-col items-center gap-2 md:gap-3 min-w-[70px] md:min-w-[80px] cursor-pointer group snap-start transition-transform hover:-translate-y-1">
                                <div class="w-16 h-16 md:w-20 md:h-20 rounded-full p-[2px] border-2 border-green-500/30 group-hover:border-green-600 transition-colors relative">
                                    <div class="w-full h-full rounded-full overflow-hidden bg-stone-100 shadow-sm group-hover:shadow-md transition-all ring-2 ring-white">
                                        <img src="${cat.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" onerror="this.src='https://via.placeholder.com/150?text=${cat.name}'">
                                    </div>
                                </div>
                                <span class="text-[10px] md:text-xs font-bold text-stone-600 group-hover:text-stone-900 transition-colors text-center truncate w-full px-1">${cat.name}</span>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="document.getElementById('category-scroll-container').scrollBy({ left: -200, behavior: 'smooth' })" class="absolute -left-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-white border border-stone-200 rounded-full flex items-center justify-center shadow-lg text-stone-600 hover:bg-stone-900 hover:text-white transition-all opacity-0 group-hover/cat:opacity-100 -translate-x-2 group-hover/cat:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-left" size="20"></i>
                    </button>
                </div>
            </div>`;

            // NEW: Render Category Banner (Infinite Gallery Style)
            if (HERO_SETTINGS.showCategoryBanner && HERO_SETTINGS.categoryBannerUrl) {
                const rawUrls = HERO_SETTINGS.categoryBannerUrl.split(/\r?\n/).filter(url => url.trim() !== '');
                
                let displayUrls = [];
                if (rawUrls.length > 0) {
                    if (rawUrls.length === 1) {
                        displayUrls = rawUrls; 
                    } else {
                        // تكرار الصور لضمان التمرير اللانهائي
                        displayUrls = [...rawUrls, ...rawUrls, ...rawUrls];
                    }
                }

                const sliderId = 'category-banner-slider';
                
                // Settings - استقبال القيم من لوحة التحكم
                const hDesk = HERO_SETTINGS.catBanHeightDesktop || HERO_SETTINGS.categoryBannerHeight || 250;
                const hMob = HERO_SETTINGS.catBanHeightMobile || 120;
                // هنا نستخدم القيم التي تحددها أنت بدقة
                const wDesk = HERO_SETTINGS.catBanWidthDesktop || HERO_SETTINGS.categoryBannerWidth || 50; 
                const wMob = HERO_SETTINGS.catBanWidthMobile || 85;
                
                const rDesk = HERO_SETTINGS.catBanRadiusDesktop || HERO_SETTINGS.categoryBannerRadius || '1.5rem';
                const rMob = HERO_SETTINGS.catBanRadiusMobile || '0.8rem';

                // Dynamic CSS
                const styleId = 'cat-banner-style';
                let styleEl = document.getElementById(styleId);
                if(!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = styleId;
                    document.head.appendChild(styleEl);
                }
                
                // تم إزالة min-width الثابت (50%) واستبداله بالنسبة المئوية التي تحددها في الإعدادات
                styleEl.innerHTML = `
                    #cat-banner-wrapper { 
                        width: 100%; 
                        padding: 10px 0;
                    }
                    
                    /* Mobile Gallery */
                    .cat-banner-slide { 
                        height: ${hMob}px; 
                        width: ${wMob}%; 
                        min-width: ${wMob}%; /* احترام الإعدادات في الموبايل */
                        margin: 0 6px; 
                        border-radius: ${rMob};
                        scroll-snap-align: center;
                        transition: transform 0.5s ease;
                        opacity: 1;
                        transform: scale(0.95);
                    }
                    .cat-banner-slide:hover { transform: scale(1); }
                    
                    /* Desktop Gallery */
                    @media (min-width: 768px) {
                        #cat-banner-wrapper { padding: 20px 0; }
                        .cat-banner-slide { 
                            height: ${hDesk}px; 
                            width: ${wDesk}%; 
                            min-width: ${wDesk}%; /* التعديل الجوهري: الآن يعتمد كلياً على الإعدادات */
                            margin: 0 15px;
                            border-radius: ${rDesk};
                            opacity: 1;
                            transform: scale(0.95);
                        }
                        .cat-banner-slide:hover { transform: scale(1); }
                    }
                    
                    #${sliderId} {
                        padding-inline: 0; 
                        /* إخفاء شريط التمرير */
                        scrollbar-width: none; 
                        -ms-overflow-style: none;
                    }
                    #${sliderId}::-webkit-scrollbar { 
                        display: none; 
                    }
                `;

                if (displayUrls.length > 0) {
                    c.innerHTML += `
                    <div class="container mx-auto px-0 mt-4 fade-in-up" style="animation-delay: 0.4s;">
                        <div class="w-full flex justify-center" onmouseenter="stopBannerAutoScroll('${sliderId}')" onmouseleave="startBannerAutoScroll('${sliderId}')">
                            <div id="cat-banner-wrapper" class="relative group bg-transparent transition-all duration-300">
                                
                                <!-- Slider Container -->
                                <div id="${sliderId}" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide scroll-smooth h-full items-center">
                                    ${displayUrls.map((url, idx) => `
                                        <div id="cat-slide-${idx}" class="cat-banner-slide flex-shrink-0 relative overflow-hidden shadow-md border border-stone-100 bg-white group/slide">
                                            <!-- تعديل هنا: استخدام object-fill -->
                                            <img src="${url.trim()}" class="w-full h-full object-fill md:object-cover transition-transform duration-700 group-hover/slide:scale-105" alt="Category Banner">
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Nav Buttons -->
                                ${rawUrls.length > 1 ? `
                                <button onclick="scrollBanner('${sliderId}', -1)" class="absolute top-1/2 left-4 md:left-10 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-xl hover:bg-stone-900 hover:text-white hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 border border-stone-200">
                                    <i data-lucide="chevron-left" size="24"></i>
                                </button>
                                <button onclick="scrollBanner('${sliderId}', 1)" class="absolute top-1/2 right-4 md:right-10 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-white/80 backdrop-blur-md rounded-full flex items-center justify-center text-stone-800 shadow-xl hover:bg-stone-900 hover:text-white hover:scale-110 transition-all opacity-0 group-hover:opacity-100 z-20 border border-stone-200">
                                    <i data-lucide="chevron-right" size="24"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>`;
                    
                    if (rawUrls.length > 1) {
                        setTimeout(() => {
                            const slider = document.getElementById(sliderId);
                            const startIndex = rawUrls.length; 
                            const targetSlide = document.getElementById(`cat-slide-${startIndex}`);
                            
                            if (targetSlide && slider) {
                                targetSlide.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
                                startBannerAutoScroll(sliderId);
                            }
                        }, 500); 
                    }
                }
            }

            setTimeout(() => startAutoScroll('category-scroll-container'), 1000);
        }

        // NEW: Auto Scroll Logic Helpers
        let scrollTimers = {};

        window.startAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // Clear existing to avoid duplicates
            if (scrollTimers[id]) clearInterval(scrollTimers[id]);

            scrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                // Safety check if element removed from DOM
                if (!element) {
                    clearInterval(scrollTimers[id]);
                    return;
                }

                // RTL Logic: 
                // In RTL, scrollLeft starts at 0 (Right side) and goes negative as we scroll Left.
                // We need to scroll LEFT (negative value) to see next items.
                
                const maxScroll = element.scrollWidth - element.clientWidth;
                
                // If content fits, no need to scroll
                if (maxScroll <= 0) return;

                const currentScroll = Math.abs(element.scrollLeft);
                
                // Check if we reached the end (Left side) with small tolerance
                if (currentScroll >= maxScroll - 10) {
                    // Reset to Start (Right side)
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // Scroll Left (Forward in RTL)
                    element.scrollBy({ left: -200, behavior: 'smooth' });
                }
            }, 3000); // Move every 3 seconds
        };

        window.stopAutoScroll = (id) => {
            if (scrollTimers[id]) {
                clearInterval(scrollTimers[id]);
                delete scrollTimers[id];
            }
        };

        function renderCategoriesView(c) {
            const html = CATEGORIES.map((cat, index) => {
                // Escape single quotes for the onclick handler
                const safeName = cat.name.replace(/'/g, "\\'");
                return `
                <div onclick="filterCategory('${safeName}')" class="group cursor-pointer flex flex-col gap-2 fade-in-up" style="animation-delay: ${index * 0.05}s">
                    <div class="relative aspect-square rounded-2xl md:rounded-[2rem] overflow-hidden bg-stone-100 shadow-sm border border-stone-100 group-hover:shadow-xl group-hover:-translate-y-1 transition-all duration-500">
                        <img src="${cat.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 ease-out" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Category'">
                        
                        <!-- Modern Overlay on Hover -->
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-500"></div>
                    </div>
                    
                    <div class="text-center px-1">
                        <h3 class="font-bold text-stone-900 text-[10px] md:text-sm group-hover:text-stone-600 transition-colors truncate">${cat.name}</h3>
                    </div>
                </div>`;
            }).join('') || `<div class="col-span-full text-center py-20 text-stone-400 bg-stone-50 rounded-xl border border-dashed border-stone-200">لا توجد أقسام حالياً</div>`;

            c.innerHTML = `
            <div class="pt-28 md:pt-24 pb-20 min-h-screen bg-white">
                <div class="container mx-auto px-4">
                    <!-- Modern Header -->
                    <div class="text-center max-w-2xl mx-auto mb-8 fade-in-up">
                        <h1 class="text-2xl md:text-4xl font-bold text-stone-900 mb-2 tracking-tight">تصنيفات المتجر</h1>
                        <p class="text-stone-500 text-xs md:text-lg leading-relaxed">اختر القسم المناسب لتصفح منتجاتنا المميزة.</p>
                    </div>

                    <!-- Updated Categories Grid: 4 columns on mobile (smaller icons) for better layout -->
                    <div class="grid grid-cols-4 sm:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-6">
                        ${html}
                    </div>

                    <!-- Call to Action -->
                    <div class="mt-12 text-center fade-in-up border-t border-stone-100 pt-8" style="animation-delay: 0.3s;">
                        <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-6 py-3 rounded-full font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto text-xs md:text-sm">
                            <span>عرض جميع المنتجات</span>
                            <i data-lucide="grid-2x2" size="16"></i>
                        </button>
                    </div>
                </div>
            </div>`;
            lucide.createIcons();
        }

        function renderAdmin(c) {
            if (!user || user.email !== ADMIN_EMAIL) {
                if (user && !user.isAnonymous) {
                     c.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center text-center px-4"><div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-6"><i data-lucide="shield-alert" size="40"></i></div><h1 class="text-2xl font-bold text-stone-900 mb-2">غير مصرح بالدخول</h1><p class="text-stone-500 mb-8">هذه الصفحة مخصصة للمسؤولين فقط.</p><button onclick="setView('home')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold">العودة للرئيسية</button></div>`;
                     return;
                }
                setView('login');
                return;
            }
            
            const isEdit = !!currentEditProduct;
            const p = currentEditProduct || {};
            const extraImages = p.images ? p.images.slice(1).join('\n') : '';
            const variantsString = p.variants ? p.variants.map(v => `${v.color}: ${v.image}`).join('\n') : '';
            // Helper to format timestamp to datetime-local string (YYYY-MM-DDTHH:MM)
            const expiryDateStr = p.discountExpiry 
                ? new Date(p.discountExpiry - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) 
                : '';

            const features = p.features ? p.features.join('\n') : '';
            const specsString = p.specifications ? p.specifications.map(s => `${s.label}: ${s.value}`).join('\n') : '';
            const defaultServices = [
                "banknote: الدفع نقداً عند الاستلام",
                "truck: توصيل مجاني",
                "rotate-ccw: 15 يوم للإرجاع",
                "shield-check: تسوق آمن",
                "badge-check: جودة مضمونة"
            ].join('\n');
            const servicesString = p.services ? p.services.map(s => `${s.icon}: ${s.text}`).join('\n') : defaultServices;

            const pendingReviews = ALL_REVIEWS.filter(r => r.status === 'pending');
            
            // Category Edit Variables
            const editCatObj = currentEditCategoryName ? CATEGORIES.find(c => c.name === currentEditCategoryName) : null;
            const catNameVal = editCatObj ? editCatObj.name : '';
            const catImgVal = editCatObj ? editCatObj.image : '';

            // Helper for active tab style
            const getTabClass = (tabName) => {
                return currentAdminTab === tabName 
                    ? "bg-stone-900 text-white shadow-md" 
                    : "bg-white text-stone-600 hover:bg-stone-100";
            };

            c.innerHTML = `
            <div class="pt-24 pb-20 container mx-auto px-4 min-h-screen bg-stone-50/50">
                <div class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto">
                    
                    <!-- Sidebar Navigation -->
                    <aside class="w-full lg:w-64 flex-shrink-0 space-y-2">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-200 mb-4">
                            <h2 class="font-bold text-stone-900 flex items-center gap-2 mb-1"><i data-lucide="layout-dashboard" size="18"></i> لوحة التحكم</h2>
                            <p class="text-xs text-stone-400">أهلاً بك، المدير</p>
                        </div>

                        <button onclick="setAdminView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('dashboard')}">
                            <i data-lucide="activity" size="18"></i> المراجعات والملخص
                        </button>
                        
                        <button onclick="setAdminView('orders')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('orders')}">
                            <i data-lucide="shopping-bag" size="18"></i> طلبات العملاء
                            ${ALL_ORDERS.filter(o => !o.isArchived).length > 0 ? `<span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full mr-auto">${ALL_ORDERS.filter(o => !o.isArchived).length}</span>` : ''}
                        </button>

                        <button onclick="currentEditProduct=null; setAdminView('products')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('products')}">
                            <i data-lucide="package-plus" size="18"></i> إدارة المنتجات
                        </button>
                        
                        <button onclick="currentEditCategoryName=null; setAdminView('categories')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('categories')}">
                            <i data-lucide="folder-plus" size="18"></i> إدارة الأقسام
                        </button>
                        
                        <button onclick="setAdminView('settings')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('settings')}">
                            <i data-lucide="settings" size="18"></i> إعدادات الواجهة
                        </button>

                         <div class="pt-4 mt-4 border-t border-stone-200">
                             <button onclick="setView('home')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm text-stone-600 hover:bg-red-50 hover:text-red-600 transition-colors">
                                <i data-lucide="log-out" size="18"></i> خروج من اللوحة
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="flex-1 min-w-0">
                        
                        <!-- 1. DASHBOARD TAB -->
                        ${currentAdminTab === 'dashboard' ? `
                            <div class="space-y-6 fade-in-up">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">إجمالي المنتجات</div>
                                        <div class="text-3xl font-bold text-stone-900">${PRODUCTS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">إجمالي الطلبات</div>
                                        <div class="text-3xl font-bold text-stone-900">${ALL_ORDERS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">المراجعات المعلقة</div>
                                        <div class="text-3xl font-bold ${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-900'}">${pendingReviews.length}</div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                    <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                        <i data-lucide="message-square-warning" class="${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-400'}"></i> 
                                        التعليقات والمراجعات
                                    </h3>
                                    ${pendingReviews.length === 0 ? `<div class="text-center py-12 bg-stone-50 rounded-2xl border border-dashed border-stone-200"><p class="text-stone-500 font-medium">لا توجد تعليقات معلقة حالياً</p></div>` : 
                                    `<div class="space-y-4">${pendingReviews.map(r => {
                                        const prod = PRODUCTS.find(p => p.id === r.productId);
                                        return `<div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 flex flex-col md:flex-row gap-6 justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-3 mb-2"><span class="font-bold text-stone-900 text-lg">${r.userName}</span><div class="flex text-yellow-400 text-xs">${Array(r.rating).fill('<i data-lucide="star" class="w-3 h-3 fill-current"></i>').join('')}</div></div>
                                                <p class="text-stone-500 text-xs mb-2">عن منتج: <span class="font-bold text-stone-800">${prod ? prod.name : 'منتج محذوف'}</span></p>
                                                <p class="text-stone-700 font-medium bg-white p-3 rounded-xl border border-orange-100">"${r.comment}"</p>
                                            </div>
                                            <div class="flex flex-col gap-3 w-full md:w-auto min-w-[200px]">
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded-xl border border-orange-200 hover:border-orange-400 transition-colors">
                                                    <input type="checkbox" id="verify-check-${r.id}" class="w-4 h-4 accent-green-600 rounded cursor-pointer">
                                                    <span class="text-xs font-bold text-stone-700 select-none">شراء تم التحقق منه</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <button onclick="handleReviewAction('${r.id}', 'approve')" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 shadow-sm">موافقة</button>
                                                    <button onclick="handleReviewAction('${r.id}', 'reject')" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-red-700 shadow-sm">رفض</button>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}</div>`}
                                </div>
                            </div>
                        ` : ''}

                        <!-- 2. ORDERS TAB (Integrated Here) -->
                        ${currentAdminTab === 'orders' ? `
                            <div class="space-y-6 fade-in-up">
                                <div class="flex flex-col gap-4 bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                                    <div class="flex flex-wrap items-center justify-between gap-4">
                                        <h2 class="font-bold text-2xl text-stone-900 flex items-center gap-2">
                                            <i data-lucide="shopping-bag" class="text-stone-900"></i> إدارة الطلبات
                                        </h2>
                                        
                                        <!-- 9️⃣ CSV EXPORT CONTROLS -->
                                        <div class="flex items-center gap-2">
                                            <div class="relative group/export">
                                                <button class="flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-xl font-bold hover:bg-green-100 transition-colors border border-green-200 shadow-sm text-sm">
                                                    <i data-lucide="download-cloud" size="16"></i> تصدير (Excel/CSV)
                                                </button>
                                                <!-- Dropdown -->
                                                <div class="absolute top-full left-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-stone-100 overflow-hidden hidden group-hover/export:block z-20">
                                                    <button onclick="exportOrdersToCSV('today')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-sm font-medium text-stone-700">طلبات اليوم</button>
                                                    <button onclick="exportOrdersToCSV('week')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-sm font-medium text-stone-700">هذا الأسبوع</button>
                                                    <button onclick="exportOrdersToCSV('month')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-sm font-medium text-stone-700">هذا الشهر</button>
                                                    <div class="h-px bg-stone-100 my-1"></div>
                                                    <button onclick="exportOrdersToCSV('all')" class="w-full text-right px-4 py-2 hover:bg-stone-50 text-sm font-bold text-stone-900">كل الطلبات</button>
                                                </div>
                                            </div>

                                            <div class="flex p-1 bg-stone-100 rounded-xl">
                                                <button onclick="setOrderTab('active')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${currentOrderTab === 'active' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}">الجارية</button>
                                                <button onclick="setOrderTab('archived')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${currentOrderTab === 'archived' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}">الأرشيف</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NEW: Order Search Bar -->
                                    <div class="relative w-full">
                                        <input type="text" oninput="filterOrdersList(this.value)" placeholder="🔍 ابحث برقم الطلب، اسم العميل، أو رقم الهاتف..." class="w-full border border-stone-200 bg-stone-50 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 focus:bg-white outline-none transition-colors">
                                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400" size="18"></i>
                                    </div>

                                    <!-- Quick Filters Bar -->
                                    <div class="flex flex-wrap gap-2 pt-2 border-t border-stone-100">
                                        <button onclick="setAdminOrderFilter('all')" class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors flex items-center gap-2 ${adminOrderFilter === 'all' ? 'bg-stone-900 text-white border-stone-900' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}">
                                            الكل
                                        </button>
                                        <button onclick="setAdminOrderFilter('pending')" class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors flex items-center gap-2 ${adminOrderFilter === 'pending' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-white text-stone-600 border-stone-200 hover:bg-orange-50'}">
                                            <span class="w-2 h-2 rounded-full bg-orange-500"></span> المعلقة (Pending)
                                        </button>
                                        <button onclick="setAdminOrderFilter('vodafone')" class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors flex items-center gap-2 ${adminOrderFilter === 'vodafone' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-stone-600 border-stone-200 hover:bg-red-50'}">
                                            <i data-lucide="smartphone" size="12"></i> فودافون كاش
                                        </button>
                                        <button onclick="setAdminOrderFilter('today')" class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors flex items-center gap-2 ${adminOrderFilter === 'today' ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-white text-stone-600 border-stone-200 hover:bg-blue-50'}">
                                            <i data-lucide="calendar" size="12"></i> طلبات اليوم
                                        </button>
                                    </div>
                                </div>

                                ${(() => {
                                    let displayOrders = currentOrderTab === 'active' ? ALL_ORDERS.filter(o => !o.isArchived) : ALL_ORDERS.filter(o => o.isArchived);
                                    
                                    // Apply Quick Filters
                                    if (adminOrderFilter === 'pending') {
                                        displayOrders = displayOrders.filter(o => ['new', 'pending_payment', 'payment_review'].includes(o.status));
                                    } else if (adminOrderFilter === 'vodafone') {
                                        displayOrders = displayOrders.filter(o => o.paymentMethod === 'vodafone_cash');
                                    } else if (adminOrderFilter === 'today') {
                                        const today = new Date();
                                        displayOrders = displayOrders.filter(o => {
                                            if(!o.createdAt) return false;
                                            const d = o.createdAt.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                                            return d.getDate() === today.getDate() && 
                                                   d.getMonth() === today.getMonth() && 
                                                   d.getFullYear() === today.getFullYear();
                                        });
                                    }

                                    if (displayOrders.length === 0) return `<div class="bg-white p-16 rounded-3xl text-center shadow-sm border border-stone-100"><div class="w-24 h-24 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6 text-stone-300"><i data-lucide="filter-x" size="40"></i></div><h3 class="font-bold text-xl text-stone-900 mb-2">لا توجد طلبات تطابق الفلتر</h3><button onclick="setAdminOrderFilter('all')" class="text-blue-600 text-sm font-bold hover:underline mt-2">عرض كل الطلبات</button></div>`;
                                    
                                    const statuses = [
                                        { val: 'new', label: 'طلب جديد' }, 
                                        { val: 'pending_payment', label: 'بانتظار الدفع' }, 
                                        { val: 'payment_review', label: 'جاري مراجعة الدفع' }, 
                                        { val: 'confirmed', label: 'تم التأكيد (مدفوع)' }, 
                                        { val: 'processing', label: 'جاري التجهيز' },
                                        { val: 'shipped', label: 'تم الشحن' }, 
                                        { val: 'delivered', label: 'تم التوصيل' },
                                        { val: 'expired', label: 'منتهية الصلاحية (Expired)' }
                                    ];

                                    // --- 1️⃣ CONFIDENCE SCORE CALCULATION FUNCTION ---
                                    const calculateConfidence = (order) => {
                                        if (order.paymentMethod !== 'vodafone_cash') return null; // Only for VF Cash

                                        let score = 0;
                                        let checks = [];

                                        // 1. Screenshot Check (40 pts)
                                        if (order.paymentDetails?.screenshotBase64) {
                                            score += 40;
                                            checks.push("📸 سكرين شوت متوفر");
                                        } else {
                                            checks.push("⚠️ لا يوجد سكرين شوت");
                                        }

                                        // 2. Phone Match (30 pts)
                                        if (order.paymentDetails?.senderPhone && order.customer?.phone) {
                                            // Check last 7 digits to avoid format issues
                                            const cleanSender = order.paymentDetails.senderPhone.replace(/\D/g, '').slice(-9);
                                            const cleanCust = order.customer.phone.replace(/\D/g, '').slice(-9);
                                            
                                            if (cleanSender === cleanCust) {
                                                score += 30;
                                                checks.push("📱 الرقم مطابق");
                                            } else {
                                                checks.push(`⚠️ رقم مختلف (${order.paymentDetails.senderPhone})`);
                                            }
                                        }

                                        // 3. Returning Customer (30 pts)
                                        // Count previous confirmed/delivered orders for this phone
                                        const prevOrders = ALL_ORDERS.filter(o => 
                                            o.customer.phone === order.customer.phone && 
                                            o.id !== order.id && 
                                            ['confirmed', 'delivered', 'shipped'].includes(o.status)
                                        ).length;

                                        if (prevOrders > 0) {
                                            score += 30;
                                            checks.push(`🔄 عميل سابق (${prevOrders} طلبات ناجحة)`);
                                        } else {
                                            checks.push("👤 عميل جديد");
                                        }

                                        let level = 'LOW';
                                        let color = 'bg-red-50 text-red-700 border-red-200';
                                        let label = 'منخفضة (Low)';
                                        
                                        if (score >= 80) {
                                            level = 'HIGH';
                                            color = 'bg-green-50 text-green-700 border-green-200';
                                            label = 'عالية (High)';
                                        } else if (score >= 40) {
                                            level = 'MEDIUM';
                                            color = 'bg-yellow-50 text-yellow-700 border-yellow-200';
                                            label = 'متوسطة (Medium)';
                                        }

                                        return { score, level, color, label, checks };
                                    };
                                    // ---------------------------------------------

                                    return displayOrders.map(order => {
                                        // تحديث عرض التاريخ ليتعامل مع Timestamp
                                        let date = "غير محدد";
                                        if (order.createdAt) {
                                            const d = order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                                            date = d.toLocaleString('ar-EG');
                                        }
                                        
                                        const trackingUrl = `${window.location.origin}${window.location.pathname}#/track-order`;
                                        const currentStatusLabel = STATUS_ARABIC_MAP[order.status] || 'تحديث حالة الطلب';
                                        const statusMsg = `مرحباً ${order.customer.name}، 👋\n\nتحديث بخصوص طلبك رقم (#${order.id}) من جدار للديكور:\nحالة الطلب الآن: *${currentStatusLabel}*\n\nيمكنك تتبع التفاصيل من هنا:\n${trackingUrl}\n\nشكراً لثقتك بنا. 🌹`;
                                        const notifyLink = `https://wa.me/20${order.customer.phone.replace(/^0+/, '')}?text=${encodeURIComponent(statusMsg)}`;

                                        // Calculate Confidence Score
                                        const confidence = calculateConfidence(order);

                                        // Payment Review Block Logic
                                        let paymentReviewHTML = '';
                                        if (order.paymentMethod === 'vodafone_cash' && order.paymentDetails) {
                                            paymentReviewHTML = `
                                            <div class="col-span-2 bg-purple-50 border border-purple-200 rounded-xl p-4 mt-2 mb-2 animate-in fade-in zoom-in duration-300">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h4 class="font-bold text-purple-900 text-sm flex items-center gap-2">
                                                        <span class="p-1 bg-purple-100 rounded text-purple-600"><i data-lucide="smartphone" size="14"></i></span>
                                                        بيانات تحويل المحافظ الإلكترونية
                                                    </h4>
                                                    
                                                    <!-- 1️⃣ Confidence Score Badge -->
                                                    ${confidence ? `
                                                    <div class="flex items-center gap-2 px-3 py-1 rounded-full border ${confidence.color} text-xs font-bold shadow-sm" title="${confidence.checks.join('\n')}">
                                                        <i data-lucide="shield-check" size="14"></i>
                                                        <span>ثقة: ${confidence.label}</span>
                                                    </div>
                                                    ` : ''}
                                                </div>

                                                <!-- Confidence Details (Small Text) -->
                                                ${confidence ? `
                                                <div class="flex flex-wrap gap-2 mb-3">
                                                    ${confidence.checks.map(chk => `
                                                        <span class="text-[10px] px-2 py-0.5 bg-white/60 rounded border border-purple-100 text-purple-800 font-medium">${chk}</span>
                                                    `).join('')}
                                                </div>
                                                ` : ''}

                                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs bg-white p-3 rounded-lg border border-purple-100 shadow-sm mb-4">
                                                    <div>
                                                        <span class="block text-purple-400 mb-1 font-medium">اسم المحول</span>
                                                        <span class="font-bold text-stone-800">${order.paymentDetails.senderName}</span>
                                                    </div>
                                                    <div>
                                                        <span class="block text-purple-400 mb-1 font-medium">رقم المحفظة</span>
                                                        <span class="font-bold text-stone-800 dir-ltr text-right font-mono">${order.paymentDetails.senderPhone}</span>
                                                    </div>
                                                    <div>
                                                        <span class="block text-purple-400 mb-1 font-medium">المبلغ المدفوع</span>
                                                        <span class="font-bold text-stone-800 font-serif text-sm">${order.paymentDetails.amountPaid} ج.م</span>
                                                    </div>
                                                    <div>
                                                        <span class="block text-purple-400 mb-1 font-medium">رقم العملية</span>
                                                        <span class="font-bold text-stone-800 font-mono bg-purple-50 px-1 rounded">${order.paymentDetails.transactionId}</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- عرض صورة الإيصال (سكرين شوت) -->
                                                ${order.paymentDetails.screenshotBase64 ? `
                                                <div class="mb-4">
                                                    <p class="text-xs font-bold text-purple-800 mb-2">صورة الإيصال المرفقة:</p>
                                                    <div class="relative group/img w-fit">
                                                        <img src="${order.paymentDetails.screenshotBase64}" class="h-40 w-auto rounded-lg border border-purple-200 shadow-sm cursor-pointer hover:shadow-md transition-all" onclick="var w=window.open('');w.document.write('<img src=\\'${order.paymentDetails.screenshotBase64}\\' style=\\'width:100%\\'>');">
                                                        <div class="absolute inset-0 bg-black/30 rounded-lg flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition-opacity pointer-events-none">
                                                            <span class="text-white text-xs font-bold flex items-center gap-1 bg-black/50 px-2 py-1 rounded-full"><i data-lucide="zoom-in" size="14"></i> اضغط للتكبير</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                ` : '<div class="mb-4 text-xs text-stone-400 bg-white p-2 rounded border border-dashed border-stone-200 inline-block">لا توجد صورة مرفقة</div>'}

                                                ${order.status === 'payment_review' ? `
                                                <div class="flex gap-3">
                                                    <button onclick="handlePaymentDecision('${order.id}', 'approve')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm hover:shadow-md flex items-center justify-center gap-2">
                                                        <i data-lucide="check-circle" size="14"></i> تأكيد الدفع (قبول)
                                                    </button>
                                                    <button onclick="handlePaymentDecision('${order.id}', 'reject')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2">
                                                        <i data-lucide="x-circle" size="14"></i> رفض الدفع
                                                    </button>
                                                </div>
                                                <p class="text-[10px] text-purple-400 mt-2 text-center">* قبول الدفع سيحول حالة الطلب تلقائياً إلى "تم التأكيد"</p>
                                                ` : ''}
                                            </div>
                                            `;
                                        }

                                        // --- 8️⃣ INTERNAL NOTES LOGIC ---
                                        const notesHTML = (order.internalNotes || []).map(n => `
                                            <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-2 text-xs flex justify-between items-start group/note">
                                                <div class="text-yellow-800 font-medium">
                                                    <i data-lucide="sticky-note" size="10" class="inline mb-0.5 ml-1"></i> ${n.text}
                                                </div>
                                                <span class="text-[9px] text-yellow-600 opacity-60 whitespace-nowrap dir-ltr">${new Date(n.timestamp).toLocaleDateString('en-GB')}</span>
                                            </div>
                                        `).join('');
                                        // ---------------------------------

                                        return `
                                        <!-- Added class order-card-item and data-search attribute for instant search -->
                                        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden group mb-4 order-card-item" data-search="${order.id} ${order.customer.name} ${order.customer.phone}">
                                            <div class="bg-stone-50 p-4 border-b border-stone-100 flex justify-between items-center gap-2 flex-wrap">
                                                <div class="flex items-center gap-2 max-w-full">
                                                    <!-- تعديل هنا: عرض الرقم بالكامل مع إمكانية النسخ -->
                                                    <div class="flex items-center bg-white px-3 py-1.5 rounded-lg border border-stone-200 shadow-sm group/id cursor-pointer" onclick="navigator.clipboard.writeText('${order.id}'); showToast('تم نسخ رقم الطلب')">
                                                        <span class="font-mono font-bold text-stone-700 text-xs select-all break-all" title="${order.id}">#${order.id}</span>
                                                        <i data-lucide="copy" size="12" class="text-stone-400 mr-2 opacity-0 group-hover/id:opacity-100 transition-opacity"></i>
                                                    </div>
                                                    <span class="text-xs text-stone-400 font-medium dir-ltr whitespace-nowrap">${date}</span>
                                                </div>
                                                
                                                <div class="flex items-center gap-2 mt-2 sm:mt-0">
                                                    <div class="relative">
                                                         <select onchange="handleOrderStatusChange('${order.id}', this.value)" class="bg-white border border-stone-300 text-stone-700 text-xs font-bold rounded-lg py-1.5 px-3 pr-8 appearance-none focus:outline-none focus:border-stone-900 cursor-pointer shadow-sm" ${currentOrderTab === 'archived' ? 'disabled' : ''}>
                                                            ${statuses.map(s => `<option value="${s.val}" ${order.status === s.val ? 'selected' : ''}>${s.label}</option>`).join('')}
                                                        </select>
                                                        <i data-lucide="chevron-down" class="absolute left-2 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none" size="14"></i>
                                                    </div>
                                                    
                                                    <!-- NEW: Notify Button (The Free Solution) -->
                                                    <a href="${notifyLink}" target="_blank" class="w-8 h-8 rounded-lg bg-green-50 text-green-600 flex items-center justify-center border border-green-200 hover:bg-green-600 hover:text-white transition-all shadow-sm" title="إرسال تحديث الحالة للعميل عبر واتساب">
                                                        <i data-lucide="bell-ring" size="16"></i>
                                                    </a>
                                                </div>
                                            </div>

                                            <div class="p-6 grid lg:grid-cols-2 gap-6">
                                                <div class="space-y-4">
                                                    
                                                    <!-- Pending Modification Request Alert (ADMIN ONLY) -->
                                                    ${order.modificationRequest && order.modificationRequest.status === 'pending' ? `
                                                    <div class="col-span-2 bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg mb-4 animate-pulse">
                                                        <div class="flex justify-between items-start gap-4">
                                                            <div>
                                                                <h4 class="font-bold text-orange-800 text-sm flex items-center gap-2"><i data-lucide="alert-triangle" size="16"></i> طلب تعديل من العميل</h4>
                                                                <p class="text-orange-700 text-sm mt-1">"${order.modificationRequest.message}"</p>
                                                            </div>
                                                            <div class="flex gap-2 shrink-0">
                                                                <button onclick="handleModDecision('${order.id}', 'approved')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">موافقة</button>
                                                                <button onclick="handleModDecision('${order.id}', 'rejected')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">رفض</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    ` : ''}

                                                    <!-- Payment Review Block Insertion -->
                                                    ${paymentReviewHTML}

                                                    <div class="flex items-start gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center shrink-0">
                                                            <i data-lucide="user" size="18" class="text-stone-500"></i>
                                                        </div>
                                                        <div class="w-full">
                                                            <p class="font-bold text-stone-900">${order.customer.name}</p>
                                                            <p class="text-sm text-stone-500 font-mono dir-ltr text-right mb-1">${order.customer.phone}</p>
                                                            <p class="text-xs text-stone-600 bg-stone-50 p-2 rounded border border-stone-100 leading-relaxed">${order.customer.address}</p>
                                                            
                                                            <!-- 7️⃣ QUICK ACTIONS TOOLBAR -->
                                                            <div class="flex gap-2 mt-3">
                                                                <button onclick="navigator.clipboard.writeText('${order.customer.phone}'); showToast('تم نسخ الرقم')" class="flex-1 h-9 flex items-center justify-center gap-1 bg-white hover:bg-stone-50 text-stone-600 rounded-lg border border-stone-200 transition-colors shadow-sm" title="نسخ الرقم">
                                                                    <i data-lucide="copy" size="14"></i>
                                                                </button>
                                                                
                                                                <a href="https://wa.me/20${order.customer.phone.replace(/^0+/, '')}" target="_blank" class="flex-1 h-9 flex items-center justify-center gap-1 bg-white hover:bg-green-50 text-green-600 rounded-lg border border-stone-200 hover:border-green-200 transition-colors shadow-sm" title="واتساب مباشر">
                                                                    <i data-lucide="message-circle" size="14"></i>
                                                                </a>
                                                                
                                                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customer.address)}" target="_blank" class="flex-1 h-9 flex items-center justify-center gap-1 bg-white hover:bg-blue-50 text-blue-600 rounded-lg border border-stone-200 hover:border-blue-200 transition-colors shadow-sm" title="فتح العنوان في الخرائط">
                                                                    <i data-lucide="map-pin" size="14"></i>
                                                                </a>

                                                                <a href="tel:${order.customer.phone}" class="flex-1 h-9 flex items-center justify-center gap-1 bg-white hover:bg-orange-50 text-orange-600 rounded-lg border border-stone-200 hover:border-orange-200 transition-colors shadow-sm" title="اتصال هاتفي">
                                                                    <i data-lucide="phone" size="14"></i>
                                                                </a>
                                                            </div>
                                                            <!-- END QUICK ACTIONS -->
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- REMOVED: Custom WhatsApp Button (Templates) -->
                                                </div>
                                                <div class="space-y-3">
                                                    <div class="bg-stone-50 rounded-xl p-3 border border-stone-100 max-h-40 overflow-y-auto custom-scrollbar">
                                                        ${order.items.map(item => `<div class="flex gap-3 items-center mb-2 last:mb-0"><img src="${item.image}" class="w-8 h-8 rounded object-cover border border-stone-200"><div class="flex-1 min-w-0"><p class="text-xs font-bold text-stone-800 truncate">${item.name}</p><p class="text-[10px] text-stone-500">${item.quantity} x $${item.price}</p></div><span class="text-xs font-bold text-stone-900">$${item.price * item.quantity}</span></div>`).join('')}
                                                    </div>
                                                    <div class="flex justify-between items-center px-2">
                                                        <span class="font-bold text-stone-600 text-sm">الإجمالي</span>
                                                        <span class="font-serif text-lg font-bold text-stone-900">$${order.totalAmount}</span>
                                                    </div>
                                                    <div class="flex justify-between items-center px-2 mt-1">
                                                        <span class="text-xs font-bold text-stone-500">طريقة الدفع</span>
                                                        ${order.paymentMethod === 'vodafone_cash' ? 
                                                            `<span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded border border-red-100 flex items-center gap-1"><i data-lucide="smartphone" size="10"></i> المحافظ الإلكترونية</span>` : 
                                                            `<span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100 flex items-center gap-1"><i data-lucide="banknote" size="10"></i> عند الاستلام</span>`
                                                        }
                                                    </div>

                                                    <!-- 8️⃣ INTERNAL NOTES SECTION (ADMIN ONLY) -->
                                                    <div class="mt-4 pt-3 border-t border-stone-100">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <i data-lucide="lock" size="12" class="text-stone-400"></i>
                                                            <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">ملاحظات داخلية (خاصة)</span>
                                                        </div>
                                                        <div class="space-y-2 mb-2 max-h-32 overflow-y-auto custom-scrollbar">
                                                            ${notesHTML.length > 0 ? notesHTML : '<p class="text-[10px] text-stone-300 italic">لا توجد ملاحظات</p>'}
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <input id="note-input-${order.id}" class="flex-1 bg-stone-50 border border-stone-200 rounded-lg px-3 py-1.5 text-xs focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all placeholder:text-stone-400" placeholder="مثال: عميل متكرر، توصيل مسائي...">
                                                            <button onclick="addInternalNote('${order.id}')" class="bg-stone-100 hover:bg-yellow-100 text-stone-500 hover:text-yellow-700 px-3 py-1 rounded-lg text-xs font-bold transition-colors border border-stone-200 hover:border-yellow-200">
                                                                إضافة
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- END INTERNAL NOTES -->

                                                </div>
                                            </div>
                                            <div class="bg-stone-50 p-3 border-t border-stone-100 flex justify-end gap-2">
                                                 <button onclick="handleOrderAction('${order.id}', 'delete')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="حذف"><i data-lucide="trash-2" size="16"></i></button>
                                                 <button onclick="openEditOrderModal('${order.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-transparent hover:border-blue-100" title="تعديل"><i data-lucide="pen-line" size="16"></i></button>
                                                 ${currentOrderTab === 'active' ? `<button onclick="handleOrderAction('${order.id}', 'archive')" class="px-4 py-2 bg-white border border-stone-200 text-stone-600 hover:text-stone-900 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">أرشفة</button>` : `<button onclick="handleOrderAction('${order.id}', 'restore')" class="px-4 py-2 bg-white border border-stone-200 text-stone-600 hover:text-stone-900 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">استعادة</button>`}
                                            </div>
                                        </div>`;
                                    }).join('');
                                })()}
                            </div>
                        ` : ''}

                        <!-- 3. PRODUCTS TAB -->
                        ${currentAdminTab === 'products' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${isEdit ? 'pen-line' : 'package-plus'}" class="text-blue-600"></i>
                                        ${isEdit ? `<span class="text-blue-600">تعديل المنتج: ${p.name}</span>` : 'إضافة منتج جديد'}
                                    </h2>
                                    ${isEdit ? `<button onclick="cancelEdit()" class="text-stone-400 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-stone-50 rounded-lg transition-colors">إلغاء وعودة للإضافة</button>` : ''}
                                </div>

                                <form onsubmit="handleSaveProduct(event)" class="space-y-8">
                                    <div class="grid md:grid-cols-2 gap-8">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">اسم المنتج <span class="text-red-500">*</span></label>
                                                <input name="prodName" value="${p.name || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none transition-all bg-stone-50 focus:bg-white placeholder:text-stone-300" placeholder="مثال: لوح بديل خشب">
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="space-y-2">
                                                    <label class="text-xs font-bold text-stone-500 uppercase">السعر <span class="text-red-500">*</span></label>
                                                    <div class="relative">
                                                        <input name="prodPrice" type="number" step="0.01" value="${p.price || ''}" required class="w-full border border-stone-200 p-3.5 pl-8 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="0.00">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">$</span>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <label class="text-xs font-bold text-stone-500 uppercase">الخصم %</label>
                                                    <input name="prodDiscount" type="number" min="0" max="100" value="${p.discount || 0}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="0">
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 gap-4">
                                                <!-- Expiry Date Field -->
                                                <div class="space-y-2 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                    <label class="text-xs font-bold text-orange-800 uppercase flex items-center gap-1"><i data-lucide="timer" size="14"></i> تاريخ انتهاء الخصم</label>
                                                    <input name="prodExpiry" type="datetime-local" value="${expiryDateStr}" class="w-full border border-orange-200 p-2 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none bg-white text-stone-700 dir-ltr">
                                                    <p class="text-[10px] text-orange-600">اتركه فارغاً إذا كان الخصم دائم</p>
                                                </div>

                                                <!-- NEW: Featured Product Checkbox -->
                                                <div class="flex items-center gap-3 bg-yellow-50 p-4 rounded-xl border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition-colors" onclick="document.getElementById('prodFeatured').click()">
                                                    <input type="checkbox" name="prodFeatured" id="prodFeatured" class="w-5 h-5 accent-yellow-500 rounded cursor-pointer" onclick="event.stopPropagation()" ${p.isFeatured ? 'checked' : ''}>
                                                    <label for="prodFeatured" class="text-sm font-bold text-yellow-800 cursor-pointer select-none flex items-center gap-2">
                                                        <i data-lucide="star" size="16" class="fill-yellow-500 text-yellow-600"></i> منتج مميز (يظهر في قسم خاص)
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">القسم <span class="text-red-500">*</span></label>
                                                <select name="prodCat" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white cursor-pointer">
                                                    ${CATEGORIES.map(c => `<option ${p.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="space-y-2">
                                                 <label class="text-xs font-bold text-stone-500 uppercase">العلامة التجارية</label>
                                                 <input name="prodBrand" value="${p.brand || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="اسم البراند (اختياري)">
                                            </div>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">رابط الصورة الرئيسية <span class="text-red-500">*</span></label>
                                                <input name="prodImg" value="${p.image || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left" placeholder="${HERO_SETTINGS.imageBaseUrl ? 'أدخل اسم الملف فقط (مثل: image_01)' : 'https://example.com/image.jpg'}">
                                                ${HERO_SETTINGS.imageBaseUrl ? `<p class="text-[10px] text-blue-600 dir-rtl">سيتم الدمج تلقائياً مع: ${HERO_SETTINGS.imageBaseUrl} وامتداد ${HERO_SETTINGS.imageDefaultExt || '.webp'}</p>` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">صور إضافية (رابط في كل سطر)</label>
                                                <textarea name="prodImages" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="https://...&#10;https://...">${extraImages}</textarea>
                                            </div>
                                            <!-- NEW: Variants Field -->
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase flex items-center gap-1"><i data-lucide="palette" size="14"></i> ألوان المنتج (اسم اللون : رابط الصورة)</label>
                                                <textarea name="prodVariants" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="Red: https://...&#10;Blue: https://...">${variantsString}</textarea>
                                                <p class="text-[10px] text-stone-400">أدخل كل لون في سطر جديد. سيتم عرض هذه الألوان كخيارات للعميل.</p>
                                            </div>
                                             <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المادة (Material)</label>
                                                <input name="prodMaterial" value="${p.material || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="مثال: خشب زان">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-8 pt-4 border-t border-stone-100">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">وصف المنتج</label>
                                                <textarea name="prodDesc" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="وصف تفصيلي للمنتج...">${p.description || ''}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المميزات (نقطة في كل سطر)</label>
                                                <textarea name="prodFeatures" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="- ميزة 1&#10;- ميزة 2">${features}</textarea>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المواصفات (الاسم: القيمة)</label>
                                                <textarea name="prodSpecs" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="الطول: 120 سم&#10;الوزن: 5 كجم">${specsString}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">الخدمات (أيقونة: نص)</label>
                                                <textarea name="prodServices" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-right" placeholder="truck: توصيل مجاني">${servicesString}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="w-full ${isEdit ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-4 rounded-xl font-bold transition-all text-lg shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2">
                                        <i data-lucide="${isEdit ? 'save' : 'plus-circle'}"></i>
                                        ${isEdit ? 'حفظ التعديلات' : 'إضافة المنتج للمتجر'}
                                    </button>
                                </form>
                            </div>
                        ` : ''}

                        <!-- 4. CATEGORIES TAB -->
                        ${currentAdminTab === 'categories' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${currentEditCategoryName ? 'pen-line' : 'folder-plus'}" class="text-blue-600"></i>
                                        ${currentEditCategoryName ? `تعديل قسم: <span class="text-blue-600">${currentEditCategoryName}</span>` : 'إدارة الأقسام'}
                                    </h2>
                                    ${currentEditCategoryName ? `<button onclick="cancelEditCategory()" class="text-stone-400 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-stone-50 rounded-lg transition-colors">إلغاء التعديل</button>` : ''}
                                </div>

                                <form onsubmit="handleAddCategory(event)" class="max-w-xl space-y-6">
                                    <div>
                                        <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">اسم القسم <span class="text-red-500">*</span></label>
                                        <input name="catName" value="${catNameVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="مثال: ديكورات حائط">
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">صورة القسم (رابط) <span class="text-red-500">*</span></label>
                                        <input name="catImg" value="${catImgVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left" placeholder="https://...">
                                    </div>

                                    <button class="w-full ${currentEditCategoryName ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-3.5 rounded-xl font-bold transition-all shadow-md flex justify-center items-center gap-2">
                                        <i data-lucide="${currentEditCategoryName ? 'save' : 'plus'}"></i>
                                        ${currentEditCategoryName ? 'حفظ التغييرات' : 'إضافة القسم'}
                                    </button>
                                </form>

                                <div class="mt-12">
                                    <h3 class="font-bold text-lg text-stone-900 mb-4 border-b border-stone-100 pb-2">الأقسام الحالية</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${CATEGORIES.map(c => `
                                            <div class="flex items-center gap-4 bg-stone-50 p-3 rounded-xl border border-stone-200 group hover:border-stone-300 transition-colors">
                                                <div class="w-16 h-16 rounded-lg bg-white overflow-hidden border border-stone-100 shrink-0">
                                                    <img src="${c.image}" class="w-full h-full object-cover">
                                                </div>
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-stone-900">${c.name}</h4>
                                                    <p class="text-xs text-stone-400">قسم نشط</p>
                                                </div>
                                                <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onclick="prepareEditCategory('${c.name}')" class="p-2 bg-white text-blue-600 border border-blue-100 hover:bg-blue-50 rounded-lg transition-colors shadow-sm"><i data-lucide="pen-line" size="16"></i></button>
                                                    <button onclick="handleDeleteCategory('${c.name}')" class="p-2 bg-white text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition-colors shadow-sm"><i data-lucide="trash-2" size="16"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- 5. SETTINGS TAB (RESTORED) -->
                        ${currentAdminTab === 'settings' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="layout-template" class="text-stone-900"></i>
                                        إعدادات الموقع والواجهة
                                    </h2>
                                </div>

                                <form onsubmit="handleSaveHeroSettings(event)" class="space-y-8 max-w-3xl">
                                    
                                    <!-- NEW: Image Configuration Settings -->
                                    <div class="space-y-4 p-6 bg-blue-50 rounded-2xl border border-blue-200">
                                        <h3 class="font-bold text-blue-800 flex items-center gap-2"><i data-lucide="image-plus"></i> تكوين روابط الصور (تلقائي)</h3>
                                        <div class="grid md:grid-cols-3 gap-6">
                                            <div class="md:col-span-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط القاعدة (Base URL)</label>
                                                <input name="imgBaseUrl" value="${HERO_SETTINGS.imageBaseUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder="https://example.com/images/">
                                                <p class="text-[10px] text-stone-500 mt-1">المسار الثابت الذي ترفع عليه صور منتجاتك</p>
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الامتداد الافتراضي</label>
                                                <input name="imgExt" value="${HERO_SETTINGS.imageDefaultExt || '.webp'}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder=".webp">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logo Settings -->
                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="image-plus"></i> هوية الموقع (الشعار)</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط الشعار (Logo URL)</label>
                                                <input name="siteLogo" value="${HERO_SETTINGS.logoUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://... (اتركه فارغاً للنص)">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">حجم الشعار (عرض بالبكسل)</label>
                                                <div class="relative">
                                                    <input name="logoSize" type="number" value="${HERO_SETTINGS.logoSize || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="100">
                                                    <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Header Banner Settings -->
                                    <div class="space-y-4 p-6 bg-orange-50 rounded-2xl border border-orange-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-orange-600 flex items-center gap-2"><i data-lucide="monitor"></i> بانر إعلاني (أسفل الهيدر)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="fbShow" class="w-5 h-5 accent-orange-600 rounded" ${HERO_SETTINGS.showFooterBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-orange-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صور البانر (كل رابط في سطر)</label>
                                                <textarea name="fbUrl" rows="3" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white custom-scrollbar" placeholder="https://image1.jpg&#10;https://image2.jpg">${HERO_SETTINGS.footerBannerUrl || ''}</textarea>
                                            </div>
                                            
                                            <!-- Desktop Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="monitor" size="14"></i> إعدادات الكمبيوتر</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input name="fbHeightDesk" type="number" value="${HERO_SETTINGS.fbHeightDesktop || HERO_SETTINGS.footerBannerHeight || '300'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">العرض (%)</label>
                                                        <input name="fbWidthDesk" type="number" value="${HERO_SETTINGS.fbWidthDesktop || HERO_SETTINGS.footerBannerWidth || '90'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input name="fbRadiusDesk" value="${HERO_SETTINGS.fbRadiusDesktop || HERO_SETTINGS.footerBannerRadius || '2rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Mobile Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="smartphone" size="14"></i> إعدادات الموبايل</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input name="fbHeightMob" type="number" value="${HERO_SETTINGS.fbHeightMobile || '150'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">العرض (%)</label>
                                                        <input name="fbWidthMob" type="number" value="${HERO_SETTINGS.fbWidthMobile || '95'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input name="fbRadiusMob" value="${HERO_SETTINGS.fbRadiusMobile || '1rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Category Banner Settings -->
                                    <div class="space-y-4 p-6 bg-green-50 rounded-2xl border border-green-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-green-600 flex items-center gap-2"><i data-lucide="layout"></i> بانر إعلاني (أسفل الأقسام)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="catBanShow" class="w-5 h-5 accent-green-600 rounded" ${HERO_SETTINGS.showCategoryBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-green-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صور البانر (كل رابط في سطر)</label>
                                                <textarea name="catBanUrl" rows="3" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-green-600 outline-none dir-ltr bg-white custom-scrollbar" placeholder="https://image1.jpg&#10;https://image2.jpg">${HERO_SETTINGS.categoryBannerUrl || ''}</textarea>
                                            </div>

                                            <!-- Desktop Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="monitor" size="14"></i> إعدادات الكمبيوتر</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input name="catBanHeightDesk" type="number" value="${HERO_SETTINGS.catBanHeightDesktop || HERO_SETTINGS.categoryBannerHeight || '250'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">العرض (%)</label>
                                                        <input name="catBanWidthDesk" type="number" value="${HERO_SETTINGS.catBanWidthDesktop || HERO_SETTINGS.categoryBannerWidth || '90'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input name="catBanRadiusDesk" value="${HERO_SETTINGS.catBanRadiusDesktop || HERO_SETTINGS.categoryBannerRadius || '1.5rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Mobile Settings -->
                                            <div class="bg-white p-4 rounded-xl border border-stone-200">
                                                <h4 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="smartphone" size="14"></i> إعدادات الموبايل</h4>
                                                <div class="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الارتفاع (px)</label>
                                                        <input name="catBanHeightMob" type="number" value="${HERO_SETTINGS.catBanHeightMobile || '120'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">العرض (%)</label>
                                                        <input name="catBanWidthMob" type="number" value="${HERO_SETTINGS.catBanWidthMobile || '95'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                    <div>
                                                        <label class="text-[10px] font-bold text-stone-500 uppercase block mb-1">الحواف (Radius)</label>
                                                        <input name="catBanRadiusMob" value="${HERO_SETTINGS.catBanRadiusMobile || '0.8rem'}" class="w-full border border-stone-200 p-2 rounded-lg text-sm text-center">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Best Seller Banner Settings -->
                                    <div class="space-y-4 p-6 bg-purple-50 rounded-2xl border border-purple-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-purple-600 flex items-center gap-2"><i data-lucide="trending-up"></i> بانر إعلاني (أسفل الأكثر مبيعاً)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="bsBanShow" class="w-5 h-5 accent-purple-600 rounded" ${HERO_SETTINGS.showBestSellerBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-purple-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="bsBanUrl" value="${HERO_SETTINGS.bestSellerBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="bsBanHeight" type="number" value="${HERO_SETTINGS.bestSellerBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="bsBanWidth" type="number" value="${HERO_SETTINGS.bestSellerBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Featured Banner Settings -->
                                    <div class="space-y-4 p-6 bg-yellow-50 rounded-2xl border border-yellow-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-yellow-600 flex items-center gap-2"><i data-lucide="star"></i> بانر إعلاني (أسفل المنتجات المميزة)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="ftBanShow" class="w-5 h-5 accent-yellow-600 rounded" ${HERO_SETTINGS.showFeaturedBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-yellow-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="ftBanUrl" value="${HERO_SETTINGS.featuredBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="ftBanHeight" type="number" value="${HERO_SETTINGS.featuredBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="ftBanWidth" type="number" value="${HERO_SETTINGS.featuredBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hero Settings -->
                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                            <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="image"></i> الصور الرئيسية (Hero Section)</h3>
                                            
                                            <!-- Hero Visibility Controls -->
                                            <div class="flex gap-3">
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-stone-200 hover:border-blue-300 transition-colors">
                                                    <input type="checkbox" name="heroShowMobile" class="w-4 h-4 accent-blue-600 rounded" ${HERO_SETTINGS.showHeroMobile !== false ? 'checked' : ''}>
                                                    <span class="text-xs font-bold text-stone-700 flex items-center gap-1"><i data-lucide="smartphone" size="14"></i> إظهار في الهاتف</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-stone-200 hover:border-blue-300 transition-colors">
                                                    <input type="checkbox" name="heroShowDesktop" class="w-4 h-4 accent-blue-600 rounded" ${HERO_SETTINGS.showHeroDesktop !== false ? 'checked' : ''}>
                                                    <span class="text-xs font-bold text-stone-700 flex items-center gap-1"><i data-lucide="monitor" size="14"></i> إظهار في الكمبيوتر</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الصورة الكبيرة (الخلفية)</label>
                                                <input name="heroMain" value="${HERO_SETTINGS.mainImage || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الصورة الصغيرة (الأمامية)</label>
                                                <input name="heroSec" value="${HERO_SETTINGS.secondaryImage || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="tag"></i> بطاقة السعر العائم</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">النص العلوي</label>
                                                <input name="heroPriceLabel" value="${HERO_SETTINGS.priceLabel || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="يبدأ من">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">السعر المعروض</label>
                                                <input name="heroPriceValue" value="${HERO_SETTINGS.priceValue || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="250 ج.م">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="percent"></i> دائرة الخصم</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">قيمة الخصم</label>
                                                <input name="heroDiscValue" value="${HERO_SETTINGS.discountValue || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="20%">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الوصف المختصر</label>
                                                <input name="heroDiscLabel" value="${HERO_SETTINGS.discountLabel || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="خصم خاص">
                                            </div>
                                        </div>
                                    </div>

                                    <button class="w-full bg-stone-900 text-white hover:bg-stone-800 py-4 rounded-xl font-bold transition-all shadow-lg flex justify-center items-center gap-2">
                                        <i data-lucide="save"></i> حفظ وتحديث الإعدادات
                                    </button>
                                </form>
                            </div>
                        ` : ''}

                    </div>
                </div>
            </div>`;
        }

        function renderLogin(c) {
            c.innerHTML = `
                <!-- تم تعديل pt-32 إلى pt-28 -->
                <div class="min-h-screen flex items-center justify-center bg-stone-50 px-6 pt-28 md:pt-20">
                    <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl max-w-md w-full text-center space-y-8 fade-in-up">
                        <div class="flex justify-center mb-4"><div class="p-4 bg-stone-100 rounded-full"><i data-lucide="shield-check" size="32" class="text-stone-900"></i></div></div>
                        <div>
                            <h2 class="text-3xl font-serif font-bold text-stone-900 mb-2">دخول المالك</h2>
                            <p class="text-stone-500 text-sm leading-relaxed">هذه المنطقة محظورة ومخصصة فقط لإدارة المتجر بواسطة المالك.<br>أي محاولة دخول بحساب آخر سيتم رفضها.</p>
                        </div>
                        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-stone-900 text-white font-bold py-4 rounded-xl hover:bg-stone-800 transition-all hover:shadow-lg group">
                            <svg class="w-5 h-5 bg-white rounded-full p-0.5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            <span>تسجيل الدخول (المالك فقط)</span>
                        </button>
                        <button onclick="setView('home')" class="text-sm text-stone-400 hover:text-stone-900 underline underline-offset-4">العودة للرئيسية كزائر</button>
                    </div>
                </div>
            `;
        }

        function renderContact(c) {
            // ... existing contact code ...
            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="pt-28 md:pt-24 pb-20 container mx-auto px-6 min-h-screen bg-stone-50/30">
                <!-- ... existing content ... -->
                <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto fade-in-up" style="animation-delay: 0.1s;">
                    <!-- ... cards ... -->
                    <a href="https://wa.me/201014175070" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-[#25D366]"></div>
                        <div class="w-16 h-16 bg-[#25D366]/10 text-[#25D366] rounded-2xl flex items-center justify-center mb-6 group-hover:bg-[#25D366] group-hover:text-white transition-colors">
                            <i data-lucide="message-circle" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">واتساب المعرض</h3>
                        <p class="text-stone-500 text-sm mb-4">تحدث معنا مباشرة لخدمة أسرع</p>
                        <span class="font-mono dir-ltr font-bold text-stone-800 text-lg group-hover:text-[#25D366] transition-colors bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-[#25D366]/5">01014175070</span>
                    </a>

                    <a href="mailto:gedar.fayoum@gmail.com" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i data-lucide="mail" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">البريد الإلكتروني</h3>
                        <p class="text-stone-500 text-sm mb-4">راسلنا لأي استفسارات تجارية</p>
                        <span class="font-bold text-stone-800 text-sm break-all group-hover:text-blue-600 transition-colors bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-blue-50">gedar.fayoum@gmail.com</span>
                    </a>

                    <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-orange-600"></div>
                        <div class="w-16 h-16 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                            <i data-lucide="map-pin" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">موقع المعرض</h3>
                        <p class="text-stone-500 text-sm mb-4">الفيوم - نهاية شارع المستشفي العام إتجاه مديرية الأمن<br/>بجوار المغسلة الامريكيه وامام مطعم ابو صلاح</p>
                        <div class="flex items-center gap-2 text-stone-800 font-bold bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-orange-50 group-hover:text-orange-600 transition-colors text-sm">
                            <span>عرض على الخريطة</span>
                            <i data-lucide="external-link" size="14"></i>
                        </div>
                    </a>
                </div>
                <!-- ... existing map ... -->
                <div class="mt-12 max-w-6xl mx-auto rounded-3xl overflow-hidden shadow-lg border border-stone-200 h-[400px] relative group fade-in-up" style="animation-delay: 0.2s;">
                     <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="block w-full h-full relative group">
                        <div class="absolute inset-0 bg-stone-200 bg-[url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg')] bg-cover opacity-20 grayscale group-hover:grayscale-0 transition-all duration-700"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-stone-900/10 to-transparent"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 z-10">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-xl animate-bounce text-red-600">
                                <i data-lucide="map-pin" class="fill-current" size="40"></i>
                            </div>
                            <span class="bg-white/90 backdrop-blur-md px-8 py-4 rounded-full font-bold shadow-lg text-stone-900 group-hover:scale-105 transition-transform border border-white/50 flex items-center gap-2">
                                <i data-lucide="navigation" size="18"></i>
                                اضغط هنا لفتح الموقع على Google Maps
                            </span>
                        </div>
                     </a>
                </div>
            </div>`;
        }

        // NEW: Render Return Policy Page
        function renderReturnPolicy(c) {
            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="pt-28 md:pt-24 pb-20 container mx-auto px-6 min-h-screen">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-12 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-blue-50 text-blue-600 mb-4 shadow-sm border border-blue-100"><i data-lucide="file-text" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">سياسة الاسترجاع والاستبدال</h1>
                        <p class="text-stone-500 text-lg">نحن نحرص دائمًا على رضا عملائنا، لذلك نوفر لك سياسة استرجاع واستبدال واضحة ومرنة لضمان أفضل تجربة شراء ممكنة.</p>
                    </div>

                    <div class="space-y-8 fade-in-up" style="animation-delay: 0.1s;">
                        <!-- Section 1 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">1</div> أولًا: شروط الاسترجاع</h2>
                            <p class="text-stone-600 mb-4 font-medium">يمكنك طلب استرجاع المنتج خلال <span class="text-red-600 font-bold">14 يومًا</span> من تاريخ الاستلام في الحالات التالية:</p>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-stone-300">
                                <li>إذا كان المنتج مختلفًا عن المواصفات أو غير مطابق للوصف.</li>
                                <li>إذا وصل المنتج بعيب مصنعي أو تالفًا.</li>
                                <li>إذا تم شحن منتج غير صحيح.</li>
                            </ul>
                            <p class="mt-4 text-sm bg-yellow-50 p-3 rounded-xl text-yellow-800 border border-yellow-100 flex gap-2 items-start"><i data-lucide="alert-circle" size="16" class="mt-0.5 shrink-0"></i> يُشترط أن يكون المنتج في حالته الأصلية بدون فتح أو استخدام، وبنفس التغليف والملحقات.</p>
                        </div>

                        <!-- Section 2 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">2</div> ثانيًا: شروط الاستبدال</h2>
                            <p class="text-stone-600 mb-4 font-medium">يمكنك طلب استبدال المنتج خلال <span class="text-blue-600 font-bold">30 يومًا</span> من تاريخ الاستلام في الحالات التالية:</p>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-stone-300">
                                <li>استبدال المقاسات أو الألوان (إذا كانت متاحة).</li>
                                <li>رغبة العميل في استبدال منتج بمنتج آخر مع تحمّل فرق السعر إن وجد.</li>
                            </ul>
                        </div>

                        <!-- Section 3 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">3</div> ثالثًا: المنتجات غير القابلة للاسترجاع</h2>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-red-300">
                                <li>المنتجات المفتوحة أو المستخدمة.</li>
                                <li>المنتجات المصممة خصيصًا بطلب العميل.</li>
                                <li>العروض الخاصة التي يتم توضيح فيها عدم إمكانية الاسترجاع.</li>
                            </ul>
                        </div>

                        <!-- Section 4 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">4</div> رابعًا: خطوات تقديم طلب الاسترجاع أو الاستبدال</h2>
                            <ol class="space-y-4">
                                <li class="flex gap-4 items-start">
                                    <div class="bg-green-50 text-green-600 p-2 rounded-lg shrink-0"><i data-lucide="message-circle" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">التواصل معنا</h4>
                                        <p class="text-stone-500 text-sm">عبر خدمة العملاء عبر واتساب وإرسال رقم الطلب.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="file-question" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">تحديد السبب</h4>
                                        <p class="text-stone-500 text-sm">تحديد سبب الاسترجاع أو الاستبدال بوضوح.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="package" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">تجهيز المنتج</h4>
                                        <p class="text-stone-500 text-sm">تجهيز المنتج وتسليمه لمندوب الشحن بعد تحديد الموعد.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="banknote" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">استرداد المبلغ</h4>
                                        <p class="text-stone-500 text-sm">يتم استرجاع المبلغ خلال 1 - 3 ايام عمل حسب وسيلة الدفع المستخدمة.</p>
                                    </div>
                                </li>
                            </ol>
                        </div>

                        <!-- Section 5 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">5</div> خامسًا: رسوم الشحن</h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                                    <h4 class="font-bold text-red-800 mb-2">خطأ من جانبنا</h4>
                                    <p class="text-red-700 text-sm">منتج خاطئ – تالف – غير مطابق: نحن نتحمّل تكلفة الشحن بالكامل.</p>
                                </div>
                                <div class="bg-stone-50 p-4 rounded-2xl border border-stone-200">
                                    <h4 class="font-bold text-stone-800 mb-2">رغبة العميل (دون خطأ)</h4>
                                    <p class="text-stone-600 text-sm">يتم خصم رسوم الشحن من قيمة المبلغ المسترد.</p>
                                </div>
                            </div>
                        </div>

                        <!-- CPA Contact -->
                        <div class="bg-stone-900 text-white p-8 rounded-3xl shadow-lg relative overflow-hidden">
                            <div class="relative z-10">
                                <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><i data-lucide="shield-check"></i> جهاز حماية المستهلك</h2>
                                <p class="text-stone-400 mb-6 text-sm">في حال وجود أي مشكلة لم يتم حلّها من خلال خدمة العملاء، يمكنكم التواصل مع جهاز حماية المستهلك في مصر:</p>
                                
                                <div class="grid md:grid-cols-2 gap-6 text-sm">
                                    <div>
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-1">الرقم المختصر</p>
                                        <p class="font-mono text-xl font-bold dir-ltr text-right md:text-right">19588</p>
                                    </div>
                                    <div>
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-1">البريد الإلكتروني</p>
                                        <p class="font-mono dir-ltr text-right md:text-right">info@cpa.gov.eg</p>
                                    </div>
                                    <div class="col-span-2">
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-2">واتساب الشكاوى</p>
                                        <div class="flex flex-col gap-1 font-mono dir-ltr text-right md:text-right">
                                            <span>القاهرة الكبرى: 01577779999</span>
                                            <span>باقي المحافظات: 01555516528</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 pt-6 border-t border-white/10 text-center md:text-right">
                                    <a href="http://shakwa.cpa-mobile.com/" target="_blank" class="inline-flex items-center gap-2 text-stone-300 hover:text-white transition-colors underline decoration-stone-600 underline-offset-4">
                                        زيارة موقع تقديم الشكاوى (حماية المستهلك)
                                        <i data-lucide="external-link" size="14"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Decor -->
                            <div class="absolute top-0 left-0 w-64 h-64 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2 blur-3xl"></div>
                        </div>

                    </div>
                </div>
            </div>`;
        }

        // NEW: Render FAQ Page
        function renderFAQ(c) {
            // ...
            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="pt-28 md:pt-24 pb-20 container mx-auto px-6 min-h-screen bg-stone-50/30">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-12 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-indigo-50 text-indigo-600 mb-4 shadow-sm border border-indigo-100"><i data-lucide="help-circle" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">الأسئلة الشائعة</h1>
                        <p class="text-stone-500 text-lg">إجابات على أكثر الأسئلة تداولاً لمساعدتك في اتخاذ القرار.</p>
                    </div>

                    <div class="space-y-4 fade-in-up" style="animation-delay: 0.1s;">
                        ${faqs.map((item, idx) => `
                            <div class="bg-white rounded-2xl border border-stone-200 overflow-hidden group">
                                <button onclick="toggleFAQ(${idx})" class="w-full text-right p-6 flex justify-between items-center hover:bg-stone-50 transition-colors">
                                    <h3 class="font-bold text-stone-900 text-lg flex items-center gap-3">
                                        <span class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 text-xs font-mono">${idx + 1}</span>
                                        ${item.q}
                                    </h3>
                                    <div id="faq-icon-${idx}" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 transition-transform duration-300">
                                        <i data-lucide="chevron-down" size="20"></i>
                                    </div>
                                </button>
                                <div id="faq-content-${idx}" class="hidden px-6 pb-6 text-stone-600 leading-relaxed border-t border-stone-100 pt-4 bg-stone-50/30 mr-14">
                                    ${item.a}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-12 text-center bg-blue-50 rounded-3xl p-8 border border-blue-100 fade-in-up" style="animation-delay: 0.2s;">
                        <h3 class="font-bold text-blue-900 text-lg mb-2">لم تجد إجابة لسؤالك؟</h3>
                        <p class="text-blue-700/80 mb-6">فريقنا جاهز للرد على جميع استفساراتك عبر الواتساب.</p>
                        <a href="https://wa.me/201014175070" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                            <i data-lucide="message-circle" size="18"></i> تحدث معنا الآن
                        </a>
                    </div>
                </div>
            </div>`;
        }

        window.toggleFAQ = (idx) => {
            const content = document.getElementById(`faq-content-${idx}`);
            const icon = document.getElementById(`faq-icon-${idx}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        };

        function renderAbout(c) {
            c.innerHTML = `<div class="pt-28 md:pt-24 container mx-auto px-6 text-center"><h1 class="text-4xl font-bold mb-8">تبسيط المنزل</h1><p class="max-w-2xl mx-auto text-stone-600">وُلدت علامة "جدار" من الرغبة في إعادة الهدوء إلى المنزل.</p></div>`;
        }

        function renderProductDetails(c) {
            // NEW: Loading State for Direct Links
            if (!isDataLoaded && PRODUCTS.length === 0) {
                c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center pt-28 md:pt-20">
                    <div class="animate-spin w-12 h-12 border-4 border-stone-200 border-t-stone-900 rounded-full mb-4"></div>
                    <p class="text-stone-500 font-medium">جاري تحميل المنتج...</p>
                </div>`;
                return;
            }

            const p = PRODUCTS.find(x => x.id == currentProductId);
            if(!p) return c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center text-center px-4 pt-28 md:pt-20">
                    <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-stone-400">
                        <i data-lucide="search-x" size="40"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-stone-900 mb-2">المنتج غير موجود</h2>
                    <p class="text-stone-500 mb-6">قد يكون تم حذف المنتج أو الرابط غير صحيح.</p>
                    <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">تصفح المتجر</button>
                </div>`;
            
            const isFav = favorites.includes(p.id);
            const images = (p.images && p.images.length > 0) ? p.images : [p.image];
            const features = (p.features && p.features.length > 0) ? p.features : [];

            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)).toFixed(2) : p.price;

            // Calculate Reviews Data
            const productReviews = ALL_REVIEWS.filter(r => r.productId === p.id && r.status === 'approved');
            const totalReviews = productReviews.length;
            const averageRating = totalReviews > 0 ? (productReviews.reduce((sum, r) => sum + r.rating, 0) / totalReviews).toFixed(1) : 0;
            const counts = { 5:0, 4:0, 3:0, 2:0, 1:0 };
            productReviews.forEach(r => counts[r.rating]++);

            // --- 1️⃣ Customer Trust: Dynamic Order Counter Logic ---
            const randomMinutes = Math.floor(Math.random() * 40) + 5; // وقت عشوائي بين 5 و 45 دقيقة
            const trustCounterHTML = `
            <div class="mt-4 pt-4 border-t border-stone-100">
                <p class="text-xs text-stone-600 flex items-center gap-2 mb-2 font-medium bg-green-50 w-fit px-3 py-1.5 rounded-full border border-green-100">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span>آخر طلب تم تأكيده منذ <b>${randomMinutes} دقيقة</b></span>
                </p>
                <div class="flex items-center gap-2 text-[10px] text-stone-500">
                    <i data-lucide="shield-check" class="text-green-600" size="14"></i>
                    <span>عملية الدفع مؤمنة 100% ويتم مراجعتها يدوياً</span>
                </div>
            </div>
            `;
            // -----------------------------------------------------

            // --- Window function to handle color selection ---
            window.selectColor = (colorName, imageUrl) => {
                currentSelectedColor = colorName;
                
                // Update Main Image
                const mainImg = document.getElementById('main-product-image');
                if (mainImg && imageUrl) mainImg.src = imageUrl;
                
                // Update Active State of Buttons
                const allBtns = document.querySelectorAll('.variant-btn');
                allBtns.forEach(btn => {
                    if (btn.dataset.color === colorName) {
                        btn.classList.add('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.remove('border-stone-200');
                        btn.classList.add('border-stone-900');
                    } else {
                        btn.classList.remove('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.add('border-stone-200');
                        btn.classList.remove('border-stone-900');
                    }
                });
            };

            // --- Dynamic Tags Generation (NEW) ---
            // 1. Get all Category Names
            const catTags = CATEGORIES.map(c => c.name);
            
            // 2. Get Random Product Keywords (First 2-3 words of product names)
            const prodTags = PRODUCTS
                .filter(prod => prod.id !== p.id) // Exclude current product
                .map(prod => prod.name.split(' ').slice(0, 3).join(' ')) // Take first 3 words
                .sort(() => 0.5 - Math.random()) // Shuffle
                .slice(0, 12); // Take 12 items
            
            // 3. Combine & Deduplicate
            const dynamicTags = [...new Set([...catTags, ...prodTags])];

            // --- NEW: Random Sponsored Product Logic ---
            const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
            const adHTML = adProduct ? `
            <div onclick="viewProduct('${adProduct.id}')" class="w-full bg-gradient-to-r from-stone-50 via-white to-stone-50 border border-stone-200 rounded-xl p-3 mb-8 flex items-center gap-4 cursor-pointer hover:shadow-md hover:border-green-200 transition-all group animate-in fade-in slide-in-from-top-4 duration-700">
                <div class="bg-stone-200 text-stone-500 text-[10px] font-bold px-2 py-1 rounded select-none">إعلان</div>
                
                <div class="w-12 h-12 bg-white rounded-lg border border-stone-100 overflow-hidden shrink-0">
                    <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                </div>
                
                <div class="flex-1 min-w-0 flex flex-col sm:flex-row sm:items-center justify-between gap-1 sm:gap-4">
                    <div class="truncate">
                        <h4 class="font-bold text-stone-900 text-xs sm:text-sm truncate group-hover:text-green-700 transition-colors">${adProduct.name}</h4>
                        <p class="text-[10px] text-stone-500 truncate hidden sm:block">${adProduct.description ? adProduct.description.substring(0, 50) + '...' : 'تصفح هذا المنتج المميز الآن'}</p>
                    </div>
                    
                    <div class="flex items-center gap-3 shrink-0">
                        <span class="font-serif font-bold text-stone-900 text-sm sm:text-base">$${adProduct.price}</span>
                        <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-400 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-all">
                            <i data-lucide="arrow-left" size="16"></i>
                        </div>
                    </div>
                </div>
            </div>` : '';

            // --- Prepared Slider Data ---
            
            // 1. Related Products (Same Category)
            const relatedProducts = PRODUCTS.filter(prod => prod.category === p.category && prod.id !== p.id);
            
            // 2. Random Suggestions (NEW LOGIC)
            // Shuffle all products and pick 8 random ones (excluding current)
            const randomSuggestions = PRODUCTS.filter(prod => prod.id !== p.id)
                                              .sort(() => 0.5 - Math.random())
                                              .slice(0, 8);

            // 3. Browsing History
            const historyIds = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            const historyProducts = historyIds.map(hId => PRODUCTS.find(prod => prod.id === hId)).filter(item => item !== undefined);

            // --- Helper: Render Slider HTML (Updated for Small Cards) ---
            const renderSliderHTML = (id, title, items, isSmall = false) => {
                if (items.length === 0) return '';
                
                // Determine width based on isSmall flag
                // UPDATE: تم تصغير العرض الافتراضي من 260px إلى 210px
                const cardWidthClass = isSmall ? 'min-w-[140px] w-[140px]' : 'min-w-[210px] w-[210px]';
                
                return `
                <div class="mt-16 border-t border-stone-100 pt-10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="${isSmall ? 'text-lg' : 'text-xl'} font-bold text-stone-900">${title}</h3>
                        <div class="flex gap-2">
                            <button onclick="scrollSection('${id}', 'prev')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600"><i data-lucide="arrow-right" size="16"></i></button>
                            <button onclick="scrollSection('${id}', 'next')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600"><i data-lucide="arrow-left" size="16"></i></button>
                        </div>
                    </div>
                    <div id="${id}" class="flex gap-4 overflow-x-auto scrollbar-hide scroll-smooth snap-x pb-4">
                        ${items.map(item => `
                            <div class="${cardWidthClass} snap-start">
                                ${isSmall ? createSmallProductCard(item) : createProductCard(item)}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            c.innerHTML = `
            <!-- تم تعديل pt-32 إلى pt-28 -->
            <div class="bg-white min-h-screen pt-28 md:pt-28 pb-20">
                <div class="container mx-auto px-4 lg:px-6">
                    
                    <!-- Insert The Ad Banner Here -->
                    ${adHTML}

                    <div class="flex items-center gap-2 text-sm text-stone-500 mb-8">
                        <button onclick="setView('shop')" class="hover:text-stone-900">المتجر</button><i data-lucide="chevron-left" size="14"></i>
                        <button onclick="filterCategory('${p.category}'); setView('shop')" class="hover:text-stone-900">${p.category}</button><i data-lucide="chevron-left" size="14"></i>
                        <span class="text-stone-900 font-medium truncate max-w-[200px]">${p.name}</span>
                    </div>
                    
                    <!-- Top Section: Images & Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mb-12">
                        <!-- Product Images -->
                        <div class="lg:col-span-5 flex flex-col-reverse lg:flex-row gap-4">
                            <div class="flex lg:flex-col gap-3 overflow-x-auto lg:overflow-y-auto lg:max-h-[500px] scrollbar-hide py-1 px-1">
                                ${images.map((img, idx) => `<div onmouseover="setActiveImage(${idx})" onclick="setActiveImage(${idx})" class="gallery-thumb cursor-pointer border border-stone-200 rounded-lg p-1 w-16 h-16 lg:w-20 lg:h-20 flex-shrink-0 bg-stone-50 ${idx===0?'active':''} hover:border-stone-400 transition-all"><img src="${img}" class="w-full h-full object-cover rounded-md"></div>`).join('')}
                            </div>
                            <!-- Modified Image Container: Square but constrained width/height -->
                            <div class="flex-1 bg-white rounded-2xl border border-stone-200 flex items-center justify-center relative group w-full max-w-[500px] mx-auto aspect-square overflow-hidden shadow-sm">
                                <img id="main-product-image" src="${images[0]}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                <button onclick="toggleFavorite('${p.id}')" class="absolute top-4 right-4 p-3 rounded-full bg-white/90 backdrop-blur-sm shadow-md hover:bg-white transition-all z-10"><i data-lucide="heart" class="${isFav?'text-red-500 fill-red-500':'text-stone-400'}"></i></button>
                            </div>
                        </div>

                        <!-- Product Info -->
                        <div class="lg:col-span-4 space-y-6">
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        ${p.brand ? `<a href="#" class="text-sm text-blue-600 hover:text-orange-600 hover:underline mb-1 inline-block font-medium">زيارة متجر ${p.brand}</a>` : ''}
                                        <h1 class="text-2xl lg:text-3xl font-bold text-stone-900 leading-tight mb-2">${p.name}</h1>
                                    </div>
                                    <button onclick="shareProduct('${p.id}')" class="w-10 h-10 rounded-full bg-stone-50 hover:bg-blue-50 text-stone-500 hover:text-blue-600 flex items-center justify-center transition-all shadow-sm border border-stone-100 shrink-0" title="مشاركة المنتج">
                                        <i data-lucide="share-2" size="20"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="flex text-yellow-400 text-sm">
                                        ${averageRating > 0 
                                            ? Array(Math.round(averageRating)).fill('<i data-lucide="star" class="fill-current w-4 h-4"></i>').join('') 
                                            : '<span class="text-stone-400 text-xs">لا توجد تقييمات</span>'}
                                    </div>
                                    <span class="text-stone-500 text-sm">(${totalReviews} تقييم)</span>
                                </div>
                            </div>
                            <div class="border-t border-b border-stone-100 py-4">
                                ${hasDiscount ? 
                                `<div class="flex items-end gap-3 mb-1">
                                    <span class="text-4xl font-bold text-red-600 font-serif">$${finalPrice}</span>
                                    <span class="text-xl text-stone-400 line-through mb-1">$${p.price}</span>
                                    <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded mb-2">خصم ${p.discount}%</span>
                                 </div>
                                 <p class="text-sm text-stone-500">شامل الضريبة</p>` 
                                : 
                                `<div class="flex items-baseline gap-2"><span class="text-3xl font-bold text-stone-900 font-serif">$${p.price}</span><span class="text-stone-500 text-sm">شامل الضريبة</span></div>`
                                }
                            </div>

                            <!-- VARIANTS SECTION (Kept here as it affects image) -->
                            ${p.variants && p.variants.length > 0 ? `
                            <div id="variants-section" class="space-y-3 pb-4 border-b border-stone-100">
                                <h3 class="font-bold text-stone-900 text-sm">الألوان المتاحة:</h3>
                                <div class="flex flex-wrap gap-3">
                                    ${p.variants.map(v => `
                                        <button 
                                            onclick="selectColor('${v.color}', '${v.image}')" 
                                            data-color="${v.color}"
                                            class="variant-btn group relative w-12 h-12 rounded-full border border-stone-200 overflow-hidden hover:scale-110 transition-all focus:outline-none"
                                            title="${v.color}"
                                        >
                                            <img src="${v.image}" class="w-full h-full object-cover">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-[10px] text-stone-400"><i data-lucide="info" size="10" class="inline"></i> اختر اللون لمشاهدة صورته وإضافته للسلة</p>
                            </div>
                            ` : ''}
                            
                            <!-- Dynamic Service Icons Slider -->
                            <div class="mt-2 py-4">
                                <div class="flex gap-4 overflow-x-auto scrollbar-hide px-1 snap-x">
                                    ${(p.services && p.services.length > 0 ? p.services : []).map(s => `
                                    <div class="min-w-[80px] w-[80px] flex flex-col items-center text-center gap-2 snap-start group cursor-default">
                                        <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 group-hover:bg-stone-200 transition-colors">
                                            <i data-lucide="${s.icon}" size="20"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-stone-500 leading-tight">${s.text.replace(/ /g, '<br>')}</span>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Report Issue Link (WhatsApp) -->
                            <div class="mt-2">
                                <a href="https://wa.me/201014175070?text=${encodeURIComponent('مرحباً، أريد الإبلاغ عن مشكلة بخصوص المنتج: ' + p.name)}" target="_blank" class="flex items-center gap-2 text-stone-400 hover:text-red-600 text-xs font-medium transition-colors w-fit p-2 rounded-lg hover:bg-stone-50">
                                    <i data-lucide="flag" size="14"></i>
                                    <span>أبلغ عن مشكلة</span>
                                </a>
                            </div>

                        </div>

                        <!-- Action Card -->
                        <div class="lg:col-span-3">
                            <div class="border border-stone-200 rounded-xl p-5 shadow-sm sticky top-24 bg-white">
                                <div class="mb-4">
                                    ${hasDiscount 
                                        ? `<span class="text-2xl font-bold text-red-600">$${finalPrice}</span> <span class="text-sm text-stone-400 line-through">$${p.price}</span>` 
                                        : `<span class="text-2xl font-bold text-stone-900">$${p.price}</span>`
                                    }
                                </div>
                                <div class="text-sm mb-6">
                                    <p class="text-green-600 font-medium mb-1">متوفر في المخزون</p>
                                    <p class="text-stone-500">يصلك خلال: <span class="text-stone-900 font-bold">2-4 أيام عمل</span></p>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between border border-stone-200 rounded-lg p-2 bg-stone-50">
                                        <span class="text-sm font-bold text-stone-600 px-2">الكمية:</span>
                                        <div class="flex items-center gap-4">
                                            <button onclick="changeDetailsQuantity(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">-</button>
                                            <span id="details-qty" class="font-bold w-4 text-center">${detailsQuantity}</span>
                                            <button onclick="changeDetailsQuantity(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">+</button>
                                        </div>
                                    </div>
                                    <button onclick="addToCartFromDetails('${p.id}')" class="w-full bg-yellow-400 hover:bg-yellow-500 text-stone-900 py-3 rounded-full font-bold shadow-sm transition-colors text-sm">إضافة إلى عربة التسوق</button>
                                    <button onclick="addToCartFromDetails('${p.id}'); checkout()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-full font-bold shadow-sm transition-colors text-sm">شراء الآن</button>
                                </div>

                                <!-- 1️⃣ Trust Signals (Social Proof) -->
                                ${trustCounterHTML}

                                <!-- Sponsored Product Ad -->
                                ${(() => {
                                    // Pick a random product for ad
                                    const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
                                    if (!adProduct) return '';
                                    
                                    return `
                                    <div class="mt-6 pt-4 border-t border-stone-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">منتج ممول</span>
                                            <i data-lucide="info" size="10" class="text-stone-300"></i>
                                        </div>
                                        <div class="border border-stone-200 rounded-xl p-2 bg-stone-50 hover:bg-white hover:border-stone-400 transition-all cursor-pointer group flex gap-3 items-center" onclick="viewProduct('${adProduct.id}')">
                                            <div class="w-14 h-14 bg-white rounded-lg overflow-hidden shrink-0 border border-stone-100">
                                                <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-bold text-stone-900 text-xs truncate mb-1">${adProduct.name}</h4>
                                                <div class="flex justify-between items-center">
                                                    <span class="font-serif font-bold text-stone-900 text-sm">$${adProduct.price}</span>
                                                    <span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded-full">عرض</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                })()}

                                <!-- "Customers usually keep this item" Box -->
                                <div class="mt-4 bg-green-50 border border-green-600 rounded-xl p-4 flex items-start justify-between gap-4 shadow-sm">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-stone-900 text-xs mb-1">عادة ما يحتفظ العملاء بهذه السلعة</h4>
                                        <p class="text-[10px] text-stone-700 leading-relaxed">يتمتع هذا المنتج بمعدلات إرجاع أقل من المتوسط.</p>
                                    </div>
                                    <div class="bg-green-600 rounded-full p-1 text-white shrink-0 shadow-sm">
                                        <i data-lucide="check" size="14" stroke-width="3"></i>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- NEW: Detailed Info Section (Bottom Layout like Amazon) -->
                    <div class="grid md:grid-cols-2 gap-8 mb-16 items-start mt-12 border-t border-stone-100 pt-12">
                        <!-- About Item -->
                        <div class="h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-stone-100 p-2 rounded-lg"><i data-lucide="file-text" class="text-stone-600" size="20"></i></span>
                                عن السلعة
                            </h3>
                            ${(() => {
                                // Calculate content length (items)
                                const materialLine = p.material ? 1 : 0;
                                const featureLines = features.length;
                                const descLines = 1;
                                const totalLines = materialLine + featureLines + descLines;
                                const isLong = totalLines > 3;

                                return `
                                <div id="about-container-${p.id}" class="relative overflow-hidden transition-all duration-500 ${isLong ? 'max-h-[300px]' : ''}">
                                    <ul class="list-disc list-outside mr-5 space-y-3 text-stone-700 leading-relaxed">
                                        ${p.material ? `<li class="font-bold text-stone-900">المادة: <span class="font-normal text-stone-700">${p.material}</span></li>` : ''}
                                        ${features.map(f => `<li>${f}</li>`).join('')}
                                        <li>${p.description || p.details}</li>
                                    </ul>
                                    ${isLong ? `<div id="about-fade-${p.id}" class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-white to-transparent"></div>` : ''}
                                </div>
                                ${isLong ? `
                                <button id="about-btn-${p.id}" onclick="toggleAbout('${p.id}')" class="text-stone-900 font-bold text-sm hover:text-orange-600 underline underline-offset-4 flex items-center gap-1 mt-4 transition-colors">
                                    <i data-lucide="chevron-down" size="16"></i> قراءة المزيد
                                </button>` : ''}
                                `;
                            })()}
                        </div>

                        <!-- Specs Section -->
                        <div class="bg-stone-50 rounded-3xl p-8 border border-stone-100 h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-white p-2 rounded-lg border border-stone-200"><i data-lucide="settings-2" class="text-stone-600" size="20"></i></span>
                                المواصفات الفنية
                            </h3>
                            ${p.specifications && p.specifications.length > 0 ? `
                            <div class="space-y-0 divide-y divide-stone-200">
                                ${p.specifications.map(s => `
                                    <div class="flex justify-between items-center py-4 px-2">
                                        <span class="font-bold text-stone-600 text-sm">${s.label}</span>
                                        <span class="text-stone-900 dir-ltr text-sm font-bold">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : `<p class="text-stone-400 text-sm">لا توجد مواصفات إضافية.</p>`}
                        </div>
                    </div>

                    <!-- Related Products Slider -->
                    ${renderSliderHTML('related-slider-section', 'المنتجات المرتبطة بهذه السلعة', relatedProducts)}
                    
                    <!-- Random Suggestions Slider (Now Small like History) -->
                    ${renderSliderHTML('suggestions-slider-section', 'اقتراحات قد تعجبك', randomSuggestions, true)}

                    <!-- Reviews Section -->
                    <div class="mt-20 border-t border-stone-100 pt-12">
                        <div class="grid lg:grid-cols-12 gap-12">
                            <!-- Right: Rating Summary (Amazon Style) -->
                            <div class="lg:col-span-4">
                                <h3 class="text-2xl font-bold text-stone-900 mb-2">مراجعات المستخدمين</h3>
                                <div class="flex items-baseline gap-2 mb-4">
                                    <div class="flex text-yellow-400 text-lg">${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-5 h-5 ${i < Math.round(averageRating) ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}</div>
                                    <span class="text-lg font-bold text-stone-900 dir-ltr">${averageRating} من 5</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-6">${totalReviews} من التقييمات العالمية</p>
                                
                                <div class="space-y-3 mb-8">
                                    ${[5,4,3,2,1].map(star => {
                                        const count = counts[star];
                                        const percent = totalReviews > 0 ? Math.round((count / totalReviews) * 100) : 0;
                                        return `
                                        <div class="flex items-center gap-3 text-sm group cursor-default hover:opacity-80 transition-opacity">
                                            <span class="w-12 text-blue-600 font-medium hover:underline text-left dir-ltr">${star} نجوم</span>
                                            <div class="flex-1 h-5 bg-stone-100 rounded-sm overflow-hidden border border-stone-200 box-border">
                                                <div class="h-full bg-yellow-400 border-r border-yellow-500" style="width: ${percent}%"></div>
                                            </div>
                                            <span class="w-8 text-blue-600 font-medium text-right dir-ltr">${percent}%</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="border-t border-stone-200 pt-6">
                                    <h4 class="font-bold text-lg mb-2">راجع هذا المنتج</h4>
                                    <p class="text-sm text-stone-500 mb-4">شارك أفكارك مع العملاء الآخرين</p>
                                    <button onclick="document.getElementById('review-form').classList.toggle('hidden')" class="w-full border border-stone-300 text-stone-900 py-2 rounded-lg text-sm font-bold hover:bg-stone-50 transition-colors">اكتب مراجعة للعميل</button>
                                    
                                    <form id="review-form" onsubmit="handleSubmitReview(event)" class="space-y-4 mt-4 hidden bg-stone-50 p-4 rounded-xl border border-stone-200">
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">التقييم العام</label>
                                            <div class="flex flex-row-reverse justify-end gap-1 group/rating">
                                                ${[5,4,3,2,1].map(val => `
                                                    <input type="radio" name="reviewerRating" value="${val}" id="star${val}" class="peer hidden" ${val===5?'checked':''}>
                                                    <label for="star${val}" class="cursor-pointer text-stone-300 peer-checked:text-yellow-400 hover:text-yellow-400 peer-hover:text-yellow-400 transition-colors"><i data-lucide="star" class="fill-current w-8 h-8"></i></label>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">الاسم</label>
                                            <input name="reviewerName" required class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="اسمك الكريم">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">أضف مراجعة مكتوبة</label>
                                            <textarea name="reviewerComment" required rows="3" class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="ما الذي أعجبك أو لم يعجبك؟ بماذا تنصح؟"></textarea>
                                        </div>
                                        <button class="w-full bg-stone-900 text-white py-2 rounded-lg text-sm font-bold hover:bg-stone-800 transition-colors shadow-md">إرسال</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Left: Reviews List -->
                            <div class="lg:col-span-8 space-y-6">
                                <h3 class="font-bold text-xl mb-4">أفضل المراجعات</h3>
                                ${productReviews.length > 0 ? productReviews.map(r => `
                                    <div class="flex gap-4 mb-6">
                                        <div class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center font-bold text-stone-600 text-lg flex-shrink-0">${r.userName.charAt(0)}</div>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-bold text-sm text-stone-900">${r.userName}</span>
                                            </div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="flex text-yellow-400 text-xs">
                                                    ${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-4 h-4 ${i < r.rating ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}
                                                </div>
                                                ${r.verified ? `<span class="text-xs font-bold text-orange-600">تم الشراء (Verified Purchase)</span>` : ''}
                                            </div>
                                            <p class="text-xs text-stone-400 mb-2">تمت المراجعة في ${new Date(r.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            <p class="text-stone-700 text-sm leading-relaxed font-medium mb-4">${r.comment}</p>
                                            <div class="flex gap-4 text-xs text-stone-500">
                                                <button class="border border-stone-200 px-4 py-1 rounded-full hover:bg-stone-50 transition-colors">مفيد</button>
                                                <button class="text-stone-400 hover:text-stone-600">إبلاغ</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="bg-stone-50 rounded-xl p-8 text-center border border-dashed border-stone-200">
                                        <p class="text-stone-500">لا توجد مراجعات حتى الآن.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- NEW: History Slider (Smaller Cards) -->
                    ${renderSliderHTML('history-slider-section', 'سجل التصفح الخاص بك', historyProducts, true)}

                    <!-- NEW: Popular Search Cloud (Dynamic) -->
                    <div class="mt-16 border-t border-stone-100 pt-10 pb-8">
                         <div class="flex justify-between items-end mb-6">
                            <h3 class="text-xl font-bold text-stone-900">البحث الشائع</h3>
                         </div>
                         <div class="flex flex-wrap gap-2.5">
                            ${dynamicTags.length > 0 ? dynamicTags.map(tag => `
                                <button onclick="updateShopFilters('search', '${tag}'); setView('shop')" class="bg-stone-100 hover:bg-stone-200 text-stone-600 hover:text-stone-900 px-3 py-1.5 rounded-md text-xs md:text-sm font-medium transition-colors border border-transparent hover:border-stone-300">
                                    ${tag}
                                </button>
                            `).join('') : '<p class="text-sm text-stone-400">لا توجد كلمات بحث شائعة حالياً.</p>'}
                         </div>
                    </div>

                </div>
            </div>`;
        }
        
        // --- Helper Function: Create Small Product Card ---
        function createSmallProductCard(p) {
            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            
            return `
            <div class="group flex flex-col gap-2 cursor-pointer h-full" onclick="viewProduct('${p.id}')">
                <div class="relative aspect-square bg-white border border-stone-100 rounded-[1.5rem] overflow-hidden group-hover:shadow-md transition-all duration-300">
                    <!-- Brand Badge -->
                    <div class="absolute top-2 right-2 z-10">
                        <span class="bg-[#00796B] text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-sm">${p.brand || 'منتج'}</span>
                    </div>

                    <!-- Image -->
                    <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">
                    
                    <!-- Add Button -->
                    <div class="absolute bottom-2 left-0 w-full px-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-white text-stone-900 text-[10px] font-bold py-2 rounded-full shadow-lg hover:bg-stone-50">
                            أضف
                        </button>
                    </div>
                </div>
                
                <div class="px-1 text-right">
                    <h3 class="text-stone-800 font-bold text-xs leading-snug line-clamp-1 mb-1">${p.name}</h3>
                    <div class="flex items-center justify-end gap-2 dir-ltr">
                        <span class="text-[#00796B] text-sm font-bold">${Math.floor(finalPrice)} ج.م</span>
                    </div>
                </div>
            </div>`;
        }

        function createProductCard(p) {
            const isFav = favorites.includes(p.id);
            const isAdmin = user && user.email === ADMIN_EMAIL;
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            
            // Format Price
            const priceFormatted = Math.floor(finalPrice).toLocaleString();
            const originalPriceFormatted = Math.floor(p.price).toLocaleString();

            return `
            <div class="group flex flex-col gap-2 cursor-pointer h-full select-none" onclick="viewProduct('${p.id}')">
                <!-- Image Container -->
                <div class="relative aspect-[4/5] bg-white rounded-xl md:rounded-[2rem] overflow-hidden transition-all duration-300 group-hover:shadow-lg border border-stone-100 group-hover:border-stone-200">
                    
                    <!-- DISCOUNT BADGE -->
                    ${hasDiscount ? `
                    <div class="absolute top-1.5 right-1.5 md:top-3 md:right-3 z-30">
                        <div class="bg-red-600 text-white text-[8px] md:text-xs font-bold px-1.5 py-0.5 md:px-3 md:py-1.5 rounded md:rounded-lg shadow-md border border-white/20 flex items-center gap-1">
                            <span class="dir-ltr">-${p.discount}%</span>
                        </div>
                    </div>` : ''}

                    <!-- Brand Badge -->
                    <div class="absolute bottom-1 right-1 md:bottom-4 md:right-4 z-20 transition-opacity duration-300 group-hover:opacity-0 hidden md:block">
                        <span class="bg-white/80 backdrop-blur-md text-stone-700 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-stone-100/50">${p.brand || 'JEDAR'}</span>
                    </div>

                    <!-- Top Left: Floating Actions -->
                    <div class="absolute top-1.5 left-1.5 md:top-3 md:left-3 z-20 flex flex-col gap-1.5">
                        <!-- Favorite -->
                        <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="w-7 h-7 md:w-9 md:h-9 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-stone-900 shadow-sm hover:scale-110 transition-transform border border-stone-100 ${isFav ? 'text-red-500' : 'text-stone-400'}">
                            <i data-lucide="heart" size="14" class="md:w-[18px] md:h-[18px] ${isFav ? 'fill-current' : ''}"></i>
                        </button>

                        <!-- Admin Controls (تمت إعادتها وتصغيرها للموبايل) -->
                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); handleEditProduct('${p.id}')" class="w-7 h-7 md:w-9 md:h-9 bg-blue-50/90 text-blue-600 rounded-full flex items-center justify-center shadow-sm hover:bg-blue-600 hover:text-white transition-all border border-blue-100" title="تعديل"><i data-lucide="pen-line" size="14" class="md:w-4 md:h-4"></i></button>
                        <button onclick="event.stopPropagation(); handleDeleteProduct('${p.id}')" class="w-7 h-7 md:w-9 md:h-9 bg-red-50/90 text-red-600 rounded-full flex items-center justify-center shadow-sm hover:bg-red-600 hover:text-white transition-all border border-red-100" title="حذف"><i data-lucide="trash-2" size="14" class="md:w-4 md:h-4"></i></button>
                        ` : ''}
                    </div>

                    <!-- Product Image -->
                    <div class="absolute inset-0">
                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-in-out" loading="lazy" alt="${p.name}">
                    </div>

                    <!-- Add To Cart Button (Floating) - Hidden on Mobile to save space, appears on hover for desktop -->
                    <div class="hidden md:block absolute bottom-3 left-3 right-3 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 z-30">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-stone-900/90 backdrop-blur-sm text-white font-bold py-3 rounded-xl shadow-lg hover:bg-stone-900 transition-colors flex items-center justify-center gap-2 text-sm">
                            أضف إلى العربة
                        </button>
                    </div>
                    
                    <!-- Mobile Add Button (Visible Always or Bottom Right) -->
                    <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="md:hidden absolute bottom-1.5 left-1.5 w-7 h-7 bg-stone-900/90 text-white rounded-full flex items-center justify-center shadow-md z-30">
                        <i data-lucide="plus" size="14"></i>
                    </button>
                </div>

                <!-- Info Section -->
                <div class="px-1 md:px-2 text-right flex flex-col gap-0.5 md:gap-1">
                    <!-- Title -->
                    <h3 class="text-stone-800 font-bold text-[10px] md:text-sm leading-tight line-clamp-2 h-7 md:h-auto group-hover:text-[#00796B] transition-colors" title="${p.name}">${p.name}</h3>
                    
                    <!-- Price -->
                    <div class="flex items-center justify-end gap-1 md:gap-2 mt-0.5 dir-ltr flex-wrap">
                        <span class="text-[#00796B] text-xs md:text-lg font-bold">${priceFormatted} <span class="text-[8px] md:text-xs text-[#00796B]">ج.م</span></span>
                        ${hasDiscount ? `<span class="text-stone-400 text-[9px] md:text-xs line-through decoration-stone-400 decoration-1">${originalPriceFormatted}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // Start
        init();
    </script>
</body>
</html>