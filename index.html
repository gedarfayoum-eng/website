<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدار - للديكورات الحديثة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .group:hover .mega-menu { display: block; animation: slideDown 0.3s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        .gallery-thumb.active { border-color: #d97706; box-shadow: 0 0 0 1px #d97706; }
    </style>
</head>
<!-- تم إضافة flex و min-h-screen هنا لإصلاح مشكلة الجليتش -->
<body class="bg-white text-stone-900 selection:bg-stone-200 overflow-x-hidden flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-40 transition-all duration-300 py-6">
        <div class="container mx-auto px-6 flex justify-between items-center relative">
            <button class="md:hidden p-2" onclick="toggleMobileMenu()"><i data-lucide="menu"></i></button>

            <!-- تم إضافة id="navbar-brand" هنا -->
            <div id="navbar-brand" onclick="setView('home')" class="cursor-pointer flex flex-col items-start leading-none group z-50 transition-all">
                <div class="text-2xl font-bold tracking-tight flex items-center gap-1">جدار<span class="text-stone-400 text-4xl leading-3">.</span></div>
                <span class="text-[0.65rem] text-stone-500 font-medium mt-1 tracking-wide">للديكورات الحديثة</span>
            </div>

            <div class="hidden md:flex gap-8 items-center h-full">
                <button onclick="setView('home')" class="nav-link hover:text-stone-500 transition-colors">الرئيسية</button>
                
                <div class="group h-full flex items-center">
                    <button onclick="setView('categories')" class="nav-link hover:text-stone-500 transition-colors py-2 flex items-center gap-1 group-hover:text-stone-900">الأقسام <i data-lucide="chevron-down" size="14" class="group-hover:rotate-180 transition-transform duration-300"></i></button>
                    
                    <!-- Modern Mega Menu -->
                    <div class="mega-menu hidden absolute top-full left-0 w-full bg-white/95 backdrop-blur-2xl shadow-[0_30px_60px_-15px_rgba(0,0,0,0.1)] border-t border-stone-100 z-40 mt-0 transition-all duration-300">
                        <div class="container mx-auto p-8">
                            <div class="flex gap-12">
                                <!-- Sidebar: Categories List -->
                                <div class="w-1/4 flex flex-col justify-between border-l border-stone-100 pl-8 min-h-[300px]">
                                    <div>
                                        <h3 class="font-bold text-lg text-stone-900 flex items-center gap-3 mb-6">
                                            <span class="w-8 h-8 rounded-lg bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="grid" size="18"></i></span>
                                            تصفح الأقسام
                                        </h3>
                                        <ul class="space-y-1" id="mega-menu-categories-list">
                                            <!-- Dynamic List -->
                                        </ul>
                                    </div>
                                    
                                    <button onclick="viewAllProducts()" class="mt-6 w-full py-3.5 rounded-xl bg-stone-900 text-white font-bold text-sm hover:bg-stone-800 transition-all flex items-center justify-center gap-2 shadow-lg shadow-stone-200 group/btn">
                                        عرض كل المنتجات <i data-lucide="arrow-left" size="16" class="group-hover/btn:-translate-x-1 transition-transform"></i>
                                    </button>
                                </div>

                                <!-- Main Content: Featured Categories Grid -->
                                <div class="w-3/4">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="font-bold text-stone-400 text-xs uppercase tracking-widest">أقسام مختارة</h3>
                                        <a href="#/categories" onclick="setView('categories')" class="text-xs font-bold text-stone-900 hover:text-blue-600 transition-colors flex items-center gap-1">عرض الكل <i data-lucide="arrow-left" size="12"></i></a>
                                    </div>
                                    <!-- UPDATED: grid-cols-4 and gap-4 -->
                                    <div id="mega-menu-popular-list" class="grid grid-cols-4 gap-4 h-full">
                                        <!-- Dynamic Cards -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="setView('offers')" class="nav-link hover:text-red-600 transition-colors font-bold text-red-500 flex items-center gap-1"><i data-lucide="flame" size="16"></i> العروض</button>
                <button onclick="setView('shop')" class="nav-link hover:text-stone-500 transition-colors">التسوق</button>
                <button onclick="setView('track-order')" class="nav-link hover:text-stone-500 transition-colors flex items-center gap-1 text-green-600 font-medium"><i data-lucide="package-search" size="16"></i> تتبع طلبك</button>
                <button onclick="setView('contact')" class="nav-link hover:text-stone-500 transition-colors">تواصل معنا</button>
            </div>

            <div class="flex items-center gap-1 z-50">
                <!-- Smart Search Bar -->
                <div id="top-search-wrapper" class="relative hidden md:block ml-1">
                    <div id="top-search-bar" class="flex items-center bg-stone-50 rounded-full w-10 h-10 transition-all duration-300 ease-out overflow-hidden border border-transparent cursor-pointer hover:bg-stone-100" onclick="toggleTopSearch(event)">
                        <button class="w-10 h-10 flex items-center justify-center text-stone-600 hover:text-stone-900 shrink-0">
                            <i data-lucide="search" size="20"></i>
                        </button>
                        <input 
                            id="top-search-input" 
                            type="text" 
                            class="w-full h-full bg-transparent border-none outline-none text-sm px-2 text-stone-700 opacity-0 transition-opacity duration-200" 
                            placeholder="ابحث عن منتج..."
                            onkeydown="handleGlobalSearch(event)"
                            onclick="event.stopPropagation()" 
                            autocomplete="off"
                        >
                    </div>
                </div>

                <!-- Favorites Button (Updated Action) -->
                <button onclick="setView('favorites')" class="relative p-2 hover:bg-stone-100 rounded-full hidden sm:block text-stone-600 hover:text-stone-900 transition-colors" title="المفضلة">
                    <i data-lucide="heart"></i>
                    <span id="fav-badge" class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full hidden shadow-sm border border-white"></span>
                </button>
                
                <!-- User Icon Logic -->
                <div class="relative group/user" id="user-menu-container">
                    <!-- Injected via JS based on auth state -->
                </div>

                <button onclick="toggleCart(true)" class="relative p-2 hover:bg-stone-100 rounded-full"><i data-lucide="shopping-bag"></i><span id="cart-badge" class="absolute top-0 right-0 h-5 w-5 bg-stone-900 text-white text-xs flex items-center justify-center rounded-full hidden">0</span></button>
            </div>
        </div>

        <div id="mobile-menu" class="absolute top-full left-0 w-full bg-white shadow-lg hidden flex-col border-t border-stone-100 h-screen overflow-y-auto pb-20">
            <div id="mobile-user-section" class="p-4 bg-stone-50 mb-2">
                <!-- Mobile User Info Injected Here -->
            </div>
            <button onclick="setView('home'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">الرئيسية</button>
            <div class="border-b border-stone-50">
                <button onclick="document.getElementById('mobile-cats').classList.toggle('hidden')" class="w-full py-4 text-center hover:bg-stone-50 flex items-center justify-center gap-2">الأقسام <i data-lucide="chevron-down" size="14"></i></button>
                <div id="mobile-cats" class="hidden bg-stone-50 py-2"><div id="mobile-cats-list"></div></div>
            </div>
            <button onclick="setView('offers'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50 font-bold text-red-500">العروض والخصومات</button>
            <button onclick="setView('shop'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">التسوق</button>
            <button onclick="setView('track-order'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50 text-green-600 font-bold">تتبع طلبك</button>
            <button onclick="setView('about'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">من نحن</button>
            <button onclick="setView('contact'); toggleMobileMenu()" class="py-4 text-center hover:bg-stone-50 border-b border-stone-50">تواصل معنا</button>
            <div class="flex justify-center gap-6 py-6 mt-auto" id="mobile-admin-link">
                <!-- Admin link injected here if admin -->
            </div>
        </div>
    </nav>

    <!-- NEW LOCATION: Header Banner (Below Fixed Nav) -->
    <!-- mt-[88px] ensures it starts after the fixed navbar -->
    <div id="header-banner-container" class="w-full z-30 transition-all duration-300 hidden mt-[88px]"></div>

    <!-- تم إضافة flex-grow هنا لدفع الـ Footer للأسفل دائماً -->
    <main id="main-content" class="flex-grow"></main>

    <!-- Drawers & Modals -->
    <div id="cart-drawer-backdrop" onclick="toggleCart(false)" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="cart-drawer" class="fixed top-0 left-0 h-full w-full sm:w-[450px] bg-white z-50 shadow-2xl transform -translate-x-full transition-transform duration-500 cubic-bezier(0.4, 0, 0.2, 1) flex flex-col border-r border-stone-100">
        <!-- Modern Header -->
        <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-white z-10">
            <div>
                <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2">عربة التسوق</h2>
                <p class="text-xs text-stone-500 mt-1">راجع طلباتك قبل الدفع</p>
            </div>
            <button onclick="toggleCart(false)" class="w-10 h-10 bg-stone-50 hover:bg-stone-100 rounded-full flex items-center justify-center transition-colors text-stone-500 hover:text-stone-900"><i data-lucide="x" size="20"></i></button>
        </div>
        
        <!-- Items Container -->
        <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-5 bg-stone-50/30 custom-scrollbar"></div>
        
        <!-- Modern Footer -->
        <div id="cart-footer" class="p-6 border-t border-stone-100 bg-white space-y-4 hidden z-10 shadow-[0_-10px_60px_-15px_rgba(0,0,0,0.1)]">
            <div class="space-y-3">
                <div class="flex justify-between items-center text-sm font-medium text-stone-500"><span>عدد المنتجات</span><span id="cart-count-summary" class="font-bold text-stone-900 bg-stone-100 px-2 py-0.5 rounded text-xs">0</span></div>
                <div class="flex justify-between items-center">
                    <span class="text-lg font-bold text-stone-900">الإجمالي</span>
                    <span id="cart-total" class="text-2xl font-serif font-bold text-stone-900">$0.00</span>
                </div>
                <p class="text-[10px] text-stone-400 text-center bg-stone-50 p-2 rounded-lg border border-stone-100"><i data-lucide="info" size="10" class="inline mb-0.5"></i> الشحن والضرائب تحسب عند إتمام الطلب</p>
            </div>
            <button onclick="checkout()" class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-3 group text-lg">
                <span>إتمام الشراء</span>
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:translate-x-1 transition-transform">
                    <i data-lucide="arrow-left" size="18"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- REMOVED OLD FAVORITE DRAWER -->

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 transition-all duration-500 translate-y-12 opacity-0 pointer-events-none bg-stone-900 text-white px-6 py-3 rounded shadow-lg text-sm font-medium"></div>

    <!-- Checkout Modal -->
    <div id="checkout-modal-backdrop" onclick="toggleCheckoutModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="checkout-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white rounded-3xl shadow-2xl z-50 opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="shopping-bag" class="text-stone-900"></i> إتمام الطلب</h2>
            <button onclick="toggleCheckoutModal(false)" class="text-stone-400 hover:text-red-500 transition-colors p-1 bg-stone-50 rounded-full"><i data-lucide="x"></i></button>
        </div>
        
        <form onsubmit="handlePlaceOrder(event)" class="space-y-5">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">الاسم بالكامل</label>
                    <div class="relative">
                        <input name="customerName" required class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400" placeholder="الاسم ثلاثي">
                        <i data-lucide="user" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم الهاتف</label>
                    <div class="relative">
                        <input name="customerPhone" type="tel" required class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400" placeholder="01xxxxxxxxx">
                        <i data-lucide="phone" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">العنوان بالتفصيل</label>
                    <div class="relative">
                        <textarea id="checkout-address" name="customerAddress" oninput="calculateCheckoutTotal()" required rows="2" class="w-full border border-stone-200 p-3.5 pl-10 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none bg-stone-50 focus:bg-white transition-all text-sm font-medium placeholder:text-stone-400 resize-none" placeholder="المحافظة - المدينة - الشارع - رقم المنزل"></textarea>
                        <i data-lucide="map-pin" class="absolute left-3.5 top-3.5 text-stone-400" size="18"></i>
                    </div>
                </div>
                
                <!-- Delivery Checkbox -->
                <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 flex items-center gap-3">
                    <input type="checkbox" id="delivery-check" onchange="calculateCheckoutTotal()" class="w-5 h-5 accent-stone-900 rounded cursor-pointer">
                    <label for="delivery-check" class="text-sm font-bold text-stone-700 cursor-pointer select-none">أريد توصيل الطلب إلى عنواني</label>
                </div>
            </div>
            
            <div class="bg-stone-50 p-5 rounded-2xl border border-stone-100 flex items-center justify-between">
                <div>
                    <p class="text-xs text-stone-500 font-bold mb-1">إجمالي المبلغ المطلوب</p>
                    <p id="delivery-note" class="text-[10px] text-blue-600 font-bold hidden"></p>
                </div>
                <div class="text-right">
                    <span id="checkout-total-display" class="block text-2xl font-serif font-bold text-stone-900">$0.00</span>
                    <span class="inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">دفع عند الاستلام</span>
                </div>
            </div>

            <button type="submit" class="w-full bg-stone-900 text-white py-4 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2 group">
                <span>تأكيد وإرسال الطلب</span>
                <i data-lucide="arrow-left" class="group-hover:-translate-x-1 transition-transform"></i>
            </button>
        </form>
    </div>

    <!-- Edit Order Modal (NEW) -->
    <div id="edit-order-modal-backdrop" onclick="toggleEditOrderModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="edit-order-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
            <h2 class="text-2xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="pen-line" class="text-blue-600"></i> تعديل الطلب</h2>
            <button onclick="toggleEditOrderModal(false)" class="text-stone-400 hover:text-red-500 transition-colors p-1 bg-stone-50 rounded-full"><i data-lucide="x"></i></button>
        </div>
        
        <form onsubmit="handleUpdateOrder(event)" id="edit-order-form" class="space-y-5">
            <input type="hidden" name="orderId">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">اسم العميل</label>
                    <input name="customerName" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">رقم الهاتف</label>
                    <input name="customerPhone" required class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 mb-1.5 uppercase tracking-wider">العنوان</label>
                    <textarea name="customerAddress" required rows="2" class="w-full border border-stone-200 p-3 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white transition-colors"></textarea>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                     <label class="block text-xs font-bold text-blue-800 mb-1.5 uppercase tracking-wider">الإجمالي (تعديل يدوي)</label>
                     <div class="relative">
                        <input name="totalAmount" type="number" step="0.01" required class="w-full border border-blue-200 p-3 pl-8 rounded-xl focus:ring-2 focus:ring-blue-600 outline-none bg-white font-bold text-stone-900">
                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">$</span>
                     </div>
                     <p class="text-[10px] text-blue-600 mt-2">تنبيه: تغيير هذا الرقم لا يؤثر على أسعار المنتجات الفردية، بل يغير إجمالي الفاتورة فقط.</p>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg flex justify-center items-center gap-2">
                <i data-lucide="save"></i> <span>حفظ التعديلات</span>
            </button>
        </form>
    </div>

    <!-- Order Success Modal (NEW) -->
    <div id="success-modal-backdrop" onclick="toggleSuccessModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="success-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-8 text-center">
        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm animate-bounce">
            <i data-lucide="check" size="40"></i>
        </div>
        <h2 class="text-2xl font-bold text-stone-900 mb-2">تم استلام طلبك بنجاح!</h2>
        <p class="text-stone-500 text-sm mb-6">شكراً لثقتك بنا. يرجى الاحتفاظ برقم الطلب لتتبع حالة الشحنة.</p>
        
        <div class="bg-stone-50 p-4 rounded-xl border border-stone-200 mb-6 relative group cursor-pointer hover:bg-stone-100 transition-colors" onclick="copyOrderId()">
            <p class="text-xs text-stone-400 font-bold uppercase tracking-wider mb-1">رقم الطلب (اضغط للنسخ)</p>
            <p id="success-order-id" class="text-xl font-mono font-bold text-stone-800 tracking-wider select-all">Loading...</p>
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 group-hover:text-stone-900 transition-colors">
                <i data-lucide="copy" size="20"></i>
            </div>
        </div>

        <button onclick="toggleSuccessModal(false); setView('track-order')" class="w-full bg-stone-900 text-white py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl mb-3 flex items-center justify-center gap-2">
            <i data-lucide="package-search" size="18"></i> تتبع حالة الطلب الآن
        </button>
        <button onclick="toggleSuccessModal(false)" class="w-full text-stone-500 font-bold py-2 hover:text-stone-900">
            متابعة التسوق
        </button>
    </div>

    <!-- Request Modification Modal (NEW Feature) -->
    <div id="mod-modal-backdrop" onclick="toggleModModal(false)" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="mod-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white rounded-3xl shadow-2xl z-[60] opacity-0 pointer-events-none transition-all duration-300 scale-95 p-6">
        <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-3">
            <h3 class="text-xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="edit-3" class="text-orange-500"></i> طلب تعديل</h3>
            <button onclick="toggleModModal(false)"><i data-lucide="x" class="text-stone-400 hover:text-stone-900"></i></button>
        </div>
        <form onsubmit="handleSubmitModRequest(event)">
            <input type="hidden" name="orderId" id="mod-order-id">
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-4 text-xs text-blue-700 leading-relaxed">
                <i data-lucide="info" size="14" class="inline mb-0.5"></i> يرجى كتابة التعديلات المطلوبة بوضوح (مثلاً: تغيير العنوان، تغيير رقم الهاتف، إلغاء منتج). سيقوم فريقنا بمراجعة الطلب وتنفيذه إن أمكن.
            </div>
            <textarea name="message" required rows="4" class="w-full border border-stone-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-stone-900 outline-none mb-4 bg-stone-50 focus:bg-white transition-all placeholder:text-stone-400" placeholder="اكتب تفاصيل التعديل هنا..."></textarea>
            <button type="submit" class="w-full bg-stone-900 text-white py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg">إرسال الطلب للإدارة</button>
        </form>
    </div>

    <!-- Modern Light Footer -->
    <footer class="bg-stone-50 text-stone-600 py-16 mt-auto border-t border-stone-200 font-light relative overflow-hidden">
        <!-- Background Elements (Light Theme) -->
        <div class="absolute top-0 right-0 w-96 h-96 bg-stone-200/40 rounded-full blur-3xl -mr-40 -mt-40 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-stone-200/40 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none"></div>

        <div class="container mx-auto px-6 relative z-10">
            <!-- Newsletter Section (Light) -->
            <div class="flex flex-col md:flex-row justify-between items-center bg-white p-8 rounded-3xl mb-16 border border-stone-200 shadow-sm">
                <div class="mb-6 md:mb-0 md:w-1/2">
                    <h3 class="text-stone-900 text-2xl font-bold mb-2 flex items-center gap-2"><i data-lucide="mail" class="text-stone-400"></i> انضم لنشرتنا البريدية</h3>
                    <p class="text-stone-500 text-sm">كن أول من يعرف عن العروض الحصرية والمنتجات الجديدة.</p>
                </div>
                <div class="w-full md:w-1/2 flex gap-2">
                    <input type="email" placeholder="بريدك الإلكتروني" class="w-full bg-stone-50 border border-stone-200 text-stone-900 px-5 py-3.5 rounded-xl focus:outline-none focus:border-stone-400 transition-colors placeholder:text-stone-400">
                    <button class="bg-stone-900 text-white px-6 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-colors whitespace-nowrap shadow-lg hover:shadow-xl hover:-translate-y-0.5 transform">اشترك</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 lg:gap-8 mb-16 border-b border-stone-200 pb-12">
                <!-- Brand Info -->
                <div class="space-y-6">
                    <!-- تم إضافة id="footer-brand" هنا -->
                    <div id="footer-brand">
                        <div class="text-3xl font-bold text-stone-900 tracking-tighter flex items-center gap-1">جدار<span class="text-stone-400 text-5xl leading-3">.</span></div>
                    </div>
                    <p class="text-sm leading-relaxed max-w-xs text-stone-500">
                        نحول مساحتك العادية إلى تحفة فنية. وجهتك الأولى لأحدث صيحات الديكور وتجاليد الحوائط في مصر بجودة لا تضاهى.
                    </p>
                    <div class="flex gap-3">
                        <a href="https://www.facebook.com/gedar.fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#1877F2] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#1877F2] text-stone-500">
                            <i data-lucide="facebook" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://www.instagram.com/gedar_fayoum" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#E4405F] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#E4405F] text-stone-500">
                            <i data-lucide="instagram" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                        <a href="https://wa.me/201014175070" target="_blank" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-[#25D366] hover:text-white transition-all duration-300 group shadow-sm border border-stone-200 hover:border-[#25D366] text-stone-500">
                            <i data-lucide="message-circle" size="18" class="group-hover:scale-110 transition-transform"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">التسوق</h4>
                    <ul class="space-y-4 text-sm">
                        <li><button onclick="setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> كل المنتجات</button></li>
                        <li><button onclick="filterCategory('بديل الخشب'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> بديل الخشب</button></li>
                        <li><button onclick="filterCategory('بديل الرخام'); setView('shop')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> بديل الرخام</button></li>
                        <li><button onclick="setView('offers')" class="hover:text-stone-900 transition-colors flex items-center gap-2 group w-full text-right"><i data-lucide="chevron-left" size="14" class="opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0 text-stone-400"></i> العروض والخصومات</button></li>
                    </ul>
                </div>

                <!-- Customer Support -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">خدمة العملاء</h4>
                    <ul class="space-y-4 text-sm">
                        <li><button onclick="setView('track-order')" class="hover:text-stone-900 transition-colors flex items-center gap-2 text-orange-600 font-bold group w-full text-right"><i data-lucide="package-search" size="16" class="group-hover:scale-110 transition-transform"></i> تتبع طلبك</button></li>
                        <li><button onclick="setView('contact')" class="hover:text-stone-900 transition-colors w-full text-right">اتصل بنا</button></li>
                        <li><button onclick="setView('faq')" class="hover:text-stone-900 transition-colors w-full text-right">الأسئلة الشائعة</button></li>
                        <li><button onclick="setView('return-policy')" class="hover:text-stone-900 transition-colors w-full text-right">سياسة الاسترجاع</button></li>
                    </ul>
                </div>

                <!-- Contact Details -->
                <div>
                    <h4 class="text-stone-900 font-bold text-lg mb-6 relative w-fit after:content-[''] after:absolute after:-bottom-2 after:right-0 after:w-1/2 after:h-0.5 after:bg-stone-300">معلومات التواصل</h4>
                    <ul class="space-y-6 text-sm">
                        <li class="flex items-start gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-500 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="map-pin" size="18"></i>
                            </div>
                            <span class="mt-1 leading-relaxed">الفيوم - نهاية شارع المستشفي العام إتجاه مديرية الأمن<br/><span class="text-stone-400 text-xs">بجوار المغسلة الامريكيه وامام مطعم ابو صلاح</span></span>
                        </li>
                        <li class="flex items-center gap-4 group">
                            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 group-hover:bg-stone-100 transition-colors text-stone-500 group-hover:text-stone-900 border border-stone-200 shadow-sm">
                                <i data-lucide="phone" size="18"></i>
                            </div>
                            <div class="flex flex-col">
                                <a href="tel:+201014175070" class="dir-ltr font-mono text-lg text-stone-900 font-bold tracking-wide hover:text-blue-600 transition-colors" title="اتصال هاتفي">01014175070</a>
                                <a href="https://wa.me/201014175070" target="_blank" class="text-[11px] font-bold text-green-600 hover:text-green-700 flex items-center gap-1 transition-colors">
                                    <i data-lucide="message-circle" size="12"></i> تواصل عبر واتساب
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 text-xs text-stone-500 border-t border-stone-200 pt-8">
                <p>&copy; 2024 متجر جدار للديكور. جميع الحقوق محفوظة.</p>
                
                <!-- Payment Methods Logos (Updated Image Size - Slightly Smaller) -->
                <div class="grayscale hover:grayscale-0 transition-all duration-500 opacity-80 hover:opacity-100">
                    <!-- تم تقليل الارتفاع قليلاً من h-20 md:h-32 إلى h-16 md:h-24 -->
                    <img src="https://www.abaqperfume.com/cdn/shop/files/e1U1c1LAEdAcgnmxYmwwqqmy4hHGZ7CJ8DpQIKXy_d883f005-45c0-4330-acf8-5ea9610acc15.png?v=1713207436&width=1100" class="h-16 md:h-24 w-auto object-contain" alt="طرق الدفع المتاحة">
                </div>
            </div>
        </div>
    </footer>

    <!-- REMOVED: Bottom Banner Container was here -->

    <!-- Firebase & Main Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Admin Configuration
        const ADMIN_EMAIL = 'gedar.fayoum@gmail.com';
        
        // Delivery Configuration
        const DELIVERY_AREAS = [
            "العبودي", "الإصلاح الزراعي", "المسلة", "رفعت عزمي", 
            "النويرى", "المستشفي العام", "دلة", "موقف مصر"
        ];
        const FIXED_DELIVERY_FEE = 70;

        // Global State
        let db, auth, appId, user;
        let CATEGORIES = [];
        let PRODUCTS = [];
        let ALL_REVIEWS = []; 
        let ALL_ORDERS = []; // NEW: Store orders
        let cart = [];
        let favorites = [];
        let isDataLoaded = false; // NEW: To handle direct link loading state
        // NEW: Global interval for countdowns
        let countdownInterval = null;
        
        // NEW: Hero Settings State (Initialized Empty)
        let HERO_SETTINGS = {
            mainImage: "",
            secondaryImage: "",
            priceLabel: "",
            priceValue: "",
            discountLabel: "",
            discountValue: "",
            logoUrl: "",
            logoSize: "100",
            // Image Configuration (NEW)
            imageBaseUrl: "",
            imageDefaultExt: ".webp",
            // Footer/Header Banner Settings
            footerBannerUrl: "",
            footerBannerHeight: "200",
            footerBannerWidth: "100", 
            showFooterBanner: false,
            // Category Banner Settings
            categoryBannerUrl: "",
            categoryBannerHeight: "200",
            categoryBannerWidth: "100",
            showCategoryBanner: false,
            // NEW: Best Seller Banner Settings
            bestSellerBannerUrl: "",
            bestSellerBannerHeight: "200",
            bestSellerBannerWidth: "100",
            showBestSellerBanner: false,
            // NEW: Featured Banner Settings
            featuredBannerUrl: "",
            featuredBannerHeight: "200",
            featuredBannerWidth: "100",
            showFeaturedBanner: false,
            // Hero Visibility Settings
            showHeroMobile: true,
            showHeroDesktop: true
        };
        let currentView = 'home';
        let currentAdminTab = 'dashboard'; // متغير جديد لتحديد القسم النشط في لوحة التحكم
        let currentOrderTab = 'active'; 
        let currentProductId = null;
        let currentEditProduct = null;
        let currentEditCategoryName = null; // NEW: Track category being edited
        let shopState = { search: '', categories: [], priceMin: 0, priceMax: 10000, sort: 'featured' };
        let detailsQuantity = 1;
        let activeImageIndex = 0;
        let currentSelectedColor = null; // متغير جديد لتخزين اللون المختار

        // --- NEW: Helper to check if discount is valid ---
        function isDiscountActive(p) {
            if (!p.discount || p.discount <= 0) return false;
            // If no expiry is set, discount is always active (permanent)
            if (!p.discountExpiry) return true;
            // Check if current time is before expiry
            return p.discountExpiry > Date.now();
        }

        // --- Init ---
        async function init() {
            lucide.createIcons();
            
            const firebaseConfig = {
                apiKey: "AIzaSyAQoLRMCHjOW_jWHtuYppSLxzaYhPZUj40",
                authDomain: "gedarwebsitenew.firebaseapp.com",
                projectId: "gedarwebsitenew",
                storageBucket: "gedarwebsitenew.firebasestorage.app",
                messagingSenderId: "164355005674",
                appId: "1:164355005674:web:ce33a2b8694c2e9507cb93",
                measurementId: "G-8FPJKYQT4X"
            };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            onAuthStateChanged(auth, (u) => {
                // Security Check: Enforce Owner Only for Google Sign-In
                // If user is signed in (not anon) AND email doesn't match admin, force logout.
                if (u && !u.isAnonymous && u.email !== ADMIN_EMAIL) {
                    signOut(auth).then(() => {
                        showToast("عذراً، هذا الحساب غير مصرح له بالدخول. الدخول للمالك فقط.");
                    });
                    return;
                }

                user = u;
                updateUserUI();
                
                if (user) {
                    setupDataListeners();
                } else {
                    signInAnonymously(auth).catch(err => console.error("Anon Auth Error:", err));
                }
            });

            const savedFavs = localStorage.getItem('aura_favorites');
            if (savedFavs) try { favorites = JSON.parse(savedFavs); updateFavoritesUI(); } catch(e) {}

            // NEW: Load Cart from LocalStorage
            const savedCart = localStorage.getItem('gedar_cart');
            if (savedCart) try { cart = JSON.parse(savedCart); updateCartUI(); } catch(e) {}

            // NEW: Listen for URL changes (Back/Forward buttons)
            window.addEventListener('hashchange', handleRouting);
            
            // NEW: Handle initial URL on page load
            handleRouting();
            
            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                if (window.scrollY > 20) {
                    nav.classList.add('bg-white/90', 'backdrop-blur-md', 'shadow-sm', 'py-4');
                    nav.classList.remove('py-6');
                } else {
                    nav.classList.remove('bg-white/90', 'backdrop-blur-md', 'shadow-sm', 'py-4');
                    nav.classList.add('py-6');
                }
            });

            // Click outside to close search
            document.addEventListener('click', (e) => {
                const wrapper = document.getElementById('top-search-wrapper');
                if (wrapper && !wrapper.contains(e.target)) {
                    closeTopSearch();
                }
            });
        }

        function setupDataListeners() {
            const catDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store');
            onSnapshot(catDoc, (snap) => {
                if (snap.exists()) {
                    let cats = snap.data().categories || [];
                    // UPDATE: تصفية البيانات لإزالة أي قسم فاسد أو undefined
                    CATEGORIES = cats
                        .map(c => typeof c === 'string' ? { name: c, image: 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500' } : c)
                        .filter(c => c && c.name && c.name !== 'undefined' && c.name.trim() !== '');
                } else {
                    // Create empty metadata doc if not exists, but don't seed dummy data
                    setDoc(catDoc, { categories: [] });
                    CATEGORIES = [];
                }
                updateMegaMenu();
                if (currentView === 'shop' || currentView === 'categories' || currentView === 'admin') renderView();
            });

            const prodCol = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            onSnapshot(prodCol, (snap) => {
                // Completely removed default seeding logic
                // Now purely relies on what's in Firestore
                PRODUCTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                isDataLoaded = true; // Data is ready
                
                // Refresh view if we were waiting for data (e.g. direct product link)
                if (currentView === 'product-details' || currentView === 'home' || currentView === 'shop') renderView();
            });

            const reviewsCol = collection(db, 'artifacts', appId, 'public', 'data', 'reviews');
            onSnapshot(reviewsCol, (snap) => {
                ALL_REVIEWS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (currentView === 'product-details' || currentView === 'admin') renderView();
            });

            // NEW: Hero Settings Listener
            const heroDoc = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero');
            onSnapshot(heroDoc, (snap) => {
                if (snap.exists()) {
                    HERO_SETTINGS = snap.data();
                }
                // Update Branding Immediately
                updateGlobalBranding();
                
                // If on home or admin, re-render to show changes
                if (currentView === 'home' || currentView === 'admin') renderView();
            });

            // NEW: Orders Listener for Admin Only
            if (user && user.email === ADMIN_EMAIL) {
                const ordersCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                onSnapshot(ordersCol, (snap) => {
                    ALL_ORDERS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    ALL_ORDERS.sort((a, b) => b.createdAt - a.createdAt);
                    // تحديث العرض إذا كنا في صفحة الطلبات أو في لوحة التحكم بتبويب الطلبات
                    if (currentView === 'orders' || (currentView === 'admin' && currentAdminTab === 'orders')) renderView();
                });
            }
        }

        function updateUserUI() {
            const container = document.getElementById('user-menu-container');
            const mobileSection = document.getElementById('mobile-user-section');
            const mobileAdminLink = document.getElementById('mobile-admin-link');
            const isAnon = user ? user.isAnonymous : true;
            const isAdmin = user && user.email === ADMIN_EMAIL;

            if (isAnon) {
                container.innerHTML = `<button onclick="setView('login')" class="p-2 hover:bg-stone-100 rounded-full hidden sm:block transition-colors" title="تسجيل الدخول"><i data-lucide="user"></i></button>`;
                mobileSection.innerHTML = `<button onclick="setView('login'); toggleMobileMenu()" class="w-full text-center py-2 bg-stone-900 text-white rounded-xl">تسجيل الدخول</button>`;
                if(mobileAdminLink) mobileAdminLink.innerHTML = '';
            } else {
                const avatar = user.photoURL || '';
                const name = user.displayName || 'مستخدم';
                const email = user.email || '';

                // Modern User Dropdown Design
                container.innerHTML = `
                    <button class="flex items-center gap-2 p-1 pl-2 hover:bg-stone-100 rounded-full hidden sm:flex border border-transparent hover:border-stone-200 transition-all group-hover/user:bg-stone-50 group-hover/user:shadow-sm">
                        ${avatar ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow-sm">` : `<div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-600"><i data-lucide="user" size="16"></i></div>`}
                        <i data-lucide="chevron-down" size="14" class="text-stone-400 group-hover/user:text-stone-800 transition-colors"></i>
                    </button>
                    
                    <div class="absolute top-full left-0 mt-3 w-72 bg-white/95 backdrop-blur-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.15)] rounded-2xl border border-stone-100 overflow-hidden hidden group-hover/user:block z-50 p-2 transform origin-top-left transition-all animate-in fade-in slide-in-from-top-2 duration-200">
                        
                        <!-- Profile Header -->
                        <div class="p-4 mb-2 bg-stone-50/80 rounded-xl flex items-center gap-4 border border-stone-100">
                             ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full object-cover ring-4 ring-white shadow-sm">` : `<div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm text-stone-400"><i data-lucide="user" size="24"></i></div>`}
                            <div class="overflow-hidden">
                                <p class="font-bold text-stone-900 text-sm truncate">${name}</p>
                                <p class="text-[11px] text-stone-500 truncate font-medium">${email}</p>
                                ${isAdmin ? `<span class="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-full">المدير</span>` : `<span class="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full">عميل</span>`}
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <div class="space-y-1">
                            ${isAdmin ? `
                            <button onclick="setView('admin')" class="w-full text-right px-3 py-2.5 hover:bg-stone-50 rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i data-lucide="layout-dashboard" size="16"></i></div> لوحة التحكم</span>
                            </button>
                            ` : ''}
                            
                            <!-- تم تحديث الرابط هنا ليوجه لتبويب الطلبات داخل اللوحة -->
                            <button onclick="${isAdmin ? "setAdminView('orders')" : "showToast('قريباً...')"}" class="w-full text-right px-3 py-2.5 hover:bg-stone-50 rounded-xl text-sm font-bold text-stone-700 flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors"><i data-lucide="package" size="16"></i></div> طلبات العملاء</span>
                                ${isAdmin ? `<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full" id="orders-badge" ${ALL_ORDERS.length===0?'style="display:none"':''}>${ALL_ORDERS.filter(o=>!o.isArchived).length}</span>` : ''}
                            </button>
                            
                            <div class="h-px bg-stone-100 my-2 mx-2"></div>
                            
                            <button onclick="handleLogout()" class="w-full text-right px-3 py-2.5 hover:bg-red-50 text-stone-600 hover:text-red-600 rounded-xl text-sm font-bold flex items-center justify-between group transition-colors">
                                <span class="flex items-center gap-3"><div class="p-1.5 rounded-lg bg-stone-100 text-stone-500 group-hover:bg-red-100 group-hover:text-red-600 transition-colors"><i data-lucide="log-out" size="16"></i></div> تسجيل الخروج</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Mobile Section (Simpler version)
                mobileSection.innerHTML = `
                    <div class="flex items-center gap-3 mb-6 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                        ${avatar ? `<img src="${avatar}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">` : `<div class="w-12 h-12 bg-stone-200 rounded-full flex items-center justify-center"><i data-lucide="user"></i></div>`}
                        <div class="overflow-hidden">
                            <p class="font-bold text-lg text-stone-900">${name}</p>
                            <p class="text-xs text-stone-500 truncate">${email}</p>
                        </div>
                    </div>
                    <button onclick="handleLogout(); toggleMobileMenu()" class="w-full flex items-center justify-center gap-2 py-3 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 transition-colors">
                        <i data-lucide="log-out" size="18"></i> تسجيل الخروج
                    </button>
                `;

                if(isAdmin && mobileAdminLink) {
                    mobileAdminLink.innerHTML = `<button onclick="setView('admin'); toggleMobileMenu()" class="flex items-center gap-2 text-sm text-stone-600"><i data-lucide="settings" size="18"></i> الإدارة</button>`;
                } else if (mobileAdminLink) {
                    mobileAdminLink.innerHTML = '';
                }
            }
            lucide.createIcons();
        }

        // --- Exposed Logic ---
        
        // NEW: Routing Handler (Updated for Deep Linking)
        function handleRouting() {
            const hash = window.location.hash; 
            
            // If no hash or just #/, default to home
            if (!hash || hash === '#/' || hash === '#') {
                if(currentView !== 'home') {
                    setView('home');
                }
                return;
            }

            const path = hash.replace(/^#\//, ''); // remove #/
            const parts = path.split('/'); // split by /
            
            const route = parts[0];
            
            if (route === 'product' && parts[1]) {
                // Route: #/product/{id}
                currentProductId = parts[1];
                currentView = 'product-details';
            } else if (route === 'admin') {
                // Route: #/admin or #/admin/orders
                currentView = 'admin';
                if(parts[1]) currentAdminTab = parts[1];
                else currentAdminTab = 'dashboard';
            } else if (route) {
                // Generic Routes: #/shop, #/about, #/return-policy etc.
                currentView = route;
            } else {
                currentView = 'home';
            }
            
            // Clean up admin edit states if leaving admin
            if (currentView !== 'admin') {
                currentEditProduct = null;
                currentEditCategoryName = null;
            }

            renderView();
            window.scrollTo(0, 0);
        }

        window.setView = (view, param) => {
            // Clear any running countdowns when switching views
            if (countdownInterval) clearInterval(countdownInterval);

            currentView = view;
            
            if(view !== 'admin' && view !== 'orders') currentEditProduct = null;
            if(view === 'admin' && !currentAdminTab) currentAdminTab = 'dashboard';
            
            // UPDATE: URL Hash Logic (Smart URL Update)
            let targetHash = '/';
            
            if (view === 'home') {
                targetHash = '/';
            } else if (view === 'offers') {
                targetHash = '/offers';
            } else if (view === 'faq') { // NEW ROUTE
                targetHash = '/faq';
            } else if (view === 'product-details' && param) {
                targetHash = '/product/' + param;
                currentProductId = param; // Ensure ID is set
            } else if (view === 'admin') {
                targetHash = '/admin/' + (param || currentAdminTab || 'dashboard');
                if(param) currentAdminTab = param;
            } else {
                targetHash = '/' + view;
            }
            
            // NEW: Update URL Hash without triggering reload
            if (window.location.hash !== '#' + targetHash) {
                history.pushState(null, null, '#' + targetHash);
            }

            renderView();
            window.scrollTo(0, 0);
        };

        // دالة جديدة للتنقل بين تبويبات لوحة التحكم
        window.setAdminView = (tab) => {
            setView('admin', tab);
        };

        window.viewProduct = (id) => {
            currentProductId = id; // Ensure ID is set immediately
            detailsQuantity = 1;
            activeImageIndex = 0;
            currentSelectedColor = null; // تصفير اللون عند فتح منتج جديد
            
            // --- NEW: Save to History ---
            // Get existing history
            let historyList = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            // Remove current id if it exists (to move it to top)
            historyList = historyList.filter(hId => hId !== id);
            // Add to front
            historyList.unshift(id);
            // Limit to 10 items
            if(historyList.length > 10) historyList.pop();
            // Save back
            localStorage.setItem('gedar_history', JSON.stringify(historyList));
            // ---------------------------

            // Use setView to handle URL update properly
            setView('product-details', id);
        };

        window.scrollSlider = (dir) => {
            const s = document.getElementById('related-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 220 : -220, behavior: 'smooth' });
        };
        
        window.scrollFeatured = (dir) => {
            const s = document.getElementById('featured-slider');
            if(s) s.scrollBy({ left: dir === 'right' ? 260 : -260, behavior: 'smooth' });
        };

        // NEW: Function to start countdown timers
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const update = () => {
                const timers = document.querySelectorAll('.discount-timer');
                if (timers.length === 0) return;

                const now = Date.now();
                timers.forEach(el => {
                    const expiry = parseInt(el.dataset.expiry);
                    const diff = expiry - now;

                    if (diff <= 0) {
                        el.innerHTML = '<span class="text-stone-400 font-bold text-xs">انتهى العرض</span>';
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    el.innerHTML = `
                        <div class="flex items-center gap-2 text-xs font-bold text-red-600 dir-ltr bg-red-50 px-2 py-1 rounded-lg border border-red-100">
                            <span class="w-5 text-center">${seconds}</span>:
                            <span class="w-5 text-center">${minutes}</span>:
                            <span class="w-5 text-center">${hours}</span>:
                            <span class="w-6 text-center">${days}ي</span>
                        </div>
                    `;
                });
            };

            update(); // Run immediately
            countdownInterval = setInterval(update, 1000);
        }

        // --- NEW: Generic Scroll Function for Product Details Sliders ---
        window.scrollSection = (id, dir) => {
            const el = document.getElementById(id);
            if(el) {
                // In RTL, scrolling negative 'left' moves to the visual left (next items)
                const scrollAmount = 300;
                el.scrollBy({ left: dir === 'next' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
            }
        };

        // --- NEW: Toggle About Section ---
        window.toggleAbout = (id) => {
            const container = document.getElementById(`about-container-${id}`);
            const fade = document.getElementById(`about-fade-${id}`);
            const btn = document.getElementById(`about-btn-${id}`);
            
            if (container.classList.contains('max-h-[100px]')) {
                // Expand
                container.classList.remove('max-h-[100px]');
                if(fade) fade.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="chevron-up" size="16"></i> عرض أقل`;
            } else {
                // Collapse
                container.classList.add('max-h-[100px]');
                if(fade) fade.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="chevron-down" size="16"></i> شاهد المزيد`;
            }
            lucide.createIcons();
        };

        // --- NEW: Share Product Logic ---
        window.shareProduct = async (id) => {
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            
            // تكوين الرابط المباشر
            // نستخدم window.location.origin و window.location.pathname لضمان أن الرابط يعمل بغض النظر عن الدومين
            const url = `${window.location.origin}${window.location.pathname}#/product/${id}`;
            
            // استخدام واجهة المشاركة الأصلية للمتصفح (للهواتف)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: product.name,
                        text: `شاهد هذا المنتج المميز من جدار: ${product.name}`,
                        url: url
                    });
                } catch (err) {
                    console.log('Sharing failed or cancelled', err);
                }
            } else {
                // النسخ للحافظة كبديل (لأجهزة الكمبيوتر أو المتصفحات القديمة)
                navigator.clipboard.writeText(url).then(() => {
                    showToast("تم نسخ رابط المنتج للحافظة");
                }).catch(() => {
                    showToast("فشل نسخ الرابط");
                });
            }
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.remove('translate-y-12', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-12', 'opacity-0'), 3000);
        };

        // --- NEW: Shop & Filter Logic (إصلاح مشكلة التصفية) ---
        
        window.filterCategory = (catName) => {
            // تفعيل القسم المختار وتصفير البحث
            shopState.categories = [catName];
            shopState.search = ''; 
            // الانتقال لصفحة المتجر
            setView('shop');
        };

        window.viewAllProducts = () => {
            // إعادة ضبط الفلاتر وعرض الكل
            shopState = { search: '', categories: [], priceMin: 0, priceMax: 1000, sort: 'featured' };
            setView('shop');
        };

        window.updateShopFilters = (type, value) => {
            if (type === 'search') {
                shopState.search = value.toLowerCase();
            } else if (type === 'category') {
                // إضافة أو إزالة القسم من مصفوفة التصفية
                if (shopState.categories.includes(value)) {
                    shopState.categories = shopState.categories.filter(c => c !== value);
                } else {
                    shopState.categories.push(value);
                }
            } else if (type === 'priceMax') {
                shopState.priceMax = Number(value);
            } else if (type === 'priceMin') {
                shopState.priceMin = Number(value);
            } else if (type === 'sort') {
                shopState.sort = value;
            }
            
            // تطبيق الفلتر وتحديث الواجهة
            if (currentView === 'shop') {
                applyShopFilters();
                
                // NEW: إعادة رسم قائمة الأقسام لتحديث حالة التحديد (Checkboxes)
                if (type === 'category') {
                    const list = document.getElementById('shop-categories-list');
                    if (list) list.innerHTML = generateCategoryFilterHTML();
                }
            }
        };

        // NEW: Helper function to generate category filter HTML
        function generateCategoryFilterHTML() {
            return CATEGORIES.map(cat => {
                const isSelected = shopState.categories.includes(cat.name);
                return `
                <label class="cursor-pointer group flex items-center justify-between p-2.5 rounded-xl transition-all duration-200 border ${isSelected ? 'bg-stone-900 border-stone-900 text-white shadow-md' : 'bg-white border-transparent hover:bg-stone-50 text-stone-600'}">
                    <div class="flex items-center gap-3">
                        <div class="relative flex items-center justify-center w-5 h-5">
                            <input type="checkbox" class="peer appearance-none w-5 h-5 border-2 rounded-md transition-all duration-200 cursor-pointer ${isSelected ? 'border-white/40 bg-white/20' : 'border-stone-300 bg-white group-hover:border-stone-400'}" value="${cat.name}" onchange="updateShopFilters('category',this.value)" ${isSelected ? 'checked' : ''}>
                            <i data-lucide="check" size="12" class="absolute text-white pointer-events-none transition-all duration-200 ${isSelected ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}"></i>
                        </div>
                        <span class="font-bold text-sm select-none">${cat.name}</span>
                    </div>
                </label>`;
            }).join('');
        }

        window.resetFilters = () => {
            viewAllProducts();
        };

        // --- NEW: Missing Cart & UI Functions (إضافة دوال السلة والمفضلة المفقودة) ---

        window.addToCart = (id, selectedColor = null) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            
            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            // البحث عن المنتج في السلة (نطابق الآيدي واللون)
            const existing = cart.find(x => x.id === id && x.selectedColor === selectedColor);
            
            if (existing) {
                existing.quantity++;
                // Update price in cart to match current offer status (optional but good practice)
                existing.price = finalPrice; 
            } else {
                // Store with effective price and selected color
                cart.push({ ...p, price: finalPrice, quantity: 1, selectedColor: selectedColor });
            }
            
            saveCart();
            updateCartUI();
            toggleCart(true);
            showToast("تمت الإضافة للسلة");
        };

        window.toggleCart = (show) => {
            const backdrop = document.getElementById('cart-drawer-backdrop');
            const drawer = document.getElementById('cart-drawer');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                drawer.classList.remove('-translate-x-full');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                drawer.classList.add('-translate-x-full');
            }
            lucide.createIcons();
        };

        window.saveCart = () => localStorage.setItem('gedar_cart', JSON.stringify(cart));

        window.removeFromCartByIndex = (index) => {
            cart.splice(index, 1);
            saveCart();
            updateCartUI();
        };

        window.updateQuantityByIndex = (index, change) => {
            const item = cart[index];
            if(item) {
                item.quantity += change;
                if(item.quantity < 1) item.quantity = 1;
                saveCart();
                updateCartUI();
            }
        };

        // Old function kept for backward compatibility if needed, but UI now uses index
        window.removeFromCart = (id) => {
            cart = cart.filter(x => x.id !== id);
            saveCart();
            updateCartUI();
        };

        window.updateQuantity = (id, change) => {
             // Fallback implementation using ID (might affect multiple variants)
             // Better to use updateQuantityByIndex
            const item = cart.find(x => x.id === id);
            if(item) {
                item.quantity += change;
                if(item.quantity < 1) item.quantity = 1;
                saveCart();
                updateCartUI();
            }
        };

        window.toggleFavorite = (id) => {
            if (favorites.includes(id)) favorites = favorites.filter(x => x !== id);
            else favorites.push(id);
            localStorage.setItem('aura_favorites', JSON.stringify(favorites));
            updateFavoritesUI();
            
            // تحديث الواجهة بناءً على الصفحة الحالية
            if(currentView === 'shop') applyShopFilters();
            else if(currentView === 'home') renderFeatured(document.getElementById('main-content'));
            else if(currentView === 'product-details') renderProductDetails(document.getElementById('main-content'));
            else if(currentView === 'favorites') renderFavoritesPage(document.getElementById('main-content'));
            
            showToast(favorites.includes(id) ? "تمت الإضافة للمفضلة" : "تم الحذف من المفضلة");
        };
        
        // دوال مساعدة لصفحة تفاصيل المنتج
        window.setActiveImage = (idx) => {
            activeImageIndex = idx;
            const mainImg = document.getElementById('main-product-image');
            const thumbs = document.querySelectorAll('.gallery-thumb');
            const p = PRODUCTS.find(x => x.id === currentProductId);
            const images = (p && p.images && p.images.length) ? p.images : (p ? [p.image] : []);
            
            if(mainImg && images[idx]) mainImg.src = images[idx];
            
            thumbs.forEach((t, i) => {
                if(i === idx) t.classList.add('active');
                else t.classList.remove('active');
            });
        };

        window.changeDetailsQuantity = (d) => {
            detailsQuantity += d;
            if(detailsQuantity < 1) detailsQuantity = 1;
            const el = document.getElementById('details-qty');
            if(el) el.innerText = detailsQuantity;
        };

        window.addToCartFromDetails = (id) => {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;

            // التحقق مما إذا كان المنتج يحتوي على ألوان ولم يتم اختيار لون
            if (p.variants && p.variants.length > 0 && !currentSelectedColor) {
                showToast("يرجى اختيار اللون أولاً");
                // Scroll to variants section
                const variantsSec = document.getElementById('variants-section');
                if(variantsSec) variantsSec.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Calculate effective price based on active discount
            const active = isDiscountActive(p);
            const finalPrice = active ? (p.price * (1 - p.discount / 100)) : p.price;

            const existing = cart.find(x => x.id === id && x.selectedColor === currentSelectedColor);
            if (existing) {
                existing.quantity += detailsQuantity;
                existing.price = finalPrice;
            } else {
                cart.push({ ...p, price: finalPrice, quantity: detailsQuantity, selectedColor: currentSelectedColor });
            }
            
            saveCart();
            updateCartUI();
            showToast("تمت الإضافة للسلة");
        };

        window.toggleMobileMenu = () => {
             const m = document.getElementById('mobile-menu');
             if(m) {
                 m.classList.toggle('hidden');
                 m.classList.toggle('flex');
             }
        };

        // --- Checkout Logic ---
        
        window.checkout = () => {
            if (cart.length === 0) return showToast("السلة فارغة");
            
            // Reset fields
            document.getElementById('delivery-check').checked = false;
            document.getElementById('checkout-address').value = ''; 
            
            // Initial Calculation
            calculateCheckoutTotal();
            
            // Close cart drawer & Open modal
            toggleCart(false);
            toggleCheckoutModal(true);
        };
        
        window.calculateCheckoutTotal = () => {
            const isDelivery = document.getElementById('delivery-check').checked;
            const address = document.getElementById('checkout-address').value.trim();
            const totalDisplay = document.getElementById('checkout-total-display');
            const noteDisplay = document.getElementById('delivery-note');
            
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let finalTotal = cartTotal;
            let note = "";
            let showNote = false;

            if (isDelivery) {
                // Check if address contains any of the predefined areas
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                
                if (isFixedArea) {
                    finalTotal += FIXED_DELIVERY_FEE;
                    note = `+ ${FIXED_DELIVERY_FEE} ج.م مصاريف توصيل`;
                    showNote = true;
                } else {
                    // Delivery requested but area not matched yet or unknown
                    note = "حساب التوصيل مع المندوب عند الاستلام";
                    showNote = true;
                }
            } else {
                note = "بدون توصيل (استلام من الفرع)";
                showNote = false;
            }

            totalDisplay.innerText = `$${finalTotal.toFixed(2)}`;
            noteDisplay.innerText = note;
            if(showNote) noteDisplay.classList.remove('hidden');
            else noteDisplay.classList.add('hidden');
        };

        window.toggleCheckoutModal = (show) => {
            const backdrop = document.getElementById('checkout-modal-backdrop');
            const modal = document.getElementById('checkout-modal');
            
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        // NEW: Success Modal Logic
        window.toggleSuccessModal = (show, orderId) => {
            const backdrop = document.getElementById('success-modal-backdrop');
            const modal = document.getElementById('success-modal');
            const idDisplay = document.getElementById('success-order-id');
            
            if (show) {
                if(orderId) idDisplay.innerText = orderId;
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        window.copyOrderId = () => {
            const id = document.getElementById('success-order-id').innerText;
            navigator.clipboard.writeText(id);
            showToast("تم نسخ رقم الطلب");
        };

        window.handlePlaceOrder = async (e) => {
            e.preventDefault();
            
            if (cart.length === 0) return;

            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            
            // Recalculate logic securely
            const isDelivery = document.getElementById('delivery-check').checked;
            let cartTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let deliveryFee = 0;
            let deliveryStatus = "no_delivery"; // no_delivery, fixed, courier

            if (isDelivery) {
                const isFixedArea = DELIVERY_AREAS.some(area => address.includes(area));
                if (isFixedArea) {
                    deliveryFee = FIXED_DELIVERY_FEE;
                    deliveryStatus = "fixed";
                } else {
                    deliveryStatus = "courier";
                }
            }

            const totalAmount = cartTotal + deliveryFee;

            const orderData = {
                customer: {
                    name: name,
                    phone: phone,
                    address: address
                },
                items: cart,
                subtotal: cartTotal,
                delivery: {
                    requested: isDelivery,
                    fee: deliveryFee,
                    status: deliveryStatus, // 'fixed' means 70 added, 'courier' means pay on delivery
                    areasMatch: deliveryStatus === 'fixed'
                },
                totalAmount: totalAmount,
                status: 'new',
                createdAt: Date.now(),
                userId: user && !user.isAnonymous ? user.uid : 'guest'
            };

            try {
                // Save and get Reference to get ID
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                
                cart = [];
                saveCart(); // Clear cart from storage too
                toggleCheckoutModal(false);
                e.target.reset();
                
                // Show Success Modal with ID
                toggleSuccessModal(true, docRef.id);
                
            } catch (error) {
                console.error("Order Error:", error);
                showToast("حدث خطأ أثناء إرسال الطلب، يرجى المحاولة مرة أخرى.");
            }
        };

        window.handleAddCategory = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            const name = e.target.catName.value.trim();
            const image = e.target.catImg.value.trim();
            
            // Check logic: If editing, update. If adding, check duplicate.
            if (currentEditCategoryName) {
                // --- UPDATE MODE ---
                try {
                    const newCats = CATEGORIES.map(c => 
                        c.name === currentEditCategoryName ? { name: name, image: image } : c
                    );
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                    showToast(`تم تعديل قسم "${name}" بنجاح`);
                    currentEditCategoryName = null; // Reset
                    e.target.reset();
                    renderView(); // Refresh UI to reset button text
                } catch(err) { console.error(err); showToast("حدث خطأ في التعديل"); }
            } else {
                // --- ADD MODE ---
                if (name && !CATEGORIES.some(c => c.name === name)) {
                    try {
                        const newCat = { 
                            name: name, 
                            image: image || "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=500" 
                        };
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: arrayUnion(newCat) });
                        showToast(`تم إضافة قسم "${name}" بنجاح`);
                        e.target.reset();
                    } catch(err) { console.error(err); showToast("حدث خطأ"); }
                } else {
                    showToast("اسم غير صالح أو موجود مسبقاً");
                }
            }
        };

        // --- NEW: Delete Category ---
        window.handleDeleteCategory = async (catName) => {
            if (!confirm(`هل أنت متأكد من حذف قسم "${catName}"؟`)) return;
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            try {
                // Filter out the category to delete
                const newCats = CATEGORIES.filter(c => c.name !== catName);
                // Save the new array (overwrite)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'store'), { categories: newCats }, { merge: true });
                showToast("تم حذف القسم");
            } catch(err) { console.error(err); showToast("حدث خطأ أثناء الحذف"); }
        };

        // NEW: Handle Save Hero Settings
        window.handleSaveHeroSettings = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");

            const mainImg = e.target.heroMain.value.trim();
            const secImg = e.target.heroSec.value.trim();
            const priceLbl = e.target.heroPriceLabel.value.trim();
            const priceVal = e.target.heroPriceValue.value.trim();
            const discLbl = e.target.heroDiscLabel.value.trim();
            const discVal = e.target.heroDiscValue.value.trim();
            
            // Logo Fields
            const logoUrl = e.target.siteLogo.value.trim();
            const logoSize = e.target.logoSize.value.trim();

            // Image Config Fields (NEW)
            const imgBaseUrl = e.target.imgBaseUrl.value.trim();
            const imgDefaultExt = e.target.imgExt.value.trim();

            // Header Banner Fields
            const fbUrl = e.target.fbUrl.value.trim();
            const fbHeight = e.target.fbHeight.value.trim();
            const fbWidth = e.target.fbWidth.value.trim();
            const fbShow = e.target.fbShow.checked;

            // Category Banner Fields
            const catBanUrl = e.target.catBanUrl.value.trim();
            const catBanHeight = e.target.catBanHeight.value.trim();
            const catBanWidth = e.target.catBanWidth.value.trim();
            const catBanShow = e.target.catBanShow.checked;

            // NEW: Best Seller Banner Fields
            const bsBanUrl = e.target.bsBanUrl.value.trim();
            const bsBanHeight = e.target.bsBanHeight.value.trim();
            const bsBanWidth = e.target.bsBanWidth.value.trim();
            const bsBanShow = e.target.bsBanShow.checked;

            // NEW: Featured Banner Fields
            const ftBanUrl = e.target.ftBanUrl.value.trim();
            const ftBanHeight = e.target.ftBanHeight.value.trim();
            const ftBanWidth = e.target.ftBanWidth.value.trim();
            const ftBanShow = e.target.ftBanShow.checked;

            // Hero Visibility Fields
            const heroMobile = e.target.heroShowMobile.checked;
            const heroDesktop = e.target.heroShowDesktop.checked;

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'hero'), {
                    mainImage: mainImg,
                    secondaryImage: secImg,
                    priceLabel: priceLbl,
                    priceValue: priceVal,
                    discountLabel: discLbl,
                    discountValue: discVal,
                    logoUrl: logoUrl,
                    logoSize: logoSize,
                    // Save Image Config (NEW)
                    imageBaseUrl: imgBaseUrl,
                    imageDefaultExt: imgDefaultExt,
                    // Save Header Banner
                    footerBannerUrl: fbUrl,
                    footerBannerHeight: fbHeight,
                    footerBannerWidth: fbWidth,
                    showFooterBanner: fbShow,
                    // Save Category Banner
                    categoryBannerUrl: catBanUrl,
                    categoryBannerHeight: catBanHeight,
                    categoryBannerWidth: catBanWidth,
                    showCategoryBanner: catBanShow,
                    // Save Best Seller Banner
                    bestSellerBannerUrl: bsBanUrl,
                    bestSellerBannerHeight: bsBanHeight,
                    bestSellerBannerWidth: bsBanWidth,
                    showBestSellerBanner: bsBanShow,
                    // Save Featured Banner
                    featuredBannerUrl: ftBanUrl,
                    featuredBannerHeight: ftBanHeight,
                    featuredBannerWidth: ftBanWidth,
                    showFeaturedBanner: ftBanShow,
                    // Save Hero Visibility
                    showHeroMobile: heroMobile,
                    showHeroDesktop: heroDesktop
                }, { merge: true });
                showToast("تم تحديث إعدادات الموقع والواجهة بنجاح");
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ أثناء الحفظ");
            }
        };

        // NEW: Function to update global branding (Navbar, Footer, & Bottom Banner)
        function updateGlobalBranding() {
            const navBrand = document.getElementById('navbar-brand');
            const footerBrand = document.getElementById('footer-brand');
            const bannerContainer = document.getElementById('header-banner-container'); // Updated ID
            const mainContent = document.getElementById('main-content'); // Get main content to adjust padding
            
            const logoUrl = HERO_SETTINGS.logoUrl;
            const size = HERO_SETTINGS.logoSize || 100;

            if (navBrand) {
                if (logoUrl) {
                    navBrand.innerHTML = `<img src="${logoUrl}" style="width: ${size}px; height: auto; max-width: none;" class="object-contain" alt="Logo">`;
                } else {
                    navBrand.innerHTML = `
                        <div class="text-2xl font-bold tracking-tight flex items-center gap-1">جدار<span class="text-stone-400 text-4xl leading-3">.</span></div>
                        <span class="text-[0.65rem] text-stone-500 font-medium mt-1 tracking-wide">للديكورات الحديثة</span>
                    `;
                }
            }

            if (footerBrand) {
                if (logoUrl) {
                    footerBrand.innerHTML = `<img src="${logoUrl}" style="width: ${parseInt(size) * 1.2}px; height: auto;" class="object-contain" alt="Logo">`;
                } else {
                    footerBrand.innerHTML = `<div class="text-3xl font-bold text-stone-900 tracking-tighter flex items-center gap-1">جدار<span class="text-stone-400 text-5xl leading-3">.</span></div>`;
                }
            }

            // Update Header Banner
            if (bannerContainer) {
                if (HERO_SETTINGS.showFooterBanner && HERO_SETTINGS.footerBannerUrl) {
                    bannerContainer.classList.remove('hidden');
                    
                    // Logic to reduce padding of main content views if banner is present to avoid double spacing
                    // We add a class to body or main to handle this via CSS if needed, 
                    // but for now, the banner simply pushes content down.
                    // Note: Views like Hero have 'pt-20'. With the banner margin, this creates extra space.
                    // We can visually accept this or try to counteract it negatively.
                    
                    bannerContainer.innerHTML = `
                        <div class="w-full bg-stone-50 flex justify-center overflow-hidden">
                            <img src="${HERO_SETTINGS.footerBannerUrl}" 
                                 style="height: ${HERO_SETTINGS.footerBannerHeight || 200}px; width: ${HERO_SETTINGS.footerBannerWidth || 100}%; object-fit: cover;" 
                                 alt="Promo Banner" class="shadow-sm">
                        </div>`;
                } else {
                    bannerContainer.classList.add('hidden');
                    bannerContainer.innerHTML = '';
                }
            }
        }

        // --- NEW: Prepare Edit ---
        window.prepareEditCategory = (name, image) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            currentEditCategoryName = name;
            currentAdminTab = 'categories'; // Switch to categories tab
            renderView(); 
        };

        window.cancelEditCategory = () => {
            currentEditCategoryName = null;
            renderView();
        };

        window.handleDeleteProduct = async (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            if (!confirm("هل أنت متأكد من رغبتك في حذف هذا المنتج نهائياً؟")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                showToast("تم حذف المنتج بنجاح");
            } catch (err) { console.error(err); showToast("حدث خطأ أثناء الحذف"); }
        };

        window.handleEditProduct = (id) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            const p = PRODUCTS.find(x => x.id === id);
            if (p) {
                currentEditProduct = p;
                currentAdminTab = 'products'; // Switch to products tab
                setView('admin');
            }
        };

        window.cancelEdit = () => {
            currentEditProduct = null;
            renderView();
        };

        window.handleSaveProduct = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح: يجب تسجيل الدخول كمسؤول");
            
            const nameVal = e.target.prodName.value;
            const brandVal = e.target.prodBrand ? e.target.prodBrand.value : "";
            const materialVal = e.target.prodMaterial ? e.target.prodMaterial.value : "";
            const priceVal = parseFloat(e.target.prodPrice.value);
            const discountVal = parseFloat(e.target.prodDiscount.value) || 0;
            const expiryVal = e.target.prodExpiry.value ? new Date(e.target.prodExpiry.value).getTime() : null;
            
            // NEW: Get Featured Value
            const isFeaturedVal = e.target.prodFeatured ? e.target.prodFeatured.checked : false;

            const catVal = e.target.prodCat.value;
            
            // --- NEW: Smart Image URL Generation ---
            let imgInput = e.target.prodImg.value.trim();
            let imgVal = imgInput;
            
            // إذا كان المدخل ليس رابطاً كاملاً (لا يبدأ بـ http) ويوجد إعدادات للقاعدة
            if (imgInput && !imgInput.match(/^https?:\/\//) && HERO_SETTINGS.imageBaseUrl) {
                // التأكد من وجود / في نهاية الرابط الأساسي
                const baseUrl = HERO_SETTINGS.imageBaseUrl.endsWith('/') 
                    ? HERO_SETTINGS.imageBaseUrl 
                    : HERO_SETTINGS.imageBaseUrl + '/';
                
                // التأكد من الامتداد
                const ext = HERO_SETTINGS.imageDefaultExt || '.webp';
                const hasExt = imgInput.includes('.');
                
                imgVal = baseUrl + imgInput + (hasExt ? '' : ext);
            }
            // ----------------------------------------

            const descVal = e.target.prodDesc ? e.target.prodDesc.value : "";
            const featuresVal = e.target.prodFeatures ? e.target.prodFeatures.value.split('\n').filter(l => l.trim()) : [];
            const imagesVal = e.target.prodImages ? e.target.prodImages.value.split('\n').filter(l => l.trim()) : [];
            
            // Parse Variants (Colors)
            const variantsLines = e.target.prodVariants ? e.target.prodVariants.value.split('\n').filter(l => l.trim()) : [];
            const variants = variantsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const color = parts[0].trim();
                const image = parts.slice(1).join(':').trim(); 
                return { color, image };
            }).filter(item => item !== null);

            // Parse Specifications
            const specsLines = e.target.prodSpecs ? e.target.prodSpecs.value.split('\n').filter(l => l.trim()) : [];
            const specifications = specsLines.map(line => {
                const parts = line.split(':'); 
                if (parts.length < 2) return null;
                const label = parts[0].trim();
                const value = parts.slice(1).join(':').trim(); 
                return { label, value };
            }).filter(item => item !== null);

            // --- NEW: Parse Services ---
            const servicesLines = e.target.prodServices ? e.target.prodServices.value.split('\n').filter(l => l.trim()) : [];
            const services = servicesLines.map(line => {
                const parts = line.split(':');
                if (parts.length < 2) return null;
                const icon = parts[0].trim();
                const text = parts.slice(1).join(':').trim();
                return { icon, text };
            }).filter(item => item !== null);

            const finalImages = [imgVal, ...imagesVal];

            const productData = {
                name: nameVal,
                brand: brandVal,
                material: materialVal,
                price: priceVal,
                discount: discountVal,
                discountExpiry: expiryVal,
                isFeatured: isFeaturedVal, // Save Featured Status
                category: catVal,
                image: imgVal,
                images: finalImages,
                description: descVal,
                features: featuresVal,
                variants: variants, // Add Variants
                specifications: specifications,
                services: services, // Add services
                rating: 5,
                details: "تفاصيل المنتج..."
            };

            try {
                if (currentEditProduct) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', currentEditProduct.id), productData);
                    showToast("تم تعديل المنتج بنجاح");
                    currentEditProduct = null;
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), productData);
                    showToast("تم إضافة المنتج بنجاح");
                }
                e.target.reset();
                if (currentView === 'admin') renderView();
            } catch(err) { console.error(err); showToast("حدث خطأ"); }
        };

        window.handleSubmitReview = async (e) => {
            e.preventDefault();
            const name = e.target.reviewerName.value.trim();
            const comment = e.target.reviewerComment.value.trim();
            const rating = parseInt(e.target.reviewerRating.value);

            if (!name || !comment) return showToast("يرجى ملء جميع الحقول");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), {
                    productId: currentProductId,
                    userName: name,
                    comment: comment,
                    rating: rating,
                    status: 'pending',
                    createdAt: Date.now()
                });
                showToast("تم إرسال تعليقك للمراجعة، سيظهر بعد الموافقة");
                e.target.reset();
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء الإرسال");
            }
        };

        window.handleReviewAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            try {
                if (action === 'approve') {
                    // Check if verified checkbox is checked
                    const isVerified = document.getElementById(`verify-check-${id}`)?.checked || false;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id), { 
                        status: 'approved',
                        verified: isVerified 
                    });
                    showToast("تمت الموافقة على التعليق");
                } else {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id));
                    showToast("تم رفض التعليق وحذفه");
                }
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // NEW: Handle Order Actions
        window.handleOrderAction = async (id, action) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                if (action === 'delete') {
                    if(!confirm("هل أنت متأكد من حذف هذا الطلب نهائياً؟")) return;
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    showToast("تم حذف الطلب");
                } else if (action === 'archive') {
                    if(!confirm("هل تريد أرشفة هذا الطلب؟")) return;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: true
                    });
                    showToast("تم نقل الطلب إلى الأرشيف");
                } else if (action === 'restore') {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                        isArchived: false
                    });
                    showToast("تم استعادة الطلب للقائمة الرئيسية");
                }
                // Status Updates handled via handleOrderStatusChange now
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ في تحديث الطلب");
            }
        };

        // NEW: Handle Modification Decision (Admin)
        window.handleModDecision = async (id, decision) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                // decision: 'approved' or 'rejected'
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'modificationRequest.status': decision,
                    'modificationRequest.adminRespondedAt': Date.now()
                });
                
                if (decision === 'approved') {
                    showToast("تمت الموافقة على طلب التعديل (يرجى تنفيذ التعديل يدوياً إذا لزم الأمر)");
                    // Optional: Open edit modal automatically if approved to let admin make changes
                    // openEditOrderModal(id); 
                } else {
                    showToast("تم رفض طلب التعديل");
                }
            } catch(err) {
                console.error(err);
                showToast("حدث خطأ");
            }
        };

        // NEW: Handle Order Status Change (Admin)
        window.handleOrderStatusChange = async (id, newStatus) => {
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    status: newStatus
                });
                showToast("تم تحديث حالة الطلب بنجاح");
            } catch(err) {
                console.error(err);
                showToast("فشل تحديث الحالة");
            }
        };

        // NEW: Edit Order Logic
        window.openEditOrderModal = (id) => {
            const order = ALL_ORDERS.find(o => o.id === id);
            if (!order) return;

            const form = document.getElementById('edit-order-form');
            form.orderId.value = order.id;
            form.customerName.value = order.customer.name;
            form.customerPhone.value = order.customer.phone;
            form.customerAddress.value = order.customer.address;
            form.totalAmount.value = order.totalAmount;

            toggleEditOrderModal(true);
        };

        window.toggleEditOrderModal = (show) => {
            const backdrop = document.getElementById('edit-order-modal-backdrop');
            const modal = document.getElementById('edit-order-modal');
            
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        window.handleUpdateOrder = async (e) => {
            e.preventDefault();
            if (!user || user.email !== ADMIN_EMAIL) return showToast("غير مصرح");
            
            const id = e.target.orderId.value;
            const name = e.target.customerName.value.trim();
            const phone = e.target.customerPhone.value.trim();
            const address = e.target.customerAddress.value.trim();
            const total = parseFloat(e.target.totalAmount.value);

            if(!name || !phone || !address || isNaN(total)) return showToast("يرجى التأكد من صحة البيانات");

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    'customer.name': name,
                    'customer.phone': phone,
                    'customer.address': address,
                    'totalAmount': total
                });
                showToast("تم تحديث بيانات الطلب بنجاح");
                toggleEditOrderModal(false);
            } catch(err) {
                console.error(err);
                showToast("فشل التحديث، حاول مرة أخرى");
            }
        };

        // NEW: Track Order Logic (Public)
        window.handleTrackOrderSearch = async (e) => {
            e.preventDefault();
            const orderId = e.target.orderId.value.trim();
            if (!orderId) return;

            const resultContainer = document.getElementById('tracking-result');
            resultContainer.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-stone-200 border-t-stone-900 rounded-full mx-auto"></div><p class="mt-4 text-stone-500 text-sm">جاري البحث...</p></div>';

            try {
                // Fetch specific order by ID
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
                
                // Using onSnapshot instead of getDoc for real-time updates on tracking page
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const order = docSnap.data();
                        order.id = docSnap.id; // Ensure ID is attached
                        renderTrackingTimeline(resultContainer, order);
                    } else {
                        resultContainer.innerHTML = `
                            <div class="text-center py-12 bg-red-50 rounded-2xl border border-red-100">
                                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-circle" size="32"></i></div>
                                <h3 class="font-bold text-lg text-stone-900">الطلب غير موجود</h3>
                                <p class="text-stone-500 mt-2">يرجى التأكد من رقم الطلب والمحاولة مرة أخرى.</p>
                            </div>`;
                        lucide.createIcons();
                    }
                });

            } catch (err) {
                console.error(err);
                resultContainer.innerHTML = '<p class="text-center text-red-500 py-8">حدث خطأ أثناء البحث.</p>';
            }
        };
        
        // NEW: Modification Modal Logic (Client)
        window.openModRequestModal = (orderId) => {
            document.getElementById('mod-order-id').value = orderId;
            toggleModModal(true);
        };

        window.toggleModModal = (show) => {
            const backdrop = document.getElementById('mod-modal-backdrop');
            const modal = document.getElementById('mod-modal');
            if (show) {
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('scale-100');
            } else {
                backdrop.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.remove('scale-100');
            }
            lucide.createIcons();
        };

        window.handleSubmitModRequest = async (e) => {
            e.preventDefault();
            const id = e.target.orderId.value;
            const msg = e.target.message.value.trim();
            if (!msg) return;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), {
                    modificationRequest: {
                        message: msg,
                        status: 'pending',
                        createdAt: Date.now()
                    }
                });
                showToast("تم إرسال طلب التعديل بنجاح");
                toggleModModal(false);
                e.target.reset();
            } catch(err) {
                console.error(err);
                showToast("فشل الإرسال");
            }
        };

        // NEW: Fix for Tab Switching (re-renders admin view now)
        window.setOrderTab = (tab) => {
            currentOrderTab = tab;
            renderView();
        };

        function renderTrackingTimeline(container, order) {
            const steps = [
                { id: 'new', label: 'تم الطلب', icon: 'shopping-bag', desc: 'تم استلام طلبك بنجاح وهو قيد المراجعة.' },
                { id: 'payment_pending', label: 'بانتظار الدفع', icon: 'credit-card', desc: 'يرجى إتمام عملية الدفع لتأكيد الطلب.' },
                { id: 'confirmed', label: 'تم التأكيد', icon: 'check-circle', desc: 'تم تأكيد طلبك والدفع بنجاح.' },
                { id: 'processing', label: 'جاري التجهيز', icon: 'package', desc: 'يقوم فريقنا بتجهيز وتغليف طلبك حالياً.' },
                { id: 'shipped', label: 'تم الشحن', icon: 'truck', desc: 'الشحنة خرجت مع مندوب التوصيل في طريقها إليك.' },
                { id: 'delivered', label: 'تم التوصيل', icon: 'home', desc: 'تم تسليم الطلب بنجاح. نتمنى أن ينال إعجابك!' }
            ];

            const currentStatus = order.status || 'new';
            const currentIndex = steps.findIndex(s => s.id === currentStatus);
            const currentStepInfo = steps[currentIndex] || steps[0];
            
            // Calculate totals
            const subtotal = order.items.reduce((s, i) => s + (i.price * i.quantity), 0);
            const deliveryFee = order.delivery ? order.delivery.fee : 0;
            const total = order.totalAmount || (subtotal + deliveryFee);
            const isDelivery = order.delivery && order.delivery.requested;

            // Status Color Logic
            const isDelivered = currentStatus === 'delivered';
            
            // Calculate progress specifically for the horizontal bar
            const progressPercent = Math.min(100, Math.max(0, (currentIndex / (steps.length - 1)) * 100));

            // Modification Request Logic
            const modReq = order.modificationRequest;
            let modReqHTML = '';
            
            if (modReq) {
                if (modReq.status === 'pending') {
                    modReqHTML = `
                    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                        <i data-lucide="clock" class="text-orange-500 mt-1 shrink-0"></i>
                        <div>
                            <h4 class="font-bold text-orange-700 text-sm">طلب التعديل قيد المراجعة</h4>
                            <p class="text-orange-600 text-xs mt-1">طلبت: "${modReq.message}"</p>
                        </div>
                    </div>`;
                } else if (modReq.status === 'approved') {
                    modReqHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                        <i data-lucide="check-circle" class="text-green-500 mt-1 shrink-0"></i>
                        <div>
                            <h4 class="font-bold text-green-700 text-sm">تمت الموافقة على طلب التعديل</h4>
                            <p class="text-green-600 text-xs mt-1">سيتم تنفيذ التعديلات المطلوبة.</p>
                        </div>
                    </div>`;
                } else if (modReq.status === 'rejected') {
                    modReqHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                        <i data-lucide="x-circle" class="text-red-500 mt-1 shrink-0"></i>
                        <div>
                            <h4 class="font-bold text-red-700 text-sm">تم رفض طلب التعديل</h4>
                            <p class="text-red-600 text-xs mt-1">عذراً، لا يمكن تنفيذ التعديل المطلوب في الوقت الحالي.</p>
                        </div>
                    </div>`;
                }
            } else if (currentStatus !== 'delivered' && currentStatus !== 'shipped') {
                // Show button only if no active request and not delivered/shipped
                modReqHTML = `
                <div class="mb-6 text-center">
                    <button onclick="openModRequestModal('${order.id}')" class="text-sm font-bold text-stone-500 hover:text-stone-900 underline decoration-stone-300 underline-offset-4 flex items-center justify-center gap-2 mx-auto transition-colors">
                        <i data-lucide="edit-3" size="14"></i> هل تريد طلب تعديل على هذا الطلب؟
                    </button>
                </div>`;
            }

            container.innerHTML = `
                <!-- 1. Hero Status Card -->
                <div class="bg-white rounded-3xl p-6 md:p-8 shadow-xl shadow-stone-200/40 mb-8 border border-white relative overflow-hidden group fade-in-up">
                    <!-- Background Decoration -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-stone-50 rounded-full -mr-20 -mt-20 blur-3xl transition-colors duration-500 group-hover:bg-stone-100"></div>
                    <div class="absolute bottom-0 left-0 w-40 h-40 ${isDelivered ? 'bg-green-50' : 'bg-blue-50'} rounded-full -ml-10 -mb-10 blur-3xl opacity-60"></div>
                    
                    <div class="relative z-10">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            <div>
                                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-stone-100 text-stone-600 mb-4 border border-stone-200">
                                    <span class="w-1.5 h-1.5 rounded-full ${isDelivered ? 'bg-green-500' : 'bg-blue-500 animate-pulse'}"></span>
                                    رقم الطلب #${order.id}
                                </div>
                                <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mb-2 tracking-tight">
                                     ${currentStepInfo.label}
                                </h2>
                                <p class="text-stone-500 text-sm md:text-base max-w-md leading-relaxed">
                                    ${currentStepInfo.desc}
                                </p>
                            </div>
                            
                            <div class="w-20 h-20 md:w-24 md:h-24 ${isDelivered ? 'bg-green-100 text-green-600' : 'bg-stone-900 text-white'} rounded-3xl flex items-center justify-center shadow-lg transform rotate-3 transition-transform hover:rotate-6">
                                <i data-lucide="${currentStepInfo.icon}" size="40"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Modification Request Section -->
                ${modReqHTML}

                <!-- Removed Grid, used space-y-8 to stack elements -->
                <div class="space-y-8 fade-in-up" style="animation-delay: 0.1s;">
                    
                    <!-- 2. Horizontal Timeline (Full Width) -->
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-stone-100 overflow-hidden">
                        <h3 class="font-bold text-lg mb-8 flex items-center gap-2 text-stone-900">
                            <div class="p-2 bg-stone-50 rounded-lg"><i data-lucide="list-checks" class="text-stone-900" size="20"></i></div>
                            سجل التتبع
                        </h3>
                        
                        <!-- Wrapper for horizontal scrolling on small screens -->
                        <div class="overflow-x-auto pb-4 custom-scrollbar">
                            <div class="min-w-[700px] relative px-4 py-6">
                                <!-- Connecting Line Background -->
                                <div class="absolute top-1/2 right-0 left-0 h-1 bg-stone-100 -translate-y-1/2 rounded-full z-0 mx-8"></div>
                                <!-- Connecting Line Progress -->
                                <div class="absolute top-1/2 right-0 h-1 bg-stone-900 -translate-y-1/2 rounded-full z-0 mx-8 transition-all duration-1000 ease-out" style="width: ${progressPercent}%"></div>

                                <div class="flex justify-between items-center relative z-10 w-full">
                                    ${steps.map((step, idx) => {
                                        const isCompleted = idx <= currentIndex;
                                        const isCurrent = idx === currentIndex;
                                        
                                        return `
                                        <div class="flex flex-col items-center gap-4 relative group cursor-default text-center w-32">
                                            <!-- Icon Circle -->
                                            <div class="w-12 h-12 rounded-full border-[3px] flex items-center justify-center transition-all duration-500 z-10 
                                                ${isCompleted 
                                                    ? 'bg-stone-900 border-stone-900 text-white shadow-lg scale-110' 
                                                    : 'bg-white border-stone-200 text-stone-300'
                                                } ${isCurrent ? 'ring-4 ring-stone-100' : ''}">
                                                <i data-lucide="${step.icon}" size="${isCurrent ? 20 : 18}"></i>
                                            </div>
                                            
                                            <!-- Text Info -->
                                            <div class="flex flex-col items-center">
                                                <h4 class="font-bold text-sm ${isCompleted ? 'text-stone-900' : 'text-stone-400'} mb-1 transition-colors">${step.label}</h4>
                                                ${isCurrent ? `<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold animate-pulse">الحالية</span>` : ''}
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description Box for Current Step -->
                        <div class="mt-6 bg-stone-50 rounded-xl p-4 border border-stone-100 flex gap-4 items-start animate-in fade-in slide-in-from-top-2">
                             <div class="w-10 h-10 rounded-full bg-white border border-stone-200 flex items-center justify-center shrink-0 text-stone-900 shadow-sm">
                                <i data-lucide="info" size="20"></i>
                             </div>
                             <div>
                                <h4 class="font-bold text-stone-900 text-sm mb-1">تفاصيل المرحلة الحالية</h4>
                                <p class="text-stone-600 text-sm leading-relaxed">${currentStepInfo.desc}</p>
                             </div>
                        </div>
                    </div>

                    <!-- 3. Invoice Summary (Moved Down & Full Width Adjustment) -->
                    <div class="bg-white rounded-3xl shadow-xl shadow-stone-200/50 border border-stone-100 overflow-hidden transform transition-all hover:-translate-y-1 duration-300">
                        <!-- Header -->
                        <div class="p-6 bg-stone-900 text-white relative overflow-hidden">
                            <!-- Decorative Circles -->
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-8 -mb-8 blur-2xl"></div>
                            
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg flex items-center gap-2">
                                        <i data-lucide="receipt" size="18" class="text-stone-400"></i> ملخص الفاتورة
                                    </h3>
                                    <p class="text-stone-400 text-xs mt-1 font-mono tracking-wider opacity-80">ORDER #${order.id}</p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/10">
                                    <i data-lucide="shopping-bag" size="20" class="text-white"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket Content Wrapper (Grid for larger screens) -->
                        <div class="grid md:grid-cols-2">
                            <!-- Items List -->
                            <div class="p-6 bg-white md:border-l md:border-stone-100 max-h-[350px] overflow-y-auto custom-scrollbar space-y-4">
                                ${order.items.map(item => `
                                    <div class="flex items-center gap-4 group">
                                        <div class="w-14 h-14 bg-stone-50 rounded-xl border border-stone-100 overflow-hidden flex-shrink-0 relative">
                                            <img src="${item.selectedColor && item.variants ? (item.variants.find(v=>v.color===item.selectedColor)?.image || item.image) : item.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                            <span class="absolute bottom-0 right-0 bg-stone-900 text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-tl-lg font-bold">${item.quantity}</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-bold text-stone-900 text-sm truncate mb-0.5">${item.name}</h4>
                                            <p class="text-xs text-stone-500 font-medium">سعر القطعة: $${item.price}</p>
                                            ${item.selectedColor ? `<p class="text-[10px] text-stone-400 mt-0.5 bg-stone-50 inline-block px-1.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <p class="font-serif font-bold text-stone-900 text-sm">$${(item.price * item.quantity).toFixed(2)}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex flex-col">
                                <!-- Ticket Divider (Vertical on desktop if needed, currently horizontal) -->
                                <div class="relative h-4 bg-stone-50 overflow-hidden md:hidden">
                                    <div class="absolute top-1/2 left-0 w-full border-t-2 border-dashed border-stone-300 -translate-y-1/2"></div>
                                    <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-stone-100 rounded-full border-r border-stone-200"></div>
                                    <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-stone-100 rounded-full border-l border-stone-200"></div>
                                </div>

                                <!-- Calculations Footer -->
                                <div class="p-6 bg-stone-50 space-y-3 flex-1">
                                    <div class="flex justify-between items-center text-xs font-bold text-stone-500">
                                        <span>المجموع الفرعي</span>
                                        <span class="font-serif text-stone-700">$${subtotal.toFixed(2)}</span>
                                    </div>
                                    ${isDelivery ? `
                                    <div class="flex justify-between items-center text-xs font-bold text-stone-500">
                                        <span>الشحن</span>
                                        <span class="font-serif text-stone-700">${deliveryFee > 0 ? '$' + deliveryFee.toFixed(2) : 'حسب المنطقة'}</span>
                                    </div>` : ''}
                                    
                                    <div class="flex justify-between items-center pt-3 border-t border-stone-200 mt-2">
                                        <span class="text-base font-bold text-stone-900">الإجمالي الكلي</span>
                                        <span class="text-xl font-serif font-black text-stone-900">$${Number(total).toFixed(2)}</span>
                                    </div>
                                </div>

                                <!-- Customer Info (Detailed) -->
                                <div class="p-5 bg-stone-50/50 border-t border-stone-100 text-xs">
                                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm">
                                                <i data-lucide="user" size="14"></i>
                                            </div>
                                            <div>
                                                <p class="text-[10px] text-stone-400 font-bold mb-0.5">العميل</p>
                                                <p class="font-bold text-stone-900 text-sm">${order.customer.name}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center gap-2">
                                            <div class="text-right">
                                                <p class="text-[10px] text-stone-400 font-bold mb-0.5">الهاتف</p>
                                                <p class="font-mono text-stone-700 font-bold dir-ltr bg-white px-2 py-0.5 rounded border border-stone-100">${order.customer.phone}</p>
                                            </div>
                                            <div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm">
                                                <i data-lucide="phone" size="14"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white p-3 rounded-xl border border-stone-200 shadow-sm flex gap-3 items-start">
                                        <i data-lucide="map-pin" size="16" class="text-orange-500 shrink-0 mt-0.5"></i>
                                        <div>
                                            <p class="text-[10px] text-stone-400 font-bold mb-1">عنوان التوصيل</p>
                                            <p class="text-stone-700 leading-relaxed font-medium">${order.customer.address}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                // Extra check immediately after popup
                if (result.user.email !== ADMIN_EMAIL) {
                    await signOut(auth);
                    showToast("عذراً، الدخول مقتصر على حساب المالك فقط: " + ADMIN_EMAIL);
                    return;
                }
                showToast("مرحباً بك يا مدير المتجر");
                setView('home');
            } catch (error) {
                console.error(error);
                showToast("فشل تسجيل الدخول");
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showToast("تم تسجيل الخروج");
                setView('home');
            } catch (error) { console.error(error); }
        };

        // --- Search Logic ---
        let isSearchOpen = false;

        window.toggleTopSearch = (e) => {
            e.stopPropagation();
            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            
            if (!isSearchOpen) {
                // Open
                bar.classList.remove('w-10', 'bg-stone-50', 'border-transparent');
                bar.classList.add('w-64', 'bg-white', 'border-stone-200', 'shadow-sm');
                input.classList.remove('opacity-0');
                input.focus();
                isSearchOpen = true;
            } else {
                // If clicked while open and empty, close it. If has text, search.
                if(input.value.trim() !== "") {
                     updateShopFilters('search', input.value.trim());
                     setView('shop');
                } else {
                    closeTopSearch(); // Toggle close if empty
                }
            }
        };

        window.closeTopSearch = () => {
            if(!isSearchOpen) return;
            const bar = document.getElementById('top-search-bar');
            const input = document.getElementById('top-search-input');
            
            bar.classList.add('w-10', 'bg-stone-50', 'border-transparent');
            bar.classList.remove('w-64', 'bg-white', 'border-stone-200', 'shadow-sm');
            input.classList.add('opacity-0');
            input.blur();
            isSearchOpen = false;
        };

        window.handleGlobalSearch = (e) => {
            if(e.key === 'Enter') {
                const val = e.target.value.trim();
                if(val) {
                     updateShopFilters('search', val);
                     setView('shop');
                     closeTopSearch(); // Optional: close after search
                }
            }
        };

        // --- Internal Helpers ---

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            const badge = document.getElementById('cart-badge');
            const totalEl = document.getElementById('cart-total');
            const countSummary = document.getElementById('cart-count-summary');
            
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
            
            const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            totalEl.innerText = `$${total.toFixed(2)}`;
            if(countSummary) countSummary.innerText = count;

            if (cart.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-in fade-in zoom-in duration-300">
                    <div class="w-32 h-32 bg-stone-50 rounded-full flex items-center justify-center mb-4 relative">
                        <div class="absolute inset-0 border-2 border-dashed border-stone-200 rounded-full animate-[spin_10s_linear_infinite]"></div>
                        <i data-lucide="shopping-bag" size="48" class="text-stone-300"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">سلة التسوق فارغة</h3>
                        <p class="text-stone-500 text-sm max-w-[200px] mx-auto">يبدو أنك لم تضف أي منتجات بعد. تصفح المتجر واكتشف خياراتنا المميزة.</p>
                    </div>
                    <button onclick="toggleCart(false)" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:-translate-y-0.5">
                        ابدأ التسوق
                    </button>
                </div>`;
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
                // نستخدم map مع index لأننا نحتاج الـ index للحذف والتعديل الدقيق
                container.innerHTML = cart.map((item, index) => {
                    // تحديد الصورة بناءً على اللون المختار
                    let displayImage = item.image;
                    if (item.selectedColor && item.variants) {
                        const variant = item.variants.find(v => v.color === item.selectedColor);
                        if (variant && variant.image) displayImage = variant.image;
                    }

                    return `
                    <div class="group flex gap-4 p-4 bg-white border border-stone-100 rounded-2xl hover:border-stone-300 hover:shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)] transition-all duration-300 relative overflow-hidden">
                        <!-- Image -->
                        <div class="h-24 w-24 flex-shrink-0 bg-stone-50 rounded-xl overflow-hidden border border-stone-100 relative">
                            <img src="${displayImage}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-700">
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <div class="flex justify-between items-start gap-2">
                                    <h3 class="font-bold text-stone-900 text-sm leading-snug line-clamp-2 hover:text-blue-600 transition-colors cursor-pointer" onclick="viewProduct('${item.id}'); toggleCart(false)">${item.name}</h3>
                                    <button onclick="removeFromCartByIndex(${index})" class="text-stone-300 hover:text-red-500 transition-colors p-1 -mt-1 -ml-1 rounded-full hover:bg-red-50"><i data-lucide="x" size="16"></i></button>
                                </div>
                                <p class="text-[10px] text-stone-400 mt-1 font-bold tracking-wider uppercase">${item.category}</p>
                                ${item.selectedColor ? `<p class="text-[10px] text-stone-500 mt-1 bg-stone-50 inline-block px-1.5 py-0.5 rounded border border-stone-100">اللون: ${item.selectedColor}</p>` : ''}
                            </div>
                            
                            <!-- Controls -->
                            <div class="flex justify-between items-end mt-3">
                                <p class="text-base font-serif font-bold text-stone-900">$${item.price}</p>
                                
                                <div class="flex items-center gap-3 bg-stone-50 rounded-lg p-1 border border-stone-100">
                                    <button onclick="updateQuantityByIndex(${index}, -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors disabled:opacity-50 hover:text-stone-900"><i data-lucide="minus" size="14"></i></button>
                                    <span class="w-6 text-center text-sm font-bold text-stone-800 select-none">${item.quantity}</span>
                                    <button onclick="updateQuantityByIndex(${index}, 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded-md shadow-sm hover:bg-stone-200 text-stone-600 transition-colors hover:text-stone-900"><i data-lucide="plus" size="14"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function updateFavoritesUI() {
            // Simplified: Only update badge
            const badge = document.getElementById('fav-badge');
            if(badge) badge.classList.toggle('hidden', favorites.length === 0);
        }

        function updateMegaMenu() {
            const list = document.getElementById('mega-menu-categories-list');
            const popularList = document.getElementById('mega-menu-popular-list');
            const mobList = document.getElementById('mobile-cats-list');
            
            // 1. Update List Column (Modern Text List - Limited to 3)
            if (list) {
                // عرض أول 3 أقسام فقط
                const visibleCats = CATEGORIES.slice(0, 3);
                
                let listHTML = visibleCats.map(cat => `
                    <li>
                        <button onclick="filterCategory('${cat.name}'); setView('shop')" class="flex items-center justify-between w-full p-3 rounded-xl hover:bg-stone-50 transition-all group text-right">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded bg-stone-100 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <img src="${cat.image}" class="w-full h-full object-cover rounded" onerror="this.style.display='none'">
                                </div>
                                <span class="font-bold text-sm text-stone-500 group-hover:text-stone-900 transition-colors">${cat.name}</span>
                            </div>
                            <i data-lucide="chevron-left" size="14" class="text-stone-300 group-hover:text-stone-900 group-hover:-translate-x-1 transition-all opacity-0 group-hover:opacity-100"></i>
                        </button>
                    </li>
                `).join('');

                // إضافة زر "تسوق المزيد" إذا كان هناك أكثر من 3 أقسام
                if (CATEGORIES.length > 3) {
                    listHTML += `
                    <li>
                        <button onclick="setView('categories')" class="flex items-center gap-3 w-full p-3 rounded-xl hover:bg-stone-50 transition-all group text-right mt-1">
                            <div class="w-6 h-6 rounded bg-stone-50 flex items-center justify-center text-stone-400 group-hover:text-stone-900 group-hover:bg-stone-200 transition-colors">
                                <i data-lucide="more-horizontal" size="14"></i>
                            </div>
                            <span class="font-bold text-sm text-stone-400 group-hover:text-stone-900 transition-colors">تسوق المزيد من الأقسام...</span>
                        </button>
                    </li>
                    `;
                }

                list.innerHTML = listHTML;
            }

            // 2. Update Popular Grid Column (Visual Cards)
            if (popularList) {
                // UPDATED: Display first 4 categories instead of 3
                const popularCats = CATEGORIES.slice(0, 4); 
                
                if (popularCats.length === 0) {
                    popularList.innerHTML = `<p class="col-span-4 text-center text-stone-400 py-12">لا توجد أقسام للعرض.</p>`;
                } else {
                    popularList.innerHTML = popularCats.map((cat, index) => `
                        <div onclick="filterCategory('${cat.name}'); setView('shop')" class="relative h-64 rounded-2xl overflow-hidden cursor-pointer group shadow-sm hover:shadow-xl transition-all duration-500 border border-stone-100 bg-stone-50">
                            <img src="${cat.image}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 ease-out" loading="lazy">
                            
                            <!-- Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/10 to-transparent opacity-80 group-hover:opacity-90 transition-opacity"></div>
                            
                            <!-- Content -->
                            <div class="absolute bottom-0 left-0 w-full p-4 translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h4 class="text-white font-bold text-lg mb-1">${cat.name}</h4>
                                <div class="flex items-center gap-2 text-white/70 text-[10px] font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75">
                                    <span>تصفح</span>
                                    <i data-lucide="arrow-left" size="10"></i>
                                </div>
                            </div>
                            
                            <!-- Floating Icon -->
                            <div class="absolute top-3 right-3 w-7 h-7 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white border border-white/20 opacity-0 group-hover:opacity-100 transition-all duration-300 -translate-y-2 group-hover:translate-y-0">
                                <i data-lucide="arrow-up-left" size="12"></i>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // 3. Update Mobile List (unchanged logic, just ensuring it runs)
            if (mobList) {
                mobList.innerHTML = CATEGORIES.map(cat => `
                    <button onclick="filterCategory('${cat.name}'); setView('shop'); toggleMobileMenu()" class="w-full py-3 text-center text-sm text-stone-600 hover:bg-stone-50 flex items-center justify-center gap-3">
                        <img src="${cat.image}" class="w-8 h-8 rounded-lg object-cover border border-stone-200">
                        ${cat.name}
                    </button>
                `).join('');
            }
            lucide.createIcons();
        }

        function applyShopFilters() {
            const grid = document.getElementById('shop-products-grid');
            const empty = document.getElementById('shop-empty-state');
            const count = document.getElementById('results-count');
            
            if (!grid) return;

            let filtered = PRODUCTS.filter(p => {
                const s = shopState.search;
                const matchesSearch = p.name.toLowerCase().includes(s) || (p.description && p.description.toLowerCase().includes(s));
                const matchesCat = shopState.categories.length === 0 || shopState.categories.includes(p.category);
                const matchesPrice = p.price >= shopState.priceMin && p.price <= shopState.priceMax;
                return matchesSearch && matchesCat && matchesPrice;
            });

            if (shopState.sort === 'price-low') filtered.sort((a, b) => a.price - b.price);
            else if (shopState.sort === 'price-high') filtered.sort((a, b) => b.price - a.price);
            else if (shopState.sort === 'newest') filtered.reverse();

            if (count) count.innerText = `النتائج: ${filtered.length}`;
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                if(empty) empty.classList.remove('hidden');
            } else {
                if(empty) empty.classList.add('hidden');
                grid.innerHTML = filtered.map(p => createProductCard(p)).join('');
            }
            lucide.createIcons();
        }

        // --- Render Views ---
        function renderView() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            
            if (currentView === 'home') {
                renderHero(main); 
                renderCategoryBar(main); // NEW: Add Category Bar here
                renderFeatured(main);
                renderCategorySections(main); // NEW: Add Category Sections here
            } else if (currentView === 'shop') {
                renderShop(main);
            } else if (currentView === 'offers') { // NEW ROUTE
                renderOffers(main);
            } else if (currentView === 'categories') {
                renderCategoriesView(main);
            } else if (currentView === 'about') {
                renderAbout(main);
            } else if (currentView === 'contact') {
                renderContact(main);
            } else if (currentView === 'return-policy') {
                renderReturnPolicy(main);
            } else if (currentView === 'faq') { // NEW ROUTE
                renderFAQ(main);
            } else if (currentView === 'product-details') {
                renderProductDetails(main);
            } else if (currentView === 'admin') {
                renderAdmin(main);
            } else if (currentView === 'orders') {
                renderOrders(main);
            } else if (currentView === 'login') {
                renderLogin(main);
            } else if (currentView === 'track-order') {
                renderTrackOrder(main);
            } else if (currentView === 'favorites') {
                renderFavoritesPage(main);
            }
            lucide.createIcons();
        }

        // NEW: Render Offers Page
        function renderOffers(c) {
            const now = Date.now();
            // Filter products with active discounts
            // 1. Products with discount AND future expiry (Timed Offers)
            let timedOffers = PRODUCTS.filter(p => p.discount > 0 && p.discountExpiry && p.discountExpiry > now);
            // 2. Products with discount but NO expiry (Permanent Offers)
            let untimedOffers = PRODUCTS.filter(p => p.discount > 0 && !p.discountExpiry);
            
            // Sort timed offers by expiry (soonest first)
            timedOffers.sort((a, b) => a.discountExpiry - b.discountExpiry);
            
            const allOffers = [...timedOffers, ...untimedOffers];

            c.innerHTML = `
            <div class="pt-32 pb-20 min-h-screen bg-red-50/20">
                <div class="container mx-auto px-4 md:px-6">
                    <div class="text-center mb-12 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-red-100 text-red-600 mb-4 shadow-sm border border-red-200 animate-pulse"><i data-lucide="timer" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">العروض الخاطفة</h1>
                        <p class="text-stone-500 text-base md:text-lg">اغتنم الفرصة! خصومات حصرية لفترة محدودة.</p>
                    </div>

                    ${allOffers.length === 0 ? `
                        <div class="text-center py-20 bg-white rounded-3xl shadow-sm border border-stone-100 max-w-2xl mx-auto fade-in-up">
                            <div class="w-24 h-24 bg-stone-100 text-stone-300 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="tag" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">لا توجد عروض نشطة حالياً</h3>
                            <p class="text-stone-500 mb-8">تابعنا قريباً للحصول على أقوى الخصومات.</p>
                            <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all">تصفح كل المنتجات</button>
                        </div>
                    ` : `
                        <!-- Updated Grid: 4 columns on XL screens, increased gap -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-4 md:gap-6 fade-in-up" style="animation-delay: 0.1s;">
                            ${allOffers.map(p => {
                                const finalPrice = (p.price * (1 - p.discount / 100)).toFixed(2);
                                return `
                                <div class="group bg-white rounded-2xl border border-red-100 overflow-hidden hover:shadow-lg hover:border-red-200 transition-all h-full flex flex-col relative" onclick="viewProduct('${p.id}')">
                                    
                                    <!-- Discount Badge (Smaller) -->
                                    <div class="absolute top-2 right-2 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-full z-10 shadow-md animate-bounce">
                                        -${p.discount}%
                                    </div>

                                    <!-- Image -->
                                    <div class="relative aspect-[4/5] overflow-hidden bg-stone-100">
                                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                        
                                        <!-- Countdown Overlay (Compact) -->
                                        ${p.discountExpiry ? `
                                        <div class="absolute bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm p-1.5 border-t border-red-100 flex flex-col items-center justify-center gap-1">
                                            <span class="text-[9px] font-bold text-stone-500 flex items-center gap-1"><i data-lucide="clock" size="8"></i> ينتهي خلال:</span>
                                            <div class="discount-timer scale-90 origin-center" data-expiry="${p.discountExpiry}"></div>
                                        </div>` : ''}
                                    </div>

                                    <div class="p-4 flex-1 flex flex-col gap-1">
                                        <h3 class="font-bold mb-1 text-stone-900 text-sm leading-tight line-clamp-2 group-hover:text-red-600 transition-colors">${p.name}</h3>
                                        
                                        <div class="mt-auto pt-2">
                                            <div class="flex flex-wrap items-center gap-1.5 mb-2">
                                                <span class="text-xl font-serif text-red-600 font-bold">$${finalPrice}</span>
                                                <span class="text-xs text-stone-400 line-through">$${p.price}</span>
                                            </div>
                                            
                                            <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-xl font-bold shadow-sm transition-colors flex items-center justify-center gap-1 text-sm">
                                                <i data-lucide="shopping-bag" size="16"></i> إلحق العرض
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `}
                </div>
            </div>`;
            
            startCountdown();
            lucide.createIcons();
        }

        // NEW: Render Favorites Page (Full Screen)
        function renderFavoritesPage(c) {
            const favItems = PRODUCTS.filter(p => favorites.includes(p.id));

            c.innerHTML = `
            <div class="pt-32 pb-20 min-h-screen bg-stone-50">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12 fade-in-up">
                        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
                            <i data-lucide="heart" size="32" class="fill-current"></i>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-3">قائمة الأمنيات</h1>
                        <p class="text-stone-500 font-medium">المنتجات التي حفظتها للرجوع إليها لاحقاً (${favItems.length})</p>
                    </div>

                    ${favItems.length === 0 ? `
                        <div class="max-w-md mx-auto text-center py-16 bg-white rounded-3xl shadow-sm border border-stone-100 fade-in-up" style="animation-delay: 0.1s;">
                            <div class="w-24 h-24 bg-stone-50 text-stone-300 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="heart-off" size="40"></i>
                            </div>
                            <h3 class="text-xl font-bold text-stone-900 mb-2">القائمة فارغة حالياً</h3>
                            <p class="text-stone-500 mb-8 px-6 leading-relaxed">لم تقم بإضافة أي منتجات إلى المفضلة بعد. تصفح المتجر واضغط على أيقونة القلب لحفظ ما يعجبك.</p>
                            <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto">
                                <span>تصفح المنتجات</span>
                                <i data-lucide="arrow-left" size="18"></i>
                            </button>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 fade-in-up" style="animation-delay: 0.1s;">
                            ${favItems.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-16 text-center fade-in-up" style="animation-delay: 0.2s;">
                            <button onclick="viewAllProducts()" class="inline-flex items-center gap-2 text-stone-500 font-bold hover:text-stone-900 transition-colors">
                                <i data-lucide="arrow-right" size="18"></i>
                                <span>متابعة التسوق</span>
                            </button>
                        </div>
                    `}
                </div>
            </div>`;
        }

        // NEW: Track Order Page
        function renderTrackOrder(c) {
            c.innerHTML = `
            <div class="pt-32 pb-20 container mx-auto px-6 min-h-screen">
                <div class="max-w-2xl mx-auto text-center mb-12 fade-in-up">
                    <span class="inline-block p-3 rounded-2xl bg-orange-50 text-orange-600 mb-4 shadow-sm border border-orange-100"><i data-lucide="package-search" size="32"></i></span>
                    <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">تتبع حالة طلبك</h1>
                    <p class="text-stone-500">أدخل رقم الطلب الخاص بك لمعرفة مرحلة التوصيل الحالية</p>
                </div>

                <div class="max-w-xl mx-auto fade-in-up" style="animation-delay: 0.1s;">
                    <form onsubmit="handleTrackOrderSearch(event)" class="relative mb-12">
                        <input name="orderId" required class="w-full h-14 pl-4 pr-14 border-2 border-stone-200 rounded-full text-lg focus:outline-none focus:border-stone-900 focus:ring-0 transition-colors shadow-sm text-center font-mono placeholder:font-sans" placeholder="أدخل رقم الطلب هنا...">
                        <button class="absolute top-2 right-2 h-10 w-10 bg-stone-900 text-white rounded-full flex items-center justify-center hover:bg-stone-800 transition-colors shadow-md">
                            <i data-lucide="search" size="20"></i>
                        </button>
                    </form>
                    
                    <div id="tracking-result"></div>
                </div>
            </div>`;
        }

        function renderHero(c) {
            // Use dynamic settings only (No static fallbacks)
            const mainImg = HERO_SETTINGS.mainImage;
            const secImg = HERO_SETTINGS.secondaryImage;
            const pLabel = HERO_SETTINGS.priceLabel;
            const pValue = HERO_SETTINGS.priceValue;
            const dLabel = HERO_SETTINGS.discountLabel;
            const dValue = HERO_SETTINGS.discountValue;

            // Visibility Logic
            const showMobile = HERO_SETTINGS.showHeroMobile !== false; // Default true if undefined
            const showDesktop = HERO_SETTINGS.showHeroDesktop !== false; // Default true if undefined

            let visibilityClass = "";
            if (showMobile && showDesktop) visibilityClass = "flex";
            else if (showMobile && !showDesktop) visibilityClass = "flex lg:hidden";
            else if (!showMobile && showDesktop) visibilityClass = "hidden lg:flex";
            else visibilityClass = "hidden"; // Both hidden

            if (!mainImg) {
                c.innerHTML = ``; // Hide hero if no data
                return;
            }

            c.innerHTML = `
            <div class="relative min-h-[95vh] bg-stone-50 ${visibilityClass} items-center overflow-hidden pt-20">
                <!-- Decorative Background Elements -->
                <div class="absolute inset-0 z-0">
                    <div class="absolute top-[-10%] right-[-5%] w-[600px] h-[600px] bg-orange-100/40 rounded-full blur-[100px]"></div>
                    <div class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-stone-200/40 rounded-full blur-[100px]"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-[0.03]"></div>
                </div>

                <div class="container mx-auto px-6 relative z-10 grid lg:grid-cols-12 gap-12 items-center">
                    <!-- Text Content -->
                    <div class="lg:col-span-6 space-y-8 fade-in-up order-2 lg:order-1">
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-stone-200 shadow-sm w-fit transition-transform hover:scale-105">
                            <span class="flex h-2 w-2 relative">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-orange-500"></span>
                            </span>
                            <span class="text-xs font-bold tracking-wider uppercase text-stone-600">جديد: بديل الخشب والرخام</span>
                        </div>
                        
                        <h1 class="text-5xl md:text-6xl lg:text-7xl font-bold leading-[1.1] text-stone-900 tracking-tight">
                            جدران تنبض <br/>
                            <span class="relative inline-block">
                                <span class="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-stone-800">بالفخامة والحياة</span>
                                <span class="absolute bottom-2 right-0 w-full h-3 bg-green-100/50 -z-0 -rotate-1"></span>
                            </span>
                        </h1>
                        
                        <p class="text-lg text-stone-600 max-w-lg leading-relaxed">
                            حول مساحتك العادية إلى تحفة فنية مع أحدث صيحات تجاليد الحوائط. 
                            نقدم لك بديل الخشب وبديل الرخام بجودة عالية ولمسات عصرية تدوم طويلاً.
                        </p>
                        
                        <div class="flex flex-wrap gap-4 pt-2">
                            <button onclick="viewAllProducts()" class="group bg-stone-900 text-white px-8 py-4 rounded-2xl font-bold hover:bg-stone-800 transition-all flex items-center gap-3 shadow-lg hover:shadow-xl hover:-translate-y-1 ring-4 ring-stone-900/10">
                                تسوق التشكيلة <i data-lucide="arrow-left" class="group-hover:-translate-x-1 transition-transform"></i>
                            </button>
                            <button onclick="setView('contact')" class="px-8 py-4 rounded-2xl font-bold text-stone-600 hover:bg-white hover:shadow-md transition-all border border-stone-200 bg-white/50 backdrop-blur-sm">
                                طلب معاينة
                            </button>
                        </div>

                        <!-- Trust Features -->
                        <div class="grid grid-cols-3 gap-4 pt-6 border-t border-stone-200/60">
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center text-orange-600 mb-2"><i data-lucide="droplets" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">مقاوم للماء</h4>
                                <p class="text-[10px] text-stone-500">ضمان عدم التأثر بالرطوبة</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-stone-100 flex items-center justify-center text-stone-600 mb-2"><i data-lucide="hammer" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">سهل التركيب</h4>
                                <p class="text-[10px] text-stone-500">يركب على جميع الأسطح</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600 mb-2"><i data-lucide="shield-check" size="20"></i></div>
                                <h4 class="font-bold text-stone-900 text-sm">ضمان 5 سنوات</h4>
                                <p class="text-[10px] text-stone-500">ضد عيوب الصناعة</p>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Content -->
                    <div class="lg:col-span-6 relative h-[600px] fade-in-up order-1 lg:order-2" style="animation-delay: 0.2s;">
                        <!-- Main Image Shape -->
                        <div class="absolute inset-0 z-10">
                            <div class="relative w-full h-full">
                                <!-- Large Image (WPC Wall) -->
                                <div class="absolute top-0 right-0 w-[85%] h-[85%] rounded-[3rem] overflow-hidden shadow-2xl z-10 border-4 border-white">
                                    <img src="${mainImg}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-[2s]">
                                    
                                    <!-- Floating Price Tag -->
                                    <div class="absolute top-8 left-8 bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-lg animate-bounce duration-[3000ms]">
                                        <p class="text-xs text-stone-500 font-bold mb-1">${pLabel}</p>
                                        <p class="text-xl font-bold text-stone-900 font-serif">${pValue}</p>
                                    </div>
                                </div>
                                
                                <!-- Secondary Image (Marble) - Floating -->
                                <div class="absolute bottom-0 left-0 w-[55%] h-[45%] rounded-[2rem] overflow-hidden shadow-2xl z-20 border-4 border-white translate-x-4 -translate-y-8">
                                    <img src="${secImg}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-[2s]">
                                    
                                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-4">
                                        <p class="text-white font-bold text-sm">بديل الرخام الفاخر</p>
                                    </div>
                                </div>

                                <!-- Decorative Circle -->
                                <div class="absolute top-[40%] right-[-5%] w-32 h-32 rounded-full border-2 border-orange-500/20 z-0"></div>
                                <div class="absolute bottom-[10%] left-[40%] w-20 h-20 rounded-full bg-stone-900 z-30 flex items-center justify-center text-white shadow-xl">
                                    <div class="text-center leading-none">
                                        <span class="block text-xl font-bold">${dValue}</span>
                                        <span class="text-[0.6rem] opacity-80">${dLabel}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderFeatured(c) {
            // 1. Render Best Sellers (Existing Logic)
            c.innerHTML += `
            <!-- UPDATED: Reduced padding to pt-12 pb-2 -->
            <div class="pt-12 pb-2 container mx-auto px-6 border-t border-stone-100">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <span class="text-xs font-bold text-green-600 tracking-wider uppercase mb-1 block">خيارات العملاء</span>
                        <h3 class="text-2xl md:text-3xl font-bold text-stone-900">الأكثر مبيعاً</h3>
                    </div>
                    <!-- REMOVED BUTTONS FROM HERE -->
                </div>
                
                <!-- WRAPPER for Relative Positioning of Arrows -->
                <div class="relative group/slider">
                    <!-- Right Arrow (Scroll Right / Prev) -->
                    <button onclick="document.getElementById('featured-slider').scrollBy({ left: 300, behavior: 'smooth' })" class="absolute top-1/2 -right-4 lg:-right-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-right" size="24"></i>
                    </button>

                    <!-- Slider Container -->
                    <div id="featured-slider" class="flex overflow-x-auto scrollbar-hide snap-x pb-8 pt-4 -mx-3 px-3 scroll-smooth">
                        ${PRODUCTS.slice(0, 8).map(p => {
                            return `
                            <!-- UPDATED: Width is 1/4 on desktop (4 items), 1/3 on tablet, 1/2 on mobile -->
                            <div class="w-1/2 md:w-1/3 lg:w-1/4 flex-shrink-0 snap-start px-3 group cursor-pointer">
                                ${createProductCard(p)}
                            </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Left Arrow (Scroll Left / Next) -->
                    <button onclick="document.getElementById('featured-slider').scrollBy({ left: -300, behavior: 'smooth' })" class="absolute top-1/2 -left-4 lg:-left-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 -translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-left" size="24"></i>
                    </button>
                </div>
            </div>`;

            // NEW: Render Best Seller Banner (If Enabled)
            if (HERO_SETTINGS.showBestSellerBanner && HERO_SETTINGS.bestSellerBannerUrl) {
                 c.innerHTML += `
                    <div class="container mx-auto px-6 mb-4 fade-in-up">
                        <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                            <img src="${HERO_SETTINGS.bestSellerBannerUrl}" 
                                 style="height: ${HERO_SETTINGS.bestSellerBannerHeight || 200}px; width: ${HERO_SETTINGS.bestSellerBannerWidth || 100}%; object-fit: cover;" 
                                 alt="Best Seller Promo Banner">
                        </div>
                    </div>`;
            }

            // 2. Render Featured Products (Existing Logic)
            const featuredProducts = PRODUCTS.filter(p => p.isFeatured);
            
            if (featuredProducts.length > 0) {
                c.innerHTML += `
                <!-- UPDATED: Reduced padding to pt-4 pb-12 -->
                <div class="pt-4 pb-12 bg-yellow-50/50 border-t border-stone-100">
                    <div class="container mx-auto px-6">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <span class="text-xs font-bold text-yellow-600 tracking-wider uppercase mb-1 block">اختياراتنا لك</span>
                                <h3 class="text-2xl md:text-3xl font-bold text-stone-900 flex items-center gap-2"><i data-lucide="star" class="text-yellow-500 fill-yellow-500" size="24"></i> منتجات مميزة</h3>
                            </div>
                            <!-- REMOVED BUTTONS FROM HERE -->
                        </div>
                        
                        <!-- WRAPPER for Relative Positioning of Arrows -->
                        <div class="relative group/slider">
                            <!-- Right Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: 300, behavior: 'smooth' })" class="absolute top-1/2 -right-4 lg:-right-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                                <i data-lucide="chevron-right" size="24"></i>
                            </button>

                            <!-- Slider Container -->
                            <div id="special-slider" class="flex overflow-x-auto scrollbar-hide snap-x pb-8 pt-4 -mx-3 px-3 scroll-smooth">
                                ${featuredProducts.map(p => {
                                    return `
                                    <!-- UPDATED: Width is 1/4 on desktop (4 items), 1/3 on tablet, 1/2 on mobile -->
                                    <div class="w-1/2 md:w-1/3 lg:w-1/4 flex-shrink-0 snap-start px-3 group cursor-pointer">
                                        ${createProductCard(p)}
                                    </div>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Left Arrow -->
                            <button onclick="document.getElementById('special-slider').scrollBy({ left: -300, behavior: 'smooth' })" class="absolute top-1/2 -left-4 lg:-left-6 -translate-y-1/2 z-20 w-12 h-12 bg-white/80 backdrop-blur-md border border-stone-200 rounded-full flex items-center justify-center text-stone-800 shadow-lg hover:bg-stone-900 hover:text-white hover:scale-110 transition-all duration-300 opacity-0 group-hover/slider:opacity-100 -translate-x-4 group-hover/slider:translate-x-0 hidden md:flex">
                                <i data-lucide="chevron-left" size="24"></i>
                            </button>
                        </div>
                    </div>
                </div>`;

                // NEW: Render Featured Banner (If Enabled & Featured Products Exist)
                if (HERO_SETTINGS.showFeaturedBanner && HERO_SETTINGS.featuredBannerUrl) {
                     c.innerHTML += `
                        <div class="container mx-auto px-6 mt-8 mb-8 fade-in-up">
                            <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                                <img src="${HERO_SETTINGS.featuredBannerUrl}" 
                                     style="height: ${HERO_SETTINGS.featuredBannerHeight || 200}px; width: ${HERO_SETTINGS.featuredBannerWidth || 100}%; object-fit: cover;" 
                                     alt="Featured Promo Banner">
                            </div>
                        </div>`;
                }
            }
        }

        // NEW: Render Category Sections (Full Grid 5 cols)
        function renderCategorySections(c) {
            // 1. Filter valid categories (only those containing products)
            const activeCategories = CATEGORIES.filter(cat => PRODUCTS.some(p => p.category === cat.name));

            if (activeCategories.length === 0) return;

            let visibleHTML = '';
            let hiddenHTML = '';

            // Loop through valid categories
            activeCategories.forEach((cat, index) => {
                // Get products for this category
                let catProducts = PRODUCTS.filter(p => p.category === cat.name);
                
                // Randomize products
                catProducts = catProducts.sort(() => 0.5 - Math.random());

                // Logic for "Show More" items within the category (Products inside section)
                const initialLimit = 25;
                const visibleProducts = catProducts.slice(0, initialLimit);
                const hiddenProducts = catProducts.slice(initialLimit);
                const hasHidden = hiddenProducts.length > 0;
                const hiddenContainerId = `more-products-${index}`;
                const btnId = `btn-more-${index}`;

                const sectionHTML = `
                <!-- Category Section -->
                <div class="py-4 border-t border-stone-100 bg-white">
                    <div class="container mx-auto px-6">
                        <!-- Category Header -->
                        <div class="flex items-center gap-4 mb-6 mt-4">
                            <div class="w-12 h-12 rounded-xl bg-stone-50 border border-stone-200 overflow-hidden shrink-0">
                                <img src="${cat.image}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-stone-900">${cat.name}</h3>
                            </div>
                            <button onclick="filterCategory('${cat.name}'); setView('shop')" class="mr-auto text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100">
                                عرض الكل <i data-lucide="arrow-left" size="14"></i>
                            </button>
                        </div>

                        <!-- Products Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            ${visibleProducts.map(p => createProductCard(p)).join('')}
                        </div>

                        <!-- Hidden Products Container (Inside Section) -->
                        ${hasHidden ? `
                        <div id="${hiddenContainerId}" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mt-6 hidden fade-in-up">
                            ${hiddenProducts.map(p => createProductCard(p)).join('')}
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button id="${btnId}" onclick="document.getElementById('${hiddenContainerId}').classList.remove('hidden'); this.style.display='none';" class="inline-flex items-center gap-2 text-stone-500 hover:text-stone-900 text-sm font-bold transition-all hover:bg-stone-50 px-4 py-2 rounded-lg">
                                <span>عرض المزيد من ${cat.name}</span>
                                <i data-lucide="chevron-down" size="16"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                // Split into visible (first 3) and hidden (rest)
                if (index < 3) {
                    visibleHTML += sectionHTML;
                } else {
                    hiddenHTML += sectionHTML;
                }
            });

            // Append Visible Sections
            c.innerHTML += visibleHTML;

            // Append Hidden Sections Button & Container if there are more
            if (hiddenHTML) {
                c.innerHTML += `
                <div id="hidden-categories-wrapper" class="hidden fade-in-up">
                    ${hiddenHTML}
                </div>
                
                <div id="show-more-cats-btn-container" class="py-8 text-center bg-stone-50/30 border-t border-stone-100 mt-4">
                    <button onclick="document.getElementById('hidden-categories-wrapper').classList.remove('hidden'); document.getElementById('show-more-cats-btn-container').style.display='none';" class="group bg-white border-2 border-stone-200 text-stone-600 px-8 py-3.5 rounded-full font-bold hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all shadow-sm hover:shadow-lg flex items-center gap-3 mx-auto text-sm">
                        <span>عرض المزيد من الأقسام</span>
                        <div class="w-6 h-6 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center group-hover:bg-white/20 group-hover:text-white transition-colors">
                            <i data-lucide="chevron-down" size="16"></i>
                        </div>
                    </button>
                </div>
                `;
            }

            lucide.createIcons();
        }

        function renderShop(c) {
            // Use the helper function directly
            const catsHTML = generateCategoryFilterHTML();
            
            let adminBlock = '';
            if (user && user.email === ADMIN_EMAIL) {
                adminBlock = `
                <div class="bg-gradient-to-br from-stone-50 to-white border border-stone-200 rounded-2xl p-5 mb-6 shadow-sm">
                    <h3 class="font-bold mb-4 flex items-center gap-2 text-stone-900 text-sm border-b border-stone-100 pb-2"><i data-lucide="shield-check" class="text-blue-600" size="16"></i> لوحة الإدارة السريعة</h3>
                    <div class="space-y-3">
                        <button onclick="currentEditProduct=null; setAdminView('products')" class="w-full flex items-center justify-center gap-2 bg-white border border-stone-200 hover:border-blue-600 text-stone-600 hover:text-blue-600 py-3 rounded-xl text-xs font-bold transition-all shadow-sm group">
                            <i data-lucide="package-plus" size="16" class="group-hover:scale-110 transition-transform"></i> إضافة منتج
                        </button>
                        <button onclick="currentEditCategoryName=null; setAdminView('categories')" class="w-full flex items-center justify-center gap-2 bg-white border border-stone-200 hover:border-blue-600 text-stone-600 hover:text-blue-600 py-3 rounded-xl text-xs font-bold transition-all shadow-sm group">
                            <i data-lucide="folder-plus" size="16" class="group-hover:scale-110 transition-transform"></i> إضافة قسم
                        </button>
                    </div>
                </div>`;
            }

            c.innerHTML = `<div class="bg-[#FAFAFA] min-h-screen pt-28 pb-20">
                <div class="container mx-auto px-4 md:px-6">
                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        
                        <!-- Sidebar Filters (Sticky on Desktop) -->
                        <aside class="w-full lg:w-1/4 lg:sticky lg:top-28 space-y-6 fade-in-up transition-all">
                            ${adminBlock}
                            
                            <!-- Search Box -->
                            <div class="bg-white p-1 rounded-2xl shadow-sm border border-stone-100">
                                <div class="relative group">
                                    <input class="w-full bg-stone-50 border-transparent p-4 pl-12 rounded-xl text-sm font-medium focus:bg-white focus:ring-2 focus:ring-stone-900 focus:outline-none transition-all placeholder:text-stone-400 text-stone-900" oninput="updateShopFilters('search',this.value)" value="${shopState.search}" placeholder="عن ماذا تبحث؟">
                                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 group-focus-within:text-stone-900 transition-colors" size="20"></i>
                                </div>
                            </div>

                            <!-- Filter Container -->
                            <div class="bg-white rounded-3xl shadow-sm border border-stone-100 overflow-hidden">
                                <div class="p-6 border-b border-stone-50 flex justify-between items-center bg-white">
                                    <h3 class="font-bold text-lg text-stone-900 flex items-center gap-2"><i data-lucide="sliders-horizontal" size="18"></i> تصفية النتائج</h3>
                                    ${shopState.categories.length > 0 || shopState.priceMax < 10000 ? `<button onclick="resetFilters()" class="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors">مسح الكل</button>` : ''}
                                </div>
                                
                                <div class="p-6 space-y-8">
                                    <!-- Categories (Added ID) -->
                                    <div>
                                        <h4 class="font-bold text-sm text-stone-400 uppercase tracking-wider mb-4">التصنيفات</h4>
                                        <div id="shop-categories-list" class="space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                            ${catsHTML}
                                        </div>
                                    </div>

                                    <!-- Price Range (Updated to Min/Max Inputs) -->
                                    <div>
                                        <h4 class="font-bold text-sm text-stone-400 uppercase tracking-wider mb-4">نطاق السعر</h4>
                                        <div class="flex items-center gap-3">
                                            <div class="relative w-full group">
                                                <label class="text-[10px] font-bold text-stone-400 absolute -top-2 right-2 bg-white px-1">من</label>
                                                <input type="number" min="0" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="0" value="${shopState.priceMin}" oninput="updateShopFilters('priceMin', this.value)">
                                                <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-400 text-xs font-serif">$</span>
                                            </div>
                                            
                                            <span class="text-stone-300 font-bold text-lg">-</span>
                                            
                                            <div class="relative w-full group">
                                                <label class="text-[10px] font-bold text-stone-400 absolute -top-2 right-2 bg-white px-1">إلى</label>
                                                <input type="number" min="0" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white transition-all text-center dir-ltr" placeholder="1000" value="${shopState.priceMax}" oninput="updateShopFilters('priceMax', this.value)">
                                                <span class="absolute top-1/2 left-3 -translate-y-1/2 text-stone-400 text-xs font-serif">$</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </aside>

                        <!-- Products Grid Area -->
                        <div class="w-full lg:w-3/4">
                            <!-- Top Bar -->
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm fade-in-up" style="animation-delay: 0.1s;">
                                <div class="flex items-center gap-2">
                                    <div class="p-2 bg-stone-50 rounded-lg text-stone-500"><i data-lucide="layout-grid" size="18"></i></div>
                                    <p id="results-count" class="text-stone-600 font-bold text-sm"></p>
                                </div>
                                
                                <div class="flex items-center gap-3 w-full sm:w-auto">
                                    <span class="text-xs font-bold text-stone-400 whitespace-nowrap">ترتيب حسب:</span>
                                    <div class="relative w-full sm:w-48">
                                        <select onchange="updateShopFilters('sort',this.value)" class="w-full appearance-none border border-stone-200 bg-stone-50 p-2.5 pl-8 pr-4 rounded-xl text-sm font-bold text-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:bg-white cursor-pointer transition-colors">
                                            <option value="featured">المميز (الافتراضي)</option>
                                            <option value="price-low">السعر: الأقل أولاً</option>
                                            <option value="price-high">السعر: الأعلى أولاً</option>
                                            <option value="newest">الأحدث إضافة</option>
                                        </select>
                                        <i data-lucide="chevron-down" size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Products Grid (UPDATED to 4 Columns) -->
                            <div id="shop-products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6"></div>
                            
                            <!-- Empty State -->
                            <div id="shop-empty-state" class="hidden flex flex-col items-center justify-center py-24 bg-white rounded-3xl border border-stone-100 shadow-sm text-center">
                                <div class="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                    <i data-lucide="search-x" class="text-stone-300" size="32"></i>
                                </div>
                                <h3 class="text-xl font-bold text-stone-900 mb-2">عذراً، لم نجد نتائج</h3>
                                <p class="text-stone-500 text-sm max-w-xs mx-auto mb-8">حاول البحث بكلمات مختلفة أو قم بإزالة بعض الفلاتر.</p>
                                <button onclick="resetFilters()" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
                                    <i data-lucide="refresh-cw" size="16"></i> إعادة تعيين الفلاتر
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            applyShopFilters();
        }

        // NEW: Render Category Bar (Stories Style)
        function renderCategoryBar(c) {
            // Only render if we have categories, but we always render the "All" button at least
            
            // UPDATE: قمت بتغيير pt-10 إلى pt-32 لزيادة المسافة العلوية وضمان عدم التداخل مع الهيدر
            c.innerHTML += `
            <div class="pt-32 pb-4 container mx-auto px-6 fade-in-up group/cat" style="animation-delay: 0.3s;">
                <div class="flex items-center gap-2 mb-6">
                    <span class="w-1 h-6 bg-stone-900 rounded-full"></span>
                    <h3 class="font-bold text-stone-900 text-lg">تسوق حسب القسم</h3>
                </div>
                
                <div class="relative" onmouseenter="stopAutoScroll('category-scroll-container')" onmouseleave="startAutoScroll('category-scroll-container')">
                    <!-- Right Arrow Button -->
                    <button onclick="document.getElementById('category-scroll-container').scrollBy({ left: 200, behavior: 'smooth' })" class="absolute -right-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-white border border-stone-200 rounded-full flex items-center justify-center shadow-lg text-stone-600 hover:bg-stone-900 hover:text-white transition-all opacity-0 group-hover/cat:opacity-100 translate-x-2 group-hover/cat:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-right" size="20"></i>
                    </button>

                    <!-- Scroll Container -->
                    <div id="category-scroll-container" class="flex gap-4 overflow-x-auto scrollbar-hide snap-x py-4 px-1 scroll-smooth">
                        <!-- Static "All" Bubble -->
                        <div onclick="viewAllProducts()" class="flex flex-col items-center gap-3 min-w-[80px] cursor-pointer group snap-start transition-transform hover:-translate-y-1">
                            <div class="w-20 h-20 rounded-full bg-stone-900 text-white flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-300 border-2 border-stone-900 ring-2 ring-stone-100 ring-offset-2">
                                <i data-lucide="grid-2x2" size="28"></i>
                            </div>
                            <span class="text-xs font-bold text-stone-900">الكل</span>
                        </div>

                        <!-- Dynamic Categories -->
                        ${CATEGORIES.map(cat => `
                            <div onclick="filterCategory('${cat.name}'); setView('shop')" class="flex flex-col items-center gap-3 min-w-[80px] cursor-pointer group snap-start transition-transform hover:-translate-y-1">
                                <div class="w-20 h-20 rounded-full p-[2px] border-2 border-green-500/30 group-hover:border-green-600 transition-colors relative">
                                    <div class="w-full h-full rounded-full overflow-hidden bg-stone-100 shadow-sm group-hover:shadow-md transition-all ring-2 ring-white">
                                        <img src="${cat.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" onerror="this.src='https://via.placeholder.com/150?text=${cat.name}'">
                                    </div>
                                </div>
                                <span class="text-xs font-bold text-stone-600 group-hover:text-stone-900 transition-colors text-center truncate w-full px-1">${cat.name}</span>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Left Arrow Button -->
                    <button onclick="document.getElementById('category-scroll-container').scrollBy({ left: -200, behavior: 'smooth' })" class="absolute -left-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-white border border-stone-200 rounded-full flex items-center justify-center shadow-lg text-stone-600 hover:bg-stone-900 hover:text-white transition-all opacity-0 group-hover/cat:opacity-100 -translate-x-2 group-hover/cat:translate-x-0 hidden md:flex">
                        <i data-lucide="chevron-left" size="20"></i>
                    </button>
                </div>
            </div>`;

            // NEW: Render Category Banner (If Enabled)
            if (HERO_SETTINGS.showCategoryBanner && HERO_SETTINGS.categoryBannerUrl) {
                 c.innerHTML += `
                    <div class="container mx-auto px-6 mt-4 fade-in-up" style="animation-delay: 0.4s;">
                        <div class="w-full flex justify-center overflow-hidden rounded-2xl shadow-sm border border-stone-100">
                            <img src="${HERO_SETTINGS.categoryBannerUrl}" 
                                 style="height: ${HERO_SETTINGS.categoryBannerHeight || 200}px; width: ${HERO_SETTINGS.categoryBannerWidth || 100}%; object-fit: cover;" 
                                 alt="Category Promo Banner">
                        </div>
                    </div>`;
            }

            // Start Auto Scroll
            setTimeout(() => startAutoScroll('category-scroll-container'), 1000);
        }

        // NEW: Auto Scroll Logic Helpers
        let scrollTimers = {};

        window.startAutoScroll = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // Clear existing to avoid duplicates
            if (scrollTimers[id]) clearInterval(scrollTimers[id]);

            scrollTimers[id] = setInterval(() => {
                const element = document.getElementById(id);
                // Safety check if element removed from DOM
                if (!element) {
                    clearInterval(scrollTimers[id]);
                    return;
                }

                // RTL Logic: 
                // In RTL, scrollLeft starts at 0 (Right side) and goes negative as we scroll Left.
                // We need to scroll LEFT (negative value) to see next items.
                
                const maxScroll = element.scrollWidth - element.clientWidth;
                
                // If content fits, no need to scroll
                if (maxScroll <= 0) return;

                const currentScroll = Math.abs(element.scrollLeft);
                
                // Check if we reached the end (Left side) with small tolerance
                if (currentScroll >= maxScroll - 10) {
                    // Reset to Start (Right side)
                    element.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // Scroll Left (Forward in RTL)
                    element.scrollBy({ left: -200, behavior: 'smooth' });
                }
            }, 3000); // Move every 3 seconds
        };

        window.stopAutoScroll = (id) => {
            if (scrollTimers[id]) {
                clearInterval(scrollTimers[id]);
                delete scrollTimers[id];
            }
        };

        function renderCategoriesView(c) {
            const html = CATEGORIES.map((cat, index) => {
                return `
                <div onclick="filterCategory('${cat.name}')" class="group cursor-pointer flex flex-col gap-3 fade-in-up" style="animation-delay: ${index * 0.05}s">
                    <div class="relative aspect-square rounded-[2rem] overflow-hidden bg-stone-100 shadow-sm border border-stone-100 group-hover:shadow-xl group-hover:-translate-y-1 transition-all duration-500">
                        <img src="${cat.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 ease-out" loading="lazy">
                        
                        <!-- Modern Overlay on Hover -->
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-500"></div>
                        
                        <!-- Floating Action Button -->
                        <div class="absolute bottom-4 left-4 w-10 h-10 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center text-stone-900 shadow-lg opacity-0 translate-y-4 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 delay-75 hover:bg-stone-900 hover:text-white">
                             <i data-lucide="arrow-up-left" size="18"></i>
                        </div>
                    </div>
                    
                    <div class="text-center px-2">
                        <h3 class="font-bold text-stone-900 text-sm md:text-base group-hover:text-stone-600 transition-colors">${cat.name}</h3>
                        <div class="w-1 h-1 bg-stone-300 rounded-full mx-auto mt-2 group-hover:w-6 group-hover:bg-stone-900 transition-all duration-300"></div>
                    </div>
                </div>`;
            }).join('');

            c.innerHTML = `
            <div class="pt-32 pb-20 min-h-screen bg-white">
                <div class="container mx-auto px-6">
                    <!-- Modern Header -->
                    <div class="text-center max-w-2xl mx-auto mb-16 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-stone-50 text-stone-500 mb-4 shadow-sm border border-stone-100"><i data-lucide="layers" size="32"></i></span>
                        <h1 class="text-4xl md:text-5xl font-bold text-stone-900 mb-4 tracking-tight">تصنيفات المتجر</h1>
                        <p class="text-stone-500 text-lg leading-relaxed">اختر القسم المناسب لتصفح منتجاتنا المميزة.</p>
                    </div>

                    <!-- Updated Categories Grid: 4 columns on XL -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6 md:gap-8">
                        ${html}
                    </div>

                    <!-- Call to Action -->
                    <div class="mt-20 text-center fade-in-up border-t border-stone-100 pt-10" style="animation-delay: 0.3s;">
                        <button onclick="viewAllProducts()" class="bg-stone-900 text-white px-8 py-3.5 rounded-full font-bold hover:bg-stone-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 mx-auto">
                            <span>عرض جميع المنتجات</span>
                            <i data-lucide="grid-2x2" size="18"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function renderAdmin(c) {
            if (!user || user.email !== ADMIN_EMAIL) {
                if (user && !user.isAnonymous) {
                     c.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center text-center px-4"><div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-6"><i data-lucide="shield-alert" size="40"></i></div><h1 class="text-2xl font-bold text-stone-900 mb-2">غير مصرح بالدخول</h1><p class="text-stone-500 mb-8">هذه الصفحة مخصصة للمسؤولين فقط.</p><button onclick="setView('home')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold">العودة للرئيسية</button></div>`;
                     return;
                }
                setView('login');
                return;
            }
            
            const isEdit = !!currentEditProduct;
            const p = currentEditProduct || {};
            const extraImages = p.images ? p.images.slice(1).join('\n') : '';
            const variantsString = p.variants ? p.variants.map(v => `${v.color}: ${v.image}`).join('\n') : '';
            // Helper to format timestamp to datetime-local string (YYYY-MM-DDTHH:MM)
            const expiryDateStr = p.discountExpiry 
                ? new Date(p.discountExpiry - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) 
                : '';

            const features = p.features ? p.features.join('\n') : '';
            const specsString = p.specifications ? p.specifications.map(s => `${s.label}: ${s.value}`).join('\n') : '';
            const defaultServices = [
                "banknote: الدفع نقداً عند الاستلام",
                "truck: توصيل مجاني",
                "rotate-ccw: 15 يوم للإرجاع",
                "shield-check: تسوق آمن",
                "badge-check: جودة مضمونة"
            ].join('\n');
            const servicesString = p.services ? p.services.map(s => `${s.icon}: ${s.text}`).join('\n') : defaultServices;

            const pendingReviews = ALL_REVIEWS.filter(r => r.status === 'pending');
            
            // Category Edit Variables
            const editCatObj = currentEditCategoryName ? CATEGORIES.find(c => c.name === currentEditCategoryName) : null;
            const catNameVal = editCatObj ? editCatObj.name : '';
            const catImgVal = editCatObj ? editCatObj.image : '';

            // Helper for active tab style
            const getTabClass = (tabName) => {
                return currentAdminTab === tabName 
                    ? "bg-stone-900 text-white shadow-md" 
                    : "bg-white text-stone-600 hover:bg-stone-100";
            };

            c.innerHTML = `
            <div class="pt-24 pb-20 container mx-auto px-4 min-h-screen bg-stone-50/50">
                <div class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto">
                    
                    <!-- Sidebar Navigation -->
                    <aside class="w-full lg:w-64 flex-shrink-0 space-y-2">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-200 mb-4">
                            <h2 class="font-bold text-stone-900 flex items-center gap-2 mb-1"><i data-lucide="layout-dashboard" size="18"></i> لوحة التحكم</h2>
                            <p class="text-xs text-stone-400">أهلاً بك، المدير</p>
                        </div>

                        <button onclick="setAdminView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('dashboard')}">
                            <i data-lucide="activity" size="18"></i> المراجعات والملخص
                        </button>
                        
                        <button onclick="setAdminView('orders')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('orders')}">
                            <i data-lucide="shopping-bag" size="18"></i> طلبات العملاء
                            ${ALL_ORDERS.filter(o => !o.isArchived).length > 0 ? `<span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full mr-auto">${ALL_ORDERS.filter(o => !o.isArchived).length}</span>` : ''}
                        </button>

                        <button onclick="currentEditProduct=null; setAdminView('products')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('products')}">
                            <i data-lucide="package-plus" size="18"></i> إدارة المنتجات
                        </button>
                        
                        <button onclick="currentEditCategoryName=null; setAdminView('categories')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('categories')}">
                            <i data-lucide="folder-plus" size="18"></i> إدارة الأقسام
                        </button>
                        
                        <button onclick="setAdminView('settings')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm transition-all ${getTabClass('settings')}">
                            <i data-lucide="settings" size="18"></i> إعدادات الواجهة
                        </button>

                         <div class="pt-4 mt-4 border-t border-stone-200">
                             <button onclick="setView('home')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-sm text-stone-600 hover:bg-red-50 hover:text-red-600 transition-colors">
                                <i data-lucide="log-out" size="18"></i> خروج من اللوحة
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="flex-1 min-w-0">
                        
                        <!-- 1. DASHBOARD TAB -->
                        ${currentAdminTab === 'dashboard' ? `
                            <div class="space-y-6 fade-in-up">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">إجمالي المنتجات</div>
                                        <div class="text-3xl font-bold text-stone-900">${PRODUCTS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">إجمالي الطلبات</div>
                                        <div class="text-3xl font-bold text-stone-900">${ALL_ORDERS.length}</div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-100">
                                        <div class="text-stone-400 text-xs font-bold uppercase mb-2">المراجعات المعلقة</div>
                                        <div class="text-3xl font-bold ${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-900'}">${pendingReviews.length}</div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                                    <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                        <i data-lucide="message-square-warning" class="${pendingReviews.length > 0 ? 'text-orange-500' : 'text-stone-400'}"></i> 
                                        التعليقات والمراجعات
                                    </h3>
                                    ${pendingReviews.length === 0 ? `<div class="text-center py-12 bg-stone-50 rounded-2xl border border-dashed border-stone-200"><p class="text-stone-500 font-medium">لا توجد تعليقات معلقة حالياً</p></div>` : 
                                    `<div class="space-y-4">${pendingReviews.map(r => {
                                        const prod = PRODUCTS.find(p => p.id === r.productId);
                                        return `<div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 flex flex-col md:flex-row gap-6 justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-3 mb-2"><span class="font-bold text-stone-900 text-lg">${r.userName}</span><div class="flex text-yellow-400 text-xs">${Array(r.rating).fill('<i data-lucide="star" class="w-3 h-3 fill-current"></i>').join('')}</div></div>
                                                <p class="text-stone-500 text-xs mb-2">عن منتج: <span class="font-bold text-stone-800">${prod ? prod.name : 'منتج محذوف'}</span></p>
                                                <p class="text-stone-700 font-medium bg-white p-3 rounded-xl border border-orange-100">"${r.comment}"</p>
                                            </div>
                                            <div class="flex flex-col gap-3 w-full md:w-auto min-w-[200px]">
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded-xl border border-orange-200 hover:border-orange-400 transition-colors">
                                                    <input type="checkbox" id="verify-check-${r.id}" class="w-4 h-4 accent-green-600 rounded cursor-pointer">
                                                    <span class="text-xs font-bold text-stone-700 select-none">شراء تم التحقق منه</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <button onclick="handleReviewAction('${r.id}', 'approve')" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 shadow-sm">موافقة</button>
                                                    <button onclick="handleReviewAction('${r.id}', 'reject')" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-red-700 shadow-sm">رفض</button>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}</div>`}
                                </div>
                            </div>
                        ` : ''}

                        <!-- 2. ORDERS TAB (Integrated Here) -->
                        ${currentAdminTab === 'orders' ? `
                            <div class="space-y-6 fade-in-up">
                                <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                                    <h2 class="font-bold text-2xl text-stone-900 flex items-center gap-2">
                                        <i data-lucide="shopping-bag" class="text-stone-900"></i> إدارة الطلبات
                                    </h2>
                                    <div class="flex p-1 bg-stone-100 rounded-xl">
                                        <button onclick="setOrderTab('active')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${currentOrderTab === 'active' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}">الجارية (${ALL_ORDERS.filter(o => !o.isArchived).length})</button>
                                        <button onclick="setOrderTab('archived')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${currentOrderTab === 'archived' ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-500 hover:text-stone-700'}">الأرشيف (${ALL_ORDERS.filter(o => o.isArchived).length})</button>
                                    </div>
                                </div>
                                ${(() => {
                                    const displayOrders = currentOrderTab === 'active' ? ALL_ORDERS.filter(o => !o.isArchived) : ALL_ORDERS.filter(o => o.isArchived);
                                    if (displayOrders.length === 0) return `<div class="bg-white p-16 rounded-3xl text-center shadow-sm border border-stone-100"><div class="w-24 h-24 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6 text-stone-300"><i data-lucide="${currentOrderTab === 'active' ? 'inbox' : 'archive'}" size="40"></i></div><h3 class="font-bold text-xl text-stone-900 mb-2">لا توجد طلبات هنا</h3></div>`;
                                    
                                    const statuses = [
                                        { val: 'new', label: 'طلب جديد' }, { val: 'payment_pending', label: 'تم التأكيد (انتظار الدفع)' },
                                        { val: 'confirmed', label: 'تم التأكيد (مدفوع)' }, { val: 'processing', label: 'جاري التجهيز' },
                                        { val: 'shipped', label: 'تم الشحن' }, { val: 'delivered', label: 'تم التوصيل' }
                                    ];

                                    return displayOrders.map(order => {
                                        const date = new Date(order.createdAt).toLocaleString('ar-EG');
                                        
                                        // --- تفاصيل رسالة الواتساب (التنسيق الجديد) ---
                                        const trackingUrl = `${window.location.origin}${window.location.pathname}#/track-order`;
                                        const whatsappMsg = `مرحبًا ${order.customer.name}،

أتواصل مع حضرتك بخصوص الطلب رقم (${order.id}).

يُرجى إتمام الدفع بمبلغ (${order.totalAmount} ج.م) ليتم تجهيز الشحنة الخاصة بحضرتك.

ومن المتوقع أن تصل الشحنة خلال يوم إلى 3 أيام عمل.
في حال التحويل الإلكتروني، يُرجى إرسال وصل الدفع بعد التحويل.

وفي حال رغبتك في تعديل الطلب:
يُرجى الدخول إلى رابط تتبع الشحنة:
${trackingUrl}
ثم إدراج كود الطلب الخاص بك، والضغط على "إرسال تعديل" مع كتابة الرسالة التي تحتوي على التعديلات المطلوبة.`;
                                        // --------------------------------------

                                        return `
                                        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden group mb-4">
                                            <div class="bg-stone-50 p-4 border-b border-stone-100 flex justify-between items-center gap-2 flex-wrap">
                                                <div class="flex items-center gap-2 max-w-full">
                                                    <!-- تعديل هنا: عرض الرقم بالكامل مع إمكانية النسخ -->
                                                    <div class="flex items-center bg-white px-3 py-1.5 rounded-lg border border-stone-200 shadow-sm group/id cursor-pointer" onclick="navigator.clipboard.writeText('${order.id}'); showToast('تم نسخ رقم الطلب')">
                                                        <span class="font-mono font-bold text-stone-700 text-xs select-all break-all" title="${order.id}">#${order.id}</span>
                                                        <i data-lucide="copy" size="12" class="text-stone-400 mr-2 opacity-0 group-hover/id:opacity-100 transition-opacity"></i>
                                                    </div>
                                                    <span class="text-xs text-stone-400 font-medium dir-ltr whitespace-nowrap">${date}</span>
                                                </div>
                                                
                                                <div class="relative mt-2 sm:mt-0">
                                                     <select onchange="handleOrderStatusChange('${order.id}', this.value)" class="bg-white border border-stone-300 text-stone-700 text-xs font-bold rounded-lg py-1.5 px-3 pr-8 appearance-none focus:outline-none focus:border-stone-900 cursor-pointer shadow-sm" ${currentOrderTab === 'archived' ? 'disabled' : ''}>
                                                        ${statuses.map(s => `<option value="${s.val}" ${order.status === s.val ? 'selected' : ''}>${s.label}</option>`).join('')}
                                                    </select>
                                                    <i data-lucide="chevron-down" class="absolute left-2 top-1/2 -translate-y-1/2 text-stone-400 pointer-events-none" size="14"></i>
                                                </div>
                                            </div>

                                            <div class="p-6 grid lg:grid-cols-2 gap-6">
                                                <div class="space-y-4">
                                                    
                                                    <!-- Pending Modification Request Alert (ADMIN ONLY) -->
                                                    ${order.modificationRequest && order.modificationRequest.status === 'pending' ? `
                                                    <div class="col-span-2 bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg mb-4 animate-pulse">
                                                        <div class="flex justify-between items-start gap-4">
                                                            <div>
                                                                <h4 class="font-bold text-orange-800 text-sm flex items-center gap-2"><i data-lucide="alert-triangle" size="16"></i> طلب تعديل من العميل</h4>
                                                                <p class="text-orange-700 text-sm mt-1">"${order.modificationRequest.message}"</p>
                                                            </div>
                                                            <div class="flex gap-2 shrink-0">
                                                                <button onclick="handleModDecision('${order.id}', 'approved')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">موافقة</button>
                                                                <button onclick="handleModDecision('${order.id}', 'rejected')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">رفض</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    ` : ''}

                                                    <div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center shrink-0"><i data-lucide="user" size="18" class="text-stone-500"></i></div><div><p class="font-bold text-stone-900">${order.customer.name}</p><p class="text-sm text-stone-500 font-mono dir-ltr text-right"><a href="tel:${order.customer.phone}">${order.customer.phone}</a></p><p class="text-sm text-stone-600 mt-1 bg-stone-50 p-2 rounded border border-stone-100">${order.customer.address}</p></div></div>
                                                    <a href="https://wa.me/20${order.customer.phone.replace(/^0+/, '')}?text=${encodeURIComponent(whatsappMsg)}" target="_blank" class="flex items-center justify-center gap-2 w-full bg-[#25D366]/10 text-[#25D366] py-2.5 rounded-xl font-bold hover:bg-[#25D366] hover:text-white transition-all text-xs"><i data-lucide="message-circle" size="16"></i> مراسلة واتساب</a>
                                                </div>
                                                <div class="space-y-3">
                                                    <div class="bg-stone-50 rounded-xl p-3 border border-stone-100 max-h-40 overflow-y-auto custom-scrollbar">
                                                        ${order.items.map(item => `<div class="flex gap-3 items-center mb-2 last:mb-0"><img src="${item.image}" class="w-8 h-8 rounded object-cover border border-stone-200"><div class="flex-1 min-w-0"><p class="text-xs font-bold text-stone-800 truncate">${item.name}</p><p class="text-[10px] text-stone-500">${item.quantity} x $${item.price}</p></div><span class="text-xs font-bold text-stone-900">$${item.price * item.quantity}</span></div>`).join('')}
                                                    </div>
                                                    <div class="flex justify-between items-center px-2"><span class="font-bold text-stone-600 text-sm">الإجمالي</span><span class="font-serif text-lg font-bold text-stone-900">$${order.totalAmount}</span></div>
                                                </div>
                                            </div>
                                            <div class="bg-stone-50 p-3 border-t border-stone-100 flex justify-end gap-2">
                                                 <button onclick="handleOrderAction('${order.id}', 'delete')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="حذف"><i data-lucide="trash-2" size="16"></i></button>
                                                 <button onclick="openEditOrderModal('${order.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-transparent hover:border-blue-100" title="تعديل"><i data-lucide="pen-line" size="16"></i></button>
                                                 ${currentOrderTab === 'active' ? `<button onclick="handleOrderAction('${order.id}', 'archive')" class="px-4 py-2 bg-white border border-stone-200 text-stone-600 hover:text-stone-900 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">أرشفة</button>` : `<button onclick="handleOrderAction('${order.id}', 'restore')" class="px-4 py-2 bg-white border border-stone-200 text-stone-600 hover:text-stone-900 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">استعادة</button>`}
                                            </div>
                                        </div>`;
                                    }).join('');
                                })()}
                            </div>
                        ` : ''}

                        <!-- 3. PRODUCTS TAB -->
                        ${currentAdminTab === 'products' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${isEdit ? 'pen-line' : 'package-plus'}" class="text-blue-600"></i>
                                        ${isEdit ? `<span class="text-blue-600">تعديل المنتج: ${p.name}</span>` : 'إضافة منتج جديد'}
                                    </h2>
                                    ${isEdit ? `<button onclick="cancelEdit()" class="text-stone-400 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-stone-50 rounded-lg transition-colors">إلغاء وعودة للإضافة</button>` : ''}
                                </div>

                                <form onsubmit="handleSaveProduct(event)" class="space-y-8">
                                    <div class="grid md:grid-cols-2 gap-8">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">اسم المنتج <span class="text-red-500">*</span></label>
                                                <input name="prodName" value="${p.name || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none transition-all bg-stone-50 focus:bg-white placeholder:text-stone-300" placeholder="مثال: لوح بديل خشب">
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="space-y-2">
                                                    <label class="text-xs font-bold text-stone-500 uppercase">السعر <span class="text-red-500">*</span></label>
                                                    <div class="relative">
                                                        <input name="prodPrice" type="number" step="0.01" value="${p.price || ''}" required class="w-full border border-stone-200 p-3.5 pl-8 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="0.00">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">$</span>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <label class="text-xs font-bold text-stone-500 uppercase">الخصم %</label>
                                                    <input name="prodDiscount" type="number" min="0" max="100" value="${p.discount || 0}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="0">
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 gap-4">
                                                <!-- Expiry Date Field -->
                                                <div class="space-y-2 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                    <label class="text-xs font-bold text-orange-800 uppercase flex items-center gap-1"><i data-lucide="timer" size="14"></i> تاريخ انتهاء الخصم</label>
                                                    <input name="prodExpiry" type="datetime-local" value="${expiryDateStr}" class="w-full border border-orange-200 p-2 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none bg-white text-stone-700 dir-ltr">
                                                    <p class="text-[10px] text-orange-600">اتركه فارغاً إذا كان الخصم دائم</p>
                                                </div>

                                                <!-- NEW: Featured Product Checkbox -->
                                                <div class="flex items-center gap-3 bg-yellow-50 p-4 rounded-xl border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition-colors" onclick="document.getElementById('prodFeatured').click()">
                                                    <input type="checkbox" name="prodFeatured" id="prodFeatured" class="w-5 h-5 accent-yellow-500 rounded cursor-pointer" onclick="event.stopPropagation()" ${p.isFeatured ? 'checked' : ''}>
                                                    <label for="prodFeatured" class="text-sm font-bold text-yellow-800 cursor-pointer select-none flex items-center gap-2">
                                                        <i data-lucide="star" size="16" class="fill-yellow-500 text-yellow-600"></i> منتج مميز (يظهر في قسم خاص)
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">القسم <span class="text-red-500">*</span></label>
                                                <select name="prodCat" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white cursor-pointer">
                                                    ${CATEGORIES.map(c => `<option ${p.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="space-y-2">
                                                 <label class="text-xs font-bold text-stone-500 uppercase">العلامة التجارية</label>
                                                 <input name="prodBrand" value="${p.brand || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="اسم البراند (اختياري)">
                                            </div>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">رابط الصورة الرئيسية <span class="text-red-500">*</span></label>
                                                <input name="prodImg" value="${p.image || ''}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left" placeholder="${HERO_SETTINGS.imageBaseUrl ? 'أدخل اسم الملف فقط (مثل: image_01)' : 'https://example.com/image.jpg'}">
                                                ${HERO_SETTINGS.imageBaseUrl ? `<p class="text-[10px] text-blue-600 dir-rtl">سيتم الدمج تلقائياً مع: ${HERO_SETTINGS.imageBaseUrl} وامتداد ${HERO_SETTINGS.imageDefaultExt || '.webp'}</p>` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">صور إضافية (رابط في كل سطر)</label>
                                                <textarea name="prodImages" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="https://...&#10;https://...">${extraImages}</textarea>
                                            </div>
                                            <!-- NEW: Variants Field -->
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase flex items-center gap-1"><i data-lucide="palette" size="14"></i> ألوان المنتج (اسم اللون : رابط الصورة)</label>
                                                <textarea name="prodVariants" rows="3" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left custom-scrollbar" placeholder="Red: https://...&#10;Blue: https://...">${variantsString}</textarea>
                                                <p class="text-[10px] text-stone-400">أدخل كل لون في سطر جديد. سيتم عرض هذه الألوان كخيارات للعميل.</p>
                                            </div>
                                             <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المادة (Material)</label>
                                                <input name="prodMaterial" value="${p.material || ''}" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="مثال: خشب زان">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-8 pt-4 border-t border-stone-100">
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">وصف المنتج</label>
                                                <textarea name="prodDesc" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="وصف تفصيلي للمنتج...">${p.description || ''}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المميزات (نقطة في كل سطر)</label>
                                                <textarea name="prodFeatures" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="- ميزة 1&#10;- ميزة 2">${features}</textarea>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">المواصفات (الاسم: القيمة)</label>
                                                <textarea name="prodSpecs" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="الطول: 120 سم&#10;الوزن: 5 كجم">${specsString}</textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase">الخدمات (أيقونة: نص)</label>
                                                <textarea name="prodServices" rows="4" class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-right" placeholder="truck: توصيل مجاني">${servicesString}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="w-full ${isEdit ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-4 rounded-xl font-bold transition-all text-lg shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex justify-center items-center gap-2">
                                        <i data-lucide="${isEdit ? 'save' : 'plus-circle'}"></i>
                                        ${isEdit ? 'حفظ التعديلات' : 'إضافة المنتج للمتجر'}
                                    </button>
                                </form>
                            </div>
                        ` : ''}

                        <!-- 4. CATEGORIES TAB -->
                        ${currentAdminTab === 'categories' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="${currentEditCategoryName ? 'pen-line' : 'folder-plus'}" class="text-blue-600"></i>
                                        ${currentEditCategoryName ? `تعديل قسم: <span class="text-blue-600">${currentEditCategoryName}</span>` : 'إدارة الأقسام'}
                                    </h2>
                                    ${currentEditCategoryName ? `<button onclick="cancelEditCategory()" class="text-stone-400 font-bold text-sm hover:text-stone-600 px-4 py-2 hover:bg-stone-50 rounded-lg transition-colors">إلغاء التعديل</button>` : ''}
                                </div>

                                <form onsubmit="handleAddCategory(event)" class="max-w-xl space-y-6">
                                    <div>
                                        <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">اسم القسم <span class="text-red-500">*</span></label>
                                        <input name="catName" value="${catNameVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white" placeholder="مثال: ديكورات حائط">
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">صورة القسم (رابط) <span class="text-red-500">*</span></label>
                                        <input name="catImg" value="${catImgVal}" required class="w-full border border-stone-200 p-3.5 rounded-xl focus:ring-2 focus:ring-stone-900 outline-none bg-stone-50 focus:bg-white dir-ltr text-left" placeholder="https://...">
                                    </div>

                                    <button class="w-full ${currentEditCategoryName ? 'bg-blue-600 hover:bg-blue-700' : 'bg-stone-900 hover:bg-stone-800'} text-white py-3.5 rounded-xl font-bold transition-all shadow-md flex justify-center items-center gap-2">
                                        <i data-lucide="${currentEditCategoryName ? 'save' : 'plus'}"></i>
                                        ${currentEditCategoryName ? 'حفظ التغييرات' : 'إضافة القسم'}
                                    </button>
                                </form>

                                <div class="mt-12">
                                    <h3 class="font-bold text-lg text-stone-900 mb-4 border-b border-stone-100 pb-2">الأقسام الحالية</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${CATEGORIES.map(c => `
                                            <div class="flex items-center gap-4 bg-stone-50 p-3 rounded-xl border border-stone-200 group hover:border-stone-300 transition-colors">
                                                <div class="w-16 h-16 rounded-lg bg-white overflow-hidden border border-stone-100 shrink-0">
                                                    <img src="${c.image}" class="w-full h-full object-cover">
                                                </div>
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-stone-900">${c.name}</h4>
                                                    <p class="text-xs text-stone-400">قسم نشط</p>
                                                </div>
                                                <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onclick="prepareEditCategory('${c.name}')" class="p-2 bg-white text-blue-600 border border-blue-100 hover:bg-blue-50 rounded-lg transition-colors shadow-sm"><i data-lucide="pen-line" size="16"></i></button>
                                                    <button onclick="handleDeleteCategory('${c.name}')" class="p-2 bg-white text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition-colors shadow-sm"><i data-lucide="trash-2" size="16"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- 5. SETTINGS TAB (RESTORED) -->
                        ${currentAdminTab === 'settings' ? `
                            <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100 fade-in-up">
                                <div class="flex justify-between items-center mb-8 pb-6 border-b border-stone-100">
                                    <h2 class="font-bold text-2xl flex gap-2 items-center text-stone-900">
                                        <i data-lucide="layout-template" class="text-stone-900"></i>
                                        إعدادات الموقع والواجهة
                                    </h2>
                                </div>

                                <form onsubmit="handleSaveHeroSettings(event)" class="space-y-8 max-w-3xl">
                                    
                                    <!-- NEW: Image Configuration Settings -->
                                    <div class="space-y-4 p-6 bg-blue-50 rounded-2xl border border-blue-200">
                                        <h3 class="font-bold text-blue-800 flex items-center gap-2"><i data-lucide="image-plus"></i> تكوين روابط الصور (تلقائي)</h3>
                                        <div class="grid md:grid-cols-3 gap-6">
                                            <div class="md:col-span-2">
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط القاعدة (Base URL)</label>
                                                <input name="imgBaseUrl" value="${HERO_SETTINGS.imageBaseUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder="https://example.com/images/">
                                                <p class="text-[10px] text-stone-500 mt-1">المسار الثابت الذي ترفع عليه صور منتجاتك</p>
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الامتداد الافتراضي</label>
                                                <input name="imgExt" value="${HERO_SETTINGS.imageDefaultExt || '.webp'}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-900 outline-none dir-ltr bg-white" placeholder=".webp">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logo Settings -->
                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="image-plus"></i> هوية الموقع (الشعار)</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط الشعار (Logo URL)</label>
                                                <input name="siteLogo" value="${HERO_SETTINGS.logoUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://... (اتركه فارغاً للنص)">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">حجم الشعار (عرض بالبكسل)</label>
                                                <div class="relative">
                                                    <input name="logoSize" type="number" value="${HERO_SETTINGS.logoSize || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="100">
                                                    <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Header Banner Settings -->
                                    <div class="space-y-4 p-6 bg-orange-50 rounded-2xl border border-orange-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-orange-600 flex items-center gap-2"><i data-lucide="monitor"></i> بانر إعلاني (أسفل الهيدر)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="fbShow" class="w-5 h-5 accent-orange-600 rounded" ${HERO_SETTINGS.showFooterBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-orange-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="fbUrl" value="${HERO_SETTINGS.footerBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="fbHeight" type="number" value="${HERO_SETTINGS.footerBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="fbWidth" type="number" value="${HERO_SETTINGS.footerBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-orange-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Category Banner Settings -->
                                    <div class="space-y-4 p-6 bg-green-50 rounded-2xl border border-green-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-green-600 flex items-center gap-2"><i data-lucide="layout"></i> بانر إعلاني (أسفل الأقسام)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="catBanShow" class="w-5 h-5 accent-green-600 rounded" ${HERO_SETTINGS.showCategoryBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-green-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="catBanUrl" value="${HERO_SETTINGS.categoryBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-green-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="catBanHeight" type="number" value="${HERO_SETTINGS.categoryBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-green-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="catBanWidth" type="number" value="${HERO_SETTINGS.categoryBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-green-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Best Seller Banner Settings -->
                                    <div class="space-y-4 p-6 bg-purple-50 rounded-2xl border border-purple-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-purple-600 flex items-center gap-2"><i data-lucide="trending-up"></i> بانر إعلاني (أسفل الأكثر مبيعاً)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="bsBanShow" class="w-5 h-5 accent-purple-600 rounded" ${HERO_SETTINGS.showBestSellerBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-purple-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="bsBanUrl" value="${HERO_SETTINGS.bestSellerBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="bsBanHeight" type="number" value="${HERO_SETTINGS.bestSellerBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="bsBanWidth" type="number" value="${HERO_SETTINGS.bestSellerBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-purple-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Featured Banner Settings -->
                                    <div class="space-y-4 p-6 bg-yellow-50 rounded-2xl border border-yellow-200">
                                        <div class="flex justify-between items-center">
                                            <h3 class="font-bold text-yellow-600 flex items-center gap-2"><i data-lucide="star"></i> بانر إعلاني (أسفل المنتجات المميزة)</h3>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="ftBanShow" class="w-5 h-5 accent-yellow-600 rounded" ${HERO_SETTINGS.showFeaturedBanner ? 'checked' : ''}>
                                                <span class="text-sm font-bold text-yellow-800">تفعيل البانر</span>
                                            </label>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">رابط صورة البانر</label>
                                                <input name="ftBanUrl" value="${HERO_SETTINGS.featuredBannerUrl || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div class="grid grid-cols-2 gap-6">
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الارتفاع (Height px)</label>
                                                    <div class="relative">
                                                        <input name="ftBanHeight" type="number" value="${HERO_SETTINGS.featuredBannerHeight || '200'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="200">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">px</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">العرض (Width %)</label>
                                                    <div class="relative">
                                                        <input name="ftBanWidth" type="number" value="${HERO_SETTINGS.featuredBannerWidth || '100'}" class="w-full border border-stone-200 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-yellow-600 outline-none dir-ltr bg-white" placeholder="100">
                                                        <span class="absolute left-3 top-3.5 text-stone-400 text-xs font-bold">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hero Settings -->
                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                            <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="image"></i> الصور الرئيسية (Hero Section)</h3>
                                            
                                            <!-- Hero Visibility Controls -->
                                            <div class="flex gap-3">
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-stone-200 hover:border-blue-300 transition-colors">
                                                    <input type="checkbox" name="heroShowMobile" class="w-4 h-4 accent-blue-600 rounded" ${HERO_SETTINGS.showHeroMobile !== false ? 'checked' : ''}>
                                                    <span class="text-xs font-bold text-stone-700 flex items-center gap-1"><i data-lucide="smartphone" size="14"></i> إظهار في الهاتف</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-stone-200 hover:border-blue-300 transition-colors">
                                                    <input type="checkbox" name="heroShowDesktop" class="w-4 h-4 accent-blue-600 rounded" ${HERO_SETTINGS.showHeroDesktop !== false ? 'checked' : ''}>
                                                    <span class="text-xs font-bold text-stone-700 flex items-center gap-1"><i data-lucide="monitor" size="14"></i> إظهار في الكمبيوتر</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الصورة الكبيرة (الخلفية)</label>
                                                <input name="heroMain" value="${HERO_SETTINGS.mainImage || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الصورة الصغيرة (الأمامية)</label>
                                                <input name="heroSec" value="${HERO_SETTINGS.secondaryImage || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none dir-ltr bg-white" placeholder="https://...">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="tag"></i> بطاقة السعر العائم</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">النص العلوي</label>
                                                <input name="heroPriceLabel" value="${HERO_SETTINGS.priceLabel || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="يبدأ من">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">السعر المعروض</label>
                                                <input name="heroPriceValue" value="${HERO_SETTINGS.priceValue || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="250 ج.م">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-4 p-6 bg-stone-50 rounded-2xl border border-stone-200">
                                        <h3 class="font-bold text-blue-600 flex items-center gap-2"><i data-lucide="percent"></i> دائرة الخصم</h3>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">قيمة الخصم</label>
                                                <input name="heroDiscValue" value="${HERO_SETTINGS.discountValue || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="20%">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-stone-500 uppercase mb-2 block">الوصف المختصر</label>
                                                <input name="heroDiscLabel" value="${HERO_SETTINGS.discountLabel || ''}" class="w-full border border-stone-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-stone-900 outline-none bg-white" placeholder="خصم خاص">
                                            </div>
                                        </div>
                                    </div>

                                    <button class="w-full bg-stone-900 text-white hover:bg-stone-800 py-4 rounded-xl font-bold transition-all shadow-lg flex justify-center items-center gap-2">
                                        <i data-lucide="save"></i> حفظ وتحديث الإعدادات
                                    </button>
                                </form>
                            </div>
                        ` : ''}

                    </div>
                </div>
            </div>`;
        }

        function renderLogin(c) {
            c.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-stone-50 px-6 pt-20">
                    <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl max-w-md w-full text-center space-y-8 fade-in-up">
                        <div class="flex justify-center mb-4"><div class="p-4 bg-stone-100 rounded-full"><i data-lucide="shield-check" size="32" class="text-stone-900"></i></div></div>
                        <div>
                            <h2 class="text-3xl font-serif font-bold text-stone-900 mb-2">دخول المالك</h2>
                            <p class="text-stone-500 text-sm leading-relaxed">هذه المنطقة محظورة ومخصصة فقط لإدارة المتجر بواسطة المالك.<br>أي محاولة دخول بحساب آخر سيتم رفضها.</p>
                        </div>
                        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-stone-900 text-white font-bold py-4 rounded-xl hover:bg-stone-800 transition-all hover:shadow-lg group">
                            <svg class="w-5 h-5 bg-white rounded-full p-0.5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            <span>تسجيل الدخول (المالك فقط)</span>
                        </button>
                        <button onclick="setView('home')" class="text-sm text-stone-400 hover:text-stone-900 underline underline-offset-4">العودة للرئيسية كزائر</button>
                    </div>
                </div>
            `;
        }

        function renderContact(c) {
            // ... existing contact code ...
            c.innerHTML = `
            <div class="pt-32 pb-20 container mx-auto px-6 min-h-screen bg-stone-50/30">
                <!-- ... existing content ... -->
                <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto fade-in-up" style="animation-delay: 0.1s;">
                    <!-- ... cards ... -->
                    <a href="https://wa.me/201014175070" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-[#25D366]"></div>
                        <div class="w-16 h-16 bg-[#25D366]/10 text-[#25D366] rounded-2xl flex items-center justify-center mb-6 group-hover:bg-[#25D366] group-hover:text-white transition-colors">
                            <i data-lucide="message-circle" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">واتساب المعرض</h3>
                        <p class="text-stone-500 text-sm mb-4">تحدث معنا مباشرة لخدمة أسرع</p>
                        <span class="font-mono dir-ltr font-bold text-stone-800 text-lg group-hover:text-[#25D366] transition-colors bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-[#25D366]/5">01014175070</span>
                    </a>

                    <a href="mailto:gedar.fayoum@gmail.com" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i data-lucide="mail" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">البريد الإلكتروني</h3>
                        <p class="text-stone-500 text-sm mb-4">راسلنا لأي استفسارات تجارية</p>
                        <span class="font-bold text-stone-800 text-sm break-all group-hover:text-blue-600 transition-colors bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-blue-50">gedar.fayoum@gmail.com</span>
                    </a>

                    <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center text-center hover:shadow-xl hover:-translate-y-1 transition-all group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-orange-600"></div>
                        <div class="w-16 h-16 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                            <i data-lucide="map-pin" size="32"></i>
                        </div>
                        <h3 class="font-bold text-xl text-stone-900 mb-2">موقع المعرض</h3>
                        <p class="text-stone-500 text-sm mb-4">الفيوم - نهاية شارع المستشفي العام إتجاه مديرية الأمن<br/>بجوار المغسلة الامريكيه وامام مطعم ابو صلاح</p>
                        <div class="flex items-center gap-2 text-stone-800 font-bold bg-stone-50 px-4 py-2 rounded-lg group-hover:bg-orange-50 group-hover:text-orange-600 transition-colors text-sm">
                            <span>عرض على الخريطة</span>
                            <i data-lucide="external-link" size="14"></i>
                        </div>
                    </a>
                </div>
                <!-- ... existing map ... -->
                <div class="mt-12 max-w-6xl mx-auto rounded-3xl overflow-hidden shadow-lg border border-stone-200 h-[400px] relative group fade-in-up" style="animation-delay: 0.2s;">
                     <a href="https://maps.app.goo.gl/UhZig4Crvg52Vq2X6" target="_blank" class="block w-full h-full relative group">
                        <div class="absolute inset-0 bg-stone-200 bg-[url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg')] bg-cover opacity-20 grayscale group-hover:grayscale-0 transition-all duration-700"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-stone-900/10 to-transparent"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 z-10">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-xl animate-bounce text-red-600">
                                <i data-lucide="map-pin" class="fill-current" size="40"></i>
                            </div>
                            <span class="bg-white/90 backdrop-blur-md px-8 py-4 rounded-full font-bold shadow-lg text-stone-900 group-hover:scale-105 transition-transform border border-white/50 flex items-center gap-2">
                                <i data-lucide="navigation" size="18"></i>
                                اضغط هنا لفتح الموقع على Google Maps
                            </span>
                        </div>
                     </a>
                </div>
            </div>`;
        }

        // NEW: Render Return Policy Page
        function renderReturnPolicy(c) {
            c.innerHTML = `
            <div class="pt-32 pb-20 container mx-auto px-6 min-h-screen">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-12 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-blue-50 text-blue-600 mb-4 shadow-sm border border-blue-100"><i data-lucide="file-text" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">سياسة الاسترجاع والاستبدال</h1>
                        <p class="text-stone-500 text-lg">نحن نحرص دائمًا على رضا عملائنا، لذلك نوفر لك سياسة استرجاع واستبدال واضحة ومرنة لضمان أفضل تجربة شراء ممكنة.</p>
                    </div>

                    <div class="space-y-8 fade-in-up" style="animation-delay: 0.1s;">
                        <!-- Section 1 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">1</div> أولًا: شروط الاسترجاع</h2>
                            <p class="text-stone-600 mb-4 font-medium">يمكنك طلب استرجاع المنتج خلال <span class="text-red-600 font-bold">14 يومًا</span> من تاريخ الاستلام في الحالات التالية:</p>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-stone-300">
                                <li>إذا كان المنتج مختلفًا عن المواصفات أو غير مطابق للوصف.</li>
                                <li>إذا وصل المنتج بعيب مصنعي أو تالفًا.</li>
                                <li>إذا تم شحن منتج غير صحيح.</li>
                            </ul>
                            <p class="mt-4 text-sm bg-yellow-50 p-3 rounded-xl text-yellow-800 border border-yellow-100 flex gap-2 items-start"><i data-lucide="alert-circle" size="16" class="mt-0.5 shrink-0"></i> يُشترط أن يكون المنتج في حالته الأصلية بدون فتح أو استخدام، وبنفس التغليف والملحقات.</p>
                        </div>

                        <!-- Section 2 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">2</div> ثانيًا: شروط الاستبدال</h2>
                            <p class="text-stone-600 mb-4 font-medium">يمكنك طلب استبدال المنتج خلال <span class="text-blue-600 font-bold">30 يومًا</span> من تاريخ الاستلام في الحالات التالية:</p>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-stone-300">
                                <li>استبدال المقاسات أو الألوان (إذا كانت متاحة).</li>
                                <li>رغبة العميل في استبدال منتج بمنتج آخر مع تحمّل فرق السعر إن وجد.</li>
                            </ul>
                        </div>

                        <!-- Section 3 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">3</div> ثالثًا: المنتجات غير القابلة للاسترجاع</h2>
                            <ul class="space-y-2 text-stone-500 list-disc list-inside marker:text-red-300">
                                <li>المنتجات المفتوحة أو المستخدمة.</li>
                                <li>المنتجات المصممة خصيصًا بطلب العميل.</li>
                                <li>العروض الخاصة التي يتم توضيح فيها عدم إمكانية الاسترجاع.</li>
                            </ul>
                        </div>

                        <!-- Section 4 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">4</div> رابعًا: خطوات تقديم طلب الاسترجاع أو الاستبدال</h2>
                            <ol class="space-y-4">
                                <li class="flex gap-4 items-start">
                                    <div class="bg-green-50 text-green-600 p-2 rounded-lg shrink-0"><i data-lucide="message-circle" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">التواصل معنا</h4>
                                        <p class="text-stone-500 text-sm">عبر خدمة العملاء عبر واتساب وإرسال رقم الطلب.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="file-question" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">تحديد السبب</h4>
                                        <p class="text-stone-500 text-sm">تحديد سبب الاسترجاع أو الاستبدال بوضوح.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="package" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">تجهيز المنتج</h4>
                                        <p class="text-stone-500 text-sm">تجهيز المنتج وتسليمه لمندوب الشحن بعد تحديد الموعد.</p>
                                    </div>
                                </li>
                                <li class="flex gap-4 items-start">
                                    <div class="bg-stone-50 text-stone-600 p-2 rounded-lg shrink-0"><i data-lucide="banknote" size="20"></i></div>
                                    <div>
                                        <h4 class="font-bold text-stone-900">استرداد المبلغ</h4>
                                        <p class="text-stone-500 text-sm">يتم استرجاع المبلغ خلال 1 - 3 ايام عمل حسب وسيلة الدفع المستخدمة.</p>
                                    </div>
                                </li>
                            </ol>
                        </div>

                        <!-- Section 5 -->
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                            <h2 class="text-xl font-bold text-stone-900 mb-4 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600">5</div> خامسًا: رسوم الشحن</h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                                    <h4 class="font-bold text-red-800 mb-2">خطأ من جانبنا</h4>
                                    <p class="text-red-700 text-sm">منتج خاطئ – تالف – غير مطابق: نحن نتحمّل تكلفة الشحن بالكامل.</p>
                                </div>
                                <div class="bg-stone-50 p-4 rounded-2xl border border-stone-200">
                                    <h4 class="font-bold text-stone-800 mb-2">رغبة العميل (دون خطأ)</h4>
                                    <p class="text-stone-600 text-sm">يتم خصم رسوم الشحن من قيمة المبلغ المسترد.</p>
                                </div>
                            </div>
                        </div>

                        <!-- CPA Contact -->
                        <div class="bg-stone-900 text-white p-8 rounded-3xl shadow-lg relative overflow-hidden">
                            <div class="relative z-10">
                                <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><i data-lucide="shield-check"></i> جهاز حماية المستهلك</h2>
                                <p class="text-stone-400 mb-6 text-sm">في حال وجود أي مشكلة لم يتم حلّها من خلال خدمة العملاء، يمكنكم التواصل مع جهاز حماية المستهلك في مصر:</p>
                                
                                <div class="grid md:grid-cols-2 gap-6 text-sm">
                                    <div>
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-1">الرقم المختصر</p>
                                        <p class="font-mono text-xl font-bold dir-ltr text-right md:text-right">19588</p>
                                    </div>
                                    <div>
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-1">البريد الإلكتروني</p>
                                        <p class="font-mono dir-ltr text-right md:text-right">info@cpa.gov.eg</p>
                                    </div>
                                    <div class="col-span-2">
                                        <p class="text-stone-500 text-xs font-bold uppercase tracking-wider mb-2">واتساب الشكاوى</p>
                                        <div class="flex flex-col gap-1 font-mono dir-ltr text-right md:text-right">
                                            <span>القاهرة الكبرى: 01577779999</span>
                                            <span>باقي المحافظات: 01555516528</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 pt-6 border-t border-white/10 text-center md:text-right">
                                    <a href="http://shakwa.cpa-mobile.com/" target="_blank" class="inline-flex items-center gap-2 text-stone-300 hover:text-white transition-colors underline decoration-stone-600 underline-offset-4">
                                        زيارة موقع تقديم الشكاوى (حماية المستهلك)
                                        <i data-lucide="external-link" size="14"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Decor -->
                            <div class="absolute top-0 left-0 w-64 h-64 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2 blur-3xl"></div>
                        </div>

                    </div>
                </div>
            </div>`;
        }

        // NEW: Render FAQ Page
        function renderFAQ(c) {
            const faqs = [
                { q: "الخامات اللي بتشتغلوا بيها مناسبة لإيه؟", a: "الخامات مناسبة لتجديد الحوائط وإضافة لمسة ديكور عصرية، وبتناسب أغلب المساحات سواء سكنية أو تجارية." },
                { q: "هل الخامات مقاومة للمياه والرطوبة؟", a: "نعم، معظم الخامات المستخدمة للحوائط مقاومة للمياه والرطوبة وبتتحمل ظروف الاستخدام اليومية." },
                { q: "هل الخامات تتحمل الحرارة؟", a: "الخامات تتحمل الحرارة الطبيعية داخل المنزل، لكن يُفضّل تجنب ملامستها لمصادر حرارة مباشرة أو لهب." },
                { q: "هل التركيب بيعيش فترة طويلة؟", a: "أيوه، مع التركيب السليم واستخدام مواد تثبيت مناسبة، الشغل بيعيش سنين بدون مشاكل." },
                { q: "هل في ضمان على الشغل؟", a: "نعم، يوجد ضمان على جودة التركيب وسلامة الخامة من أي عيب مصنعي — مدة الضمان تختلف حسب نوع الخامة." },
                { q: "ينفع أركّب فوق الحائط القديم؟", a: "طبعًا، ينفع التركيب فوق (دهان - محارة - سيراميك - أي سطح مستوي). المهم يكون نظيف وجاف." },
                { q: "هل الخامات سهلة التنظيف؟", a: "نعم، تُنظّف بسهولة باستخدام فوطة مبللة وصابون خفيف—بدون مواد كيميائية قوية." },
                { q: "هل في ألوان وسماكات متعددة؟", a: "متوفر أشكال وألوان وسماكات متنوعة تناسب أي ديكور وأي مساحة." },
                { q: "الأسعار بتشمل الخامة والتركيب؟", a: "عادةً بيتم حساب السعر حسب المساحة ونوع الخامة المختارة، وممكن يشمل التركيب حسب العرض المتفق عليه." },
                { q: "هل بتوفروا معاينة قبل التنفيذ؟", a: "نعم، نوفر معاينة للمكان لتحديد المقاسات واختيار الأنسب من الخامات." },
                { q: "التنفيذ بياخد وقت قد إيه؟", a: "على حسب المساحة، ولكن غالبًا التنفيذ بيتم في يوم واحد أو يومين." },
                { q: "هل بتشتغلوا خارج المحافظة؟", a: "نعم، نوفر شحن أو تنفيذ في محافظات مختلفة — حسب الموقع ورسوم النقل." },
                { q: "هل أقدر أرجع أو أستبدل الخامة؟", a: "نعم، طبقًا لسياسة الاسترجاع والاستبدال الخاصة بالموقع، بشرط تكون الخامة في حالتها الأصلية ولم تُستخدم." }
            ];

            c.innerHTML = `
            <div class="pt-32 pb-20 container mx-auto px-6 min-h-screen bg-stone-50/30">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-12 fade-in-up">
                        <span class="inline-block p-3 rounded-2xl bg-indigo-50 text-indigo-600 mb-4 shadow-sm border border-indigo-100"><i data-lucide="help-circle" size="32"></i></span>
                        <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-4">الأسئلة الشائعة</h1>
                        <p class="text-stone-500 text-lg">إجابات على أكثر الأسئلة تداولاً لمساعدتك في اتخاذ القرار.</p>
                    </div>

                    <div class="space-y-4 fade-in-up" style="animation-delay: 0.1s;">
                        ${faqs.map((item, idx) => `
                            <div class="bg-white rounded-2xl border border-stone-200 overflow-hidden group">
                                <button onclick="toggleFAQ(${idx})" class="w-full text-right p-6 flex justify-between items-center hover:bg-stone-50 transition-colors">
                                    <h3 class="font-bold text-stone-900 text-lg flex items-center gap-3">
                                        <span class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 text-xs font-mono">${idx + 1}</span>
                                        ${item.q}
                                    </h3>
                                    <div id="faq-icon-${idx}" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 transition-transform duration-300">
                                        <i data-lucide="chevron-down" size="20"></i>
                                    </div>
                                </button>
                                <div id="faq-content-${idx}" class="hidden px-6 pb-6 text-stone-600 leading-relaxed border-t border-stone-100 pt-4 bg-stone-50/30 mr-14">
                                    ${item.a}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-12 text-center bg-blue-50 rounded-3xl p-8 border border-blue-100 fade-in-up" style="animation-delay: 0.2s;">
                        <h3 class="font-bold text-blue-900 text-lg mb-2">لم تجد إجابة لسؤالك؟</h3>
                        <p class="text-blue-700/80 mb-6">فريقنا جاهز للرد على جميع استفساراتك عبر الواتساب.</p>
                        <a href="https://wa.me/201014175070" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                            <i data-lucide="message-circle" size="18"></i> تحدث معنا الآن
                        </a>
                    </div>
                </div>
            </div>`;
        }

        window.toggleFAQ = (idx) => {
            const content = document.getElementById(`faq-content-${idx}`);
            const icon = document.getElementById(`faq-icon-${idx}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        };

        function renderAbout(c) {
            c.innerHTML = `<div class="pt-32 container mx-auto px-6 text-center"><h1 class="text-4xl font-bold mb-8">تبسيط المنزل</h1><p class="max-w-2xl mx-auto text-stone-600">وُلدت علامة "جدار" من الرغبة في إعادة الهدوء إلى المنزل.</p></div>`;
        }

        function renderProductDetails(c) {
            // NEW: Loading State for Direct Links
            if (!isDataLoaded && PRODUCTS.length === 0) {
                c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center pt-20">
                    <div class="animate-spin w-12 h-12 border-4 border-stone-200 border-t-stone-900 rounded-full mb-4"></div>
                    <p class="text-stone-500 font-medium">جاري تحميل المنتج...</p>
                </div>`;
                return;
            }

            const p = PRODUCTS.find(x => x.id == currentProductId);
            if(!p) return c.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center text-center px-4 pt-20">
                    <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-stone-400">
                        <i data-lucide="search-x" size="40"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-stone-900 mb-2">المنتج غير موجود</h2>
                    <p class="text-stone-500 mb-6">قد يكون تم حذف المنتج أو الرابط غير صحيح.</p>
                    <button onclick="setView('shop')" class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-stone-800 transition-colors">تصفح المتجر</button>
                </div>`;
            
            const isFav = favorites.includes(p.id);
            const images = (p.images && p.images.length > 0) ? p.images : [p.image];
            const features = (p.features && p.features.length > 0) ? p.features : [];

            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)).toFixed(2) : p.price;

            // Calculate Reviews Data
            const productReviews = ALL_REVIEWS.filter(r => r.productId === p.id && r.status === 'approved');
            const totalReviews = productReviews.length;
            const averageRating = totalReviews > 0 ? (productReviews.reduce((sum, r) => sum + r.rating, 0) / totalReviews).toFixed(1) : 0;
            const counts = { 5:0, 4:0, 3:0, 2:0, 1:0 };
            productReviews.forEach(r => counts[r.rating]++);

            // --- Window function to handle color selection ---
            window.selectColor = (colorName, imageUrl) => {
                currentSelectedColor = colorName;
                
                // Update Main Image
                const mainImg = document.getElementById('main-product-image');
                if (mainImg && imageUrl) mainImg.src = imageUrl;
                
                // Update Active State of Buttons
                const allBtns = document.querySelectorAll('.variant-btn');
                allBtns.forEach(btn => {
                    if (btn.dataset.color === colorName) {
                        btn.classList.add('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.remove('border-stone-200');
                        btn.classList.add('border-stone-900');
                    } else {
                        btn.classList.remove('ring-2', 'ring-stone-900', 'ring-offset-2');
                        btn.classList.add('border-stone-200');
                        btn.classList.remove('border-stone-900');
                    }
                });
            };

            // --- Dynamic Tags Generation (NEW) ---
            // 1. Get all Category Names
            const catTags = CATEGORIES.map(c => c.name);
            
            // 2. Get Random Product Keywords (First 2-3 words of product names)
            const prodTags = PRODUCTS
                .filter(prod => prod.id !== p.id) // Exclude current product
                .map(prod => prod.name.split(' ').slice(0, 3).join(' ')) // Take first 3 words
                .sort(() => 0.5 - Math.random()) // Shuffle
                .slice(0, 12); // Take 12 items
            
            // 3. Combine & Deduplicate
            const dynamicTags = [...new Set([...catTags, ...prodTags])];

            // --- NEW: Random Sponsored Product Logic ---
            const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
            const adHTML = adProduct ? `
            <div onclick="viewProduct('${adProduct.id}')" class="w-full bg-gradient-to-r from-stone-50 via-white to-stone-50 border border-stone-200 rounded-xl p-3 mb-8 flex items-center gap-4 cursor-pointer hover:shadow-md hover:border-green-200 transition-all group animate-in fade-in slide-in-from-top-4 duration-700">
                <div class="bg-stone-200 text-stone-500 text-[10px] font-bold px-2 py-1 rounded select-none">إعلان</div>
                
                <div class="w-12 h-12 bg-white rounded-lg border border-stone-100 overflow-hidden shrink-0">
                    <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                </div>
                
                <div class="flex-1 min-w-0 flex flex-col sm:flex-row sm:items-center justify-between gap-1 sm:gap-4">
                    <div class="truncate">
                        <h4 class="font-bold text-stone-900 text-xs sm:text-sm truncate group-hover:text-green-700 transition-colors">${adProduct.name}</h4>
                        <p class="text-[10px] text-stone-500 truncate hidden sm:block">${adProduct.description ? adProduct.description.substring(0, 50) + '...' : 'تصفح هذا المنتج المميز الآن'}</p>
                    </div>
                    
                    <div class="flex items-center gap-3 shrink-0">
                        <span class="font-serif font-bold text-stone-900 text-sm sm:text-base">$${adProduct.price}</span>
                        <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-400 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-all">
                            <i data-lucide="arrow-left" size="16"></i>
                        </div>
                    </div>
                </div>
            </div>` : '';

            // --- Prepared Slider Data ---
            
            // 1. Related Products (Same Category)
            const relatedProducts = PRODUCTS.filter(prod => prod.category === p.category && prod.id !== p.id);
            
            // 2. Random Suggestions (NEW LOGIC)
            // Shuffle all products and pick 8 random ones (excluding current)
            const randomSuggestions = PRODUCTS.filter(prod => prod.id !== p.id)
                                              .sort(() => 0.5 - Math.random())
                                              .slice(0, 8);

            // 3. Browsing History
            const historyIds = JSON.parse(localStorage.getItem('gedar_history') || '[]');
            const historyProducts = historyIds.map(hId => PRODUCTS.find(prod => prod.id === hId)).filter(item => item !== undefined);

            // --- Helper: Render Slider HTML (Updated for Small Cards) ---
            const renderSliderHTML = (id, title, items, isSmall = false) => {
                if (items.length === 0) return '';
                
                // Determine width based on isSmall flag
                // UPDATE: تم تصغير العرض الافتراضي من 260px إلى 210px
                const cardWidthClass = isSmall ? 'min-w-[140px] w-[140px]' : 'min-w-[210px] w-[210px]';
                
                return `
                <div class="mt-16 border-t border-stone-100 pt-10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="${isSmall ? 'text-lg' : 'text-xl'} font-bold text-stone-900">${title}</h3>
                        <div class="flex gap-2">
                            <button onclick="scrollSection('${id}', 'prev')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600"><i data-lucide="arrow-right" size="16"></i></button>
                            <button onclick="scrollSection('${id}', 'next')" class="w-8 h-8 border border-stone-200 rounded-full hover:bg-stone-900 hover:text-white hover:border-stone-900 transition-all flex items-center justify-center text-stone-600"><i data-lucide="arrow-left" size="16"></i></button>
                        </div>
                    </div>
                    <div id="${id}" class="flex gap-4 overflow-x-auto scrollbar-hide scroll-smooth snap-x pb-4">
                        ${items.map(item => `
                            <div class="${cardWidthClass} snap-start">
                                ${isSmall ? createSmallProductCard(item) : createProductCard(item)}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            c.innerHTML = `
            <div class="bg-white min-h-screen pt-28 pb-20">
                <div class="container mx-auto px-4 lg:px-6">
                    
                    <!-- Insert The Ad Banner Here -->
                    ${adHTML}

                    <div class="flex items-center gap-2 text-sm text-stone-500 mb-8">
                        <button onclick="setView('shop')" class="hover:text-stone-900">المتجر</button><i data-lucide="chevron-left" size="14"></i>
                        <button onclick="filterCategory('${p.category}'); setView('shop')" class="hover:text-stone-900">${p.category}</button><i data-lucide="chevron-left" size="14"></i>
                        <span class="text-stone-900 font-medium truncate max-w-[200px]">${p.name}</span>
                    </div>
                    
                    <!-- Top Section: Images & Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mb-12">
                        <!-- Product Images -->
                        <div class="lg:col-span-5 flex flex-col-reverse lg:flex-row gap-4">
                            <div class="flex lg:flex-col gap-3 overflow-x-auto lg:overflow-y-auto lg:max-h-[500px] scrollbar-hide py-1 px-1">
                                ${images.map((img, idx) => `<div onmouseover="setActiveImage(${idx})" onclick="setActiveImage(${idx})" class="gallery-thumb cursor-pointer border border-stone-200 rounded-lg p-1 w-16 h-16 lg:w-20 lg:h-20 flex-shrink-0 bg-stone-50 ${idx===0?'active':''} hover:border-stone-400 transition-all"><img src="${img}" class="w-full h-full object-cover rounded-md"></div>`).join('')}
                            </div>
                            <!-- Modified Image Container: Square but constrained width/height -->
                            <div class="flex-1 bg-white rounded-2xl border border-stone-200 flex items-center justify-center relative group w-full max-w-[500px] mx-auto aspect-square overflow-hidden shadow-sm">
                                <img id="main-product-image" src="${images[0]}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                <button onclick="toggleFavorite('${p.id}')" class="absolute top-4 right-4 p-3 rounded-full bg-white/90 backdrop-blur-sm shadow-md hover:bg-white transition-all z-10"><i data-lucide="heart" class="${isFav?'text-red-500 fill-red-500':'text-stone-400'}"></i></button>
                            </div>
                        </div>

                        <!-- Product Info -->
                        <div class="lg:col-span-4 space-y-6">
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <div>
                                        ${p.brand ? `<a href="#" class="text-sm text-blue-600 hover:text-orange-600 hover:underline mb-1 inline-block font-medium">زيارة متجر ${p.brand}</a>` : ''}
                                        <h1 class="text-2xl lg:text-3xl font-bold text-stone-900 leading-tight mb-2">${p.name}</h1>
                                    </div>
                                    <button onclick="shareProduct('${p.id}')" class="w-10 h-10 rounded-full bg-stone-50 hover:bg-blue-50 text-stone-500 hover:text-blue-600 flex items-center justify-center transition-all shadow-sm border border-stone-100 shrink-0" title="مشاركة المنتج">
                                        <i data-lucide="share-2" size="20"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="flex text-yellow-400 text-sm">
                                        ${averageRating > 0 
                                            ? Array(Math.round(averageRating)).fill('<i data-lucide="star" class="fill-current w-4 h-4"></i>').join('') 
                                            : '<span class="text-stone-400 text-xs">لا توجد تقييمات</span>'}
                                    </div>
                                    <span class="text-stone-500 text-sm">(${totalReviews} تقييم)</span>
                                </div>
                            </div>
                            <div class="border-t border-b border-stone-100 py-4">
                                ${hasDiscount ? 
                                `<div class="flex items-end gap-3 mb-1">
                                    <span class="text-4xl font-bold text-red-600 font-serif">$${finalPrice}</span>
                                    <span class="text-xl text-stone-400 line-through mb-1">$${p.price}</span>
                                    <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded mb-2">خصم ${p.discount}%</span>
                                 </div>
                                 <p class="text-sm text-stone-500">شامل الضريبة</p>` 
                                : 
                                `<div class="flex items-baseline gap-2"><span class="text-3xl font-bold text-stone-900 font-serif">$${p.price}</span><span class="text-stone-500 text-sm">شامل الضريبة</span></div>`
                                }
                            </div>

                            <!-- VARIANTS SECTION (Kept here as it affects image) -->
                            ${p.variants && p.variants.length > 0 ? `
                            <div id="variants-section" class="space-y-3 pb-4 border-b border-stone-100">
                                <h3 class="font-bold text-stone-900 text-sm">الألوان المتاحة:</h3>
                                <div class="flex flex-wrap gap-3">
                                    ${p.variants.map(v => `
                                        <button 
                                            onclick="selectColor('${v.color}', '${v.image}')" 
                                            data-color="${v.color}"
                                            class="variant-btn group relative w-12 h-12 rounded-full border border-stone-200 overflow-hidden hover:scale-110 transition-all focus:outline-none"
                                            title="${v.color}"
                                        >
                                            <img src="${v.image}" class="w-full h-full object-cover">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-[10px] text-stone-400"><i data-lucide="info" size="10" class="inline"></i> اختر اللون لمشاهدة صورته وإضافته للسلة</p>
                            </div>
                            ` : ''}
                            
                            <!-- Dynamic Service Icons Slider -->
                            <div class="mt-2 py-4">
                                <div class="flex gap-4 overflow-x-auto scrollbar-hide px-1 snap-x">
                                    ${(p.services && p.services.length > 0 ? p.services : []).map(s => `
                                    <div class="min-w-[80px] w-[80px] flex flex-col items-center text-center gap-2 snap-start group cursor-default">
                                        <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 group-hover:bg-stone-200 transition-colors">
                                            <i data-lucide="${s.icon}" size="20"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-stone-500 leading-tight">${s.text.replace(/ /g, '<br>')}</span>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Report Issue Link (WhatsApp) -->
                            <div class="mt-2">
                                <a href="https://wa.me/201014175070?text=${encodeURIComponent('مرحباً، أريد الإبلاغ عن مشكلة بخصوص المنتج: ' + p.name)}" target="_blank" class="flex items-center gap-2 text-stone-400 hover:text-red-600 text-xs font-medium transition-colors w-fit p-2 rounded-lg hover:bg-stone-50">
                                    <i data-lucide="flag" size="14"></i>
                                    <span>أبلغ عن مشكلة</span>
                                </a>
                            </div>

                        </div>

                        <!-- Action Card -->
                        <div class="lg:col-span-3">
                            <div class="border border-stone-200 rounded-xl p-5 shadow-sm sticky top-24 bg-white">
                                <div class="mb-4">
                                    ${hasDiscount 
                                        ? `<span class="text-2xl font-bold text-red-600">$${finalPrice}</span> <span class="text-sm text-stone-400 line-through">$${p.price}</span>` 
                                        : `<span class="text-2xl font-bold text-stone-900">$${p.price}</span>`
                                    }
                                </div>
                                <div class="text-sm mb-6">
                                    <p class="text-green-600 font-medium mb-1">متوفر في المخزون</p>
                                    <p class="text-stone-500">يصلك خلال: <span class="text-stone-900 font-bold">2-4 أيام عمل</span></p>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between border border-stone-200 rounded-lg p-2 bg-stone-50">
                                        <span class="text-sm font-bold text-stone-600 px-2">الكمية:</span>
                                        <div class="flex items-center gap-4">
                                            <button onclick="changeDetailsQuantity(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">-</button>
                                            <span id="details-qty" class="font-bold w-4 text-center">${detailsQuantity}</span>
                                            <button onclick="changeDetailsQuantity(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm hover:bg-stone-100">+</button>
                                        </div>
                                    </div>
                                    <button onclick="addToCartFromDetails('${p.id}')" class="w-full bg-yellow-400 hover:bg-yellow-500 text-stone-900 py-3 rounded-full font-bold shadow-sm transition-colors text-sm">إضافة إلى عربة التسوق</button>
                                    <button onclick="addToCartFromDetails('${p.id}'); checkout()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-full font-bold shadow-sm transition-colors text-sm">شراء الآن</button>
                                </div>

                                <!-- Sponsored Product Ad -->
                                ${(() => {
                                    // Pick a random product for ad
                                    const adProduct = PRODUCTS.filter(x => x.id !== p.id).sort(() => 0.5 - Math.random())[0];
                                    if (!adProduct) return '';
                                    
                                    return `
                                    <div class="mt-6 pt-4 border-t border-stone-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">منتج ممول</span>
                                            <i data-lucide="info" size="10" class="text-stone-300"></i>
                                        </div>
                                        <div class="border border-stone-200 rounded-xl p-2 bg-stone-50 hover:bg-white hover:border-stone-400 transition-all cursor-pointer group flex gap-3 items-center" onclick="viewProduct('${adProduct.id}')">
                                            <div class="w-14 h-14 bg-white rounded-lg overflow-hidden shrink-0 border border-stone-100">
                                                <img src="${adProduct.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-bold text-stone-900 text-xs truncate mb-1">${adProduct.name}</h4>
                                                <div class="flex justify-between items-center">
                                                    <span class="font-serif font-bold text-stone-900 text-sm">$${adProduct.price}</span>
                                                    <span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded-full">عرض</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                })()}

                                <!-- "Customers usually keep this item" Box -->
                                <div class="mt-4 bg-green-50 border border-green-600 rounded-xl p-4 flex items-start justify-between gap-4 shadow-sm">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-stone-900 text-xs mb-1">عادة ما يحتفظ العملاء بهذه السلعة</h4>
                                        <p class="text-[10px] text-stone-700 leading-relaxed">يتمتع هذا المنتج بمعدلات إرجاع أقل من المتوسط.</p>
                                    </div>
                                    <div class="bg-green-600 rounded-full p-1 text-white shrink-0 shadow-sm">
                                        <i data-lucide="check" size="14" stroke-width="3"></i>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- NEW: Detailed Info Section (Bottom Layout like Amazon) -->
                    <div class="grid md:grid-cols-2 gap-8 mb-16 items-start mt-12 border-t border-stone-100 pt-12">
                        <!-- About Item -->
                        <div class="h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-stone-100 p-2 rounded-lg"><i data-lucide="file-text" class="text-stone-600" size="20"></i></span>
                                عن السلعة
                            </h3>
                            ${(() => {
                                // Calculate content length (items)
                                const materialLine = p.material ? 1 : 0;
                                const featureLines = features.length;
                                const descLines = 1;
                                const totalLines = materialLine + featureLines + descLines;
                                const isLong = totalLines > 3;

                                return `
                                <div id="about-container-${p.id}" class="relative overflow-hidden transition-all duration-500 ${isLong ? 'max-h-[300px]' : ''}">
                                    <ul class="list-disc list-outside mr-5 space-y-3 text-stone-700 leading-relaxed">
                                        ${p.material ? `<li class="font-bold text-stone-900">المادة: <span class="font-normal text-stone-700">${p.material}</span></li>` : ''}
                                        ${features.map(f => `<li>${f}</li>`).join('')}
                                        <li>${p.description || p.details}</li>
                                    </ul>
                                    ${isLong ? `<div id="about-fade-${p.id}" class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-white to-transparent"></div>` : ''}
                                </div>
                                ${isLong ? `
                                <button id="about-btn-${p.id}" onclick="toggleAbout('${p.id}')" class="text-stone-900 font-bold text-sm hover:text-orange-600 underline underline-offset-4 flex items-center gap-1 mt-4 transition-colors">
                                    <i data-lucide="chevron-down" size="16"></i> قراءة المزيد
                                </button>` : ''}
                                `;
                            })()}
                        </div>

                        <!-- Specs Section -->
                        <div class="bg-stone-50 rounded-3xl p-8 border border-stone-100 h-full">
                            <h3 class="font-bold text-xl text-stone-900 mb-6 flex items-center gap-2">
                                <span class="bg-white p-2 rounded-lg border border-stone-200"><i data-lucide="settings-2" class="text-stone-600" size="20"></i></span>
                                المواصفات الفنية
                            </h3>
                            ${p.specifications && p.specifications.length > 0 ? `
                            <div class="space-y-0 divide-y divide-stone-200">
                                ${p.specifications.map(s => `
                                    <div class="flex justify-between items-center py-4 px-2">
                                        <span class="font-bold text-stone-600 text-sm">${s.label}</span>
                                        <span class="text-stone-900 dir-ltr text-sm font-bold">${s.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : `<p class="text-stone-400 text-sm">لا توجد مواصفات إضافية.</p>`}
                        </div>
                    </div>

                    <!-- Related Products Slider -->
                    ${renderSliderHTML('related-slider-section', 'المنتجات المرتبطة بهذه السلعة', relatedProducts)}
                    
                    <!-- Random Suggestions Slider (Now Small like History) -->
                    ${renderSliderHTML('suggestions-slider-section', 'اقتراحات قد تعجبك', randomSuggestions, true)}

                    <!-- Reviews Section -->
                    <div class="mt-20 border-t border-stone-100 pt-12">
                        <div class="grid lg:grid-cols-12 gap-12">
                            <!-- Right: Rating Summary (Amazon Style) -->
                            <div class="lg:col-span-4">
                                <h3 class="text-2xl font-bold text-stone-900 mb-2">مراجعات المستخدمين</h3>
                                <div class="flex items-baseline gap-2 mb-4">
                                    <div class="flex text-yellow-400 text-lg">${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-5 h-5 ${i < Math.round(averageRating) ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}</div>
                                    <span class="text-lg font-bold text-stone-900 dir-ltr">${averageRating} من 5</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-6">${totalReviews} من التقييمات العالمية</p>
                                
                                <div class="space-y-3 mb-8">
                                    ${[5,4,3,2,1].map(star => {
                                        const count = counts[star];
                                        const percent = totalReviews > 0 ? Math.round((count / totalReviews) * 100) : 0;
                                        return `
                                        <div class="flex items-center gap-3 text-sm group cursor-default hover:opacity-80 transition-opacity">
                                            <span class="w-12 text-blue-600 font-medium hover:underline text-left dir-ltr">${star} نجوم</span>
                                            <div class="flex-1 h-5 bg-stone-100 rounded-sm overflow-hidden border border-stone-200 box-border">
                                                <div class="h-full bg-yellow-400 border-r border-yellow-500" style="width: ${percent}%"></div>
                                            </div>
                                            <span class="w-8 text-blue-600 font-medium text-right dir-ltr">${percent}%</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="border-t border-stone-200 pt-6">
                                    <h4 class="font-bold text-lg mb-2">راجع هذا المنتج</h4>
                                    <p class="text-sm text-stone-500 mb-4">شارك أفكارك مع العملاء الآخرين</p>
                                    <button onclick="document.getElementById('review-form').classList.toggle('hidden')" class="w-full border border-stone-300 text-stone-900 py-2 rounded-lg text-sm font-bold hover:bg-stone-50 transition-colors">اكتب مراجعة للعميل</button>
                                    
                                    <form id="review-form" onsubmit="handleSubmitReview(event)" class="space-y-4 mt-4 hidden bg-stone-50 p-4 rounded-xl border border-stone-200">
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">التقييم العام</label>
                                            <div class="flex flex-row-reverse justify-end gap-1 group/rating">
                                                ${[5,4,3,2,1].map(val => `
                                                    <input type="radio" name="reviewerRating" value="${val}" id="star${val}" class="peer hidden" ${val===5?'checked':''}>
                                                    <label for="star${val}" class="cursor-pointer text-stone-300 peer-checked:text-yellow-400 hover:text-yellow-400 peer-hover:text-yellow-400 transition-colors"><i data-lucide="star" class="fill-current w-8 h-8"></i></label>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">الاسم</label>
                                            <input name="reviewerName" required class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="اسمك الكريم">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-stone-600 mb-1">أضف مراجعة مكتوبة</label>
                                            <textarea name="reviewerComment" required rows="3" class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:outline-none focus:border-stone-900 focus:ring-1 focus:ring-stone-900" placeholder="ما الذي أعجبك أو لم يعجبك؟ بماذا تنصح؟"></textarea>
                                        </div>
                                        <button class="w-full bg-stone-900 text-white py-2 rounded-lg text-sm font-bold hover:bg-stone-800 transition-colors shadow-md">إرسال</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Left: Reviews List -->
                            <div class="lg:col-span-8 space-y-6">
                                <h3 class="font-bold text-xl mb-4">أفضل المراجعات</h3>
                                ${productReviews.length > 0 ? productReviews.map(r => `
                                    <div class="flex gap-4 mb-6">
                                        <div class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center font-bold text-stone-600 text-lg flex-shrink-0">${r.userName.charAt(0)}</div>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-bold text-sm text-stone-900">${r.userName}</span>
                                            </div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <div class="flex text-yellow-400 text-xs">
                                                    ${Array(5).fill(0).map((_,i) => `<i data-lucide="star" class="w-4 h-4 ${i < r.rating ? 'fill-current' : 'text-stone-200'}"></i>`).join('')}
                                                </div>
                                                ${r.verified ? `<span class="text-xs font-bold text-orange-600">تم الشراء (Verified Purchase)</span>` : ''}
                                            </div>
                                            <p class="text-xs text-stone-400 mb-2">تمت المراجعة في ${new Date(r.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            <p class="text-stone-700 text-sm leading-relaxed font-medium mb-4">${r.comment}</p>
                                            <div class="flex gap-4 text-xs text-stone-500">
                                                <button class="border border-stone-200 px-4 py-1 rounded-full hover:bg-stone-50 transition-colors">مفيد</button>
                                                <button class="text-stone-400 hover:text-stone-600">إبلاغ</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="bg-stone-50 rounded-xl p-8 text-center border border-dashed border-stone-200">
                                        <p class="text-stone-500">لا توجد مراجعات حتى الآن.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- NEW: History Slider (Smaller Cards) -->
                    ${renderSliderHTML('history-slider-section', 'سجل التصفح الخاص بك', historyProducts, true)}

                    <!-- NEW: Popular Search Cloud (Dynamic) -->
                    <div class="mt-16 border-t border-stone-100 pt-10 pb-8">
                         <div class="flex justify-between items-end mb-6">
                            <h3 class="text-xl font-bold text-stone-900">البحث الشائع</h3>
                         </div>
                         <div class="flex flex-wrap gap-2.5">
                            ${dynamicTags.length > 0 ? dynamicTags.map(tag => `
                                <button onclick="updateShopFilters('search', '${tag}'); setView('shop')" class="bg-stone-100 hover:bg-stone-200 text-stone-600 hover:text-stone-900 px-3 py-1.5 rounded-md text-xs md:text-sm font-medium transition-colors border border-transparent hover:border-stone-300">
                                    ${tag}
                                </button>
                            `).join('') : '<p class="text-sm text-stone-400">لا توجد كلمات بحث شائعة حالياً.</p>'}
                         </div>
                    </div>

                </div>
            </div>`;
        }
        
        // --- Helper Function: Create Small Product Card ---
        function createSmallProductCard(p) {
            // UPDATE: Use helper
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            
            return `
            <div class="group flex flex-col gap-2 cursor-pointer h-full" onclick="viewProduct('${p.id}')">
                <div class="relative aspect-square bg-white border border-stone-100 rounded-[1.5rem] overflow-hidden group-hover:shadow-md transition-all duration-300">
                    <!-- Brand Badge -->
                    <div class="absolute top-2 right-2 z-10">
                        <span class="bg-[#00796B] text-white text-[9px] font-bold px-2 py-1 rounded-full shadow-sm">${p.brand || 'منتج'}</span>
                    </div>

                    <!-- Image -->
                    <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">
                    
                    <!-- Add Button -->
                    <div class="absolute bottom-2 left-0 w-full px-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-white text-stone-900 text-[10px] font-bold py-2 rounded-full shadow-lg hover:bg-stone-50">
                            أضف
                        </button>
                    </div>
                </div>
                
                <div class="px-1 text-right">
                    <h3 class="text-stone-800 font-bold text-xs leading-snug line-clamp-1 mb-1">${p.name}</h3>
                    <div class="flex items-center justify-end gap-2 dir-ltr">
                        <span class="text-[#00796B] text-sm font-bold">${Math.floor(finalPrice)} ج.م</span>
                    </div>
                </div>
            </div>`;
        }

        function createProductCard(p) {
            const isFav = favorites.includes(p.id);
            const isAdmin = user && user.email === ADMIN_EMAIL;
            const hasDiscount = isDiscountActive(p);
            const finalPrice = hasDiscount ? (p.price * (1 - p.discount / 100)) : p.price;
            
            // Format Price
            const priceFormatted = Math.floor(finalPrice).toLocaleString();
            const originalPriceFormatted = Math.floor(p.price).toLocaleString();

            return `
            <div class="group flex flex-col gap-3 cursor-pointer h-full select-none" onclick="viewProduct('${p.id}')">
                <!-- Image Container -->
                <div class="relative aspect-[4/5] bg-white rounded-[2rem] overflow-hidden transition-all duration-300 group-hover:shadow-lg border border-stone-100 group-hover:border-stone-200">
                    
                    <!-- DISCOUNT BADGE (UPDATED: Top Right, Vivid Red) -->
                    ${hasDiscount ? `
                    <div class="absolute top-3 right-3 z-30">
                        <div class="bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-md border border-white/20 flex items-center gap-1 animate-in fade-in zoom-in duration-300">
                            <span class="dir-ltr">-${p.discount}%</span>
                            <i data-lucide="tag" size="12" class="fill-white/30 text-white"></i>
                        </div>
                    </div>` : ''}

                    <!-- Brand Badge (Moved to Bottom Right) -->
                    <div class="absolute bottom-4 right-4 z-20 transition-opacity duration-300 group-hover:opacity-0">
                        <span class="bg-white/80 backdrop-blur-md text-stone-700 text-[10px] font-bold px-2.5 py-1 rounded-lg shadow-sm border border-stone-100/50">${p.brand || 'JEDAR'}</span>
                    </div>

                    <!-- Top Left: Floating Actions -->
                    <div class="absolute top-3 left-3 z-20 flex flex-col gap-2">
                        <!-- Favorite -->
                        <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="w-9 h-9 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-stone-900 shadow-sm hover:scale-110 transition-transform border border-stone-100 ${isFav ? 'text-red-500' : 'text-stone-400'}">
                            <i data-lucide="heart" size="18" class="${isFav ? 'fill-current' : ''}"></i>
                        </button>
                        <!-- Quick View -->
                        <button onclick="event.stopPropagation(); viewProduct('${p.id}')" class="w-9 h-9 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-stone-900 shadow-sm hover:scale-110 transition-transform border border-stone-100 hidden md:flex">
                            <i data-lucide="eye" size="18"></i>
                        </button>
                        
                        <!-- Admin Controls -->
                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); handleEditProduct('${p.id}')" class="w-9 h-9 bg-blue-50/90 text-blue-600 rounded-full flex items-center justify-center shadow-sm hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="pen-line" size="16"></i></button>
                        <button onclick="event.stopPropagation(); handleDeleteProduct('${p.id}')" class="w-9 h-9 bg-red-50/90 text-red-600 rounded-full flex items-center justify-center shadow-sm hover:bg-red-600 hover:text-white transition-all"><i data-lucide="trash-2" size="16"></i></button>
                        ` : ''}
                    </div>

                    <!-- Product Image -->
                    <div class="absolute inset-0">
                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-in-out" loading="lazy" alt="${p.name}">
                    </div>

                    <!-- Add To Cart Button (Floating at Bottom) -->
                    <div class="absolute bottom-3 left-3 right-3 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 z-30">
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-stone-900/90 backdrop-blur-sm text-white font-bold py-3 rounded-xl shadow-lg hover:bg-stone-900 transition-colors flex items-center justify-center gap-2 text-sm">
                            أضف إلى العربة
                        </button>
                    </div>
                </div>

                <!-- Info Section -->
                <div class="px-2 text-right flex flex-col gap-1">
                    <!-- Brand / Category -->
                    <div class="flex justify-between items-center">
                        <p class="text-stone-400 text-[10px] font-bold mb-0.5">${p.category}</p>
                        ${p.rating ? `<div class="flex items-center gap-1"><i data-lucide="star" class="w-3 h-3 fill-yellow-400 text-yellow-400"></i><span class="text-[10px] text-stone-500 font-bold dir-ltr">${p.rating}</span></div>` : ''}
                    </div>
                    
                    <!-- Title -->
                    <h3 class="text-stone-800 font-bold text-sm leading-relaxed line-clamp-2 min-h-[2.5em] group-hover:text-[#00796B] transition-colors" title="${p.name}">${p.name}</h3>
                    
                    <!-- Price -->
                    <div class="flex items-center justify-end gap-2 mt-1 dir-ltr">
                        <span class="text-[#00796B] text-lg font-bold">${priceFormatted} جنيه</span>
                        ${hasDiscount ? `<span class="text-stone-400 text-xs line-through decoration-stone-400 decoration-1">${originalPriceFormatted}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // Start
        init();
    </script>
</body>
</html>